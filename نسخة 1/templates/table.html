{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4 py-4">
    
    <style>
        /* Modern UI Overrides */
        .filter-card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            background: white;
            transition: transform 0.2s;
        }
        
        .main-card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            overflow: hidden;
            background: white;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
            color: white;
            font-weight: 600;
            padding: 16px 10px;
            border: none;
            white-space: nowrap;
            text-align: center !important;
            vertical-align: middle !important;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody td {
            padding: 14px 10px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
            text-align: center !important;
            color: #444;
            font-size: 0.9rem;
            white-space: normal !important;
            word-wrap: break-word;
        }

        .table-hover tbody tr:hover {
            background-color: #f8faff !important;
        }

        .form-control, .form-select {
            border-radius: 12px;
            padding: 10px 15px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            font-size: 0.9rem;
        }

        .form-control:focus, .form-select:focus {
            background-color: white;
            border-color: #2a5298;
            box-shadow: 0 0 0 4px rgba(42, 82, 152, 0.1);
        }

        .btn {
            border-radius: 10px;
            padding: 8px 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: none;
            box-shadow: 0 4px 10px rgba(30, 60, 114, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(30, 60, 114, 0.3);
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        }

        .btn-white {
            background: white;
            border: 1px solid #eee;
            color: #555;
        }
        .btn-white:hover {
            background: #f8f9fa;
            color: #333;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            min-width: 90px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Resizer styles */
        .resizer {
            position: absolute;
            top: 0;
            left: 0; /* RTL specific */
            width: 5px;
            cursor: col-resize;
            user-select: none;
            height: 100%;
            opacity: 0;
            z-index: 20;
        }
        .table thead th:hover .resizer {
            opacity: 0.5;
            background-color: rgba(255,255,255,0.3);
        }
        .resizer:hover, .resizing {
            background-color: rgba(255,255,255,0.8) !important;
            opacity: 1 !important;
        }

        /* Custom Scrollbar */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>

    <!-- Header & Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-1">سجل الضمانات</h4>
            <p class="text-muted small mb-0">إدارة ومتابعة الضمانات البنكية</p>
        </div>
        <div class="d-flex gap-2">
             <div class="dropdown">
                <button class="btn btn-white shadow-sm dropdown-toggle" type="button" id="columnToggleBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-columns text-primary me-2"></i> الأعمدة
                </button>
                <ul class="dropdown-menu dropdown-menu-end p-3 shadow border-0" aria-labelledby="columnToggleBtn" id="columnToggleList" style="max-height: 400px; overflow-y: auto; width: 250px;">
                    <!-- Column toggles will be generated here -->
                </ul>
            </div>
            
            <button class="btn btn-white shadow-sm text-success" onclick="exportTableToExcel('guaranteesTable')">
                <i class="fas fa-file-excel me-2"></i> تصدير
            </button>
            
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="fas fa-plus me-2"></i> ضمان جديد
            </button>
        </div>
    </div>

    <!-- Filters Toolbar -->
    <div class="filter-card p-3 mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="searchInput" class="form-control border-0 bg-light" placeholder="بحث سريع (رقم الضمان، المستفيد، المشروع)...">
                </div>
            </div>
            <div class="col-md-2">
                <select id="bankFilter" class="form-select">
                    <option value="">كل البنوك</option>
                    <option value="الراجحي">الراجحي</option>
                    <option value="الأهلي">الأهلي</option>
                    <option value="الرياض">الرياض</option>
                    <option value="ساب">ساب</option>
                    <option value="الإنماء">الإنماء</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="statusFilter" class="form-select">
                    <option value="">كل الحالات</option>
                    <option value="ساري">ساري</option>
                    <option value="منتهي">منتهي</option>
                    <option value="قارب على الانتهاء">قارب على الانتهاء</option>
                    <option value="انتهى في انتظار التأكيد">انتظار التأكيد</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="typeFilter" class="form-select">
                    <option value="">كل الأنواع</option>
                    <option value="ابتدائي">ابتدائي</option>
                    <option value="نهائي">نهائي</option>
                    <option value="دفعة مقدمة">دفعة مقدمة</option>
                    <option value="مالي">مالي</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <span class="badge bg-light text-primary p-2 px-3 rounded-pill border">
                    <i class="fas fa-list-ol me-1"></i> <span id="rowCount">{{ guarantees|length }}</span> ضمان
                </span>
            </div>
        </div>
    </div>

    <!-- Main Table Card -->
    <div class="main-card">
        <div class="table-responsive" style="max-height: 70vh;">
            <table class="table table-hover mb-0" id="guaranteesTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>رقم الضمان</th>
                        <th>البنك</th>
                        <th>النوع</th>
                        <th>المبلغ</th>
                        <th>الغطاء</th>
                        <th>النسبة</th>
                        <th>المستفيد</th>
                        <th>المشروع</th>
                        <th>طالب الضمان</th>
                        <th>تاريخ الإصدار</th>
                        <th>تاريخ الانتهاء</th>
                        <th>القسم</th>
                        <th>ملاحظات</th>
                        <th>رقم القيد</th>
                        <th>الحالة</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for g in guarantees %}
                    <tr data-bank="{{ g.bank }}" data-status="{{ g.display_status }}" data-type="{{ g.g_type }}" 
                        data-search="{{ g.g_no }} {{ g.beneficiary }} {{ g.project_name }} {{ g.amount }} {{ g.requester }} {{ g.notes }} {{ g.entry_number }}">
                        <td class="text-muted small">{{ loop.index }}</td>
                        <td class="fw-bold text-primary" style="font-family: monospace; font-size: 1rem;">{{ g.g_no }}</td>
                        <td>{{ g.bank }}</td>
                        <td><span class="badge bg-light text-dark border">{{ g.g_type }}</span></td>
                        <td class="font-monospace fw-bold text-dark">{{ "{:,.2f}".format(g.amount) if g.amount else '0.00' }}</td>
                        <td class="font-monospace text-muted">{{ "{:,.2f}".format(g.insurance_amount) if g.insurance_amount else '0.00' }}</td>
                        <td class="font-monospace">{{ "{:,.2f}".format(g.percent) if g.percent else '0.00' }}%</td>
                        <td>{{ g.beneficiary }}</td>
                        <td class="small">{{ g.project_name }}</td>
                        <td>{{ g.requester }}</td>
                        <td style="white-space: nowrap;">{{ g.issue_date }}</td>
                        <td style="white-space: nowrap;">{{ g.end_date }}</td>
                        <td>{{ g.department }}</td>
                        <td class="small text-muted">{{ g.notes }}</td>
                        <td>{{ g.entry_number }}</td>
                        <td>
                            {% if g.display_status == 'ساري' %}
                                <span class="badge bg-success bg-opacity-10 text-success status-badge">ساري</span>
                            {% elif g.display_status == 'منتهي' %}
                                <span class="badge bg-danger bg-opacity-10 text-danger status-badge">منتهي</span>
                            {% elif g.display_status == 'قارب على الانتهاء' %}
                                <span class="badge bg-warning bg-opacity-10 text-warning status-badge">قارب على الانتهاء</span>
                            {% elif g.display_status == 'انتهى في انتظار التأكيد' %}
                                <span class="badge bg-info bg-opacity-10 text-info status-badge">انتظار التأكيد</span>
                            {% else %}
                                <span class="badge bg-secondary status-badge">{{ g.display_status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light text-primary edit-btn" 
                                    data-id="{{ g.id }}"
                                    data-gno="{{ g.g_no }}"
                                    data-bank="{{ g.bank }}"
                                    data-dept="{{ g.department }}"
                                    data-type="{{ g.g_type }}"
                                    data-amount="{{ g.amount }}"
                                    data-insurance="{{ g.insurance_amount }}"
                                    data-percent="{{ g.percent }}"
                                    data-beneficiary="{{ g.beneficiary }}"
                                    data-project="{{ g.project_name }}"
                                    data-requester="{{ g.requester }}"
                                    data-issuedate="{{ g.issue_date }}"
                                    data-enddate="{{ g.end_date }}"
                                    data-status="{{ g.user_status }}"
                                    data-notes="{{ g.notes }}"
                                    data-entry="{{ g.entry_number }}"
                                    data-bs-toggle="modal" data-bs-target="#editModal"
                                    title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if current_user.role == 'admin' %}
                                <button class="btn btn-sm btn-light text-danger delete-btn" 
                                    data-id="{{ g.id }}"
                                    data-gno="{{ g.g_no }}"
                                    data-bs-toggle="modal" data-bs-target="#deleteModal"
                                    title="حذف">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-primary">إضافة ضمان جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_guarantee') }}" method="POST">
                <div class="modal-body pt-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">رقم الضمان <span class="text-danger">*</span></label>
                            <input type="text" name="g_no" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">البنك</label>
                            <select name="bank" class="form-select">
                                <option value="الراجحي">الراجحي</option>
                                <option value="الأهلي">الأهلي</option>
                                <option value="الرياض">الرياض</option>
                                <option value="ساب">ساب</option>
                                <option value="الإنماء">الإنماء</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">النوع</label>
                            <select name="g_type" class="form-select">
                                <option value="ابتدائي">ابتدائي</option>
                                <option value="نهائي">نهائي</option>
                                <option value="دفعة مقدمة">دفعة مقدمة</option>
                                <option value="مالي">مالي</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">المبلغ</label>
                            <input type="number" step="0.01" name="amount" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">الغطاء</label>
                            <input type="number" step="0.01" name="insurance_amount" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">النسبة %</label>
                            <input type="number" step="0.01" name="percent" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">المستفيد</label>
                            <input type="text" name="beneficiary" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">المشروع</label>
                            <input type="text" name="project_name" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">طالب الضمان</label>
                            <input type="text" name="requester" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">القسم</label>
                            <input type="text" name="department" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">تاريخ الإصدار</label>
                            <input type="date" name="issue_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">تاريخ الانتهاء</label>
                            <input type="date" name="end_date" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">رقم القيد</label>
                            <input type="text" name="entry_number" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">الحالة</label>
                            <select name="user_status" class="form-select">
                                <option value="ساري" selected>ساري</option>
                                <option value="منتهي">منتهي</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted mb-1">ملاحظات</label>
                            <textarea name="notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary px-4">حفظ الضمان</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-primary">تعديل بيانات الضمان</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="POST">
                <div class="modal-body pt-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">رقم الضمان</label>
                            <input type="text" name="g_no" id="edit_g_no" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">البنك</label>
                            <select name="bank" id="edit_bank" class="form-select">
                                <option value="الراجحي">الراجحي</option>
                                <option value="الأهلي">الأهلي</option>
                                <option value="الرياض">الرياض</option>
                                <option value="ساب">ساب</option>
                                <option value="الإنماء">الإنماء</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">النوع</label>
                            <select name="g_type" id="edit_g_type" class="form-select">
                                <option value="ابتدائي">ابتدائي</option>
                                <option value="نهائي">نهائي</option>
                                <option value="دفعة مقدمة">دفعة مقدمة</option>
                                <option value="مالي">مالي</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">المبلغ</label>
                            <input type="number" step="0.01" name="amount" id="edit_amount" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">الغطاء</label>
                            <input type="number" step="0.01" name="insurance_amount" id="edit_insurance" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-1">النسبة %</label>
                            <input type="number" step="0.01" name="percent" id="edit_percent" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">المستفيد</label>
                            <input type="text" name="beneficiary" id="edit_beneficiary" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">المشروع</label>
                            <input type="text" name="project_name" id="edit_project" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">طالب الضمان</label>
                            <input type="text" name="requester" id="edit_requester" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">القسم</label>
                            <input type="text" name="department" id="edit_dept" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">تاريخ الإصدار</label>
                            <input type="date" name="issue_date" id="edit_issue_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">تاريخ الانتهاء</label>
                            <input type="date" name="end_date" id="edit_end_date" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">رقم القيد</label>
                            <input type="text" name="entry_number" id="edit_entry" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-1">الحالة</label>
                            <select name="user_status" id="edit_status" class="form-select">
                                <option value="ساري">ساري</option>
                                <option value="منتهي">منتهي</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted mb-1">ملاحظات</label>
                            <textarea name="notes" id="edit_notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary px-4">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-danger">تأكيد الحذف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                هل أنت متأكد من رغبتك في حذف الضمان رقم <span id="delete_g_no" class="fw-bold text-dark"></span>؟
                <p class="text-muted small mt-2 mb-0">لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-footer border-0">
                <form id="deleteForm" method="POST">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-danger px-4">حذف نهائي</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Filter Logic
    const searchInput = document.getElementById('searchInput');
    const bankFilter = document.getElementById('bankFilter');
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    const tableBody = document.getElementById('tableBody');
    const rowCount = document.getElementById('rowCount');

    function filterTable() {
        const searchText = searchInput.value.toLowerCase();
        const bank = bankFilter.value;
        const status = statusFilter.value;
        const type = typeFilter.value;
        
        let visibleCount = 0;
        const rows = tableBody.getElementsByTagName('tr');

        for (let row of rows) {
            const rowBank = row.getAttribute('data-bank') || '';
            const rowStatus = row.getAttribute('data-status') || '';
            const rowType = row.getAttribute('data-type') || '';
            const rowSearch = row.getAttribute('data-search').toLowerCase();

            const matchSearch = rowSearch.includes(searchText);
            const matchBank = !bank || rowBank === bank;
            const matchType = !type || rowType === type;

            let matchStatus = true;
            if (status) {
                matchStatus = rowStatus === status;
            } else {
                // If "All" status selected:
                // Hide "منتهي" unless searching (and finding a match)
                if (rowStatus === 'منتهي') {
                    if (searchText.length > 0 && matchSearch) {
                        matchStatus = true;
                    } else {
                        matchStatus = false;
                    }
                }
            }

            if (matchSearch && matchBank && matchStatus && matchType) {
                row.style.display = '';
                visibleCount++;
                // Update sequence number dynamically
                if (row.cells.length > 0) {
                    row.cells[0].textContent = visibleCount;
                }
            } else {
                row.style.display = 'none';
            }
        }
        rowCount.textContent = visibleCount;
    }

    searchInput.addEventListener('keyup', filterTable);
    bankFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
    typeFilter.addEventListener('change', filterTable);

    // Initial call to apply default filters (hide expired)
    filterTable();

    // Edit Modal Logic
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const form = document.getElementById('editForm');
            form.action = `/guarantees/edit/${id}`;
            
            document.getElementById('edit_g_no').value = this.dataset.gno;
            document.getElementById('edit_bank').value = this.dataset.bank;
            document.getElementById('edit_dept').value = this.dataset.dept;
            document.getElementById('edit_g_type').value = this.dataset.type;
            document.getElementById('edit_amount').value = this.dataset.amount;
            document.getElementById('edit_insurance').value = this.dataset.insurance;
            document.getElementById('edit_percent').value = this.dataset.percent;
            document.getElementById('edit_beneficiary').value = this.dataset.beneficiary;
            document.getElementById('edit_project').value = this.dataset.project;
            document.getElementById('edit_requester').value = this.dataset.requester;
            document.getElementById('edit_issue_date').value = this.dataset.issuedate;
            document.getElementById('edit_end_date').value = this.dataset.enddate;
            document.getElementById('edit_status').value = this.dataset.status || 'ساري';
            document.getElementById('edit_notes').value = this.dataset.notes;
            document.getElementById('edit_entry').value = this.dataset.entry;
        });
    });

    // Delete Modal Logic
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const gno = this.dataset.gno;
            const form = document.getElementById('deleteForm');
            form.action = `/guarantees/delete/${id}`;
            document.getElementById('delete_g_no').textContent = gno;
        });
    });

    // Export to Excel (Simple implementation)
    function exportTableToExcel(tableID, filename = ''){
        var downloadLink;
        var dataType = 'application/vnd.ms-excel';
        var tableSelect = document.getElementById(tableID);
        var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
        
        // Specify file name
        filename = filename?filename+'.xls':'guarantees_data.xls';
        
        // Create download link element
        downloadLink = document.createElement("a");
        
        document.body.appendChild(downloadLink);
        
        if(navigator.msSaveOrOpenBlob){
            var blob = new Blob(['\ufeff', tableHTML], {
                type: dataType
            });
            navigator.msSaveOrOpenBlob( blob, filename);
        }else{
            // Create a link to the file
            downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
        
            // Setting the file name
            downloadLink.download = filename;
            
            //triggering the function
            downloadLink.click();
        }
    }

    // Column Visibility Logic
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('guaranteesTable');
        const headers = table.querySelectorAll('thead th');
        const toggleList = document.getElementById('columnToggleList');
        const savedVisibility = JSON.parse(localStorage.getItem('guaranteesTableVisibility')) || {};
        
        // Create a style element for dynamic column hiding
        const styleEl = document.createElement('style');
        styleEl.id = 'column-visibility-styles';
        document.head.appendChild(styleEl);

        const updateStyles = () => {
            const rules = [];
            headers.forEach((_, index) => {
                const isVisible = savedVisibility[index] !== false;
                if (!isVisible) {
                    rules.push(`.table-col-${index} { display: none !important; }`);
                }
            });
            styleEl.textContent = rules.join('\n');
        };

        // Assign classes to all columns for robust targeting
        headers.forEach((th, index) => {
            th.classList.add(`table-col-${index}`);
        });
        
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            Array.from(row.cells).forEach((td, index) => {
                td.classList.add(`table-col-${index}`);
            });
        });

        headers.forEach((th, index) => {
            const text = th.innerText.trim();
            // Allow all columns to be toggled, even empty ones
            if (!text && index !== 0 && !th.querySelector('i')) return; 
            
            const isVisible = savedVisibility[index] !== false; // Default true
            
            const li = document.createElement('li');
            li.className = 'dropdown-item-text py-1';
            li.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input column-toggle" type="checkbox" value="${index}" id="colCheck${index}" ${isVisible ? 'checked' : ''}>
                    <label class="form-check-label w-100 stretched-link" for="colCheck${index}">
                        ${text || (index === 0 ? '#' : 'إجراءات')}
                    </label>
                </div>
            `;
            toggleList.appendChild(li);
        });

        // Apply initial styles
        updateStyles();

        // Event delegation for toggles
        toggleList.addEventListener('change', function(e) {
            if (e.target.classList.contains('column-toggle')) {
                const index = parseInt(e.target.value);
                const isChecked = e.target.checked;
                
                // Update visibility state
                savedVisibility[index] = isChecked;
                localStorage.setItem('guaranteesTableVisibility', JSON.stringify(savedVisibility));
                
                // Update Styles
                updateStyles();
            }
        });
        
        // Prevent dropdown close on click inside
        toggleList.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    // Column Resizing Logic
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('guaranteesTable');
        const headers = table.querySelectorAll('th');
        
        headers.forEach(header => {
            const resizer = document.createElement('div');
            resizer.classList.add('resizer');
            header.appendChild(resizer);
            
            let x = 0;
            let w = 0;
            
            const mouseDownHandler = function(e) {
                x = e.clientX;
                const styles = window.getComputedStyle(header);
                w = parseInt(styles.width, 10);
                
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                resizer.classList.add('resizing');
            };
            
            const mouseMoveHandler = function(e) {
                const dx = x - e.clientX; // RTL: drag left increases width
                header.style.width = `${w + dx}px`;
                header.style.minWidth = `${w + dx}px`; // Force min-width
            };
            
            const mouseUpHandler = function() {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                resizer.classList.remove('resizing');
            };
            
            resizer.addEventListener('mousedown', mouseDownHandler);
        });
    });

</script>
{% endblock %}