# -*- coding: utf-8 -*-
"""
Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª
- Ø«ÙŠÙ… Ø¯Ø§ÙƒÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
- Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQLite
- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„ Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø±Ù†Ø© (ØªØªØ¶Ù…Ù† "Ø­ Ø§Ù„Ø¶Ù…Ø§Ù†" Ùˆ"Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©)")
- ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† (Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ/Ø³Ø§Ø¨/Ø§Ù„Ø±ÙŠØ§Ø¶/Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡)
- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ) Ù…Ø¹ ÙØªØ±Ø§Øª Ø§Ù„Ø³Ù…Ø§Ø­
- ÙÙ„Ø§ØªØ± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ø¨Ù†Ùƒ ÙÙ‚Ø· + Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
- Ø¥Ø²Ø§Ù„Ø© ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ²Ø± Ø§Ù„Ø­Ø§Ù„Ø©
- Ø§Ù„ØªÙØ§Ù Ù†Øµ Ù„Ø«Ù„Ø§Ø«Ø© Ø£Ø¹Ù…Ø¯Ø© Ø·ÙˆÙŠÙ„Ø©ØŒ ÙˆØ¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ØµÙ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
- Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªØºÙ„Ù‚ Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ…
"""
import sys, os, sqlite3, re, subprocess
try:
    import requests
except ImportError:
    pass

# Fix for Qt platform plugin "windows" not found error
# Must be set before importing PyQt5 (which happens in reports_handler)
qt_plugin_path = os.path.join(sys.prefix, 'Lib', 'site-packages', 'PyQt5', 'Qt5', 'plugins')
if os.path.exists(qt_plugin_path):
    os.environ['QT_QPA_PLATFORM_PLUGIN_PATH'] = qt_plugin_path

from reports_handler import ReportsHandler
from logger import log_error, log_info


# Import centralized database support
try:
    from importlib.util import find_spec
    DATABASE_ADAPTER_AVAILABLE = bool(find_spec("db_adapter"))
except Exception:
    DATABASE_ADAPTER_AVAILABLE = False


# ==== PATCH: Ensure "Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶" appears in department dropdowns ====
def _ensure_default_departments_on_combo(combo):
    try:
        # Ø­Ù…Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØµØµØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¶Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        defaults = ["Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"]
        for d in (_read_custom_departments() + defaults):
            if combo.findText(d) < 0:
                combo.addItem(d)
    except Exception:
        pass

# Hook 1: after dialog loads options, guarantee default department

# Hook 2: after MainWindow reloads departments, guarantee default department
def _PATCH_after_main_reload_departments(self):
    try:
        if hasattr(self, "cmb_dept"):
            _ensure_default_departments_on_combo(self.cmb_dept)
    except Exception:
        pass
# ==== END PATCH ====
# ==== BANK PATCH: Ensure default banks (incl. Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶) appear in bank dropdowns/filters ====
def _ensure_default_banks_on_combo(combo):
    try:
        # Ø­Ù…Ù„ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…Ø®ØµØµØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¶Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª
        defaults = ["Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³Ø§Ø¨", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ", "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]
        for b in (_read_custom_banks() + defaults):
            if combo.findText(b) < 0:
                combo.addItem(b)
    except Exception:
        pass

def _PATCH_after_dialog_load_options(self):
    try:
        if hasattr(self, "cmb_dept"):
            _ensure_default_departments_on_combo(self.cmb_dept)
        if hasattr(self, "cmb_bank"):
            _ensure_default_banks_on_combo(self.cmb_bank)
    except Exception:
        pass

def _PATCH_after_main_reload_banks(self):
    try:
        # Try to locate common bank combos in MainWindow (filters etc.)
        for name in ("cmb_bank", "cmb_filter_bank", "cmbBank", "cmbBanks"):
            combo = getattr(self, name, None)
            if combo is not None:
                _ensure_default_banks_on_combo(combo)
    except Exception:
        pass
# ==== END BANK PATCH ====

# Fallback imports for PyQt5 compatibility
try:
    from PyQt5 import QtCore, QtGui, QtWidgets  # type: ignore
except ImportError:
    # If PyQt5 is not available, try PySide2 as an alternative
    try:
        from PySide2 import QtCore, QtGui, QtWidgets  # type: ignore
    except ImportError:
        # If neither is available, raise an informative error
        raise ImportError(
            "Neither PyQt5 nor PySide2 could be resolved. "
            "Please install one of them: "
            "'pip install PyQt5' or 'pip install PySide2'"
        )


# ---- helper: normalize Arabic/RTL header names (placed early so all modules can use it) ----
def _norm_col_name(txt):
    try:
        if txt is None:
            return ""
        s = str(txt)
        # remove RTL marks
        s = s.replace("\u200f", "").replace("\u200e", "").replace("Ù€", "")
        # unifiy common Arabic variants
        s = (s.replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
             .replace("Ù‰", "ÙŠ").replace("Ø©", "Ù‡"))
        # collapse spaces
        s = " ".join(s.split())
        return s.strip()
    except Exception:
        return str(txt or "")


from pathlib import Path
from datetime import date, timedelta

from PyQt5 import QtCore, QtGui, QtWidgets, QtPrintSupport  # type: ignore

def log_audit(action, target, details, user="System"):
    try:
        from db_adapter import connect_db
        conn = connect_db()
        c = conn.cursor()
        c.execute("INSERT INTO audit_log (user, action, target, details) VALUES (?, ?, ?, ?)",
                  (user, action, target, details))
        conn.commit()
        conn.close()
    except Exception as e:
        pass

import resources_rc
_ = resources_rc
import json


# Optional: PDF thumbnails via PyMuPDF
try:
    import fitz  # type: ignore # PyMuPDF
    HAVE_PYMUPDF = True
except Exception:
    HAVE_PYMUPDF = False

APP_TITLE = "Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª"




class LoansWindow(QtWidgets.QMainWindow):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶")
        self.resize(1100, 700)
        # Toolbar (right-aligned under RTL)
        tb = QtWidgets.QToolBar(self)
        try:
            tb.setMovable(False)
            tb.setIconSize(QtCore.QSize(24, 24))
            tb.setLayoutDirection(QtCore.Qt.RightToLeft)
        except Exception:
            pass
        self.addToolBar(tb)
        self.module_switch = QtWidgets.QComboBox()
        self.module_switch.addItems(["Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶"])
        try:
            self.module_switch.setCurrentIndex(1)
        except Exception:
            pass
        try:
            self.module_switch.currentIndexChanged.connect(lambda idx: self._switch_module("guarantees") if int(idx) == 0 else None)
        except Exception:
            pass
        # Buttons (match MainWindow style/size)
        def make_btn(txt, tip):
            b = QtWidgets.QToolButton()
            b.setText(txt)
            b.setToolTip(tip)
            b.setStyleSheet(
                """
                QToolButton {
                    font-size: 18px;
                    background-color: transparent;
                    border: none;
                    padding: 4px;
                    min-width: 28px;
                    min-height: 28px;
                }
                QToolButton:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    border-radius: 3px;
                }
                """
            )
            return b
        btn_settings = make_btn("âš™", "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
        btn_excel = make_btn("ğŸ“Š", "ØªØµØ¯ÙŠØ± Excel")
        btn_print = make_btn("ğŸ–¨", "Ø·Ø¨Ø§Ø¹Ø©")
        btn_pdf = make_btn("ğŸ“„", "ØªØµØ¯ÙŠØ± PDF")
        btn_add = make_btn("+", "Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø¶")
        btn_add.setStyleSheet(
            """
            QToolButton {
                font-size: 16px;
                font-weight: bold;
                color: #2e7d32;
                background-color: transparent;
                border: 1px solid #2e7d32;
                border-radius: 3px;
                padding: 2px 6px;
                min-width: 28px;
                min-height: 28px;
            }
            QToolButton:hover {
                background-color: #2e7d32;
                color: white;
            }
            """
        )
        btn_del = make_btn("ğŸ—‘", "Ø­Ø°Ù Ù‚Ø±Ø¶")
        btn_del.setStyleSheet(
            """
            QToolButton {
                font-size: 16px;
                font-weight: bold;
                color: #c62828;
                background-color: transparent;
                border: 1px solid #c62828;
                border-radius: 3px;
                padding: 2px 6px;
                min-width: 28px;
                min-height: 28px;
            }
            QToolButton:hover {
                background-color: #c62828;
                color: white;
            }
            """
        )
        btn_edit = make_btn("âœï¸", "ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø±Ø¶")
        tb.addWidget(btn_settings)
        tb.addSeparator(); tb.addWidget(btn_excel); tb.addWidget(btn_print); tb.addWidget(btn_pdf)
        tb.addSeparator(); tb.addWidget(btn_add); tb.addWidget(btn_edit); tb.addWidget(btn_del)
        spacer = QtWidgets.QWidget()
        spacer.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Preferred)
        tb.addWidget(spacer)
        tb.addWidget(self.module_switch)
        # Central widget
        cw = QtWidgets.QWidget(self)
        self.setCentralWidget(cw)
        v = QtWidgets.QVBoxLayout(cw)
        # Removed global cybor control per request
        # Tabs per bank with a type filter (long/short) and single table
        self.tabs = QtWidgets.QTabWidget(self); v.addWidget(self.tabs)
        self.bank_views = {}
        for bank in self._load_loans_banks():
            view = self._create_bank_tab()
            self.bank_views[bank] = view
            self.tabs.addTab(view["container"], bank)
        # Active table alias defaults to first bank
        first_bank = self._load_loans_banks()[0]
        self.table = self.bank_views[first_bank]["table"]
        def _on_tab_changed(i):
            try:
                _ = self.tabs.widget(i)
                # find bank name
                bank = self.tabs.tabText(i)
                self.table = self.bank_views.get(bank, {}).get("table", self.table)
            except Exception:
                pass
        self.tabs.currentChanged.connect(_on_tab_changed)
        self._editing = False
        self._loading = False
        # itemChanged connected per-table in _create_loans_table
        btn_settings.clicked.connect(self.show_loans_settings_dialog)
        btn_excel.clicked.connect(self._export_excel)
        btn_print.clicked.connect(self._print_loans)
        btn_pdf.clicked.connect(self._export_pdf)
        btn_add.clicked.connect(self._add_row)
        btn_edit.clicked.connect(self._edit_row)
        btn_del.clicked.connect(self._del_row)
        try:
            self._load_all_banks_from_db()
        except Exception:
            self._seed_initial_rows(5)
        try:
            _logo = _read_brand_logo_path()
        except Exception:
            _logo = ""
        try:
            self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
            self._embedded_splash.show()
            self._embedded_splash.raise_()
        except Exception:
            self._embedded_splash = None
    def _switch_module(self, target):
        try:
            cur_user = getattr(self, "current_user", "")
        except Exception:
            cur_user = ""
        try:
            w = MainWindow() if str(target) == "guarantees" else LoansWindow()
        except Exception:
            w = MainWindow()
        try:
            w.current_user = cur_user
        except Exception:
            pass
        try:
            w.show()
        except Exception:
            pass
        try:
            self.close()
        except Exception:
            pass

        try:
            self._setup_field_suggestions()
        except Exception:
            pass
    def _load_loans_banks(self):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            banks = s.value("loans/banks", type=list) or ["Ø§Ù„Ø£Ù‡Ù„ÙŠ","Ø³Ø§Ø¨","Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ","Ø§Ù„Ø±ÙŠØ§Ø¶","Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]
            # normalize and uniques
            banks = [str(b).strip() for b in banks if str(b).strip()]
            if not banks:
                banks = ["Ø§Ù„Ø£Ù‡Ù„ÙŠ","Ø³Ø§Ø¨","Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ","Ø§Ù„Ø±ÙŠØ§Ø¶","Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]
            return list(dict.fromkeys(banks))
        except Exception:
            return ["Ø§Ù„Ø£Ù‡Ù„ÙŠ","Ø³Ø§Ø¨","Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ","Ø§Ù„Ø±ÙŠØ§Ø¶","Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]

    def _save_loans_banks(self, banks):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            s.setValue("loans/banks", list(dict.fromkeys([str(b).strip() for b in banks if str(b).strip()])))
        except Exception:
            pass

    def _create_loans_table(self):
        t = QtWidgets.QTableWidget(self)
        t.setColumnCount(14)
        t.setHorizontalHeaderLabels([
            "Ø±Ù‚Ù… Ø§Ù„Ù‚Ø±Ø¶","Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø¶","Ø£ØµÙ„ Ø§Ù„Ù‚Ø±Ø¶","Ø§Ù„Ù…Ø³Ø¯Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø±Ø¶","Ø§Ù„Ù‚Ø§Ø¦Ù… Ù…Ù† Ø§Ù„Ù‚Ø±Ø¶","Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø±Ø¶","Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø±Ø¶","Ù…Ø¯Ø© Ø§Ù„Ù‚Ø±Ø¶ (ÙŠÙˆÙ…)",
            "Ø³Ø¹Ø± Ø§Ù„ÙØ§Ø¦Ø¯Ø©","Ø³Ø§ÙŠØ¨Ø±","Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§Ø¦Ø¯Ø©","ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ÙØªØ±Ø©","Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚","Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯",
        ])
        try:
            t.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        except Exception:
            pass
        t.itemChanged.connect(lambda it, _t=t: self._on_item_changed_table(_t, it))
        t.cellDoubleClicked.connect(lambda r,c, _t=t: self._on_cell_dblclicked_table(_t, r, c))
        return t

    def _create_bank_tab(self):
        cont = QtWidgets.QWidget(self)
        lay = QtWidgets.QVBoxLayout(cont)
        # Filter
        hb = QtWidgets.QHBoxLayout()
        lbl = QtWidgets.QLabel("ØªØµÙÙŠØ© Ø§Ù„Ù†ÙˆØ¹:")
        cmb = QtWidgets.QComboBox(cont); cmb.addItems(["Ø§Ù„ÙƒÙ„","Ø·ÙˆÙŠÙ„ Ø§Ù„Ø§Ø¬Ù„","Ù‚ØµÙŠØ± Ø§Ù„Ø§Ø¬Ù„"])
        hb.addWidget(lbl); hb.addWidget(cmb)
        try:
            hb.addStretch(1)
        except Exception:
            pass
        lay.addLayout(hb)
        # Single table
        tbl = self._create_loans_table()
        try:
            tbl.installEventFilter(self)
        except Exception:
            pass
        lay.addWidget(tbl)
        # Hook filter
        def _apply_filter():
            mode = cmb.currentText().strip()
            try:
                for r in range(tbl.rowCount()):
                    t = (self._get_text(r, 1) or "").strip()
                    hide = False
                    if mode == "Ø·ÙˆÙŠÙ„ Ø§Ù„Ø§Ø¬Ù„":
                        hide = (t != "Ø·ÙˆÙŠÙ„ Ø§Ù„Ø§Ø¬Ù„")
                    elif mode == "Ù‚ØµÙŠØ± Ø§Ù„Ø§Ø¬Ù„":
                        hide = (t != "Ù‚ØµÙŠØ± Ø§Ù„Ø§Ø¬Ù„")
                    else:
                        hide = False
                    try:
                        tbl.setRowHidden(r, hide)
                    except Exception:
                        pass
            except Exception:
                pass
        try:
            cmb.currentTextChanged.connect(lambda *_: _apply_filter())
        except Exception:
            pass
        return {"container": cont, "table": tbl, "filter": cmb}

    def eventFilter(self, obj, event):
        try:
            if event.type() in (QtCore.QEvent.FocusIn, QtCore.QEvent.MouseButtonPress):
                for view in self.bank_views.values():
                    if obj is view.get("table"):
                        self.table = obj
                        break
        except Exception:
            pass
        return super().eventFilter(obj, event)

    def _on_item_changed_table(self, table, item):
        if self._editing or self._loading or item is None:
            return
        prev = self.table
        try:
            self.table = table
            self._on_item_changed(item)
        finally:
            self.table = prev

    def _on_cell_dblclicked_table(self, table, r, c):
        prev = self.table
        try:
            self.table = table
            rid = self._get_row_id(r)
            if rid is None:
                try:
                    self._persist_row(r)
                    rid = self._get_row_id(r)
                except Exception:
                    pass
            if rid is None:
                return
            try:
                if c == 2:
                    dlg = InstallmentsDialog(self, rid)
                elif c == 4:
                    dlg = RepaymentsDialog(self, rid)
                else:
                    dlg = None
                if dlg:
                    dlg.exec_()
            except Exception:
                pass
        finally:
            self.table = prev
    def _refresh_loan_totals(self, loan_id):
        repaid = 0.0
        principal = 0.0
        try:
            conn = connect_db(); c = conn.cursor()
            row = c.execute("SELECT principal FROM loans WHERE id=?", (int(loan_id),)).fetchone()
            if row:
                principal = float(row[0] or 0.0)
            row2 = c.execute("SELECT COALESCE(SUM(amount),0) FROM repayments WHERE loan_id=? AND COALESCE(roll_over,0)=0", (int(loan_id),)).fetchone()
            if row2:
                repaid = float(row2[0] or 0.0)
            outstanding = max(0.0, principal - repaid)
            c.execute("UPDATE loans SET repaid=?, outstanding=? WHERE id=?", (repaid, outstanding, int(loan_id)))
            conn.commit(); conn.close()
        except Exception:
            pass
        try:
            for view in self.bank_views.values():
                tbl = view.get("table")
                if not tbl:
                    continue
                prev = self.table; self.table = tbl
                try:
                    for r in range(tbl.rowCount()):
                        if self._get_row_id(r) == int(loan_id):
                            self._set_text(r, 2, self._format_amount(principal))
                            self._set_text(r, 3, self._format_amount(repaid))
                            self._set_text(r, 4, self._format_amount(max(0.0, principal - repaid)))
                            self._compute_row(r)
                            self._persist_row(r)
                            break
                finally:
                    self.table = prev
        except Exception:
            pass

    def _add_row(self):
        # Default bank is current tab
        cur_bank = ""
        try:
            cur_bank = self.tabs.tabText(self.tabs.currentIndex())
        except Exception:
            cur_bank = ""
        dlg = LoanFormDialog(self, default_cybor=0.0, banks=self._load_loans_banks(), current_bank=cur_bank)
        if dlg.exec_() != QtWidgets.QDialog.Accepted:
            return
        data = dlg.result_values()
        def _pd(x):
            d = parse_date(x)
            return d
        d1 = _pd(data.get("start_date"))
        d2 = _pd(data.get("end_date"))
        days = 0
        if d1 and d2:
            try:
                days = max(0, (d2 - d1).days)
            except Exception:
                days = 0
        rp = float(data.get("rate_percent", 0.0))
        cy = float(data.get("cybor_percent", 0.0))
        tp = rp + cy
        outst = float(data.get("principal", 0.0)) - 0.0
        period_interest = outst * (tp / 100.0) / 360.0 * float(days)
        total_due = outst + period_interest
        try:
            conn = connect_db(); c = conn.cursor()
            c.execute(
                "INSERT INTO loans (bank, loan_type, principal, repaid, outstanding, start_date, end_date, duration_days, rate_percent, cybor_percent, total_percent, period_interest, total_due, sector) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)",
                (
                    data.get("bank",""), data.get("loan_type",""), float(data.get("principal",0.0)), float(0.0), float(outst),
                    data.get("start_date"), data.get("end_date"), int(days), float(rp), float(cy), float(tp),
                    float(period_interest), float(total_due), data.get("sector","")
                )
            )
            conn.commit()
            rid = c.lastrowid
            conn.close()
        except Exception:
            rid = None
        # Insert into the correct bank/tab (long vs short)
        target_bank = data.get("bank", cur_bank)
        view = self.bank_views.get(target_bank)
        if view:
            tbl = view["table"]
        else:
            tbl = self.table
        prev = self.table; self.table = tbl
        r = tbl.rowCount()
        tbl.insertRow(r)
        if rid is not None:
            self._set_row_id(r, rid)
        # Ø±Ù‚Ù… Ø§Ù„Ù‚Ø±Ø¶
        self._set_text(r, 0, str(int(rid or 0)))
        self._set_text(r, 1, data.get("loan_type",""))
        self._set_text(r, 2, self._format_amount(data.get("principal",0.0)))
        self._set_text(r, 3, self._format_amount(0.0))
        self._set_text(r, 4, self._format_amount(outst))
        self._set_text(r, 5, format_date_for_view(data.get("start_date")))
        self._set_text(r, 6, format_date_for_view(data.get("end_date")))
        self._set_text(r, 7, str(int(days)))
        self._set_text(r, 8, self._format_percent(rp))
        self._set_text(r, 9, self._format_percent(cy))
        self._set_text(r, 10, self._format_percent(tp))
        self._set_text(r, 11, self._format_amount(period_interest))
        self._set_text(r, 12, self._format_amount(total_due))
        self._set_text(r, 13, data.get("sector",""))
        self.table = prev

    def _edit_row(self):
        r = self.table.currentRow()
        if r < 0:
            return
        rid = self._get_row_id(r)
        try:
            if rid is None:
                self._persist_row(r)
                rid = self._get_row_id(r)
        except Exception:
            pass
        cur_bank = ""
        try:
            cur_bank = self.tabs.tabText(self.tabs.currentIndex())
        except Exception:
            cur_bank = ""
        initial = {
            "bank": cur_bank,
            "loan_type": self._get_text(r, 1),
            "principal": self._parse_amount(self._get_text(r, 2)) or 0.0,
            "outstanding": self._parse_amount(self._get_text(r, 4)) or 0.0,
            "start_date": self._get_text(r, 5),
            "end_date": self._get_text(r, 6),
            "rate_percent": self._parse_percent(self._get_text(r, 8)) or 0.0,
            "cybor_percent": self._parse_percent(self._get_text(r, 9)) or 0.0,
            "sector": self._get_text(r, 13),
        }
        dlg = LoanFormDialog(self, default_cybor=0.0, banks=self._load_loans_banks(), current_bank=cur_bank, initial=initial)
        if dlg.exec_() != QtWidgets.QDialog.Accepted:
            return
        data = dlg.result_values()
        d1 = parse_date(data.get("start_date"))
        d2 = parse_date(data.get("end_date"))
        days = 0
        if d1 and d2:
            try:
                days = max(0, (d2 - d1).days)
            except Exception:
                days = 0
        rp = float(data.get("rate_percent", 0.0))
        cy = float(data.get("cybor_percent", 0.0))
        tp = rp + cy
        principal = float(data.get("principal", 0.0))
        outst = float(data.get("outstanding", 0.0))
        repaid = max(0.0, principal - outst)
        try:
            conn = connect_db(); c = conn.cursor()
            c.execute(
                "UPDATE loans SET bank=?, loan_type=?, principal=?, repaid=?, outstanding=?, start_date=?, end_date=?, duration_days=?, rate_percent=?, cybor_percent=?, total_percent=?, period_interest=?, total_due=?, sector=? WHERE id=?",
                (
                    data.get("bank",""), data.get("loan_type",""), float(principal), float(repaid), float(outst),
                    data.get("start_date"), data.get("end_date"), int(days), float(rp), float(cy), float(tp),
                    float(outst * (tp/100.0) / 360.0 * float(days)), float(outst + (outst * (tp/100.0) / 360.0 * float(days))), data.get("sector",""), int(rid or 0)
                )
            )
            conn.commit()
            conn.close()
        except Exception:
            try: conn.close()
            except Exception: pass
        self._editing = True
        try:
            self._set_text(r, 1, data.get("loan_type",""))
            self._set_text(r, 2, self._format_amount(principal))
            self._set_text(r, 3, self._format_amount(repaid))
            self._set_text(r, 4, self._format_amount(outst))
            self._set_text(r, 5, format_date_for_view(data.get("start_date")))
            self._set_text(r, 6, format_date_for_view(data.get("end_date")))
            self._set_text(r, 7, str(int(days)))
            self._set_text(r, 8, self._format_percent(rp))
            self._set_text(r, 9, self._format_percent(cy))
            self._set_text(r, 10, self._format_percent(tp))
            self._compute_row(r)
        finally:
            self._editing = False
        try:
            self._load_all_banks_from_db()
        except Exception:
            pass

    def show_loans_settings_dialog(self):
        try:
            dlg = LoansSettingsDialog(self)
        except Exception:
            dlg = None
        if dlg:
            try:
                dlg.exec_()
            except Exception:
                pass
        # After settings may change banks list, rebuild tabs
        try:
            self._rebuild_bank_tabs()
        except Exception:
            pass

    def _del_row(self):
        r = self.table.currentRow()
        if r >= 0:
            rid = self._get_row_id(r)
            try:
                if rid is not None:
                    conn = connect_db(); c = conn.cursor()
                    c.execute("DELETE FROM loans WHERE id=?", (rid,))
                    conn.commit(); conn.close()
            except Exception:
                try:
                    conn.close()
                except Exception:
                    pass
            self.table.removeRow(r)

    def _seed_initial_rows(self, n):
        for _ in range(int(n)):
            self._add_row()

    def _on_item_changed(self, item):
        if self._editing or self._loading or item is None:
            return
        r = item.row()
        c = item.column()
        if c in (2, 3, 4, 5, 7, 8):
            self._editing = True
            try:
                try:
                    p = self._parse_amount(self._get_text(r, 2)) or 0.0
                    rep = self._parse_amount(self._get_text(r, 3)) or 0.0
                    self._set_text(r, 4, self._format_amount(max(0.0, p - rep)))
                except Exception:
                    pass
                self._reformat_inputs(r)
                self._compute_row(r)
                self._persist_row(r)
            finally:
                self._editing = False
        elif c in (1, 13):
            self._editing = True
            try:
                self._persist_row(r)
            finally:
                self._editing = False

    def _reformat_inputs(self, r):
        def set_text(ci, txt):
            it = self.table.item(r, ci)
            if it is None:
                it = QtWidgets.QTableWidgetItem()
                self.table.setItem(r, ci, it)
            it.setText(str(txt))
            try:
                it.setTextAlignment(QtCore.Qt.AlignCenter)
            except Exception:
                pass
        a1 = self._parse_amount(self._get_text(r, 2))
        if a1 is not None:
            set_text(2, self._format_amount(a1))
        a2 = self._parse_amount(self._get_text(r, 3))
        if a2 is not None:
            set_text(3, self._format_amount(a2))
        s = self._parse_percent(self._get_text(r, 8))
        if s is not None:
            set_text(8, self._format_percent(s))
        cy = self._parse_percent(self._get_text(r, 9))
        if cy is not None:
            set_text(9, self._format_percent(cy))
        d1 = self._parse_date(self._get_text(r, 5))
        if d1 is not None:
            set_text(5, format_date_for_view(d1))
        d2 = self._parse_date(self._get_text(r, 6))
        if d2 is not None:
            set_text(6, format_date_for_view(d2))

    def _compute_row(self, r):
        d1 = self._parse_date(self._get_text(r, 5))
        d2 = self._parse_date(self._get_text(r, 6))
        days = 0
        if d1 and d2:
            days = max(0, (d2 - d1).days)
        self._set_text(r, 7, str(days))
        s = self._parse_percent(self._get_text(r, 8)) or 0.0
        cy = self._parse_percent(self._get_text(r, 9)) or 0.0
        total_p = s + cy
        self._set_text(r, 10, self._format_percent(total_p))
        outstanding = self._parse_amount(self._get_text(r, 4)) or 0.0
        period_interest = outstanding * (total_p / 100.0) / 360.0 * float(days)
        self._set_text(r, 11, self._format_amount(period_interest))
        total_due = outstanding + period_interest
        self._set_text(r, 12, self._format_amount(total_due))

    def _get_text(self, r, c):
        it = self.table.item(r, c)
        return "" if it is None else it.text()

    def _set_text(self, r, c, txt):
        it = self.table.item(r, c)
        if it is None:
            it = QtWidgets.QTableWidgetItem()
            self.table.setItem(r, c, it)
        it.setText(str(txt))
        try:
            it.setTextAlignment(QtCore.Qt.AlignCenter)
        except Exception:
            pass

    def _parse_amount(self, txt):
        t = str(txt or "").replace(",", "").strip()
        if not t:
            return None
        try:
            return float(t)
        except Exception:
            return None

    def _format_amount(self, v):
        try:
            return "{:,.2f}".format(float(v))
        except Exception:
            return str(v)

    def _parse_percent(self, txt):
        t = str(txt or "").replace("%", "").strip()
        if not t:
            return None
        try:
            return float(t)
        except Exception:
            return None

    def _format_percent(self, v):
        try:
            f = float(v)
            s = "{:.4f}".format(f).rstrip("0").rstrip(".")
            if s in ("-0", "0", "-0.0"):
                s = "0"
            return s + "%"
        except Exception:
            return str(v)

    def _parse_date(self, txt):
        try:
            return parse_date(txt)
        except Exception:
            return None

    def _format_date(self, dt):
        try:
            return format_date_for_view(dt)
        except Exception:
            months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
            return "{:02d}{}-{}".format(int(dt.day), months[int(dt.month) - 1], int(dt.year))

    def _build_loans_html(self):
        cols = []
        for i in range(self.table.columnCount()):
            it = self.table.horizontalHeaderItem(i)
            cols.append(it.text() if it else f"Ø¹Ù…ÙˆØ¯ {i+1}")
        html = [
            "<html><head><meta charset='utf-8'><style>body{direction:rtl;font-family:'Tahoma';} table{border-collapse:collapse;width:100%} th,td{border:1px solid #888;padding:6px;text-align:center}</style></head><body>",
            "<h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø±ÙˆØ¶</h3>",
            "<table><tr>" + "".join([f"<th>{h}</th>" for h in cols]) + "</tr>"
        ]
        for r in range(self.table.rowCount()):
            html.append("<tr>")
            for c in range(self.table.columnCount()):
                it = self.table.item(r, c)
                html.append(f"<td>{'' if it is None else it.text()}</td>")
            html.append("</tr>")
        if self.table.rowCount() == 0:
            html.append("<tr><td colspan='" + str(self.table.columnCount()) + "' style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>")
        html.append("</table></body></html>")
        return "".join(html)

    def _render_branded(self, printer, doc):
        cfg = load_brand_settings(self)
        painter = QtGui.QPainter(printer)
        rect_pt = printer.pageRect(QtPrintSupport.QPrinter.Point)
        content = QtCore.QRectF(rect_pt)
        y_offset = 0
        if cfg.get("logo_enabled") and cfg.get("logo_path"):
            lp = QtGui.QPixmap(cfg["logo_path"])
            if not lp.isNull():
                h = max(16, int(cfg.get("logo_height", 48)))
                lp2 = lp.scaledToHeight(h, QtCore.Qt.SmoothTransformation)
                painter.drawPixmap(30, 30, lp2)
                y_offset = 30 + lp2.height() + 10
        if cfg.get("wm_enabled") and cfg.get("wm_path"):
            pm = QtGui.QPixmap(cfg["wm_path"]) 
            if not pm.isNull():
                vp = painter.viewport()
                size = int(min(vp.width(), vp.height()) * float(cfg.get("wm_scale", 0.40)))
                pm2 = pm.scaled(size, size, QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation)
                painter.save()
                painter.setOpacity(float(cfg.get("wm_opacity", 0.08)))
                painter.drawPixmap(vp.x() + (vp.width() - pm2.width()) // 2,
                                   vp.y() + (vp.height() - pm2.height()) // 2, pm2)
                painter.restore()
        content.adjust(30, y_offset + 10, -30, -30)
        doc.setPageSize(QtCore.QSizeF(rect_pt.size()))
        painter.save()
        doc.drawContents(painter, content)
        painter.restore()
        painter.end()

    def _print_loans(self):
        printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
        
        # Apply Duplex & Printer Settings
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            
            # Printer
            p_name = s.value("print/printer_name", "")
            if p_name:
                printer.setPrinterName(p_name)
                
            # Duplex
            d_idx = s.value("print/duplex", 0, type=int)
            if d_idx == 1:
                printer.setDuplex(QtPrintSupport.QPrinter.DuplexLongSide)
            elif d_idx == 2:
                printer.setDuplex(QtPrintSupport.QPrinter.DuplexShortSide)
            else:
                printer.setDuplex(QtPrintSupport.QPrinter.DuplexNone)
        except Exception:
            pass
            
        dlg = QtPrintSupport.QPrintDialog(printer, self)
        if dlg.exec_() == QtWidgets.QDialog.Accepted:
            doc = QtGui.QTextDocument()
            doc.setHtml(self._build_loans_html())
            self._render_branded(printer, doc)

    def _export_pdf(self):
        path, _ = QtWidgets.QFileDialog.getSaveFileName(self, "Ø­ÙØ¸ PDF", "loans.pdf", "PDF (*.pdf)")
        if not path:
            return
        printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
        printer.setOutputFormat(QtPrintSupport.QPrinter.PdfFormat)
        try:
            printer.setOutputFileName(path)
        except Exception:
            pass
        doc = QtGui.QTextDocument()
        doc.setHtml(self._build_loans_html())
        self._render_branded(printer, doc)

    def _export_excel(self):
        try:
            _fallback_export_excel(self)
        except Exception:
            pass

    def _show_brand_settings_loans(self):
        try:
            dlg = WatermarkSettingsDialog(self)
            if dlg.exec_() == QtWidgets.QDialog.Accepted:
                vals = dlg.result_values()
                s = QtCore.QSettings("GuaranteesApp", "Main")
                for k, v in vals.items():
                    s.setValue(k, v)
                self.apply_brand_settings()
        except Exception:
            pass

    def _apply_cybor_to_table(self):
        return

    def _rebuild_bank_tabs(self):
        banks = self._load_loans_banks()
        # Add new banks
        for bname in banks:
            if bname not in self.bank_views:
                view = self._create_bank_tab()
                self.bank_views[bname] = view
                self.tabs.addTab(view["container"], bname)
        # Remove banks not listed
        for bname in list(self.bank_views.keys()):
            if bname not in banks:
                view = self.bank_views.pop(bname)
                try:
                    idx = self.tabs.indexOf(view["container"])
                    if idx >= 0:
                        self.tabs.removeTab(idx)
                except Exception:
                    pass
        # Reload data for all
        try:
            self._load_all_banks_from_db()
        except Exception:
            pass

    def load_loans_column_settings(self):
        s = QtCore.QSettings("GuaranteesApp", "Main")
        order = s.value("loans/columns/order", type=list)
        hidden_by_name = s.value("loans/columns/hidden_by_name", type=dict)
        if order is None:
            order = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
        if not isinstance(hidden_by_name, dict):
            hidden_by_name = {}
        hidden_by_name = {str(k): bool(int(v)) if isinstance(v, (str, int)) else bool(v) for k, v in hidden_by_name.items()}
        return order, hidden_by_name

    def save_loans_column_settings(self, order, hidden_by_name):
        s = QtCore.QSettings("GuaranteesApp", "Main")
        s.setValue("loans/columns/order", order)
        hidden_str = {str(k): int(bool(v)) for k, v in hidden_by_name.items()}
        s.setValue("loans/columns/hidden_by_name", hidden_str)

    def apply_loans_column_settings(self, order, hidden_by_name):
        header = self.table.horizontalHeader()
        try:
            header.setSectionsMovable(True)
        except Exception:
            pass
        def _map():
            m = {}
            for i in range(self.table.columnCount()):
                it = self.table.horizontalHeaderItem(i)
                nm = (it.text().strip() if it else f"col_{i}")
                m[nm] = i
            return m
        try:
            self.table.setUpdatesEnabled(False)
            header.blockSignals(True)
            for desired_visual, name in enumerate(order):
                name_to_logical = _map()
                if name not in name_to_logical:
                    continue
                logical = name_to_logical[name]
                current_visual = header.visualIndex(logical)
                if current_visual != desired_visual and current_visual != -1:
                    header.moveSection(current_visual, desired_visual)
        finally:
            try:
                header.blockSignals(False)
                self.table.setUpdatesEnabled(True)
            except Exception:
                pass
        for i in range(self.table.columnCount()):
            try:
                name = (self.table.horizontalHeaderItem(i).text() or "").strip()
                self.table.setColumnHidden(i, bool(hidden_by_name.get(name, False)))
            except Exception:
                pass

    def save_loans_table_geometry(self):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            by_name = {}
            by_index = []
            try:
                for i in range(self.table.columnCount()):
                    it = self.table.horizontalHeaderItem(i)
                    nm = _norm_col_name(it.text() if it else str(i))
                    w = int(self.table.columnWidth(i))
                    by_name[nm] = w
                    by_index.append(w)
            except Exception:
                pass
            s.setValue("loans/columns/widths_by_name", by_name)
            s.setValue("loans/columns/widths_by_index", by_index)
            try:
                heights = [int(self.table.rowHeight(r)) for r in range(self.table.rowCount())]
            except Exception:
                heights = []
            s.setValue("loans/rows/heights", heights)
        except Exception:
            pass

    def load_loans_table_geometry(self):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            by_name = s.value("loans/columns/widths_by_name", type=dict) or {}
            if not isinstance(by_name, dict):
                by_name = {}
            by_name = {_norm_col_name(k): int(v) for k, v in by_name.items() if str(v).strip() != ""}
            by_index = s.value("loans/columns/widths_by_index", type=list) or []
            if not isinstance(by_index, list):
                by_index = []
            by_index = [int(v) for v in by_index if str(v).strip() != ""]
            heights = s.value("loans/rows/heights", type=list) or []
            if not isinstance(heights, list):
                heights = []
            heights = [int(h) for h in heights if str(h).strip() != ""]
            return by_name, by_index, heights
        except Exception:
            return {}, [], []

    def apply_loans_table_geometry(self, widths_by_name=None, widths_by_index=None, row_heights=None):
        try:
            if widths_by_name or widths_by_index:
                for i in range(self.table.columnCount()):
                    try:
                        it = self.table.horizontalHeaderItem(i)
                        nm = _norm_col_name(it.text() if it else str(i))
                        w = None
                        if widths_by_name and nm in widths_by_name:
                            w = int(widths_by_name[nm])
                        elif widths_by_index and i < len(widths_by_index):
                            w = int(widths_by_index[i])
                        if w and w > 0:
                            self.table.setColumnWidth(i, w)
                    except Exception:
                        pass
        except Exception:
            pass
        try:
            if row_heights and self.table.rowCount() > 0:
                m = min(self.table.rowCount(), len(row_heights))
                for r in range(m):
                    try:
                        h = int(row_heights[r])
                        if h > 0:
                            self.table.setRowHeight(r, h)
                    except Exception:
                        pass
        except Exception:
            pass

    def _show_loans_settings(self):
        dlg = QtWidgets.QDialog(self)
        dlg.setWindowTitle("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø±ÙˆØ¶")
        lay = QtWidgets.QVBoxLayout(dlg)
        grp_cols = QtWidgets.QGroupBox("ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©", dlg)
        gl = QtWidgets.QVBoxLayout(grp_cols)
        lst = QtWidgets.QListWidget(grp_cols)
        lst.setDragDropMode(QtWidgets.QAbstractItemView.InternalMove)
        lst.setDefaultDropAction(QtCore.Qt.MoveAction)
        headers = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
        order, hidden_by_name = self.load_loans_column_settings()
        names = order if (order and len(order) == len(headers)) else headers
        for nm in names:
            it = QtWidgets.QListWidgetItem(nm)
            it.setFlags(it.flags() | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsSelectable)
            it.setCheckState(QtCore.Qt.Checked if not hidden_by_name.get(nm, False) else QtCore.Qt.Unchecked)
            lst.addItem(it)
        gl.addWidget(lst)
        h1 = QtWidgets.QHBoxLayout()
        btn_apply_cols = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚", grp_cols)
        btn_save_cols = QtWidgets.QPushButton("Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚", grp_cols)
        def _read_cols():
            new_order = [lst.item(i).text() for i in range(lst.count())]
            new_hidden = {lst.item(i).text(): (lst.item(i).checkState() != QtCore.Qt.Checked) for i in range(lst.count())}
            return new_order, new_hidden
        btn_apply_cols.clicked.connect(lambda: self.apply_loans_column_settings(*_read_cols()))
        btn_save_cols.clicked.connect(lambda: (lambda x: (self.save_loans_column_settings(*x), self.apply_loans_column_settings(*x)))(_read_cols()))
        h1.addWidget(btn_apply_cols); h1.addWidget(btn_save_cols); h1.addStretch(1)
        gl.addLayout(h1)
        lay.addWidget(grp_cols)
        grp_sz = QtWidgets.QGroupBox("Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ", dlg)
        fl = QtWidgets.QFormLayout(grp_sz)
        sp_w = QtWidgets.QSpinBox(grp_sz); sp_w.setRange(20, 800); sp_w.setValue(120)
        sp_h = QtWidgets.QSpinBox(grp_sz); sp_h.setRange(12, 200); sp_h.setValue(28)
        fl.addRow("Ø¹Ø±Ø¶ Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:", sp_w)
        fl.addRow("Ø§Ø±ØªÙØ§Ø¹ Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ:", sp_h)
        lay.addWidget(grp_sz)
        h2 = QtWidgets.QHBoxLayout()
        btn_apply_w = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶", dlg)
        btn_apply_h = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹", dlg)
        btn_save_geom = QtWidgets.QPushButton("Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©", dlg)
        btn_restore_geom = QtWidgets.QPushButton("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©", dlg)
        btn_apply_w.clicked.connect(lambda: [self.table.setColumnWidth(i, int(sp_w.value())) for i in range(self.table.columnCount())])
        btn_apply_h.clicked.connect(lambda: [self.table.setRowHeight(r, int(sp_h.value())) for r in range(self.table.rowCount())])
        btn_save_geom.clicked.connect(self.save_loans_table_geometry)
        def _restore():
            by_name, by_index, heights = self.load_loans_table_geometry()
            self.apply_loans_table_geometry(by_name, by_index, heights)
        btn_restore_geom.clicked.connect(_restore)
        for _b in (btn_apply_w, btn_apply_h, btn_save_geom, btn_restore_geom):
            h2.addWidget(_b)
        h2.addStretch(1)
        lay.addLayout(h2)
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Close, dlg)
        lay.addWidget(btns)
        btns.rejected.connect(dlg.reject)
        try:
            dlg.exec_()
        except Exception:
            pass

    def _set_row_id(self, r, rid):
        it = self.table.item(r, 0)
        if it is None:
            it = QtWidgets.QTableWidgetItem()
            self.table.setItem(r, 0, it)
        it.setData(QtCore.Qt.UserRole, int(rid))

    def _get_row_id(self, r):
        it = self.table.item(r, 0)
        try:
            val = it.data(QtCore.Qt.UserRole)
            if val not in (None, ""):
                return int(val)
            # fallback: try parse visible text
            txt = it.text() if it else ""
            return None if str(txt).strip() == "" else int(float(str(txt).strip()))
        except Exception:
            return None

    def _persist_row(self, r):
        try:
            rid = self._get_row_id(r)
            # current bank name based on active table
            def _current_bank():
                try:
                    return self.tabs.tabText(self.tabs.currentIndex())
                except Exception:
                    return ""
            vals = {
                "bank": _current_bank() or None,
                "loan_type": self._get_text(r, 1) or None,
                "principal": self._parse_amount(self._get_text(r, 2)) or 0.0,
                "repaid": self._parse_amount(self._get_text(r, 3)) or 0.0,
                "outstanding": self._parse_amount(self._get_text(r, 4)) or 0.0,
                "start_date": self._get_text(r, 5) or None,
                "end_date": self._get_text(r, 6) or None,
                "duration_days": int(float(self._get_text(r, 7) or 0) or 0),
                "rate_percent": self._parse_percent(self._get_text(r, 8)) or 0.0,
                "cybor_percent": self._parse_percent(self._get_text(r, 9)) or 0.0,
                "total_percent": self._parse_percent(self._get_text(r, 10)) or 0.0,
                "period_interest": self._parse_amount(self._get_text(r, 11)) or 0.0,
                "total_due": self._parse_amount(self._get_text(r, 12)) or 0.0,
                "sector": self._get_text(r, 13) or None,
            }
            conn = connect_db(); c = conn.cursor()
            if rid is None:
                c.execute(
                    """
                    INSERT INTO loans (bank, loan_type, principal, repaid, outstanding, start_date, end_date,
                                       duration_days, rate_percent, cybor_percent, total_percent,
                                       period_interest, total_due, sector)
                    VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)
                    """,
                    (
                        vals["bank"],
                        vals["loan_type"], vals["principal"], vals["repaid"], vals["outstanding"],
                        vals["start_date"], vals["end_date"], vals["duration_days"],
                        vals["rate_percent"], vals["cybor_percent"], vals["total_percent"],
                        vals["period_interest"], vals["total_due"], vals["sector"],
                    )
                )
                conn.commit()
                rid = c.lastrowid
                self._set_row_id(r, rid)
            else:
                c.execute(
                    """
                    UPDATE loans SET bank=?, loan_type=?, principal=?, repaid=?, outstanding=?, start_date=?, end_date=?,
                                    duration_days=?, rate_percent=?, cybor_percent=?, total_percent=?,
                                    period_interest=?, total_due=?, sector=?
                    WHERE id=?
                    """,
                    (
                        vals["bank"],
                        vals["loan_type"], vals["principal"], vals["repaid"], vals["outstanding"],
                        vals["start_date"], vals["end_date"], vals["duration_days"],
                        vals["rate_percent"], vals["cybor_percent"], vals["total_percent"],
                        vals["period_interest"], vals["total_due"], vals["sector"], rid,
                    )
                )
                conn.commit()
            conn.close()
        except Exception:
            try:
                conn.close()
            except Exception:
                pass

    def _load_all_banks_from_db(self):
        self._loading = True
        try:
            conn = connect_db(); c = conn.cursor()
            for bank, view in self.bank_views.items():
                try:
                    rows = c.execute("SELECT id, bank, loan_type, principal, repaid, outstanding, start_date, end_date, duration_days, rate_percent, cybor_percent, total_percent, period_interest, total_due, sector FROM loans WHERE bank=? ORDER BY id DESC", (bank,)).fetchall()
                except Exception:
                    rows = []
                tbl = view["table"]; tbl.setRowCount(0)
                # helper to write into a table
                def _fill(tbl, rowdata):
                    prev = self.table; self.table = tbl
                    try:
                        rid, _bank_n, loan_type, principal, repaid, outstanding, start_date, end_date, duration_days, rate_percent, cybor_percent, total_percent, period_interest, total_due, sector = rowdata
                        r = tbl.rowCount(); tbl.insertRow(r)
                        self._set_row_id(r, rid)
                        # Ø±Ù‚Ù… Ø§Ù„Ù‚Ø±Ø¶ ÙŠØ¹Ø±Ø¶ id
                        self._set_text(r, 0, str(int(rid or 0)))
                        try:
                            it0 = self.table.item(r, 0)
                            if it0:
                                it0.setFlags(QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsEnabled)
                        except Exception:
                            pass
                        self._set_text(r, 1, loan_type or "")
                        self._set_text(r, 2, self._format_amount(principal or 0.0))
                        self._set_text(r, 3, self._format_amount(repaid or 0.0))
                        self._set_text(r, 4, self._format_amount(outstanding or 0.0))
                        self._set_text(r, 5, format_date_for_view(start_date) if start_date else "")
                        self._set_text(r, 6, format_date_for_view(end_date) if end_date else "")
                        self._set_text(r, 7, str(int(duration_days or 0)))
                        self._set_text(r, 8, self._format_percent(rate_percent or 0.0))
                        self._set_text(r, 9, self._format_percent(cybor_percent or 0.0))
                        self._set_text(r, 10, self._format_percent(total_percent or 0.0))
                        self._set_text(r, 11, self._format_amount(period_interest or 0.0))
                        self._set_text(r, 12, self._format_amount(total_due or 0.0))
                        self._set_text(r, 13, sector or "")
                    finally:
                        self.table = prev
                for row in rows:
                    _fill(tbl, row)
                # apply current filter
                try:
                    mode = view["filter"].currentText().strip()
                    for r in range(tbl.rowCount()):
                        t = (self._get_text(r, 1) or "").strip()
                        hide = False
                        if mode == "Ø·ÙˆÙŠÙ„ Ø§Ù„Ø§Ø¬Ù„":
                            hide = (t != "Ø·ÙˆÙŠÙ„ Ø§Ù„Ø§Ø¬Ù„")
                        elif mode == "Ù‚ØµÙŠØ± Ø§Ù„Ø§Ø¬Ù„":
                            hide = (t != "Ù‚ØµÙŠØ± Ø§Ù„Ø§Ø¬Ù„")
                        else:
                            hide = False
                        tbl.setRowHidden(r, hide)
                except Exception:
                    pass
            conn.close()
        finally:
            self._loading = False

# --- Lists persistence (departments/banks) ---
def _read_json_list(val, fallback=None):
    try:
        if isinstance(val, str) and val:
            lst = json.loads(val)
            if isinstance(lst, list):
                return [str(x).strip() for x in lst if str(x).strip()]
    except Exception:
        pass
    # QSettings Ù‚Ø¯ ÙŠÙØ¹ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    if isinstance(val, (list, tuple)):
        try:
            return [str(x).strip() for x in val if str(x).strip()]
        except Exception:
            pass
    # ØªÙ‚Ø³ÙŠÙ… Ù†ØµÙŠ Ø¨Ø¯ÙŠÙ„
    try:
        if isinstance(val, str) and val:
            return [s.strip() for s in val.split('|') if s.strip()]
    except Exception:
        pass
    return list(fallback or [])


def _read_custom_departments():
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        val = s.value("lists/departments", [])
        return _read_json_list(val, [])
    except Exception:
        return []

def _save_custom_departments(items):
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        s.setValue("lists/departments", json.dumps(list(dict.fromkeys([str(x).strip() for x in items if str(x).strip()])), ensure_ascii=False))
    except Exception:
        pass

def _read_custom_banks():
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        val = s.value("lists/banks", [])
        return _read_json_list(val, [])
    except Exception:
        return []

def _save_custom_banks(items):
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        s.setValue("lists/banks", json.dumps(list(dict.fromkeys([str(x).strip() for x in items if str(x).strip()])), ensure_ascii=False))
    except Exception:
        pass
# --- Branding helpers (logo path) ---
def _read_brand_logo_path():
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        p = s.value("logo/path", type=str) or ""
        return p
    except Exception:
        return ""


DB_NAME = "guarantees.db"

SAB_MARKERS = ("ATNHTS", "APNHTS", "APNGCU", "ATNGCU", "AFGGCU", "GST", "AFGWPM", "APNWPM", "ATNCBG", "APNCBG", "GIC")

# --- Portable application directory detection ---
def _get_app_dir():
    """Return the application directory - works for both script and EXE."""
    try:
        # For PyInstaller EXE
        if hasattr(sys, '_MEIPASS'):
            # When running as EXE, return the directory containing the EXE
            if hasattr(sys, 'frozen'):
                return Path(sys.executable).parent
        # For script, return directory containing the script
        return Path(__file__).resolve().parent
    except Exception:
        # Fallback to current directory
        return Path.cwd()

def _get_data_dir():
    """Return the data directory inside application directory."""
    app_dir = _get_app_dir()
    data_dir = app_dir / "data"
    try:
        data_dir.mkdir(parents=True, exist_ok=True)
    except Exception:
        pass
    return data_dir

def _get_portable_settings():
    """Return QSettings instance using portable INI format stored in data directory."""
    data_dir = _get_data_dir()
    ini_path = data_dir / "settings.ini"
    return QtCore.QSettings(str(ini_path), QtCore.QSettings.IniFormat)

# Patch QSettings after data directory functions are defined
def _patch_qsettings():
    """Patch QtCore.QSettings to use portable format for GuaranteesApp."""
    try:
        # Store original QSettings class
        if not hasattr(QtCore, '_OriginalQSettings'):
            QtCore._OriginalQSettings = QtCore.QSettings
        
        class PortableQSettingsWrapper:
            def __init__(self, *args, **kwargs):
                # If called with "GuaranteesApp" and "Main", use portable INI format
                if len(args) >= 2 and args[0] == "GuaranteesApp" and args[1] == "Main":
                    data_dir = _get_data_dir()
                    ini_path = data_dir / "settings.ini"
                    # Use original QSettings with INI format
                    self._settings = QtCore._OriginalQSettings(str(ini_path), QtCore.QSettings.IniFormat)
                else:
                    # For other calls, use original QSettings as-is
                    self._settings = QtCore._OriginalQSettings(*args, **kwargs)
            
            def __getattr__(self, name):
                return getattr(self._settings, name)
            
            def __enter__(self):
                return self._settings.__enter__()
            
            def __exit__(self, *args):
                return self._settings.__exit__(*args)
        
        # Replace QSettings class with wrapper
        QtCore.QSettings = PortableQSettingsWrapper
    except Exception:
        pass

def db_path():
    """Return a valid, writable DB path - PORTABLE (stored in app/data/ directory).
    
    This function now supports centralized database configuration.
    """
    if DATABASE_ADAPTER_AVAILABLE:
        # Use the adapter version
        from db_adapter import db_path as adapter_db_path
        return adapter_db_path()
    
    # Portable SQLite logic - stores DB in app/data/ directory
    r"""Return a valid, writable DB path - PORTABLE.

    - Stores database in {app_dir}/data/guarantees.db
    - Automatically migrates from old Documents location if exists
    """

    def _is_writable_dir(p: Path) -> bool:
        try:
            p.mkdir(parents=True, exist_ok=True)
            import os
            tf = p / (".__writable_" + next(iter("xy")))
            with open(tf, "w", encoding="utf-8") as f:
                f.write("ok")
            try:
                os.remove(str(tf))
            except Exception:
                pass
            return True
        except Exception:
            return False

    # Use portable data directory
    data_dir = _get_data_dir()
    new_db_path = data_dir / DB_NAME
    
    # Migrate from old Documents location if exists and new doesn't
    if not new_db_path.exists():
        old_db_path = Path.home() / "Documents" / "Guarantees" / DB_NAME
        if old_db_path.exists():
            try:
                # Ensure data directory exists
                data_dir.mkdir(parents=True, exist_ok=True)
                import shutil
                shutil.copy2(str(old_db_path), str(new_db_path))
                # Also try to migrate old QSettings location
                try:
                    old_settings = QtCore.QSettings("GuaranteesApp", "Main")
                    old_db_dir = old_settings.value("db/dir", type=str)
                    if old_db_dir and Path(old_db_dir).exists():
                        # Copy any attachments from old location
                        old_attachments = Path(old_db_dir) / "attachments"
                        new_attachments = data_dir / "attachments"
                        if old_attachments.exists() and not new_attachments.exists():
                            try:
                                import shutil
                                shutil.copytree(str(old_attachments), str(new_attachments))
                            except Exception:
                                pass
                except Exception:
                    pass
            except Exception:
                pass
    
    return str(new_db_path)


def connect_db():
    """Create a database connection with support for both SQLite and PostgreSQL.
    
    Returns:
        Database connection object (sqlite3.Connection or psycopg2 connection)
    """
    if DATABASE_ADAPTER_AVAILABLE:
        from db_adapter import connect_db as adapter_connect_db
        return adapter_connect_db()
    
    # Original SQLite logic
    """Create a SQLite connection with sane concurrency defaults.

    - Set a busy timeout to wait for locks instead of failing immediately.
    - Enable WAL journal mode for better read/write concurrency.
    - Use NORMAL synchronous for performance while keeping safety acceptable.
    """
    conn = sqlite3.connect(db_path(), timeout=10.0, check_same_thread=False)
    try:
        conn.execute("PRAGMA busy_timeout=5000")
        conn.execute("PRAGMA journal_mode=WAL")
        conn.execute("PRAGMA synchronous=NORMAL")
        conn.execute("PRAGMA foreign_keys=ON")
    except Exception:
        # Pragmas are best-effort; continue even if any fails
        pass
    return conn

# moved above main block


def ensure_db():
    """Ensure database tables exist (compatibility wrapper for centralized database)."""
    if DATABASE_ADAPTER_AVAILABLE:
        from db_adapter import ensure_db as adapter_ensure_db
        return adapter_ensure_db()
    
    # Migrate old data first (runs on every startup to ensure data portability)
    migrate_old_db_if_any()
    
    # Create automatic backup (once per day)
    try:
        from datetime import datetime
        data_dir = _get_data_dir()
        last_backup_file = data_dir / ".last_backup"
        should_backup = True
        
        if last_backup_file.exists():
            try:
                last_backup_date = datetime.fromisoformat(last_backup_file.read_text(encoding='utf-8').strip())
                # Backup only once per day
                if (datetime.now() - last_backup_date).days < 1:
                    should_backup = False
            except Exception:
                pass
        
        if should_backup:
            backup_path = create_backup()
            if backup_path:
                # Update last backup timestamp
                try:
                    last_backup_file.write_text(datetime.now().isoformat(), encoding='utf-8')
                except Exception:
                    pass
    except Exception:
        pass
    
    # Original SQLite logic (unchanged)
    conn = connect_db();
    c = conn.cursor()
    c.execute(
        """CREATE TABLE IF NOT EXISTS guarantees (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            department TEXT, bank TEXT, g_no TEXT,
            g_type TEXT, amount REAL, insurance_amount REAL, percent REAL,
            beneficiary TEXT, requester TEXT, project_name TEXT,
            issue_date TEXT, end_date TEXT,
            user_status TEXT, cash_flag INTEGER DEFAULT 0, attachment TEXT,
            delivery_status TEXT, recipient_name TEXT, notes TEXT, entry_number TEXT
        )"""
    )
    conn.commit();
    try:
        c.execute(
            """CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                pass_hash TEXT NOT NULL,
                role TEXT DEFAULT 'user',
                active INTEGER DEFAULT 1
            )"""
        )
        conn.commit()
    except Exception:
        pass
    try:
        info = c.execute("PRAGMA table_info(users)").fetchall()
        cols = [r[1] for r in info]
        notnull = {r[1]: int(r[3] or 0) for r in info}
        if 'pass_hash' not in cols:
            c.execute("ALTER TABLE users ADD COLUMN pass_hash TEXT")
        if 'password_hash' not in cols:
            c.execute("ALTER TABLE users ADD COLUMN password_hash TEXT")
        if 'role' not in cols:
            c.execute("ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'")
        if 'active' not in cols:
            c.execute("ALTER TABLE users ADD COLUMN active INTEGER DEFAULT 1")
        conn.commit()
    except Exception:
        pass
    try:
        info = c.execute("PRAGMA table_info(users)").fetchall()
        cols = [r[1] for r in info]
        notnull = {r[1]: int(r[3] or 0) for r in info}
        if ('password_hash' in cols and notnull.get('password_hash', 0) == 1) and ('pass_hash' not in cols):
            c.execute("CREATE TABLE IF NOT EXISTS users_new (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE NOT NULL, password_hash TEXT NOT NULL, role TEXT DEFAULT 'user', active INTEGER DEFAULT 1, pass_hash TEXT)")
            rows = c.execute("SELECT id, username, COALESCE(password_hash, pass_hash, '') as h, role, active FROM users").fetchall()
            for rid, un, h, role, active in rows:
                c.execute("INSERT OR IGNORE INTO users_new (id, username, password_hash, role, active, pass_hash) VALUES (?,?,?,?,?,?)", (rid, un, str(h or ''), role, active, str(h or '')))
            c.execute("DROP TABLE users")
            c.execute("ALTER TABLE users_new RENAME TO users")
            conn.commit()
    except Exception:
        pass
    try:
        c.execute("UPDATE users SET password_hash=pass_hash WHERE (password_hash IS NULL OR password_hash='') AND pass_hash IS NOT NULL")
        c.execute("UPDATE users SET pass_hash=password_hash WHERE (pass_hash IS NULL OR pass_hash='') AND password_hash IS NOT NULL")
        conn.commit()
    except Exception:
        pass
    # --- Multi-attachment support ---
    try:
        c.execute("""CREATE TABLE IF NOT EXISTS attachments (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        g_no TEXT NOT NULL,
                        path TEXT NOT NULL,
                        notes TEXT
                    )""")
        conn.commit()
    except Exception:
        pass

    # Ensure 'notes' column exists for attachments (runtime migration)
    try:
        cols = [r[1] for r in c.execute("PRAGMA table_info(attachments)").fetchall()]
        if "notes" not in cols:
            c.execute("ALTER TABLE attachments ADD COLUMN notes TEXT")
            conn.commit()
    except Exception:
        pass

    try:
        c.execute(
            """CREATE TABLE IF NOT EXISTS loans (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                loan_type TEXT,
                principal REAL,
                outstanding REAL,
                start_date TEXT,
                end_date TEXT,
                duration_days INTEGER,
                rate_percent REAL,
                cybor_percent REAL,
                total_percent REAL,
                period_interest REAL,
                total_due REAL,
                sector TEXT
            )"""
        )
        conn.commit()
    except Exception:
        pass

    # Runtime migration for new columns
    try:
        cols = [r[1] for r in c.execute("PRAGMA table_info(guarantees)").fetchall()]
        if "delivery_status" not in cols:
            c.execute("ALTER TABLE guarantees ADD COLUMN delivery_status TEXT")
            conn.commit()
        if "recipient_name" not in cols:
            c.execute("ALTER TABLE guarantees ADD COLUMN recipient_name TEXT")
            conn.commit()
        if "notes" not in cols:
            c.execute("ALTER TABLE guarantees ADD COLUMN notes TEXT")
            conn.commit()
        if "entry_number" not in cols:
            c.execute("ALTER TABLE guarantees ADD COLUMN entry_number TEXT")
            conn.commit()
    except Exception:
        pass

    # Runtime migration for 'attachment' column
    try:
        cols = [r[1] for r in c.execute("PRAGMA table_info(guarantees)").fetchall()]
        if "attachment" not in cols:
            c.execute("ALTER TABLE guarantees ADD COLUMN attachment TEXT")
            conn.commit()
        else:
            # migrate existing single attachments into new table
            try:
                rows = c.execute(
                    "SELECT g_no, attachment FROM guarantees WHERE TRIM(COALESCE(attachment, '')) <> ''").fetchall()
                for gno, ap in rows:
                    try:
                        c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (gno, ap))
                    except Exception:
                        pass
                conn.commit()
            except Exception:
                pass
    except Exception:
        pass
    # --- Bank Limits table ---
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        c.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='bank_limits'")
        table_exists = c.fetchone() is not None
        
        if table_exists:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            cols = [r[1] for r in c.execute("PRAGMA table_info(bank_limits)").fetchall()]
            if "bank_name" not in cols or "limit_amount" not in cols:
                # Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©
                c.execute("DROP TABLE IF EXISTS bank_limits")
                conn.commit()
                table_exists = False
        
        if not table_exists:
            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©
            c.execute("""CREATE TABLE bank_limits (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            bank_name TEXT UNIQUE NOT NULL,
                            limit_amount REAL DEFAULT 0.0
                        )""")
            conn.commit()
    except Exception:
        # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯
        try:
            c.execute("DROP TABLE IF EXISTS bank_limits")
            c.execute("""CREATE TABLE bank_limits (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            bank_name TEXT UNIQUE NOT NULL,
                            limit_amount REAL DEFAULT 0.0
                        )""")
            conn.commit()
        except Exception:
            pass
    conn.close()
    # Cleanup legacy 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' bank values to empty for consistent filtering
    try:
        conn = connect_db(); c = conn.cursor()
        c.execute("UPDATE guarantees SET bank='' WHERE TRIM(COALESCE(bank,'')) IN ('', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')")
        conn.commit(); conn.close()
    except Exception:
        pass

# --- Portable attachments helpers ---
def attachments_dir() -> str:
    """Return the base folder for attachments under the portable data directory."""
    data_dir = _get_data_dir()
    att_dir = data_dir / "attachments"
    try:
        att_dir.mkdir(parents=True, exist_ok=True)
    except Exception:
        pass
    return str(att_dir)

def _safe_dirname_from_gno(g_no: str) -> str:
    """Sanitize g_no to be used as a folder name."""
    g = normalize_gno(g_no or "")
    return g or "_unspecified"

def resolve_attachment_path(p: str) -> str:
    """Resolve a stored attachment path to an absolute path.
    Includes fallback search strategies for missing files (robust resolution).
    """
    try:
        p_str = str(p)
        if not p_str.strip():
            return ""
            
        pp = Path(p_str)
        
        # 1. Absolute path check
        if pp.is_absolute():
            if pp.exists():
                return str(pp)
            # If absolute path is invalid/moved, try to recover using just the filename
            pp = Path(pp.name)
            
        # 2. Check standard relative path (expected location)
        base = Path(attachments_dir())
        expected_path = base / pp
        if expected_path.exists():
            return str(expected_path)
            
        # 3. Fallback: Search strategies
        bn = pp.name
        
        # Strategy A: Check in legacy "Attachments" folder (flat)
        app_dir = _get_app_dir()
        legacy_base = app_dir / "Attachments"
        cand_legacy = legacy_base / bn
        if cand_legacy.exists():
            return str(cand_legacy)
            
        # Strategy B: Recursive search in attachments_dir 
        # (This handles cases where g_no folder name mismatch or file moved)
        for root, dirs, files in os.walk(str(base)):
            if bn in files:
                return str(Path(root) / bn)
                
        # Strategy C: Recursive search in legacy folder
        if legacy_base.exists():
             for root, dirs, files in os.walk(str(legacy_base)):
                if bn in files:
                    return str(Path(root) / bn)
                    
        # If all fails, return the expected path (so it shows as missing at that location)
        return str(expected_path)
    except Exception:
        return p

def _open_local_file_safe(p_raw: str, parent=None) -> bool:
    try:
        # Use the robust resolution logic
        ap = resolve_attachment_path(p_raw)
        path = Path(ap)
        
        if path.exists():
            try:
                if sys.platform.startswith('win'):
                    os.startfile(str(path))
                else:
                    try:
                        QtGui.QDesktopServices.openUrl(QtCore.QUrl.fromLocalFile(str(path)))
                    except Exception:
                        subprocess.Popen(['xdg-open', str(path)])
                return True
            except Exception as e:
                QtWidgets.QMessageBox.warning(parent or None, "Ø®Ø·Ø£", f"ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…Ù„Ù:\n{e}")
                return False
        else:
            QtWidgets.QMessageBox.warning(parent or None, "Ø®Ø·Ø£", f"Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:\n{ap}")
            return False
    except Exception:
        return False

def copy_attachment_for_gno(g_no: str, src_path: str) -> str:
    """Copy a file into attachments/<g_no>/ and return the relative path stored in DB.
    If a name conflict exists, append a numeric suffix.
    """
    try:
        import shutil
        src = Path(src_path)
        if not src.exists():
            return src_path
        dest_dir = Path(attachments_dir()) / _safe_dirname_from_gno(g_no)
        dest_dir.mkdir(parents=True, exist_ok=True)
        base = src.name
        dest = dest_dir / base
        if dest.exists():
            stem = dest.stem
            suf = dest.suffix
            i = 1
            while True:
                cand = dest_dir / f"{stem}_{i}{suf}"
                if not cand.exists():
                    dest = cand
                    break
                i += 1
        shutil.copy2(str(src), str(dest))
        # store relative path (from attachments_dir)
        rel = Path(".") / ""  # placeholder
        try:
            rel = dest.relative_to(Path(attachments_dir()))
        except Exception:
            rel = dest.name
        return str(rel).replace("\\", "/")
    except Exception:
        return src_path

def copy_attachments_for_gno(g_no: str, files: list) -> list:
    """Copy multiple files for a guarantee and return list of relative paths."""
    out = []
    for f in files or []:
        try:
            out.append(copy_attachment_for_gno(g_no, f))
        except Exception:
            out.append(f)
    return out


def export_database_to_excel(sqlite_path=None, output_path=None):
    """Export database to a single Excel file."""
    try:
        import openpyxl  # type: ignore
        from openpyxl.utils import get_column_letter  # type: ignore
        import sqlite3
    except ImportError:
        return False
    
    if sqlite_path is None:
        sqlite_path = db_path()
        
    try:
        conn = sqlite3.connect(sqlite_path)
        cur = conn.cursor()
        
        # Get all tables
        tables = [r[0] for r in cur.execute("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'")]
        
        # Sort tables: 'guarantees' first
        tables_sorted = []
        if 'guarantees' in tables:
            tables_sorted.append('guarantees')
            tables.remove('guarantees')
        
        # Add other tables sorted alphabetically
        tables_sorted.extend(sorted(tables))
        
        wb = openpyxl.Workbook()
        # Remove default sheet
        if 'Sheet' in wb.sheetnames:
            wb.remove(wb['Sheet'])
            
        for table in tables_sorted:
            ws = wb.create_sheet(title=table)
            # ws.print_area = 'A:R' - Removed to fix error

            
            # Get data
            if table == 'guarantees':
                rows = cur.execute(f"SELECT * FROM {table} ORDER BY bank ASC, issue_date DESC").fetchall()
            else:
                rows = cur.execute(f"SELECT * FROM {table}").fetchall()
            
            # Get headers
            if cur.description:
                orig_headers = [description[0] for description in cur.description]
                headers = list(orig_headers)
                if table == 'guarantees':
                    # Map to Arabic headers
                    arabic_map = {
                        'id': 'Ù…',
                        'department': 'Ø§Ù„Ù‚Ø³Ù…',
                        'bank': 'Ø§Ù„Ø¨Ù†Ùƒ',
                        'g_no': 'Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†',
                        'g_type': 'Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†',
                        'amount': 'Ø§Ù„Ù‚ÙŠÙ…Ø©',
                        'insurance_amount': 'Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†',
                        'percent': 'Ø§Ù„Ù†Ø³Ø¨Ø©',
                        'beneficiary': 'Ø§Ù„Ù…Ø³ØªÙÙŠØ¯',
                        'requester': 'Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¶Ù…Ø§Ù†',
                        'project_name': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
                        'issue_date': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±',
                        'end_date': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡',
                        'user_status': 'Ø§Ù„Ø­Ø§Ù„Ø©',
                        'cash_flag': 'Ù†Ù‚Ø¯ÙŠ',
                        'attachment': 'Ù…Ø±ÙÙ‚',
                        'delivery_status': 'Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                        'recipient_name': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…',
                        'notes': 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
                        'entry_number': 'Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯'
                    }
                    headers = [arabic_map.get(h, h) for h in headers]
                    
                    # Ù‚Øµ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØªÙˆÙ‚Ù Ø¹Ù†Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    try:
                        idx = headers.index("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡")
                        headers = headers[:idx+1]
                    except ValueError:
                        pass
                ws.append(headers)
            
            # Filter out expired guarantees from the 'guarantees' sheet
            if table == 'guarantees':
                try:
                    # Use original (English) column names to find indices
                    idx_end = orig_headers.index('end_date') if 'end_date' in orig_headers else None
                    idx_user = orig_headers.index('user_status') if 'user_status' in orig_headers else None
                    allowed_statuses = ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„")
                    filtered_rows = []
                    for row in rows:
                        us = ""
                        if idx_user is not None:
                            try:
                                us = (str(row[idx_user] or "").strip())
                            except Exception:
                                us = ""
                        end_val = None
                        if idx_end is not None:
                            try:
                                end_val = row[idx_end]
                            except Exception:
                                end_val = None
                        a_status = auto_status_for_row(end_val, "", None)
                        if us == "Ù…Ù†ØªÙ‡ÙŠ":
                            a_status = "Ù…Ù†ØªÙ‡ÙŠ"
                        elif us:
                            a_status = us
                        if a_status in allowed_statuses:
                            filtered_rows.append(row)
                    rows = filtered_rows
                except Exception:
                    # If anything goes wrong, fall back to unfiltered rows
                    pass
            
            for row in rows:
                if table == 'guarantees':
                    row = row[:len(headers)]
                ws.append(row)
                
            # Auto-adjust column width and apply number formats
            for column_cells in ws.columns:
                try:
                    col_idx = column_cells[0].column
                    col_header = ""
                    try:
                        col_header = headers[col_idx-1]
                    except:
                        pass
                    
                    length = 0
                    for cell in column_cells:
                        val = str(cell.value) if cell.value is not None else ""
                        length = max(length, len(val))
                        # Format Percentage
                        if table == 'guarantees' and "Ø§Ù„Ù†Ø³Ø¨Ø©" in col_header and cell.row > 1:
                            cell.number_format = '0"%"'
                    
                    ws.column_dimensions[get_column_letter(col_idx)].width = min(length + 2, 50) # Cap at 50
                except Exception:
                    pass
            
            if ws.max_row > 0:
                last_col_letter = get_column_letter(ws.max_column)
                ws.print_area = f'A1:{last_col_letter}{ws.max_row}'
                
        if output_path:
            wb.save(output_path)
            
        conn.close()
        return True
    except Exception as e:
        print(f"Error exporting to Excel: {e}")
        return False


def create_backup():
    """Create a backup of database and attachments in data/backup/ directory.
    
    Returns:
        Path to the backup directory, or None if backup failed
    """
    try:
        from datetime import datetime
        import shutil
        import zipfile
        import os
        
        data_dir = _get_data_dir()
        backup_dir = data_dir / "backup"
        backup_dir.mkdir(parents=True, exist_ok=True)
        
        # Create timestamp for backup folder name
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_folder = backup_dir / f"backup_{timestamp}"
        backup_folder.mkdir(parents=True, exist_ok=True)
        
        # Backup database
        db_path_file = Path(db_path())
        if db_path_file.exists():
            backup_db = backup_folder / DB_NAME
            shutil.copy2(str(db_path_file), str(backup_db))
        
        # Backup attachments
        attachments_path = Path(attachments_dir())
        if attachments_path.exists() and attachments_path.is_dir():
            backup_attachments = backup_folder / "attachments"
            if attachments_path.exists():
                shutil.copytree(str(attachments_path), str(backup_attachments), dirs_exist_ok=True)
        
        # Backup settings.ini if exists
        settings_ini = data_dir / "settings.ini"
        if settings_ini.exists():
            backup_settings = backup_folder / "settings.ini"
            shutil.copy2(str(settings_ini), str(backup_settings))

        # Generate Excel Export
        excel_path = data_dir / "Guarantees_Data.xlsx"
        try:
            export_database_to_excel(str(db_path_file), str(excel_path))
            # Also copy to backup folder
            if excel_path.exists():
                shutil.copy2(str(excel_path), str(backup_folder / "Guarantees_Data.xlsx"))
        except Exception as e:
            try:
                _log(f"Excel export failed: {e}")
            except:
                pass
        
        # Create a zip file of the backup for easier transfer
        zip_path = backup_dir / f"backup_{timestamp}.zip"
        with zipfile.ZipFile(str(zip_path), 'w', zipfile.ZIP_DEFLATED) as zipf:
            # Add database
            if db_path_file.exists():
                zipf.write(str(db_path_file), DB_NAME)
            # Add Excel backup
            if excel_path.exists():
                zipf.write(str(excel_path), "Guarantees_Data.xlsx")
            # Add attachments
            if attachments_path.exists():
                for root, dirs, files in os.walk(str(attachments_path)):
                    for file in files:
                        file_path = Path(root) / file
                        arcname = file_path.relative_to(attachments_path.parent)
                        zipf.write(str(file_path), str(arcname))
            # Add settings
            if settings_ini.exists():
                zipf.write(str(settings_ini), "settings.ini")
        
        # Keep only last 10 backups (delete older ones)
        try:
            backups = sorted(backup_dir.glob("backup_*"), key=lambda p: p.stat().st_mtime, reverse=True)
            for old_backup in backups[10:]:  # Keep only 10 most recent
                try:
                    if old_backup.is_dir():
                        shutil.rmtree(str(old_backup))
                    elif old_backup.is_file() and old_backup.suffix == '.zip':
                        old_backup.unlink()
                except Exception:
                    pass
        except Exception:
            pass
        
        return str(backup_folder)
    except Exception as e:
        try:
            _log(f"Backup failed: {e}")
        except:
            pass
        print(f"Backup failed: {e}")
        return None


def restore_backup(backup_path: str = None):
    """Restore database and attachments from a backup.
    
    Args:
        backup_path: Path to backup folder or zip file. If None, shows dialog to select.
    
    Returns:
        True if restore was successful, False otherwise
    """
    try:
        from datetime import datetime
        import shutil
        import zipfile
        from PyQt5 import QtWidgets  # type: ignore
        
        # If no path provided, show file dialog
        if backup_path is None:
            backup_path, _ = QtWidgets.QFileDialog.getOpenFileName(
                None, 
                "Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", 
                str(_get_data_dir() / "backup"),
                "Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (*.zip);;Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (*.*)"
            )
            if not backup_path:
                return False
        
        backup_path = Path(backup_path)
        if not backup_path.exists():
            return False
        
        data_dir = _get_data_dir()
        temp_extract = data_dir / ".temp_restore"
        
        try:
            # Extract if it's a zip file
            if backup_path.suffix == '.zip':
                temp_extract.mkdir(parents=True, exist_ok=True)
                with zipfile.ZipFile(str(backup_path), 'r') as zipf:
                    zipf.extractall(str(temp_extract))
                restore_source = temp_extract
            else:
                restore_source = backup_path
            
            # Restore database
            backup_db = restore_source / DB_NAME
            if backup_db.exists():
                current_db = Path(db_path())
                # Create backup of current database before restoring
                if current_db.exists():
                    current_backup = current_db.parent / f"{DB_NAME}.before_restore_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
                    shutil.copy2(str(current_db), str(current_backup))
                # Restore
                shutil.copy2(str(backup_db), str(current_db))
            
            # Restore attachments
            backup_attachments = restore_source / "attachments"
            if backup_attachments.exists() and backup_attachments.is_dir():
                current_attachments = Path(attachments_dir())
                # Backup current attachments
                if current_attachments.exists():
                    current_att_backup = current_attachments.parent / f"attachments.before_restore_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
                    if current_att_backup.exists():
                        shutil.rmtree(str(current_att_backup))
                    shutil.copytree(str(current_attachments), str(current_att_backup))
                # Restore
                if current_attachments.exists():
                    shutil.rmtree(str(current_attachments))
                shutil.copytree(str(backup_attachments), str(current_attachments))
            
            # Restore settings
            backup_settings = restore_source / "settings.ini"
            if backup_settings.exists():
                current_settings = data_dir / "settings.ini"
                if current_settings.exists():
                    settings_backup = data_dir / f"settings.ini.before_restore_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
                    shutil.copy2(str(current_settings), str(settings_backup))
                shutil.copy2(str(backup_settings), str(current_settings))
            
            # Cleanup temp extraction
            if temp_extract.exists():
                shutil.rmtree(str(temp_extract))
            
            return True
        except Exception:
            # Cleanup on error
            if temp_extract.exists():
                try:
                    shutil.rmtree(str(temp_extract))
                except Exception:
                    pass
            return False
    except Exception:
        return False


def migrate_old_db_if_any():
    """Migrate old database and attachments from various legacy locations to portable data directory.
    
    This function now runs on every startup to ensure data is always available when the program is moved.
    It merges data from old locations into the current portable data directory.
    """
    try:
        data_dir = _get_data_dir()
        new_db = data_dir / DB_NAME
        new_attachments = data_dir / "attachments"
        
        # Ensure data directory exists
        data_dir.mkdir(parents=True, exist_ok=True)
        new_attachments.mkdir(parents=True, exist_ok=True)
        
        import shutil
        import sqlite3
        
        # 1. Migrate DB from script directory (if exists and different from current)
        try:
            old_script_db = Path(__file__).parent / DB_NAME
            if old_script_db.exists() and old_script_db.resolve() != Path(new_db).resolve():
                if not new_db.exists():
                    # Copy database if new doesn't exist
                    shutil.copy2(str(old_script_db), str(new_db))
                else:
                    # Merge data from old database into new
                    try:
                        old_conn = sqlite3.connect(str(old_script_db))
                        new_conn = sqlite3.connect(str(new_db))
                        old_c = old_conn.cursor()
                        new_c = new_conn.cursor()
                        
                        # Get all guarantees from old DB
                        old_guarantees = old_c.execute("SELECT * FROM guarantees").fetchall()
                        old_cols = [desc[0] for desc in old_c.description]
                        
                        # Get columns that exist in new database
                        new_cols_info = new_c.execute("PRAGMA table_info(guarantees)").fetchall()
                        new_cols = [col[1] for col in new_cols_info]
                        
                        # Only use columns that exist in both databases
                        common_cols = [col for col in old_cols if col in new_cols]
                        
                        for row in old_guarantees:
                            row_dict = dict(zip(old_cols, row))
                            g_no = row_dict.get('g_no', '')
                            if g_no:
                                # Check if guarantee already exists
                                existing = new_c.execute("SELECT id FROM guarantees WHERE g_no=?", (g_no,)).fetchone()
                                if not existing:
                                    # Insert new guarantee with only common columns
                                    if common_cols:
                                        cols = ', '.join(common_cols)
                                        placeholders = ', '.join(['?' for _ in common_cols])
                                        values = tuple(row_dict.get(col, None) for col in common_cols)
                                        new_c.execute(f"INSERT INTO guarantees ({cols}) VALUES ({placeholders})", values)
                        
                        # Merge attachments
                        try:
                            old_att_rows = old_c.execute("SELECT * FROM attachments").fetchall()
                            old_att_cols = [desc[0] for desc in old_c.description] if old_att_rows else []
                            for att_row in old_att_rows:
                                att_dict = dict(zip(old_att_cols, att_row))
                                g_no = att_dict.get('g_no', '')
                                path = att_dict.get('path', '')
                                if g_no and path:
                                    # Check if attachment already exists
                                    existing = new_c.execute("SELECT id FROM attachments WHERE g_no=? AND path=?", (g_no, path)).fetchone()
                                    if not existing:
                                        notes = att_dict.get('notes', '')
                                        new_c.execute("INSERT INTO attachments (g_no, path, notes) VALUES (?,?,?)", (g_no, path, notes))
                        except Exception:
                            pass
                        
                        new_conn.commit()
                        old_conn.close()
                        new_conn.close()
                    except Exception:
                        pass
        except Exception:
            pass
        
        # 2. Migrate DB from Documents folder (if not already migrated by db_path())
        try:
            old_docs_db = Path.home() / "Documents" / "Guarantees" / DB_NAME
            if old_docs_db.exists() and old_docs_db.resolve() != Path(new_db).resolve():
                if not new_db.exists():
                    shutil.copy2(str(old_docs_db), str(new_db))
                else:
                    # Merge data (similar to above)
                    try:
                        old_conn = sqlite3.connect(str(old_docs_db))
                        new_conn = sqlite3.connect(str(new_db))
                        old_c = old_conn.cursor()
                        new_c = new_conn.cursor()
                        
                        old_guarantees = old_c.execute("SELECT * FROM guarantees").fetchall()
                        old_cols = [desc[0] for desc in old_c.description]
                        
                        # Get columns that exist in new database
                        new_cols_info = new_c.execute("PRAGMA table_info(guarantees)").fetchall()
                        new_cols = [col[1] for col in new_cols_info]
                        
                        # Only use columns that exist in both databases
                        common_cols = [col for col in old_cols if col in new_cols]
                        
                        for row in old_guarantees:
                            row_dict = dict(zip(old_cols, row))
                            g_no = row_dict.get('g_no', '')
                            if g_no:
                                existing = new_c.execute("SELECT id FROM guarantees WHERE g_no=?", (g_no,)).fetchone()
                                if not existing:
                                    if common_cols:
                                        cols = ', '.join(common_cols)
                                        placeholders = ', '.join(['?' for _ in common_cols])
                                        values = tuple(row_dict.get(col, None) for col in common_cols)
                                        new_c.execute(f"INSERT INTO guarantees ({cols}) VALUES ({placeholders})", values)
                        
                        try:
                            old_att_rows = old_c.execute("SELECT * FROM attachments").fetchall()
                            old_att_cols = [desc[0] for desc in old_c.description] if old_att_rows else []
                            for att_row in old_att_rows:
                                att_dict = dict(zip(old_att_cols, att_row))
                                g_no = att_dict.get('g_no', '')
                                path = att_dict.get('path', '')
                                if g_no and path:
                                    existing = new_c.execute("SELECT id FROM attachments WHERE g_no=? AND path=?", (g_no, path)).fetchone()
                                    if not existing:
                                        notes = att_dict.get('notes', '')
                                        new_c.execute("INSERT INTO attachments (g_no, path, notes) VALUES (?,?,?)", (g_no, path, notes))
                        except Exception:
                            pass
                        
                        new_conn.commit()
                        old_conn.close()
                        new_conn.close()
                    except Exception:
                        pass
        except Exception:
            pass
        
        # 3. Migrate attachments from old Documents location
        try:
            old_docs_att = Path.home() / "Documents" / "Guarantees" / "attachments"
            if old_docs_att.exists() and old_docs_att.is_dir():
                # Copy all files and subdirectories
                for item in old_docs_att.rglob('*'):
                    if item.is_file():
                        try:
                            rel_path = item.relative_to(old_docs_att)
                            dest_file = new_attachments / rel_path
                            if not dest_file.exists():
                                dest_file.parent.mkdir(parents=True, exist_ok=True)
                                shutil.copy2(str(item), str(dest_file))
                        except Exception:
                            pass
        except Exception:
            pass
        
        # 4. Migrate attachments from old Attachments folder in app root
        old_root_attachments = _get_app_dir() / "Attachments"
        if old_root_attachments.exists() and old_root_attachments.is_dir():
            try:
                # Copy all files from old Attachments folder
                for item in old_root_attachments.rglob('*'):
                    if item.is_file():
                        try:
                            rel_path = item.relative_to(old_root_attachments)
                            dest_file = new_attachments / rel_path
                            if not dest_file.exists():
                                dest_file.parent.mkdir(parents=True, exist_ok=True)
                                shutil.copy2(str(item), str(dest_file))
                        except Exception:
                            pass
            except Exception:
                pass
        
        # 5. Also check for database in old script directory (when program is moved)
        try:
            # Check if there's a database in the directory where the script/exe is located
            app_dir = _get_app_dir()
            app_dir_db = app_dir / DB_NAME
            if app_dir_db.exists() and app_dir_db.resolve() != Path(new_db).resolve():
                if not new_db.exists():
                    shutil.copy2(str(app_dir_db), str(new_db))
                else:
                    # Merge data
                    try:
                        old_conn = sqlite3.connect(str(app_dir_db))
                        new_conn = sqlite3.connect(str(new_db))
                        old_c = old_conn.cursor()
                        new_c = new_conn.cursor()
                        
                        old_guarantees = old_c.execute("SELECT * FROM guarantees").fetchall()
                        old_cols = [desc[0] for desc in old_c.description]
                        
                        # Get columns that exist in new database
                        new_cols_info = new_c.execute("PRAGMA table_info(guarantees)").fetchall()
                        new_cols = [col[1] for col in new_cols_info]
                        
                        # Only use columns that exist in both databases
                        common_cols = [col for col in old_cols if col in new_cols]
                        
                        for row in old_guarantees:
                            row_dict = dict(zip(old_cols, row))
                            g_no = row_dict.get('g_no', '')
                            if g_no:
                                existing = new_c.execute("SELECT id FROM guarantees WHERE g_no=?", (g_no,)).fetchone()
                                if not existing:
                                    if common_cols:
                                        cols = ', '.join(common_cols)
                                        placeholders = ', '.join(['?' for _ in common_cols])
                                        values = tuple(row_dict.get(col, None) for col in common_cols)
                                        new_c.execute(f"INSERT INTO guarantees ({cols}) VALUES ({placeholders})", values)
                        
                        try:
                            old_att_rows = old_c.execute("SELECT * FROM attachments").fetchall()
                            old_att_cols = [desc[0] for desc in old_c.description] if old_att_rows else []
                            for att_row in old_att_rows:
                                att_dict = dict(zip(old_att_cols, att_row))
                                g_no = att_dict.get('g_no', '')
                                path = att_dict.get('path', '')
                                if g_no and path:
                                    existing = new_c.execute("SELECT id FROM attachments WHERE g_no=? AND path=?", (g_no, path)).fetchone()
                                    if not existing:
                                        notes = att_dict.get('notes', '')
                                        new_c.execute("INSERT INTO attachments (g_no, path, notes) VALUES (?,?,?)", (g_no, path, notes))
                        except Exception:
                            pass
                        
                        new_conn.commit()
                        old_conn.close()
                        new_conn.close()
                    except Exception:
                        pass
        except Exception:
            pass
        
    except Exception:
        pass


def parse_date(s: str):
    from datetime import date as _date, datetime as _dt, timedelta as _td
    from dateutil.parser import parse as _parse_date  # type: ignore
    if s is None or s == "":
        return None
    if isinstance(s, _dt):
        return s.date()
    if isinstance(s, _date):
        return s
    try:
        if isinstance(s, (int, float)) or (isinstance(s, str) and re.fullmatch(r"\s*[0-9]+(\.[0-9]+)?\s*", s)):
            val = float(s);
            base = _date(1899, 12, 30)
            return base + _td(days=int(val))
    except Exception:
        pass
    s = str(s).strip()
    try:
        s = s.translate(ARABIC_DIGITS)
    except Exception:
        pass
    try:
        return _parse_date(s).date()
    except Exception:
        pass
    _months = {"jan": 1, "january": 1, "feb": 2, "february": 2, "mar": 3, "march": 3, "apr": 4, "april": 4, "may": 5,
               "jun": 6, "june": 6, "jul": 7, "july": 7, "aug": 8, "august": 8, "sep": 9, "sept": 9, "september": 9,
               "oct": 10, "october": 10, "nov": 11, "november": 11, "dec": 12, "december": 12}
    m = re.fullmatch(r"\s*(\d{1,2})[-/ ]([A-Za-z]{3,9})[-/ ](\d{4})\s*", s)
    if m:
        d, mon, y = m.groups();
        mon_n = _months.get(mon.lower())
        if mon_n:
            try:
                return _dt(int(y), mon_n, int(d)).date()
            except Exception:
                pass
    # Pattern: DDMon-YYYY (Ø¨Ø¯ÙˆÙ† ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø´Ù‡Ø±)
    m2 = re.fullmatch(r"\s*(\d{1,2})([A-Za-z]{3,9})-(\d{4})\s*", s)
    if m2:
        d, mon, y = m2.groups()
        mon_n = _months.get(mon.lower())
        if mon_n:
            try:
                return _dt(int(y), mon_n, int(d)).date()
            except Exception:
                pass
    for f in ("%Y-%m-%d", "%Y/%m/%d", "%d/%m/%Y", "%d-%m-%Y", "%m/%d/%Y", "%m-%d-%Y",
              "%Y-%m-%d %H:%M:%S", "%Y/%m/%d %H:%M:%S", "%d/%m/%Y %H:%M", "%d-%m-%Y %H:%M"):
        try:
            return _dt.strptime(s, f).date()
        except Exception:
            continue
    try:
        return _dt.fromisoformat(s.split(" ")[0]).date()
    except Exception:
        pass
    try:
        val = float(s.replace(",", ""));
        base = _date(1899, 12, 30)
        return base + _td(days=int(val))
    except Exception:
        return None


def bank_grace_days(bank: str) -> int:
    bank = (bank or "").strip()
    if bank == "Ø§Ù„Ø£Ù‡Ù„ÙŠ":
        return 30
    if bank in ("Ø³Ø§Ø¨", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ", "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"):
        return 60
    return 60


def detect_bank_from_gno(g_no: str) -> str:
    n = normalize_gno(g_no)
    raw = (g_no or "").strip().upper().translate(ARABIC_DIGITS)

    # Special case mapping: certain guarantee numbers are tied to specific sub-banks
    if n == "B299015":
        return "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"

    # SABB: presence of any known markers anywhere in the number
    try:
        markers = SAB_MARKERS
    except NameError:
        markers = ["ATNHTS", "APNHTS", "APNGCU", "ATNGCU", "AFGGCU", "GST", "AFGWPM", "APNWPM", "ATNCBG", "APNCBG", "GIC"]
    if any(m and (m in n) for m in markers):
        return "Ø³Ø§Ø¨"

    # Al Rajhi: any number containing OGTE
    if "OGTE" in n:
        return "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ"

    # Riyad Bank: contains JLG or RLG
    if ("JLG" in n) or ("RLG" in n):
        return "Ø§Ù„Ø±ÙŠØ§Ø¶"

    # Alinma: contains MD
    if "MD" in n:
        return "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"

    # Al Ahli (NCB): contains 'B' or 'M' (excluding the special B299015 handled above)
    try:
        if ("B" in raw) or ("M" in raw):
            return "Ø§Ù„Ø£Ù‡Ù„ÙŠ"
    except Exception:
        pass

    return ""


def normalize_bank(b: str, g_no: str) -> str:
    b = (b or "").strip()

    # Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ù…Ø¹ÙŠÙ†
    if normalize_gno(g_no) == "B299015":
        return "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"

    # Ø£ÙˆÙ„Ø§Ù‹: ÙØ¶Ù‘Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ (ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø§Ø³Ù…)
    if "Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶" in b or "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶" in b or "Ø§Ù„Ø§Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶" in b:
        return "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"
    if any(x in b for x in ("Ø§Ù„Ø§Ù‡Ù„ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„Ø§Ù‡Ù„ÙŠ ")):
        return "Ø§Ù„Ø£Ù‡Ù„ÙŠ"
    if "Ø³Ø§Ø¨" in b:
        return "Ø³Ø§Ø¨"
    if "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ" in b:
        return "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ"
    if "Ø§Ù„Ø±ÙŠØ§Ø¶" in b:
        return "Ø§Ù„Ø±ÙŠØ§Ø¶"
    if "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡" in b or "Ø§Ù„Ø§Ù†Ù…Ø§Ø¡" in b:
        return "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"

    # Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© ÙŠØ¯ÙˆÙŠØ© ÙˆØ§Ø¶Ø­Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
    auto = detect_bank_from_gno(g_no)
    if auto:
        return auto

    # Ø¥Ù„ØºØ§Ø¡ "ØºÙŠØ± Ù…Ø­Ø¯Ø¯": Ø¥Ù† Ù„Ù… ÙŠÙØ³ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø¨Ù†ÙƒØŒ Ù†ÙØ¹ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ø£Ùˆ ÙØ±Ø§Øº
    return b or ""


def auto_status_for_row(end_date: str, bank: str, today: date = None) -> str:
    d_end = parse_date(end_date)
    if not d_end:
        return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
    if today is None:
        today = date.today()
    
    # Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
    # Ø§Ù„ØªØ§Ø±ÙŠØ® > ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ = Ø§Ù†ØªÙ‡ÙŠ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ§ÙƒÙŠØ¯
    if today > d_end:
        return "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯"
    
    # Ø§Ù„ØªØ§Ø±ÙŠØ® â‰¤ 30 ÙŠÙˆÙ… Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ = Ù‚Ø§Ø±Ø¨ Ø¹Ù„ÙŠ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    days_until_expiry = (d_end - today).days
    if days_until_expiry <= 30:
        return "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"
    
    # Ø§Ù„ØªØ§Ø±ÙŠØ® < Ø£ÙƒØ«Ø± Ù…Ù† 30 ÙŠÙˆÙ… Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ = Ø³Ø§Ø±ÙŠ
    return "Ø³Ø§Ø±ÙŠ"


HEADER_ALIASES = {
    "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†": ["Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "g_no", "no", "RNO", "Ø±Ù‚Ù…"],
    "Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†": ["Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†", "type", "g_type"],
    "Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†": ["Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†", "amount", "Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†"],
    "Ù… Ø§Ù„ØªØ§Ù…ÙŠÙ†": ["Ù… Ø§Ù„ØªØ§Ù…ÙŠÙ†", "Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†", "insurance_amount", "ØªØ£Ù…ÙŠÙ†", "Ù…Ø¨Ù„Øº Ø§Ù„ØªØ§Ù…ÙŠÙ†"],
    "%": ["%", "Ùª", "Ù†Ø³Ø¨Ø©", "percent", "Ø§Ù„Ù†Ø³Ø¨Ø©", "Ø§Ù„Ù†Ø³Ø¨Ù‡", "Ø§Ù„Ù†Ø³Ø¨Ø©%", "Ø§Ù„Ù†Ø³Ø¨Ù‡%", "Ø§Ù„Ù†Ø³Ø¨Ø© %", "Ø§Ù„Ù†Ø³Ø¨Ù‡ %"],
    "Ø§Ù„Ø¨Ù†Ùƒ": ["Ø§Ù„Ø¨Ù†Ùƒ", "bank", "Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…ØµØ¯Ø±"],
    "Ø§Ù„Ù‚Ø³Ù…": ["Ø§Ù„Ù‚Ø³Ù…", "department", "dept"],
    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØµØ¯Ø§Ø±": ["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØµØ¯Ø§Ø±", "issue_date", "Øª.Ø§Ù„Ø§ØµØ¯Ø§Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±"],
    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": ["end", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "expiry", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†ØªÙ‡Ø§Ø¡"],
    "Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©": ["Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©", "Ø§Ù„Ø¬Ù‡Ø©", "Ø§Ù„Ù…Ø³ØªÙÙŠØ¯", "Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©", "beneficiary"],
    "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©": ["Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©", "requester", "Ø´ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ù„Ù„Ø¶Ù…Ø§Ù†", "Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù„Ù„Ù…Ø¶Ù…ÙˆÙ†",
                       "ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù„Ù„Ù…Ø¶Ù…ÙˆÙ†"],
    "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹": ["Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", "project_name", "Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"],
    "Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©)": ["Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©)", "Ø­Ø§Ù„Ø©", "user_status", "Ø­ Ø§Ù„Ø¶Ù…Ø§Ù†"],
    "Ø§Ù„ØªØ³Ù„ÙŠÙ…": ["Ø§Ù„ØªØ³Ù„ÙŠÙ…", "delivery_status"],
    "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…": ["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", "recipient_name"],
    "Ù…Ù„Ø§Ø­Ø¸Ø§Øª": ["Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "notes"],
    "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯": ["Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯", "entry_number"],
}


def _norm(s):
    return ("" if s is None else str(s).strip())


def import_xlsx_to_db(xlsx_path: str, parent=None):
    from openpyxl import load_workbook  # type: ignore
    wb = load_workbook(xlsx_path, data_only=True)
    ws = wb.active

    # read first row as headers and normalize
    raw_headers = [(_norm(c.value)) for c in next(ws.iter_rows(min_row=1, max_row=1))]
    headers = [normalize_text_ar(h) for h in raw_headers]

    # build aliases map from HEADER_ALIASES (normalize keys & values)
    _ALIASES = {}
    try:
        alias_items = HEADER_ALIASES.items()
    except NameError:
        alias_items = []
    for key, aliases in alias_items:
        nk = normalize_text_ar(key)
        _ALIASES[nk] = [normalize_text_ar(a) for a in aliases]

    idx = {}
    for key, aliases in _ALIASES.items():
        for i, h in enumerate(headers):
            if h in aliases:
                idx[key] = i
                break

    def col(name):
        return idx.get(normalize_text_ar(name), None)

    # required columns
    if any(v is None for v in [col("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†"), col("Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†")]):
        try:
            QtWidgets.QMessageBox.warning(parent, "Ø§Ø³ØªÙŠØ±Ø§Ø¯", "ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.")
        except Exception:
            pass
        return

    conn = connect_db();
    c = conn.cursor()
    inserted = 0

    def _to_float(x):
        s = str(_norm(x)).translate(ARABIC_DIGITS).replace(",", "")
        try:
            return float(s or 0)
        except Exception:
            return 0.0

    # Helper to safely read a cell value and handle merged cells
    def _cell_value(row, idx, row_index):
        if idx is None:
            return ""
        try:
            cell = row[idx]
            val = cell.value
            if val is None:
                # If within a merged range, fallback to the top-left cell's value
                try:
                    for mr in ws.merged_cells.ranges:
                        if cell.coordinate in mr:
                            tl = ws.cell(mr.min_row, mr.min_col)
                            val = tl.value
                            break
                except Exception:
                    pass
            return val
        except Exception:
            return ""

    for _row_idx, row in enumerate(ws.iter_rows(min_row=2), start=2):
        idx_gno = col("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†")
        g_no_cell = _cell_value(row, idx_gno, _row_idx) if idx_gno is not None else ""
        g_no = normalize_gno(_norm(g_no_cell))
        if not g_no:
            continue

        idx_gtype = col("Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†")
        g_type = _norm(_cell_value(row, idx_gtype, _row_idx)) if idx_gtype is not None else ""

        idx_amt = col("Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†")
        amount = _to_float(_cell_value(row, idx_amt, _row_idx)) if idx_amt is not None else 0.0

        idx_ins = col("Ù… Ø§Ù„ØªØ§Ù…ÙŠÙ†")
        ins = _to_float(_cell_value(row, idx_ins, _row_idx)) if idx_ins is not None else 0.0

        idx_pct = col("%")
        pct = parse_percent(_cell_value(row, idx_pct, _row_idx)) if idx_pct is not None else 0.0

        idx_bank = col("Ø§Ù„Ø¨Ù†Ùƒ")
        bank_raw = _norm(_cell_value(row, idx_bank, _row_idx)) if idx_bank is not None else ""

        idx_dept = col("Ø§Ù„Ù‚Ø³Ù…")
        dept = _norm(_cell_value(row, idx_dept, _row_idx)) if idx_dept is not None else ""

        idx_issue = col("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØµØ¯Ø§Ø±")
        idx_endd = col("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡")
        issue_raw = _norm(_cell_value(row, idx_issue, _row_idx)) if idx_issue is not None else ""
        endd_raw = _norm(_cell_value(row, idx_endd, _row_idx)) if idx_endd is not None else ""

        issue_dt = parse_date(issue_raw)
        end_dt = parse_date(endd_raw)
        issue = issue_dt.strftime('%Y-%m-%d') if issue_dt else issue_raw
        endd = end_dt.strftime('%Y-%m-%d') if end_dt else endd_raw

        idx_benef = col("Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©")
        benef = _norm(_cell_value(row, idx_benef, _row_idx)) if idx_benef is not None else ""

        idx_req = col("Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©")
        req = _norm(_cell_value(row, idx_req, _row_idx)) if idx_req is not None else ""

        idx_proj = col("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")
        proj = _norm(_cell_value(row, idx_proj, _row_idx)) if idx_proj is not None else ""

        idx_user_status = col("Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©)")
        user_status = _norm(_cell_value(row, idx_user_status, _row_idx)) if idx_user_status is not None else ""

        idx_delivery_status = col("Ø§Ù„ØªØ³Ù„ÙŠÙ…")
        delivery_status = _norm(_cell_value(row, idx_delivery_status, _row_idx)) if idx_delivery_status is not None else ""

        idx_recipient_name = col("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…")
        recipient_name = _norm(_cell_value(row, idx_recipient_name, _row_idx)) if idx_recipient_name is not None else ""

        idx_notes = col("Ù…Ù„Ø§Ø­Ø¸Ø§Øª")
        notes = _norm(_cell_value(row, idx_notes, _row_idx)) if idx_notes is not None else ""

        idx_entry_number = col("Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯")
        entry_number = _norm(_cell_value(row, idx_entry_number, _row_idx)) if idx_entry_number is not None else ""

        # determine bank; auto detection dominates
        bank = normalize_bank(bank_raw, g_no)

        cash = 1 if ("Ù†Ù‚Ø¯" in g_type or "CASH" in str(g_type).upper()) else 0

        existing = c.execute("SELECT id FROM guarantees WHERE g_no=?", (g_no,)).fetchone()
        if existing:
            rid = existing[0]
            c.execute("""UPDATE guarantees SET department=?, bank=?, g_type=?, amount=?, insurance_amount=?, percent=?,
                         beneficiary=?, requester=?, project_name=?, issue_date=?, end_date=?, user_status=?, cash_flag=?,
                         delivery_status=?, recipient_name=?, notes=?, entry_number=?
                         WHERE id=?""",
                      (dept, bank, g_type, amount, ins, pct, benef, req, proj, issue, endd, user_status, cash,
                       delivery_status, recipient_name, notes, entry_number, rid))
        else:
            c.execute("""INSERT INTO guarantees (department, bank, g_no, g_type, amount, insurance_amount, percent,
                         beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag,
                         delivery_status, recipient_name, notes, entry_number)
                         VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)""",
                      (dept, bank, g_no, g_type, amount, ins, pct, benef, req, proj, issue, endd, user_status, cash,
                       delivery_status, recipient_name, notes, entry_number))
        inserted += 1

    conn.commit();
    # --- Multi-attachment support ---
    try:
        c.execute("""CREATE TABLE IF NOT EXISTS attachments (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        g_no TEXT NOT NULL,
                        path TEXT NOT NULL,
                        notes TEXT
                    )""")
        conn.commit()
    except Exception:
        pass

    # Ensure 'notes' column exists for attachments (runtime migration)
    try:
        cols = [r[1] for r in c.execute("PRAGMA table_info(attachments)").fetchall()]
        if "notes" not in cols:
            c.execute("ALTER TABLE attachments ADD COLUMN notes TEXT")
            conn.commit()
    except Exception:
        pass

    # Runtime migration for 'attachment' column
    try:
        cols = [r[1] for r in c.execute("PRAGMA table_info(guarantees)").fetchall()]
        if "attachment" not in cols:
            c.execute("ALTER TABLE guarantees ADD COLUMN attachment TEXT")
            conn.commit()
        else:
            # migrate existing single attachments into new table
            try:
                rows = c.execute(
                    "SELECT g_no, attachment FROM guarantees WHERE TRIM(COALESCE(attachment, '')) <> ''").fetchall()
                for gno, ap in rows:
                    try:
                        c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (gno, ap))
                    except Exception:
                        pass
                conn.commit()
            except Exception:
                pass
    except Exception:
        pass
    conn.close()
    try:
        _status(parent, f"ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØ­Ø¯ÙŠØ« {inserted} Ø³Ø¬Ù„Ù‹Ø§.", 2000)
    except Exception:
        pass


def show_date_settings(self):
    cur = load_date_format_key()
    dlg = DateSettingsDialog(self, current_key=cur)
    if dlg.exec_() == QtWidgets.QDialog.Accepted:
        key = dlg.chosen_key()
        save_date_format_key(key)
    self.refresh()
    # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
    if not getattr(self, "_splash_shown_once", False):
        try:
            _logo = _read_brand_logo_path()
        except Exception:
            _logo = ""
        try:
            self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
            self._embedded_splash.show()
            self._embedded_splash.raise_()
        except Exception:
            self._embedded_splash = None
        self._splash_shown_once = True


# --- Helpers: Arabic/number/text normalization (added) ---
ARABIC_DIGITS = str.maketrans("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©", "0123456789")


def normalize_text_ar(s: str) -> str:
    """Normalize Arabic headers: remove tatweel, unify alif/hamza, trim extra spaces."""
    s = ("" if s is None else str(s)).strip()
    s = s.replace("Ù€", "")  # tatweel
    s = (s.replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
         .replace("Ù‰", "ÙŠ").replace("Ø©", "Ù‡"))
    s = " ".join(s.split())
    return s


def normalize_gno(g_no: str) -> str:
    """Clean guarantee number: Arabic digits->Latin, remove spaces/dashes/slashes."""
    n = (g_no or "").strip().upper()
    n = n.translate(ARABIC_DIGITS)
    n = n.replace(" ", "").replace("-", "").replace("/", "")
    return n

def extract_digits_only(s: str) -> str:
    """Extract only digits from a string (Arabic and Latin digits)."""
    if not s:
        return ""
    s = str(s).translate(ARABIC_DIGITS)
    return ''.join(c for c in s if c.isdigit())

def _try_convert_to_number(val, is_percent=False):
    """Try to convert string to number, handling currency formatting and percentages."""
    if not val:
        return False, 0.0
    try:
        s = str(val).strip()
        if not s:
            return False, 0.0
        # Translate Arabic digits
        s = s.translate(ARABIC_DIGITS)
        
        s = s.replace(",", "").replace("%", "")
        if s.startswith("(") and s.endswith(")"):
            s = "-" + s[1:-1]
        
        f = float(s)
        if is_percent:
            f = f / 100.0
        return True, f
    except ValueError:
        return False, 0.0

def _dedup_rows_by_gno(rows, gno_index: int = 2):
    """Remove duplicate rows by normalized guarantee number, keeping the first occurrence.

    Works for tuples/lists returned from DB. The first occurrence is assumed to be the
    latest due to ORDER BY id DESC in queries.
    """
    seen = set()
    out = []
    for r in rows:
        try:
            key = normalize_gno(str((r[gno_index] if len(r) > gno_index else "") or ""))
        except Exception:
            key = ""
        if key and key in seen:
            continue
        if key:
            seen.add(key)
        out.append(r)
    return out


def parse_percent(val):
    """
    Parse any percentage-like value and ALWAYS return a number in [0, 100] (percent units).
    Rules:
      - If the text contains % (or Arabic Ùª): strip it, parse the number.
      - If it's a plain number:
          * If 0 < x <= 1 â†’ treat as a fraction and multiply by 100 (0.05 â†’ 5.0)
          * Otherwise â†’ already percent (5 â†’ 5.0, 80 â†’ 80.0)
      - Supports Arabic digits and Arabic decimal separators (Ù«Ù¬) and comma decimals.
      - Invalid/empty â†’ 0.0
      - Final result is clamped to [0, 100].
    """
    import re
    # Map Arabic digits and separators to Latin/ASCII
    TRANS = str.maketrans("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©Ù«Ù¬", "0123456789..")

    def _finalize(x):
        try:
            x = float(x)
        except Exception:
            return 0.0
        if x < 0:
            return 0.0
        if x > 100:
            return 100.0
        return x

    if val is None:
        return 0.0

    # Numeric fast path
    if isinstance(val, (int, float)):
        try:
            x = float(val)
            if 0 < x <= 1:
                x *= 100.0
            return _finalize(x)
        except Exception:
            return 0.0

    # Normalize string
    s = str(val).strip()
    s = s.translate(TRANS)
    s = s.replace("Ùª", "%")
    # unify spaces around %
    s = re.sub(r'\s*%\s*', '%', s)
    # remove thousands separators between digits (e.g., 1,234.5 or 1 234,5)
    s = re.sub(r'(?<=\d)[\s,](?=\d{3}(\D|$))', '', s)

    if '%' in s:
        s_num = s.replace('%', '')
        s_num = s_num.replace(' ', '').replace(',', '.')
        try:
            return _finalize(float(s_num))
        except Exception:
            # fallback to first number in the string
            m = re.search(r'[-+]?\d+(?:[\.,]\d+)?', s_num)
            return _finalize(m.group(0).replace(',', '.')) if m else 0.0

    # Plain number case
    s_num = s.replace(' ', '').replace(',', '.')
    try:
        x = float(s_num)
        if 0 < x <= 1:
            x *= 100.0
        return _finalize(x)
    except Exception:
        # fallback: extract a number from noisy strings
        m = re.search(r'[-+]?\d+(?:[\.,]\d+)?', s_num)
        if m:
            x = float(m.group(0).replace(',', '.'))
            if 0 < x <= 1:
                x *= 100.0
            return _finalize(x)
        return 0.0


def format_date_for_view(s):
    d = parse_date(s)
    if not d:
        return ""
    try:
        import calendar as _cal
        key = load_date_format_key()
        if key == "D-MMM-YYYY":
            mon = _cal.month_abbr[d.month]
            return f"{d.day}-{mon}-{d.year}"
        elif key == "DD/MM/YYYY":
            return d.strftime("%d/%m/%Y")
        elif key == "MM/DD/YYYY":
            return d.strftime("%m/%d/%Y")
        else:  # default and 'YYYY-MM-DD'
            return d.strftime("%Y-%m-%d")
    except Exception:
        return d.strftime("%Y-%m-%d")


class WrapTextDelegate(QtWidgets.QStyledItemDelegate):
    """
    Delegate that enables word-wrapping for long text cells and reports an appropriate sizeHint.
    Works with QTableWidget/QTableView. Prevents eliding so full text is visible when row height allows.
    """

    def paint(self, painter, option, index):
        opt = QtWidgets.QStyleOptionViewItem(option)
        self.initStyleOption(opt, index)
        # Enable wrapping and avoid eliding
        opt.textElideMode = QtCore.Qt.ElideNone
        opt.features |= QtWidgets.QStyleOptionViewItem.WrapText
        # Let base class handle painting with updated options
        super().paint(painter, opt, index)

    def sizeHint(self, option, index):
        # Compute a wrapped text height based on column width
        text = str(index.data() or "")
        if not text:
            return super().sizeHint(option, index)

        # figure out available width for text
        view = self.parent()
        try:
            col_w = view.columnWidth(index.column())
        except Exception:
            col_w = option.rect.width() if option.rect.width() > 0 else 200

        # padding to account for cell margins
        avail_w = max(10, col_w - 12)
        fm = option.fontMetrics if hasattr(option, "fontMetrics") else QtGui.QFontMetrics(view.font())
        # Use boundingRect with word wrap
        rect = fm.boundingRect(0, 0, avail_w, 10_000, QtCore.Qt.TextWordWrap, text)
        h = max(rect.height() + 12, 28)  # add padding and minimum row height
        # Width can be column width; height as computed
        return QtCore.QSize(col_w, h)


class MultiLineEditDelegate(WrapTextDelegate):
    """
    Delegate that provides a QTextEdit editor to allow multi-line input.
    - Enter inserts a new line (like Excel wrap).
    - Ctrl+Enter Ø£Ùˆ Shift+Enter ØªÙ†Ù‡ÙŠ Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØªØ«Ø¨Øª Ø§Ù„Ù‚ÙŠÙ…Ø©.
    Automatically resizes the row to fit the new content.
    """

    def createEditor(self, parent, _option, _index):
        ed = QtWidgets.QTextEdit(parent)
        try:
            ed.setAcceptRichText(False)
        except Exception:
            pass
        try:
            ed.setWordWrapMode(QtGui.QTextOption.WordWrap)
        except Exception:
            pass
        ed.installEventFilter(self)
        # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø§Ù„ØªØ§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­Ø±Ø±
        try:
            ed.setTabChangesFocus(True)
        except Exception:
            pass
        return ed

    def setEditorData(self, editor, index):
        try:
            editor.setPlainText(str(index.data() or ""))
        except Exception:
            pass

    def setModelData(self, editor, model, index):
        try:
            text = editor.toPlainText()
        except Exception:
            text = str(editor.toPlainText()) if hasattr(editor, 'toPlainText') else ""
        try:
            model.setData(index, text, QtCore.Qt.EditRole)
        except Exception:
            pass
        # Ø§Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        try:
            view = self.parent()
            if isinstance(view, (QtWidgets.QTableWidget, QtWidgets.QTableView)):
                view.resizeRowToContents(index.row())
        except Exception:
            pass

    def updateEditorGeometry(self, editor, option, index):
        try:
            editor.setGeometry(option.rect)
        except Exception:
            pass

    def eventFilter(self, obj, event):
        try:
            if isinstance(obj, QtWidgets.QTextEdit) and event.type() == QtCore.QEvent.KeyPress:
                key = event.key()
                mods = QtWidgets.QApplication.keyboardModifiers()
                # Ctrl+Enter Ø£Ùˆ Shift+Enter: Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±
                if key in (QtCore.Qt.Key_Return, QtCore.Qt.Key_Enter) and (mods & QtCore.Qt.ControlModifier or mods & QtCore.Qt.ShiftModifier):
                    self.commitData.emit(obj)
                    self.closeEditor.emit(obj, QtWidgets.QAbstractItemDelegate.NoHint)
                    return True
                # Escape: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±
                if key == QtCore.Qt.Key_Escape:
                    self.closeEditor.emit(obj, QtWidgets.QAbstractItemDelegate.RevertModelCache)
                    return True
        except Exception:
            pass
        return super().eventFilter(obj, event)



def _selected_rows_or_current(self):
    """Return a sorted list of selected row indices; fallback to current row if none."""
    rows = set()
    try:
        tbl = getattr(self, "table", None)
        tbl_cash = getattr(self, "table_cash", None)
        use_tbl = tbl
        try:
            if tbl_cash and (tbl_cash.hasFocus() or (tbl_cash.selectionModel() and (tbl_cash.selectionModel().selectedRows() or tbl_cash.selectionModel().selectedIndexes()))):
                use_tbl = tbl_cash
        except Exception:
            pass
        sm = use_tbl.selectionModel() if use_tbl is not None else None
        if sm is not None:
            # Works for both SingleSelection and ExtendedSelection
            try:
                rows = set(i.row() for i in sm.selectedRows())
            except Exception:
                rows = set()
            if not rows:
                try:
                    rows = set(i.row() for i in use_tbl.selectedIndexes())
                except Exception:
                    rows = set()
    except Exception:
        rows = set()
    if not rows:
        try:
            r = use_tbl.currentRow() if use_tbl is not None else None
            if r is not None and int(r) >= 0:
                rows = {int(r)}
        except Exception:
            pass
    return sorted(rows)


def _selected_gnos(self):
    """Return a list of selected guarantee numbers (g_no) based on table selection (robust)."""
    rows = _selected_rows_or_current(self)
    if not rows:
        return []
    # locate 'Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†' column by normalized header text
    col = None
    try:
        def _norm(s):
            return normalize_text_ar(s)
        tbl = getattr(self, "table", None)
        tbl_cash = getattr(self, "table_cash", None)
        use_tbl = tbl
        try:
            if tbl_cash and (tbl_cash.hasFocus() or (tbl_cash.selectionModel() and (tbl_cash.selectionModel().selectedRows() or tbl_cash.selectionModel().selectedIndexes()))):
                use_tbl = tbl_cash
        except Exception:
            pass
        for i in range(use_tbl.columnCount()):
            try:
                h = use_tbl.horizontalHeaderItem(i).text()
            except Exception:
                h = ""
            hn = _norm(h)
            if hn in (_norm("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†"), _norm("g_no"), _norm("no"), _norm("RNO"), _norm("Ø±Ù‚Ù…")):
                col = i
                break
        if col is None:
            # fallback: try first visible column
            for i in range(use_tbl.columnCount()):
                if not use_tbl.isColumnHidden(i):
                    col = i
                    break
        if col is None:
            col = 0
    except Exception:
        col = 0
    gnos = []
    for r in rows:
        try:
            it = use_tbl.item(r, col)
            val = (it.text() if it else "") if hasattr(it, "text") else str(it or "")
            val = (val or "").strip()
            if val:
                gnos.append(val)
        except Exception:
            pass
    return gnos


def _selected_rowids(self):
    rows = _selected_rows_or_current(self)
    if not rows:
        return []
    col = None
    try:
        def _norm(s):
            return normalize_text_ar(s)
        tbl = getattr(self, "table", None)
        tbl_cash = getattr(self, "table_cash", None)
        use_tbl = tbl
        try:
            if tbl_cash and (tbl_cash.hasFocus() or (tbl_cash.selectionModel() and (tbl_cash.selectionModel().selectedRows() or tbl_cash.selectionModel().selectedIndexes()))):
                use_tbl = tbl_cash
        except Exception:
            pass
        for i in range(use_tbl.columnCount()):
            try:
                h = use_tbl.horizontalHeaderItem(i).text()
            except Exception:
                h = ""
            hn = _norm(h)
            if hn in (_norm("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†"), _norm("g_no"), _norm("no"), _norm("RNO"), _norm("Ø±Ù‚Ù…")):
                col = i
                break
        if col is None:
            for i in range(use_tbl.columnCount()):
                if not use_tbl.isColumnHidden(i):
                    col = i
                    break
        if col is None:
            col = 0
    except Exception:
        col = 0
    rids = []
    for r in rows:
        try:
            it = use_tbl.item(r, col)
            rid = it.data(QtCore.Qt.UserRole) if it else None
            if rid is not None:
                rids.append(int(rid))
        except Exception:
            pass
    return rids


def apply_loaded_table_geometry(self):
    pass


class FontSettingsDialog(QtWidgets.QDialog):
    """Dialog to configure fonts for the app, table headers, and table body (safe: uses QFontDialog)."""

    def __init__(self, parent=None, initial=None):

        try:
          apply_loaded_table_geometry(self)
        except Exception:
            pass
        try:
            _install_geometry_undo(self)
        except Exception:
            pass
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·")
        self.setModal(True)
        lay = QtWidgets.QFormLayout(self)
        try:
            apply_toolbar_visibility(self)
        except Exception:
            pass

        # State
        self._app = QtGui.QFont(initial.get("appFamily", "Tahoma"),
                                int(initial.get("appSize", 11))) if initial else QtGui.QFont("Tahoma", 11)
        self._header = QtGui.QFont(initial.get("headerFamily", "Tahoma"),
                                   int(initial.get("headerSize", 11))) if initial else QtGui.QFont("Tahoma", 11)
        self._header.setBold(bool(initial.get("headerBold", False)) if initial else False)
        self._body = QtGui.QFont(initial.get("bodyFamily", "Tahoma"),
                                 int(initial.get("bodySize", 11))) if initial else QtGui.QFont("Tahoma", 11)

        # App font
        self.app_btn = QtWidgets.QPushButton(self._label_for_font(self._app))
        self.app_size = QtWidgets.QSpinBox(self);
        self.app_size.setRange(8, 36);
        self.app_size.setValue(self._app.pointSize() or 11)
        self.app_btn.clicked.connect(lambda: self._pick_font("app"))

        # Header font
        self.header_btn = QtWidgets.QPushButton(self._label_for_font(self._header))
        self.header_size = QtWidgets.QSpinBox(self);
        self.header_size.setRange(8, 36);
        self.header_size.setValue(self._header.pointSize() or 11)
        self.header_bold = QtWidgets.QCheckBox("Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ø±ÙŠØ¶Ø©", self);
        self.header_bold.setChecked(self._header.bold())
        self.header_btn.clicked.connect(lambda: self._pick_font("header"))

        # Body font
        self.body_btn = QtWidgets.QPushButton(self._label_for_font(self._body))
        self.body_size = QtWidgets.QSpinBox(self);
        self.body_size.setRange(8, 36);
        self.body_size.setValue(self._body.pointSize() or 11)
        self.body_btn.clicked.connect(lambda: self._pick_font("body"))

        lay.addRow("Ø®Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:", self.app_btn);
        lay.addRow("Ø­Ø¬Ù… Ø®Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:", self.app_size)
        lay.addRow("Ø®Ø· Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„:", self.header_btn);
        lay.addRow("Ø­Ø¬Ù… Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„:", self.header_size)
        lay.addRow(self.header_bold)
        lay.addRow("Ø®Ø· ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„:", self.body_btn);
        lay.addRow("Ø­Ø¬Ù… ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„:", self.body_size)

        # Alignment options
        self.align_group = QtWidgets.QGroupBox("Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ")
        h = QtWidgets.QHBoxLayout(self.align_group)
        self.align_right = QtWidgets.QRadioButton("ÙŠÙ…ÙŠÙ†")
        self.align_center = QtWidgets.QRadioButton("ÙˆØ³Ø·")
        self.align_left = QtWidgets.QRadioButton("ÙŠØ³Ø§Ø±")
        h.addWidget(self.align_right);
        h.addWidget(self.align_center);
        h.addWidget(self.align_left)
        lay.addRow(self.align_group)
        if initial:
            al = (initial.get("align") or "right")
        else:
            al = "right"
        if al == "left":
            self.align_left.setChecked(True)
        elif al == "center":
            self.align_center.setChecked(True)
        else:
            self.align_right.setChecked(True)

        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel,
                                          parent=self)
        lay.addRow(btns)
        btns.accepted.connect(self.accept);
        btns.rejected.connect(self.reject)

    def _label_for_font(self, f: QtGui.QFont):
        return f"{f.family()} ({f.pointSize()}pt)"

    def _pick_font(self, which: str):
        base = {"app": self._app, "header": self._header, "body": self._body}[which]
        font, ok = QtWidgets.QFontDialog.getFont(base, self, "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·")
        if ok:
            if which == "app":
                self._app = font
                self.app_btn.setText(self._label_for_font(font))
                self.app_size.setValue(font.pointSize() or self.app_size.value())
            elif which == "header":
                self._header = font
                self.header_btn.setText(self._label_for_font(font))
                self.header_size.setValue(font.pointSize() or self.header_size.value())
            else:
                self._body = font
                self.body_btn.setText(self._label_for_font(font))
                self.body_size.setValue(font.pointSize() or self.body_size.value())

    def get_values(self):
        return {
            "align": "left" if self.align_left.isChecked() else (
                "center" if self.align_center.isChecked() else "right"),
            "appFamily": self._app.family(),
            "appSize": int(self.app_size.value()),
            "headerFamily": self._header.family(),
            "headerSize": int(self.header_size.value()),
            "headerBold": bool(self.header_bold.isChecked()),
            "bodyFamily": self._body.family(),
            "bodySize": int(self.body_size.value()),
        }


        # Ensure autosave is enabled after UI is built (disabled due to context)
        # try:
        #     self.enable_autosave()
        # except Exception:
        #     pass

class GuaranteeViewDialog(QtWidgets.QDialog):
    """Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ù…Ø§Ù†."""
    
    def __init__(self, parent=None, row_data=None, g_no=None):
        super().__init__(parent)
        self.setWindowTitle("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ù…Ø§Ù†")
        self.setMinimumWidth(900)
        self.setMinimumHeight(700)
        self.resize(900, 700)
        
        self.is_editing = False
        
        # Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ±Ù‡Ø§
        if not row_data and g_no:
            try:
                conn = connect_db()
                c = conn.cursor()
                row = c.execute(
                    """SELECT department, bank, g_no, g_type, amount, insurance_amount, percent, 
                       beneficiary, requester, project_name, issue_date, end_date, user_status, 
                       cash_flag, delivery_status, recipient_name, notes, entry_number 
                       FROM guarantees WHERE g_no=?""",
                    (normalize_gno(g_no),)
                ).fetchone()
                conn.close()
                
                if row:
                    row_data = {
                        "department": row[0] or "",
                        "bank": row[1] or "",
                        "g_no": row[2] or "",
                        "g_type": row[3] or "",
                        "amount": row[4] or 0,
                        "insurance_amount": row[5] or 0,
                        "percent": row[6] or 0,
                        "beneficiary": row[7] or "",
                        "requester": row[8] or "",
                        "project_name": row[9] or "",
                        "issue_date": row[10] or "",
                        "end_date": row[11] or "",
                        "user_status": row[12] or "ØªÙ„Ù‚Ø§Ø¦ÙŠ",
                        "cash_flag": int(row[13] or 0),
                        "delivery_status": row[14] or "",
                        "recipient_name": row[15] or "",
                        "notes": row[16] or "",
                        "entry_number": row[17] or "",
                    }
            except Exception:
                pass
        
        if not row_data:
            row_data = {}
        self.row_data = row_data
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            self.theme_name = (s.value("theme/name", "dark") or "dark").lower()
        except Exception:
            self.theme_name = "dark"
        
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø«ÙŠÙ…
        if self.theme_name == "light":
            self.c_win = "#f5f5f5"; self.c_base = "#ffffff"; self.c_alt = "#f5f5f5"
            self.c_border = "#d0d0d0"; self.c_text = "#000000"; self.c_lbl = "#666666"
            self.c_btn = "#f0f0f0"; self.c_btn_h = "#e0e0e0"
            self.c_input_bg = "#ffffff"; self.c_input_border = "#aaaaaa"
        elif self.theme_name == "colorful":
            self.c_win = "#1f2430"; self.c_base = "#202533"; self.c_alt = "#252b3c"
            self.c_border = "#2b3145"; self.c_text = "#ffffff"; self.c_lbl = "#aab0be"
            self.c_btn = "#2b3145"; self.c_btn_h = "#32384e"
            self.c_input_bg = "#1a1e2a"; self.c_input_border = "#3e445e"
        else: # dark
            self.c_win = "#2d2d30"; self.c_base = "#1e1e1e"; self.c_alt = "#2d2d30"
            self.c_border = "#3e3e42"; self.c_text = "#ffffff"; self.c_lbl = "#cccccc"
            self.c_btn = "#2d2d30"; self.c_btn_h = "#3e3e42"
            self.c_input_bg = "#252526"; self.c_input_border = "#555555"
        
        # Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_layout = QtWidgets.QVBoxLayout(self)
        main_layout.setContentsMargins(20, 20, 20, 20)
        self.setStyleSheet(f"background-color: {self.c_win}; color: {self.c_text};")
        
        card = QtWidgets.QWidget()
        card.setStyleSheet(f"QWidget {{ background-color: {self.c_base}; border-radius: 8px; border: 1px solid {self.c_border}; }}")
        card_layout = QtWidgets.QVBoxLayout(card)
        card_layout.setSpacing(15)
        card_layout.setContentsMargins(30, 25, 30, 25)
        
        self.grid = QtWidgets.QGridLayout()
        self.grid.setSpacing(14)
        self.grid.setContentsMargins(0, 15, 0, 15)
        
        self.ui_widgets = {}
        
        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„: (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ù…ÙØªØ§Ø­ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª)
        self.field_defs = [
            ("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "g_no", "text", None),
            ("Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†", "g_type", "combo", None),
            ("Ø§Ù„Ù‚Ø³Ù…", "department", "combo", None),
            ("Ø§Ù„Ø¨Ù†Ùƒ", "bank", "combo", None),
            ("Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†", "amount", "number", None),
            ("Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†", "insurance_amount", "number", None),
            ("Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ù…Ø§Ù†", "percent", "percent", None),
            ("Ø§Ù„Ø­Ø§Ù„Ø©", "user_status", "combo", ["ØªÙ„Ù‚Ø§Ø¦ÙŠ", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"]),
            ("Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª", "cash_flag", "combo", [("Ù„Ø§", "ØªØ³Ù‡ÙŠÙ„Ø§Øª"), ("Ù†Ø¹Ù…", "Ù†Ù‚Ø¯ÙŠ")]),
            ("Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©", "beneficiary", "text", None),
            ("Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©", "requester", "text", None),
            ("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", "project_name", "text", None),
            ("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "issue_date", "date", None),
            ("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "end_date", "date", None),
            ("Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯", "entry_number", "text", None),
            ("Ø§Ù„ØªØ³Ù„ÙŠÙ…", "delivery_status", "text", None),
            ("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", "recipient_name", "text", None),
        ]
        
        for i, (lbl_text, key, ftype, opts) in enumerate(self.field_defs):
            row, col = i // 2, (i % 2) * 2
            
            lbl = QtWidgets.QLabel(lbl_text + ":")
            lbl.setStyleSheet(f"color: {self.c_lbl}; font-size: 13px; font-weight: bold; min-width: 130px;")
            
            widget = self._create_widget(key, ftype, opts)
            self.ui_widgets[key] = widget
            
            self.grid.addWidget(lbl, row, col)
            self.grid.addWidget(widget, row, col+1)
            
        card_layout.addLayout(self.grid)
        
        # Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        lbl_notes = QtWidgets.QLabel("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:")
        lbl_notes.setStyleSheet(f"color: {self.c_lbl}; font-size: 13px; font-weight: bold; margin-top: 8px;")
        self.txt_notes = QtWidgets.QTextEdit()
        self.txt_notes.setText(str(self.row_data.get("notes", "")))
        self.txt_notes.setReadOnly(True)
        self.txt_notes.setStyleSheet(self._get_view_style(is_notes=True))
        self.txt_notes.setMaximumHeight(80)
        
        card_layout.addWidget(lbl_notes)
        card_layout.addWidget(self.txt_notes)
        
        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        btn_layout = QtWidgets.QHBoxLayout()
        self.btn_edit = QtWidgets.QPushButton("ØªØ¹Ø¯ÙŠÙ„")
        self.btn_print = QtWidgets.QPushButton("Ø·Ø¨Ø§Ø¹Ø©")
        self.btn_close = QtWidgets.QPushButton("Ø¥ØºÙ„Ø§Ù‚")
        
        btn_style = f"""
            QPushButton {{ background-color: {self.c_btn}; color: {self.c_text}; border: 1px solid {self.c_border}; padding: 10px 40px; border-radius: 4px; font-size: 13px; }}
            QPushButton:hover {{ background-color: {self.c_btn_h}; }}
        """
        for btn in [self.btn_edit, self.btn_print, self.btn_close]:
            btn.setStyleSheet(btn_style)
            
        self.btn_edit.clicked.connect(self._toggle_edit)
        self.btn_print.clicked.connect(self._print_details)
        self.btn_close.clicked.connect(self._handle_close)
        
        btn_layout.addStretch()
        btn_layout.addWidget(self.btn_edit)
        btn_layout.addSpacing(10)
        btn_layout.addWidget(self.btn_print)
        btn_layout.addSpacing(10)
        btn_layout.addWidget(self.btn_close)
        btn_layout.addStretch()
        
        card_layout.addLayout(btn_layout)
        main_layout.addWidget(card)
        
        # ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        self._populate_widgets()

    def _create_widget(self, key, ftype, opts):
        if ftype in ["text", "number", "percent"]:
            w = QtWidgets.QLineEdit()
            w.setReadOnly(True)
        elif ftype == "combo":
            w = QtWidgets.QComboBox()
            w.setEnabled(False)
            w.setEditable(True)
            w.lineEdit().setReadOnly(True)
        elif ftype == "date":
            w = QtWidgets.QDateEdit()
            w.setDisplayFormat("yyyy-MM-dd")
            w.setCalendarPopup(True)
            w.setReadOnly(True)
            w.setButtonSymbols(QtWidgets.QAbstractSpinBox.NoButtons)
        
        w.setStyleSheet(self._get_view_style())
        return w

    def _get_view_style(self, is_notes=False):
        min_h = "min-height: 60px;" if is_notes else "min-height: 20px;"
        return f"background-color: {self.c_alt}; border: 1px solid {self.c_border}; border-radius: 4px; color: {self.c_text}; font-size: 13px; padding: 8px 12px; {min_h}"
        
    def _get_edit_style(self, is_notes=False):
        min_h = "min-height: 60px;" if is_notes else ""
        return f"background-color: {self.c_input_bg}; border: 1px solid {self.c_input_border}; border-radius: 4px; color: {self.c_text}; font-size: 13px; padding: 5px; {min_h}"

    def _populate_widgets(self):
        for key, w in self.ui_widgets.items():
            val = self.row_data.get(key, "")
            
            if isinstance(w, QtWidgets.QLineEdit):
                if key == "amount" or key == "insurance_amount":
                    try:
                        clean_val = str(val or "0").replace(",", "").strip()
                        w.setText(f"{float(clean_val):,.2f}")
                    except:
                        w.setText("0.00")
                elif key == "percent":
                     clean_val = str(val).replace("%", "").strip()
                     w.setText(f"{clean_val}%")
                else:
                    w.setText(str(val))
                    
            elif isinstance(w, QtWidgets.QComboBox):
                w.clear()
                if key == "cash_flag":
                    try:
                        if str(val).strip() == "Ù†Ø¹Ù…":
                             is_cash = 1
                        else:
                             is_cash = int(val or 0)
                        txt = "Ù†Ø¹Ù… (Ù†Ù‚Ø¯ÙŠ)" if is_cash else "Ù„Ø§ (ØªØ³Ù‡ÙŠÙ„Ø§Øª)"
                    except:
                        txt = "Ù„Ø§ (ØªØ³Ù‡ÙŠÙ„Ø§Øª)"
                    w.addItem(txt)
                    w.setCurrentText(txt)
                else:
                    w.addItem(str(val))
                    w.setCurrentText(str(val))
                
            elif isinstance(w, QtWidgets.QDateEdit):
                d = parse_date(str(val))
                if d:
                    w.setDate(QtCore.QDate(d.year, d.month, d.day))
                else:
                    w.setDate(QtCore.QDate.currentDate())
    
    def _toggle_edit(self):
        if self.is_editing:
            self._save_changes()
        else:
            self._enter_edit_mode()
            
    def _enter_edit_mode(self):
        self.is_editing = True
        self.btn_edit.setText("Ø­ÙØ¸")
        self.btn_close.setText("Ø¥Ù„ØºØ§Ø¡")
        
        self._load_combo_options()
        
        for key, w in self.ui_widgets.items():
            w.setStyleSheet(self._get_edit_style())
            if isinstance(w, QtWidgets.QLineEdit):
                w.setReadOnly(False)
                if key in ["amount", "insurance_amount"]:
                    txt = w.text().replace(",", "")
                    w.setText(txt)
                if key == "percent":
                    txt = w.text().replace("%", "")
                    w.setText(txt)
            elif isinstance(w, QtWidgets.QComboBox):
                w.setEnabled(True)
                w.setEditable(True)
                w.lineEdit().setReadOnly(False)
            elif isinstance(w, QtWidgets.QDateEdit):
                w.setReadOnly(False)
                w.setButtonSymbols(QtWidgets.QAbstractSpinBox.UpDownArrows)
        
        self.txt_notes.setReadOnly(False)
        self.txt_notes.setStyleSheet(self._get_edit_style(is_notes=True))

    def _load_combo_options(self):
        conn = connect_db()
        c = conn.cursor()
        
        def _fill(k, sql):
            w = self.ui_widgets.get(k)
            if not w or not isinstance(w, QtWidgets.QComboBox): return
            curr = w.currentText()
            w.clear()
            try:
                items = [r[0] for r in c.execute(sql).fetchall() if r[0]]
                items = sorted(list(set([str(x).strip() for x in items if str(x).strip()])))
                w.addItems(items)
            except: pass
            
            if w.findText(curr) < 0:
                w.addItem(curr)
            w.setCurrentText(curr)

        _fill("g_type", "SELECT DISTINCT g_type FROM guarantees")
        _fill("department", "SELECT DISTINCT department FROM guarantees")
        _fill("bank", "SELECT DISTINCT bank FROM guarantees")
        _fill("user_status", "SELECT DISTINCT user_status FROM guarantees")
        
        w = self.ui_widgets.get("cash_flag")
        if w:
            curr = w.currentText()
            w.clear()
            w.addItem("Ù„Ø§ (ØªØ³Ù‡ÙŠÙ„Ø§Øª)")
            w.addItem("Ù†Ø¹Ù… (Ù†Ù‚Ø¯ÙŠ)")
            w.setCurrentText(curr)
            
        conn.close()

    def _save_changes(self):
        g_no_widget = self.ui_widgets["g_no"]
        new_g_no = g_no_widget.text().strip()
        if not new_g_no:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø·Ù„ÙˆØ¨")
            return
            
        data = {}
        for key, w in self.ui_widgets.items():
            if isinstance(w, QtWidgets.QLineEdit):
                data[key] = w.text().strip()
            elif isinstance(w, QtWidgets.QComboBox):
                data[key] = w.currentText().strip()
            elif isinstance(w, QtWidgets.QDateEdit):
                data[key] = w.date().toString("yyyy-MM-dd")
        
        data["notes"] = self.txt_notes.toPlainText()
        
        try:
            data["amount"] = float(str(data["amount"]).replace(",", "").strip() or 0)
        except: data["amount"] = 0
        try:
            data["insurance_amount"] = float(str(data["insurance_amount"]).replace(",", "").strip() or 0)
        except: data["insurance_amount"] = 0
        try:
            data["percent"] = float(str(data["percent"]).replace("%","").strip() or 0)
        except: data["percent"] = 0
        
        if "Ù†Ø¹Ù…" in data["cash_flag"]: data["cash_flag"] = 1
        else: data["cash_flag"] = 0
        
        try:
            conn = connect_db()
            c = conn.cursor()
            
            old_g_no = self.row_data.get("g_no")
            if normalize_gno(new_g_no) != normalize_gno(old_g_no):
                exists = c.execute("SELECT 1 FROM guarantees WHERE g_no=? AND g_no<>?", (normalize_gno(new_g_no), normalize_gno(old_g_no))).fetchone()
                if exists:
                    QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
                    conn.close()
                    return

            c.execute("""
                UPDATE guarantees SET 
                g_no=?, g_type=?, department=?, bank=?, amount=?, insurance_amount=?, percent=?,
                beneficiary=?, requester=?, project_name=?, issue_date=?, end_date=?,
                user_status=?, cash_flag=?, delivery_status=?, recipient_name=?, notes=?, entry_number=?
                WHERE g_no=?
            """, (
                normalize_gno(new_g_no), data["g_type"], data["department"], normalize_bank(data["bank"], new_g_no),
                data["amount"], data["insurance_amount"], data["percent"],
                data["beneficiary"], data["requester"], data["project_name"],
                data["issue_date"], data["end_date"],
                data["user_status"], data["cash_flag"],
                data["delivery_status"], data["recipient_name"], data["notes"], data["entry_number"],
                normalize_gno(old_g_no)
            ))
            conn.commit()
            conn.close()
            
            self.row_data.update(data)
            self.row_data["g_no"] = new_g_no
            
            self.is_editing = False
            self.btn_edit.setText("ØªØ¹Ø¯ÙŠÙ„")
            self.btn_close.setText("Ø¥ØºÙ„Ø§Ù‚")
            
            for key, w in self.ui_widgets.items():
                w.setStyleSheet(self._get_view_style())
                if isinstance(w, QtWidgets.QLineEdit):
                    w.setReadOnly(True)
                elif isinstance(w, QtWidgets.QComboBox):
                    w.setEnabled(False)
                    w.setEditable(True)
                    w.lineEdit().setReadOnly(True)
                elif isinstance(w, QtWidgets.QDateEdit):
                    w.setReadOnly(True)
                    w.setButtonSymbols(QtWidgets.QAbstractSpinBox.NoButtons)
            
            self.txt_notes.setReadOnly(True)
            self.txt_notes.setStyleSheet(self._get_view_style(is_notes=True))
            
            self._populate_widgets()
            
            QtWidgets.QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª")
            
            if self.parent() and hasattr(self.parent(), "refresh"):
                self.parent().refresh()
                
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: {e}")

    def _handle_close(self):
        if self.is_editing:
            self.is_editing = False
            self.btn_edit.setText("ØªØ¹Ø¯ÙŠÙ„")
            self.btn_close.setText("Ø¥ØºÙ„Ø§Ù‚")
            
            for key, w in self.ui_widgets.items():
                w.setStyleSheet(self._get_view_style())
                if isinstance(w, QtWidgets.QLineEdit):
                    w.setReadOnly(True)
                elif isinstance(w, QtWidgets.QComboBox):
                    w.setEnabled(False)
                    w.setEditable(True)
                    w.lineEdit().setReadOnly(True)
                elif isinstance(w, QtWidgets.QDateEdit):
                    w.setReadOnly(True)
                    w.setButtonSymbols(QtWidgets.QAbstractSpinBox.NoButtons)
            
            self.txt_notes.setReadOnly(True)
            self.txt_notes.setStyleSheet(self._get_view_style(is_notes=True))
            
            self._populate_widgets()
        else:
            self.accept()

    def _print_details(self):
        try:
            printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
            
            # Apply Duplex & Printer Settings
            try:
                s = QtCore.QSettings("GuaranteesApp", "Main")
                
                # Printer
                p_name = s.value("print/printer_name", "")
                if p_name:
                    printer.setPrinterName(p_name)
                
                # Duplex
                d_idx = s.value("print/duplex", 0, type=int)
                if d_idx == 1:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexLongSide)
                elif d_idx == 2:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexShortSide)
                else:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexNone)
            except Exception:
                pass
                
            dialog = QtPrintSupport.QPrintDialog(printer, self)
            if dialog.exec_() == QtWidgets.QDialog.Accepted:
                doc = QtGui.QTextDocument()
                doc.setDefaultStyleSheet("td { padding: 5px; text-align: center; vertical-align: middle; } th { padding: 5px; background-color: #f0f0f0; text-align: center; vertical-align: middle; }")
                
                html = """
                <h2 align="center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†</h2>
                <table border="1" cellspacing="0" cellpadding="4" width="100%" style="border-collapse: collapse;">
                """
                
                fields_order = [
                    ("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "g_no"), ("Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†", "g_type"),
                    ("Ø§Ù„Ù‚Ø³Ù…", "department"), ("Ø§Ù„Ø¨Ù†Ùƒ", "bank"),
                    ("Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†", "amount"), ("Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†", "insurance_amount"),
                    ("Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ù…Ø§Ù†", "percent"), ("Ø§Ù„Ø­Ø§Ù„Ø©", "user_status"),
                    ("Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª", "cash_flag"), ("Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©", "beneficiary"),
                    ("Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©", "requester"), ("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", "project_name"),
                    ("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "issue_date"), ("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "end_date"),
                    ("Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯", "entry_number"), ("Ø§Ù„ØªØ³Ù„ÙŠÙ…", "delivery_status"),
                    ("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", "recipient_name")
                ]
                
                for label, key in fields_order:
                    val = self.row_data.get(key, "-")
                    if key in ["amount", "insurance_amount"]:
                        try:
                            val = f"{float(val):,.2f}"
                        except:
                            pass
                    elif key == "percent":
                        val = f"{val}%"
                    elif key == "cash_flag":
                        val = "Ù†Ø¹Ù…" if (val == 1 or val == "1" or val == "Ù†Ø¹Ù…") else "Ù„Ø§"
                    
                    html += f"<tr><td width='30%' align='center'><b>{label}</b></td><td align='center'>{val}</td></tr>"
                
                html += "</table>"
                
                notes = self.row_data.get("notes", "")
                if notes:
                    html += f"<h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3><p>{notes}</p>"
                
                doc.setHtml(html)
                doc.print_(printer)
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø·Ø¨Ø§Ø¹Ø©", f"ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {e}")

class BankLimitsDialog(QtWidgets.QDialog):
    """Ù†Ø§ÙØ°Ø© Ø­ÙˆØ§Ø± Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ")
        self.setMinimumWidth(600)
        self.setMinimumHeight(500)
        
        layout = QtWidgets.QVBoxLayout(self)
        
        # ØªØ¹Ù„ÙŠÙ…Ø§Øª
        lbl_info = QtWidgets.QLabel("Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ÙƒÙ„ Ø¨Ù†Ùƒ:")
        layout.addWidget(lbl_info)
        
        # Ø¬Ø¯ÙˆÙ„ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯
        self.table = QtWidgets.QTableWidget(self)
        self.table.setColumnCount(2)
        self.table.setHorizontalHeaderLabels(["Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰"])
        self.table.horizontalHeader().setStretchLastSection(True)
        self.table.setAlternatingRowColors(True)
        self.table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        
        # Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        self._load_banks()
        
        layout.addWidget(self.table)
        
        # Ø£Ø²Ø±Ø§Ø±
        btn_box = QtWidgets.QDialogButtonBox(
            QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel,
            self
        )
        btn_box.accepted.connect(self._save_limits)
        btn_box.rejected.connect(self.reject)
        layout.addWidget(btn_box)
    
    def _load_banks(self):
        """ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            rows = self.parent()._iter_all_rows()
        except Exception:
            rows = []
        
        banks_set = set()
        for r in rows:
            try:
                bank_raw = r[1]
                g_no = r[2]
                bank_name = normalize_bank(bank_raw or "", str(g_no or ""))
                if bank_name:
                    banks_set.add(bank_name)
            except Exception:
                pass
        
        # Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        limits_map = {}
        try:
            conn = connect_db()
            c = conn.cursor()
            for row in c.execute("SELECT bank_name, limit_amount FROM bank_limits").fetchall():
                limits_map[row[0]] = float(row[1] or 0.0)
            conn.close()
        except Exception:
            limits_map = {}
        
        # Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        banks_list = sorted(banks_set)
        self.table.setRowCount(len(banks_list))
        
        for idx, bank_name in enumerate(banks_list):
            # Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ
            it_bank = QtWidgets.QTableWidgetItem(bank_name)
            it_bank.setFlags(it_bank.flags() ^ QtCore.Qt.ItemIsEditable)
            it_bank.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            self.table.setItem(idx, 0, it_bank)
            
            # Ø§Ù„Ø­Ø¯
            limit_val = limits_map.get(bank_name, 0.0)
            ed_limit = QtWidgets.QLineEdit()
            ed_limit.setText(f"{limit_val:,.2f}".replace(",", ""))
            ed_limit.setPlaceholderText("0.00")
            ed_limit.setAlignment(QtCore.Qt.AlignCenter)
            self.table.setCellWidget(idx, 1, ed_limit)
    
    def _save_limits(self):
        """Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            ensure_db()
            
            conn = connect_db()
            c = conn.cursor()
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø©
            try:
                c.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='bank_limits'")
                if not c.fetchone():
                    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    c.execute("""CREATE TABLE bank_limits (
                                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                                    bank_name TEXT UNIQUE NOT NULL,
                                    limit_amount REAL DEFAULT 0.0
                                )""")
                    conn.commit()
            except Exception:
                pass
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            try:
                cols = [r[1] for r in c.execute("PRAGMA table_info(bank_limits)").fetchall()]
                if "bank_name" not in cols or "limit_amount" not in cols:
                    # Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    c.execute("DROP TABLE IF EXISTS bank_limits")
                    c.execute("""CREATE TABLE bank_limits (
                                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                                    bank_name TEXT UNIQUE NOT NULL,
                                    limit_amount REAL DEFAULT 0.0
                                )""")
                    conn.commit()
            except Exception:
                pass
            
            for row in range(self.table.rowCount()):
                bank_name = self.table.item(row, 0).text()
                ed_limit = self.table.cellWidget(row, 1)
                if not ed_limit or not bank_name:
                    continue
                
                try:
                    limit_text = ed_limit.text().strip().replace(",", "")
                    limit_val = float(limit_text or 0.0)
                except Exception:
                    limit_val = 0.0
                
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… INSERT OR REPLACE Ù„ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ©
                c.execute(
                    "INSERT OR REPLACE INTO bank_limits (bank_name, limit_amount) VALUES (?, ?)",
                    (bank_name, limit_val)
                )
            
            conn.commit()
            conn.close()
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            try:
                self.parent()._populate_bank_limits_tab()
            except Exception:
                pass
            
            try:
                _status(self.parent(), "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­", 2000)
            except Exception:
                pass
            self.accept()
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯: {str(e)}")


class GuaranteeDialog(QtWidgets.QDialog):
    """Dialog to add/edit a guarantee with manual text for beneficiary/requester/project, and cash/credit selector."""

    def __init__(self, parent=None, data=None):
        super().__init__(parent)
        self.setWindowTitle("Ø¶Ù…Ø§Ù† Ø¬Ø¯ÙŠØ¯" if data is None else "ØªØ¹Ø¯ÙŠÙ„ Ø¶Ù…Ø§Ù†")
        try:
            scr = QtWidgets.QApplication.primaryScreen()
            geo = scr.availableGeometry() if scr else None
            if geo:
                self.resize(max(320, int(geo.width() * 0.33)), max(240, int(geo.height() * 0.33)))
            else:
                self.resize(320, 240)
        except Exception:
            self.resize(320, 240)
        form = QtWidgets.QFormLayout(self)

        # Ø±Ù‚Ù… ÙˆÙ…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù† (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)
        self.ed_gno = QtWidgets.QLineEdit()
        self.ed_gno.setAlignment(QtCore.Qt.AlignCenter)
        self.lbl_dup_warn = QtWidgets.QLabel("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§!")
        self.lbl_dup_warn.setStyleSheet("color: red; font-weight: bold; margin-left: 5px;")
        self.lbl_dup_warn.hide()
        
        self.ed_amount = QtWidgets.QLineEdit();
        self.ed_amount.setPlaceholderText("Ù…Ø«Ø§Ù„: 50000")
        self.ed_amount.setAlignment(QtCore.Qt.AlignCenter)

        # Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø³Ø¯Ù„Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (Ù†ÙˆØ¹/Ù‚Ø³Ù…/Ø¨Ù†Ùƒ)
        self.cmb_gtype = QtWidgets.QComboBox();
        self.cmb_gtype.setEditable(True)
        self.cmb_gtype.lineEdit().setAlignment(QtCore.Qt.AlignCenter)
        self.cmb_dept = QtWidgets.QComboBox();
        self.cmb_dept.setEditable(True)
        self.cmb_dept.lineEdit().setAlignment(QtCore.Qt.AlignCenter)
        # Ø¨Ù†Ùƒ
        self.cmb_bank = QtWidgets.QComboBox();
        self.cmb_bank.setEditable(True)
        self.cmb_bank.lineEdit().setAlignment(QtCore.Qt.AlignCenter)

        # Ø­Ù‚ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ©
        self.ed_benef = QtWidgets.QLineEdit()
        self.ed_benef.setAlignment(QtCore.Qt.AlignCenter)
        self.ed_req = QtWidgets.QLineEdit()
        self.ed_req.setAlignment(QtCore.Qt.AlignCenter)
        self.ed_proj = QtWidgets.QLineEdit()
        self.ed_proj.setAlignment(QtCore.Qt.AlignCenter)
        self.ed_entry_number = QtWidgets.QLineEdit()
        self.ed_entry_number.setAlignment(QtCore.Qt.AlignCenter)

        # Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª
        self.cmb_cash = QtWidgets.QComboBox();
        self.cmb_cash.addItems(["Ù†Ù‚Ø¯ÙŠ", "ØªØ³Ù‡ÙŠÙ„Ø§Øª"])
        # Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: ØªØ³Ù‡ÙŠÙ„Ø§Øª Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¶Ù…Ø§Ù† Ø¬Ø¯ÙŠØ¯
        try:
            self.cmb_cash.setCurrentIndex(1)
        except Exception:
            pass

        # Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©): Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (ØªÙ„Ù‚Ø§Ø¦ÙŠ/ØºÙŠØ± Ù…Ø³Ø¬Ù„)
        self.cmb_user_status = QtWidgets.QComboBox();
        self.cmb_user_status.setEditable(False)
        # Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¨Ø³Ø·Ø©: "ØªÙ„Ù‚Ø§Ø¦ÙŠ" => ØªÙØ®Ø²Ù‘ÙÙ† ÙƒÙ‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ© ÙÙŠ user_status
        self.cmb_user_status.addItems(["ØªÙ„Ù‚Ø§Ø¦ÙŠ", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"])  

        # Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ù…Ø§Ù†
        self.sp_percent = QtWidgets.QDoubleSpinBox();
        self.sp_percent.setAlignment(QtCore.Qt.AlignCenter)
        self.sp_percent.setRange(0.0, 100.0)
        self.sp_percent.setDecimals(2)
        self.sp_percent.setSuffix("%")
        self.sp_percent.setValue(0.0)

        # ØªÙˆØ§Ø±ÙŠØ®
        self.de_issue = QtWidgets.QDateEdit(calendarPopup=True);
        self.de_issue.setAlignment(QtCore.Qt.AlignCenter)
        self.de_issue.setDisplayFormat("yyyy-MM-dd")
        self.de_end = QtWidgets.QDateEdit(calendarPopup=True);
        self.de_end.setAlignment(QtCore.Qt.AlignCenter)
        self.de_end.setDisplayFormat("yyyy-MM-dd")
        self.de_issue.setDate(QtCore.QDate.currentDate());
        self.de_end.setDate(QtCore.QDate.currentDate())

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù„Ø£Ù†ÙˆØ§Ø¹/Ø£Ù‚Ø³Ø§Ù…/Ø¨Ù†ÙˆÙƒ ÙÙ‚Ø·
        self._load_options()

        # Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        _gno_layout = QtWidgets.QHBoxLayout()
        _gno_layout.addWidget(self.ed_gno)
        _gno_layout.addWidget(self.lbl_dup_warn)
        form.addRow("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†:", _gno_layout)
        
        form.addRow("Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†:", self.cmb_gtype)
        form.addRow("Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†:", self.ed_amount)
        form.addRow("Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ù…Ø§Ù†:", self.sp_percent)
        # Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„
        form.addRow("Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©):", self.cmb_user_status)
        form.addRow("Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©:", self.ed_benef)
        form.addRow("Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©:", self.ed_req)
        form.addRow("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:", self.ed_proj)
        form.addRow("Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯:", self.ed_entry_number)
        form.addRow("Ø§Ù„Ù‚Ø³Ù…:", self.cmb_dept)
        form.addRow("Ø§Ù„Ø¨Ù†Ùƒ:", self.cmb_bank)
        form.addRow("Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª:", self.cmb_cash)
        form.addRow("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:", self.de_issue)
        form.addRow("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:", self.de_end)

        # Attachments row
        self._sel_files = []
        self.attach_btn = QtWidgets.QPushButton("Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙÙ‚â€¦")
        self.attach_lbl = QtWidgets.QLabel("")
        ah = QtWidgets.QHBoxLayout();
        ah.addWidget(self.attach_btn);
        ah.addWidget(self.attach_lbl);
        ah.addStretch(1)
        wrap = QtWidgets.QWidget();
        wrap.setLayout(ah)
        form.addRow("Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:", wrap)
        self.attach_btn.clicked.connect(self.pick_attachments)

        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel, self)
        form.addRow(btns)
        btns.accepted.connect(self.accept);
        btns.rejected.connect(self.reject)

        # ØªØ¹Ø¨Ø¦Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        self._original_gno = None
        if data:
            self._original_gno = normalize_gno(data.get("g_no", ""))
            self.ed_gno.setText(data.get("g_no", ""))
            self._set_current_or_add(self.cmb_gtype, data.get("g_type", ""))
            self.ed_amount.setText(str(data.get("amount", "")))
            try:
                _p = data.get("percent", 0)
                _p = float(str(_p).replace('%','').strip() or 0)
                self.sp_percent.setValue(_p)
            except Exception:
                pass
            self.ed_benef.setText(data.get("beneficiary", ""))
            self.ed_req.setText(data.get("requester", ""))
            self.ed_proj.setText(data.get("project_name", ""))
            self.ed_entry_number.setText(data.get("entry_number", ""))
            self._set_current_or_add(self.cmb_dept, data.get("department", ""))
            self._set_current_or_add(self.cmb_bank, data.get("bank", ""))
            try:
                us = (data.get("user_status", "") or "").strip()
                if not us:
                    self.cmb_user_status.setCurrentIndex(0)  # ØªÙ„Ù‚Ø§Ø¦ÙŠ
                else:
                    self._set_current_or_add(self.cmb_user_status, us)
            except Exception:
                pass
            try:
                d = parse_date(data.get("issue_date", ""))
                if d: self.de_issue.setDate(QtCore.QDate(d.year, d.month, d.day))
            except Exception:
                pass
            try:
                d = parse_date(data.get("end_date", ""))
                if d: self.de_end.setDate(QtCore.QDate(d.year, d.month, d.day))
            except Exception:
                pass
            try:
                self.cmb_cash.setCurrentIndex(0 if int(data.get("cash_flag", 0)) else 1)
            except Exception:
                self.cmb_cash.setCurrentIndex(1)

        # Real-time duplicate check
        try:
            self.ed_gno.textChanged.connect(self._check_duplicate_gno)
            self._pending_attach_files = []
        except Exception:
            pass

        try:
            self._setup_field_suggestions()
        except Exception:
            pass

    def _set_current_or_add(self, combo, text):
        text = "" if text is None else str(text)
        if not text:
            return
        idx = combo.findText(text)
        if idx < 0:
            combo.addItem(text)
            idx = combo.count() - 1
        combo.setCurrentIndex(idx)

    def _load_options(self):



        """Load distinct values from DB for dropdowns (types/departments/banks)."""
        conn = connect_db()
        c = conn.cursor()
        try:
            _PATCH_after_dialog_load_options(self)
        except Exception:
            pass


        def _fill(combo, sql):
            try:
                items = [r[0] for r in c.execute(sql).fetchall()]
                seen = set()
                for it in items:
                    s = "" if it is None else str(it).strip()
                    if not s or s in seen:
                        continue
                    combo.addItem(s)
                    seen.add(s)
            except Exception:
                pass

        _fill(self.cmb_gtype,
              "SELECT DISTINCT g_type FROM guarantees WHERE TRIM(COALESCE(g_type,''))<>'' ORDER BY g_type")
        _fill(self.cmb_dept,
              "SELECT DISTINCT department FROM guarantees WHERE TRIM(COALESCE(department,''))<>'' ORDER BY department")
        # Ø¨Ù†ÙˆÙƒ
        _fill(self.cmb_bank,
              "SELECT DISTINCT bank FROM guarantees WHERE TRIM(COALESCE(bank,''))<>'' ORDER BY bank")
        try:
            def _norm_ar(s):
                return normalize_text_ar(str(s or "")).strip().lower()
            items = []
            for i in range(self.cmb_bank.count()):
                t = self.cmb_bank.itemText(i)
                t = str(t or "").strip()
                if t:
                    items.append(t)
            uniq = {}
            for t in items:
                k = _norm_ar(t)
                if k not in uniq:
                    uniq[k] = t
            def _canon(s):
                ss = str(s or "").strip()
                if "Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶" in ss:
                    return "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"
                na = _norm_ar(ss)
                if na == _norm_ar("Ø§Ù„Ø£Ù‡Ù„ÙŠ") or na == _norm_ar("Ø§Ù„Ø§Ù‡Ù„ÙŠ"):
                    return "Ø§Ù„Ø£Ù‡Ù„ÙŠ"
                if na == _norm_ar("Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡") or na == _norm_ar("Ø§Ù„Ø§Ù†Ù…Ø§Ø¡"):
                    return "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"
                return ss
            for k in list(uniq.keys()):
                uniq[k] = _canon(uniq[k])
            ordered = ["Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³Ø§Ø¨", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ", "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]
            self.cmb_bank.clear()
            added = set()
            for name in ordered:
                kk = _norm_ar(name)
                if kk in uniq and kk not in added:
                    self.cmb_bank.addItem(name)
                    added.add(kk)
            for k, v in uniq.items():
                if k not in added:
                    self.cmb_bank.addItem(v)
        except Exception:
            pass

        # Ensure default department exists even if not in DB yet
        try:
            _default_depts = ["Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"]
            for _d in _default_depts:
                if self.cmb_dept.findText(_d) < 0:
                    self.cmb_dept.addItem(_d)
        except Exception:
            pass
        # Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ù„Ù…Ø®ØµØµØ©
        try:
            _PATCH_after_dialog_load_options(self)
        except Exception:
            pass

        conn.close()

    def pick_attachments(self):
        files, _ = QtWidgets.QFileDialog.getOpenFileNames(self, "Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙÙ‚Ø§Øª", "",
                                                          "Ù…Ù„ÙØ§Øª Ù…Ø¯Ø¹ÙˆÙ…Ø© (*.pdf *.png *.jpg *.jpeg *.bmp)")
        if files:
            self._sel_files = files
            try:
                self.attach_lbl.setText(f"ØªÙ… Ø§Ø®ØªÙŠØ§Ø± {len(files)} Ù…Ù„Ù(Ø§Øª)")
            except Exception:
                pass
            # If g_no is specified, copy and persist immediately; otherwise queue
            gno = normalize_gno(self.ed_gno.text().strip())
            if gno:
                try:
                    rels = copy_attachments_for_gno(gno, files)
                    conn = connect_db(); c = conn.cursor()
                    for rel in rels:
                        try:
                            c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (gno, rel))
                        except Exception:
                            pass
                    conn.commit(); conn.close()
                except Exception:
                    pass
            else:
                # store pending until autosave when g_no is set
                try:
                    self._pending_attach_files.extend(files)
                except Exception:
                    self._pending_attach_files = list(files)
        else:
            self._sel_files = []
            self.attach_lbl.setText("")

    def _setup_field_suggestions(self):
        def _attach(le, fetch):
            comp = QtWidgets.QCompleter(self)
            comp.setCaseSensitivity(QtCore.Qt.CaseInsensitive)
            try:
                comp.setFilterMode(QtCore.Qt.MatchContains)
            except Exception:
                pass
            comp.setMaxVisibleItems(3)
            try:
                comp.popup().setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarAlwaysOff)
            except Exception:
                pass
            mdl = QtCore.QStringListModel([], comp)
            comp.setModel(mdl)
            le.setCompleter(comp)
            def _on(txt):
                t = str(txt or "").strip()
                items = fetch(t) if t else []
                items = list(dict.fromkeys(items))[:3]
                mdl.setStringList(items)
                if items:
                    comp.complete()
            try:
                le.textEdited.connect(_on)
            except Exception:
                pass
        def _q(sql, p):
            try:
                conn = connect_db(); c = conn.cursor()
                rows = c.execute(sql, ("%" + p + "%",)).fetchall()
                conn.close()
                return [str(r[0]) for r in rows if (r and r[0] is not None)]
            except Exception:
                return []
        _attach(self.ed_benef, lambda t: _q("SELECT DISTINCT beneficiary FROM guarantees WHERE TRIM(COALESCE(beneficiary,''))<>'' AND beneficiary LIKE ? ORDER BY beneficiary LIMIT 3", t))
        _attach(self.ed_req, lambda t: _q("SELECT DISTINCT requester FROM guarantees WHERE TRIM(COALESCE(requester,''))<>'' AND requester LIKE ? ORDER BY requester LIMIT 3", t))
        _attach(self.ed_proj, lambda t: _q("SELECT DISTINCT project_name FROM guarantees WHERE TRIM(COALESCE(project_name,''))<>'' AND project_name LIKE ? ORDER BY project_name LIMIT 3", t))
        _attach(self.ed_entry_number, lambda t: _q("SELECT DISTINCT entry_number FROM guarantees WHERE TRIM(COALESCE(entry_number,''))<>'' AND entry_number LIKE ? ORDER BY entry_number LIMIT 3", t))
        _attach(self.ed_gno, lambda t: _q("SELECT DISTINCT g_no FROM guarantees WHERE TRIM(COALESCE(g_no,''))<>'' AND g_no LIKE ? ORDER BY g_no LIMIT 3", t))
        def _attach_combo(cmb):
            try:
                le = cmb.lineEdit()
            except Exception:
                le = None
            if not le:
                return
            def _fetch(t):
                tl = str(t or "").strip().lower()
                if not tl:
                    return []
                items = [cmb.itemText(i) for i in range(cmb.count())]
                return [it for it in items if tl in str(it).lower()][:3]
            _attach(le, _fetch)
        _attach_combo(self.cmb_dept)
        _attach_combo(self.cmb_bank)
        _attach_combo(self.cmb_gtype)

    def _get_default_scanner_id(self):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            v = s.value("scan/default_device_id", "")
            return str(v or "")
        except Exception:
            return ""

    def _set_default_scanner_id(self, device_id):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            s.setValue("scan/default_device_id", device_id)
        except Exception:
            pass

    def _scan_to_temp_via_wia(self):
        try:
            import os, tempfile, datetime
            ts = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            tmpdir = tempfile.mkdtemp(prefix="scan_")
            tmpfile = os.path.join(tmpdir, f"scan_{ts}.jpg")
            sid = self._get_default_scanner_id()
            
            # Try to import Windows scanner libraries with better error handling
            win32com = None
            try:
                import win32com.client as win32com  # type: ignore
            except (ImportError, ModuleNotFoundError):
                pass
            
            if win32com:
                try:
                    dm = win32com.Dispatch("WIA.DeviceManager")
                    if sid:
                        for di in dm.DeviceInfos:
                            try:
                                if str(getattr(di, "DeviceID", "")) == sid:
                                    dev = di.Connect()
                                    img = dev.Items[1].Transfer()
                                    img.SaveFile(tmpfile)
                                    return tmpfile
                            except Exception:
                                pass
                    dlg = win32com.Dispatch("WIA.CommonDialog")
                    dev = dlg.ShowSelectDevice()
                    if dev:
                        sid2 = str(getattr(dev, "DeviceID", ""))
                        img = dlg.ShowAcquireImage()
                        if img:
                            img.SaveFile(tmpfile)
                            if sid2:
                                self._set_default_scanner_id(sid2)
                            return tmpfile
                except Exception:
                    pass
            
            # Try alternative Windows scanner library
            cc = None
            try:
                import comtypes.client as cc  # type: ignore
            except (ImportError, ModuleNotFoundError):
                pass
            
            if cc:
                try:
                    dm = cc.CreateObject("WIA.DeviceManager")
                    if sid:
                        try:
                            infos = dm.DeviceInfos
                        except Exception:
                            infos = []
                        for i in range(len(infos) if hasattr(infos, "__len__") else 0):
                            try:
                                di = infos[i]
                                if str(getattr(di, "DeviceID", "")) == sid:
                                    dev = di.Connect()
                                    img = dev.Items[1].Transfer()
                                    img.SaveFile(tmpfile)
                                    return tmpfile
                            except Exception:
                                pass
                    dlg = cc.CreateObject("WIA.CommonDialog")
                    dev = dlg.ShowSelectDevice()
                    sid2 = str(getattr(dev, "DeviceID", "")) if dev else ""
                    img = dlg.ShowAcquireImage()
                    if img:
                        img.SaveFile(tmpfile)
                        if sid2:
                            self._set_default_scanner_id(sid2)
                        return tmpfile
                except Exception:
                    pass
                    
        except Exception:
            pass
        return ""

    def scan_attachment_from_form(self):
                files = []
                p = self._scan_to_temp_via_wia()
                ok = bool(p)
                if ok:
                    files = [p]
                else:
                    try:
                        import subprocess, time, os
                        from pathlib import Path
                        start = time.time()
                        subprocess.run(["wiaacmgr.exe"], check=False)
                        user = os.path.expanduser("~")
                        dirs = [
                            os.path.join(user, "Pictures", "Scans"),
                            os.path.join(user, "Documents", "Scanned Documents"),
                        ]
                        exts = ("*.jpg", "*.jpeg", "*.png", "*.bmp", "*.tif", "*.tiff", "*.pdf")
                        cands = []
                        for d in dirs:
                            try:
                                p = Path(d)
                                if p.is_dir():
                                    for e in exts:
                                        for f in p.glob(e):
                                            try:
                                                if os.path.getmtime(str(f)) >= start - 1:
                                                    cands.append(f)
                                            except Exception:
                                                pass
                            except Exception:
                                pass
                        cands.sort(key=lambda f: os.path.getmtime(str(f)), reverse=True)
                        files = [str(cands[0])] if cands else []
                    except Exception:
                        files = []
                if not files:
                    return
                try:
                    self._sel_files = list(self._sel_files) + list(files)
                    self.attach_lbl.setText(f"ØªÙ… Ø§Ø®ØªÙŠØ§Ø± {len(self._sel_files)} Ù…Ù„Ù(Ø§Øª)")
                except Exception:
                    pass
                gno = normalize_gno(self.ed_gno.text().strip())
                if gno:
                    try:
                        rels = copy_attachments_for_gno(gno, files)
                        conn = connect_db(); c = conn.cursor()
                        for rel in rels:
                            try:
                                c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (gno, rel))
                            except Exception:
                                pass
                        conn.commit(); conn.close()
                    except Exception:
                        pass
                else:
                    try:
                        self._pending_attach_files.extend(files)
                    except Exception:
                        self._pending_attach_files = list(files)

    def _check_duplicate_gno(self):
        txt = self.ed_gno.text().strip()
        n = normalize_gno(txt)
        if not n:
            self.lbl_dup_warn.hide()
            return
        
        # If editing and matches original, ignore
        if self._original_gno and n == self._original_gno:
            self.lbl_dup_warn.hide()
            return

        try:
            conn = connect_db()
            c = conn.cursor()
            exists = c.execute("SELECT 1 FROM guarantees WHERE g_no=?", (n,)).fetchone()
            conn.close()
            if exists:
                self.lbl_dup_warn.show()
                self.ed_gno.setStyleSheet("background-color: #FFFF00; color: #000000;")
            else:
                self.lbl_dup_warn.hide()
                self.ed_gno.setStyleSheet("")
        except Exception:
            pass

    def values(self):
                return {
                    "g_no": self.ed_gno.text().strip(),
                    "g_type": self.cmb_gtype.currentText().strip(),
                    "amount": float(self.ed_amount.text().replace(",", "").translate(
                        ARABIC_DIGITS) or 0) if self.ed_amount.text().strip() else 0.0,
                    "percent": float(self.sp_percent.value() if hasattr(self, 'sp_percent') else 0.0),
                    "beneficiary": self.ed_benef.text().strip(),
                    "requester": self.ed_req.text().strip(),
                    "project_name": self.ed_proj.text().strip(),
                    "entry_number": self.ed_entry_number.text().strip(),
                    "department": self.cmb_dept.currentText().strip(),
                    "bank": self.cmb_bank.currentText().strip(),
                    "cash_flag": 1 if self.cmb_cash.currentText() == "Ù†Ù‚Ø¯ÙŠ" else 0,
                    "issue_date": self.de_issue.date().toString("yyyy-MM-dd"),
                    "end_date": self.de_end.date().toString("yyyy-MM-dd"),
                    # Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©: "ØªÙ„Ù‚Ø§Ø¦ÙŠ" => ØªØ®Ø²ÙŠÙ† ÙØ§Ø±Øº
                    "user_status": ("" if (hasattr(self, "cmb_user_status") and self.cmb_user_status.currentText().strip() == "ØªÙ„Ù‚Ø§Ø¦ÙŠ") else (getattr(self.cmb_user_status, "currentText", lambda: "")().strip() if hasattr(self, "cmb_user_status") else "")),
                    "attachments": list(self._sel_files),
                }



class AttachmentCard(QtWidgets.QFrame):
    """A small card with preview/icon, file name and actions."""

    def __init__(self, rid: int, path: str, parent=None):
        super().__init__(parent)
        self.rid = rid
        self.path_raw = path
        try:
            self.path = resolve_attachment_path(path)
        except Exception:
            self.path = path
        self.setFrameShape(QtWidgets.QFrame.StyledPanel)
        self.setFrameShadow(QtWidgets.QFrame.Raised)
        self.setLineWidth(1)
        self.setMinimumWidth(160)
        self.setMaximumWidth(220)
        self.setStyleSheet("QFrame { border: 1px solid #444; border-radius: 6px; }")

        v = QtWidgets.QVBoxLayout(self);
        v.setContentsMargins(8, 8, 8, 8);
        v.setSpacing(6)
        # Preview
        self.preview = QtWidgets.QLabel(self);
        self.preview.setAlignment(QtCore.Qt.AlignCenter)
        self.preview.setFixedHeight(140)
        v.addWidget(self.preview)

        # File name (base)
        base = Path(path).name
        self.lbl = QtWidgets.QLabel(base);
        self.lbl.setWordWrap(True)
        self.lbl.setAlignment(QtCore.Qt.AlignCenter)
        v.addWidget(self.lbl)

        # Notes field
        self._notes_loading = False
        self.ed_notes = QtWidgets.QLineEdit(self)
        try:
            self.ed_notes.setPlaceholderText("Ù…Ù„Ø§Ø­Ø¸Ø§Øªâ€¦")
        except Exception:
            pass
        self.ed_notes.setAlignment(QtCore.Qt.AlignRight)
        self.ed_notes.setClearButtonEnabled(True)
        v.addWidget(self.ed_notes)

        # Debounced autosave for notes
        self._notes_timer = QtCore.QTimer(self)
        self._notes_timer.setSingleShot(True)
        self._notes_timer.setInterval(600)
        self.ed_notes.textChanged.connect(self._schedule_save_notes)

        # Buttons row
        h = QtWidgets.QHBoxLayout();
        h.addStretch(1)
        self.btn_open = QtWidgets.QToolButton();
        self.btn_open.setText("ÙØªØ­")
        self.btn_del = QtWidgets.QToolButton();
        self.btn_del.setText("Ø­Ø°Ù")
        h.addWidget(self.btn_open);
        h.addWidget(self.btn_del)
        v.addLayout(h)

        self.btn_open.clicked.connect(self.open_file)
        self.btn_del.clicked.connect(self.request_delete)

        self._load_preview()
        self._load_notes()

    def set_notes(self, text: str):
        try:
            self._notes_loading = True
            self.ed_notes.setText(text or "")
        except Exception:
            pass
        finally:
            self._notes_loading = False

    def _schedule_save_notes(self):
        if self._notes_loading:
            return
        try:
            self._notes_timer.start()
        except Exception:
            pass

    def _save_notes(self):
        try:
            conn = connect_db(); c = conn.cursor()
            c.execute("UPDATE attachments SET notes=? WHERE id=?", (self.ed_notes.text(), self.rid))
            conn.commit(); conn.close()
        except Exception:
            pass

    def _load_notes(self):
        try:
            conn = connect_db(); c = conn.cursor()
            try:
                row = c.execute("SELECT notes FROM attachments WHERE id=?", (self.rid,)).fetchone()
                self.set_notes(row[0] if row else "")
            except Exception:
                self.set_notes("")
            conn.close()
        except Exception:
            pass
        # Connect after initial load to avoid triggering save
        try:
            self._notes_timer.timeout.connect(self._save_notes)
        except Exception:
            pass

    def _qimage_from_pymupdf_pix(self, pix):
        try:
            # Determine format
            if pix.alpha:
                fmt = QtGui.QImage.Format_RGBA8888
            else:
                fmt = QtGui.QImage.Format_RGB888
            img = QtGui.QImage(pix.samples, pix.width, pix.height, pix.stride, fmt)
            # Deep copy to detach from the underlying buffer
            return img.copy()
        except Exception:
            return None

    def _load_preview(self):
        p = self.path
        try:
            lower = p.lower()
            if lower.endswith((".png", ".jpg", ".jpeg", ".bmp", ".gif", ".webp")):
                pix = QtGui.QPixmap(p)
                if not pix.isNull():
                    self.preview.setPixmap(
                        pix.scaled(self.preview.size(), QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation))
                    return
            elif lower.endswith(".pdf"):
                if HAVE_PYMUPDF:
                    try:
                        doc = fitz.open(p)
                        if doc.page_count > 0:
                            page = doc.load_page(0)
                            mat = fitz.Matrix(2, 2)
                            pix = page.get_pixmap(matrix=mat, alpha=False)
                            img = self._qimage_from_pymupdf_pix(pix)
                            if img is not None and not img.isNull():
                                pm = QtGui.QPixmap.fromImage(img)
                                self.preview.setPixmap(pm.scaled(self.preview.size(), QtCore.Qt.KeepAspectRatio,
                                                                 QtCore.Qt.SmoothTransformation))
                                return
                    except Exception:
                        pass
                # Fallback: show 'PDF' label icon
                pm = QtGui.QPixmap(96, 96)
                pm.fill(QtCore.Qt.transparent)
                painter = QtGui.QPainter(pm)
                painter.setRenderHint(QtGui.QPainter.Antialiasing)
                painter.setBrush(QtGui.QBrush(QtGui.QColor(66, 66, 66)))
                painter.setPen(QtCore.Qt.NoPen)
                painter.drawRoundedRect(0, 0, 96, 96, 12, 12)
                painter.setPen(QtGui.QPen(QtGui.QColor(255, 255, 255)))
                font = QtGui.QFont("Tahoma", 16);
                font.setBold(True)
                painter.setFont(font)
                painter.setPen(QtCore.Qt.black);
                painter.drawText(pm.rect(), QtCore.Qt.AlignCenter, "PDF")
                painter.end()
                self.preview.setPixmap(pm)
                return
            # generic icon for non-images / fallback
            icon = self.style().standardIcon(QtWidgets.QStyle.SP_FileIcon)
            pm = icon.pixmap(64, 64)
            self.preview.setPixmap(pm)
        except Exception:
            pass

    def open_file(self):
        try:
            _open_local_file_safe(getattr(self, 'path_raw', None) or getattr(self, 'path', ''), parent=self)
        except Exception:
            pass

    def request_delete(self):
        # Walk up parent chain to find the dialog that owns `_delete_by_id`
        obj = self
        target = None
        try:
            while obj is not None:
                if hasattr(obj, "_delete_by_id"):
                    target = obj;
                    break
                obj = obj.parent()
        except Exception:
            target = None
        if target is not None:
            target._delete_by_id(self.rid)
        else:
            try:
                QtWidgets.QMessageBox.warning(self, "Ø­Ø°Ù", "ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª.")
            except Exception:
                pass


class AutoResizingTextEdit(QtWidgets.QPlainTextEdit):
    def __init__(self, text, parent_table, callback):
        super().__init__(text)
        self.parent_table = parent_table
        self.callback = callback
        self.setFrameShape(QtWidgets.QFrame.NoFrame)
        self.setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarAlwaysOff)
        self.setStyleSheet("background: transparent;")
        self.textChanged.connect(self.adjust_height)

    def adjust_height(self):
        pos = self.pos()
        row = self.parent_table.indexAt(pos).row()
        if row == -1: return
        
        doc_height = self.document().size().height()
        h = int(doc_height + 15)
        if h < 40: h = 40
        
        if self.parent_table.rowHeight(row) != h:
            self.parent_table.setRowHeight(row, h)

    def focusInEvent(self, event):
        self.parent_table.clearSelection()
        super().focusInEvent(event)

    def focusOutEvent(self, event):
        self.callback(self.toPlainText())
        super().focusOutEvent(event)

    def resizeEvent(self, event):
        self.adjust_height()
        super().resizeEvent(event)

class CopyableLineEdit(QtWidgets.QLineEdit):
    def __init__(self, text, parent_table, preview_callback, attachment_path):
        super().__init__(text)
        self.parent_table = parent_table
        self.preview_callback = preview_callback
        self.attachment_path = attachment_path
        self.setReadOnly(True)
        self.setFrame(False)
        self.setStyleSheet("background: transparent;")
        self.setCursor(QtCore.Qt.IBeamCursor)

    def focusInEvent(self, event):
        self.parent_table.clearSelection()
        if self.preview_callback:
            self.preview_callback(self.attachment_path)
        super().focusInEvent(event)

class AttachmentManagerDialog(QtWidgets.QDialog):
    """Manage multiple attachments (PDF/images) with embedded preview."""

    def __init__(self, parent, g_no):
        super().__init__(parent)
        self.g_no = g_no
        self.setWindowTitle(f"Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª - {g_no}")
        self.resize(1150, 750)
        self.setLayoutDirection(QtCore.Qt.RightToLeft)

        # Internal state for PDF viewer
        self.current_doc = None
        self.current_page_idx = 0
        self.zoom_level = 1.0
        self.current_file_path = None

        # Panning state
        self.is_panning = False
        self.last_mouse_pos = None

        self.setup_ui()
        
        # Connections
        self.table.itemSelectionChanged.connect(self.on_selection_changed)
        self.btn_add.clicked.connect(self.add_files)
        self.btn_scan.clicked.connect(self.scan_files)
        self.btn_print_all.clicked.connect(self.print_all)
        self.btn_delete_all.clicked.connect(self.delete_all)
        self.btn_close.clicked.connect(self.accept)
        
        # PDF Nav Connections
        self.btn_prev.clicked.connect(self.prev_page)
        self.btn_next.clicked.connect(self.next_page)
        self.btn_zoom_in.clicked.connect(self.zoom_in)
        self.btn_zoom_out.clicked.connect(self.zoom_out)
        self.btn_open_ext.clicked.connect(self.open_external)
        self.btn_print_page.clicked.connect(self.print_current_page)

        self.reload()

    def setup_ui(self):
        root = QtWidgets.QVBoxLayout(self)
        
        # Splitter
        splitter = QtWidgets.QSplitter(QtCore.Qt.Horizontal)
        root.addWidget(splitter)
        
        # --- Left Panel (List) ---
        left_widget = QtWidgets.QWidget()
        left_layout = QtWidgets.QVBoxLayout(left_widget)
        left_layout.setContentsMargins(0, 0, 0, 0)
        
        # Toolbar
        tools = QtWidgets.QHBoxLayout()
        self.btn_add = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ©â€¦")
        self.btn_scan = QtWidgets.QPushButton("Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ")
        self.btn_print_all = QtWidgets.QPushButton("Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„")
        self.btn_delete_all = QtWidgets.QPushButton("Ø­Ø°Ù Ø§Ù„ÙƒÙ„")
        tools.addWidget(self.btn_add)
        tools.addWidget(self.btn_scan)
        tools.addWidget(self.btn_print_all)
        tools.addWidget(self.btn_delete_all)
        tools.addStretch(1)
        left_layout.addLayout(tools)
        
        if not HAVE_PYMUPDF:
            hint = QtWidgets.QLabel("ØªÙ†ÙˆÙŠÙ‡: Ù„ØªÙØ¹ÙŠÙ„ Ù…Ø³ØªØ¹Ø±Ø¶ PDF Ø§Ù„Ù…Ø¯Ù…Ø¬ØŒ Ø«Ø¨Øª PyMuPDF: pip install pymupdf")
            hint.setStyleSheet("color:#f0ad4e; font-size:11px;")
            left_layout.addWidget(hint)

        # Table
        self.table = QtWidgets.QTableWidget()
        self.table.setColumnCount(5) # Icon, Name, Notes, Download, Delete
        self.table.setHorizontalHeaderLabels(["", "Ø§Ù„Ø§Ø³Ù…", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "ØªÙ†Ø²ÙŠÙ„", "Ø­Ø°Ù"])
        self.table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        self.table.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
        self.table.verticalHeader().setVisible(False)
        self.table.setAlternatingRowColors(True)
        self.table.setShowGrid(False)
        
        # Col widths
        h = self.table.horizontalHeader()
        h.setSectionResizeMode(1, QtWidgets.QHeaderView.Stretch)
        self.table.setColumnWidth(0, 40)
        self.table.setColumnWidth(2, 240)
        self.table.setColumnWidth(3, 30)
        self.table.setColumnWidth(4, 30)
        
        left_layout.addWidget(self.table)
        
        # --- Right Panel (Preview) ---
        right_widget = QtWidgets.QWidget()
        right_layout = QtWidgets.QVBoxLayout(right_widget)
        right_layout.setContentsMargins(0, 0, 0, 0)
        
        # Preview Toolbar
        ptools = QtWidgets.QHBoxLayout()
        self.btn_open_ext = QtWidgets.QPushButton("ÙØªØ­ Ø®Ø§Ø±Ø¬ÙŠ â†—")
        self.btn_print_page = QtWidgets.QPushButton("Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø©")
        self.btn_zoom_out = QtWidgets.QPushButton(" - ")
        self.btn_zoom_in = QtWidgets.QPushButton(" + ")
        self.btn_prev = QtWidgets.QPushButton("Ø§Ù„Ø³Ø§Ø¨Ù‚")
        self.lbl_page = QtWidgets.QLabel("0 / 0")
        self.btn_next = QtWidgets.QPushButton("Ø§Ù„ØªØ§Ù„ÙŠ")
        
        for b in (self.btn_open_ext, self.btn_print_page, self.btn_zoom_out, self.btn_zoom_in, self.btn_prev, self.btn_next):
            b.setCursor(QtCore.Qt.PointingHandCursor)
            
        ptools.addWidget(self.btn_open_ext)
        ptools.addWidget(self.btn_print_page)
        ptools.addStretch(1)
        ptools.addWidget(self.btn_zoom_out)
        ptools.addWidget(self.btn_zoom_in)
        ptools.addSpacing(15)
        ptools.addWidget(self.btn_prev)
        ptools.addWidget(self.lbl_page)
        ptools.addWidget(self.btn_next)
        
        right_layout.addLayout(ptools)
        
        # Scroll Area
        self.scroll = QtWidgets.QScrollArea()
        self.scroll.setWidgetResizable(True)
        self.scroll.setAlignment(QtCore.Qt.AlignCenter)
        self.scroll.setStyleSheet("background-color: #505050;") # Dark bg for contrast
        
        self.preview_lbl = QtWidgets.QLabel("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")
        self.preview_lbl.setAlignment(QtCore.Qt.AlignCenter)
        self.preview_lbl.setStyleSheet("color: #aaa;")
        self.scroll.setWidget(self.preview_lbl)
        
        # Install event filter for zoom
        self.scroll.viewport().installEventFilter(self)
        
        right_layout.addWidget(self.scroll)
        
        splitter.addWidget(left_widget)
        splitter.addWidget(right_widget)
        splitter.setStretchFactor(0, 12)
        splitter.setStretchFactor(1, 10)
        
        # Bottom
        bot = QtWidgets.QHBoxLayout()
        self.btn_close = QtWidgets.QPushButton("Ø¥ØºÙ„Ø§Ù‚")
        bot.addStretch(1)
        bot.addWidget(self.btn_close)
        root.addLayout(bot)

        # Hidden print overlay (legacy support)
        self._print_overlay = QtWidgets.QLabel(self)
        self._print_overlay.hide()
        self._print_progress = QtWidgets.QProgressBar(self)
        self._print_progress.hide()

    def _conn(self):
        return connect_db()

    def reload(self):
        self.current_doc = None
        self.current_file_path = None
        self.preview_lbl.setText("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")
        self.preview_lbl.setPixmap(QtGui.QPixmap())
        self.lbl_page.setText("0 / 0")
        self.enable_nav(False)
        
        try:
            conn = self._conn(); c = conn.cursor()
            rows = c.execute("SELECT id, path, COALESCE(notes,'') FROM attachments WHERE g_no=? ORDER BY id DESC", (self.g_no,)).fetchall()
            conn.close()
        except:
            rows = []
            
        self.table.setRowCount(0)
        for i, (rid, p, notes) in enumerate(rows):
            ap = resolve_attachment_path(p)
            self.table.insertRow(i)
            
            # Icon
            lbl_icon = QtWidgets.QLabel()
            lbl_icon.setAlignment(QtCore.Qt.AlignCenter)
            pm = self._make_thumbnail(ap)
            lbl_icon.setPixmap(pm)
            self.table.setCellWidget(i, 0, lbl_icon)
            
            # Name
            self.table.setItem(i, 1, QtWidgets.QTableWidgetItem(""))
            name_ed = CopyableLineEdit(Path(ap).stem, self.table, self.show_preview, ap)
            self.table.setCellWidget(i, 1, name_ed)
            
            # Notes
            ed = AutoResizingTextEdit(notes, self.table, lambda t, rid=rid: self._update_notes(rid, t))
            self.table.setCellWidget(i, 2, ed)
            
            # Download
            btn_dl = QtWidgets.QToolButton(); btn_dl.setText("â¬‡")
            btn_dl.clicked.connect(lambda _, p=p: self._save_attachment_as(p))
            self.table.setCellWidget(i, 3, btn_dl)
            
            # Delete
            btn_del = QtWidgets.QToolButton(); btn_del.setText("ğŸ—‘")
            btn_del.clicked.connect(lambda _, rid=rid: self._delete_by_id(rid))
            self.table.setCellWidget(i, 4, btn_del)
            
            # Store full path in item data for easy access
            self.table.item(i, 1).setData(QtCore.Qt.UserRole, ap)
            
        # Initial adjustment
        # for r in range(self.table.rowCount()):
        #      self.table.setRowHeight(r, 40)

    def _make_thumbnail(self, path):
        try:
            icon = QtWidgets.QFileIconProvider().icon(QtCore.QFileInfo(path))
            return icon.pixmap(12, 12)
        except:
            return QtGui.QPixmap(12,12)

    def on_selection_changed(self):
        rows = self.table.selectionModel().selectedRows()
        if not rows:
            return
        row = rows[0].row()
        ap = self.table.item(row, 1).data(QtCore.Qt.UserRole)
        self.show_preview(ap)
        
    def show_preview(self, path):
        self.scroll.setCursor(QtCore.Qt.ArrowCursor)
        self.current_file_path = path
        self.current_doc = None
        self.current_page_idx = 0
        self.zoom_level = 1.0
        
        if not path or not os.path.exists(path):
            self.preview_lbl.setText("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
            return
            
        ext = Path(path).suffix.lower()
        
        if ext == ".pdf":
            if HAVE_PYMUPDF:
                try:
                    self.current_doc = fitz.open(path)
                    self.render_page()
                    self.scroll.setCursor(QtCore.Qt.OpenHandCursor)
                except Exception as e:
                    self.preview_lbl.setText(f"Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ PDF: {e}")
            else:
                self.preview_lbl.setText("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…ÙƒØªØ¨Ø© PyMuPDF ØºÙŠØ± Ù…Ø«Ø¨ØªØ©.")
        elif ext in (".png", ".jpg", ".jpeg", ".bmp", ".gif"):
            pm = QtGui.QPixmap(path)
            if not pm.isNull():
                self.preview_lbl.setPixmap(pm)
                self.lbl_page.setText("ØµÙˆØ±Ø©")
                self.enable_nav(False)
                self.scroll.setCursor(QtCore.Qt.OpenHandCursor)
            else:
                self.preview_lbl.setText("ØµÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©")
        else:
            self.preview_lbl.setText("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª")
            self.lbl_page.setText("-")
            self.enable_nav(False)

    def render_page(self):
        if not self.current_doc: return
        try:
            page = self.current_doc.load_page(self.current_page_idx)
            mat = fitz.Matrix(self.zoom_level, self.zoom_level)
            pix = page.get_pixmap(matrix=mat)
            img = QtGui.QImage(pix.samples, pix.width, pix.height, pix.stride, QtGui.QImage.Format_RGB888)
            self.preview_lbl.setPixmap(QtGui.QPixmap.fromImage(img))
            self.lbl_page.setText(f"{self.current_page_idx + 1} / {self.current_doc.page_count}")
            self.enable_nav(True)
        except Exception as e:
            self.preview_lbl.setText(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶: {e}")

    def enable_nav(self, enable):
        self.btn_prev.setEnabled(enable)
        self.btn_next.setEnabled(enable)
        self.btn_zoom_in.setEnabled(enable)
        self.btn_zoom_out.setEnabled(enable)

    def next_page(self):
        if self.current_doc and self.current_page_idx < self.current_doc.page_count - 1:
            self.current_page_idx += 1
            self.render_page()

    def prev_page(self):
        if self.current_doc and self.current_page_idx > 0:
            self.current_page_idx -= 1
            self.render_page()
            
    def eventFilter(self, source, event):
        if source == self.scroll.viewport():
            if event.type() == QtCore.QEvent.Wheel:
                if event.modifiers() & QtCore.Qt.ControlModifier:
                    if event.angleDelta().y() > 0:
                        self.zoom_in()
                    else:
                        self.zoom_out()
                    return True

            # Panning Logic (Left Click Drag)
            elif event.type() == QtCore.QEvent.MouseButtonPress:
                if event.button() == QtCore.Qt.LeftButton:
                    self.is_panning = True
                    self.last_mouse_pos = event.pos()
                    self.scroll.setCursor(QtCore.Qt.ClosedHandCursor)
                    return True
            
            elif event.type() == QtCore.QEvent.MouseMove:
                if self.is_panning and self.last_mouse_pos:
                    delta = event.pos() - self.last_mouse_pos
                    self.last_mouse_pos = event.pos()
                    
                    hbar = self.scroll.horizontalScrollBar()
                    vbar = self.scroll.verticalScrollBar()
                    
                    hbar.setValue(hbar.value() - delta.x())
                    vbar.setValue(vbar.value() - delta.y())
                    return True
                    
            elif event.type() == QtCore.QEvent.MouseButtonRelease:
                if event.button() == QtCore.Qt.LeftButton:
                    self.is_panning = False
                    self.scroll.setCursor(QtCore.Qt.OpenHandCursor)
                    return True

        return super().eventFilter(source, event)

    def zoom_in(self):
        self.zoom_level += 0.25
        self.render_page()

    def zoom_out(self):
        if self.zoom_level > 0.5:
            self.zoom_level -= 0.25
            self.render_page()
            
    def open_external(self):
        if self.current_file_path:
            _open_local_file_safe(self.current_file_path, self)

    def print_current_page(self):
        if not self.current_file_path: return
        
        printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
        
        # Apply Duplex & Printer Settings
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            
            # Printer
            p_name = s.value("print/printer_name", "")
            if p_name:
                printer.setPrinterName(p_name)
            
            # Duplex
            d_idx = s.value("print/duplex", 0, type=int)
            if d_idx == 1:
                printer.setDuplex(QtPrintSupport.QPrinter.DuplexLongSide)
            elif d_idx == 2:
                printer.setDuplex(QtPrintSupport.QPrinter.DuplexShortSide)
            else:
                printer.setDuplex(QtPrintSupport.QPrinter.DuplexNone)
        except Exception:
            pass
            
        dialog = QtPrintSupport.QPrintDialog(printer, self)
        if dialog.exec_() != QtWidgets.QDialog.Accepted:
            return
            
        painter = QtGui.QPainter(printer)
        
        # Check if PDF or Image
        if self.current_doc: # PDF
            try:
                page = self.current_doc.load_page(self.current_page_idx)
                # higher zoom for printing quality
                zoom = 3.0 
                mat = fitz.Matrix(zoom, zoom)
                pix = page.get_pixmap(matrix=mat)
                img = QtGui.QImage(pix.samples, pix.width, pix.height, pix.stride, QtGui.QImage.Format_RGB888)
                
                # Draw to printer
                rect = painter.viewport()
                size = img.size()
                size.scale(rect.size(), QtCore.Qt.KeepAspectRatio)
                painter.setViewport(rect.x(), rect.y(), size.width(), size.height())
                painter.setWindow(img.rect())
                painter.drawImage(0, 0, img)
                
            except Exception as e:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {e}")
        
        elif self.current_file_path.lower().endswith(('.png', '.jpg', '.jpeg', '.bmp', '.gif', '.tif', '.tiff')):
             # Image
             pixmap = QtGui.QPixmap(self.current_file_path)
             if not pixmap.isNull():
                 rect = painter.viewport()
                 size = pixmap.size()
                 size.scale(rect.size(), QtCore.Qt.KeepAspectRatio)
                 painter.setViewport(rect.x(), rect.y(), size.width(), size.height())
                 painter.setWindow(pixmap.rect())
                 painter.drawPixmap(0, 0, pixmap)
             
        painter.end()

    def _update_notes(self, rid: int, text: str):
        try:
            conn = self._conn(); c = conn.cursor()
            c.execute("UPDATE attachments SET notes=? WHERE id=?", (text, rid))
            conn.commit(); conn.close()
        except:
            pass

    def _delete_by_id(self, rid):
        try:
            if QtWidgets.QMessageBox.question(self, "Ø­Ø°Ù", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ØŸ", 
               QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No) == QtWidgets.QMessageBox.Yes:
                conn = self._conn(); c = conn.cursor()
                c.execute("DELETE FROM attachments WHERE id=?", (rid,))
                conn.commit(); conn.close()
                
                # Audit
                try:
                    log_audit("Ø­Ø°Ù Ù…Ø±ÙÙ‚", f"ID: {rid}", f"Ø¶Ù…Ø§Ù†: {self.g_no}")
                except: pass
                
                self.reload()
        except Exception as e:
            pass

    def delete_all(self):
        if QtWidgets.QMessageBox.question(self, "Ø­Ø°Ù Ø§Ù„ÙƒÙ„", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ", 
           QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No) == QtWidgets.QMessageBox.Yes:
            try:
                conn = self._conn(); c = conn.cursor()
                c.execute("DELETE FROM attachments WHERE g_no=?", (self.g_no,))
                conn.commit(); conn.close()
                log_audit("Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª", self.g_no, "")
                self.reload()
            except: pass

    def print_all(self):
        # ... Reuse existing logic or simplified ...
        import os, time
        try:
            conn = self._conn(); c = conn.cursor()
            rows = c.execute("SELECT path FROM attachments WHERE g_no=?", (self.g_no,)).fetchall()
            conn.close()
            if not rows:
                 QtWidgets.QMessageBox.information(self, "Ø·Ø¨Ø§Ø¹Ø©", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª.")
                 return
            
            for (p,) in rows:
                ap = resolve_attachment_path(p)
                if os.path.exists(ap):
                    try:
                        os.startfile(ap, "print")
                        time.sleep(1)
                    except: pass
        except: pass

    def add_files(self):
        files, _ = QtWidgets.QFileDialog.getOpenFileNames(self, "Ø¥Ø¶Ø§ÙØ©", "", "Files (*.*)")
        if files:
            try:
                rels = copy_attachments_for_gno(self.g_no, files)
                conn = self._conn(); c = conn.cursor()
                for rel in rels:
                    c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (self.g_no, rel))
                conn.commit(); conn.close()
                
                log_audit("Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª", self.g_no, f"Ø¹Ø¯Ø¯: {len(files)}")
                self.reload()
            except: pass

    def _save_attachment_as(self, p_raw):
        try:
            ap = resolve_attachment_path(p_raw)
            if not os.path.exists(ap): return
            import shutil
            dest, _ = QtWidgets.QFileDialog.getSaveFileName(self, "Ø­ÙØ¸ Ø¨Ø§Ø³Ù…", Path(ap).name)
            if dest:
                shutil.copy2(ap, dest)
                QtWidgets.QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ù„Ø­ÙØ¸.")
        except: pass

    def _get_default_scanner_id(self):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            v = s.value("scan/default_device_id", "")
            return str(v or "")
        except Exception:
            return ""

    def _set_default_scanner_id(self, device_id):
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            s.setValue("scan/default_device_id", device_id)
        except Exception:
            pass

    def _scan_to_temp_via_wia(self):
        try:
            import os, tempfile, datetime
            ts = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            tmpdir = tempfile.mkdtemp(prefix="scan_")
            tmpfile = os.path.join(tmpdir, f"scan_{ts}.jpg")
            sid = self._get_default_scanner_id()
            
            # Try to import Windows scanner libraries with better error handling
            win32com = None
            try:
                import win32com.client as win32com  # type: ignore
            except (ImportError, ModuleNotFoundError):
                pass
            
            if win32com:
                try:
                    dm = win32com.Dispatch("WIA.DeviceManager")
                    if sid:
                        for di in dm.DeviceInfos:
                            try:
                                if str(getattr(di, "DeviceID", "")) == sid:
                                    dev = di.Connect()
                                    img = dev.Items[1].Transfer()
                                    img.SaveFile(tmpfile)
                                    return tmpfile
                            except Exception:
                                pass
                    dlg = win32com.Dispatch("WIA.CommonDialog")
                    dev = dlg.ShowSelectDevice()
                    if dev:
                        sid2 = str(getattr(dev, "DeviceID", ""))
                        img = dlg.ShowAcquireImage()
                        if img:
                            img.SaveFile(tmpfile)
                            if sid2:
                                self._set_default_scanner_id(sid2)
                            return tmpfile
                except Exception:
                    pass
            
            # Try alternative Windows scanner library
            cc = None
            try:
                import comtypes.client as cc  # type: ignore
            except (ImportError, ModuleNotFoundError):
                pass
            
            if cc:
                try:
                    dm = cc.CreateObject("WIA.DeviceManager")
                    if sid:
                        try:
                            infos = dm.DeviceInfos
                        except Exception:
                            infos = []
                        for i in range(len(infos) if hasattr(infos, "__len__") else 0):
                            try:
                                di = infos[i]
                                if str(getattr(di, "DeviceID", "")) == sid:
                                    dev = di.Connect()
                                    img = dev.Items[1].Transfer()
                                    img.SaveFile(tmpfile)
                                    return tmpfile
                            except Exception:
                                pass
                    dlg = cc.CreateObject("WIA.CommonDialog")
                    dev = dlg.ShowSelectDevice()
                    sid2 = str(getattr(dev, "DeviceID", "")) if dev else ""
                    img = dlg.ShowAcquireImage()
                    if img:
                        img.SaveFile(tmpfile)
                        if sid2:
                            self._set_default_scanner_id(sid2)
                        return tmpfile
                except Exception:
                    pass
                    
        except Exception:
            pass
        return ""

    def scan_files(self):
        files = []
        p = self._scan_to_temp_via_wia()
        if p:
            files = [p]
        else:
            # Fallback to wiaacmgr.exe (Windows Fax and Scan)
            try:
                import subprocess, time, os
                from pathlib import Path
                start = time.time()
                subprocess.run(["wiaacmgr.exe"], check=False)
                user = os.path.expanduser("~")
                dirs = [
                    os.path.join(user, "Pictures", "Scans"),
                    os.path.join(user, "Documents", "Scanned Documents"),
                ]
                exts = ("*.jpg", "*.jpeg", "*.png", "*.bmp", "*.tif", "*.tiff", "*.pdf")
                cands = []
                for d in dirs:
                    try:
                        p = Path(d)
                        if p.is_dir():
                            for e in exts:
                                for f in p.glob(e):
                                    try:
                                        if os.path.getmtime(str(f)) >= start - 1:
                                            cands.append(f)
                                    except Exception:
                                        pass
                    except Exception:
                        pass
                cands.sort(key=lambda f: os.path.getmtime(str(f)), reverse=True)
                files = [str(cands[0])] if cands else []
            except Exception:
                files = []

        if files:
            # Convert scanned images to PDF if PyMuPDF is available
            final_files = []
            if HAVE_PYMUPDF:
                for f in files:
                    if Path(f).suffix.lower() in ('.jpg', '.jpeg', '.png', '.bmp', '.tif', '.tiff'):
                        try:
                            pdf_path = os.path.splitext(f)[0] + ".pdf"
                            doc = fitz.open()
                            img = fitz.open(f)
                            rect = img[0].rect
                            pdfbytes = img.convert_to_pdf()
                            img.close()
                            imgPDF = fitz.open("pdf", pdfbytes)
                            page = doc.new_page(width=rect.width, height=rect.height)
                            page.show_pdf_page(rect, imgPDF, 0)
                            doc.save(pdf_path)
                            doc.close()
                            final_files.append(pdf_path)
                        except Exception as e:
                            print(f"PDF conversion failed: {e}")
                            final_files.append(f)
                    else:
                        final_files.append(f)
            else:
                final_files = files

            try:
                rels = copy_attachments_for_gno(self.g_no, final_files)
                conn = self._conn(); c = conn.cursor()
                for rel in rels:
                    c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (self.g_no, rel))
                conn.commit(); conn.close()
                log_audit("Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ù„Ù…Ø±ÙÙ‚", self.g_no, f"Ø¹Ø¯Ø¯: {len(final_files)}")
                self.reload()
            except Exception as e:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù…Ø³ÙˆØ­: {e}")


class ColumnSettingsDialog(QtWidgets.QDialog):
    """A simple dialog to reorder/show/hide columns (name-based visibility)."""

    def __init__(self, parent, headers, hidden_by_name):
        super().__init__(parent)
        self.setWindowTitle("ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©")
        self.resize(420, 460)
        v = QtWidgets.QVBoxLayout(self)

        self.list = QtWidgets.QListWidget(self)
        self.list.setSelectionMode(QtWidgets.QAbstractItemView.SingleSelection)
        self.list.setDragDropMode(QtWidgets.QAbstractItemView.InternalMove)
        for i, h in enumerate(headers):
            it = QtWidgets.QListWidgetItem(h)
            it.setFlags(
                it.flags() | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsEnabled | QtCore.Qt.ItemIsSelectable)
            it.setCheckState(QtCore.Qt.Unchecked if (hidden_by_name.get(h, False)) else QtCore.Qt.Checked)
            self.list.addItem(it)
        v.addWidget(self.list)

        h = QtWidgets.QHBoxLayout()
        self.btn_up = QtWidgets.QPushButton("ÙÙˆÙ‚")
        self.btn_down = QtWidgets.QPushButton("ØªØ­Øª")
        self.btn_hide = QtWidgets.QPushButton("Ø¥Ø®ÙØ§Ø¡")
        self.btn_show = QtWidgets.QPushButton("Ø¥Ø¸Ù‡Ø§Ø±")
        h.addWidget(self.btn_up);
        h.addWidget(self.btn_down);
        h.addStretch(1);
        h.addWidget(self.btn_hide);
        h.addWidget(self.btn_show)
        v.addLayout(h)

        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel)
        v.addWidget(btns)

        self.btn_up.clicked.connect(self._move_up)
        self.btn_down.clicked.connect(self._move_down)
        self.btn_hide.clicked.connect(lambda: self._set_checked(False))
        self.btn_show.clicked.connect(lambda: self._set_checked(True))
        btns.accepted.connect(self.accept);
        btns.rejected.connect(self.reject)

    def _current_row(self):
        return self.list.currentRow()

    def _move_up(self):
        r = self._current_row()
        if r > 0:
            it = self.list.takeItem(r)
            self.list.insertItem(r - 1, it)
            self.list.setCurrentRow(r - 1)

    def _move_down(self):
        r = self._current_row()
        if 0 <= r < self.list.count() - 1:
            it = self.list.takeItem(r)
            self.list.insertItem(r + 1, it)
            self.list.setCurrentRow(r + 1)

    def _set_checked(self, show: bool):
        it = self.list.currentItem()
        if it:
            it.setCheckState(QtCore.Qt.Checked if show else QtCore.Qt.Unchecked)

    def result_config(self):
        order = []
        hidden_by_name = {}
        for i in range(self.list.count()):
            it = self.list.item(i)
            name = it.text()
            order.append(name)
            hidden_by_name[name] = (it.checkState() != QtCore.Qt.Checked)
        return order, hidden_by_name


class DateSettingsDialog(QtWidgets.QDialog):
    """Dialog to choose how dates are displayed in the table (format only)."""
    FORMATS = [
        ("D-MMM-YYYY", "16-Apr-2025"),
        ("DD/MM/YYYY", "16/04/2025"),
        ("YYYY-MM-DD", "2025-04-16"),
        ("MM/DD/YYYY", "04/16/2025"),
    ]

    def __init__(self, parent=None, current_key: str = "D-MMM-YYYY"):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®")
        self.setModal(True)
        lay = QtWidgets.QFormLayout(self)
        self.combo = QtWidgets.QComboBox(self)
        for key, sample in self.FORMATS:
            self.combo.addItem(f"{sample}  ({key})", key)
        # set current
        k2i = {self.combo.itemData(i): i for i in range(self.combo.count())}
        self.combo.setCurrentIndex(k2i.get(current_key, 0))
        lay.addRow("ØµÙŠØºØ© Ø§Ù„Ø¹Ø±Ø¶:", self.combo)
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel, self)
        lay.addRow(btns)
        btns.accepted.connect(self.accept)
        btns.rejected.connect(self.reject)

    def chosen_key(self):
        return self.combo.currentData()


def load_date_format_key():
    s = QtCore.QSettings("GuaranteesApp", "Main")
    key = s.value("date/format", type=str) or "D-MMM-YYYY"
    return key


def save_date_format_key(key: str):
    s = QtCore.QSettings("GuaranteesApp", "Main")
    s.setValue("date/format", key)


class WatermarkOverlay(QtWidgets.QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAttribute(QtCore.Qt.WA_TransparentForMouseEvents, True)
        self.setAttribute(QtCore.Qt.WA_NoSystemBackground, True)
        self._pm = None;
        self._opacity = 0.08;
        self._scale = 0.5;
        self._enabled = False

    def set_config(self, path=None, enabled=None, opacity=None, scale=None):
        if path is not None:
            pm = QtGui.QPixmap(path);
            self._pm = pm if (not pm.isNull()) else None
        if enabled is not None: self._enabled = bool(enabled)
        if opacity is not None: self._opacity = max(0.0, min(1.0, float(opacity)))
        if scale is not None: self._scale = max(0.1, min(1.5, float(scale)))
        self.update()

    def paintEvent(self, e):
        if not self._enabled or self._pm is None: return
        p = QtGui.QPainter(self);
        p.setOpacity(self._opacity)
        size = int(min(self.width(), self.height()) * self._scale)
        pm = self._pm.scaled(size, size, QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation)
        p.drawPixmap((self.width() - pm.width()) // 2, (self.height() - pm.height()) // 2, pm);
        p.end()


class WatermarkSettingsDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent);
        self.setWindowTitle("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©");
        self.setModal(True)
        lay = QtWidgets.QFormLayout(self);
        s = QtCore.QSettings("GuaranteesApp", "Main")
        # Watermark
        self.w_enabled = QtWidgets.QCheckBox("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©");
        self.w_enabled.setChecked(bool(int(s.value("watermark/enabled", 0) or 0)))
        self.w_path = QtWidgets.QLineEdit(s.value("watermark/path", type=str) or "");
        self.w_browse = QtWidgets.QPushButton("Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ùâ€¦")
        self.w_opacity = QtWidgets.QDoubleSpinBox();
        self.w_opacity.setRange(0.01, 1.0);
        self.w_opacity.setSingleStep(0.01);
        self.w_opacity.setValue(float(s.value("watermark/opacity", 0.08) or 0.08))
        self.w_scale = QtWidgets.QDoubleSpinBox();
        self.w_scale.setRange(0.1, 20.0);
        self.w_scale.setSingleStep(0.10);
        self.w_scale.setValue(float(s.value("watermark/scale", 0.40) or 0.40))
        w_h = QtWidgets.QHBoxLayout();
        w_h.addWidget(self.w_path);
        w_h.addWidget(self.w_browse)
        lay.addRow(self.w_enabled);
        lay.addRow("Ù…Ù„Ù Ø§Ù„Ø´Ø¹Ø§Ø± (PNG/SVG):", w_h);
        lay.addRow("Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©:", self.w_opacity);
        lay.addRow("Ø­Ø¬Ù… Ø§Ù„Ù†Ø³Ø¨ÙŠ:", self.w_scale)
        # Logo
        self.l_enabled = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±");
        self.l_enabled.setChecked(bool(int(s.value("logo/enabled", 1) or 1)))
        self.l_path = QtWidgets.QLineEdit(
            s.value("logo/path", type=str) or (s.value("watermark/path", type=str) or ""));
        self.l_browse = QtWidgets.QPushButton("Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ùâ€¦")
        self.l_height = QtWidgets.QSpinBox();
        self.l_height.setRange(16, 200);
        self.l_height.setValue(int(s.value("logo/height", 48) or 48))
        l_h = QtWidgets.QHBoxLayout();
        l_h.addWidget(self.l_path);
        l_h.addWidget(self.l_browse)
        lay.addRow(self.l_enabled);
        lay.addRow("Ù…Ù„Ù Ø§Ù„Ø´Ø¹Ø§Ø± (PNG/SVG):", l_h);
        lay.addRow("Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±Ø£Ø³ (Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„):", self.l_height)
        # App icon & banner
        self.app_icon_enabled = QtWidgets.QCheckBox("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø¹Ø§Ø± ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬");
        self.app_icon_enabled.setChecked(bool(int(s.value("logo/appIconEnabled", 1) or 1)))
        self.app_banner_enabled = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ)");
        self.app_banner_enabled.setChecked(bool(int(s.value("logo/appBannerEnabled", 1) or 1)))
        self.app_banner_h = QtWidgets.QSpinBox();
        self.app_banner_h.setRange(16, 96);
        self.app_banner_h.setValue(int(s.value("logo/appBannerHeight", 28) or 28))
        lay.addRow(self.app_icon_enabled)
        lay.addRow(self.app_banner_enabled)
        lay.addRow("Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ:", self.app_banner_h)
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel,
                                          parent=self);
        lay.addRow(btns)
        self.w_browse.clicked.connect(lambda: self._pick(self.w_path));
        self.l_browse.clicked.connect(lambda: self._pick(self.l_path))
        btns.accepted.connect(self.accept);
        btns.rejected.connect(self.reject)

    def _pick(self, line):
        path, _ = QtWidgets.QFileDialog.getOpenFileName(self, "Ø§Ø®ØªØ± ØµÙˆØ±Ø©", "",
                                                        "Images (*.png *.jpg *.jpeg *.bmp *.svg)")
        if path: line.setText(path)

    def result_values(self):
        return {"watermark/enabled": 1 if self.w_enabled.isChecked() else 0,
                "watermark/path": self.w_path.text().strip(),
                "watermark/opacity": float(self.w_opacity.value()),
                "watermark/scale": float(self.w_scale.value()),
                "logo/enabled": 1 if self.l_enabled.isChecked() else 0,
                "logo/path": self.l_path.text().strip(),
                "logo/height": int(self.l_height.value()),
                "logo/appIconEnabled": 1 if self.app_icon_enabled.isChecked() else 0,
                "logo/appBannerEnabled": 1 if self.app_banner_enabled.isChecked() else 0,
                "logo/appBannerHeight": int(self.app_banner_h.value())}


# =======================
# Print Preview (Advanced)
# =======================



# ====== Geometry Undo (Ctrl+Z) ======
def _capture_geometry_state(self):
    """Return a tuple (col_widths, row_heights)."""
    table = getattr(self, "table", None)
    if table is None:
        return ([], [])
    cols = [int(table.columnWidth(i)) for i in range(table.columnCount())]
    rows = [int(table.rowHeight(r)) for r in range(table.rowCount())]
    return (cols, rows)


def _apply_geometry_state(self, state):
    """Apply a state returned by _capture_geometry_state (best-effort)."""
    try:
        cols, rows = state
    except Exception:
        return
    table = getattr(self, "table", None)
    if table is None:
        return
    if cols:
        for i, w in enumerate(cols[:table.columnCount()]):
            try: table.setColumnWidth(i, int(w))
            except Exception: pass
    if rows:
        for r, h in enumerate(rows[:table.rowCount()]):
            try: table.setRowHeight(r, int(h))
            except Exception: pass


def _install_geometry_undo(self):
    """Prepare an undo stack for table geometry and connect signals + Ctrl+Z shortcut."""
    table = getattr(self, "table", None)
    if table is None:
        return
    # stack of states
    self._geom_undo_stack = getattr(self, "_geom_undo_stack", [])
    # push initial state
    try:
        self._geom_undo_stack.append(_capture_geometry_state(self))
    except Exception:
        pass

    # connect header resized signals
    try:
        table.horizontalHeader().sectionResized.connect(lambda *_: _on_geometry_changed(self))
    except Exception:
        pass
    try:
        table.verticalHeader().sectionResized.connect(lambda *_: _on_geometry_changed(self))
    except Exception:
        pass

    # Ctrl+Z shortcut
    try:
        sc = QtWidgets.QShortcut(QtGui.QKeySequence("Ctrl+Z"), self)
        sc.setContext(QtCore.Qt.ApplicationShortcut)
        sc.activated.connect(lambda: _undo_geometry(self))
        self._geom_undo_sc = sc
    except Exception:
        pass


def _on_geometry_changed(self):
    """Push a new geometry state when changed (debounced lightly)."""
    try:
        st = _capture_geometry_state(self)
        if not hasattr(self, "_geom_undo_stack"):
            self._geom_undo_stack = []
        # Avoid duplicates
        if not self._geom_undo_stack or self._geom_undo_stack[-1] != st:
            self._geom_undo_stack.append(st)
        # Save persistently as well
        save_table_geometry(self)
    except Exception:
        pass


def _undo_geometry(self):
    """Undo to previous geometry state (Ctrl+Z)."""
    try:
        stk = getattr(self, "_geom_undo_stack", [])
        if len(stk) >= 2:
            # drop current
            stk.pop()
            prev = stk[-1]
            _apply_geometry_state(self, prev)
            # after applying, save
            save_table_geometry(self)
            try:
                if hasattr(self, "statusBar") and self.statusBar():
                    self.statusBar().showMessage("ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ù‚Ø§Ø³Ø§Øª.", 2000)
            except Exception:
                pass
    except Exception:
        pass
class TableSizeDialog(QtWidgets.QDialog):
    """Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„ØµÙÙˆÙ (Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© + Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ)."""

    def __init__(self, parent):
        super().__init__(parent)
        self.parent = parent
        self.setWindowTitle("Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ")
        self.resize(520, 520)

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        try:
            by_name, by_index, heights = load_table_geometry(self.parent)
        except Exception:
            by_name, by_index, heights = {}, [], []

        root = QtWidgets.QVBoxLayout(self)

        # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¯Ø§Ø®Ù„ ScrollArea
        scroll = QtWidgets.QScrollArea(self);
        scroll.setWidgetResizable(True)
        cont = QtWidgets.QWidget(scroll);
        form = QtWidgets.QFormLayout(cont)
        self._spins = {}  # name -> QSpinBox
        for i in range(self.parent.table.columnCount()):
            try:
                name = self.parent.table.horizontalHeaderItem(i).text()
            except Exception:
                name = f"Ø¹Ù…ÙˆØ¯ {i + 1}"
            sp = QtWidgets.QSpinBox(cont);
            sp.setRange(40, 1600);
            sp.setSingleStep(5)
            # Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©: Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø«Ù… Ø§Ù„ÙÙ‡Ø±Ø³ Ø«Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
            val = None
            name_norm = _norm_col_name(name)
            if name_norm in by_name:
                val = int(by_name[name_norm])
            elif i < len(by_index):
                val = int(by_index[i])
            else:
                try:
                    val = int(self.parent.table.columnWidth(i))
                except Exception:
                    val = 120
            sp.setValue(max(40, int(val or 120)))
            form.addRow(name + ":", sp)
            self._spins[name] = sp

        scroll.setWidget(cont)
        root.addWidget(scroll, 1)

        # Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ
        row_box = QtWidgets.QGroupBox("Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ", self)
        row_lay = QtWidgets.QFormLayout(row_box)
        self.sp_row_h = QtWidgets.QSpinBox(self);
        self.sp_row_h.setRange(16, 600);
        self.sp_row_h.setSingleStep(2)
        # Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§: Ø£ÙˆÙ„ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø­ÙÙˆØ¸ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ø£ÙˆÙ„ ØµÙ
        rh = None
        if heights and len(heights) > 0:
            try:
                rh = int(heights[0])
            except Exception:
                rh = None
        if rh is None:
            try:
                rh = int(self.parent.table.rowHeight(0))
            except Exception:
                rh = 28
        self.sp_row_h.setValue(max(16, rh or 28))
        self.chk_apply_all = QtWidgets.QCheckBox("ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
        self.chk_apply_all.setChecked(True)
        row_lay.addRow("Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (px):", self.sp_row_h)
        row_lay.addRow(self.chk_apply_all)
        root.addWidget(row_box)

        # Ø£Ø²Ø±Ø§Ø±
        btns = QtWidgets.QDialogButtonBox(self)
        btn_apply = btns.addButton("ØªØ·Ø¨ÙŠÙ‚", QtWidgets.QDialogButtonBox.ApplyRole)
        btn_save = btns.addButton("Ø­ÙØ¸", QtWidgets.QDialogButtonBox.AcceptRole)
        btn_close = btns.addButton("Ø¥ØºÙ„Ø§Ù‚", QtWidgets.QDialogButtonBox.RejectRole)
        root.addWidget(btns)

        btn_apply.clicked.connect(self._apply_only)
        btn_save.clicked.connect(self._apply_and_save)
        btn_close.clicked.connect(self.reject)

    def _apply_only(self):
        """ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„ØµÙÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·."""
        try:
            # Ø£Ø¹Ù…Ø¯Ø©
            for i in range(self.parent.table.columnCount()):
                try:
                    name = self.parent.table.horizontalHeaderItem(i).text()
                    v = int(self._spins.get(name).value())
                    if v > 0:
                        self.parent.table.setColumnWidth(i, v)
                except Exception:
                    pass
            # ØµÙÙˆÙ
            h = int(self.sp_row_h.value())
            if h > 0 and self.chk_apply_all.isChecked():
                for r in range(self.parent.table.rowCount()):
                    try:
                        self.parent.table.setRowHeight(r, h)
                    except Exception:
                        pass
            # ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø­ÙØ¸ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            try:
                save_table_geometry(self.parent)
            except Exception:
                pass
            try:
                if hasattr(self.parent, "statusBar") and self.parent.statusBar():
                    self.parent.statusBar().showMessage("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª.", 2000)
            except Exception:
                pass
        except Exception as e:
            try:
                QtWidgets.QMessageBox.critical(self, "Ù…Ù‚Ø§Ø³Ø§Øª", f"ØªØ¹Ø°Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: {e}")
            except Exception:
                pass

    def _apply_and_save(self):
        """ØªØ·Ø¨ÙŠÙ‚ Ø«Ù… Ø­ÙØ¸ ÙÙŠ QSettings Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø¶Ø­."""
        self._apply_only()
        try:
            # Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØµØ±ÙŠØ­
            save_table_geometry(self.parent)
            # Ø¥Ø´Ø¹Ø§Ø±
            try:
                _status(self.parent, "ØªÙ… Ø­ÙØ¸ Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„ØµÙÙˆÙ.", 2000)
            except Exception:
                pass
            try:
                if hasattr(self.parent, "statusBar") and self.parent.statusBar():
                    self.parent.statusBar().showMessage("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª.", 3000)
            except Exception:
                pass
        except Exception as e:
            try:
                QtWidgets.QMessageBox.critical(self, "Ù…Ù‚Ø§Ø³Ø§Øª", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸: {e}")
            except Exception:
                pass


def show_size_settings(self):
    try:
        dlg = TableSizeDialog(self)
        dlg.exec_()
    except Exception as e:
        try:
            QtWidgets.QMessageBox.critical(self, "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", f"ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª: {e}")
        except Exception:
            pass


# ==========================
# Export: Visible Table -> Excel
# ==========================


def _safe_filename(name: str) -> str:
    try:
        s = (name or "").strip()
    except Exception:
        s = "report"
    if not s:
        s = "report"
    for ch in "\\/:*?\"<>|":
        s = s.replace(ch, "_")
    return s

def _default_excel_name(parent, fallback: str = "report") -> str:
    try:
        tabs = getattr(parent, "tabs", None)
        if tabs is not None:
            idx = tabs.currentIndex()
            page = tabs.tabText(idx)
        else:
            page = (getattr(parent, "windowTitle", lambda: "")() or "").strip() or fallback
    except Exception:
        page = fallback

    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªØµÙÙŠØ© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙÙ‚Ø·
    tab_name = "main"
    try:
        if tabs is not None:
            current_widget = tabs.currentWidget()
            if current_widget is getattr(parent, '_bank_detailed_tab_widget', None):
                tab_name = "bank_detailed"
            elif current_widget is getattr(parent, '_dept_report_tab_widget', None):
                tab_name = "dept_report"
            elif current_widget is getattr(parent, '_dept_matrix_tab_widget', None):
                tab_name = "dept_matrix"
            elif current_widget is getattr(parent, '_kpis_tab_widget', None):
                tab_name = "kpis"
            elif current_widget is getattr(parent, '_bank_limits_tab_widget', None):
                tab_name = "bank_limits"
    except Exception:
        pass

    vals = []
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Øª (attributes) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    target_attrs = []
    if tab_name == "main":
        target_attrs = ["cmb_bank", "cmb_dept", "cmb_status", "cmb_cash", "cmb_gtype"]
    elif tab_name == "bank_detailed":
        target_attrs = ["bank_detailed_filter"]
    elif tab_name == "dept_report":
        target_attrs = ["dept_report_bank_filter", "dept_report_dept_filter"]
    elif tab_name == "dept_matrix":
        target_attrs = ["dept_matrix_bank_filter"]
    elif tab_name == "kpis":
        target_attrs = ["kpi_bank_filter"]

    for attr in target_attrs:
        try:
            w = getattr(parent, attr, None)
            if w and hasattr(w, "currentText"):
                t = (w.currentText() or "").strip()
                if t and t != "Ø§Ù„ÙƒÙ„" and (t not in vals):
                    vals.append(t)
        except Exception:
            pass

    base = _safe_filename(page)
    if vals:
        base = base + "_" + _safe_filename("_".join(vals))
    return base + ".xlsx"

def export_table_to_excel(parent, table=None):
    """
    ØªÙˆØ­ÙŠØ¯ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙƒØ³Ù„: ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§ØªØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©ØŒ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙØŒ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù…).
    """
    try:
        dlg = PrintPreviewDialog(parent, table_override=table)
        dlg._export_excel_from_preview()
    except Exception:
        try:
            QtWidgets.QMessageBox.critical(parent, "ØªØµØ¯ÙŠØ±", "ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° ØªØµØ¯ÙŠØ± Excel Ø¹Ø¨Ø± Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.")
        except Exception:
            pass
        return
class ToolbarButtonsDialog(QtWidgets.QDialog):
    """Ù†Ø§ÙØ°Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„Ù†Øµ ÙÙ‚Ø· (Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±/Ù…Ù†ØªÙ‡ÙŠ/Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„)."""
    LABELS = ["Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„", "ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„", "ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„", "Ù…Ù†ØªÙ‡ÙŠ", "Ø¥Ø¶Ø§ÙØ© Ø¶Ù…Ø§Ù†", "ØªØ¹Ø¯ÙŠÙ„ Ø¶Ù…Ø§Ù†", "Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"]

    def __init__(self, parent):
        super().__init__(parent)
        self.setWindowTitle("Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ")
        self.resize(380, 340)
        v = QtWidgets.QVBoxLayout(self)

        self.list = QtWidgets.QListWidget(self)
        self.list.setSelectionMode(QtWidgets.QAbstractItemView.NoSelection)
        v.addWidget(self.list)

        s = QtCore.QSettings("GuaranteesApp", "Main")
        import json as _json
        try:
            hidden = _json.loads(s.value("toolbar/hidden_by_text", type=str) or "{}")
        except Exception:
            hidden = {}

        present = []
        for tb in parent.findChildren(QtWidgets.QToolBar):
            for act in tb.actions():
                txt = (act.text() or "").strip()
                if txt in self.LABELS and txt not in present:
                    present.append(txt)
            for btn in tb.findChildren(QtWidgets.QToolButton):
                txt = (btn.text() or "").strip()
                if txt in self.LABELS and txt not in present:
                    present.append(txt)
            # Also search for QPushButton embedded via QWidgetAction
            for pbtn in tb.findChildren(QtWidgets.QPushButton):
                txt = (pbtn.text() or "").strip()
                if txt in self.LABELS and txt not in present:
                    present.append(txt)

        for label in present:
            it = QtWidgets.QListWidgetItem(label, self.list)
            it.setFlags(it.flags() | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
            it.setCheckState(QtCore.Qt.Checked if not bool(hidden.get(label, False)) else QtCore.Qt.Unchecked)
            it.setData(QtCore.Qt.UserRole, label)

        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel, self)
        v.addWidget(btns)
        btns.accepted.connect(self.accept);
        btns.rejected.connect(self.reject)

    def result_hidden_map(self):
        res = {}
        for i in range(self.list.count()):
            it = self.list.item(i)
            res[it.data(QtCore.Qt.UserRole)] = (it.checkState() != QtCore.Qt.Checked)
        return res


def apply_toolbar_visibility(self):
    """ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ."""
    try:
        labels = set(["Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„", "ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„", "ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„", "Ù…Ù†ØªÙ‡ÙŠ", "Ø¥Ø¶Ø§ÙØ© Ø¶Ù…Ø§Ù†", "ØªØ¹Ø¯ÙŠÙ„ Ø¶Ù…Ø§Ù†", "Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"])
        s = QtCore.QSettings("GuaranteesApp", "Main")
        import json as _json
        try:
            hidden = _json.loads(s.value("toolbar/hidden_by_text", type=str) or "{}")
        except Exception:
            hidden = {}
        for tb in self.findChildren(QtWidgets.QToolBar):
            for act in tb.actions():
                try:
                    t = (act.text() or "").strip()
                    if t in labels:
                        act.setVisible(not bool(hidden.get(t, False)))
                except Exception:
                    pass
            for btn in tb.findChildren(QtWidgets.QToolButton):
                try:
                    t = (btn.text() or "").strip()
                    if t in labels:
                        btn.setVisible(not bool(hidden.get(t, False)))
                except Exception:
                    pass
            # Also handle QPushButton embedded via QWidgetAction
            for pbtn in tb.findChildren(QtWidgets.QPushButton):
                try:
                    t = (pbtn.text() or "").strip()
                    if t in labels:
                        pbtn.setVisible(not bool(hidden.get(t, False)))
                except Exception:
                    pass
    except Exception:
        pass


def show_toolbar_buttons_settings(self):
    try:
        dlg = ToolbarButtonsDialog(self)
        if dlg.exec_() == QtWidgets.QDialog.Accepted:
            hidden = dlg.result_hidden_map()
            s = QtCore.QSettings("GuaranteesApp", "Main")
            import json as _json
            try:
                s.setValue("toolbar/hidden_by_text", _json.dumps(hidden, ensure_ascii=False))
            except Exception:
                s.setValue("toolbar/hidden_by_text", str(hidden))
            apply_toolbar_visibility(self)
    except Exception as e:
        try:
            QtWidgets.QMessageBox.critical(self, "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", f"ØªØ¹Ø°Ø± ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ·: {e}")
        except Exception:
            pass


class QuickSettingsDialog(QtWidgets.QDialog):
    """Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ© Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€” ØªØ®Ø·ÙŠØ· Ø´Ø¨ÙƒÙŠ (Ø¹Ù…ÙˆØ¯Ø§Ù†) Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠØ±."""

    def __init__(self, parent):
        super().__init__(parent)
        self.setWindowTitle("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€” ÙˆØ¶Ø¹ Ø®ÙÙŠÙ")
        # Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø¨ÙƒÙŠ + Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
        self.resize(560, 360)
        self.setSizeGripEnabled(True)

        root = QtWidgets.QVBoxLayout(self)

        # === Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===
        btn_date = QtWidgets.QPushButton("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®â€¦")
        btn_font = QtWidgets.QPushButton("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·â€¦")
        btn_cols = QtWidgets.QPushButton("ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©â€¦")
        btn_brand = QtWidgets.QPushButton("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø±/Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©â€¦")
        btn_import = QtWidgets.QPushButton("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„â€¦")
        btn_sizes = QtWidgets.QPushButton("Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙâ€¦")
        btn_export = QtWidgets.QPushButton("ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„â€¦");
        btn_toolbar = QtWidgets.QPushButton("Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠâ€¦")
        btn_backup = QtWidgets.QPushButton("Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©â€¦")
        btn_backup.setToolTip("Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
        btn_restore = QtWidgets.QPushButton("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©â€¦")
        btn_restore.setToolTip("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©")
        btn_save = QtWidgets.QPushButton("Ø­ÙØ¸ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¢Ù† (Ctrl+S)")
        btn_save.setToolTip("ÙŠØ­ÙØ¸ ØªØ±ØªÙŠØ¨/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© + Ø§Ù„Ø®Ø·ÙˆØ· + Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©")

        # ØªÙˆØµÙŠÙ„Ø§Øª (Ù…Ø­Ø§Ø·Ø© Ø¨Ù€ try Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø·Ù„ Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± Ø§Ù„Ø¯ÙˆØ§Ù„)
        try:
            btn_date.clicked.connect(parent.show_date_settings)
        except Exception:
            pass
        try:
            btn_font.clicked.connect(parent.show_font_settings)
        except Exception:
            pass
        try:
            btn_cols.clicked.connect(parent.show_column_settings)
        except Exception:
            pass
        try:
            btn_brand.clicked.connect(parent.show_brand_settings)
        except Exception:
            pass
        try:
            if hasattr(parent, "show_import_excel"):
                btn_import.clicked.connect(parent.show_import_excel)
            else:
                btn_import.clicked.connect(parent.do_import)
        except Exception:
            pass
        try:
            btn_sizes.clicked.connect(parent.show_size_settings)
        except Exception:
            pass
        try:
            btn_save.clicked.connect(getattr(parent, "save_all_settings", lambda: None))
        except Exception:
            pass
        try:
            btn_export.clicked.connect(lambda: export_table_to_excel(parent))
        except Exception:
            pass
        try:
            btn_toolbar.clicked.connect(lambda: show_toolbar_buttons_settings(parent))
        except Exception:
            pass
        try:
            def _create_backup():
                backup_path = create_backup()
                if backup_path:
                    QtWidgets.QMessageBox.information(parent, "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", 
                        f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ù…Ø³Ø§Ø±: {backup_path}\n\nØ§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù…Ø¬Ù„Ø¯ data/backup/")
                else:
                    QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.")
            btn_backup.clicked.connect(_create_backup)
        except Exception:
            pass
        try:
            def _restore_backup():
                reply = QtWidgets.QMessageBox.question(parent, "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", 
                    "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ\n\nØ³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.\nØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.",
                    QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No)
                if reply == QtWidgets.QMessageBox.Yes:
                    # Create backup of current data first
                    create_backup()
                    if restore_backup():
                        QtWidgets.QMessageBox.information(parent, "Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", 
                            "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.")
                    else:
                        QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.")
            btn_restore.clicked.connect(_restore_backup)
        except Exception:
            pass

        buttons = [btn_date, btn_font, btn_cols, btn_brand, btn_import, btn_sizes, btn_export, btn_toolbar, btn_backup, btn_restore, btn_save]

        # === ØªØ®Ø·ÙŠØ· Ø´Ø¨ÙƒÙŠ 2 Ø£Ø¹Ù…Ø¯Ø© ===
        grid = QtWidgets.QGridLayout()
        grid.setHorizontalSpacing(10)
        grid.setVerticalSpacing(10)

        # Ù†Ù…Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±: Ø§Ø±ØªÙØ§Ø¹ Ù…Ø±ÙŠØ­ + ØªÙ…Ø¯Ø¯ Ø£ÙÙ‚ÙŠ
        for b in buttons:
            b.setMinimumHeight(38)
            b.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Fixed)

        cols = 2
        r = c = 0
        for b in buttons:
            grid.addWidget(b, r, c)
            c += 1
            if c >= cols:
                c = 0
                r += 1

        # Ù„Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ ÙØ±Ø¯ÙŠ Ù†Ø¶ÙŠÙ Stretch Ù„Ù…Ù„Ø¡ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„
        if len(buttons) % cols == 1:
            spacer = QtWidgets.QWidget()
            spacer.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Fixed)
            grid.addWidget(spacer, r, 1)

        root.addLayout(grid, 1)

        # Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø£Ø³ÙÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Close, self)
        btns.rejected.connect(self.reject)
        btns.button(QtWidgets.QDialogButtonBox.Close).clicked.connect(self.close)
        root.addWidget(btns)


def quick_show_settings_dialog(self):
    try:
        dlg = QuickSettingsDialog(self)
        dlg.exec_()
    except Exception as e:
        try:
            QtWidgets.QMessageBox.critical(self, "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", f"ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {e}")
        except Exception:
            pass


class PrintPreviewDialog(QtWidgets.QDialog):
    """
    Ù…Ø±ÙƒØ² Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ø®ØµØ§Ø¦Øµ:
    - Ø­Ø¬Ù…/Ø§ØªØ¬Ø§Ù‡/Ù‡ÙˆØ§Ù…Ø´
    - ØªØ­Ø¬ÙŠÙ… (Ù…Ù„Ø§Ø¡Ù…Ø© Ø¹Ø±Ø¶/ØµÙØ­Ø©/Ù†Ø³Ø¨Ø©)
    - Ø±Ø£Ø³/ØªØ°ÙŠÙŠÙ„ Ø¨Ù†ØµÙˆØµ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ({date}ØŒ {page}ØŒ {pages}ØŒ {title}ØŒ {dept})
    - ØªÙƒØ±Ø§Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©
    - Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ù„ÙÙŠØ§ØªØŒ Ø³Ù…Ø§ÙƒØ© Ø§Ù„Ø­Ø¯ÙˆØ¯ØŒ ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø®Ø· Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§
    - Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙÙŠ Ø¢Ø®Ø± Ø§Ù„ØµÙØ­Ø©/Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø£Ø¹Ù…Ø¯Ø© Ø±Ù‚Ù…ÙŠØ© Ù…Ø®ØªØ§Ø±Ø©
    - Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø¨Ø± QSettings
    """

    def __init__(self, parent, table_override=None):
        super().__init__(parent)
        # Ø§Ø¶Ø¨Ø· Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø´ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ:
        # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„ØŒ Ø£Ø¶Ù Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ Ù„Ù„Ø¹Ù†ÙˆØ§Ù†
        try:
            if getattr(parent, 'tabs', None) and getattr(parent, '_bank_detailed_tab_widget', None) \
               and parent.tabs.currentWidget() is parent._bank_detailed_tab_widget:
                sel_bank = None
                try:
                    bf = getattr(parent, 'bank_detailed_filter', None)
                    if bf is not None and bf.count() > 0:
                        sel_bank = (bf.currentText() or '').strip()
                except Exception:
                    sel_bank = None
                if sel_bank:
                    self.setWindowTitle(f"Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ø¨Ù†Ùƒ: {sel_bank}")
                else:
                    self.setWindowTitle("Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ø¨Ù†Ùƒ: ØºÙŠØ± Ù…Ø­Ø¯Ø¯")
            elif getattr(parent, 'tabs', None) and getattr(parent, '_bank_limits_tab_widget', None) \
                 and parent.tabs.currentWidget() is parent._bank_limits_tab_widget:
                self.setWindowTitle("Ù…Ø¹Ø§ÙŠÙ†Ø© Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ")
            else:
                self.setWindowTitle("Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
        except Exception:
            # ÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ø£ÙŠ Ø®Ø·Ø£ØŒ Ø§Ø±Ø¬Ø¹ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            self.setWindowTitle("Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
        self.resize(1180, 760)
        self.parent = parent
        # Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©ØŒ Ù†Ø³Ù…Ø­ Ø¨ØªÙ…Ø±ÙŠØ± Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©)
        self._table_override = table_override
        # ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¹ Ù†Ù…Ø· Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: Ø§ØªØ¬Ø§Ù‡ RTL ÙˆØ®Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        try:
            self.setLayoutDirection(QtCore.Qt.RightToLeft)
        except Exception:
            pass
        try:
            if hasattr(self.parent, "load_font_settings"):
                cfg = self.parent.load_font_settings()
                self.setFont(QtGui.QFont(cfg["appFamily"], int(cfg["appSize"])) )
        except Exception:
            pass

        # Printer + preview widget
        self.printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
        self.printer.setPageSize(QtPrintSupport.QPrinter.A4)
        # Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£ÙÙ‚ÙŠ
        self.printer.setOrientation(QtPrintSupport.QPrinter.Landscape)
        self.preview = QtPrintSupport.QPrintPreviewWidget(self.printer, self)
        # Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        self._current_preview_page = 1
        # Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø§Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø¡Ù…Ø© Ù„Ù„Ø¹Ø±Ø¶ØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Zoom Ù…Ø®ØµØµ
        try:
            self.preview.setZoomMode(QtPrintSupport.QPrintPreviewWidget.FitToWidth)
        except Exception:
            pass
        
        # ØªØ«Ø¨ÙŠØª event filter Ø¹Ù„Ù‰ preview widget Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±
        try:
            self.preview.installEventFilter(self)
            self.preview.viewport().installEventFilter(self)
        except Exception:
            pass

        # ========= Side controls =========
        side = QtWidgets.QTabWidget()
        # --- Tab: Page ---
        pg_page = QtWidgets.QWidget();
        v_page = QtWidgets.QVBoxLayout(pg_page)
        f1 = QtWidgets.QFormLayout()
        # ØªØ­Ø³ÙŠÙ† Ù…Ø­Ø§Ø°Ø§Ø© ÙˆÙ…Ø³ÙˆÙ‘Ø­Ø§Øª ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØµÙØ­Ø© Ù„ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ†
        try:
            f1.setContentsMargins(0, 0, 0, 0)
            f1.setFormAlignment(QtCore.Qt.AlignRight)
            f1.setLabelAlignment(QtCore.Qt.AlignRight)
            f1.setFieldGrowthPolicy(QtWidgets.QFormLayout.AllNonFixedFieldsGrow)
            v_page.setContentsMargins(0, 0, 0, 0)
            v_page.setSpacing(8)
        except Exception:
            pass
        self.cmb_size = QtWidgets.QComboBox()
        for name, val in [("A4", QtPrintSupport.QPrinter.A4),
                          ("A3", QtPrintSupport.QPrinter.A3),
                          ("Letter", QtPrintSupport.QPrinter.Letter)]:
            self.cmb_size.addItem(name, val)
        self.cmb_orient = QtWidgets.QComboBox()
        self.cmb_orient.addItem("Ø¹Ù…ÙˆØ¯ÙŠ", QtPrintSupport.QPrinter.Portrait)
        self.cmb_orient.addItem("Ø£ÙÙ‚ÙŠ", QtPrintSupport.QPrinter.Landscape)
        # Ø§Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ø¥Ù„Ù‰ Ø£ÙÙ‚ÙŠ
        try:
            self.cmb_orient.setCurrentIndex(1)
        except Exception:
            pass
        self.cmb_color_mode = QtWidgets.QComboBox()
        try:
            self.cmb_color_mode.addItems(["Ø£Ù„ÙˆØ§Ù†", "Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯"])
            self.cmb_color_mode.setCurrentIndex(1)
        except Exception:
            pass
        self.cmb_scale_mode = QtWidgets.QComboBox();
        # Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (0: Ø¹Ø±Ø¶ØŒ 1: ØµÙØ­Ø©ØŒ 2: Ù†Ø³Ø¨Ø©)
        # ÙˆÙ†Ø¶ÙŠÙ "Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙÙˆÙ" Ùˆ"Ø¨Ù„Ø§ ØªØ­Ø¬ÙŠÙ…" ÙƒØ®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        self.cmb_scale_mode.addItems(["Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶", "Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙØ­Ø©", "Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©",
                                      "Ù…Ù„Ø§Ø¡Ù…Ø© ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©", "Ø¨Ù„Ø§ ØªØ­Ø¬ÙŠÙ…"])
        # Ø§Ø¬Ø¹Ù„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ "Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©" (70%) Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        try:
            self.cmb_scale_mode.setCurrentIndex(2)
        except Exception:
            pass
        self.sp_scale = QtWidgets.QSpinBox();
        self.sp_scale.setRange(10, 2000);
        self.sp_scale.setValue(70)
        self.sp_font_scale = QtWidgets.QSpinBox();
        self.sp_font_scale.setRange(50, 200);
        self.sp_font_scale.setValue(100)
        self.sp_table_spacing = QtWidgets.QDoubleSpinBox();
        self.sp_table_spacing.setRange(0.0, 500.0);
        self.sp_table_spacing.setSingleStep(5.0);
        self.sp_table_spacing.setValue(20.0);
        self.sp_table_spacing.setSuffix(" pt")
        self.sp_border = QtWidgets.QDoubleSpinBox();
        self.sp_border.setSuffix(" pt");
        self.sp_border.setRange(0, 3);
        self.sp_border.setSingleStep(0.25);
        self.sp_border.setValue(0.5)
        # Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        self.sp_from_page = QtWidgets.QSpinBox();
        self.sp_from_page.setRange(1, 9999);
        self.sp_from_page.setValue(1)
        self.sp_to_page = QtWidgets.QSpinBox();
        self.sp_to_page.setRange(1, 9999);
        self.sp_to_page.setValue(9999)
        # Ø®ÙŠØ§Ø±: Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
        self.chk_current_page = QtWidgets.QCheckBox("Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·")
        self.cmb_style = QtWidgets.QComboBox();
        self.cmb_style.addItems(["ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ Ø£Ø¨ÙŠØ¶", "Ø±Ø£Ø³ Ø£Ø¨ÙŠØ¶", "Ø´Ø±ÙŠØ·ÙŠ", "Ù…ÙƒØ«Ù‘Ù"])  # Ø´ÙƒÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        try:
            self.cmb_style.setCurrentIndex(2)
        except Exception:
            pass
        self.chk_print_bg = QtWidgets.QCheckBox("Ø·Ø¨Ø§Ø¹Ø© Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø®Ù„Ø§ÙŠØ§")
        self.chk_white_text = QtWidgets.QCheckBox("Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ø¨ÙŠØ¶")
        self.chk_repeat_header = QtWidgets.QCheckBox("ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©");
        self.chk_repeat_header.setChecked(True)
        # Ø£Ø¶Ù Ø­Ù‚ÙˆÙ„ Ù…Ù†/Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ø±Ù† ÙŠØ³ØªØ¬ÙŠØ¨ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
        try:
            self.sp_from_page.setMinimumWidth(80)
            self.sp_to_page.setMinimumWidth(80)
            pol = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Fixed)
            self.sp_from_page.setSizePolicy(pol)
            self.sp_to_page.setSizePolicy(pol)
        except Exception:
            pass
        # ØµÙ Ø±Ø£Ø³ Ø§Ù„ØªØ¨ÙˆÙŠØ¨: Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª + Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰
        row_pages = QtWidgets.QHBoxLayout();
        row_pages.setSpacing(10)
        try:
            row_pages.setContentsMargins(0, 0, 0, 0)
            # Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙŠÙ…ÙŠÙ†-Ø¥Ù„Ù‰-ÙŠØ³Ø§Ø± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆÙŠØ¶Ø¹ Ø§Ù„Ø²Ø± ÙŠÙ…ÙŠÙ†Ù‹Ø§
            row_pages.setLayoutDirection(QtCore.Qt.RightToLeft)
        except Exception:
            pass
        # Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ù…Ø±Ø¨Ø¹ ÙˆÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰
        self.btn_inline_print = QtWidgets.QPushButton("ğŸ–¨")
        
        # Ø®Ø§Ù†Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®
        self.sp_copies = QtWidgets.QSpinBox()
        self.sp_copies.setRange(1, 100)
        self.sp_copies.setValue(1)
        self.sp_copies.setToolTip("Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®")
        # Ù†ÙØ³ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø­Ø¬Ù… Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ (70px)
        self.sp_copies.setFixedWidth(70)

        try:
            self.btn_inline_print.setToolTip("Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
            # Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ø­Ø¬Ù… Ù„ÙŠÙƒÙˆÙ† Ø£ÙˆØ¶Ø­: 96x96
            self.btn_inline_print.setFixedSize(96, 96)
            self.btn_inline_print.setCursor(QtGui.QCursor(QtCore.Qt.PointingHandCursor))
            self.btn_inline_print.setStyleSheet(
                """
                QPushButton {
                    background-color: #2b8a84;
                    color: #ffffff;
                    border: 1px solid #1f6f69;
                    border-radius: 10px;
                    font-size: 26px;
                    font-weight: bold;
                }
                QPushButton:hover { background-color: #339e97; }
                QPushButton:pressed { background-color: #237a74; }
                """
            )
            self.btn_inline_print.clicked.connect(self._print)
        except Exception:
            pass
        # ØªØ£ÙƒÙŠØ¯ Ù…Ø­Ø§Ø°Ø§ØªÙ‡ Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ ØµÙ Ø§Ù„Ø±Ø£Ø³
        row_pages.addWidget(self.btn_inline_print)
        try:
            row_pages.setAlignment(self.btn_inline_print, QtCore.Qt.AlignRight | QtCore.Qt.AlignTop)
        except Exception:
            pass
            
        row_pages.addSpacing(10)
        
        # Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª (Ù…Ù†/Ø¥Ù„Ù‰) Ø¨Ø´ÙƒÙ„ Ø¹Ù…ÙˆØ¯ÙŠ Ø¨Ø¬Ø§Ù†Ø¨ Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        wid_ranges = QtWidgets.QWidget()
        wid_ranges.setLayoutDirection(QtCore.Qt.RightToLeft)
        col_ranges = QtWidgets.QFormLayout(wid_ranges)
        col_ranges.setContentsMargins(0, 0, 0, 0)
        col_ranges.setSpacing(4)
        col_ranges.setLabelAlignment(QtCore.Qt.AlignRight)
        col_ranges.setFormAlignment(QtCore.Qt.AlignRight)
        
        # Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ
        self.sp_from_page.setFixedWidth(70)
        self.sp_to_page.setFixedWidth(70)
        
        col_ranges.addRow("Ù…Ù† ØµÙØ­Ø©:", self.sp_from_page)
        col_ranges.addRow("Ø¥Ù„Ù‰ ØµÙØ­Ø©:", self.sp_to_page)
        # Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ù‡Ù†Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø®Ø·
        col_ranges.addRow("Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®:", self.sp_copies)
        
        row_pages.addWidget(wid_ranges)

        # ÙØ§ØµÙ„ Ù…Ø±Ù† Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        row_pages.addStretch(1)
        # Ø£Ø¶Ù Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø£Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ù‚ÙˆÙ„
        v_page.addLayout(row_pages)
        f1.addRow("", self.chk_current_page)
        self.chk_snapshot = QtWidgets.QCheckBox("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø­Ù„ ÙÙˆØ±ÙŠ)")
        self.chk_direct_print = QtWidgets.QCheckBox("Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¸Ø§Ù…)")
        # ØªÙØ¹ÙŠÙ„ Ø¯Ø§Ø¦Ù… Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ùˆ ØªØ¹Ø·ÙŠÙ„ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        try:
            self.chk_direct_print.setChecked(True)
            self.chk_direct_print.setEnabled(False)
        except Exception:
            pass
        # Ø§Ø¬Ø¹Ù„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø¯Ø¯ Ø£ÙÙ‚ÙŠÙ‹Ø§ Ù„ØªØªÙØ§Ø¹Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶
        try:
            _exp_pol = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Fixed)
            for w in [self.cmb_size, self.cmb_orient, self.cmb_scale_mode, self.sp_scale,
                      self.sp_font_scale, self.sp_border, self.cmb_style,
                      self.chk_print_bg, self.chk_white_text, self.chk_repeat_header,
                      self.chk_snapshot, self.chk_direct_print, self.sp_from_page, self.sp_to_page, self.sp_copies]:
                try:
                    w.setSizePolicy(_exp_pol)
                except Exception:
                    pass
        except Exception:
            pass
        # Ø£Ù‚Ø³Ø§Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ²Ø§Ø­Ù…: Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ØŒ Ø§Ù„ØªØ­Ø¬ÙŠÙ…ØŒ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        def make_section(title, rows):
            wrap = QtWidgets.QWidget()
            lay = QtWidgets.QVBoxLayout(wrap)
            lay.setContentsMargins(0, 0, 0, 0)
            lay.setSpacing(6)

            btn = QtWidgets.QToolButton()
            btn.setText(title)
            btn.setToolButtonStyle(QtCore.Qt.ToolButtonTextBesideIcon)
            btn.setArrowType(QtCore.Qt.RightArrow)
            btn.setCheckable(True)
            btn.setChecked(False)

            cont = QtWidgets.QWidget()
            fl = QtWidgets.QFormLayout(cont)
            fl.setContentsMargins(8, 8, 8, 8)
            fl.setSpacing(8)

            for lbl, w in rows:
                if lbl:
                    fl.addRow(lbl, w)
                else:
                    fl.addRow(w)

            def _toggle(on):
                cont.setVisible(on)
                btn.setArrowType(QtCore.Qt.DownArrow if on else QtCore.Qt.RightArrow)

            btn.toggled.connect(_toggle)
            lay.addWidget(btn)
            lay.addWidget(cont)
            cont.setVisible(False)
            wrap.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Maximum)
            return wrap

        # ØªØµÙ…ÙŠÙ… Ø«Ø§Ø¨Øª (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ) Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        def make_fixed_section(title, rows):
            wrap2 = QtWidgets.QWidget()
            lay2 = QtWidgets.QVBoxLayout(wrap2)
            lay2.setContentsMargins(0, 0, 0, 0)
            lay2.setSpacing(4)

            lbl_title = QtWidgets.QLabel(title)
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„ÙŠÙƒÙˆÙ† Ø¨Ø§Ø±Ø²Ø§Ù‹
            lbl_title.setStyleSheet("font-weight: bold; color: #1f6f69; font-size: 14px; margin-bottom: 2px;")
            
            cont2 = QtWidgets.QFrame()
            cont2.setFrameShape(QtWidgets.QFrame.StyledPanel)
            cont2.setFrameShadow(QtWidgets.QFrame.Raised)
            grid = QtWidgets.QGridLayout(cont2)
            grid.setContentsMargins(8, 8, 8, 8)
            grid.setHorizontalSpacing(10)
            grid.setVerticalSpacing(6)

            def add_row(r, lbl, w):
                if lbl:
                    lab = QtWidgets.QLabel(lbl)
                    lab.setAlignment(QtCore.Qt.AlignRight | QtCore.Qt.AlignVCenter)
                    grid.addWidget(lab, r, 0)
                    grid.addWidget(w, r, 1)
                else:
                    grid.addWidget(w, r, 0, 1, 2)

            for i, (lbl, w) in enumerate(rows):
                add_row(i, lbl, w)
            grid.setColumnStretch(0, 1); grid.setColumnStretch(1, 3)

            lay2.addWidget(lbl_title)
            lay2.addWidget(cont2)
            wrap2.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Maximum)
            return wrap2

        # ØªØµÙ…ÙŠÙ… Ø¨Ø¯ÙŠÙ„ Ø¨Ø´ÙƒÙ„ Ø£Ù‚Ø±Ø¨ Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥ÙƒØ³Ù„ (Ø´Ø¨ÙƒÙŠ ÙˆÙ…Ø¶ØºÙˆØ·)
        def make_excel_section(title, rows):
            wrap2 = QtWidgets.QWidget()
            lay2 = QtWidgets.QVBoxLayout(wrap2)
            lay2.setContentsMargins(0, 0, 0, 0)
            lay2.setSpacing(6)

            btn2 = QtWidgets.QToolButton()
            btn2.setText(title)
            btn2.setToolButtonStyle(QtCore.Qt.ToolButtonTextBesideIcon)
            btn2.setArrowType(QtCore.Qt.RightArrow)
            btn2.setCheckable(True)
            btn2.setChecked(False)

            cont2 = QtWidgets.QFrame()
            cont2.setFrameShape(QtWidgets.QFrame.StyledPanel)
            cont2.setFrameShadow(QtWidgets.QFrame.Raised)
            grid = QtWidgets.QGridLayout(cont2)
            grid.setContentsMargins(8, 8, 8, 8)
            grid.setHorizontalSpacing(10)
            grid.setVerticalSpacing(6)

            def add_row(r, lbl, w):
                if lbl:
                    lab = QtWidgets.QLabel(lbl)
                    lab.setAlignment(QtCore.Qt.AlignRight | QtCore.Qt.AlignVCenter)
                    grid.addWidget(lab, r, 0)
                    grid.addWidget(w, r, 1)
                else:
                    grid.addWidget(w, r, 0, 1, 2)

            for i, (lbl, w) in enumerate(rows):
                add_row(i, lbl, w)
            grid.setColumnStretch(0, 1); grid.setColumnStretch(1, 3)

            def _toggle2(on):
                cont2.setVisible(on)
                btn2.setArrowType(QtCore.Qt.DownArrow if on else QtCore.Qt.RightArrow)

            btn2.toggled.connect(_toggle2)
            lay2.addWidget(btn2)
            lay2.addWidget(cont2)
            # Ø§Ø¬Ø¹Ù„ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ù…ÙØªÙˆØ­Ø§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙˆØ¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if title == "Ø§Ù„ØªØ­Ø¬ÙŠÙ…":
                cont2.setVisible(True)
                btn2.setArrowType(QtCore.Qt.DownArrow)
                btn2.setChecked(True)
            else:
                cont2.setVisible(False)
            wrap2.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Maximum)
            return wrap2

        sec_scale = make_fixed_section("Ø§Ù„ØªØ­Ø¬ÙŠÙ…", [
            ("Ø§Ù„ØªØ­Ø¬ÙŠÙ…:", self.cmb_scale_mode), ("Ø§Ù„Ù†Ø³Ø¨Ø© %:", self.sp_scale), ("ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø®Ø· %:", self.sp_font_scale),
            ("ÙØ§Ø±Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ†:", self.sp_table_spacing)
        ])
        sec_style = make_excel_section("Ø§Ù„ØªÙ†Ø³ÙŠÙ‚", [
            ("Ø´ÙƒÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:", self.cmb_style), ("Ø³Ù…Ùƒ Ø§Ù„Ø­Ø¯ÙˆØ¯:", self.sp_border),
            ("Ø§Ù„Ø®Ù„ÙÙŠØ§Øª:", self.chk_print_bg), ("Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ø¨ÙŠØ¶:", self.chk_white_text), ("", self.chk_repeat_header)
        ])

        # Ø£Ù‚Ø³Ø§Ù… Ù…Ø±ØªØ¨Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥ÙƒØ³Ù„
        sec_page = make_fixed_section("Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©", [
            ("Ø­Ø¬Ù… Ø§Ù„ÙˆØ±Ù‚:", self.cmb_size), ("Ø§Ù„Ø§ØªØ¬Ø§Ù‡:", self.cmb_orient), ("ÙˆØ¶Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:", self.cmb_color_mode)
        ])
        sec_print_opts = make_excel_section("Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©", [
            ("", self.chk_snapshot), ("", self.chk_direct_print)
        ])
        v_page.addWidget(sec_scale)
        # ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (sec_style) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ ØªØ«Ø¨ÙŠØª Ù‚ÙŠÙ…Ù‡
        sec_style.setVisible(False)
        v_page.addWidget(sec_style)
        v_page.addWidget(sec_page)
        # ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (sec_print_opts) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ ØªØ«Ø¨ÙŠØª Ù‚ÙŠÙ…Ù‡Ø§
        sec_print_opts.setVisible(False)
        v_page.addWidget(sec_print_opts)
        # Ø£Ø¶Ù Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©
        v_page.addLayout(f1)
        side.addTab(pg_page, "Ø§Ù„ØµÙØ­Ø©")

        # --- Tab: Header/Footer ---
        self.pg_hf = QtWidgets.QWidget();
        v_hf = QtWidgets.QVBoxLayout(self.pg_hf)
        v_hf.setContentsMargins(0, 0, 0, 0)
        v_hf.setSpacing(8)
        
        # Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ
        def make_hf_section(title, rows):
            wrap = QtWidgets.QWidget()
            lay = QtWidgets.QVBoxLayout(wrap)
            lay.setContentsMargins(0, 0, 0, 0)
            lay.setSpacing(6)
            
            btn = QtWidgets.QToolButton()
            btn.setText(title)
            btn.setToolButtonStyle(QtCore.Qt.ToolButtonTextBesideIcon)
            btn.setArrowType(QtCore.Qt.RightArrow)
            btn.setCheckable(True)
            btn.setChecked(False)
            
            cont = QtWidgets.QWidget()
            fl = QtWidgets.QFormLayout(cont)
            fl.setContentsMargins(8, 8, 8, 8)
            fl.setSpacing(8)
            
            for lbl, w in rows:
                if lbl:
                    fl.addRow(lbl, w)
                else:
                    fl.addRow(w)
            
            def _toggle(on):
                cont.setVisible(on)
                btn.setArrowType(QtCore.Qt.DownArrow if on else QtCore.Qt.RightArrow)
            
            btn.toggled.connect(_toggle)
            lay.addWidget(btn)
            lay.addWidget(cont)
            cont.setVisible(False)
            wrap.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Maximum)
            return wrap
        
        # === Ù‚Ø³Ù…: Ø§Ù„Ø±Ø£Ø³ ===
        self.ed_header_right = QtWidgets.QLineEdit("{date}")
        self.ed_header_center = QtWidgets.QLineEdit("{title}")
        self.ed_header_left = QtWidgets.QLineEdit("ØµÙØ­Ø© {page} Ù…Ù† {pages}")
        row_hdr = QtWidgets.QHBoxLayout()
        row_hdr.addWidget(QtWidgets.QLabel("ÙŠÙ…ÙŠÙ†:")); row_hdr.addWidget(self.ed_header_right)
        row_hdr.addWidget(QtWidgets.QLabel("ÙˆØ³Ø·:")); row_hdr.addWidget(self.ed_header_center)
        row_hdr.addWidget(QtWidgets.QLabel("ÙŠØ³Ø§Ø±:")); row_hdr.addWidget(self.ed_header_left)
        # Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØºÙŠÙ‘Ø±Ø§Øª
        row_btns = QtWidgets.QHBoxLayout()
        def _mk_btn(txt, macro):
            b = QtWidgets.QToolButton(); b.setText(txt); b.clicked.connect(lambda: self._insert_macro(macro))
            return b
        row_btns.addWidget(_mk_btn("ØªØ§Ø±ÙŠØ®", "{date}"))
        row_btns.addWidget(_mk_btn("ÙˆÙ‚Øª", "{time}"))
        row_btns.addWidget(_mk_btn("ØµÙØ­Ø©", "{page}"))
        row_btns.addWidget(_mk_btn("Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª", "{pages}"))
        row_btns.addWidget(_mk_btn("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "{title}"))
        row_btns.addWidget(_mk_btn("Ø§Ù„Ù‚Ø³Ù…", "{dept}"))
        self.sp_header_size = QtWidgets.QSpinBox(); self.sp_header_size.setRange(8, 72); self.sp_header_size.setValue(12)
        self.chk_use_filter_dept = QtWidgets.QCheckBox("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ø±Ø£Ø³")
        sec_header = make_hf_section("Ø§Ù„Ø±Ø£Ø³", [
            ("Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ù‡ÙŠØ¯Ø±:", self.sp_header_size),
            ("Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø±:", row_hdr),
            ("Ø¥Ø¯Ø±Ø§Ø¬ Ù…ØªØºÙŠÙ‘Ø±Ø§Øª:", row_btns),
            (None, self.chk_use_filter_dept)
        ])
        v_hf.addWidget(sec_header)
        
        # === Ù‚Ø³Ù…: Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ===
        self.sp_col_header_size = QtWidgets.QSpinBox(); self.sp_col_header_size.setRange(8, 8); self.sp_col_header_size.setValue(8); self.sp_col_header_size.setEnabled(False)
        self.chk_col_header_bold = QtWidgets.QCheckBox("Ø®Ø· Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ø±ÙŠØ¶")
        self.chk_col_header_bold.setChecked(True)
        self.sp_col_header_row_height_pct = QtWidgets.QDoubleSpinBox(); self.sp_col_header_row_height_pct.setRange(5.0, 800.0); self.sp_col_header_row_height_pct.setDecimals(1); self.sp_col_header_row_height_pct.setSingleStep(1.0); self.sp_col_header_row_height_pct.setValue(100.0); self.sp_col_header_row_height_pct.setSuffix(" %")
        sec_col_header = make_hf_section("Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©", [
            ("Ø­Ø¬Ù… Ø®Ø· Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:", self.sp_col_header_size),
            ("Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© %:", self.sp_col_header_row_height_pct),
            (None, self.chk_col_header_bold)
        ])
        v_hf.addWidget(sec_col_header)
        
        # === Ù‚Ø³Ù…: Ø§Ù„ØªØ°ÙŠÙŠÙ„ ===
        self.ed_footer = QtWidgets.QLineEdit("ØµÙØ­Ø© {page} Ù…Ù† {pages}")
        sec_footer = make_hf_section("Ø§Ù„ØªØ°ÙŠÙŠÙ„", [
            ("Ù†Øµ Ø§Ù„ØªØ°ÙŠÙŠÙ„:", self.ed_footer)
        ])
        v_hf.addWidget(sec_footer)
        
        v_hf.addStretch(1)
        # ØªÙ… Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø±Ø£Ø³/Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ ØªØ«Ø¨ÙŠØª Ù‚ÙŠÙ…Ù‡
        # side.addTab(self.pg_hf, "Ø§Ù„Ø±Ø£Ø³/Ø§Ù„ØªØ°ÙŠÙŠÙ„")

        # --- Tab: Columns ---
        pg_cols = QtWidgets.QWidget();
        vcols = QtWidgets.QVBoxLayout(pg_cols)
        self.list_cols = QtWidgets.QListWidget();
        self.list_cols.setSelectionMode(QtWidgets.QAbstractItemView.NoSelection)
        self.list_cols.setAlternatingRowColors(True)
        # Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·
        # Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒÙ…ØµØ¯Ø± Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©
        source_table = self._table_override or getattr(self.parent, 'table', None)
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        is_bank_limits_tab = False
        try:
            if getattr(self.parent, "tabs", None) and getattr(self.parent, "_bank_limits_tab_widget", None):
                if self.parent.tabs.currentWidget() is self.parent._bank_limits_tab_widget:
                    if getattr(self.parent, 'bank_limits_table', None):
                        source_table = self.parent.bank_limits_table
                        is_bank_limits_tab = True
        except Exception:
            pass
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„
        if source_table is None:
            source_table = getattr(self.parent, 'table', None)
        if source_table is None:
            headers = []
        else:
            headers = [source_table.horizontalHeaderItem(i).text() for i in range(source_table.columnCount())]
            # Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            if is_bank_limits_tab:
                # Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                for c in range(source_table.columnCount()):
                    try:
                        if source_table.isColumnHidden(c):
                            source_table.setColumnHidden(c, False)
                    except Exception:
                        pass
        for i, h in enumerate(headers):
            it = QtWidgets.QListWidgetItem(h, self.list_cols)
            it.setFlags(it.flags() | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
            it.setCheckState(QtCore.Qt.Checked)
        # ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…ÙÙØ¹Ù‘Ù„Ø© Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ØŒ ÙˆØ³Ù†ÙˆÙÙ‘Ù‚Ù‡Ø§ Ø¨Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§
        vcols.addWidget(self.list_cols, 1)
        # Ø®ÙŠØ§Ø±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        self.chk_use_main_widths = QtWidgets.QCheckBox("Ø§Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø¨ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
        self.chk_use_main_widths.setChecked(True)
        vcols.addWidget(self.chk_use_main_widths)
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ ÙˆØ­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©)
        h_sizes = QtWidgets.QGridLayout()
        lbl_row = QtWidgets.QLabel("Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ %:")
        self.sp_row_height_pct = QtWidgets.QDoubleSpinBox(); self.sp_row_height_pct.setRange(0.5, 2000.0); self.sp_row_height_pct.setDecimals(2); self.sp_row_height_pct.setSingleStep(0.5); self.sp_row_height_pct.setValue(100.0); self.sp_row_height_pct.setSuffix(" %")
        lbl_col = QtWidgets.QLabel("Ø­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© %:")
        self.sp_col_width_pct = QtWidgets.QDoubleSpinBox(); self.sp_col_width_pct.setRange(5.0, 2000.0); self.sp_col_width_pct.setSingleStep(5.0); self.sp_col_width_pct.setValue(100.0); self.sp_col_width_pct.setSuffix(" %")
        # ØªÙ… Ù†Ù‚Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ† Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ø¬ÙŠÙ… ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        h_sizes.addWidget(lbl_row, 0, 0); h_sizes.addWidget(self.sp_row_height_pct, 0, 1)
        h_sizes.addWidget(lbl_col, 1, 0); h_sizes.addWidget(self.sp_col_width_pct, 1, 1)
        vcols.addLayout(h_sizes)
        # Ø¬Ø¯ÙˆÙ„ ØªØ­Ø¬ÙŠÙ… Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¹Ù„Ù‰ Ø­Ø¯Ø© (Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ + Ù†Ø³Ø¨Ø© %)
        lbl_scales = QtWidgets.QLabel("ØºÙŠÙ‘Ø± Ø­Ø¬Ù… ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¹Ù„Ù‰ Ø­Ø¯Ø©:")
        vcols.addWidget(lbl_scales)
        self.tbl_col_scales = QtWidgets.QTableWidget()
        self.tbl_col_scales.setColumnCount(2)
        self.tbl_col_scales.setHorizontalHeaderLabels(["Ø§Ù„Ø¹Ù…ÙˆØ¯", "Ù†Ø³Ø¨Ø© %"])
        self.tbl_col_scales.horizontalHeader().setStretchLastSection(True)
        self.tbl_col_scales.verticalHeader().setVisible(False)
        self.tbl_col_scales.setAlternatingRowColors(True)
        self._col_scale_spinboxes = []
        # Ø§Ù…Ù„Ø£ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø·
        self.tbl_col_scales.setRowCount(0)
        try:
            self._refresh_col_scales_from_selection()
        except Exception:
            pass
        vcols.addWidget(self.tbl_col_scales)
        # Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        # Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŒ ÙˆØ¥Ù† ÙØ´Ù„Øª Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±
        try:
            self._match_visible_main_by_name()
        except Exception:
            try:
                self._match_visible()
            except Exception:
                pass
        side.addTab(pg_cols, "Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©")

        # --- Tab: Totals ---
        pg_tot = QtWidgets.QWidget();
        v_tot = QtWidgets.QVBoxLayout(pg_tot)
        v_tot.setContentsMargins(0, 0, 0, 0)
        v_tot.setSpacing(8)
        
        # Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ (Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØµÙØ­Ø©)
        def make_totals_section(title, rows):
            wrap = QtWidgets.QWidget()
            lay = QtWidgets.QVBoxLayout(wrap)
            lay.setContentsMargins(0, 0, 0, 0)
            lay.setSpacing(6)
            
            btn = QtWidgets.QToolButton()
            btn.setText(title)
            btn.setToolButtonStyle(QtCore.Qt.ToolButtonTextBesideIcon)
            btn.setArrowType(QtCore.Qt.RightArrow)
            btn.setCheckable(True)
            btn.setChecked(False)
            
            cont = QtWidgets.QWidget()
            fl = QtWidgets.QFormLayout(cont)
            fl.setContentsMargins(8, 8, 8, 8)
            fl.setSpacing(8)
            
            for lbl, w in rows:
                if lbl:
                    fl.addRow(lbl, w)
                else:
                    fl.addRow(w)
            
            def _toggle(on):
                cont.setVisible(on)
                btn.setArrowType(QtCore.Qt.DownArrow if on else QtCore.Qt.RightArrow)
            
            btn.toggled.connect(_toggle)
            lay.addWidget(btn)
            lay.addWidget(cont)
            cont.setVisible(False)
            wrap.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Maximum)
            # Ø­ÙØ¸ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ ÙƒØ®ØµØ§Ø¦Øµ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
            wrap._section_button = btn
            wrap._section_content = cont
            return wrap
        
        # === Ù‚Ø³Ù…: Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø© ===
        self.cmb_total_cols = QtWidgets.QListWidget();
        self.cmb_total_cols.setSelectionMode(QtWidgets.QAbstractItemView.MultiSelection)
        self.cmb_total_cols.setMaximumHeight(120)
        for name in headers:
            # ÙÙ‚Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù† (Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†) - Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†
            if (("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†" in name or "Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†" in name) and 
                "Ø§Ù„ØªØ£Ù…ÙŠÙ†" not in name and "insurance" not in name.lower()):
                self.cmb_total_cols.addItem(name)
        try:
            # ØªØ­Ø¯ÙŠØ¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù† ÙÙ‚Ø·
            for i in range(self.cmb_total_cols.count()):
                it = self.cmb_total_cols.item(i)
                it.setSelected(True)
        except Exception:
            pass
        self.chk_total_per_page = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø¢Ø®Ø± ÙƒÙ„ ØµÙØ­Ø©")
        self.sp_total_row_h = QtWidgets.QSpinBox(); self.sp_total_row_h.setRange(20, 120); self.sp_total_row_h.setValue(28)
        self.sp_total_page_font_pt = QtWidgets.QSpinBox(); self.sp_total_page_font_pt.setRange(6, 48); self.sp_total_page_font_pt.setValue(9)
        sec_cols_page = make_totals_section("Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø©", [
            ("Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠÙ‡Ø§:", self.cmb_total_cols),
            (None, self.chk_total_per_page),
            ("Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù†Ù‚Ø·Ø©):", self.sp_total_row_h),
            ("Ø­Ø¬Ù… Ø§Ù„Ø®Ø· (Ù†Ù‚Ø·Ø©):", self.sp_total_page_font_pt)
        ])
        # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø¯ ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª
        def _check_and_activate_totals():
            try:
                parent = getattr(self, 'parent', None)
                if not parent:
                    return
                status = getattr(parent, 'cmb_status', None)
                gtype = getattr(parent, 'cmb_gtype', None)
                cmb_cash = getattr(parent, 'cmb_cash', None)
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
                has_status_filter = False
                if status:
                    try:
                        status_text = status.currentText().strip() if hasattr(status, 'currentText') else ''
                        has_status_filter = status_text and status_text != 'Ø§Ù„ÙƒÙ„'
                    except Exception:
                        pass
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹
                has_type_filter = False
                if gtype:
                    try:
                        gtype_text = gtype.currentText().strip() if hasattr(gtype, 'currentText') else ''
                        has_type_filter = gtype_text and gtype_text != 'Ø§Ù„ÙƒÙ„'
                    except Exception:
                        pass
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª
                has_cash_filter = False
                if cmb_cash:
                    try:
                        cash_text = cmb_cash.currentText().strip() if hasattr(cmb_cash, 'currentText') else ''
                        has_cash_filter = cash_text and cash_text != 'Ø§Ù„ÙƒÙ„'
                    except Exception:
                        pass
                
                if has_status_filter or has_type_filter or has_cash_filter:
                    # ÙØªØ­ Ø§Ù„Ø¨Ù†Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    btn = getattr(sec_cols_page, '_section_button', None)
                    cont = getattr(sec_cols_page, '_section_content', None)
                    if btn and cont:
                        btn.setChecked(True)
                        btn.setArrowType(QtCore.Qt.DownArrow)
                        cont.setVisible(True)
                    # ØªÙØ¹ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    if hasattr(self, 'chk_total_per_page'):
                        self.chk_total_per_page.setChecked(True)
            except Exception:
                pass
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… timer Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¬Ø§Ù‡Ø²Ø©)
        QtCore.QTimer.singleShot(100, _check_and_activate_totals)
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±
        try:
            parent = getattr(self, 'parent', None)
            if parent:
                status = getattr(parent, 'cmb_status', None)
                gtype = getattr(parent, 'cmb_gtype', None)
                cmb_cash = getattr(parent, 'cmb_cash', None)
                if status:
                    status.currentTextChanged.connect(_check_and_activate_totals)
                    status.currentIndexChanged.connect(_check_and_activate_totals)
                if gtype:
                    gtype.currentTextChanged.connect(_check_and_activate_totals)
                    gtype.currentIndexChanged.connect(_check_and_activate_totals)
                if cmb_cash:
                    cmb_cash.currentTextChanged.connect(_check_and_activate_totals)
                    cmb_cash.currentIndexChanged.connect(_check_and_activate_totals)
        except Exception:
            pass
        v_tot.addWidget(sec_cols_page)
        
        # === Ù‚Ø³Ù…: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ===
        self.chk_total_overall = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
        self.chk_total_overall.setChecked(True)
        self.sp_total_font_pt = QtWidgets.QSpinBox(); self.sp_total_font_pt.setRange(6, 24); self.sp_total_font_pt.setValue(10)
        self.sp_total_offset_cm = QtWidgets.QDoubleSpinBox(); self.sp_total_offset_cm.setDecimals(2); self.sp_total_offset_cm.setRange(-10.0, 10.0); self.sp_total_offset_cm.setSingleStep(0.10); self.sp_total_offset_cm.setValue(0.50)
        self.chk_total_box = QtWidgets.QCheckBox("Ø®Ù„ÙÙŠØ©/Ø­Ø¯ Ø­ÙˆÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±")
        self.chk_total_box.setChecked(True)
        sec_report = make_totals_section("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", [
            (None, self.chk_total_overall),
            ("Ø­Ø¬Ù… Ø§Ù„Ø®Ø· (Ù†Ù‚Ø·Ø©):", self.sp_total_font_pt),
            ("Ø¥Ø²Ø§Ø­Ø© Ø¹Ù† Ø§Ù„Ø£Ø³ÙÙ„ (Ø³Ù…):", self.sp_total_offset_cm),
            (None, self.chk_total_box)
        ])
        v_tot.addWidget(sec_report)
        
        # === Ù‚Ø³Ù…: Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ ===
        self.chk_props_footer = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø®Ù„Ø§ØµØ© Ø®ØµØ§Ø¦Øµ Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„")
        self.chk_props_footer.setChecked(True)
        self.sp_props_row_h = QtWidgets.QSpinBox(); self.sp_props_row_h.setRange(16, 96); self.sp_props_row_h.setValue(90)
        self.sp_props_font_pt = QtWidgets.QSpinBox(); self.sp_props_font_pt.setRange(6, 24); self.sp_props_font_pt.setValue(8)
        self.chk_props_bold_values = QtWidgets.QCheckBox("Ø®Ø· Ø¹Ø±ÙŠØ¶ Ù„Ù‚ÙŠÙ… Ø§Ù„Ø®ØµØ§Ø¦Øµ")
        self.chk_props_bold_values.setChecked(True)
        self.sp_props_gap = QtWidgets.QDoubleSpinBox(); self.sp_props_gap.setDecimals(2); self.sp_props_gap.setRange(0.0, 10.0); self.sp_props_gap.setSingleStep(0.10); self.sp_props_gap.setValue(2.80)
        self.sp_props_width_pct = QtWidgets.QDoubleSpinBox(); self.sp_props_width_pct.setRange(10.0, 100.0); self.sp_props_width_pct.setDecimals(1); self.sp_props_width_pct.setSingleStep(1.0); self.sp_props_width_pct.setValue(42.0)
        self.cmb_props_align = QtWidgets.QComboBox(); self.cmb_props_align.addItems(["ÙŠÙ…ÙŠÙ†", "ÙŠØ³Ø§Ø±", "Ù…Ù†ØªØµÙ"]); self.cmb_props_align.setCurrentText("ÙŠÙ…ÙŠÙ†")
        self.sp_props_offset_cm = QtWidgets.QDoubleSpinBox(); self.sp_props_offset_cm.setDecimals(2); self.sp_props_offset_cm.setRange(0.0, 10.0); self.sp_props_offset_cm.setSingleStep(0.10); self.sp_props_offset_cm.setValue(10.00)
        self.chk_props_footer_single_page = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø®Ù„Ø§ØµØ© Ø®ØµØ§Ø¦Øµ ÙÙŠ ØµÙØ­Ø© Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙ‚Ø·")
        sec_props = make_totals_section("Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ", [
            (None, self.chk_props_footer),
            ("Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø§Ù„Ø®ØµØ§Ø¦Øµ (Ù†Ù‚Ø·Ø©):", self.sp_props_row_h),
            ("Ø­Ø¬Ù… Ø§Ù„Ø®Ø· (Ù†Ù‚Ø·Ø©):", self.sp_props_font_pt),
            (None, self.chk_props_bold_values),
            ("Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ (Ø³Ù…):", self.sp_props_gap),
            ("Ù†Ø³Ø¨Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (% Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰):", self.sp_props_width_pct),
            ("Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„:", self.cmb_props_align),
            ("Ø¥Ø²Ø§Ø­Ø© Ø£ÙÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© (Ø³Ù…):", self.sp_props_offset_cm),
            (None, self.chk_props_footer_single_page)
        ])
        v_tot.addWidget(sec_props)
        
        # === Ù‚Ø³Ù…: Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ ===
        self.chk_bank_sum_visible = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ")
        self.chk_bank_sum_visible.setChecked(True)
        self.sp_bank_sum_row_h = QtWidgets.QSpinBox(); self.sp_bank_sum_row_h.setRange(20, 200); self.sp_bank_sum_row_h.setValue(110)
        self.sp_bank_sum_width_pct = QtWidgets.QDoubleSpinBox(); self.sp_bank_sum_width_pct.setRange(40.0, 100.0); self.sp_bank_sum_width_pct.setSingleStep(1.0); self.sp_bank_sum_width_pct.setValue(65.0); self.sp_bank_sum_width_pct.setSuffix(" %")
        self.sp_bank_sum_bank_pct = QtWidgets.QDoubleSpinBox(); self.sp_bank_sum_bank_pct.setRange(20.0, 80.0); self.sp_bank_sum_bank_pct.setSingleStep(1.0); self.sp_bank_sum_bank_pct.setValue(50.0); self.sp_bank_sum_bank_pct.setSuffix(" %")
        self.sp_bank_sum_num_pct = QtWidgets.QDoubleSpinBox(); self.sp_bank_sum_num_pct.setRange(5.0, 25.0); self.sp_bank_sum_num_pct.setSingleStep(0.5); self.sp_bank_sum_num_pct.setValue(25.0); self.sp_bank_sum_num_pct.setSuffix(" %")
        self.sp_bank_sum_hdr_pt = QtWidgets.QSpinBox(); self.sp_bank_sum_hdr_pt.setRange(6, 24); self.sp_bank_sum_hdr_pt.setValue(9)
        self.sp_bank_sum_row_pt = QtWidgets.QSpinBox(); self.sp_bank_sum_row_pt.setRange(6, 24); self.sp_bank_sum_row_pt.setValue(9)
        self.chk_bank_sum_zebra = QtWidgets.QCheckBox("ØªØ¸Ù„ÙŠÙ„ ØµÙÙˆÙ Ù…ØªØ¹Ø§Ù‚Ø¨Ø©")
        self.chk_bank_sum_zebra.setChecked(True)
        self.chk_bank_sum_auto = QtWidgets.QCheckBox("ØªØ®Ø·ÙŠØ· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©")
        self.chk_bank_sum_auto.setChecked(True)
        self.cmb_bank_sum_align = QtWidgets.QComboBox(); self.cmb_bank_sum_align.addItems(["ÙŠÙ…ÙŠÙ†", "ÙŠØ³Ø§Ø±", "Ù…Ù†ØªØµÙ"]); self.cmb_bank_sum_align.setCurrentText("Ù…Ù†ØªØµÙ")
        self.sp_bank_sum_offset_cm = QtWidgets.QDoubleSpinBox(); self.sp_bank_sum_offset_cm.setDecimals(2); self.sp_bank_sum_offset_cm.setRange(0.0, 10.0); self.sp_bank_sum_offset_cm.setSingleStep(0.10); self.sp_bank_sum_offset_cm.setValue(0.00)
        self.sp_bank_sum_gap = QtWidgets.QDoubleSpinBox(); self.sp_bank_sum_gap.setDecimals(2); self.sp_bank_sum_gap.setRange(0.0, 10.0); self.sp_bank_sum_gap.setSingleStep(0.10); self.sp_bank_sum_gap.setValue(1.50)
        sec_bank = make_totals_section("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø§Ù‚Ø³Ø§Ù…", [
            (None, self.chk_bank_sum_visible),
            ("Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ (Ù†Ù‚Ø·Ø©):", self.sp_bank_sum_row_h),
            ("Ù†Ø³Ø¨Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (% Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰):", self.sp_bank_sum_width_pct),
            ("Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ù†Ùƒ (% Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„):", self.sp_bank_sum_bank_pct),
            ("Ù†Ø³Ø¨Ø© ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù…ÙŠ (% Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„):", self.sp_bank_sum_num_pct),
            ("Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø±Ø£Ø³ (Ù†Ù‚Ø·Ø©):", self.sp_bank_sum_hdr_pt),
            ("Ø­Ø¬Ù… Ø®Ø· Ø§Ù„ØµÙ (Ù†Ù‚Ø·Ø©):", self.sp_bank_sum_row_pt),
            (None, self.chk_bank_sum_zebra),
            (None, self.chk_bank_sum_auto),
            ("Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„:", self.cmb_bank_sum_align),
            ("Ø¥Ø²Ø§Ø­Ø© Ø£ÙÙ‚ÙŠØ© (Ø³Ù…):", self.sp_bank_sum_offset_cm),
            ("Ù…Ø³Ø§ÙØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø³Ù…):", self.sp_bank_sum_gap)
        ])
        v_tot.addWidget(sec_bank)
        
        # === Ù‚Ø³Ù…: Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù‚Ø¯ÙŠ ===
        self.sp_cash_title_offset_cm = QtWidgets.QDoubleSpinBox(); self.sp_cash_title_offset_cm.setDecimals(2); self.sp_cash_title_offset_cm.setRange(-10.0, 10.0); self.sp_cash_title_offset_cm.setSingleStep(0.10); self.sp_cash_title_offset_cm.setValue(4.00)
        sec_cash = make_totals_section("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù‚Ø¯ÙŠ", [
            ("Ø¥Ø²Ø§Ø­Ø© Ø±Ø£Ø³ÙŠØ© (Ø³Ù…):", self.sp_cash_title_offset_cm)
        ])
        v_tot.addWidget(sec_cash)
        
        v_tot.addStretch(1)
        # Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        try:
            # Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø©
            self.chk_total_per_page.toggled.connect(self.preview.updatePreview)
            self.chk_total_per_page.toggled.connect(self._save_settings)
            self.sp_total_row_h.valueChanged.connect(self.preview.updatePreview)
            self.sp_total_row_h.valueChanged.connect(self._save_settings)
            self.sp_total_page_font_pt.valueChanged.connect(self.preview.updatePreview)
            self.sp_total_page_font_pt.valueChanged.connect(self._save_settings)
            # Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            self.chk_total_overall.toggled.connect(self.preview.updatePreview)
            self.chk_total_overall.toggled.connect(self._save_settings)
            self.sp_total_font_pt.valueChanged.connect(self.preview.updatePreview)
            self.sp_total_font_pt.valueChanged.connect(self._save_settings)
            self.sp_total_offset_cm.valueChanged.connect(self.preview.updatePreview)
            self.sp_total_offset_cm.valueChanged.connect(self._save_settings)
            self.chk_total_box.toggled.connect(self.preview.updatePreview)
            self.chk_total_box.toggled.connect(self._save_settings)
            # Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ
            self.chk_props_footer.toggled.connect(self.preview.updatePreview)
            self.chk_props_footer.toggled.connect(self._save_settings)
            self.sp_props_row_h.valueChanged.connect(self.preview.updatePreview)
            self.sp_props_row_h.valueChanged.connect(self._save_settings)
            self.sp_props_font_pt.valueChanged.connect(self.preview.updatePreview)
            self.sp_props_font_pt.valueChanged.connect(self._save_settings)
            self.chk_props_bold_values.toggled.connect(self.preview.updatePreview)
            self.chk_props_bold_values.toggled.connect(self._save_settings)
            self.sp_props_gap.valueChanged.connect(self.preview.updatePreview)
            self.sp_props_gap.valueChanged.connect(self._save_settings)
            self.sp_props_width_pct.valueChanged.connect(self.preview.updatePreview)
            self.sp_props_width_pct.valueChanged.connect(self._save_settings)
            self.cmb_props_align.currentIndexChanged.connect(self.preview.updatePreview)
            self.cmb_props_align.currentIndexChanged.connect(self._save_settings)
            self.sp_props_offset_cm.valueChanged.connect(self.preview.updatePreview)
            self.sp_props_offset_cm.valueChanged.connect(self._save_settings)
            self.chk_props_footer_single_page.toggled.connect(self.preview.updatePreview)
            self.chk_props_footer_single_page.toggled.connect(self._save_settings)
            # Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ
            self.chk_bank_sum_visible.toggled.connect(self.preview.updatePreview)
            self.chk_bank_sum_visible.toggled.connect(self._save_settings)
            self.sp_bank_sum_row_h.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_row_h.valueChanged.connect(self._save_settings)
            self.sp_bank_sum_width_pct.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_width_pct.valueChanged.connect(self._save_settings)
            self.sp_bank_sum_bank_pct.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_bank_pct.valueChanged.connect(self._save_settings)
            self.sp_bank_sum_num_pct.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_num_pct.valueChanged.connect(self._save_settings)
            self.sp_bank_sum_hdr_pt.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_hdr_pt.valueChanged.connect(self._save_settings)
            self.sp_bank_sum_row_pt.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_row_pt.valueChanged.connect(self._save_settings)
            self.chk_bank_sum_zebra.toggled.connect(self.preview.updatePreview)
            self.chk_bank_sum_zebra.toggled.connect(self._save_settings)
            self.chk_bank_sum_auto.toggled.connect(self.preview.updatePreview)
            self.chk_bank_sum_auto.toggled.connect(self._save_settings)
            self.cmb_bank_sum_align.currentIndexChanged.connect(self.preview.updatePreview)
            self.cmb_bank_sum_align.currentIndexChanged.connect(self._save_settings)
            self.sp_bank_sum_offset_cm.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_offset_cm.valueChanged.connect(self._save_settings)
            self.sp_bank_sum_gap.valueChanged.connect(self.preview.updatePreview)
            self.sp_bank_sum_gap.valueChanged.connect(self._save_settings)
            # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù‚Ø¯ÙŠ
            self.sp_cash_title_offset_cm.valueChanged.connect(self.preview.updatePreview)
            self.sp_cash_title_offset_cm.valueChanged.connect(self._save_settings)
            # Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            if isinstance(self.cmb_total_cols, QtWidgets.QListWidget):
                self.cmb_total_cols.itemSelectionChanged.connect(self.preview.updatePreview)
                self.cmb_total_cols.itemSelectionChanged.connect(self._save_settings)
        except Exception:
            pass
        side.addTab(pg_tot, "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª")

        # --- Tab: Watermark ---
        pg_wm = QtWidgets.QWidget();
        v_wm = QtWidgets.QVBoxLayout(pg_wm)
        v_wm.setContentsMargins(0, 0, 0, 0)
        v_wm.setSpacing(8)
        
        # Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ
        def make_wm_section(title, rows):
            wrap = QtWidgets.QWidget()
            lay = QtWidgets.QVBoxLayout(wrap)
            lay.setContentsMargins(0, 0, 0, 0)
            lay.setSpacing(6)
            
            btn = QtWidgets.QToolButton()
            btn.setText(title)
            btn.setToolButtonStyle(QtCore.Qt.ToolButtonTextBesideIcon)
            btn.setArrowType(QtCore.Qt.RightArrow)
            btn.setCheckable(True)
            btn.setChecked(False)
            
            cont = QtWidgets.QWidget()
            fl = QtWidgets.QFormLayout(cont)
            fl.setContentsMargins(8, 8, 8, 8)
            fl.setSpacing(8)
            
            for lbl, w in rows:
                if lbl:
                    fl.addRow(lbl, w)
                else:
                    fl.addRow(w)
            
            def _toggle(on):
                cont.setVisible(on)
                btn.setArrowType(QtCore.Qt.DownArrow if on else QtCore.Qt.RightArrow)
            
            btn.toggled.connect(_toggle)
            lay.addWidget(btn)
            lay.addWidget(cont)
            cont.setVisible(False)
            wrap.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Maximum)
            return wrap
        
        # === Ù‚Ø³Ù…: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ===
        self.wm_enabled = QtWidgets.QCheckBox("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©")
        # Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§: ÙØ¹Ù‘Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        try:
            self.wm_enabled.setChecked(True)
        except Exception:
            pass
        self.wm_path = QtWidgets.QLineEdit("")
        self.wm_browse = QtWidgets.QPushButton("Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ùâ€¦")
        self.wm_opacity = QtWidgets.QDoubleSpinBox(); self.wm_opacity.setRange(0.01, 1.0); self.wm_opacity.setSingleStep(0.01); self.wm_opacity.setValue(0.20)
        self.wm_scale = QtWidgets.QDoubleSpinBox(); self.wm_scale.setRange(0.1, 20.0); self.wm_scale.setSingleStep(0.10); self.wm_scale.setValue(0.40)
        h_wmpath = QtWidgets.QHBoxLayout(); h_wmpath.addWidget(self.wm_path); h_wmpath.addWidget(self.wm_browse)
        sec_wm = make_wm_section("Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©", [
            (None, self.wm_enabled),
            ("Ù…Ù„Ù Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© (PNG/SVG):", h_wmpath),
            ("Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©:", self.wm_opacity),
            ("Ø­Ø¬Ù… Ù†Ø³Ø¨ÙŠ:", self.wm_scale)
        ])
        v_wm.addWidget(sec_wm)
        
        v_wm.addStretch(1)
        side.addTab(pg_wm, "Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©")

        # Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© (QDialogButtonBox) Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†

        # Layout Ù…Ø¹ Ù…Ù‚Ø³Ù‘Ù… Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨ Ù„ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        splitter = QtWidgets.QSplitter(QtCore.Qt.Horizontal, self)
        splitter.setChildrenCollapsible(False)
        splitter.addWidget(side)
        splitter.addWidget(self.preview)
        try:
            # Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£ÙŠØ¶Ù‹Ø§ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø¯Ø¯ Ù„ØªØªÙØ§Ø¹Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
            splitter.setStretchFactor(0, 1)
            splitter.setStretchFactor(1, 1)
            splitter.setSizes([520, 900])
            side.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Expanding)
        except Exception:
            pass
        root = QtWidgets.QVBoxLayout(self)
        root.addWidget(splitter)
        # Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª ÙŠØ·ÙÙˆ ÙÙˆÙ‚ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        pdf_row = QtWidgets.QHBoxLayout()
        # Ø²Ø± Ø­ÙØ¸ PDF Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªÙ…Ø§Ù…Ù‹Ø§
        btn_save_pdf = QtWidgets.QPushButton("Ø­ÙØ¸ PDFâ€¦")
        btn_save_pdf.setToolTip("ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ PDF Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
        try:
            btn_save_pdf.clicked.connect(self._save_pdf_from_preview)
        except Exception:
            pass
        # Ø²Ø± ØªØµØ¯ÙŠØ± Excel Ø¨Ù†ÙØ³ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
        btn_export_excel = QtWidgets.QPushButton("ØªØµØ¯ÙŠØ± Excelâ€¦")
        btn_export_excel.setToolTip("ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Excel Ø¨Ù†ÙØ³ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©")
        try:
            btn_export_excel.clicked.connect(self._export_excel_from_preview)
        except Exception:
            pass
        # Ø£Ø¯ÙˆØ§Øª ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        btn_zoom_out = QtWidgets.QPushButton("-")
        btn_zoom_out.setToolTip("ØªØµØºÙŠØ± Ù…Ø¹Ø§ÙŠÙ†Ø© (Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹)")
        btn_zoom_in = QtWidgets.QPushButton("+")
        btn_zoom_in.setToolTip("ØªÙƒØ¨ÙŠØ± Ù…Ø¹Ø§ÙŠÙ†Ø© (Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹)")
        self.sl_zoom = QtWidgets.QSlider(QtCore.Qt.Horizontal)
        self.sl_zoom.setRange(10, 400)
        self.sl_zoom.setValue(100)
        self.sl_zoom.setFixedWidth(160)
        def _set_custom_zoom():
            try:
                self.preview.setZoomMode(QtPrintSupport.QPrintPreviewWidget.Custom)
            except Exception:
                # Ø¨Ø¹Ø¶ Ø¥ØµØ¯Ø§Ø±Ø§Øª PyQt5 ØªØ³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù
                try:
                    self.preview.setZoomMode(QtPrintSupport.QPrintPreviewWidget.ZoomMode.Custom)
                except Exception:
                    pass
        def _zoom_apply(factor):
            try:
                _set_custom_zoom()
                self.preview.setZoomFactor(max(0.1, float(factor)))
            except Exception:
                pass
        btn_zoom_out.clicked.connect(lambda: _zoom_apply(self.preview.zoomFactor() * 0.9))
        btn_zoom_in.clicked.connect(lambda: _zoom_apply(self.preview.zoomFactor() * 1.1))
        self.sl_zoom.valueChanged.connect(lambda v: _zoom_apply(v/100.0))
        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        btn_prev_page = QtWidgets.QPushButton("â—„")
        btn_prev_page.setToolTip("Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©")
        btn_prev_page.setFixedWidth(30)
        btn_next_page = QtWidgets.QPushButton("â–º")
        btn_next_page.setToolTip("Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©")
        btn_next_page.setFixedWidth(30)
        self.lbl_page_info = QtWidgets.QLabel("ØµÙØ­Ø© 1 Ù…Ù† 1")
        self.lbl_page_info.setToolTip("Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª")
        def _go_prev():
            try:
                cur = getattr(self, '_current_preview_page', 1)
                if cur > 1:
                    self._current_preview_page = cur - 1
                    self.preview.updatePreview()
            except Exception:
                pass
        def _go_next():
            try:
                cur = getattr(self, '_current_preview_page', 1)
                # Ø§Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ù…Ù† Ø¢Ø®Ø± Ø±Ø³Ù…
                total = getattr(self, '_total_pages', 1)
                if cur < total:
                    self._current_preview_page = cur + 1
                    self.preview.updatePreview()
            except Exception:
                pass
        btn_prev_page.clicked.connect(_go_prev)
        btn_next_page.clicked.connect(_go_next)
        # Ø¶Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø±Ù‰
        pdf_row.addWidget(btn_save_pdf)
        pdf_row.addWidget(btn_export_excel)
        pdf_row.addSpacing(8)
        pdf_row.addWidget(btn_prev_page)
        pdf_row.addWidget(self.lbl_page_info)
        pdf_row.addWidget(btn_next_page)
        pdf_row.addSpacing(8)
        pdf_row.addWidget(btn_zoom_out)
        pdf_row.addWidget(self.sl_zoom)
        pdf_row.addWidget(btn_zoom_in)
        pdf_row.addStretch(1)
        # Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ØªØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø²ÙˆÙ…
        # Ø¶Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙƒØ¹Ù†ØµØ± Ø¹Ø§Ø¦Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        self.preview_tools = QtWidgets.QWidget(self.preview)
        self.preview_tools.setLayout(pdf_row)
        try:
            self.preview_tools.setStyleSheet("QWidget{background-color: rgba(40,40,50,170); border-radius: 8px;}")
        except Exception:
            pass
        self.preview_tools.show(); self.preview_tools.raise_()
        try:
            self._position_preview_tools()
        except Exception:
            pass
        self.setLayout(root)
        # Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        self._print_overlay = QtWidgets.QLabel(self)
        try:
            self._print_overlay.setAttribute(QtCore.Qt.WA_TransparentForMouseEvents)
            self._print_overlay.setAttribute(QtCore.Qt.WA_TranslucentBackground)
            try:
                pal = QtWidgets.QApplication.palette()
                hi = pal.color(QtGui.QPalette.Highlight)
                ht = pal.color(QtGui.QPalette.HighlightedText)
                self._print_overlay.setStyleSheet(f"QLabel {{ background: rgba({hi.red()}, {hi.green()}, {hi.blue()}, 180); color: rgb({ht.red()}, {ht.green()}, {ht.blue()}); border-radius:10px; padding:10px 16px; font-size:13px; font-weight:600; }}")
            except Exception:
                self._print_overlay.setStyleSheet("QLabel { background: rgba(0,0,0,160); color:#fff; border-radius:10px; padding:10px 16px; font-size:13px; font-weight:600; }")
            self._print_overlay.setWindowFlags(QtCore.Qt.SubWindow)
            self._print_overlay.hide()
        except Exception:
            pass
        # Ø£Ø¹ÙØ¯ ØªÙ…ÙˆØ¶Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        try:
            self.preview.installEventFilter(self)
        except Exception:
            pass

        # Load settings then connect signals
        self._load_settings()
        for w in [self.cmb_size, self.cmb_orient, self.cmb_color_mode,
                  self.cmb_scale_mode, self.sp_scale, self.sp_font_scale, self.sp_border,
                  self.cmb_style,
                  self.chk_print_bg, self.chk_white_text, self.chk_repeat_header, self.chk_snapshot, self.chk_direct_print,
                  self.ed_header_right, self.ed_header_center, self.ed_header_left, self.ed_footer,
                  self.sp_header_size, self.sp_col_header_size, self.sp_col_header_row_height_pct, self.chk_col_header_bold,
                  self.chk_use_filter_dept, self.list_cols,
                  self.sp_from_page, self.sp_to_page,
                  self.wm_enabled, self.wm_opacity, self.wm_scale, self.wm_path,
                  self.chk_use_main_widths, self.sp_row_height_pct, self.sp_col_width_pct,]:
            if hasattr(w, "currentIndexChanged"):
                w.currentIndexChanged.connect(self.preview.updatePreview)
                w.currentIndexChanged.connect(self._save_settings)
            if hasattr(w, "valueChanged"):
                w.valueChanged.connect(self.preview.updatePreview)
                w.valueChanged.connect(self._save_settings)
        # Ø§Ø±Ø¨Ø· Ø¥Ø´Ø§Ø±Ø§Øª QCheckBox ØºÙŠØ± Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø© Ø£Ø¹Ù„Ø§Ù‡
        try:
            self.chk_col_header_bold.toggled.connect(self.preview.updatePreview)
            self.chk_col_header_bold.toggled.connect(self._save_settings)
        except Exception:
            pass
        # Ø±Ø¨Ø· ÙƒÙ„ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
        try:
            for cb in [
                getattr(self, 'chk_print_bg', None), getattr(self, 'chk_white_text', None),
                getattr(self, 'chk_repeat_header', None), getattr(self, 'chk_snapshot', None),
                getattr(self, 'chk_direct_print', None), getattr(self, 'chk_use_filter_dept', None),
                getattr(self, 'chk_use_main_widths', None), getattr(self, 'chk_props_footer', None),
                getattr(self, 'chk_props_bold_values', None), getattr(self, 'chk_props_footer_single_page', None),
                getattr(self, 'wm_enabled', None), getattr(self, 'chk_total_per_page', None),
                getattr(self, 'chk_total_overall', None)
            ]:
                if isinstance(cb, QtWidgets.QCheckBox):
                    cb.stateChanged.connect(self.preview.updatePreview)
                    cb.stateChanged.connect(self._save_settings)
        except Exception:
            pass
        # Ø§Ø±Ø¨Ø· Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
        try:
            for le in [self.ed_header_right, self.ed_header_center, self.ed_header_left, self.ed_footer, self.wm_path]:
                if isinstance(le, QtWidgets.QLineEdit):
                    le.textChanged.connect(self.preview.updatePreview)
                    le.textChanged.connect(self._save_settings)
        except Exception:
            pass
        # Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        try:
            if isinstance(self.cmb_total_cols, QtWidgets.QListWidget):
                self.cmb_total_cols.itemSelectionChanged.connect(self.preview.updatePreview)
                self.cmb_total_cols.itemSelectionChanged.connect(self._save_settings)
        except Exception:
            pass
        self.list_cols.itemChanged.connect(self.preview.updatePreview)
        self.list_cols.itemChanged.connect(self._save_settings)
        # Ø£Ø¹ÙØ¯ Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù†Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        try:
            self.list_cols.itemChanged.connect(self._refresh_col_scales_from_selection)
        except Exception:
            pass
        # Ø£Ø±Ø¨Ø· Ù…Ù†Ø²Ù„Ù‚Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©
        try:
            for sb in getattr(self, '_col_scale_spinboxes', []):
                sb.valueChanged.connect(self.preview.updatePreview)
                sb.valueChanged.connect(self._save_settings)
        except Exception:
            pass
        # Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù„Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©
        def _pick_wm():
            try:
                path, _ = QtWidgets.QFileDialog.getOpenFileName(self, "Ø§Ø®ØªØ± ØµÙˆØ±Ø©", "",
                                                                "Images (*.png *.jpg *.jpeg *.bmp *.svg)")
                if path:
                    self.wm_path.setText(path)
            except Exception:
                pass
        self.wm_browse.clicked.connect(_pick_wm)
        # Ø§Ø±Ø¨Ø· ØªØºÙŠÙ‘Ø± Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ù„Ø­Ø¬Ù… Ù„ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ ÙÙˆØ±Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        try:
            self.cmb_orient.currentIndexChanged.connect(
                lambda idx: (self.printer.setOrientation(self.cmb_orient.itemData(idx)), self.preview.updatePreview()))
            self.cmb_size.currentIndexChanged.connect(
                lambda idx: (self.printer.setPageSize(self.cmb_size.itemData(idx)), self.preview.updatePreview()))
            self.cmb_color_mode.currentIndexChanged.connect(
                lambda idx: (
                    self.printer.setColorMode(QtPrintSupport.QPrinter.Color if int(idx) == 0 else QtPrintSupport.QPrinter.GrayScale),
                    self.preview.updatePreview()
                )
            )
        except Exception:
            pass
        self.preview.paintRequested.connect(self._render)
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø®ÙŠØ§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        try:
            self.chk_current_page.stateChanged.connect(self.preview.updatePreview)
            self.chk_current_page.stateChanged.connect(self._save_settings)
        except Exception:
            pass

        # Ø§Ø®ØªØµØ§Ø± Enter/Return Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
        try:
            QtWidgets.QShortcut(QtGui.QKeySequence("Return"), self, activated=self._print)
            QtWidgets.QShortcut(QtGui.QKeySequence("Enter"), self, activated=self._print)
        except Exception:
            pass
        # Ø§Ø®ØªØµØ§Ø± Ctrl+S Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµØ±Ø§Ø­Ø©Ù‹
        try:
            QtWidgets.QShortcut(QtGui.QKeySequence("Ctrl+S"), self, activated=self._explicit_save_settings)
        except Exception:
            pass

        # ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ù‹Ø§
        try:
            self.preview.updatePreview()
        except Exception:
            pass
        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ø¤Ø¬Ù‘Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        try:
            QtCore.QTimer.singleShot(0, self.preview.updatePreview)
        except Exception:
            pass

    # ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    def closeEvent(self, e):
        try:
            self._save_settings()
        except Exception:
            pass
        try:
            # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØµÙ†Ù Ø§Ù„Ø£Ø¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„Ø¶Ù…Ø§Ù† ØªÙ†ÙÙŠØ° Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ
            super().closeEvent(e)
        except Exception:
            try:
                e.accept()
            except Exception:
                pass

    # Ø¶ÙÙ…ÙÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    def showEvent(self, e):
        try:
            super().showEvent(e)
        except Exception:
            pass
        try:
            self.preview.updatePreview()
        except Exception:
            pass

    def _delete_selected_guarantees(self):
        """ÙŠØ­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†/Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† (g_no).
        ÙŠØ´Ù…Ù„ Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©ØŒ Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¥Ù† Ø£Ù…ÙƒÙ†.
        """
        try:
            parent = getattr(self, 'parent', None)
            if parent is None or not hasattr(parent, '_selected_gnos'):
                try:
                    _status(self, "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.", 2500)
                except Exception:
                    pass
                return
            gnos = list(parent._selected_gnos())
            if not gnos:
                try:
                    _status(self, "Ù…Ù† ÙØ¶Ù„Ùƒ Ø­Ø¯Ù‘Ø¯ ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.", 2500)
                except Exception:
                    pass
                return
            # ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
            try:
                sample = "\n".join(str(g) for g in gnos[:8])
                msg = ("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n\n" + sample) if sample else "Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù."
                ret = QtWidgets.QMessageBox.question(
                    self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", msg,
                    QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
                    QtWidgets.QMessageBox.No
                )
                if ret != QtWidgets.QMessageBox.Yes:
                    return
            except Exception:
                pass

            # ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            deleted = 0
            try:
                conn = connect_db(); c = conn.cursor()
                # Ø§Ø­Ø°Ù Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª)
                try:
                    for g in gnos:
                        gkey = normalize_gno(str(g or ""))
                        try:
                            rows = c.execute("SELECT id, path FROM attachments WHERE g_no=?", (gkey,)).fetchall()
                        except Exception:
                            rows = []
                        for rid, p in rows:
                            # Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„
                            try:
                                c.execute("DELETE FROM attachments WHERE id=?", (rid,))
                            except Exception:
                                pass
                            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙØ¹Ù„ÙŠ
                            try:
                                ap = resolve_attachment_path(p)
                                from pathlib import Path as _P
                                _P(ap).unlink(missing_ok=True)
                            except Exception:
                                pass
                except Exception:
                    pass
                # Ø«Ù… Ø§Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª
                try:
                    for g in gnos:
                        gkey = normalize_gno(str(g or ""))
                        if not gkey:
                            continue
                        c.execute("DELETE FROM guarantees WHERE g_no=?", (gkey,))
                        try:
                            deleted += int(c.rowcount or 0)
                        except Exception:
                            pass
                except Exception as e:
                    try:
                        QtWidgets.QMessageBox.warning(self, "Ø­Ø°Ù", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù: {e}")
                    except Exception:
                        pass
                try:
                    conn.commit(); conn.close()
                except Exception:
                    pass
            except Exception as e:
                try:
                    QtWidgets.QMessageBox.critical(self, "Ø­Ø°Ù", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: {e}")
                except Exception:
                    pass

            # Ø­Ø¯Ù‘Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
            try:
                if hasattr(parent, 'refresh'):
                    parent.refresh()
            except Exception:
                pass
            try:
                QtWidgets.QMessageBox.information(self, "ØªÙ…", f"ØªÙ… Ø­Ø°Ù {deleted} Ø³Ø¬Ù„(Ø§Øª).")
            except Exception:
                pass
            # Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            try:
                self.preview.updatePreview()
            except Exception:
                pass
        except Exception:
            pass


    def _mm_to_points(self, mm):
        return mm * 72.0 / 25.4

    def _cm_to_points(self, cm):
        # 1 inch = 2.54 cm, 1 point = 1/72 inch
        try:
            return float(cm) * 72.0 / 2.54
        except Exception:
            return 0.0

    def _load_settings(self):
        s = QtCore.QSettings("GuaranteesApp", "Print")
        # Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ØµÙØ­Ø©/ØªØ¨ÙˆÙŠØ¨ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ù„Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        try:
            gkey = self._settings_group_key()
            s.beginGroup(gkey)
            # Ø¥Ù† Ù„Ù… Ù†Ø¬Ø¯ Ù‚ÙŠÙ…Ø§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ø³Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© Ù‚Ø¯ÙŠÙ… ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ…ØŒ Ø«Ù… Ø§Ø±ØªØ¯Ù‘ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            try:
                if not s.childKeys():
                    s.endGroup()
                    try:
                        import unicodedata
                        # Ø·Ø¨Ø¹ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø¨Ø§Ø¯Ø¦Ø© page_
                        target = gkey[5:] if gkey.startswith("page_") else gkey
                        def _norm(txt):
                            t = (txt or "")
                            try:
                                t = unicodedata.normalize('NFKC', t)
                            except Exception:
                                pass
                            # Ø£Ø²Ù„ Ø¨Ø§Ø¯Ø¦Ø© page_
                            if t.startswith("page_"):
                                t = t[5:]
                            # Ø§Ø­Ø°Ù Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„ØºØ§ÙŠØ§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±
                            try:
                                t = "".join(ch for ch in t if unicodedata.category(ch)[0] not in ('P','N'))
                            except Exception:
                                pass
                            return t
                        # Ø¬Ø±Ù‘Ø¨ Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠØ¹
                        for grp in s.childGroups():
                            try:
                                if _norm(grp) == _norm(target):
                                    s.beginGroup(grp)
                                    if s.childKeys():
                                        break
                                    else:
                                        s.endGroup()
                            except Exception:
                                pass
                    except Exception:
                        pass
                    # Ø¥Ù† Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø°Ù„ÙƒØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    try:
                        if not s.childKeys():
                            s.beginGroup("page_default")
                    except Exception:
                        s.beginGroup("page_default")
            except Exception:
                pass
        except Exception:
            pass
        # Ø§Ø¶Ø¨Ø· Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¨Ø£Ù…Ø§Ù† Ù„ØªØ¬Ù†Ù‘Ø¨ Ø­Ø§Ù„Ø© "Ø¨Ù„Ø§ Ø§Ø®ØªÙŠØ§Ø±" Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ø­Ù‚Ù„Ø§Ù‹ ÙØ§Ø±ØºÙ‹Ø§
        def _safe_set_combo_index(combo: QtWidgets.QComboBox, idx: int, default: int = 0):
            try:
                ci = int(idx)
            except Exception:
                ci = int(default)
            try:
                if ci < 0 or ci >= combo.count():
                    ci = int(default)
                combo.setCurrentIndex(ci)
            except Exception:
                try:
                    combo.setCurrentIndex(int(default))
                except Exception:
                    pass

        _safe_set_combo_index(self.cmb_size, s.value("size_idx", 0, int), 0)
        # Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£ÙÙ‚ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© Ù…Ø­ÙÙˆØ¸Ø©
        _safe_set_combo_index(self.cmb_orient, s.value("orient_idx", 1, int), 1)
        # ÙˆØ¶Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£Ù„ÙˆØ§Ù†
        try:
            _safe_set_combo_index(self.cmb_color_mode, s.value("color_mode_idx", 0, int), 0)
        except Exception:
            pass
        # ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ ÙˆØ¥Ù„ØºØ§Ø¡ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        # ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (Ù…Ø¤Ø´Ø± 2) Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        _safe_set_combo_index(self.cmb_scale_mode, s.value("scale_mode", 2, int), 2)
        # Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 70%
        try:
            _pct = int(s.value("scale_pct", 70, int))
        except Exception:
            _pct = 70
        try:
            if _pct == 92:
                _pct = 85
                s.setValue("scale_pct", _pct)
        except Exception:
            pass
        self.sp_scale.setValue(_pct)
        self.sp_font_scale.setValue(s.value("font_scale", 100, int))
        self.sp_border.setValue(s.value("border_pt", 0.5, float))
        _safe_set_combo_index(self.cmb_style, s.value("style_mode", 2, int), 2)
        self.chk_print_bg.setChecked(s.value("print_bg", False, bool))
        self.chk_white_text.setChecked(s.value("text_white", False, bool))
        self.chk_repeat_header.setChecked(s.value("repeat_header", True, bool))
        # Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª
        try:
            self.sp_from_page.setValue(s.value("page_from", 1, int))
            self.sp_to_page.setValue(s.value("page_to", 9999, int))
        except Exception:
            self.sp_from_page.setValue(1)
            self.sp_to_page.setValue(9999)
        try:
            self.chk_current_page.setChecked(s.value("current_page_only", False, bool))
        except Exception:
            self.chk_current_page.setChecked(False)
        # Ø§Ø¬Ø¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ÙØ¹Ù‘Ù„Ù‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†ÙØ³ Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        self.chk_snapshot.setChecked(s.value("snapshot_mode", True, bool))
        self.chk_direct_print.setChecked(s.value("direct_print", True, bool))
        # ØªØ­Ù…ÙŠÙ„ Ù†ØµÙˆØµ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ÙŠÙ…ÙŠÙ†/ÙˆØ³Ø·/ÙŠØ³Ø§Ø±
        try:
            self.ed_header_right.setText(s.value("header_right", "{date}"))
            self.ed_header_center.setText(s.value("header_center", "{title}"))
            self.ed_header_left.setText(s.value("header_left", "ØµÙØ­Ø© {page} Ù…Ù† {pages}"))
        except Exception:
            pass
        self.ed_footer.setText(s.value("footer", "ØµÙØ­Ø© {page} Ù…Ù† {pages}"))
        # Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ù‡ÙŠØ¯Ø±
        try:
            self.sp_header_size.setValue(int(s.value("header_pt", 12)))
        except Exception:
            self.sp_header_size.setValue(12)
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø«Ø§Ø¨Øª 8 Ù†Ù‚Ø§Ø·
        try:
            self.sp_col_header_size.setValue(8)
        except Exception:
            self.sp_col_header_size.setValue(8)
        try:
            self.chk_col_header_bold.setChecked(s.value("col_header_bold", False, bool))
        except Exception:
            self.chk_col_header_bold.setChecked(False)
        # Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© %
        try:
            self.sp_col_header_row_height_pct.setValue(float(s.value("col_header_row_pct", 100.0)))
        except Exception:
            self.sp_col_header_row_height_pct.setValue(100.0)
        self.chk_use_filter_dept.setChecked(s.value("use_filter_dept", True, bool))
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        try:
            self.chk_use_main_widths.setChecked(s.value("use_main_widths", True, bool))
        except Exception:
            self.chk_use_main_widths.setChecked(True)
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ
        try:
            self.chk_props_footer.setChecked(s.value("props_footer_enabled", True, bool))
        except Exception:
            self.chk_props_footer.setChecked(True)
        try:
            self.sp_props_row_h.setValue(int(s.value("props_row_h", 90)))
        except Exception:
            self.sp_props_row_h.setValue(90)
        # ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø· Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
        try:
            self.sp_props_font_pt.setValue(int(s.value("props_font_pt", 8)))
        except Exception:
            self.sp_props_font_pt.setValue(8)
        try:
            self.chk_props_bold_values.setChecked(s.value("props_bold_values", True, bool))
        except Exception:
            self.chk_props_bold_values.setChecked(True)
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ (Ø³Ù…) Ù…Ø¹ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·
        try:
            _gap_cm_raw = s.value("props_gap_cm", None)
            gap_cm = float(_gap_cm_raw) if _gap_cm_raw is not None else None
        except Exception:
            gap_cm = None
        if gap_cm is None:
            # ØªØ±Ø­ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù† ÙˆØ¬Ø¯
            try:
                old_points = float(s.value("props_gap", 80))
            except Exception:
                old_points = 80.0
            gap_cm = (old_points / 72.0) * 2.54
            try:
                s.setValue("props_gap_cm", gap_cm)
            except Exception:
                pass
        try:
            self.sp_props_gap.setValue(gap_cm)
        except Exception:
            self.sp_props_gap.setValue(2.80)
        # ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
        try:
            self.sp_props_width_pct.setValue(float(s.value("props_width_pct", 42.0)))
        except Exception:
            self.sp_props_width_pct.setValue(42.0)
        # ØªØ±Ù‚ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ 42 Ø¥Ù† ÙƒØ§Ù† Ù…Ø§ Ø²Ø§Ù„ 38
        try:
            if float(self.sp_props_width_pct.value()) == 38.0:
                self.sp_props_width_pct.setValue(42.0)
        except Exception:
            pass
        # ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ¶Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
        try:
            align_txt = s.value("props_align", "ÙŠÙ…ÙŠÙ†", str)
            if align_txt not in ("ÙŠÙ…ÙŠÙ†", "ÙŠØ³Ø§Ø±", "Ù…Ù†ØªØµÙ"):
                align_txt = "ÙŠÙ…ÙŠÙ†"
            self.cmb_props_align.setCurrentText(align_txt)
        except Exception:
            try:
                self.cmb_props_align.setCurrentText("ÙŠÙ…ÙŠÙ†")
            except Exception:
                pass
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø£ÙÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© (Ø³Ù…)
        try:
            _off = s.value("props_horz_offset_cm", 10.00)
            self.sp_props_offset_cm.setValue(float(_off))
        except Exception:
            try:
                self.sp_props_offset_cm.setValue(10.00)
            except Exception:
                pass
        try:
            self.chk_props_footer_single_page.setChecked(s.value("props_footer_single_page", False, bool))
        except Exception:
            self.chk_props_footer_single_page.setChecked(False)
        # ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        try:
            self.chk_total_per_page.setChecked(s.value("total_per_page", True, bool))
        except Exception:
            self.chk_total_per_page.setChecked(False)
        try:
            self.chk_total_overall.setChecked(s.value("total_overall", True, bool))
        except Exception:
            self.chk_total_overall.setChecked(True)
        try:
            total_sel_json = s.value("total_cols_sel", "", str)
            if total_sel_json and isinstance(self.cmb_total_cols, QtWidgets.QListWidget):
                names = json.loads(total_sel_json)
                if isinstance(names, list):
                    name_set = set(names)
                    for i in range(self.cmb_total_cols.count()):
                        it = self.cmb_total_cols.item(i)
                        it.setSelected(it.text() in name_set)
        except Exception:
            pass
        try:
            self.sp_total_row_h.setValue(int(s.value("total_row_h", 28)))
        except Exception:
            self.sp_total_row_h.setValue(28)
        try:
            self.sp_total_page_font_pt.setValue(int(s.value("total_page_font_pt", 9)))
        except Exception:
            self.sp_total_page_font_pt.setValue(9)
        try:
            self.sp_total_font_pt.setValue(int(s.value("total_font_pt", 10)))
        except Exception:
            self.sp_total_font_pt.setValue(10)
        try:
            self.sp_total_offset_cm.setValue(float(s.value("total_offset_cm", 0.50)))
        except Exception:
            self.sp_total_offset_cm.setValue(0.50)
        try:
            self.chk_total_box.setChecked(s.value("total_box", True, bool))
        except Exception:
            self.chk_total_box.setChecked(True)
        # Ù†Ø³Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ ÙˆØ­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        try:
            self.sp_row_height_pct.setValue(float(s.value("row_height_pct", 100.0)))
        except Exception:
            self.sp_row_height_pct.setValue(100.0)
        try:
            self.sp_col_width_pct.setValue(float(s.value("col_width_pct", 100.0)))
        except Exception:
            self.sp_col_width_pct.setValue(100.0)
        try:
            self.sp_table_spacing.setValue(float(s.value("table_spacing", 20.0)))
        except Exception:
            self.sp_table_spacing.setValue(20.0)
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø§Ù‚Ø³Ø§Ù…)
        try:
            self.sp_bank_sum_row_h.setValue(int(s.value("dept_sum_row_h", 32)))
        except Exception:
            self.sp_bank_sum_row_h.setValue(32)
        try:
            self.chk_bank_sum_visible.setChecked(s.value("dept_sum_visible", True, bool))
        except Exception:
            self.chk_bank_sum_visible.setChecked(True)
        try:
            self.sp_bank_sum_width_pct.setValue(float(s.value("dept_sum_width_pct", 90.0)))
        except Exception:
            self.sp_bank_sum_width_pct.setValue(90.0)
        try:
            self.sp_bank_sum_bank_pct.setValue(float(s.value("dept_sum_bank_pct", 52.0)))
        except Exception:
            self.sp_bank_sum_bank_pct.setValue(52.0)
        try:
            self.sp_bank_sum_num_pct.setValue(float(s.value("dept_sum_num_pct", 12.0)))
        except Exception:
            self.sp_bank_sum_num_pct.setValue(12.0)
        try:
            self.sp_bank_sum_hdr_pt.setValue(int(s.value("dept_sum_hdr_pt", 10)))
        except Exception:
            self.sp_bank_sum_hdr_pt.setValue(10)
        try:
            self.sp_bank_sum_row_pt.setValue(int(s.value("dept_sum_row_pt", 9)))
        except Exception:
            self.sp_bank_sum_row_pt.setValue(9)
        try:
            self.chk_bank_sum_zebra.setChecked(s.value("dept_sum_zebra", True, bool))
        except Exception:
            self.chk_bank_sum_zebra.setChecked(True)
        try:
            self.chk_bank_sum_auto.setChecked(s.value("dept_sum_auto", True, bool))
        except Exception:
            self.chk_bank_sum_auto.setChecked(True)
        try:
            self.cmb_bank_sum_align.setCurrentText(s.value("dept_sum_align", "Ù…Ù†ØªØµÙ", str))
        except Exception:
            self.cmb_bank_sum_align.setCurrentText("Ù…Ù†ØªØµÙ")
        try:
            self.sp_bank_sum_offset_cm.setValue(float(s.value("dept_sum_offset_cm", 0.00)))
        except Exception:
            self.sp_bank_sum_offset_cm.setValue(0.00)
        try:
            self.sp_bank_sum_gap.setValue(float(s.value("dept_sum_gap_cm", 1.50)))
        except Exception:
            self.sp_bank_sum_gap.setValue(1.50)
        try:
            self.sp_cash_title_offset_cm.setValue(float(s.value("cash_title_offset_cm", 4.00)))
        except Exception:
            self.sp_cash_title_offset_cm.setValue(4.00)
        # ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø¨ Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
        try:
            cols_scale_map_json = s.value("cols_scale_map", "", str)
            if cols_scale_map_json and getattr(self, 'tbl_col_scales', None):
                mp = json.loads(cols_scale_map_json)
                if isinstance(mp, dict):
                    for i in range(self.tbl_col_scales.rowCount()):
                        it = self.tbl_col_scales.item(i, 0)
                        sb = self.tbl_col_scales.cellWidget(i, 1)
                        if it is not None and sb is not None:
                            nm = self._norm_header(it.text())
                            if nm in mp:
                                try:
                                    sb.setValue(float(mp[nm]))
                                except Exception:
                                    pass
        except Exception:
            pass
        # Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        # Ù†ÙØ¶Ù‘Ù„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŒ Ø«Ù… Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        # Ù†Ø·Ø¨Ù‚ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        try:
            self._match_visible_main_by_name()
        except Exception:
            try:
                self._match_visible()
            except Exception:
                pass

        # Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙŠ ØªØ¨Ù‚Ù‰ Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        try:
            checked_names = []
            for i in range(self.list_cols.count()):
                it = self.list_cols.item(i)
                if it.checkState() == QtCore.Qt.Checked:
                    checked_names.append(it.text())
            s.setValue("print_checked_cols", json.dumps(checked_names, ensure_ascii=False))
        except Exception:
            pass

        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© (ÙŠÙØ­Ù…Ù‘Ù„ Ù…Ù† Main Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø©)
        try:
            s2 = QtCore.QSettings("GuaranteesApp", "Main")
            # Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ù…ÙØ¹Ù‘Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§
            self.wm_enabled.setChecked(bool(int(s2.value("watermark/enabled", 1) or 1)))
            wm_path_val = s2.value("watermark/path", type=str) or ""
            # Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³Ø§Ø± Ù…Ø­Ø¯Ø¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯Ù…Ø¬
            if not wm_path_val:
                wm_path_val = ":/assets/watermark.png"
            self.wm_path.setText(wm_path_val)
            try:
                self.wm_opacity.setValue(float(s2.value("watermark/opacity", 0.20) or 0.20))
            except Exception:
                self.wm_opacity.setValue(0.20)
            try:
                self.wm_scale.setValue(float(s2.value("watermark/scale", 0.40) or 0.40))
            except Exception:
                self.wm_scale.setValue(0.40)
            # ÙØ±Ø¶ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            try:
                self.wm_enabled.setChecked(True)
            except Exception:
                pass
        except Exception:
            # Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©
            self.wm_enabled.setChecked(True)
            self.wm_path.setText(":/assets/watermark.png")
            self.wm_opacity.setValue(0.10)
            self.wm_scale.setValue(0.40)
        # Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        try:
            s.endGroup()
        except Exception:
            pass

    def _save_settings(self):
        s = QtCore.QSettings("GuaranteesApp", "Print")
        # Ø®Ø²Ù‘Ù† Ø§Ù„Ù‚ÙŠÙ… Ø¶Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ØµÙØ­Ø©/ØªØ¨ÙˆÙŠØ¨ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ‚Ù„Ø§Ù„
        try:
            gkey = self._settings_group_key()
            s.beginGroup(gkey)
        except Exception:
            pass
        s.setValue("size_idx", self.cmb_size.currentIndex())
        s.setValue("orient_idx", self.cmb_orient.currentIndex())
        s.setValue("scale_mode", self.cmb_scale_mode.currentIndex())
        s.setValue("scale_pct", self.sp_scale.value())
        s.setValue("font_scale", self.sp_font_scale.value())
        s.setValue("border_pt", self.sp_border.value())
        s.setValue("style_mode", self.cmb_style.currentIndex())
        try:
            s.setValue("color_mode_idx", int(self.cmb_color_mode.currentIndex()))
        except Exception:
            pass
        s.setValue("print_bg", self.chk_print_bg.isChecked())
        s.setValue("text_white", self.chk_white_text.isChecked())
        s.setValue("repeat_header", self.chk_repeat_header.isChecked())
        s.setValue("snapshot_mode", self.chk_snapshot.isChecked())
        s.setValue("direct_print", self.chk_direct_print.isChecked())
        # Ø­ÙØ¸ Ù†ØµÙˆØµ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙŠÙ…ÙŠÙ†/ÙˆØ³Ø·/ÙŠØ³Ø§Ø± ÙˆØ§Ù„ØªØ°ÙŠÙŠÙ„
        s.setValue("header_right", self.ed_header_right.text())
        s.setValue("header_center", self.ed_header_center.text())
        s.setValue("header_left", self.ed_header_left.text())
        s.setValue("footer", self.ed_footer.text())
        # Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª
        s.setValue("page_from", int(self.sp_from_page.value()))
        s.setValue("page_to", int(self.sp_to_page.value()))
        try:
            s.setValue("current_page_only", bool(self.chk_current_page.isChecked()))
        except Exception:
            pass
        # Ø­ÙØ¸ Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ù‡ÙŠØ¯Ø±
        s.setValue("header_pt", int(self.sp_header_size.value()))
        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        try:
            s.setValue("col_header_pt", int(self.sp_col_header_size.value()))
        except Exception:
            pass
        try:
            s.setValue("col_header_bold", bool(self.chk_col_header_bold.isChecked()))
        except Exception:
            pass
        try:
            s.setValue("col_header_row_pct", float(self.sp_col_header_row_height_pct.value()))
        except Exception:
            pass
        s.setValue("use_filter_dept", self.chk_use_filter_dept.isChecked())
        s.setValue("use_main_widths", self.chk_use_main_widths.isChecked())
        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ
        try:
            s.setValue("props_footer_enabled", bool(self.chk_props_footer.isChecked()))
        except Exception:
            pass
        try:
            s.setValue("props_row_h", int(self.sp_props_row_h.value()))
        except Exception:
            pass
        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø· Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
        try:
            s.setValue("props_font_pt", int(self.sp_props_font_pt.value()))
        except Exception:
            pass
        try:
            s.setValue("props_bold_values", bool(self.chk_props_bold_values.isChecked()))
        except Exception:
            pass
        try:
            s.setValue("props_gap_cm", float(self.sp_props_gap.value()))
        except Exception:
            pass
        try:
            s.setValue("props_width_pct", float(self.sp_props_width_pct.value()))
        except Exception:
            pass
        try:
            s.setValue("props_align", str(self.cmb_props_align.currentText()))
        except Exception:
            pass
        try:
            s.setValue("props_horz_offset_cm", float(self.sp_props_offset_cm.value()))
        except Exception:
            pass
        try:
            s.setValue("props_footer_single_page", bool(self.chk_props_footer_single_page.isChecked()))
        except Exception:
            pass
        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        try:
            s.setValue("total_per_page", bool(self.chk_total_per_page.isChecked()))
        except Exception:
            pass
        try:
            s.setValue("total_overall", bool(self.chk_total_overall.isChecked()))
        except Exception:
            pass
        try:
            tot_names = [it.text() for it in self.cmb_total_cols.selectedItems()] if hasattr(self, 'cmb_total_cols') else []
            s.setValue("total_cols_sel", json.dumps(tot_names, ensure_ascii=False))
        except Exception:
            pass
        try:
            s.setValue("total_row_h", int(self.sp_total_row_h.value()))
        except Exception:
            pass
        try:
            s.setValue("total_page_font_pt", int(self.sp_total_page_font_pt.value()))
        except Exception:
            pass
        try:
            s.setValue("total_font_pt", int(self.sp_total_font_pt.value()))
        except Exception:
            pass
        try:
            s.setValue("total_offset_cm", float(self.sp_total_offset_cm.value()))
        except Exception:
            pass
        try:
            s.setValue("total_box", bool(self.chk_total_box.isChecked()))
        except Exception:
            pass
        # Ø­ÙØ¸ Ù†Ø³Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ ÙˆØ­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        try:
            s.setValue("row_height_pct", float(self.sp_row_height_pct.value()))
        except Exception:
            pass
        try:
            s.setValue("col_width_pct", float(self.sp_col_width_pct.value()))
        except Exception:
            pass
        try:
            s.setValue("table_spacing", float(self.sp_table_spacing.value()))
        except Exception:
            pass
        # Ø­ÙØ¸ Ù†Ø³Ø¨ Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯
        try:
            mp = {}
            if getattr(self, 'tbl_col_scales', None):
                for i in range(self.tbl_col_scales.rowCount()):
                    it = self.tbl_col_scales.item(i, 0)
                    sb = self.tbl_col_scales.cellWidget(i, 1)
                    if it is not None and sb is not None:
                        nm = self._norm_header(it.text())
                        mp[nm] = float(sb.value())
            s.setValue("cols_scale_map", json.dumps(mp, ensure_ascii=False))
        except Exception:
            pass
        # Ø­ÙØ¸ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø«Ø¨Ø§Øª Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        try:
            checked_names = []
            for i in range(self.list_cols.count()):
                it = self.list_cols.item(i)
                if it.checkState() == QtCore.Qt.Checked:
                    checked_names.append(it.text())
            s.setValue("print_checked_cols", json.dumps(checked_names, ensure_ascii=False))
        except Exception:
            pass

        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ÙÙŠ Main Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        try:
            s2 = QtCore.QSettings("GuaranteesApp", "Main")
            s2.setValue("watermark/enabled", 1 if self.wm_enabled.isChecked() else 0)
            s2.setValue("watermark/path", self.wm_path.text().strip())
            s2.setValue("watermark/opacity", float(self.wm_opacity.value()))
            s2.setValue("watermark/scale", float(self.wm_scale.value()))
        except Exception:
            pass
        # Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø§Ù‚Ø³Ø§Ù…)
        try:
            s.setValue("dept_sum_row_h", int(self.sp_bank_sum_row_h.value()))
            s.setValue("dept_sum_visible", bool(self.chk_bank_sum_visible.isChecked()))
            s.setValue("dept_sum_width_pct", float(self.sp_bank_sum_width_pct.value()))
            s.setValue("dept_sum_bank_pct", float(self.sp_bank_sum_bank_pct.value()))
            s.setValue("dept_sum_num_pct", float(self.sp_bank_sum_num_pct.value()))
            s.setValue("dept_sum_hdr_pt", int(self.sp_bank_sum_hdr_pt.value()))
            s.setValue("dept_sum_row_pt", int(self.sp_bank_sum_row_pt.value()))
            s.setValue("dept_sum_zebra", bool(self.chk_bank_sum_zebra.isChecked()))
            s.setValue("dept_sum_auto", bool(self.chk_bank_sum_auto.isChecked()))
            s.setValue("dept_sum_align", str(self.cmb_bank_sum_align.currentText()))
            s.setValue("dept_sum_offset_cm", float(self.sp_bank_sum_offset_cm.value()))
            s.setValue("dept_sum_gap_cm", float(self.sp_bank_sum_gap.value()))
        except Exception:
            pass
        try:
            s.setValue("cash_title_offset_cm", float(self.sp_cash_title_offset_cm.value()))
        except Exception:
            pass
        # Ø§Ù†Ø³Ø® Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªÙŠ Ø­ÙÙØ¸Øª Ù„Ù„ØªÙˆ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ÙŠÙƒÙˆÙ† Ø£Ø³Ø§Ø³Ù‹Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        try:
            keys = s.childKeys(); vals = {}
            for k in keys:
                try: vals[k] = s.value(k)
                except Exception: pass
            # Ø§Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ÙŠÙƒÙˆÙ† Ù…Ø±Ø¬Ø¹Ù‹Ø§ Ø¹Ø§Ù…Ù‘Ù‹Ø§
            s.endGroup(); s.beginGroup("page_default")
            for k, v in vals.items():
                try: s.setValue(k, v)
                except Exception: pass
        except Exception:
            try: s.endGroup()
            except Exception: pass
        # Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©)
        try:
            s.endGroup()
        except Exception:
            pass
        # ØªØ£ÙƒÙŠØ¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ù‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²Ù†
        try:
            s.sync()
        except Exception:
            pass

    def _explicit_save_settings(self):
        """ÙŠØ­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙˆÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…."""
        try:
            self._save_settings()
        except Exception:
            # Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØŒ Ù†Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù„Ø·ÙŠÙ
            try:
                _status(self, "ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.", 2500)
            except Exception:
                pass
            return
        # Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­
        try:
            gkey = "page_default"
            try:
                gkey = self._settings_group_key()
            except Exception:
                pass
            QtWidgets.QMessageBox.information(self, "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", f"ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¶Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: {gkey}.")
        except Exception:
            pass

    def _insert_macro(self, macro: str):
        try:
            fw = QtWidgets.QApplication.focusWidget()
            target = None
            # Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ØªØºÙŠÙ‘Ø± ÙÙŠ Ø®Ø§Ù†Ø© QLineEdit Ø§Ù„Ù†Ø´Ø·Ø© Ø¥Ù† ÙƒØ§Ù†Øª Ø¶Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ø£Ø³/Ø§Ù„ØªØ°ÙŠÙŠÙ„
            if isinstance(fw, QtWidgets.QLineEdit) and fw in [
                getattr(self, 'ed_header_right', None),
                getattr(self, 'ed_header_center', None),
                getattr(self, 'ed_header_left', None),
                getattr(self, 'ed_footer', None)
            ]:
                target = fw
            else:
                # Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ø®Ø§Ù†Ø© Ù†Øµ Ù†Ø´Ø·Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ù†Ø© ÙˆØ³Ø· Ø§Ù„Ù‡ÙŠØ¯Ø± ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
                target = getattr(self, 'ed_header_center', None)
                try:
                    if target:
                        target.setFocus()
                except Exception:
                    pass
            if target:
                target.insert(macro or "")
            try:
                self.preview.updatePreview()
            except Exception:
                pass
            try:
                self._save_settings()
            except Exception:
                pass
        except Exception:
            pass

    def _fmt_text(self, text, page=1, pages=1):
        # Ø¹Ù†ÙˆØ§Ù† ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙØªÙˆØ­
        try:
            title = self._current_filter_title()
        except Exception:
            # Ø§Ø±ØªØ¯Ø§Ø¯ Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©/Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            title = "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
            try:
                if getattr(self.parent, 'tabs', None):
                    title = self.parent.tabs.tabText(self.parent.tabs.currentIndex()) or title
                elif hasattr(self.parent, "windowTitle"):
                    title = self.parent.windowTitle() or title
            except Exception:
                try:
                    title = self.parent.windowTitle()
                except Exception:
                    title = "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
        today = QtCore.QDate.currentDate().toString("yyyy-MM-dd")
        now_time = QtCore.QTime.currentTime().toString("HH:mm")
        dept = ""
        if self.chk_use_filter_dept.isChecked():
            try:
                dept = self.parent.cmb_dept.currentText()
            except Exception:
                dept = ""
        return (text or "").replace("{date}", today).replace("{time}", now_time).replace("{title}", title) \
            .replace("{dept}", dept).replace("{page}", str(page)).replace("{pages}", str(pages))

    def _settings_group_key(self) -> str:
        """ÙŠØ±Ø¬Ø¹ Ù…ÙØªØ§Ø­Ù‹Ø§ ÙØ±ÙŠØ¯Ù‹Ø§ Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ÙˆØ§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©.
        Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„ ÙƒÙ„ ØªØ¨ÙˆÙŠØ¨/ÙÙ„ØªØ± ÙŠØ­ØªÙØ¸ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡ Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø©.
        """
        parent = getattr(self, 'parent', None)
        parts = []
        
        # 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        tab_name = "main"
        try:
            if parent and getattr(parent, 'tabs', None):
                current_widget = parent.tabs.currentWidget()
                if current_widget is getattr(parent, '_bank_detailed_tab_widget', None):
                    tab_name = "bank_detailed"
                elif current_widget is getattr(parent, '_dept_report_tab_widget', None):
                    tab_name = "dept_report"
                elif current_widget is getattr(parent, '_dept_matrix_tab_widget', None):
                    tab_name = "dept_matrix"
                elif current_widget is getattr(parent, '_kpis_tab_widget', None):
                    tab_name = "kpis"
                elif current_widget is getattr(parent, '_bank_limits_tab_widget', None):
                    tab_name = "bank_limits"
                else:
                    tab_name = "main"
        except Exception:
            tab_name = "main"
        parts.append(tab_name)
        
        # 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© (ÙÙ‚Ø· Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
        if tab_name == "main":
            def _txt(name):
                w = getattr(parent, name, None)
                try:
                    return str(w.currentText()).strip()
                except Exception:
                    return ""
            
            dept = _txt('cmb_dept')
            if dept and dept != 'Ø§Ù„ÙƒÙ„':
                # ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ…ÙØªØ§Ø­
                parts.append(f"d_{dept.replace(' ', '_')}")
            
            bank = _txt('cmb_bank')
            if bank and bank != 'Ø§Ù„ÙƒÙ„':
                parts.append(f"b_{bank.replace(' ', '_')}")
            
            status = _txt('cmb_status')
            if status and status != 'Ø§Ù„ÙƒÙ„':
                parts.append(f"s_{status.replace(' ', '_')}")
            
            gtype = _txt('cmb_gtype')
            if gtype and gtype != 'Ø§Ù„ÙƒÙ„':
                parts.append(f"t_{gtype.replace(' ', '_')}")
            
            cash = _txt('cmb_cash')
            if cash and cash != 'Ø§Ù„ÙƒÙ„':
                parts.append(f"c_{cash.replace(' ', '_')}")
        
        # 3. Ù„ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„ØŒ Ø£Ø¶Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
        elif tab_name == "bank_detailed":
            try:
                bf = getattr(parent, 'bank_detailed_filter', None)
                if bf:
                    bank = str(bf.currentText()).strip()
                    if bank and bank != 'Ø§Ù„ÙƒÙ„':
                        parts.append(f"b_{bank.replace(' ', '_')}")
            except Exception:
                pass
        
        # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        key = "_".join(parts) if parts else "page_default"
        return f"page_{key}"

    def _current_filter_title(self) -> str:
        """ÙŠØ¨Ù†ÙŠ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§ Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©Ø› Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ± ÙŠØ±Ø¬Ø¹ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨.
        Ù…Ø«Ø§Ù„: "Ø§Ù„Ù‚Ø³Ù…: Ø§Ù„Ù…Ø·Ø§Ø±Ø§Øª | Ø§Ù„Ø¨Ù†Ùƒ: Ø§Ù„Ø£Ù‡Ù„ÙŠ | Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ù†ØªÙ‡ÙŠ | Ø¨Ø­Ø«: Ø£Ø­Ù…Ø¯"
        """
        parent = getattr(self, 'parent', None)
        if not parent:
            return "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"

        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        tab_name = "main"
        try:
            if getattr(parent, 'tabs', None):
                current_widget = parent.tabs.currentWidget()
                if current_widget is getattr(parent, '_bank_detailed_tab_widget', None):
                    tab_name = "bank_detailed"
                elif current_widget is getattr(parent, '_dept_report_tab_widget', None):
                    tab_name = "dept_report"
                elif current_widget is getattr(parent, '_dept_matrix_tab_widget', None):
                    tab_name = "dept_matrix"
                elif current_widget is getattr(parent, '_kpis_tab_widget', None):
                    tab_name = "kpis"
                elif current_widget is getattr(parent, '_bank_limits_tab_widget', None):
                    tab_name = "bank_limits"
                else:
                    tab_name = "main"
        except Exception:
            tab_name = "main"

        parts = []
        
        def _txt(name):
            w = getattr(parent, name, None)
            if w is None:
                return ""
            try:
                if hasattr(w, 'currentText'):
                    return str(w.currentText()).strip()
                elif hasattr(w, 'text'):
                    return str(w.text()).strip()
            except Exception:
                pass
            return ""
        def _txt_ed(name):
            w = getattr(parent, name, None)
            if w is None:
                return ""
            try:
                if hasattr(w, 'text'):
                    return str(w.text()).strip()
            except Exception:
                pass
            return ""

        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
        if tab_name == "main":
            dept = _txt('cmb_dept');    dept = dept if dept and dept != 'Ø§Ù„ÙƒÙ„' else ""
            bank = _txt('cmb_bank');    bank = bank if bank and bank != 'Ø§Ù„ÙƒÙ„' else ""
            gtype = _txt('cmb_gtype');  gtype = gtype if gtype and gtype != 'Ø§Ù„ÙƒÙ„' else ""
            cash = _txt('cmb_cash');    cash = cash if cash and cash != 'Ø§Ù„ÙƒÙ„' else ""
            status = _txt('cmb_status');status = status if status and status != 'Ø§Ù„ÙƒÙ„' else ""
            search = _txt_ed('ed_search')
            
            if dept:   parts.append(f"Ø§Ù„Ù‚Ø³Ù…: {dept}")
            if bank:   parts.append(f"Ø§Ù„Ø¨Ù†Ùƒ: {bank}")
            if gtype:  parts.append(f"Ø§Ù„Ù†ÙˆØ¹: {gtype}")
            if cash:   parts.append(f"Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª: {cash}")
            if status: parts.append(f"Ø§Ù„Ø­Ø§Ù„Ø©: {status}")
            if search: parts.append(f"Ø¨Ø­Ø«: {search}")

        elif tab_name == "bank_detailed":
            try:
                bf = getattr(parent, 'bank_detailed_filter', None)
                bank = str(bf.currentText()).strip() if bf is not None and hasattr(bf, 'currentText') else ""
            except Exception:
                bank = ""
            if bank and bank != 'Ø§Ù„ÙƒÙ„':
                parts.append(f"Ø§Ù„Ø¨Ù†Ùƒ: {bank}")

        elif tab_name == "dept_matrix":
            try:
                bf = getattr(parent, 'dept_matrix_bank_filter', None)
                bn = str(bf.currentText()).strip() if bf is not None and hasattr(bf, 'currentText') else ""
            except Exception:
                bn = ""
            if bn and bn != 'Ø§Ù„ÙƒÙ„':
                parts.append(f"Ø§Ù„Ø¨Ù†Ùƒ: {bn}")

        title = " | ".join(parts)
        if title:
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„Ø§ØªØ± ÙˆØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡
            # ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©ØŒ Ù‚Ø¯ Ù†Ø±ØºØ¨ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ÙƒØ¨Ø§Ø¯Ø¦Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙƒØ§ÙÙŠÙ‹Ø§
            if tab_name == "bank_detailed":
                return f"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„ â€” {title}"
            elif tab_name == "dept_matrix":
                return f"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… â€” {title}"
            return title
            
        # Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ ÙÙ„Ø§ØªØ± Ø¸Ø§Ù‡Ø±Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ÙƒÙ„ ØªØ¨ÙˆÙŠØ¨
        if tab_name == "bank_detailed":
            return "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„"
        elif tab_name == "dept_matrix":
            return "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"
            
        # Ù„Ø§ ÙÙ„Ø§ØªØ±: Ø§Ø±Ø¬Ø¹ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨/Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        try:
            if getattr(parent, 'tabs', None):
                tab_text = parent.tabs.tabText(parent.tabs.currentIndex())
                if tab_text and tab_text.strip():
                    return tab_text.strip()
            if hasattr(parent, 'windowTitle'):
                win_title = parent.windowTitle()
                if win_title and win_title.strip():
                    return win_title.strip()
        except Exception:
            pass
        return "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"

    def _selected_columns(self, table=None):
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        is_bank_limits_tab = False
        try:
            if getattr(self.parent, "tabs", None) and getattr(self.parent, "_bank_limits_tab_widget", None):
                if self.parent.tabs.currentWidget() is self.parent._bank_limits_tab_widget:
                    if table is getattr(self.parent, 'bank_limits_table', None):
                        is_bank_limits_tab = True
        except Exception:
            pass
        
        # Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ± Ø¬Ø¯ÙˆÙ„ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù…Ù†Ù‡
        cols = []
        for i in range(self.list_cols.count()):
            it = self.list_cols.item(i)
            if it.checkState() == QtCore.Qt.Checked:
                cols.append(i)
        
        # Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ: Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø·
        if is_bank_limits_tab and table is not None:
            cols = []
            try:
                for c in range(table.columnCount()):
                    if not table.isColumnHidden(c):
                        cols.append(c)
            except Exception:
                cols = list(range(table.columnCount()))
            return cols
        
        # Ø¥Ù† ØªÙ… ØªÙ…Ø±ÙŠØ± Ø¬Ø¯ÙˆÙ„ØŒ Ù‚ÙŠÙ‘Ø¯ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¨Ù†Ø·Ø§Ù‚ Ø£Ø¹Ù…Ø¯ØªÙ‡ Ù„ØªÙØ§Ø¯ÙŠ ÙÙ‡Ø§Ø±Ø³ Ø®Ø§Ø±Ø¬ÙŠØ©
        try:
            if table is not None:
                cols = [c for c in cols if 0 <= int(c) < int(table.columnCount())]
                # Ø¥Ù† Ø®Ù„Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø¤ÙˆØ³
                if not cols:
                    try:
                        header = table.horizontalHeader()
                        order = sorted(range(table.columnCount()), key=lambda i: header.visualIndex(i))
                        cols = [i for i in order if not table.isColumnHidden(i)]
                    except Exception:
                        cols = list(range(table.columnCount()))
        except Exception:
            pass
        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ­Ø¯Ù‘ÙØ¯ Ø´ÙŠØ¡ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯ Ø£Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        if not cols:
            try:
                t = table if table is not None else getattr(self.parent, 'table', None)
                header = t.horizontalHeader()
                order = sorted(range(t.columnCount()), key=lambda i: header.visualIndex(i))
                cols = [i for i in order if not t.isColumnHidden(i)]
            except Exception:
                try:
                    t = table if table is not None else getattr(self.parent, 'table', None)
                    cols = list(range(t.columnCount()))
                except Exception:
                    cols = []
        # ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø¯ÙŠÙ„ ÙˆÙ…Ø¹ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø·Ø§Ø¨ÙÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        try:
            if self._table_override is not None and getattr(self, 'chk_use_main_widths', None) and self.chk_use_main_widths.isChecked():
                main_tbl = getattr(self.parent, 'table', None)
                cur_tbl = table if table is not None else self._table_override
                if main_tbl is not None and cur_tbl is not None:
                    hd = main_tbl.horizontalHeader()
                    order_main = sorted(range(main_tbl.columnCount()), key=lambda i: hd.visualIndex(i))
                    names_order = [self._norm_header(self._header_text(main_tbl, i)) for i in order_main if not main_tbl.isColumnHidden(i)]
                    name_to_idx_cur = {self._norm_header(self._header_text(cur_tbl, i)): i for i in range(cur_tbl.columnCount())}
                    matched = [name_to_idx_cur[n] for n in names_order if n in name_to_idx_cur]
                    if matched:
                        cols = matched
        except Exception:
            pass
        # Ø£Ø¹ÙØ¯ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØ·Ø§Ø¨Ù‚ ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        try:
            if getattr(self, 'chk_use_main_widths', None) and self.chk_use_main_widths.isChecked():
                main_tbl = getattr(self.parent, 'table', None)
                cur_tbl = table if table is not None else main_tbl
                if main_tbl is not None and cur_tbl is not None:
                    hd = main_tbl.horizontalHeader()
                    order_main = sorted(range(main_tbl.columnCount()), key=lambda i: hd.visualIndex(i))
                    names_order = [self._norm_header(self._header_text(main_tbl, i)) for i in order_main if not main_tbl.isColumnHidden(i)]
                    name_to_idx_cur = {self._norm_header(self._header_text(cur_tbl, i)): i for i in range(cur_tbl.columnCount())}
                    reordered = [name_to_idx_cur[n] for n in names_order if n in name_to_idx_cur and name_to_idx_cur[n] in cols]
                    if reordered:
                        cols = reordered
                    # Ù„Ùˆ ÙØ´Ù„ ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ØŒ Ù„Ø§ ØªØ¯Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©
                    if not cols:
                        cols = [i for i in range(cur_tbl.columnCount()) if not cur_tbl.isColumnHidden(i)] or list(range(cur_tbl.columnCount()))
        except Exception:
            pass
        return cols

    def _visible_column_names_checked(self):
        """ÙŠØ±Ø¬Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø§Ù„Ù…ÙÙØ¹Ù‘Ù„Ø©) ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©."""
        names = []
        try:
            for i in range(self.list_cols.count()):
                it = self.list_cols.item(i)
                if it.checkState() == QtCore.Qt.Checked:
                    names.append(it.text())
        except Exception:
            pass
        return names

    def _match_visible_main_by_name(self):
        """Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø§Ù„Ø§Ø³Ù…."""
        tbl_main = getattr(self.parent, 'table', None)
        if tbl_main is None:
            return
        name_visible = {}
        try:
            for ci in range(tbl_main.columnCount()):
                nm = self._norm_header(self._header_text(tbl_main, ci))
                name_visible[nm] = (not tbl_main.isColumnHidden(ci))
        except Exception:
            pass
        matched = 0
        for i in range(self.list_cols.count()):
            it = self.list_cols.item(i)
            nm = self._norm_header(it.text())
            vis = name_visible.get(nm, False)
            it.setCheckState(QtCore.Qt.Checked if vis else QtCore.Qt.Unchecked)
            if vis:
                matched += 1
        # Ø¥Ù† Ù„Ù… ÙŠÙØ·Ø§Ø¨Ù‚ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø¹ÙØ¯ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø­Ø³Ø¨ Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        if matched == 0:
            try:
                self._match_visible()
            except Exception:
                pass

    def _match_visible(self):
        """Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·."""
        tbl = getattr(self.parent, 'table', None)
        for i in range(self.list_cols.count()):
            try:
                vis = not tbl.isColumnHidden(i)
            except Exception:
                vis = True
            self.list_cols.item(i).setCheckState(QtCore.Qt.Checked if vis else QtCore.Qt.Unchecked)

    def _refresh_col_scales_from_selection(self):
        """Ø£Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù†Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª."""
        try:
            prev = {}
            if getattr(self, 'tbl_col_scales', None):
                for i in range(self.tbl_col_scales.rowCount()):
                    it = self.tbl_col_scales.item(i, 0)
                    sb = self.tbl_col_scales.cellWidget(i, 1)
                    if it is not None and sb is not None:
                        prev[self._norm_header(it.text())] = float(sb.value())
            names = self._visible_column_names_checked()
            self.tbl_col_scales.setRowCount(len(names))
            self._col_scale_spinboxes = []
            for i, h in enumerate(names):
                name_item = QtWidgets.QTableWidgetItem(h)
                name_item.setFlags(QtCore.Qt.ItemIsEnabled)
                self.tbl_col_scales.setItem(i, 0, name_item)
                sb = QtWidgets.QDoubleSpinBox(); sb.setRange(5.0, 2000.0); sb.setSingleStep(5.0); sb.setSuffix(" %")
                try:
                    sb.setValue(prev.get(self._norm_header(h), 100.0))
                except Exception:
                    sb.setValue(100.0)
                self.tbl_col_scales.setCellWidget(i, 1, sb)
                self._col_scale_spinboxes.append(sb)
            try:
                for sb in self._col_scale_spinboxes:
                    sb.valueChanged.connect(self.preview.updatePreview)
                    sb.valueChanged.connect(self._save_settings)
            except Exception:
                pass
            try:
                self.preview.updatePreview()
                self._save_settings()
            except Exception:
                pass
        except Exception:
            pass

    def _numeric_text_to_float(self, s):
        try:
            t = ("" if s is None else str(s)).translate(ARABIC_DIGITS).replace(",", "").strip()
            return float(t)
        except Exception:
            return None

    def _header_text(self, table, c):
        try:
            # QTableWidget path
            if hasattr(table, 'horizontalHeaderItem'):
                it = table.horizontalHeaderItem(c)
                if it and it.text():
                    return it.text()
            # QTableView path
            model = table.model() if hasattr(table, 'model') else None
            if model is not None:
                hd = model.headerData(c, QtCore.Qt.Horizontal, QtCore.Qt.DisplayRole)
                if hd is None:
                    hd = model.headerData(c, QtCore.Qt.Horizontal)
                if hd is not None:
                    return str(hd)
        except Exception:
            pass
        return f"Column {c + 1}"

    def _norm_header(self, name: str) -> str:
        # Ø·Ø¨Ù‘Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        s = ("" if name is None else str(name)).strip()
        if s.startswith("ØªØ§Ø±ÙŠØ® "):
            s = s[6:]
        aliases = {
            "Ø§Ù„Ù…Ø¨Ù„Øº": "Ø§Ù„Ù‚ÙŠÙ…Ø©",
            "Ø§Ù„Ù‚ÙŠÙ…Ø©": "Ø§Ù„Ù‚ÙŠÙ…Ø©",
            "Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©": "Ø§Ù„Ø¬Ù‡Ø©",
            "Ø§Ù„Ø¬Ù‡Ø©": "Ø§Ù„Ø¬Ù‡Ø©",
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±": "Ø§Ù„Ø¥ØµØ¯Ø§Ø±",
            "Ø§Ù„Ø¥ØµØ¯Ø§Ø±": "Ø§Ù„Ø¥ØµØ¯Ø§Ø±",
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": "Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
            "Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": "Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
        }
        return aliases.get(s, s)

    def _compute_totals(self, table, row_range, cols):
        totals = {}
        for c in cols:
            name = self._header_text(table, c)
            for r in range(row_range[0], row_range[1]):
                if hasattr(table, 'item'):
                    it = table.item(r, c)
                    val = self._numeric_text_to_float(it.text() if it else None)
                else:
                    try:
                        model = table.model()
                        idx = model.index(r, c)
                        val = self._numeric_text_to_float(model.data(idx, QtCore.Qt.DisplayRole))
                    except Exception:
                        val = None
                if val is None:
                    continue
                totals[name] = totals.get(name, 0.0) + val
        return totals

    def _guess_total_cols(self, table, max_probe_rows=50):
        try:
            cols = []
            rc = table.rowCount() if hasattr(table, 'rowCount') else (table.model().rowCount() if table.model() else 0)
            cc = table.columnCount() if hasattr(table, 'columnCount') else (table.model().columnCount() if table.model() else 0)
            probe_rows = min(rc, max_probe_rows)
            for i in range(cc):
                name = self._header_text(table, i) or ""
                if any(k in name for k in ["Ù‚ÙŠÙ…Ø©", "amount", "insurance", "Ø§Ù„ØªØ£Ù…ÙŠÙ†", "%", "Ù†Ø³Ø¨Ø©"]):
                    cols.append(i); continue
                # Ø¥Ù† Ù„Ù… ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ… ÙØ¹Ù„ÙŠÙ‹Ø§
                found_num = False
                for r in range(probe_rows):
                    try:
                        if hasattr(table, 'item'):
                            it = table.item(r, i)
                            val = self._numeric_text_to_float(it.text() if it else None)
                        else:
                            idx = table.model().index(r, i)
                            val = self._numeric_text_to_float(table.model().data(idx, QtCore.Qt.DisplayRole))
                    except Exception:
                        val = None
                    if val is not None:
                        found_num = True; break
                if found_num:
                    cols.append(i)
            return cols
        except Exception:
            return []

    def _render(self, printer, painter_override=None):
        # Ø·Ø¨Ù‘Ù‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© (Ø§Ù„Ø­Ø¬Ù…/Ø§Ù„Ø§ØªØ¬Ø§Ù‡) Ø­Ø³Ø¨ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù…
        try:
            self._apply_printer_settings(printer)
        except Exception:
            pass
        try:
            if hasattr(self, '_unreg_gnos_cache'):
                setattr(self, '_unreg_gnos_cache', {})
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ø´Ø± Ø¯Ù…Ø¬ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            self._next_table_same_page = False
            self._next_table_y_offset = 0
        except Exception:
            pass
        painter = painter_override or QtGui.QPainter(printer)
        painter.save()

        # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ Ù„ØªØ¬Ù†Ù‘Ø¨ Ù‚ØµÙ‘ Ù…Ù† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©
        page_rect = getattr(printer, 'printableRect', printer.pageRect)()
        mt = self._mm_to_points(60.0)
        mb = self._mm_to_points(60.0)
        ml = self._mm_to_points(25.0)
        mr = self._mm_to_points(100.0)
        content = QtCore.QRectF(page_rect.left() + ml, page_rect.top() + mt, page_rect.width() - ml - mr,
                                page_rect.height() - mt - mb)
        # Ø§Ø¯ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø¯Ø§Ø®Ù„ ÙŠÙ…ÙŠÙ†Ù‹Ø§ ÙˆÙŠØ³Ø§Ø±Ù‹Ø§ Ù„ØªØ¬Ù†Ù‘Ø¨ Ù‚ØµÙ‘ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª
        try:
            edge_safe_pad = max(1.0, float(getattr(self, 'sp_border', None).value() if hasattr(self, 'sp_border') else 1.0)) + 0.75
        except Exception:
            edge_safe_pad = 1.75
        content = content.adjusted(edge_safe_pad, 0.0, -edge_safe_pad, 0.0)

        # ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ: Ù„Ø§ Ù†Ø­Ø¬Ø² Ù…Ø³Ø§Ø­Ø© Ø£Ø³ÙÙ„ ÙƒÙ„ ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†.
        # Ø³Ù†Ø±Ø³Ù…Ù‡ ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙˆØ¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø³Ø§ÙØ© Ù‚ØµÙŠØ±Ø©.
        props_values = []
        try:
            props_values = self._compute_props_values(None)
        except Exception:
            props_values = []

        # Ù†Ø³Ø¨ ØªØ­Ø¬ÙŠÙ… Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ ÙˆØ­Ø¬Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        try:
            row_scale = max(0.005, float(self.sp_row_height_pct.value()) / 100.0)
        except Exception:
            row_scale = 1.0
        try:
            col_scale = max(0.05, float(self.sp_col_width_pct.value()) / 100.0)
        except Exception:
            col_scale = 1.0
        # Ù†Ø³Ø¨Ø© Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† Ø§Ø±ØªÙØ§Ø¹ ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        try:
            hdr_row_scale = max(0.05, float(self.sp_col_header_row_height_pct.value()) / 100.0)
        except Exception:
            hdr_row_scale = 1.0

        # Ø®Ø±ÙŠØ·Ø© Ù†Ø³Ø¨ Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯ (Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¨Ù‘Ø¹)
        col_scale_map = None
        try:
            if getattr(self, 'tbl_col_scales', None) and self.tbl_col_scales.rowCount() > 0:
                col_scale_map = {}
                for i in range(self.tbl_col_scales.rowCount()):
                    it = self.tbl_col_scales.item(i, 0)
                    sb = self.tbl_col_scales.cellWidget(i, 1)
                    if it is not None and sb is not None:
                        nm = self._norm_header(it.text())
                        col_scale_map[nm] = max(0.05, float(sb.value()) / 100.0)
        except Exception:
            col_scale_map = None

        # ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø±Ø³Ù… Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

        # Ù„Ùˆ ÙˆÙØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙŠÙ„ØŒ Ù†ØªØ¬Ø§Ù‡Ù„ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆÙ†Ø·Ø¨Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·
        table = self._table_override or getattr(self.parent, 'table', None)
        reports_tables = []
        if self._table_override is None:
            try:
                if getattr(self.parent, "tabs", None) and getattr(self.parent, "_kpis_tab_widget", None):
                    if self.parent.tabs.currentWidget() is self.parent._kpis_tab_widget:
                        tbls = self.parent._kpis_tab_widget.findChildren((QtWidgets.QTableWidget, QtWidgets.QTableView))
                        if tbls:
                            def _rc(t):
                                try:
                                    return int(getattr(t, 'rowCount', lambda: t.model().rowCount())())
                                except Exception:
                                    return 0
                            nonempty = [t for t in tbls if _rc(t) > 0]
                            table = (nonempty[0] if nonempty else tbls[0])
                            reports_tables = (nonempty if nonempty else tbls)
            except Exception:
                pass
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„"ØŒ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙˆØ§Ù„Ù…ÙÙ„ØªØ±Ø© ÙÙ‚Ø·
        if self._table_override is None:
            try:
                if getattr(self.parent, "tabs", None) and getattr(self.parent, "_bank_detailed_tab_widget", None):
                    if self.parent.tabs.currentWidget() is self.parent._bank_detailed_tab_widget:
                        tbls = []
                        dept_only = False
                        try:
                            dept_only = bool(getattr(self.parent, 'bank_detailed_dept_only_chk', None) and self.parent.bank_detailed_dept_only_chk.isChecked())
                        except Exception:
                            dept_only = False
                        if dept_only:
                            try:
                                if getattr(self.parent, 'bank_detailed_dept_table', None):
                                    tbls.append(self.parent.bank_detailed_dept_table)
                            except Exception:
                                pass
                        else:
                            try:
                                if getattr(self.parent, 'bank_detailed_active_table', None):
                                    tbls.append(self.parent.bank_detailed_active_table)
                            except Exception:
                                pass
                            try:
                                if getattr(self.parent, 'bank_detailed_dept_table', None):
                                    tbls.append(self.parent.bank_detailed_dept_table)
                            except Exception:
                                pass
                        if tbls:
                            def _rc(t):
                                try:
                                    return int(getattr(t, 'rowCount', lambda: t.model().rowCount())())
                                except Exception:
                                    return 0
                            nonempty = [t for t in tbls if _rc(t) > 0]
                            table = (nonempty[0] if nonempty else tbls[0])
                            reports_tables = (nonempty if nonempty else tbls)
            except Exception:
                pass
        # Ø¹Ù„Ù… Ø®Ø§Øµ Ù„ØªØ¨ÙˆÙŠØ¨ "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„" Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
        is_bank_detailed = False
        # Ø¹Ù„Ù… Ø®Ø§Øµ Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        is_dept_report = False
        # Ø¹Ù„Ù… Ø®Ø§Øµ Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©)
        is_dept_matrix = False
        # Ø¹Ù„Ù… Ø®Ø§Øµ: Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ ÙÙ„ØªØ± Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯ØŒ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ
        is_main_dept_summary = False
        # Ø¹Ù„Ù… Ø®Ø§Øµ Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        is_bank_limits = False
        # ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¨Ù†ÙˆÙƒ
        try:
            if getattr(self.parent, "tabs", None) and getattr(self.parent, "_bank_detailed_tab_widget", None):
                if self.parent.tabs.currentWidget() is self.parent._bank_detailed_tab_widget:
                    is_bank_detailed = True
        except Exception:
            pass
        # ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©)
        try:
            if getattr(self.parent, "tabs", None) and getattr(self.parent, "_dept_matrix_tab_widget", None):
                if self.parent.tabs.currentWidget() is self.parent._dept_matrix_tab_widget:
                    if getattr(self.parent, 'dept_matrix_table', None):
                        table = self.parent.dept_matrix_table
                        is_dept_report = True
                        is_dept_matrix = True
        except Exception:
            pass
        # ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        if not is_dept_matrix:
            try:
                if getattr(self.parent, "tabs", None) and getattr(self.parent, "_dept_report_tab_widget", None):
                    if self.parent.tabs.currentWidget() is self.parent._dept_report_tab_widget and getattr(self.parent, 'dept_report_table', None):
                        table = self.parent.dept_report_table
                        is_dept_report = True
            except Exception:
                pass
        # ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        if getattr(self.parent, "tabs", None) and getattr(self.parent, "_bank_limits_tab_widget", None):
            if self.parent.tabs.currentWidget() is self.parent._bank_limits_tab_widget:
                if getattr(self.parent, 'bank_limits_table', None):
                    table = self.parent.bank_limits_table
                    is_bank_limits = True
                    try:
                        hd_cnt = table.columnCount()
                        for _ci in range(hd_cnt):
                            _hn = (self._header_text(table, _ci) or "").strip()
                            if _hn == "Ø§Ù„Ø¨Ù†Ùƒ":
                                try:
                                    table.setColumnHidden(_ci, False)
                                except Exception:
                                    pass
                                try:
                                    cur_w = int(table.columnWidth(_ci))
                                except Exception:
                                    cur_w = 0
                                try:
                                    table.setColumnWidth(_ci, max(cur_w, 160))
                                except Exception:
                                    pass
                                break
                    except Exception:
                        pass
        # Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ ÙÙ„ØªØ± Ù‚Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø¹Ù„Ù…
        try:
            if table is getattr(self.parent, 'table', None):
                dep_txt = str(getattr(self.parent, 'cmb_dept', None).currentText()).strip() if getattr(self.parent, 'cmb_dept', None) else ""
                if dep_txt and dep_txt != "Ø§Ù„ÙƒÙ„":
                    is_main_dept_summary = True
        except Exception:
            pass
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª
        cash_filter = None
        try:
            parent = getattr(self, 'parent', None)
            if parent:
                cmb_cash = getattr(parent, 'cmb_cash', None)
                if cmb_cash:
                    cash_filter = cmb_cash.currentText().strip() if hasattr(cmb_cash, 'currentText') else ''
                    if cash_filter == 'Ø§Ù„ÙƒÙ„':
                        cash_filter = None
        except Exception:
            pass
        
        # Ø¥Ù† ÙƒÙ†Ø§ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù†Ù‚Ø¯ÙŠØŒ Ø§Ø·Ø¨Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµØ§Ø¦Øµ/Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        try:
            if (self._table_override is None) and (table is getattr(self.parent, 'table', None)) and getattr(self.parent, 'table_cash', None):
                # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ù†Ù‚Ø¯ÙŠØŒ Ø§Ø·Ø¨Ø¹ ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ
                if cash_filter == 'Ù†Ù‚Ø¯ÙŠ':
                    if int(getattr(self.parent.table_cash, 'rowCount', lambda: 0)()) > 0:
                        reports_tables = [self.parent.table_cash]
                    else:
                        reports_tables = []
                # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± ØªØ³Ù‡ÙŠÙ„Ø§ØªØŒ Ø§Ø·Ø¨Ø¹ ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ³Ù‡ÙŠÙ„Ø§Øª
                elif cash_filter == 'ØªØ³Ù‡ÙŠÙ„Ø§Øª':
                    reports_tables = [table]
                # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ±ØŒ Ø§Ø·Ø¨Ø¹ ÙƒÙ„Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ†
                else:
                    if int(getattr(self.parent.table_cash, 'rowCount', lambda: 0)()) > 0:
                        reports_tables = [table, self.parent.table_cash]
                    else:
                        reports_tables = [table]
        except Exception:
            pass
        if table is None:
            # Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø¯Ø¯Ø› Ø§Ø·Ø¨Ø¹ Ù„Ù‚Ø·Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙƒØ­Ù„ Ø£Ø®ÙŠØ±
            try:
                pm = self.parent._kpis_tab_widget.grab()
                pm2 = pm.scaled(int(content.width()), int(content.height()), QtCore.Qt.KeepAspectRatio,
                                 QtCore.Qt.SmoothTransformation)
                x = int(content.left() + (content.width() - pm2.width()) / 2)
                y = int(content.top() + (content.height() - pm2.height()) / 2)
                painter.drawPixmap(x, y, pm2)
                if painter_override is None:
                    painter.restore(); painter.end()
                else:
                    painter.restore()
                return
            except Exception:
                pass
        # Ø¥Ù† ÙƒØ§Ù†Øª ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø¶Ù‘Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        try:
            _cur_rows = int(getattr(table, 'rowCount', lambda: table.model().rowCount())()) if table is not None else 0
        except Exception:
            _cur_rows = 0
        if _cur_rows == 0:
            try:
                _main = getattr(self.parent, 'table', None)
                _main_rows = int(getattr(_main, 'rowCount', lambda: _main.model().rowCount())()) if _main is not None else 0
                if _main is not None and _main_rows > 0:
                    table = _main
                    reports_tables = []
            except Exception:
                pass
        tables_iter = reports_tables if reports_tables else ([table] if table is not None else [])
        # Ø³Ù†ÙƒØ±Ù‘Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰
        # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ØŒ Ø³ÙŠØ³ØªØ®Ø¯Ù… Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ù‚Ø·Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£Ø¹Ù„Ø§Ù‡
        # Ù†Ø³ØªØ®Ø¯ÙÙ… Ø§Ù„Ù…ØªØºÙŠØ± table Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        # Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ù‚
        # (ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©ØŒ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
        cols = None
        # Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        if not reports_tables:
            for ti, table in enumerate(tables_iter):
                # ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø¬Ø¯ÙˆÙ„ØŒ Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ù…Ø§ Ø¨ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
                if ti > 0:
                    try:
                        printer.newPage()
                    except Exception:
                        pass

                # Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ù‚
                if reports_tables or is_dept_report:
                    # ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    cols = list(range(table.columnCount()))
                else:
                    # ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©/Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©
                    cols = self._selected_columns(table)
                    if not cols:
                        cols = list(range(table.columnCount()))

                # --- Snapshot mode: render the actual table widget exactly as shown (safe fallback) ---
                try:
                    style_mode = getattr(self, 'cmb_style', None).currentIndex() if hasattr(self, 'cmb_style') else 0
                    # ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø¬ÙŠÙ… Ø£Ø¹Ù…Ø¯Ø© Ù…Ø®ØµØµ Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯Ø› Ù†Ø³Ù…Ø­ Ø¨Ù‡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ù…ÙˆØ­Ù‘Ø¯Ù‹Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
                    apply_uniform_scale = True
                    try:
                        if col_scale_map is not None:
                            factors = set()
                            for _ci in range(table.columnCount()):
                                nm = self._norm_header(self._header_text(table, _ci))
                                # Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ù…ÙˆØ­Ø¯ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠØ› Ø§Ø³ØªØ®Ø¯Ù… 1.0 Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© Ø®Ø§ØµØ©
                                fct = col_scale_map.get(nm, 1.0)
                                factors.add(round(fct, 6))
                            if len(factors) == 1:
                                uniform_factor = list(factors)[0]
                            else:
                                apply_uniform_scale = False
                                uniform_factor = 1.0
                        else:
                            uniform_factor = col_scale
                    except Exception:
                        uniform_factor = col_scale

                    if self.chk_snapshot.isChecked() and style_mode == 0 and not self.chk_white_text.isChecked() and apply_uniform_scale:
                        header_h = table.horizontalHeader().height()
                        total_h = header_h + sum(table.rowHeight(r) for r in range(table.rowCount()))
                        total_w = sum(table.columnWidth(c) for c in range(table.columnCount()))
                        # Ø¨Ø¹Ø¯ Ø¶Ø¨Ø· content Ø¨Ù‡Ø§Ù…Ø´ Ø¯Ø§Ø®Ù„ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨
                        kx = max(0.001, float(max(1.0, content.width())) / max(1.0, float(total_w)))
                        ky = float(content.height()) / max(1.0, float(total_h))
                        # ÙØ¹Ù‘Ù„ "Ø§Ù„ØªØ­Ø¬ÙŠÙ…" Ù…Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·: Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„ØµÙØ­Ø©/Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©
                        mode = self.cmb_scale_mode.currentIndex()
                        # Ø¥Ø¬Ø¨Ø§Ø± Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙƒØ§Ù…Ù„Ù‹Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
                        try:
                            if ((getattr(self.parent, 'bank_detailed_dept_table', None) is not None and table is self.parent.bank_detailed_dept_table) or
                                (getattr(self.parent, 'bank_detailed_active_table', None) is not None and table is self.parent.bank_detailed_active_table)):
                                mode = 0  # Fit to width
                        except Exception:
                            pass
                        if mode == 2 or mode == 1:
                            # Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ù…Ø®ØµØµØ© (Ø£Ùˆ Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ Ø£ØµØ¨Ø­Øª Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
                            sx_k = max(0.05, self.sp_scale.value() / 100.0)
                            sy_k = sx_k
                        elif mode == 0:
                            # Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶: Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                            sx_k = kx; sy_k = kx

                        elif mode == 3:
                            # Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙÙˆÙ: Ø§Ù„ØµÙÙˆÙ Ø¹Ù„Ù‰ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ø±ØªÙØ§Ø¹)
                            sx_k = ky; sy_k = ky
                        else:
                            # Ø¨Ù„Ø§ ØªØ­Ø¬ÙŠÙ…
                            sx_k = 1.0; sy_k = 1.0
                        painter.save()
                        try:
                            totals_only_active = bool(is_dept_matrix and getattr(self.parent, 'dept_matrix_totals_only_chk', None) and self.parent.dept_matrix_totals_only_chk.isChecked())
                        except Exception:
                            totals_only_active = False
                        if totals_only_active:
                            try:
                                dx = max(0.0, (content.width() - (total_w * (sx_k * uniform_factor))) / 2.0)
                            except Exception:
                                dx = 0.0
                            painter.translate(content.left() + dx, content.top())
                        else:
                            painter.translate(content.left(), content.top())
                        # Ø·Ø¨Ù‘Ù‚ Ù†Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙ
                        painter.scale(sx_k * uniform_factor, sy_k * row_scale)
                        painter.setClipRect(QtCore.QRectF(0, 0, total_w, total_h))
                        table.render(painter, QtCore.QPoint(), QtGui.QRegion(table.rect()))
                        painter.restore()
                        # Ø§Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ù‚Ø·Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        try:
                            self._draw_watermark(painter, content, page_rect, 1, 1, printer)
                        except Exception:
                            pass
                        if painter_override is None:
                            painter.restore(); painter.end()
                        return
                except Exception:
                    pass

        # Ø§Ø·Ø¨Ø¹ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªØ¹Ø¯Ø¯Ø© Ø£Ùˆ Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯)
        # Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø§Ø·Ø¨Ø¹ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆÙÙ‚ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙ„ÙŠ
        for ti, table in enumerate(tables_iter):
                # ØªØ­ÙƒÙ… ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù…Ø³Ø§Ø­Ø©
                start_same = False
                start_offset_for_first_page = 0
                if ti > 0:
                    try:
                        start_same = bool(getattr(self, '_next_table_same_page', False))
                        if start_same:
                            try:
                                start_offset_for_first_page = int(getattr(self, '_next_table_y_offset', 0))
                            except Exception:
                                start_offset_for_first_page = 0
                            # ØµÙÙ‘Ø± Ø§Ù„Ø£Ø¹Ù„Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø­ØªÙ‰ Ù„Ø§ ØªØ¤Ø«Ù‘Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ©
                            try:
                                self._next_table_same_page = False
                                self._next_table_y_offset = 0
                            except Exception:
                                pass
                        else:
                            try:
                                printer.newPage()
                            except Exception:
                                pass
                    except Exception:
                        try:
                            printer.newPage()
                        except Exception:
                            pass
                # Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©"
                # ÙÙŠ Ø­Ø§Ù„Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                if is_dept_report or is_dept_matrix:
                    cols = list(range(table.columnCount()))
                else:
                    cols = self._selected_columns(table)
                    if not cols:
                        cols = list(range(table.columnCount()))
                try:
                    if getattr(self.parent, 'bank_detailed_dept_table', None) is not None and table is self.parent.bank_detailed_dept_table:
                        cols = list(range(table.columnCount()))
                except Exception:
                    pass
                # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©) ÙŠØ·Ø¨Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                try:
                    if is_dept_matrix and table is getattr(self.parent, 'dept_matrix_table', None):
                        cols = list(range(table.columnCount()))
                        # Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)
                        hidden_cols_dept = []
                        for c in range(table.columnCount()):
                            try:
                                if table.isColumnHidden(c):
                                    hidden_cols_dept.append(c)
                                    table.setColumnHidden(c, False)
                            except Exception:
                                pass
                        # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø®ÙŠØ± (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ) Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                        last_col = table.columnCount() - 1
                        if last_col >= 0 and last_col not in cols:
                            cols.append(last_col)
                except Exception:
                    pass
                # Ø­ÙˆÙ‘Ù„ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø¨ÙƒØ³Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ù„Ù‚ÙŠØ§Ø³ ØµØ­ÙŠØ­
                try:
                    screen_dpi_x = max(1, int(getattr(table, 'logicalDpiX', lambda: 96)()))
                except Exception:
                    screen_dpi_x = 96
                try:
                    screen_dpi_y = max(1, int(getattr(table, 'logicalDpiY', lambda: 96)()))
                except Exception:
                    screen_dpi_y = 96
                try:
                    printer_dpi = max(72, int(getattr(printer, 'resolution', lambda: 300)()))
                except Exception:
                    printer_dpi = 300
                sx = float(printer_dpi) / float(screen_dpi_x)
                sy = float(printer_dpi) / float(screen_dpi_y)

                # ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£Ùˆ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ
                is_dept_tbl = False
                is_active_tbl = False
                try:
                    is_dept_tbl = (getattr(self.parent, 'bank_detailed_dept_table', None) is not None and table is self.parent.bank_detailed_dept_table)
                except Exception:
                    is_dept_tbl = False
                try:
                    is_active_tbl = (getattr(self.parent, 'bank_detailed_active_table', None) is not None and table is self.parent.bank_detailed_active_table)
                except Exception:
                    is_active_tbl = False
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙŠ ÙÙ„ØªØ± Ù†Ø´Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£Ùˆ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
                has_active_filter = False
                try:
                    if table is getattr(self.parent, 'table', None) or table is getattr(self.parent, 'table_cash', None):
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù…
                        cmb_dept = getattr(self.parent, 'cmb_dept', None)
                        if cmb_dept:
                            dept_txt = str(cmb_dept.currentText()).strip() if hasattr(cmb_dept, 'currentText') else ""
                            if dept_txt and dept_txt != "Ø§Ù„ÙƒÙ„":
                                has_active_filter = True
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ
                        if not has_active_filter:
                            cmb_bank = getattr(self.parent, 'cmb_bank', None)
                            if cmb_bank:
                                bank_txt = str(cmb_bank.currentText()).strip() if hasattr(cmb_bank, 'currentText') else ""
                                if bank_txt and bank_txt != "Ø§Ù„ÙƒÙ„":
                                    has_active_filter = True
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹
                        if not has_active_filter:
                            cmb_gtype = getattr(self.parent, 'cmb_gtype', None)
                            if cmb_gtype:
                                gtype_txt = str(cmb_gtype.currentText()).strip() if hasattr(cmb_gtype, 'currentText') else ""
                                if gtype_txt and gtype_txt != "Ø§Ù„ÙƒÙ„":
                                    has_active_filter = True
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
                        if not has_active_filter:
                            cmb_status = getattr(self.parent, 'cmb_status', None)
                            if cmb_status:
                                status_txt = str(cmb_status.currentText()).strip() if hasattr(cmb_status, 'currentText') else ""
                                if status_txt and status_txt != "Ø§Ù„ÙƒÙ„":
                                    has_active_filter = True
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
                        if not has_active_filter:
                            ed_search = getattr(self.parent, 'ed_search', None)
                            if ed_search:
                                search_txt = str(ed_search.text()).strip() if hasattr(ed_search, 'text') else ""
                                if search_txt:
                                    has_active_filter = True
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª (Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·)
                        if not has_active_filter and table is getattr(self.parent, 'table', None):
                            cmb_cash = getattr(self.parent, 'cmb_cash', None)
                            if cmb_cash:
                                cash_txt = str(cmb_cash.currentText()).strip() if hasattr(cmb_cash, 'currentText') else ""
                                if cash_txt and cash_txt != "Ø§Ù„ÙƒÙ„":
                                    has_active_filter = True
                except Exception:
                    pass
                
                id_w_px = 60  # Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ ID (Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„)
                apply_id = bool(is_dept_tbl or is_active_tbl or has_active_filter)

                # Ø·Ø§Ø¨ÙÙ‚ Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø¥Ù† ÙˆÙØ¬Ø¯
                main_tbl = getattr(self.parent, 'table', None)
                map_w = {}
                try:
                    if main_tbl is not None:
                        for _ci in range(main_tbl.columnCount()):
                            _nm = self._norm_header(self._header_text(main_tbl, _ci))
                            map_w[_nm] = int(main_tbl.columnWidth(_ci))
                except Exception:
                    map_w = {}
                def _col_w(_c:int) -> int:
                    try:
                        _nm = self._norm_header(self._header_text(table, _c))
                        w = None
                        if getattr(self, 'chk_use_main_widths', None) and self.chk_use_main_widths.isChecked():
                            if _nm in map_w:
                                w = int(map_w[_nm])
                        if w is None:
                            w = int(table.columnWidth(_c))
                        if is_bank_limits:
                            nm = _nm.strip()
                            mins = {
                                "Ø§Ù„Ø¨Ù†Ùƒ": 160,
                                "Ø§Ù„Ø­Ø¯": 110,
                                "Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©": 110,
                                "Ø¶Ù…Ø§Ù†Ø§Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©": 120,
                                "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª": 120,
                                "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ": 110,
                                "Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…": 90,
                                "Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©": 120,
                            }
                            w = max(w, int(mins.get(nm, 90)))
                        # Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©) Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±
                        if is_dept_matrix:
                            try:
                                # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆØ³Ø¹ Ù‚Ù„ÙŠÙ„Ù‹Ø§ØŒ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØªÙˆØ³Ø·ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù…ÙˆØ­Ù‘Ø¯
                                if _nm.strip() == "Ø§Ù„Ù‚Ø³Ù…":
                                    w = max(w, 140)
                                elif _nm.strip() == "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ":
                                    w = max(w, 100)
                                else:
                                    # Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© ØªØ­Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø±Ø¤ÙˆØ³Ù‡Ø§ ÙØ§Ø±ØºØ©ØŒ Ø¹Ø§Ù„Ø¬Ù‡Ø§ Ø¨Ù…ÙˆØ¶Ø¹Ù‡Ø§
                                    if _c > 0 and _c < (table.columnCount() - 1):
                                        w = max(w, 90)
                            except Exception:
                                # Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ø¢Ù…Ù† ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª
                                if _c > 0:
                                    w = max(w, 80)
                        return w
                    except Exception:
                        try:
                            return int(table.columnWidth(_c))
                        except Exception:
                            return 100

                def _col_scale_factor(_c:int) -> float:
                    try:
                        _nm = self._norm_header(self._header_text(table, _c))
                        if col_scale_map is not None:
                            return float(col_scale_map.get(_nm, 1.0))
                        return 1.0
                    except Exception:
                        return 1.0

                header_h = (table.horizontalHeader().height() if self.chk_repeat_header.isChecked() else 0) * sy * hdr_row_scale
                total_w = sum(_col_w(c) * _col_scale_factor(c) for c in cols) * sx
                if apply_id:
                    total_w += id_w_px * sx  # Ø£Ø¶Ù Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ ID Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø­ØªÙ‰ ØªØªÙ†Ø§Ø³Ø¨ Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶

                mode = self.cmb_scale_mode.currentIndex()
                # Ø¥Ø¬Ø¨Ø§Ø± Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØ§Ù…Ù„Ù‹Ø§
                try:
                    if ((getattr(self.parent, 'bank_detailed_dept_table', None) is not None and table is self.parent.bank_detailed_dept_table) or
                        (getattr(self.parent, 'bank_detailed_active_table', None) is not None and table is self.parent.bank_detailed_active_table)):
                        mode = 0  # Fit to width
                except Exception:
                    pass
                if mode == 2 or mode == 1:
                    k = self.sp_scale.value() / 100.0
                elif mode == 0:
                    k = max(0.001, content.width() / max(1.0, total_w))

                elif mode == 3:
                    total_h = header_h + sum(table.rowHeight(r) for r in range(table.rowCount())) * sy * row_scale
                    k = (content.height() - header_h) / max(1.0, total_h)
                    # ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    # min_scale = 0.3  # 30% ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰
                    # k = max(k, min_scale)
                else:
                    k = 1.0
                # Ø¥Ø¬Ø¨Ø§Ø± Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙØ­Ø© Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©) Ù„Ù…Ù†Ø¹ ØµÙØ­Ø© Ø¥Ø¶Ø§ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
                try:
                    if is_dept_matrix:
                        total_h = header_h + sum(table.rowHeight(r) for r in range(table.rowCount())) * sy * row_scale
                        k = min(max(0.001, content.width() / max(1.0, total_w)), (content.height() - header_h) / max(1.0, total_h))
                        mode = 1  # Ø¥Ø¬Ø¨Ø§Ø± Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙØ­Ø©
                        # ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                        # k = max(k, 0.3)
                except Exception:
                    pass
                # Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ ÙÙ„ØªØ±: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ù„Ø§ ÙŠÙƒÙˆÙ† ØµØºÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹
                # ÙˆØ§Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
                force_single_page = True  # Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹: ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© (Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
                # Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„: Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
                try:
                    if (table is getattr(self.parent, 'bank_detailed_active_table', None)) or (table is getattr(self.parent, 'bank_detailed_dept_table', None)):
                        force_single_page = False
                except Exception:
                    pass
                try:
                    # Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                    if table is getattr(self.parent, 'table', None) and mode == 1:
                        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¬ÙŠÙ… ØµØºÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 40%)ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙØ­Ø©
                        if k < 0.4:
                            k = max(0.001, content.width() / max(1.0, total_w))
                            # ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                            # k = max(k, 0.4)
                            # Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø­Ø¯ Ø£Ø¯Ù†Ù‰ØŒ Ø§Ø³Ù…Ø­ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
                            force_single_page = False
                        else:
                            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¬ÙŠÙ… ÙƒØ§ÙÙŠØ§Ù‹ (>= 40%)ØŒ ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªÙ†Ø§Ø³Ø¨ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                            total_h_check = header_h + sum(table.rowHeight(r) for r in range(table.rowCount())) * sy * row_scale * k
                            if total_h_check > (content.height() - header_h):
                                # Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø§ ÙŠØªÙ†Ø§Ø³Ø¨ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ø§Ø³Ù…Ø­ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
                                force_single_page = False
                            else:
                                # Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªÙ†Ø§Ø³Ø¨ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                                force_single_page = True
                    # Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„
                    elif (table is getattr(self.parent, 'bank_detailed_active_table', None) or 
                          table is getattr(self.parent, 'bank_detailed_dept_table', None)) and mode == 1:
                        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¬ÙŠÙ… ØµØºÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 40%)ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØµÙØ­Ø©
                        if k < 0.4:
                            k = max(0.001, content.width() / max(1.0, total_w))
                            # ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                            # k = max(k, 0.4)
                            # Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø­Ø¯ Ø£Ø¯Ù†Ù‰ØŒ Ø§Ø³Ù…Ø­ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
                            force_single_page = False
                        else:
                            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¬ÙŠÙ… ÙƒØ§ÙÙŠØ§Ù‹ (>= 40%)ØŒ ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªÙ†Ø§Ø³Ø¨ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                            total_h_check = header_h + sum(table.rowHeight(r) for r in range(table.rowCount())) * sy * row_scale * k
                            if total_h_check > (content.height() - header_h):
                                # Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø§ ÙŠØªÙ†Ø§Ø³Ø¨ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ø§Ø³Ù…Ø­ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
                                force_single_page = False
                            else:
                                # Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØªÙ†Ø§Ø³Ø¨ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                                force_single_page = True
                except Exception:
                    pass

                # Ø§Ø­Ø³Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŒ Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø£ÙŠ Ø¥Ø²Ø§Ø­Ø© Ø±Ø£Ø³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                usable_h = content.height() - header_h
                # Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ø£Ø¶Ù Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ 0 Ùˆ 1 Ù„Ù„Ø±Ø£Ø³
                if is_dept_matrix and table.rowCount() >= 2:
                    header_h += (table.rowHeight(0) + table.rowHeight(1)) * sy * row_scale * k
                    usable_h = content.height() - header_h
                    # Ø§Ø­Ø³Ø¨ Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„ØµÙÙˆÙ Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„ØµÙ 2
                    row_heights = [table.rowHeight(r) * sy * row_scale * k for r in range(2, table.rowCount())]
                else:
                    row_heights = [table.rowHeight(r) * sy * row_scale * k for r in range(table.rowCount())]
                pages_ranges = []
                acc = 0.0; start = 0
                # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¨Ø¯Ø£ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦ØµØŒ Ø§Ø­Ø¬Ø² Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                usable_h_first = usable_h
                try:
                    if ti > 0 and start_same:
                        usable_h_first = max(0.0, usable_h - float(start_offset_for_first_page))
                except Exception:
                    usable_h_first = usable_h
                # Ø§Ø­Ø¬Ø² Ù…Ø³Ø§Ø­Ø© Ø³Ø·Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù„ÙƒÙ„ ØµÙØ­Ø© Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ù…ÙØ¹Ù„Ø§Ù‹ â€” Ù…Ø¹ Ø§Ù„ØªØ­Ø¬ÙŠÙ…
                try:
                    _base_h = int(getattr(self, 'sp_total_row_h', None).value()) if hasattr(self, 'sp_total_row_h') else 28
                except Exception:
                    _base_h = 28
                try:
                    h_tot = float(_base_h) * sy * k
                except Exception:
                    h_tot = 28.0 * sy * k
                try:
                    reserve_h = h_tot if (self.chk_total_per_page.isChecked() and sel_total_cols) else 0
                except Exception:
                    reserve_h = 0
                cap = max(0.0, usable_h_first - reserve_h)
                # Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ø§Ø·Ø¨Ø¹ ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙ 2
                if is_dept_matrix:
                    pages_ranges = [(2, table.rowCount())]
                    pages = 1
                else:
                    for i, rh in enumerate(row_heights):
                        if acc + rh > cap and i > start:
                            pages_ranges.append((start, i)); start = i; acc = 0.0
                            # Ø¨Ø¹Ø¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø© Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ù…Ø¹ Ø§Ù„Ø­Ø¬Ø²
                            cap = max(0.0, usable_h - reserve_h)
                        acc += rh
                    pages_ranges.append((start, table.rowCount()))
                    pages = len(pages_ranges)
                    # Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¬Ø¯Ø§ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„: Ø¥Ø°Ø§ ÙƒØ§Ù† force_single_page = FalseØŒ Ø§Ø³Ù…Ø­ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
                    is_bank_detailed_table = (table is getattr(self.parent, 'bank_detailed_active_table', None) or 
                                             table is getattr(self.parent, 'bank_detailed_dept_table', None))
                    if (mode == 3 or is_dept_report) and force_single_page:
                        pages_ranges = [(0, table.rowCount())]
                        pages = 1
                    elif (mode == 3 or is_dept_report):
                        # Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰: Ø§Ø¬Ø¨Ø± ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
                        pages_ranges = [(0, table.rowCount())]
                        pages = 1

                sel_total_names = [self.cmb_total_cols.item(i).text() for i in range(self.cmb_total_cols.count()) if
                                   self.cmb_total_cols.item(i).isSelected()]
                sel_total_cols = [i for i in range(table.columnCount()) if (self._header_text(table, i) in sel_total_names)]
                if not sel_total_cols:
                    try:
                        sel_total_cols = self._guess_total_cols(table)
                    except Exception:
                        sel_total_cols = []
                

                f = table.font()
                eff_font_scale = (self.sp_font_scale.value() / 100.0)
                style_mode = getattr(self, 'cmb_style', None).currentIndex() if hasattr(self, 'cmb_style') else 0
                if mode == 1:
                    pass  # ØªÙ… ØªÙˆØ­ÙŠØ¯Ù‡ Ù…Ø¹ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                elif mode == 0:
                    eff_font_scale *= max(0.5, min(1.0, float(k)))
                elif mode == 3:
                    eff_font_scale *= max(0.3, min(1.0, float(k)))
                if style_mode == 3:
                    eff_font_scale *= 0.9
                f.setPointSizeF(max(6.0, f.pointSizeF() * eff_font_scale))

                # Ø·Ø¨Ù‘Ù‚ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                try:
                    from_p = max(1, int(self.sp_from_page.value()))
                    to_p = max(from_p, int(self.sp_to_page.value()))
                except Exception:
                    from_p, to_p = 1, pages
                # Ø¥Ù† ØªÙ… Ø§Ø®ØªÙŠØ§Ø± "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·"ØŒ Ø§Ø¶Ø¨Ø· Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©
                print_current_page_only = False
                try:
                    if hasattr(self, 'chk_current_page') and self.chk_current_page.isChecked():
                        print_current_page_only = True
                        # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                        cur = getattr(self, '_current_preview_page', 1)
                        cur = max(1, min(cur, pages))
                        from_p = to_p = cur
                except Exception:
                    pass
                to_p = min(to_p, pages)
                filtered_pages = pages_ranges[from_p - 1: to_p]
                pages_print = len(filtered_pages) if filtered_pages else 0
                # Ø­ÙØ¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø©
                try:
                    self._total_pages = pages
                    if hasattr(self, 'lbl_page_info'):
                        cur = getattr(self, '_current_preview_page', 1)
                        self.lbl_page_info.setText(f"ØµÙØ­Ø© {cur} Ù…Ù† {pages}")
                except Exception:
                    pass

                # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                current_page_title = None
                try:
                    current_page_title = self._current_filter_title()
                    if not current_page_title or current_page_title.strip() == "":
                        current_page_title = self.windowTitle()
                    if not current_page_title or current_page_title.strip() == "":
                        current_page_title = "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
                except Exception:
                    try:
                        current_page_title = self.windowTitle() or "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
                    except Exception:
                        current_page_title = "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"

                # ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙŠØ³ØªÙ…Ø± Ø¹Ø¨Ø± Ø§Ù„ØµÙØ­Ø§Øª)
                print_row_counter = 0
                for pidx, (r0, r1) in enumerate(filtered_pages, 1):
                    # ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù…
                    try:
                        self._current_preview_page = pidx
                        if hasattr(self, 'lbl_page_info'):
                            self.lbl_page_info.setText(f"ØµÙØ­Ø© {pidx} Ù…Ù† {pages}")
                    except Exception:
                        pass
                    if pidx > 1:
                        printer.newPage()

                    # Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ³Ø§Ø±Ù‹Ø§ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
                    rect = QtCore.QRectF(content.left(), page_rect.top() + 2, content.width(), mt - 4)
                    try:
                        hdr_pt = int(self.sp_header_size.value())
                    except Exception:
                        hdr_pt = max(6, int(10 * eff_font_scale))
                    painter.setFont(QtGui.QFont(f.family(), max(6, hdr_pt)))
                    painter.setPen(QtCore.Qt.black)
                    metrics = QtGui.QFontMetrics(painter.font())
                    pad_rect = rect.adjusted(8, 0, -8, 0)
                    hdr_date = QtCore.QDate.currentDate().toString("yyyy-MM-dd")
                    painter.drawText(pad_rect, QtCore.Qt.AlignVCenter | QtCore.Qt.AlignLeft | QtCore.Qt.TextSingleLine, hdr_date)
                    # Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© Ø£Ùˆ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ­ÙŠØ­
                    try:
                        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®ÙŠØ§Ø± "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·" Ù…ÙØ¹Ù‘Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯
                        if print_current_page_only:
                            page_title = current_page_title
                        else:
                            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ ÙƒÙ„ ØµÙØ­Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                            page_title = self._current_filter_title()
                            if not page_title or page_title.strip() == "":
                                page_title = self.windowTitle()
                            if not page_title or page_title.strip() == "":
                                page_title = current_page_title
                    except Exception:
                        page_title = current_page_title
                    elided = metrics.elidedText(page_title, QtCore.Qt.ElideRight, int(pad_rect.width()))
                    painter.drawText(pad_rect, QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter | QtCore.Qt.TextSingleLine, elided)
                    if self.ed_footer.text().strip():
                        ftr = self._fmt_text(self.ed_footer.text(), pidx, pages_print if pages_print else pages)
                        rect = QtCore.QRectF(content.left(), page_rect.bottom() - mb + 2, content.width(), mb - 4)
                        painter.setFont(QtGui.QFont(f.family(), max(8, int(9))))
                        painter.setPen(QtCore.Qt.black);
                        painter.drawText(rect, QtCore.Qt.AlignVCenter | QtCore.Qt.AlignRight, ftr)

                    # Ø³ÙŠØªÙ… Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¨ÙˆØ¶Ø¹ "ØªØ­Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"

                    painter.save()
                    # ÙˆØ³Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙÙ‚ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ø£Ùˆ Ø®ÙŠØ§Ø± "Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙ‚Ø·" ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    x_center = 0.0
                    try:
                        sel_bank_txt = str(getattr(self.parent, 'dept_matrix_bank_filter', None).currentText()).strip() if getattr(self.parent, 'dept_matrix_bank_filter', None) else ""
                    except Exception:
                        sel_bank_txt = ""
                    bank_filter_active = bool(is_dept_matrix and sel_bank_txt and (sel_bank_txt != "Ø§Ù„ÙƒÙ„"))
                    totals_only_active = False
                    try:
                        totals_only_active = bool(is_dept_matrix and getattr(self.parent, 'dept_matrix_totals_only_chk', None) and self.parent.dept_matrix_totals_only_chk.isChecked())
                    except Exception:
                        totals_only_active = False
                    try:
                        if bank_filter_active or totals_only_active:
                            x_center = max(0.0, (content.width() - (sum(_col_w(c) * _col_scale_factor(c) for c in cols) * sx * k + (id_w_px * sx * k if apply_id else 0))) / 2.0)
                    except Exception:
                        x_center = 0.0
                    painter.translate(content.left() + x_center, content.top())
                    # ÙˆØ³Ù‘Ø¹ Ø§Ù„Ù‚Øµ Ø¨Ø¹Ø±Ø¶ ØµØºÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£ÙŠÙ…Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                    painter.setClipRect(QtCore.QRectF(0, 0, content.width() + 2, content.height()))
                    painter.scale(1.0, 1.0)
                    painter.setFont(f)
                    pen = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())));
                    painter.setPen(pen)
                    painter.setBrush(QtCore.Qt.NoBrush)

                    # Ø§Ø¨Ø¯Ø£ ØªØ­Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©
                    y = (start_offset_for_first_page if (ti > 0 and pidx == 1 and start_same) else 0)
                    if (ti > 0 and pidx == 1 and start_same):
                        try:
                            try:
                                _base_h = int(getattr(self, 'sp_total_row_h', None).value()) if hasattr(self, 'sp_total_row_h') else 28
                            except Exception:
                                _base_h = 28
                            h_tot = float(_base_h) * sy * k
                            reserve_h = h_tot if (self.chk_total_per_page.isChecked() and sel_total_cols) else 0
                        except Exception:
                            reserve_h = 0
                        remaining_h = max(0.0, (content.bottom() - (content.top() + y)) - reserve_h)
                        try:
                            min_row_h = (table.rowHeight(0) * sy * row_scale * k) if table.rowCount() > 0 else 1.0
                        except Exception:
                            min_row_h = 1.0
                        # Ø¹Ù†Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØŒ Ø§Ø­Ø¬Ø² Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø±
                        need_new_page = False
                        try:
                            if table is getattr(self.parent, 'table_cash', None):
                                tfont = QtGui.QFont(f.family(), 18)
                                fm = QtGui.QFontMetrics(tfont)
                                h_title = fm.height() + 8
                                try:
                                    off_pts = self._cm_to_points(float(self.sp_cash_title_offset_cm.value()))
                                except Exception:
                                    off_pts = 0.0
                                extra = off_pts if off_pts > 0 else 0.0
                                need_new_page = remaining_h < max(8.0, h_title + extra + min_row_h)
                            else:
                                need_new_page = remaining_h < max(8.0, min_row_h)
                        except Exception:
                            need_new_page = remaining_h < max(8.0, min_row_h)
                        if need_new_page:
                            try:
                                self._draw_watermark(painter, content, page_rect, pidx, pages_print if pages_print else pages, printer)
                            except Exception:
                                pass
                            try:
                                printer.newPage()
                            except Exception:
                                pass
                            y = 0
                    # Ø¹Ù†ÙˆØ§Ù† Ù‚Ø¨Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ù†Ù‚Ø¯ÙŠ
                    try:
                        if (table is getattr(self.parent, 'table_cash', None)) and (pidx == 1):
                            painter.save()
                            heading_pt = 18
                            try:
                                painter.setFont(QtGui.QFont(f.family(), heading_pt))
                            except Exception:
                                painter.setFont(QtGui.QFont('', heading_pt))
                            painter.setPen(QtCore.Qt.black)
                            fm = QtGui.QFontMetrics(painter.font())
                            h_title = fm.height() + 8
                            try:
                                off_pts2 = self._cm_to_points(float(self.sp_cash_title_offset_cm.value()))
                            except Exception:
                                off_pts2 = 0.0
                            y += 8 + off_pts2
                            rc_title = QtCore.QRectF(0, y, content.width(), h_title)
                            painter.drawText(rc_title, QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter, "Ø¶Ù…Ø§Ù†Ø§Øª Ù†Ù‚Ø¯ÙŠØ©")
                            painter.restore()
                            y += rc_title.height() + 16
                    except Exception:
                        pass
                    # ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªØ¬Ù†Ø¨ Ø¸Ù‡ÙˆØ± Ø³Ø·Ø± Ø¥Ø¶Ø§ÙÙŠ
                    rtl = False
                    try:
                        rtl = (table.layoutDirection() == QtCore.Qt.RightToLeft)
                    except Exception:
                        rtl = False

                    # Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ø§Ø·Ø¨Ø¹ Ø§Ù„ØµÙ 0 Ùˆ 1 ÙƒØ±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø©
                    if is_dept_matrix and table.rowCount() >= 2:
                        # Ø§Ø±Ø³Ù… Ø§Ù„ØµÙ 0 (Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆÙƒ) Ùˆ Ø§Ù„ØµÙ 1 (Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª) ÙƒØ±Ø¤ÙˆØ³
                        if rtl:
                            edge_adj = painter.pen().widthF() / 2.0 if painter.pen().widthF() > 0 else 0.5
                            x = total_w * k - edge_adj
                        else:
                            x = 0
                        # Ø·Ø¨Ù‘Ù‚ Ø®Ø· Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØµØµ
                        try:
                            hdr_font = QtGui.QFont(f.family(), max(6, int(self.sp_col_header_size.value())))
                            hdr_font.setBold(bool(self.chk_col_header_bold.isChecked()))
                            painter.setFont(hdr_font)
                        except Exception:
                            pass
                        # Ø§Ù„ØµÙ 0: Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆÙƒ â€” Ø¯Ù…Ø¬ Ø®Ù„Ø§ÙŠØ§ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨Ù†Ùƒ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ÙÙ„ØªØ± Ø¨Ù†Ùƒ
                        h_row0 = table.rowHeight(0) * sy * row_scale * k
                        cols_per_bank = 4
                        if bank_filter_active:
                            # Ø§Ø±Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹
                            try:
                                w_sec = _col_w(cols[0]) * sx * _col_scale_factor(cols[0]) * k
                            except Exception:
                                w_sec = _col_w(0) * sx * _col_scale_factor(0) * k
                            if rtl:
                                x -= w_sec
                            rect_sec = QtCore.QRectF(x, y, w_sec, h_row0)
                            painter.save(); painter.fillRect(rect_sec, QtGui.QColor(255, 255, 255))
                            pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                            painter.setPen(pen_hdr); painter.drawRect(rect_sec); painter.restore()
                            if not rtl:
                                x += w_sec
                            # Ø¯Ù…Ø¬ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© ÙÙŠ Ù…Ø³ØªØ·ÙŠÙ„ ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ
                            w_bank = 0.0
                            for cc in cols[1:1+cols_per_bank]:
                                w_bank += _col_w(cc) * sx * _col_scale_factor(cc) * k
                            if rtl:
                                x -= w_bank
                            rect_bank = QtCore.QRectF(x, y, w_bank, h_row0)
                            painter.save(); painter.fillRect(rect_bank, QtGui.QColor(255, 255, 255))
                            pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                            painter.setPen(pen_hdr); painter.drawRect(rect_bank)
                            try:
                                it = table.item(0, 1)
                                txt = it.text() if it else ""
                            except Exception:
                                txt = sel_bank_txt
                            painter.setPen(QtCore.Qt.black)
                            painter.drawText(rect_bank.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter, txt)
                            painter.restore()
                            if not rtl:
                                x += w_bank
                            # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± (Ø§Ù„Ø¹Ø§Ù…) ÙÙ‚Ø· Ø¥Ù† ÙˆÙØ¬Ø¯ ÙØ¹Ù„ÙŠÙ‹Ø§
                            has_global_total = False
                            try:
                                last_col = table.columnCount() - 1
                                it_tot_hdr = table.item(1, last_col)
                                has_global_total = bool(it_tot_hdr and (it_tot_hdr.text().strip() == "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"))
                            except Exception:
                                has_global_total = False
                            if has_global_total:
                                try:
                                    last_visual_col = cols[-1]
                                    w_tot = _col_w(last_visual_col) * sx * _col_scale_factor(last_visual_col) * k
                                except Exception:
                                    w_tot = _col_w(table.columnCount()-1) * sx * _col_scale_factor(table.columnCount()-1) * k
                                if rtl:
                                    x -= w_tot
                                rect_tot = QtCore.QRectF(x, y, w_tot, h_row0)
                                painter.save(); painter.fillRect(rect_tot, QtGui.QColor(255, 255, 255))
                                pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                                painter.setPen(pen_hdr); painter.drawRect(rect_tot); painter.restore()
                                if not rtl:
                                    x += w_tot
                            y += h_row0
                        else:
                            # Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: Ø§Ø±Ø³Ù… ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
                            for c in cols:
                                w = _col_w(c) * sx * _col_scale_factor(c) * k
                                if rtl:
                                    x -= w
                                rect = QtCore.QRectF(x, y, w, h_row0)
                                painter.save()
                                painter.fillRect(rect, QtGui.QColor(255, 255, 255))
                                pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                                painter.setPen(pen_hdr)
                                painter.drawRect(rect)
                                try:
                                    it = table.item(0, c)
                                    txt = it.text() if it else ""
                                except Exception:
                                    txt = ""
                                painter.setPen(QtCore.Qt.black)
                                painter.drawText(rect.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter, txt)
                                painter.restore()
                                if not rtl:
                                    x += w
                            y += h_row0
                        # Ø§Ù„ØµÙ 1: Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª
                        h_row1 = table.rowHeight(1) * sy * row_scale * k
                        if rtl:
                            x = total_w * k - edge_adj
                        else:
                            x = 0
                        for c in cols:
                            w = _col_w(c) * sx * _col_scale_factor(c) * k
                            if rtl:
                                x -= w
                            rect = QtCore.QRectF(x, y, w, h_row1)
                            painter.save()
                            painter.fillRect(rect, QtGui.QColor(255, 255, 255))
                            pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                            painter.setPen(pen_hdr)
                            painter.drawRect(rect)
                            # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙ 1
                            try:
                                it = table.item(1, c)
                                txt = it.text() if it else ""
                            except Exception:
                                txt = ""
                            painter.setPen(QtCore.Qt.black)
                            painter.drawText(rect.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter, txt)
                            painter.restore()
                            if not rtl:
                                x += w
                        y += h_row1
                    elif self.chk_repeat_header.isChecked():
                        if rtl:
                            edge_adj = painter.pen().widthF() / 2.0 if painter.pen().widthF() > 0 else 0.5
                            x = total_w * k - edge_adj
                            if apply_id:
                                x += (id_w_px * sx * k)
                        else:
                            x = 0
                        # Ø·Ø¨Ù‘Ù‚ Ø®Ø· Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØµØµ
                        try:
                            hdr_font = QtGui.QFont(f.family(), max(6, int(self.sp_col_header_size.value())))
                            hdr_font.setBold(bool(self.chk_col_header_bold.isChecked()))
                            painter.setFont(hdr_font)
                        except Exception:
                            pass
                        # Ø§Ø±Ø³Ù… Ø±Ø£Ø³ Ø¹Ù…ÙˆØ¯ ID Ù‚Ø¨Ù„ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…/Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª (Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·)
                        if apply_id:
                            w_id = id_w_px * sx * k
                            h = table.horizontalHeader().height() * sy * hdr_row_scale * k
                            if rtl:
                                x -= w_id
                            rect_id = QtCore.QRectF(x, y, w_id, h)
                            painter.save()
                            if style_mode == 1 and not is_dept_matrix and not is_dept_report:
                                painter.fillRect(rect_id, QtGui.QColor(255, 255, 255))
                                pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                                painter.setPen(pen_hdr)
                                painter.drawRect(rect_id)
                                painter.setPen(QtCore.Qt.black)
                                painter.drawText(rect_id.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignCenter, "ID")
                            else:
                                painter.fillRect(rect_id, QtGui.QColor(32, 32, 32))
                                pen_hdr = QtGui.QPen(QtCore.Qt.white, max(0.25, float(self.sp_border.value())))
                                painter.setPen(pen_hdr)
                                painter.drawRect(rect_id)
                                painter.setPen(QtCore.Qt.white)
                                painter.drawText(rect_id.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignCenter, "ID")
                            painter.restore()
                            if not rtl:
                                x += w_id
                        for c in cols:
                            w = _col_w(c) * sx * _col_scale_factor(c) * k
                            h = table.horizontalHeader().height() * sy * hdr_row_scale * k
                            if rtl:
                                x -= w
                            rect = QtCore.QRectF(x, y, w, h)
                            painter.save()
                            if style_mode == 1 and not is_dept_matrix and not is_dept_report:
                                painter.fillRect(rect, QtGui.QColor(255, 255, 255))
                                pen_hdr = QtGui.QPen(QtCore.Qt.black, max(0.25, float(self.sp_border.value())))
                                painter.setPen(pen_hdr)
                                painter.drawRect(rect)
                                txt = self._header_text(table, c)
                                painter.setPen(QtCore.Qt.black)
                                painter.drawText(rect.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignCenter, txt)
                            else:
                                painter.fillRect(rect, QtGui.QColor(32, 32, 32))
                                pen_hdr = QtGui.QPen(QtCore.Qt.white, max(0.25, float(self.sp_border.value())))
                                painter.setPen(pen_hdr)
                                painter.drawRect(rect)
                                txt = self._header_text(table, c)
                                painter.setPen(QtCore.Qt.white)
                                painter.drawText(rect.adjusted(6, 0, -6, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignCenter, txt)
                            painter.restore()
                            if not rtl:
                                x += w
                        y += table.horizontalHeader().height() * sy * hdr_row_scale * k

                    # Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø· Ø§Ù„ØµÙ Ø¨Ù†ØµÙ Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø±Ø£Ø³ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¶ÙˆØ­ Ø±Ø£Ø³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    f_row = QtGui.QFont(f)
                    try:
                        f_row.setPointSizeF(max(6.0, float(f.pointSizeF()) * 0.5))
                    except Exception:
                        pass
                    gno_idx = -1
                    attach_idx = -1
                    name_cols = set()
                    try:
                        for _ci in range(table.columnCount()):
                            _hn = (self._header_text(table, _ci) or "").strip()
                            if _hn in ("Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "g_no", "no", "RNO", "Ø±Ù‚Ù…"):
                                gno_idx = _ci
                            if _hn in ("Ù…Ø±ÙÙ‚", "Ø§Ù„Ù…Ø±ÙÙ‚", "Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª"):
                                attach_idx = _ci
                            if _hn in ("Ø§Ø³Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", "Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"):
                                name_cols.add(_ci)
                    except Exception:
                        gno_idx = -1
                        attach_idx = -1
                        name_cols = set()
                    unreg_set = set()
                    if gno_idx >= 0:
                        try:
                            cache_key = id(table)
                            cache = getattr(self, '_unreg_gnos_cache', None)
                            if not isinstance(cache, dict):
                                cache = {}
                                setattr(self, '_unreg_gnos_cache', cache)
                            if cache_key in cache:
                                unreg_set = cache[cache_key]
                            else:
                                gnos_all = []
                                if hasattr(table, 'item'):
                                    for _rr in range(int(getattr(table, 'rowCount', lambda: 0)())):
                                        _it = table.item(_rr, gno_idx)
                                        _txt = _it.text().strip() if _it else ""
                                        if _txt:
                                            _nn = normalize_gno(_txt)
                                            if _nn:
                                                gnos_all.append(_nn)
                                else:
                                    model = table.model()
                                    for _rr in range(int(model.rowCount())):
                                        _idx = model.index(_rr, gno_idx)
                                        _val = model.data(_idx, QtCore.Qt.DisplayRole)
                                        _txt = "" if _val is None else str(_val)
                                        if _txt:
                                            _nn = normalize_gno(_txt)
                                            if _nn:
                                                gnos_all.append(_nn)
                                gnos_all = list({g for g in gnos_all if g})
                                if gnos_all:
                                    conn = connect_db(); c = conn.cursor()
                                    q = f"SELECT g_no FROM guarantees WHERE g_no IN ({','.join(['?']*len(gnos_all))}) AND TRIM(COALESCE(user_status,''))='Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„'"
                                    rows_unreg = c.execute(q, gnos_all).fetchall()
                                    conn.close()
                                    unreg_set = {normalize_gno(r[0]) for r in rows_unreg if r and r[0]}
                                    cache[cache_key] = unreg_set
                        except Exception as e:
                            try:
                                _log(f"print: unregistered gnos query failed: {e}")
                            except Exception:
                                pass
                    painter.setFont(f_row)
                    # Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): ØªØ®Ø·Ù‘ Ø§Ù„ØµÙ 0 Ùˆ 1 Ù„Ø£Ù†Ù‡Ù…Ø§ Ø±Ø¤ÙˆØ³
                    start_row = r0
                    end_row = r1
                    if is_dept_matrix:
                        # ØªØ®Ø·Ù‘ Ø§Ù„ØµÙ 0 Ùˆ 1 (Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)
                        start_row = max(start_row, 2)
                        end_row = max(end_row, 2)
                    # Ø§Ù„Ø¹Ø¯Ø§Ø¯ print_row_counter ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù‚Ø¨Ù„ Ø­Ù„Ù‚Ø© Ø§Ù„ØµÙØ­Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ©
                    for r in range(start_row, end_row):
                        if rtl:
                            edge_adj = painter.pen().widthF() / 2.0 if painter.pen().widthF() > 0 else 0.5
                            x = total_w * k - edge_adj
                            if apply_id:
                                x += (id_w_px * sx * k)
                        else:
                            x = 0
                        
                        pad_row = 4 if style_mode == 3 else 6
                        base_row_h = table.rowHeight(r) * sy * row_scale * k
                        row_h_needed = base_row_h
                        is_unreg_row = False
                        try:
                            if gno_idx >= 0:
                                if hasattr(table, 'item'):
                                    _it_g = table.item(r, gno_idx)
                                    _g_txt = _it_g.text().strip() if _it_g else ""
                                else:
                                    model = table.model()
                                    _idx_g = model.index(r, gno_idx)
                                    _val_g = model.data(_idx_g, QtCore.Qt.DisplayRole)
                                    _g_txt = "" if _val_g is None else str(_val_g)
                                if _g_txt:
                                    _ng = normalize_gno(_g_txt)
                                    is_unreg_row = (_ng in unreg_set)
                        except Exception:
                            is_unreg_row = False
                        skip_zero_row = False
                        if is_dept_matrix and bank_filter_active:
                            try:
                                last_total_col = table.columnCount() - 1
                                it_tot = table.item(r, last_total_col)
                                txt_tot = it_tot.text() if it_tot else ""
                                tnum = (txt_tot or "")
                                tnum = tnum.replace("\u200f","" ).replace("\u200e","" )
                                tnum = tnum.translate(str.maketrans("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©", "0123456789"))
                                tnum = tnum.replace(",","" ).replace(" ", "")
                                tnum = tnum.replace("%","" )
                                tnum = tnum.replace("Ù«",".")
                                val = float(tnum) if tnum else 0.0
                            except Exception:
                                val = 0.0
                            try:
                                it0 = table.item(r, 0)
                                is_total_row = bool(it0 and (it0.text().strip() == "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"))
                            except Exception:
                                is_total_row = False
                            skip_zero_row = (not is_total_row) and (val == 0.0)
                        if skip_zero_row:
                            continue
                        # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·
                        print_row_counter += 1
                        if apply_id:
                            w_id = id_w_px * sx * k
                            h = row_h_needed
                            if rtl:
                                x -= w_id
                            rect_id = QtCore.QRectF(x, y, w_id, h)
                            bg_color = QtGui.QColor(255, 255, 255)
                            alpha_bg = int(255 * 0.85)
                            # Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
                            if is_dept_matrix:
                                painter.fillRect(rect_id, bg_color)
                            elif is_dept_report:
                                painter.fillRect(rect_id, bg_color)
                            else:
                                if self.chk_print_bg.isChecked():
                                    if is_unreg_row:
                                        bg_color = QtGui.QColor(235, 235, 235)
                                    try:
                                        bg_color.setAlpha(alpha_bg)
                                    except Exception:
                                        pass
                                    painter.fillRect(rect_id, bg_color)
                                else:
                                    if style_mode == 2 and ((r - r0) % 2 == 1):
                                        bg_color = QtGui.QColor(245, 245, 245)
                                    if is_unreg_row:
                                        bg_color = QtGui.QColor(235, 235, 235)
                                    try:
                                        bg_color.setAlpha(alpha_bg)
                                    except Exception:
                                        pass
                                    painter.fillRect(rect_id, bg_color)
                            painter.drawRect(rect_id)
                            lum = 0.299 * bg_color.red() + 0.587 * bg_color.green() + 0.114 * bg_color.blue()
                            if self.chk_white_text.isChecked():
                                pen_col = QtCore.Qt.white if lum < 160 else QtCore.Qt.black
                            else:
                                pen_col = QtCore.Qt.white if lum < 128 else QtCore.Qt.black
                            painter.setPen(pen_col)
                            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆÙ„ÙŠØ³ Ø±Ù‚Ù… Ø§Ù„ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                            seq_txt = str(print_row_counter)
                            painter.drawText(rect_id.adjusted(4, 0, -4, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter, seq_txt)
                            if not rtl:
                                x += w_id
                        for c in cols:
                            w = _col_w(c) * sx * _col_scale_factor(c) * k
                            h = row_h_needed
                            if rtl:
                                x -= w
                            rect = QtCore.QRectF(x, y, w, h)
                            bg_color = QtGui.QColor(255, 255, 255)
                            alpha_bg = int(255 * 0.85)
                            # ØªØ¸Ù„ÙŠÙ„ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØµÙÙˆÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø§Ù„Ø®ÙÙŠÙ ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                            try:
                                is_total_row = False
                                if is_dept_matrix:
                                    it0 = table.item(r, 0)
                                    is_total_row = bool(it0 and (it0.text().strip() == "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"))
                                last_total_col = table.columnCount() - 1
                                is_total_col = bool(is_dept_matrix and (c == last_total_col or (1 <= c < last_total_col and ((c - 1) % 4) == 3)))
                                if is_total_row or is_total_col:
                                    bg_color = QtGui.QColor(238, 238, 238)
                            except Exception:
                                pass
                            if self.chk_print_bg.isChecked():
                                if hasattr(table, 'item'):
                                    it = table.item(r, c)
                                    if it and it.background().color().isValid():
                                        bg_color = it.background().color()
                                else:
                                    try:
                                        model = table.model()
                                        idx = model.index(r, c)
                                        bg = model.data(idx, QtCore.Qt.BackgroundRole)
                                        col = bg.color() if isinstance(bg, QtGui.QBrush) else (bg if isinstance(bg, QtGui.QColor) else None)
                                        if col and col.isValid():
                                            bg_color = col
                                    except Exception:
                                        pass
                                if is_unreg_row:
                                    bg_color = QtGui.QColor(235, 235, 235)
                                try:
                                    bg_color.setAlpha(alpha_bg)
                                except Exception:
                                    pass
                                painter.fillRect(rect, bg_color)
                            else:
                                if style_mode == 2 and ((r - r0) % 2 == 1):
                                    bg_color = QtGui.QColor(245, 245, 245)
                                if is_unreg_row:
                                    bg_color = QtGui.QColor(235, 235, 235)
                                try:
                                    bg_color.setAlpha(alpha_bg)
                                except Exception:
                                    pass
                                painter.fillRect(rect, bg_color)
                            if hasattr(table, 'item'):
                                it = table.item(r, c)
                                txt = it.text() if it else ""
                            else:
                                try:
                                    model = table.model()
                                    idx = model.index(r, c)
                                    val = model.data(idx, QtCore.Qt.DisplayRole)
                                    txt = "" if val is None else str(val)
                                except Exception:
                                    txt = ""
                            try:
                                no_attach = False
                                if attach_idx >= 0:
                                    if hasattr(table, 'item'):
                                        it_att = table.item(r, attach_idx)
                                        t_att = (it_att.text().strip() if it_att and it_att.text() else "")
                                    else:
                                        _idxa = model.index(r, attach_idx)
                                        _vala = model.data(_idxa, QtCore.Qt.DisplayRole)
                                        t_att = "" if _vala is None else str(_vala).strip()
                                    no_attach = (t_att in ("", "Ù„Ø§", "0", "False", "false"))
                                if (c in name_cols) and no_attach and txt:
                                    txt = f"{txt} âœ–"
                            except Exception:
                                pass
                            painter.drawRect(rect)
                            lum = 0.299 * bg_color.red() + 0.587 * bg_color.green() + 0.114 * bg_color.blue()
                            if self.chk_white_text.isChecked():
                                pen_col = QtCore.Qt.white if lum < 160 else QtCore.Qt.black
                            else:
                                pen_col = QtCore.Qt.white if lum < 128 else QtCore.Qt.black
                            painter.setPen(pen_col);
                            align = QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter
                            pad = pad_row
                            disp = QtGui.QFontMetrics(painter.font()).elidedText(txt, QtCore.Qt.ElideRight, int(rect.width() - 2 * pad))
                            painter.drawText(rect.adjusted(pad, 0, -pad, 0), align, disp)
                            if not rtl:
                                x += w
                        y += row_h_needed

                    try:
                        st_val = str(self.parent.cmb_status.currentText()).strip() if getattr(self.parent, 'cmb_status', None) else ''
                    except Exception:
                        st_val = ''
                    try:
                        gt_val = str(self.parent.cmb_gtype.currentText()).strip() if getattr(self.parent, 'cmb_gtype', None) else ''
                    except Exception:
                        gt_val = ''
                    try:
                        cash_val = str(self.parent.cmb_cash.currentText()).strip() if getattr(self.parent, 'cmb_cash', None) else ''
                    except Exception:
                        cash_val = ''
                    do_page_total = self.chk_total_per_page.isChecked() and sel_total_cols and ((st_val and st_val != 'Ø§Ù„ÙƒÙ„') or (gt_val and gt_val != 'Ø§Ù„ÙƒÙ„') or (cash_val and cash_val != 'Ø§Ù„ÙƒÙ„'))
                    if do_page_total:
                        totals = self._compute_totals(table, (r0, r1), sel_total_cols)
                        if rtl:
                            edge_adj = painter.pen().widthF() / 2.0 if painter.pen().widthF() > 0 else 0.5
                            x = total_w * k - edge_adj
                            if apply_id:
                                x += (id_w_px * sx * k)
                        else:
                            x = 0
                        try:
                            _base_h = int(getattr(self, 'sp_total_row_h', None).value()) if hasattr(self, 'sp_total_row_h') else 28
                            h_row = float(_base_h) * sy * k
                        except Exception:
                            h_row = 28.0 * sy * k
                        for c in cols:
                            w = _col_w(c) * sx * _col_scale_factor(c) * k
                            name = self._header_text(table, c)
                            if rtl:
                                x -= w
                            rect = QtCore.QRectF(x, y, w, h_row)
                            painter.drawRect(rect)
                            if name in totals:
                                try:
                                    pg_pt = int(getattr(self, 'sp_total_page_font_pt', None).value()) if hasattr(self, 'sp_total_page_font_pt') else 9
                                except Exception:
                                    pg_pt = 9
                                painter.setFont(QtGui.QFont(f.family(), max(6, int(pg_pt * eff_font_scale))))
                                painter.setPen(QtCore.Qt.black)
                                painter.drawText(rect.adjusted(4, 0, -4, 0), QtCore.Qt.AlignVCenter | QtCore.Qt.AlignRight, f"{totals[name]:,.2f}")
                            if not rtl:
                                x += w
                        y += h_row

                    painter.restore()

                    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙÙ„ÙŠ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®Ø¶Ø±) Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±

                    # Ù…Ù„Ø®Øµ Ø±Ø¦ÙŠØ³ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù… (ØªØ¹Ø¯ÙŠÙ„ Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø§Ù‚Ø³Ø§Ù…)
                    try:
                        show_summary = False
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ø±Ø· Ø§Ù„Ø¸Ù‡ÙˆØ±: Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©ØŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ØŒ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…ÙØ¹Ù„ØŒ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ¹Ù„
                        if pidx == (pages_print if pages_print else pages) and (ti == 0) and is_main_dept_summary:
                            try:
                                if getattr(self, 'chk_bank_sum_visible', None) and self.chk_bank_sum_visible.isChecked():
                                    show_summary = True
                            except:
                                show_summary = True # Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯

                        if show_summary:
                            # 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± ÙˆÙ…ÙˆØ«ÙˆÙ‚
                            try: row_h = int(self.sp_bank_sum_row_h.value())
                            except: row_h = 32
                            
                            try: font_pt = max(6, int(self.sp_bank_sum_row_pt.value()))
                            except: font_pt = 9
                            
                            try: hdr_pt = max(6, int(self.sp_bank_sum_hdr_pt.value()))
                            except: hdr_pt = 10
                            
                            try: gap_pts = self._cm_to_points(float(self.sp_bank_sum_gap.value()))
                            except: gap_pts = self._cm_to_points(1.50)
                            
                            try: align_txt = str(self.cmb_bank_sum_align.currentText())
                            except: align_txt = "Ù…Ù†ØªØµÙ"
                            
                            try: offset_pts = self._cm_to_points(float(self.sp_bank_sum_offset_cm.value()))
                            except: offset_pts = 0.0
                            
                            try: width_pct = float(self.sp_bank_sum_width_pct.value()) / 100.0
                            except: width_pct = 0.90
                            
                            try: auto_layout = bool(self.chk_bank_sum_auto.isChecked())
                            except: auto_layout = True
                            
                            try: use_zebra = bool(self.chk_bank_sum_zebra.isChecked())
                            except: use_zebra = True

                            # 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø£ÙƒØ«Ø± Ø°ÙƒØ§Ø¡Ù‹)
                            idx_bank = idx_type = idx_amount = idx_cash = idx_status = None
                            
                            # Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒØ´Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù…
                            for i in range(table.columnCount()):
                                nm = self._header_text(table, i).strip()
                                if nm == "Ø§Ù„Ø¨Ù†Ùƒ": idx_bank = i
                                elif nm in ("Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø§Ù„Ù†ÙˆØ¹"): idx_type = i
                                elif nm in ("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø§Ù„Ù‚ÙŠÙ…Ø©"): idx_amount = i
                                elif nm in ("Ù†Ù‚Ø¯ÙŠ", "Ù†Ù‚Ø¯ÙŠØŸ"): idx_cash = i
                                elif nm in ("Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ)"): idx_status = i
                            
                            # Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ÙƒØ´Ù
                            if idx_bank is None or idx_type is None or idx_amount is None:
                                idx_bank, idx_type, idx_amount, idx_cash, idx_status = 1, 3, 4, 14, 13

                            sums_by_bank = {}
                            for rr in range(table.rowCount()):
                                # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙÙˆÙ ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù†Ù‚Ø¯ÙŠ / Ù…Ù†ØªÙ‡ÙŠ)
                                is_excluded = False
                                try:
                                    if idx_cash is not None:
                                        it_c = table.item(rr, idx_cash)
                                        t_c = (it_c.text().strip() if it_c and it_c.text() else "")
                                        if t_c in ("Ù†Ø¹Ù…", "1", "true", "True"): is_excluded = True
                                except: pass
                                
                                try:
                                    if idx_status is not None and not is_excluded:
                                        it_s = table.item(rr, idx_status)
                                        t_s = (it_s.text().strip() if it_s and it_s.text() else "")
                                        if t_s == "Ù…Ù†ØªÙ‡ÙŠ": is_excluded = True
                                except: pass
                                
                                if is_excluded: continue

                                it_b = table.item(rr, idx_bank)
                                it_t = table.item(rr, idx_type)
                                it_a = table.item(rr, idx_amount)
                                
                                b_raw = it_b.text() if it_b else ""
                                g_type = (it_t.text() if it_t else "").strip()
                                try:
                                    txt_amt = it_a.text() if it_a else "0"
                                    amt = float(str(txt_amt.replace(',', '')).strip() or 0)
                                except: amt = 0.0

                                bname = normalize_bank(b_raw or "", "")
                                if bname not in sums_by_bank:
                                    sums_by_bank[bname] = {"initial": 0.0, "final": 0.0, "financial": 0.0}
                                
                                gt = g_type.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
                                if any(x in gt for x in ["Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰", "Ù…Ø¨Ø¯Ø¦ÙŠ", "Ù…Ø¨Ø¯Ø¦Ù‰"]):
                                    sums_by_bank[bname]["initial"] += amt
                                elif any(x in gt for x in ["Ù†Ù‡Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦Ù‰"]):
                                    sums_by_bank[bname]["final"] += amt
                                elif any(x in gt for x in ["Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ù…Ø§Ù„ÙŠØ©", "Ù…Ø§Ù„Ù‰"]):
                                    sums_by_bank[bname]["financial"] += amt

                            # 3. Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                            rows_cnt = len(sums_by_bank) + 2 # Header + Total
                            tbl_h = rows_cnt * row_h
                            content_w = content.width() - 6
                            target_tbl_w = content_w * width_pct
                            
                            try: font_obj = QtGui.QFont(f.family(), font_pt)
                            except: font_obj = QtGui.QFont("Arial", font_pt)
                            fm = QtGui.QFontMetrics(font_obj)
                            
                            try: hdr_font_obj = QtGui.QFont(f.family(), hdr_pt); hdr_font_obj.setBold(True)
                            except: hdr_font_obj = font_obj

                            col_ws = []
                            hdrs = ["Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦ÙŠ", "Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"]
                            
                            if auto_layout:
                                pad = 24  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ù„ØªØ¬Ù†Ø¨ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ù†ØµÙˆØµ
                                min_col_w = 65  # Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ
                                
                                # Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                                fm_h = QtGui.QFontMetrics(hdr_font_obj)
                                max_ws = [max(min_col_w, fm_h.width(h) + pad) for h in hdrs]
                                # Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                                max_ws[0] = max(max_ws[0], 120)

                                for b, s in sums_by_bank.items():
                                    vals = [
                                        str(b),
                                        f"{s['initial']:,.2f}",
                                        f"{s['final']:,.2f}",
                                        f"{s['financial']:,.2f}",
                                        f"{(s['initial'] + s['final'] + s['financial']):,.2f}"
                                    ]
                                    for i, v in enumerate(vals):
                                        w = fm.width(v) + pad
                                        if w > max_ws[i]: max_ws[i] = w
                                
                                # ØªÙˆØ­ÙŠØ¯ Ø¹Ø±Ø¶ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø£Ù†Ø§Ù‚Ø©
                                max_num_w = max(max_ws[1], max_ws[2], max_ws[3], max_ws[4])
                                col_ws = [max_ws[0], max_num_w, max_num_w, max_num_w, max_num_w]
                                
                                sum_w = sum(col_ws)
                                
                                # ØªØ·Ø¨ÙŠÙ‚ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¹ ØªÙˆØ²ÙŠØ¹ Ø°ÙƒÙŠ Ù„Ù„Ù…Ø³Ø§Ø­Ø©
                                if sum_w < target_tbl_w:
                                    diff = target_tbl_w - sum_w
                                    # ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ§Ø¦Ø¶: 40% Ù„Ù„Ø¨Ù†ÙƒØŒ 60% Ù„Ù„Ø£Ø±Ù‚Ø§Ù… (15% Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯)
                                    col_ws[0] += diff * 0.40
                                    per_col = (diff * 0.60) / 4.0
                                    for i in range(1, 5):
                                        col_ws[i] += per_col
                                    
                                    tbl_w = target_tbl_w
                                elif sum_w > content_w:
                                    # ØªÙ‚Ù„ÙŠØµ Ù†Ø³Ø¨ÙŠ Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©
                                    scale = content_w / sum_w
                                    col_ws = [w * scale for w in col_ws]
                                    tbl_w = content_w
                                else:
                                    tbl_w = sum_w
                            else:
                                # ØªØ®Ø·ÙŠØ· ÙŠØ¯ÙˆÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨
                                try: pct_bank = float(self.sp_bank_sum_bank_pct.value())
                                except: pct_bank = 52.0
                                try: pct_num = float(self.sp_bank_sum_num_pct.value())
                                except: pct_num = 12.0
                                
                                total_pct = pct_bank + 4 * pct_num
                                if total_pct <= 0: total_pct = 100.0
                                
                                # Ø§Ù„Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª ÙƒÙ…Ø§ Ø·Ù„Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·
                                tbl_w = target_tbl_w
                                scale = tbl_w / total_pct
                                col_ws = [pct_bank * scale, pct_num * scale, pct_num * scale, pct_num * scale, pct_num * scale]

                            # 4. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙÙˆØ§ØµÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                            remaining_h = (content.bottom() - (content.top() + y))
                            need_new = remaining_h < (tbl_h + gap_pts)
                            
                            if need_new:
                                try: self._draw_watermark(painter, content, page_rect, pidx, pages_print if pages_print else pages, printer)
                                except: pass
                                try: printer.newPage()
                                except: pass
                                y = 0
                            else:
                                y += gap_pts

                            if align_txt == "ÙŠØ³Ø§Ø±": xstart = offset_pts
                            elif align_txt == "Ù…Ù†ØªØµÙ": xstart = max(0.0, (content.width() - tbl_w) / 2.0) + offset_pts
                            else: xstart = max(0.0, content.width() - tbl_w - offset_pts)

                            # 5. Ø§Ù„Ø±Ø³Ù… Ø§Ù„ÙØ¹Ù„ÙŠ
                            painter.save()
                            painter.translate(content.left() + xstart, content.top())
                            
                            # Ø§Ù„Ø®Ù„ÙÙŠØ©
                            painter.setPen(QtGui.QPen(QtCore.Qt.black, 1.0))
                            painter.fillRect(QtCore.QRectF(0, y, tbl_w, tbl_h), QtGui.QColor(255, 255, 255))
                            
                            # Ø§Ù„Ù‡ÙŠØ¯Ø±
                            painter.setFont(hdr_font_obj)
                            x2 = tbl_w
                            for i, nm in enumerate(hdrs):
                                ww = col_ws[i]
                                rc = QtCore.QRectF(x2 - ww, y, ww, row_h)
                                painter.drawRect(rc)
                                painter.drawText(rc, QtCore.Qt.AlignCenter, nm)
                                x2 -= ww
                            y += row_h
                            
                            # Ø§Ù„ØµÙÙˆÙ
                            painter.setFont(font_obj)
                            grand_i = grand_f = grand_m = 0.0
                            row_idx = 0
                            
                            for b, s in sorted(sums_by_bank.items()):
                                if use_zebra and (row_idx % 2 == 1):
                                    painter.fillRect(QtCore.QRectF(0, y, tbl_w, row_h), QtGui.QColor(240, 240, 240))
                                
                                total_v = s["initial"] + s["final"] + s["financial"]
                                vals = [b, s["initial"], s["final"], s["financial"], total_v]
                                grand_i += s["initial"]; grand_f += s["final"]; grand_m += s["financial"]
                                
                                x2 = tbl_w
                                for i, v in enumerate(vals):
                                    ww = col_ws[i]
                                    rc = QtCore.QRectF(x2 - ww, y, ww, row_h)
                                    painter.setPen(QtCore.Qt.black)
                                    painter.drawRect(rc)
                                    
                                    if i == 0: # Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ
                                        painter.drawText(rc.adjusted(4, 0, -4, 0), QtCore.Qt.AlignCenter, str(v))
                                    else:
                                        painter.drawText(rc.adjusted(4, 0, -4, 0), QtCore.Qt.AlignCenter, f"{v:,.2f}")
                                    x2 -= ww
                                y += row_h
                                row_idx += 1
                                
                            # ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                            painter.setFont(hdr_font_obj)
                            painter.fillRect(QtCore.QRectF(0, y, tbl_w, row_h), QtGui.QColor(230, 230, 230))
                            
                            vals_tot = ["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", grand_i, grand_f, grand_m, (grand_i + grand_f + grand_m)]
                            x2 = tbl_w
                            for i, v in enumerate(vals_tot):
                                ww = col_ws[i]
                                rc = QtCore.QRectF(x2 - ww, y, ww, row_h)
                                painter.drawRect(rc)
                                if i == 0:
                                    painter.drawText(rc.adjusted(4, 0, -4, 0), QtCore.Qt.AlignCenter, str(v))
                                else:
                                    painter.drawText(rc.adjusted(4, 0, -4, 0), QtCore.Qt.AlignCenter, f"{v:,.2f}")
                                x2 -= ww

                            painter.restore()
                            
                            # ØªØ­Ø¯ÙŠØ« Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠ (Ù„ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
                            try:
                                self._next_table_same_page = True
                                self._next_table_y_offset = y + row_h + 14
                            except: pass

                    except Exception as e:
                        print(f"Error drawing dept summary: {e}")
                        pass

                    # Ø§Ø±Ø³Ù… Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙ‚Ø· â€” Ø¨Ø¹Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ³Ù‡ÙŠÙ„Ø§Øª ÙÙ‚Ø·
                    try:
                        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙÙ„ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ ÙÙ‚Ø·
                        has_bank_filter = False
                        try:
                            parent = getattr(self, 'parent', None)
                            if parent:
                                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ
                                cmb_bank = getattr(parent, 'cmb_bank', None)
                                if cmb_bank:
                                    bank_text = cmb_bank.currentText().strip() if hasattr(cmb_bank, 'currentText') else ''
                                    if bank_text and bank_text != 'Ø§Ù„ÙƒÙ„':
                                        has_bank_filter = True
                        except Exception:
                            pass
                        
                        if getattr(self, 'chk_props_footer', None) and self.chk_props_footer.isChecked() and not is_dept_report and (table is getattr(self.parent, 'table', None)) and not is_main_dept_summary and has_bank_filter:
                            sep = bool(getattr(self, 'chk_props_footer_single_page', None) and self.chk_props_footer_single_page.isChecked())
                            if not sep and (pidx == (pages_print if pages_print else pages)):
                                # ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·
                                if is_bank_detailed and ti > 0:
                                    pass
                                else:
                                    vals = props_values or self._compute_props_values(None)
                                    if vals:
                                        row_h = max(16, int(getattr(self, 'sp_props_row_h', None).value() if hasattr(self, 'sp_props_row_h') else 90))
                                        props_h = len(vals) * row_h + 8
                                        # Ù†Ø³Ø¨Ø© Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙˆÙ…Ø³Ø§ÙØ© Ø§Ù„ÙØµÙ„ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                                        try:
                                            width_pct = float(getattr(self, 'sp_props_width_pct', None).value()) if hasattr(self, 'sp_props_width_pct') else 42.0
                                        except Exception:
                                            width_pct = 42.0
                                        try:
                                            gap_cm = float(getattr(self, 'sp_props_gap', None).value()) if hasattr(self, 'sp_props_gap') else 2.80
                                            gap = self._cm_to_points(gap_cm)
                                        except Exception:
                                            gap = self._cm_to_points(2.80)
                                        try:
                                            # Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„ÙŠØ¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (6px)
                                            props_w = min(content.width() * max(10.0, width_pct) / 100.0, content.width() - 6)
                                        except Exception:
                                            props_w = content.width() - 6
                                        # ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¶Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±/Ù…Ù†ØªØµÙ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
                                        try:
                                            align_txt = getattr(self, 'cmb_props_align', None).currentText() if hasattr(self, 'cmb_props_align') else "ÙŠÙ…ÙŠÙ†"
                                        except Exception:
                                            align_txt = "ÙŠÙ…ÙŠÙ†"
                                        # Ø¥Ø²Ø§Ø­Ø© Ø£ÙÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø³Ù…)
                                        try:
                                            offset_pts = self._cm_to_points(float(getattr(self, 'sp_props_offset_cm', None).value())) if hasattr(self, 'sp_props_offset_cm') else self._cm_to_points(10.00)
                                        except Exception:
                                            offset_pts = self._cm_to_points(10.00)
                                        # Ø¥Ù† Ù„Ù… ØªØªØ³Ø¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø®ØµØ§Ø¦ØµØŒ Ø§Ù†Ù‚Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
                                        try:
                                            fits_here = (content.top() + y + gap + props_h) <= (content.bottom() - 2)
                                        except Exception:
                                            fits_here = True
                                        if not fits_here:
                                            # Ø¥Ù† ÙƒØ§Ù†Øª ØµÙØ­Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù„Ø§ ØªØªØ³Ø¹ Ù‡Ù†Ø§ØŒ Ø§Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø£ÙˆÙ„Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                                            # Ø­ØªÙ‰ Ù„Ø§ ØªØ®Ø±Ø¬ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ©ØŒ Ø«Ù… Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©.
                                            try:
                                                self._draw_watermark(painter, content, page_rect, pidx, pages_print if pages_print else pages, printer)
                                            except Exception:
                                                pass
                                            try:
                                                printer.newPage()
                                            except Exception:
                                                pass
                                            # Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø£Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                                            y = 0
                                        if align_txt == "ÙŠØ³Ø§Ø±":
                                            xstart = content.left() + offset_pts
                                        elif align_txt == "Ù…Ù†ØªØµÙ":
                                            xstart = content.left() + (content.width() - props_w) / 2.0
                                        else:  # ÙŠÙ…ÙŠÙ†
                                            xstart = content.right() - props_w - offset_pts
                                        rect2 = QtCore.QRectF(xstart,
                                                              content.top() + y + gap,
                                                              props_w, props_h)
                                        self._draw_props_footer(painter, rect2, vals, f.family())
                                        # Ø¹Ù„Ù… Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª Ù…Ø³Ø§Ø­Ø©Ø› Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø±Ø£Ø³ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                                        try:
                                            self._next_table_same_page = True
                                            self._next_table_y_offset = y + gap + props_h + 6
                                        except Exception:
                                            pass
                    except Exception:
                        pass

                    # Ø®ÙŠØ§Ø±: Ø¹Ø±Ø¶ Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙÙŠ ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
                    # ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø© Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±ØºØ¨ØªÙƒ

                    # Ø§Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
                    self._draw_watermark(painter, content, page_rect, pidx, pages_print if pages_print else pages, printer)

                    # Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©ØŒ Ø§Ø³Ù…Ø­ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¨Ø¯Ø¡ Ù‡Ù†Ø§
                    try:
                        if pidx == (pages_print if pages_print else pages):
                            if not getattr(self, '_next_table_same_page', False):
                                remaining_h = content.bottom() - (content.top() + y)
                                
                                # ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„
                                is_bank_detailed = False
                                try:
                                    if getattr(self.parent, "tabs", None) and getattr(self.parent, "_bank_detailed_tab_widget", None):
                                        if self.parent.tabs.currentWidget() is self.parent._bank_detailed_tab_widget:
                                            is_bank_detailed = True
                                except Exception:
                                    pass

                                # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© > 10% Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ > 60 Ù†Ù‚Ø·Ø©ØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ù…Ø¬
                                # ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø§Ù„Ù…ÙØµÙ„ØŒ Ø§Ù‚Ø¨Ù„ Ø¨Ù…Ø³Ø§Ø­Ø© Ø£Ù‚Ù„ (40 Ù†Ù‚Ø·Ø©) Ù„Ø£Ù† Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ØµØºÙŠØ±Ø©
                                threshold = 40 if is_bank_detailed else 100
                                pct_threshold = 0.05 if is_bank_detailed else 0.15
                                
                                if remaining_h > threshold or remaining_h > (content.height() * pct_threshold):
                                    self._next_table_same_page = True
                                    try:
                                        spacing_val = float(self.sp_table_spacing.value())
                                    except Exception:
                                        spacing_val = 20.0
                                    self._next_table_y_offset = y + spacing_val
                    except Exception:
                        pass
        # Ø¨Ø¹Ø¯ Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ù„Ø§ ØªÙ†ÙÙ‘Ø° Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠ Ø£Ø¯Ù†Ø§Ù‡
        if painter_override is None:
            painter.restore(); painter.end()
        return
    def _print(self):
        self._save_settings()
        # ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ù…Ø²Ø§Ù…Ù†Ø© Ø§ØªØ¬Ø§Ù‡/Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ ÙØªØ­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        try:
            self._apply_printer_settings(self.printer)
            # ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®
            if hasattr(self, 'sp_copies'):
                self.printer.setCopyCount(self.sp_copies.value())
        except Exception:
            pass
        # Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©
        print_notification = None
        try:
            print_notification = QtWidgets.QDialog(self)
            print_notification.setWindowTitle("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
            print_notification.setWindowFlags(QtCore.Qt.Dialog | QtCore.Qt.FramelessWindowHint | QtCore.Qt.WindowStaysOnTopHint)
            print_notification.setModal(False)
            try:
                pal = QtWidgets.QApplication.palette()
                hi = pal.color(QtGui.QPalette.Highlight)
                ht = pal.color(QtGui.QPalette.HighlightedText)
                style = f"""
                QDialog {{
                    background: rgba({hi.red()}, {hi.green()}, {hi.blue()}, 220);
                    border-radius: 15px;
                    padding: 20px;
                }}
                QLabel {{
                    color: rgb({ht.red()}, {ht.green()}, {ht.blue()});
                    font-size: 16px;
                    font-weight: 600;
                    background: transparent;
                }}
                """
                print_notification.setStyleSheet(style)
            except Exception:
                print_notification.setStyleSheet("""
                    QDialog { background: rgba(0, 0, 0, 200); border-radius: 15px; padding: 20px; }
                    QLabel { color: #fff; font-size: 16px; font-weight: 600; background: transparent; }
                """)
            layout = QtWidgets.QVBoxLayout(print_notification)
            layout.setContentsMargins(30, 30, 30, 30)
            label = QtWidgets.QLabel("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...", print_notification)
            label.setAlignment(QtCore.Qt.AlignCenter)
            layout.addWidget(label)
            print_notification.adjustSize()
            # ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©
            screen = QtWidgets.QApplication.desktop().screenGeometry()
            x = (screen.width() - print_notification.width()) // 2
            y = (screen.height() - print_notification.height()) // 2
            print_notification.move(x, y)
            print_notification.show()
            QtWidgets.QApplication.processEvents()
        except Exception:
            pass
        try:
            if True:  # Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù…ÙØ¹Ù„Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
                # Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªÙØ§Ø¯ÙŠ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"
                try:
                    painter = QtGui.QPainter(self.printer)
                    self._render(self.printer, painter_override=painter)
                    painter.end()
                    try:
                        self.accept()
                    except Exception:
                        self.close()
                except Exception:
                    # ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„ Ù†Ø¹ÙˆØ¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                    dlg = QtPrintSupport.QPrintDialog(self.printer, self)
                    if dlg.exec_() == QtWidgets.QDialog.Accepted:
                        painter = QtGui.QPainter(self.printer)
                        self._render(self.printer, painter_override=painter)
                        painter.end()
                        try:
                            self.accept()
                        except Exception:
                            self.close()
        finally:
            # Ø¥Ø®ÙØ§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            try:
                if print_notification:
                    print_notification.close()
                    print_notification.deleteLater()
            except Exception:
                pass
            try:
                self._print_overlay.hide()
            except Exception:
                pass

    def _save_pdf_from_preview(self):
        """Ø­ÙØ¸ PDF Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·."""
        try:
            self._save_settings()
        except Exception:
            pass
        # Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© (Ø¥Ù† ÙƒØ§Ù† ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ ØªÙØµÙŠÙ„ÙŠÙ‹Ø§)
        try:
            bank = self._parse_bank_from_title() or "report"
        except Exception:
            bank = "report"
        default_name = f"{bank}.pdf"
        path, _ = QtWidgets.QFileDialog.getSaveFileName(self, "Ø­ÙØ¸ PDF", default_name, "PDF (*.pdf)")
        if not path:
            return
        # Ø£Ù†Ø´Ø¦ Ø·Ø§Ø¨Ø¹Ø© PDF ÙˆØ·Ø¨Ù‘Ù‚ Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ù†Ø³Ø® ÙƒØ§Ù…Ù„ Ù…Ù† Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)
        printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
        try:
            printer.setOutputFormat(QtPrintSupport.QPrinter.PdfFormat)
            printer.setOutputFileName(path)
        except Exception:
            pass
        # Ø·Ø¨Ù‘Ù‚ Ù†ÙØ³ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª ÙˆØ§Ù„ØªØ­Ø¬ÙŠÙ…
        try:
            src = self.printer
            try:
                printer.setPageSize(src.pageSize())
            except Exception:
                pass
            try:
                printer.setOrientation(src.orientation())
            except Exception:
                pass
            try:
                printer.setFullPage(src.fullPage())
            except Exception:
                # Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ø¯ÙŠÙ†Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§
                printer.setFullPage(True)
            try:
                # Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¯Ù‚Ø© Ù„ØªÙØ§Ø¯ÙŠ Ø§Ø®ØªÙ„Ø§Ù Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
                res = int(src.resolution() or 300)
                printer.setResolution(max(96, res))
            except Exception:
                printer.setResolution(300)
            try:
                printer.setColorMode(src.colorMode())
            except Exception:
                pass
        except Exception:
            # ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©ØŒ Ø·Ø¨Ù‘Ù‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            try:
                self._apply_printer_settings(printer)
            except Exception:
                pass
        # Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ§Ù…
        try:
            # Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªØ§Ù…Ø©
            painter = QtGui.QPainter(printer)
            self._render(printer, painter_override=painter)
            painter.end()
        except Exception as e:
            try:
                QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", f"ØªØ¹Ø°Ø± Ø­ÙØ¸ PDF: {e}")
            except Exception:
                pass

    def _export_excel_from_preview(self):
        """ØªØµØ¯ÙŠØ± Excel Ø¨Ù†ÙØ³ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ ÙƒÙ…Ø§ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©."""
        try:
            from openpyxl import Workbook
            from openpyxl.styles import Font, Alignment, Border, Side, PatternFill
            from openpyxl.utils import get_column_letter
        except Exception:
            try:
                QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", "Ù…Ø·Ù„ÙˆØ¨ ØªØ«Ø¨ÙŠØª openpyxl:\n pip install openpyxl")
            except Exception:
                pass
            return
        
        try:
            self._save_settings()
        except Exception:
            pass
        
        # Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ
        try:
            default_name = _default_excel_name(getattr(self, 'parent', self), fallback="report")
        except Exception:
            default_name = "report.xlsx"
        path, _ = QtWidgets.QFileDialog.getSaveFileName(self, "ØªØµØ¯ÙŠØ± Excel", default_name, "Excel (*.xlsx)")
        if not path:
            return
        
        wb = Workbook()
        ws = wb.active
        ws.title = "ØªÙ‚Ø±ÙŠØ±"
        try:
            ws.sheet_view.rightToLeft = True
            # ws.print_area = 'A:R' - Removed

        except Exception:
            pass
        
        # Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ©
        thin = Side(border_style="thin", color="999999")
        border = Border(top=thin, bottom=thin, left=thin, right=thin)
        hdr_font = Font(bold=True)
        
        current_row = 1
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ _render Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
        try:
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            table = None
            if self._table_override is not None:
                table = self._table_override
            else:
                try:
                    if hasattr(self.parent, 'tabs') and self.parent.tabs is not None:
                        cur = self.parent.tabs.currentWidget()
                        if cur is getattr(self.parent, '_dept_matrix_tab_widget', None):
                            table = getattr(self.parent, 'dept_matrix_table', None)
                        elif cur is getattr(self.parent, '_dept_report_tab_widget', None):
                            table = getattr(self.parent, 'dept_report_table', None)
                        elif cur is getattr(self.parent, '_bank_detailed_tab_widget', None):
                            table = getattr(self.parent, 'bank_detailed_active_table', None) or getattr(self.parent, 'bank_detailed_dept_table', None)
                        elif cur is getattr(self.parent, '_bank_limits_tab_widget', None):
                            table = getattr(self.parent, 'bank_limits_table', None)
                        else:
                            table = getattr(self.parent, 'table', None)
                    else:
                        table = getattr(self.parent, 'table', None)
                except Exception:
                    table = getattr(self.parent, 'table', None)
            
            if table is None:
                try:
                    QtWidgets.QMessageBox.warning(self, "ØªØµØ¯ÙŠØ±", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„ØªØµØ¯ÙŠØ±Ù‡.")
                except Exception:
                    pass
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ±
            cash_filter = None
            try:
                parent = getattr(self, 'parent', None)
                if parent:
                    cmb_cash = getattr(parent, 'cmb_cash', None)
                    if cmb_cash:
                        cash_filter = cmb_cash.currentText().strip() if hasattr(cmb_cash, 'currentText') else ''
                        if cash_filter == 'Ø§Ù„ÙƒÙ„':
                            cash_filter = None
            except Exception:
                pass
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ± (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ _render)
            reports_tables = []
            try:
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
                is_bank_limits_tab = False
                is_dept_report_tab = False
                try:
                    if hasattr(self.parent, 'tabs') and self.parent.tabs is not None:
                        cur = self.parent.tabs.currentWidget()
                        if cur is getattr(self.parent, '_bank_limits_tab_widget', None):
                            is_bank_limits_tab = True
                        elif cur is getattr(self.parent, '_dept_report_tab_widget', None):
                            is_dept_report_tab = True
                except Exception:
                    pass
                
                # Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ: ØµØ¯Ù‘Ø± Ø¬Ø¯ÙˆÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙÙ‚Ø·
                if is_bank_limits_tab and table is getattr(self.parent, 'bank_limits_table', None):
                    reports_tables = [table]
                # Ù„ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ØµØ¯Ù‘Ø± Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙ‚Ø·
                elif is_dept_report_tab and table is getattr(self.parent, 'dept_report_table', None):
                    reports_tables = [table]
                # Ø¯Ù…Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                elif (self._table_override is None) and (table is getattr(self.parent, 'table', None)) and getattr(self.parent, 'table_cash', None):
                    if cash_filter == 'Ù†Ù‚Ø¯ÙŠ':
                        if int(getattr(self.parent.table_cash, 'rowCount', lambda: 0)()) > 0:
                            reports_tables = [self.parent.table_cash]
                    elif cash_filter == 'ØªØ³Ù‡ÙŠÙ„Ø§Øª':
                        reports_tables = [table]
                    else:
                        if int(getattr(self.parent.table_cash, 'rowCount', lambda: 0)()) > 0:
                            reports_tables = [table, self.parent.table_cash]
                        else:
                            reports_tables = [table]
                # Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ: Ø§Ø­ØªØ±Ù… Ø®ÙŠØ§Ø± "Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙ‚Ø·"
                elif hasattr(self.parent, 'tabs') and getattr(self.parent, '_bank_detailed_tab_widget', None) and (self.parent.tabs.currentWidget() is self.parent._bank_detailed_tab_widget):
                    dept_only = False
                    try:
                        dept_only = bool(getattr(self.parent, 'bank_detailed_dept_only_chk', None) and self.parent.bank_detailed_dept_only_chk.isChecked())
                    except Exception:
                        dept_only = False
                    lst = []
                    if dept_only:
                        try:
                            if getattr(self.parent, 'bank_detailed_dept_table', None) and int(getattr(self.parent.bank_detailed_dept_table, 'rowCount', lambda: 0)()) > 0:
                                lst.append(self.parent.bank_detailed_dept_table)
                        except Exception:
                            pass
                    else:
                        try:
                            if getattr(self.parent, 'bank_detailed_active_table', None) and int(getattr(self.parent.bank_detailed_active_table, 'rowCount', lambda: 0)()) > 0:
                                lst.append(self.parent.bank_detailed_active_table)
                        except Exception:
                            pass
                        try:
                            if getattr(self.parent, 'bank_detailed_dept_table', None) and int(getattr(self.parent.bank_detailed_dept_table, 'rowCount', lambda: 0)()) > 0:
                                lst.append(self.parent.bank_detailed_dept_table)
                        except Exception:
                            pass
                    if lst:
                        reports_tables = lst
            except Exception:
                pass
            
            tables_iter = reports_tables if reports_tables else ([table] if table is not None else [])
            
            # Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            def _get_print_columns(tbl):
                # ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ù…Ø§ Ø¹Ø¯Ø§ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ): Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                if reports_tables and not is_bank_limits_tab:
                    return list(range(tbl.columnCount()))
                # Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                if tbl is getattr(self.parent, 'dept_report_table', None):
                    return list(range(tbl.columnCount()))
                # Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                if tbl is getattr(self.parent, 'dept_matrix_table', None):
                    return list(range(tbl.columnCount()))
                # ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† list_cols
                cols = self._selected_columns(tbl)
                if not cols:
                    cols = list(range(tbl.columnCount()))
                return cols

            def _merge_dept_matrix_excel_headers(ws_sheet, merge_state):
                """Ø§Ø¯Ù…Ø¬ Ø®Ù„Ø§ÙŠØ§ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙÙŠ ÙˆØ±Ù‚Ø© Ø¥ÙƒØ³Ù„ Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©)."""
                try:
                    if not merge_state:
                        return
                    spans = merge_state.get("spans") or []
                    row0_vals = merge_state.get("row0_vals") or []
                    if not spans and row0_vals:
                        spans = []
                        n = len(row0_vals)
                        col = 1  # ØªØ®Ø·Ù‘Ù Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„
                        while col < max(0, n - 1):
                            val = str(row0_vals[col] or "").strip()
                            if val:
                                start = col
                                nxt = col + 1
                                while nxt < (n - 1) and not str(row0_vals[nxt] or "").strip():
                                    nxt += 1
                                spans.append((val, start, max(start, nxt - 1)))
                                col = nxt
                            else:
                                col += 1
                    excel_rows = merge_state.get("excel_rows") or {}
                    bank_row = excel_rows.get(0)
                    if not bank_row or not spans:
                        return
                    for name, start_col, end_col in spans:
                        try:
                            start_excel = int(start_col) + 1
                            end_excel = int(end_col) + 1
                        except Exception:
                            continue
                        if end_excel < start_excel:
                            continue
                        try:
                            ws_sheet.merge_cells(start_row=bank_row, start_column=start_excel, end_row=bank_row, end_column=end_excel)
                        except Exception:
                            pass
                        cell = ws_sheet.cell(row=bank_row, column=start_excel)
                        if name:
                            cell.value = str(name)
                        cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                        cell.border = border
                except Exception:
                    pass
            
            # ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø¬Ø¯ÙˆÙ„
            for ti, tbl in enumerate(tables_iter):
                if ti > 0:
                    # Ø¥Ø¶Ø§ÙØ© ØµÙ ÙØ§Ø±Øº Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                    current_row += 1
                
                # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
                cols = _get_print_columns(tbl)
                
                # Ù‚Øµ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØªÙˆÙ‚Ù Ø¹Ù†Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                limit_cols = []
                found_limit = False
                for c in cols:
                    limit_cols.append(c)
                    h_txt = ""
                    try:
                        it = tbl.horizontalHeaderItem(c)
                        if it:
                            h_txt = it.text()
                    except:
                        pass
                    if "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" in h_txt:
                        found_limit = True
                        break
                if found_limit:
                    cols = limit_cols
                
                # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ)
                if tbl is getattr(self.parent, 'table_cash', None):
                    ws.cell(row=current_row, column=1).value = "Ø¶Ù…Ø§Ù†Ø§Øª Ù†Ù‚Ø¯ÙŠØ©"
                    cell = ws.cell(row=current_row, column=1)
                    cell.font = Font(bold=True, size=14)
                    current_row += 1
                
                # Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                is_dept_matrix_table_hdr = (tbl is getattr(self.parent, 'dept_matrix_table', None))
                headers = []
                if not is_dept_matrix_table_hdr:
                    for c in cols:
                        try:
                            it = tbl.horizontalHeaderItem(c)
                            if it:
                                hdr_txt = it.text() if hasattr(it, "text") else ""
                            else:
                                try:
                                    model = tbl.model()
                                    if model:
                                        idx = model.headerData(c, QtCore.Qt.Horizontal, QtCore.Qt.DisplayRole)
                                        hdr_txt = str(idx) if idx is not None else ""
                                    else:
                                        hdr_txt = ""
                                except Exception:
                                    hdr_txt = ""
                            headers.append(hdr_txt)
                        except Exception:
                            headers.append("")
                    ws.append(headers)
                    header_row = ws.max_row
                    current_row = ws.max_row + 1
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
                
                
                # Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† "Ø§Ø¬Ù…Ø§Ù„ÙŠ" ÙˆÙ…Ø´ØªÙ‚Ø§ØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                def _norm_txt_export(s):
                    try:
                        s = str(s or "").replace("\u200f", "").replace("\u200e", "").replace("Ù€", "").strip()
                        s = s.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
                        return s.lower()
                    except Exception:
                        return str(s or "").lower()
                def _starts_with_total_export(s):
                    t = _norm_txt_export(s)
                    if not t:
                        return False
                    if t.startswith("Ø§Ù„"):
                        t = t[2:]
                    first = (t.split() or [""])[0]
                    return first in {"Ø§Ø¬Ù…Ø§Ù„ÙŠ","Ø§Ø¬Ù…Ø§Ù„Ù‰","Ø§Ø¬Ù…Ø§Ù„","Ù…Ø¬Ù…ÙˆØ¹","Ø¬Ù…Ù„Ù‡","total","sum"}
                from openpyxl.styles import PatternFill
                gray_fill = PatternFill(start_color="E0E0E0", end_color="E0E0E0", fill_type="solid")
                
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… header_row Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† current_row Ù„ØªÙ†Ø³ÙŠÙ‚ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                for j in range(1, len(headers) + 1):
                    cell = ws.cell(row=header_row, column=j)
                    cell.font = hdr_font
                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                    cell.border = border
                    col0 = j - 1
                    try:
                        if (tbl is getattr(self.parent, 'dept_report_table', None)) or (tbl is getattr(self.parent, 'dept_matrix_table', None)):
                            h = headers[col0] if col0 < len(headers) else ""
                            if _starts_with_total_export(h):
                                cell.fill = gray_fill
                    except Exception:
                        pass
                # Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø§Ù„Ø±Ø£Ø³ (Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙÙ‚Ø·)
                if not is_dept_matrix_table_hdr:
                    try:
                        header_height = tbl.horizontalHeader().height()
                        if header_height > 0:
                            excel_header_height = max(15, round(header_height / 1.33))
                            ws.row_dimensions[header_row].height = excel_header_height
                    except Exception:
                        pass
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                is_bank_limits_table = (tbl is getattr(self.parent, 'bank_limits_table', None))
                is_dept_report_table = (tbl is getattr(self.parent, 'dept_report_table', None))
                is_dept_matrix_table = (tbl is getattr(self.parent, 'dept_matrix_table', None))
                is_bank_detailed_dept_table = (tbl is getattr(self.parent, 'bank_detailed_dept_table', None))
                
                # Ù†Ù…Ø· Ø±Ø£Ø³ Ø®Ø§Øµ Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ (Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ÙˆÙ†Øµ Ø£Ø¨ÙŠØ¶)
                if is_bank_limits_table:
                    try:
                        for j in range(1, len(headers) + 1):
                            hc = ws.cell(row=header_row, column=j)
                            hc.font = Font(bold=True, color="FFFFFF")
                            hc.fill = PatternFill(start_color="000000", end_color="000000", fill_type="solid")
                            hc.alignment = Alignment(horizontal="center", vertical="center", wrap_text=False)
                            hc.border = border
                    except Exception:
                        pass
                dept_matrix_merge_state = None
                matrix_total_col_indices = []
                if is_dept_matrix_table:
                    dept_matrix_merge_state = {"excel_rows": {}, "row0_vals": None, "spans": None}
                    try:
                        parent = getattr(self, 'parent', None)
                        spans_attr = getattr(parent, '_dept_matrix_bank_spans', None)
                        if spans_attr:
                            dept_matrix_merge_state["spans"] = [(str(nm or ""), int(c0), int(c1)) for nm, c0, c1 in spans_attr]
                    except Exception:
                        pass
                    # Ø­Ø¯Ù‘Ø¯ Ø£Ø¹Ù…Ø¯Ø© "Ø¥Ø¬Ù…Ø§Ù„ÙŠ" Ù„Ù„Ù…ØµÙÙˆÙØ© (Ù„ÙƒÙ„ Ø¨Ù†Ùƒ + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…)
                    try:
                        banks = list(getattr(self.parent, '_dept_matrix_visible_banks', []) or [])
                        cols_per_bank = int(getattr(self.parent, '_dept_matrix_cols_per_bank', 0) or 0)
                        total_col_idx = getattr(self.parent, '_dept_matrix_total_col_index', None)
                        if cols_per_bank == 4 and banks:
                            for i in range(len(banks)):
                                table_col = 1 + i * cols_per_bank + (cols_per_bank - 1)
                                matrix_total_col_indices.append(int(table_col))
                        if total_col_idx is not None:
                            matrix_total_col_indices.append(int(total_col_idx))
                    except Exception:
                        pass
                
                # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                # Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ©: Ø§ÙƒØªØ¨ Ø§Ù„ØµÙÙŠÙ† 0 Ùˆ 1 ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ…Ø§Ù…Ù‹Ø§
                start_r = 0 if is_dept_matrix_table_hdr else 0
                
                # ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ù†Ùƒ Ù„Ù„ØªØ±ØªÙŠØ¨
                bank_col_idx = -1
                if not is_dept_matrix_table:
                    for i, h in enumerate(headers):
                        if "Ø§Ù„Ø¨Ù†Ùƒ" in h:
                            bank_col_idx = i
                            break
                
                # ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
                all_rows_data = []
                for r in range(start_r, tbl.rowCount()):
                    try:
                        # ØªØ¬Ù†Ù‘Ø¨ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ø£ÙŠ Ø¬Ø¯ÙˆÙ„
                        if tbl.isRowHidden(r):
                            continue
                    except Exception:
                        pass
                    
                    row_vals = []
                    for c in cols:
                        try:
                            it = tbl.item(r, c)
                            if it is not None:
                                if hasattr(it, "text"):
                                    txt = it.text()
                                elif hasattr(it, "data"):
                                    txt = str(it.data(QtCore.Qt.DisplayRole) or "")
                                else:
                                    txt = ""
                            else:
                                # Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                                try:
                                    model = tbl.model()
                                    if model:
                                        idx = model.index(r, c)
                                        txt = str(model.data(idx, QtCore.Qt.DisplayRole) or "")
                                    else:
                                        txt = ""
                                except Exception:
                                    txt = ""
                            txt = txt.replace("\u200f", "").replace("\u200e", "").replace("Ù€", "")
                        except Exception:
                            txt = ""
                        row_vals.append(txt)
                    all_rows_data.append((r, row_vals))
                
                # Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                if bank_col_idx != -1:
                    try:
                        all_rows_data.sort(key=lambda x: x[1][bank_col_idx])
                    except:
                        pass
                
                # Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚
                for r, row_vals in all_rows_data:
                    ws.append(row_vals)
                    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    if not is_dept_report_table:
                        excel_row = ws.max_row
                        current_row = ws.max_row + 1
                    else:
                        excel_row = current_row
                        current_row += 1
                    if dept_matrix_merge_state is not None and r in (0, 1):
                        try:
                            dept_matrix_merge_state["excel_rows"][r] = excel_row
                            if r == 0:
                                dept_matrix_merge_state["row0_vals"] = list(row_vals)
                        except Exception:
                            pass
                    
                    
                    
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ ØµÙ Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„)
                    is_total_row = False
                    try:
                        if (tbl is getattr(self.parent, 'dept_report_table', None)) or (tbl is getattr(self.parent, 'dept_matrix_table', None)):
                            first_cell_txt = row_vals[0] if len(row_vals) > 0 else ""
                            is_total_row = _starts_with_total_export(first_cell_txt)
                    except Exception:
                        pass
                    
                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ
                    for j in range(1, len(row_vals) + 1):
                        cell = ws.cell(row=excel_row, column=j)
                        # Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
                        try:
                            if is_bank_limits_table:
                                cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=False)
                            else:
                                cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                        except Exception:
                            cell.alignment = Alignment(horizontal="center", vertical="center")
                        cell.border = border
                        
                        # ØªØ¸Ù„ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ/Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ "Ø§Ø¬Ù…Ø§Ù„ÙŠ" Ø£Ùˆ Ù…Ø´ØªÙ‚Ø§ØªÙ‡Ø§ ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        col0 = j - 1
                        is_total_col = False
                        try:
                            if tbl is getattr(self.parent, 'dept_report_table', None):
                                hh = headers[col0] if col0 < len(headers) else ""
                                is_total_col = _starts_with_total_export(hh)
                            elif tbl is getattr(self.parent, 'dept_matrix_table', None):
                                is_total_col = (col0 in matrix_total_col_indices)
                        except Exception:
                            pass
                        if is_total_row or is_total_col:
                            cell.fill = gray_fill
                        
                        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                        try:
                            h = headers[col0] if col0 < len(headers) else ""
                            h_norm = h.replace("\u200f", "").replace("\u200e", "").strip().lower()
                            txt_val = row_vals[col0] if col0 < len(row_vals) else ""
                            
                            # Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ: ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (Ø¹Ø¯Ø§ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ù†Ùƒ)
                            if is_bank_limits_table:
                                if h and h.strip() == "Ø§Ù„Ø¨Ù†Ùƒ":
                                    # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ù†Ùƒ: Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
                                    cell.value = txt_val
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                else:
                                    # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰
                                    is_percent = ("%" in h or "Ù†Ø³Ø¨Ø©" in h or "percent" in h_norm)
                                    success, num_val = _try_convert_to_number(txt_val, is_percent)
                                    if success:
                                        cell.value = num_val
                                        if is_percent:
                                            cell.number_format = '0"%"'
                                        else:
                                            cell.number_format = "#,##0.00"
                                        cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                    else:
                                        cell.value = txt_val
                            # Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
                            elif is_dept_report_table:
                                # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù…: Ù†Øµ
                                if col0 == 0:
                                    cell.value = txt_val
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                else:
                                    # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ø±Ù‚Ù…ÙŠØ©
                                    success, num_val = _try_convert_to_number(txt_val, False)
                                    if success:
                                        cell.value = num_val
                                        cell.number_format = "#,##0.00"
                                        cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                    else:
                                        cell.value = txt_val
                            # Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ©
                            elif is_dept_matrix_table:
                                # ØªØ®Ø·ÙŠ ØµÙÙˆÙ Ø§Ù„Ø±Ø£Ø³ (0 Ùˆ 1)
                                if r < 2:
                                    cell.value = txt_val
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                else:
                                    # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù…: Ù†Øµ
                                    if col0 == 0:
                                        cell.value = txt_val
                                        cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                    else:
                                        # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ø±Ù‚Ù…ÙŠØ©
                                        success, num_val = _try_convert_to_number(txt_val, False)
                                        if success:
                                            cell.value = num_val
                                            cell.number_format = "#,##0.00"
                                            cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                        else:
                                            cell.value = txt_val
                            # Ù„Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ: ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
                            elif is_bank_detailed_dept_table:
                                # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù…: Ù†Øµ
                                if col0 == 0:
                                    cell.value = txt_val
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                else:
                                    # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ Ø±Ù‚Ù…ÙŠØ©
                                    success, num_val = _try_convert_to_number(txt_val, False)
                                    if success:
                                        cell.value = num_val
                                        cell.number_format = "#,##0.00"
                                        cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                    else:
                                        cell.value = txt_val
                            # Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
                            elif ("Ù‚ÙŠÙ…Ø©" in h or "Ù…Ø¨Ù„Øº" in h) and "Ø§Ù„ØªØ£Ù…ÙŠÙ†" not in h and "insurance" not in h_norm:
                                success, num_val = _try_convert_to_number(txt_val, False)
                                if success:
                                    cell.value = num_val
                                    cell.number_format = "#,##0.00"
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                else:
                                    cell.value = txt_val
                            elif "%" in h or "Ù†Ø³Ø¨Ø©" in h or "percent" in h_norm:
                                success, num_val = _try_convert_to_number(txt_val, True)
                                if success:
                                    cell.value = num_val
                                    cell.number_format = "0%"
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                else:
                                    cell.value = txt_val
                            else:
                                # Ù„Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙŠØ©: Ø¶Ø¹ Ø§Ù„Ù†Øµ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
                                cell.value = txt_val
                                cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                        except Exception:
                            # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: Ø¶Ø¹ Ø§Ù„Ù†Øµ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
                            try:
                                cell.value = row_vals[col0] if col0 < len(row_vals) else ""
                                cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                            except Exception:
                                pass
                    
                    # Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ Ø¨Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    try:
                        row_height = tbl.rowHeight(r)
                        if row_height > 0:
                            # ØªØ­ÙˆÙŠÙ„ Ù…Ù† pixels Ø¥Ù„Ù‰ points (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ 1 point = 1.33 pixels)
                            excel_row_height = max(15, round(row_height / 1.33))
                            ws.row_dimensions[excel_row].height = excel_row_height
                    except Exception:
                        pass
                
                if dept_matrix_merge_state:
                    _merge_dept_matrix_excel_headers(ws, dept_matrix_merge_state)
                    # Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©): Ø§Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ Ø§Ù„Ø°ÙŠ ÙŠÙ„ÙŠÙ‡ Ø«Ù… Ø§Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
                    try:
                        src_row = header_row
                        dst_row = header_row + 1
                        max_cols = len(headers)
                        for col_idx in range(1, max_cols + 1):
                            src_cell = ws.cell(row=src_row, column=col_idx)
                            val = src_cell.value
                            if val not in (None, ""):
                                dst_cell = ws.cell(row=dst_row, column=col_idx)
                                if dst_cell.value in (None, ""):
                                    dst_cell.value = val
                                else:
                                    # Ø¯Ù…Ø¬ Ø§Ù„Ù†ØµÙŠÙ† Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© Ù…Ø³Ø¨Ù‚Ø©
                                    dst_cell.value = f"{val} {dst_cell.value}"
                        ws.delete_rows(src_row, 1)
                        current_row -= 1
                    except Exception:
                        pass
                
                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø©
                try:
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ±
                    st_val = ''
                    gt_val = ''
                    cash_val = ''
                    try:
                        parent = getattr(self, 'parent', None)
                        if parent:
                            status = getattr(parent, 'cmb_status', None)
                            gtype = getattr(parent, 'cmb_gtype', None)
                            cmb_cash = getattr(parent, 'cmb_cash', None)
                            if status:
                                st_val = status.currentText().strip() if hasattr(status, 'currentText') else ''
                            if gtype:
                                gt_val = gtype.currentText().strip() if hasattr(gtype, 'currentText') else ''
                            if cmb_cash:
                                cash_val = cmb_cash.currentText().strip() if hasattr(cmb_cash, 'currentText') else ''
                    except Exception:
                        pass
                    
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø©
                    do_page_total = False
                    if (not is_dept_report_table) and hasattr(self, 'chk_total_per_page') and self.chk_total_per_page.isChecked():
                        if (st_val and st_val != 'Ø§Ù„ÙƒÙ„') or (gt_val and gt_val != 'Ø§Ù„ÙƒÙ„') or (cash_val and cash_val != 'Ø§Ù„ÙƒÙ„'):
                            do_page_total = True
                    
                    if do_page_total:
                        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                        sel_total_names = []
                        if hasattr(self, 'cmb_total_cols'):
                            try:
                                sel_total_names = [self.cmb_total_cols.item(i).text() for i in range(self.cmb_total_cols.count()) if
                                                   self.cmb_total_cols.item(i).isSelected()]
                            except Exception:
                                pass
                        
                        sel_total_cols = [i for i in range(tbl.columnCount()) if (self._header_text(tbl, i) in sel_total_names)]
                        
                        if sel_total_cols:
                            totals = self._compute_totals(tbl, (0, tbl.rowCount()), sel_total_cols)
                            if totals:
                                # Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                                total_row = [""] * len(cols)
                                for idx, c in enumerate(cols):
                                    if c in sel_total_cols:
                                        col_name = self._header_text(tbl, c)
                                        col_idx_in_headers = idx
                                        if col_idx_in_headers < len(total_row):
                                            total_row[col_idx_in_headers] = totals.get(col_name, 0.0)
                                
                                # Ø¥Ø¶Ø§ÙØ© Ù†Øµ "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„
                                if total_row:
                                    total_row[0] = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"
                                
                                ws.append(total_row)
                                excel_row = ws.max_row
                                current_row = ws.max_row + 1
                                
                                # ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                                for j in range(1, len(total_row) + 1):
                                    cell = ws.cell(row=excel_row, column=j)
                                    cell.font = Font(bold=True)
                                    # Ù„Ø§ ØªØ¸Ù„ÙŠÙ„ Ù„ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ â€” Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                    cell.border = border
                                    
                                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                                    if j > 1 and total_row[j-1] != "" and total_row[j-1] != "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ":
                                        try:
                                            val = float(total_row[j-1])
                                            cell.value = val
                                            cell.number_format = "#,##0.00"
                                            cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                        except Exception:
                                            pass
                except Exception:
                    pass

                
                # Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
                try:
                    has_bank_filter = False
                    try:
                        parent = getattr(self, 'parent', None)
                        if parent:
                            cmb_bank = getattr(parent, 'cmb_bank', None)
                            if cmb_bank:
                                bank_text = cmb_bank.currentText().strip() if hasattr(cmb_bank, 'currentText') else ''
                                if bank_text and bank_text != 'Ø§Ù„ÙƒÙ„':
                                    has_bank_filter = True
                    except Exception:
                        pass
                    
                    if has_bank_filter and hasattr(self, 'chk_props_footer') and self.chk_props_footer.isChecked():
                        if tbl is getattr(self.parent, 'table', None):
                            props_values = self._compute_props_values(None)
                            if props_values:
                                # Ø¥Ø¶Ø§ÙØ© ØµÙ ÙØ§Ø±Øº
                                current_row += 1
                                
                                # Ø±Ø¤ÙˆØ³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ (Ø§Ù„Ø®Ø§ØµÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù‚ÙŠÙ…Ø©)
                                ws.append(["Ø§Ù„Ø®Ø§ØµÙŠØ©", "Ø§Ù„Ù‚ÙŠÙ…Ø©"])
                                header_props_row = ws.max_row
                                current_row = ws.max_row + 1
                                for j in range(1, 3):
                                    cell = ws.cell(row=header_props_row, column=j)
                                    cell.font = hdr_font
                                    cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
                                    cell.border = border
                                
                                # Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ (Ø§Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø¨Ù„Øº)
                                for val, label in props_values:
                                    ws.append([label, val])
                                    excel_row = ws.max_row
                                    current_row = ws.max_row + 1
                                    
                                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ
                                    for j in range(1, 3):
                                        cell = ws.cell(row=excel_row, column=j)
                                        if j == 1:  # Ø§Ù„Ø®Ø§ØµÙŠØ© (Ø§Ù„Ù†Øµ)
                                            cell.alignment = Alignment(horizontal="right", vertical="top", wrap_text=True)
                                        else:  # Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø§Ù„Ù…Ø¨Ù„Øº)
                                            cell.alignment = Alignment(horizontal="right", vertical="top", wrap_text=True)
                                            try:
                                                cell.value = float(val)
                                                cell.number_format = "#,##0.00"
                                            except Exception:
                                                pass
                                        cell.border = border
                except Exception:
                    pass

                # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø¹Ù†Ø¯ ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                try:
                    parent = getattr(self, 'parent', None)
                    is_main_table = (tbl is getattr(self.parent, 'table', None))
                    dep_txt = ''
                    try:
                        if parent and getattr(parent, 'cmb_dept', None):
                            dep_txt = parent.cmb_dept.currentText().strip()
                    except Exception:
                        dep_txt = ''
                    chk_visible = False
                    try:
                        chk_visible = bool(getattr(self, 'chk_bank_sum_visible', None) and self.chk_bank_sum_visible.isChecked())
                    except Exception:
                        chk_visible = False
                    do_bank_summary = bool(is_main_table and dep_txt and dep_txt != 'Ø§Ù„ÙƒÙ„' and chk_visible)
                    if do_bank_summary:
                        idx_bank = None; idx_type = None; idx_amount = None; idx_cash = None; idx_status = None
                        try:
                            for i in range(tbl.columnCount()):
                                nm = (self._header_text(tbl, i) or '').strip()
                                if nm == 'Ø§Ù„Ø¨Ù†Ùƒ':
                                    idx_bank = i
                                elif nm in ('Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†', 'Ø§Ù„Ù†ÙˆØ¹'):
                                    idx_type = i
                                elif nm in ('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'):
                                    idx_amount = i
                                elif nm in ('Ù†Ù‚Ø¯ÙŠ', 'Ù†Ù‚Ø¯ÙŠØŸ'):
                                    idx_cash = i
                                elif nm in ('Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ)'):
                                    idx_status = i
                            if idx_bank is None or idx_type is None or idx_amount is None:
                                idx_bank, idx_type, idx_amount, idx_cash, idx_status = 1, 3, 4, 14, 13
                        except Exception:
                            idx_bank, idx_type, idx_amount, idx_cash, idx_status = 1, 3, 4, 14, 13
                        sums_by_bank = {}
                        for rr in range(tbl.rowCount()):
                            it_b = tbl.item(rr, idx_bank); it_t = tbl.item(rr, idx_type); it_a = tbl.item(rr, idx_amount)
                            is_cash = False; is_finished = False
                            try:
                                if idx_cash is not None:
                                    it_c = tbl.item(rr, idx_cash)
                                    t_c = (it_c.text().strip() if it_c and it_c.text() else '')
                                    is_cash = t_c in ('Ù†Ø¹Ù…', '1', 'true', 'True')
                            except Exception:
                                is_cash = False
                            try:
                                if idx_status is not None:
                                    it_s = tbl.item(rr, idx_status)
                                    t_s = (it_s.text().strip() if it_s and it_s.text() else '')
                                    is_finished = (t_s == 'Ù…Ù†ØªÙ‡ÙŠ')
                            except Exception:
                                is_finished = False
                            if is_cash or is_finished:
                                continue
                            b_raw = it_b.text() if it_b else ''
                            g_type = (it_t.text() if it_t else '').strip()
                            try:
                                amt = float(str((it_a.text() if it_a else '0').replace(',', '')).strip() or 0)
                            except Exception:
                                try:
                                    amt = float(it_a.text().replace(',', '')) if it_a and it_a.text() else 0.0
                                except Exception:
                                    amt = 0.0
                            bname = normalize_bank(b_raw or '', '')
                            if bname not in sums_by_bank:
                                sums_by_bank[bname] = {'initial': 0.0, 'final': 0.0, 'financial': 0.0}
                            gt = g_type.replace('Ù‰', 'ÙŠ').replace('Ø£', 'Ø§').replace('Ø¥', 'Ø§').replace('Ø¢', 'Ø§')
                            if ('Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' in gt) or ('Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰' in gt) or ('Ù…Ø¨Ø¯Ø¦ÙŠ' in gt) or ('Ù…Ø¨Ø¯Ø¦Ù‰' in gt):
                                sums_by_bank[bname]['initial'] += amt
                            elif ('Ù†Ù‡Ø§Ø¦ÙŠ' in gt) or ('Ù†Ù‡Ø§Ø¦Ù‰' in gt):
                                sums_by_bank[bname]['final'] += amt
                            elif ('Ù…Ø§Ù„ÙŠ' in gt) or ('Ø§Ù„Ù…Ø§Ù„ÙŠØ©' in gt) or ('Ù…Ø§Ù„Ù‰' in gt):
                                sums_by_bank[bname]['financial'] += amt
                        if sums_by_bank:
                            current_row += 1
                            hdrs = ['Ø§Ù„Ø¨Ù†Ùƒ', 'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', 'Ù†Ù‡Ø§Ø¦ÙŠ', 'Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ']
                            ws.append(hdrs)
                            hdr_row = ws.max_row
                            for j in range(1, len(hdrs) + 1):
                                cell = ws.cell(row=hdr_row, column=j)
                                cell.font = hdr_font
                                cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
                                cell.border = border
                            current_row = ws.max_row + 1
                            grand_i = grand_f = grand_m = 0.0
                            for b, s in sorted(sums_by_bank.items()):
                                total_v = float(s['initial']) + float(s['final']) + float(s['financial'])
                                ws.append([b, s['initial'], s['final'], s['financial'], total_v])
                                excel_row = ws.max_row
                                current_row = ws.max_row + 1
                                for j in range(1, 6):
                                    cell = ws.cell(row=excel_row, column=j)
                                    cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
                                    cell.border = border
                                    if j > 1:
                                        try:
                                            val = float(ws.cell(row=excel_row, column=j).value or 0.0)
                                            cell.value = val
                                            cell.number_format = '#,##0.00'
                                        except Exception:
                                            pass
                                grand_i += float(s['initial']); grand_f += float(s['final']); grand_m += float(s['financial'])
                            total_all2 = grand_i + grand_f + grand_m
                            ws.append(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', grand_i, grand_f, grand_m, total_all2])
                            excel_row = ws.max_row
                            current_row = ws.max_row + 1
                            for j in range(1, 6):
                                cell = ws.cell(row=excel_row, column=j)
                                cell.font = Font(bold=True)
                                cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
                                cell.border = border
                                if j > 1:
                                    try:
                                        val = float(ws.cell(row=excel_row, column=j).value or 0.0)
                                        cell.value = val
                                        cell.number_format = '#,##0.00'
                                    except Exception:
                                        pass
                except Exception:
                    pass

                # Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                try:
                    for idx, c in enumerate(cols, start=1):
                        try:
                            px = int(tbl.columnWidth(c))
                        except Exception:
                            px = 120
                        base_w = max(12, round(px / 7, 1))
                        try:
                            is_limits = (tbl is getattr(self.parent, 'bank_limits_table', None))
                        except Exception:
                            is_limits = False
                        width = max(base_w, 16 if is_limits else base_w)
                        # Ø·Ø¨Ù‚ Ù†ÙØ³ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯Ù†ÙŠØ§ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© ÙƒÙ…Ø§ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                        if is_limits:
                            try:
                                nm = (headers[idx-1] if (idx-1) < len(headers) else "").strip()
                            except Exception:
                                nm = ""
                            mins_px = {
                                "Ø§Ù„Ø¨Ù†Ùƒ": 160,
                                "Ø§Ù„Ø­Ø¯": 110,
                                "Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©": 110,
                                "Ø¶Ù…Ø§Ù†Ø§Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©": 120,
                                "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª": 120,
                                "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ": 110,
                                "Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…": 90,
                                "Ø§Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©": 140,
                            }
                            min_char = round(float(mins_px.get(nm, 90)) / 7.0, 1)
                            width = max(width, min_char)
                        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒØ¨Ø±
                        col_letter = get_column_letter(idx)
                        if col_letter in ws.column_dimensions:
                            existing_width = ws.column_dimensions[col_letter].width
                            ws.column_dimensions[col_letter].width = max(existing_width or 8, width)
                        else:
                            ws.column_dimensions[col_letter].width = width
                except Exception:
                    pass
            
            # ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            try:
                if table is getattr(self.parent, 'dept_matrix_table', None):
                    ws.freeze_panes = "A3"
                else:
                    ws.freeze_panes = "A2"
            except Exception:
                pass
            
            if ws.max_row > 0:
                last_col_letter = get_column_letter(ws.max_column)
                ws.print_area = f'A1:{last_col_letter}{ws.max_row}'
            
            wb.save(path)
            try:
                QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±", "ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Excel Ø¨Ù†ÙØ³ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨.")
            except Exception:
                pass
        except Exception as e:
            try:
                QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", f"ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Excel: {e}")
            except Exception:
                pass

    # ØªÙ…ÙˆØ¶Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø¬Ù…
    def eventFilter(self, obj, event):
        try:
            if obj is self.preview and event.type() == QtCore.QEvent.Resize:
                self._position_preview_tools()
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ctrl + Mouse Wheel Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±
            elif event.type() == QtCore.QEvent.Wheel:
                modifiers = QtWidgets.QApplication.keyboardModifiers()
                if modifiers == QtCore.Qt.ControlModifier:
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø¯Ø« Ø¹Ù„Ù‰ preview widget Ø£Ùˆ viewport
                    if obj == self.preview or obj == self.preview.viewport():
                        delta = event.angleDelta().y()
                        if delta != 0:
                            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                            try:
                                current_zoom = self.preview.zoomFactor()
                            except Exception:
                                current_zoom = 1.0
                            
                            # Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø²ÙŠØ§Ø¯Ø©/Ù†Ù‚ØµØ§Ù† 10%)
                            if delta > 0:
                                new_zoom = current_zoom * 1.1
                            else:
                                new_zoom = current_zoom * 0.9
                            
                            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ÙˆØ¯ (10% - 400%)
                            new_zoom = max(0.1, min(4.0, new_zoom))
                            
                            # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±
                            try:
                                self.preview.setZoomMode(QtPrintSupport.QPrintPreviewWidget.Custom)
                            except Exception:
                                try:
                                    self.preview.setZoomMode(QtPrintSupport.QPrintPreviewWidget.ZoomMode.Custom)
                                except Exception:
                                    pass
                            try:
                                self.preview.setZoomFactor(new_zoom)
                                # ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                                if hasattr(self, 'sl_zoom'):
                                    self.sl_zoom.setValue(int(new_zoom * 100))
                            except Exception:
                                pass
                            
                            event.accept()
                            return True
        except Exception:
            pass
        return super().eventFilter(obj, event)

    def _position_preview_tools(self):
        try:
            if hasattr(self, 'preview_tools') and self.preview_tools is not None:
                m = 10
                w = self.preview_tools.sizeHint().width()
                h = self.preview_tools.sizeHint().height()
                pw = self.preview.width(); ph = self.preview.height()
                self.preview_tools.setGeometry(pw - w - m, ph - h - m, w, h)
                self.preview_tools.raise_()
        except Exception:
            pass

    def _apply_printer_settings(self, printer):
        try:
            # Ø­Ø¬Ù… ÙˆØ§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            size_val = self.cmb_size.currentData()
            orient_val = self.cmb_orient.currentData()
            if size_val is not None:
                printer.setPageSize(size_val)
            if orient_val is not None:
                printer.setOrientation(orient_val)
            printer.setFullPage(True)
            try:
                idx = int(self.cmb_color_mode.currentIndex())
            except Exception:
                idx = 0
            try:
                mode = QtPrintSupport.QPrinter.Color if idx == 0 else QtPrintSupport.QPrinter.GrayScale
                printer.setColorMode(mode)
            except Exception:
                pass
            
            # --- Duplex Settings ---
            try:
                s = QtCore.QSettings("GuaranteesApp", "Main")
                d_idx = s.value("print/duplex", 0, type=int)
                if d_idx == 1:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexLongSide)
                elif d_idx == 2:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexShortSide)
                else:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexNone)
            except Exception:
                pass

        except Exception:
            pass

    def _report_title_for(self, table_obj):
        try:
            if table_obj is getattr(self.parent, "kpi_bank_table", None):
                return "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ"
            if table_obj is getattr(self.parent, "kpi_dept_table", None):
                return "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"
            if table_obj is getattr(self.parent, "kpi_type_table", None):
                return "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù†ÙˆØ§Ø¹"
        except Exception:
            pass
        return "Ø§Ù„ØªÙ‚Ø±ÙŠØ±"

    def _draw_watermark(self, painter, content_rect, page_rect, pidx, pages, printer):
        """ÙŠØ±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.
        - ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­: ØªÙ…ÙƒÙŠÙ†ØŒ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ù„Ø´ÙØ§ÙÙŠØ©ØŒ ÙˆØ§Ù„Ø­Ø¬Ù… Ø§Ù„Ù†Ø³Ø¨ÙŠ.
        - Ø¥Ù† Ù„Ù… ÙŠÙØ­Ø¯Ù‘ÙØ¯ Ù…Ø³Ø§Ø±ØŒ ÙŠÙØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯Ù…Ø¬ ":/assets/watermark.png".
        - ØªÙØ±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ¨ SourceOver Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø­ØªÙ‰ Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡.
        """
        try:
            if not getattr(self, 'wm_enabled', None):
                return
            if not self.wm_enabled.isChecked():
                return

            # Ø­Ù…Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯ Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯Ù…Ø¬
            path = (self.wm_path.text().strip() or ':/assets/watermark.png')
            pm = QtGui.QPixmap(path)
            if pm.isNull():
                # Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯Ù…Ø¬
                pm = QtGui.QPixmap(':/assets/watermark.png')
                if pm.isNull():
                    return

            # Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© ÙŠØ¤Ø«Ø± ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ØªÙ…Ø±ÙƒØ² Ø§Ù„Ø·ÙÙŠÙ
            try:
                orient = printer.orientation()
            except Exception:
                orient = QtGui.QPageLayout.Landscape

            # Ø­Ø¬Ù… Ø§Ù„Ù†Ø³Ø¨ÙŠ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            scale = float(self.wm_scale.value())
            # Ø§Ø³Ù…Ø­ Ø¨Ù‚ÙŠÙ… Ø£ÙƒØ¨Ø± Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ© Ø¶Ø®Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
            scale = max(0.1, min(20.0, scale))

            # Ø§Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¶Ù…Ù† Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            # Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ù ÙŠØ¹ØªÙ…Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù†Ø³Ø¨ÙŠ Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠØ¯ Ø¨Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠ
            w_target = content_rect.width() * scale
            h_target = w_target * (pm.height() / float(pm.width()))
            cx = content_rect.left() + (content_rect.width() - w_target) / 2.0
            cy = content_rect.top() + (content_rect.height() - h_target) / 2.0
            if orient == QtGui.QPageLayout.Portrait:
                cy += content_rect.height() * 0.02

            target = QtCore.QRectF(cx, cy, w_target, h_target)
            src = QtCore.QRectF(0, 0, pm.width(), pm.height())

            painter.save()
            # Ø£Ù„ØºÙ Ø£ÙŠ Ù‚ØµÙ‘ Ù…ØªØ±Ø§ÙƒÙ… Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø¹Ø¨Ø± ÙƒØ§Ù…Ù„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            try:
                painter.setClipping(False)
            except Exception:
                pass
            # Ø§Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±.
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… SourceOver ÙŠØ¬Ø¹Ù„Ù‡Ø§ ØªÙØ¹Ø±Ø¶ ÙÙˆÙ‚ Ø£ÙŠ ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ¶Ø§Ø¡ Ù„Ù„Ø±Ø³Ù….
            painter.setCompositionMode(QtGui.QPainter.CompositionMode_SourceOver)
            try:
                painter.setOpacity(float(self.wm_opacity.value()))
            except Exception:
                painter.setOpacity(0.10)
            painter.drawPixmap(target, pm, src)
            painter.restore()
        except Exception:
            pass

    def _parse_bank_from_title(self):
        """ÙŠØ­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ ÙØªØ­ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ."""
        try:
            t = (self.windowTitle() or "").strip()
        except Exception:
            t = ""
        prefixes = ["Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ø¨Ù†Ùƒ:", "ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ø¨Ù†Ùƒ:", "Ø§Ù„Ø¨Ù†Ùƒ:"]
        for p in prefixes:
            if p in t:
                try:
                    return t.split(p, 1)[1].strip()
                except Exception:
                    pass
        return None

    def _compute_props_values(self, table):
        """ÙŠØ­Ø³Ø¨ Ù‚ÙŠÙ… Ø®Ù„Ø§ØµØ© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
        - Ø¥Ù† ÙƒØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø¨Ù†Ùƒ Ù…Ø­Ø¯Ø¯ØŒ ØªÙØ­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ùƒ.
        - ÙˆØ¥Ù„Ø§ ØªÙØ­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…ÙØ¬Ù…Ù‘Ø¹Ø© Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø¨ØºØ¶Ù‘ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù†ÙˆØ¹.
        ÙŠØ¹Ø§Ø¯ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ù†ÙØ³ Ø´ÙƒÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©.
        """
        values = []
        try:
            from datetime import date as _date
            today = _date.today()
            # Ù…ØµØ¯Ø± Ø§Ù„ØµÙÙˆÙ: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§ (Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù†ÙˆØ¹)
            try:
                rows = self.parent._iter_all_rows()
            except Exception:
                rows = []
            # Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ Ù…Ù† ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ Ø«Ù… Ø§Ø³ØªÙ†ØªØ§Ø¬ Ù…Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
            bank_name = None
            try:
                parent = getattr(self, 'parent', None)
                if parent:
                    cmb_bank = getattr(parent, 'cmb_bank', None)
                    if cmb_bank:
                        bank_text = cmb_bank.currentText().strip() if hasattr(cmb_bank, 'currentText') else ''
                        if bank_text and bank_text != 'Ø§Ù„ÙƒÙ„':
                            bank_name = bank_text
            except Exception:
                pass
            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ø¨Ù†ÙƒØŒ Ø¬Ø±Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            if not bank_name:
                bank_name = self._parse_bank_from_title()
            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨Ù†Ùƒ Ù…Ø­Ø¯Ø¯ØŒ Ø§Ø³ØªÙ†ØªØ¬ Ù…Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
            if not bank_name:
                distinct_banks = set()
                try:
                    for r in rows:
                        try:
                            b_raw = r[1]; gno = str(r[2] or "")
                        except Exception:
                            b_raw, gno = "", ""
                        bnorm = normalize_bank(b_raw or "", gno or "")
                        if bnorm:
                            distinct_banks.add(bnorm)
                    if len(distinct_banks) == 1:
                        bank_name = next(iter(distinct_banks))
                except Exception:
                    pass

            allowed_statuses = ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯")
            final_total = 0.0
            initial_total = 0.0
            reg_used = 0.0
            unreg_used = 0.0
            for row in rows:
                try:
                    bank_raw = row[1]; g_no = str(row[2] or ""); g_type = (row[3] or "").strip()
                    amount = float(row[4] or 0.0); end_date = row[11]; user_status = (row[12] or "").strip()
                    cash_flag = int(row[13] or 0)
                except Exception:
                    bank_raw, g_no, g_type, amount, end_date, user_status, cash_flag = "", "", "", 0.0, None, "", 0
                bname = normalize_bank(bank_raw or "", g_no or "")
                if bank_name and bname != bank_name:
                    continue
                # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ù…Ù† ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                if cash_flag:
                    continue

                # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
                a_status = auto_status_for_row(end_date, bname, today)
                if user_status == "Ù…Ù†ØªÙ‡ÙŠ":
                    a_status = "Ù…Ù†ØªÙ‡ÙŠ"
                elif user_status == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                    # Ù†ÙØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¢Ù„ÙŠØ© Ù„ÙƒÙ†Ù‡Ø§ Ø³ØªÙØ³ØªØ¨Ø¹Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                    pass

                # Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ/Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ: ÙÙ‚Ø· Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©ØŒ ÙˆØ¨Ø´Ø±Ø· Ø£Ù„Ø§ ÙŠÙƒÙˆÙ† "ØºÙŠØ± Ù…Ø³Ø¬Ù„"
                if a_status in allowed_statuses and user_status != "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                    gt = (g_type or "").strip()
                    gt_norm = gt.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
                    if ("Ù†Ù‡Ø§Ø¦ÙŠ" in gt_norm) or ("Ù†Ù‡Ø§Ø¦Ù‰" in gt_norm) or ("Ù…Ø§Ù„ÙŠ" in gt_norm) or ("Ø§Ù„Ù…Ø§Ù„ÙŠØ©" in gt_norm) or ("Ù…Ø§Ù„Ù‰" in gt_norm):
                        final_total += amount
                    elif ("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" in gt_norm) or ("Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰" in gt_norm) or ("Ù…Ø¨Ø¯Ø¦ÙŠ" in gt_norm) or ("Ù…Ø¨Ø¯Ø¦Ù‰" in gt_norm):
                        initial_total += amount

                # Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„: Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø· ÙˆØ¨ÙˆØ¶Ø¹ "ØºÙŠØ± Ù…Ø³Ø¬Ù„"
                if a_status in allowed_statuses and user_status == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                    unreg_used += amount

            # Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ = Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ + Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡)
            reg_used = final_total + initial_total

            total_used = reg_used + unreg_used
            # Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
            limit_val = 0.0
            try:
                if bank_name:
                    conn = connect_db()
                    c = conn.cursor()
                    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ø¯Ø¯
                    result = c.execute("SELECT limit_amount FROM bank_limits WHERE bank_name = ?", (bank_name,)).fetchone()
                    if result:
                        limit_val = float(result[0] or 0.0)
                    conn.close()
            except Exception:
                pass
            remaining = limit_val - total_used

            # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù†Ù…Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            values = [
                (limit_val, "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø¶Ù…Ø§Ù†Ø§Øª"),
                (final_total, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©"),
                (initial_total, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"),
                (reg_used, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ"),
                (unreg_used, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„ÙƒØ´Ù"),
                (total_used, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),
                (remaining, "Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ§Ø­"),
            ]
        except Exception:
            # Ø¥Ù† Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø£Ø¹ÙØ¯ Ù‚ÙŠÙ…Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø¦Ù…Ù‹Ø§
            try:
                bank_name = None
                # Ø¬Ø±Ø¨ ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹
                try:
                    parent = getattr(self, 'parent', None)
                    if parent:
                        cmb_bank = getattr(parent, 'cmb_bank', None)
                        if cmb_bank:
                            bank_text = cmb_bank.currentText().strip() if hasattr(cmb_bank, 'currentText') else ''
                            if bank_text and bank_text != 'Ø§Ù„ÙƒÙ„':
                                bank_name = bank_text
                except Exception:
                    pass
                # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ø¨Ù†ÙƒØŒ Ø¬Ø±Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                if not bank_name:
                    bank_name = self._parse_bank_from_title()
            except Exception:
                pass
            # Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
            limit_val = 0.0
            try:
                if bank_name:
                    conn = connect_db()
                    c = conn.cursor()
                    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ø¯Ø¯
                    result = c.execute("SELECT limit_amount FROM bank_limits WHERE bank_name = ?", (bank_name,)).fetchone()
                    if result:
                        limit_val = float(result[0] or 0.0)
                    conn.close()
            except Exception:
                pass
            values = [
                (limit_val, "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø¶Ù…Ø§Ù†Ø§Øª"),
                (0.0, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©"),
                (0.0, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©"),
                (0.0, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ"),
                (0.0, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„ÙƒØ´Ù"),
                (0.0, "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"),
                (limit_val, "Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…ØªØ§Ø­"),
            ]
        return values

    def _draw_props_footer(self, painter, area_rect, values, font_family):
        """ÙŠØ±Ø³Ù… ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ ØµÙÙˆÙ: Ø§Ù„Ù‚ÙŠÙ…Ø© ÙŠØ³Ø§Ø±Ù‹Ø§ ÙˆØ§Ù„Ø§Ø³Ù… ÙŠÙ…ÙŠÙ†Ù‹Ø§."""
        try:
            if not values:
                return
            # Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶Ø¨Ø· Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù…Ø¹ Ø­Ø¯ Ø£Ø¹Ù„Ù‰ Ø£ÙƒØ¨Ø±
            row_h = max(16, int(getattr(self, 'sp_props_row_h', None).value() if hasattr(self, 'sp_props_row_h') else 90))
            painter.save()
            # Ø­Ø¯ÙˆØ¯ Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ù‹Ø§ Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
            painter.setPen(QtGui.QPen(QtCore.Qt.black, 1.0))
            painter.fillRect(area_rect, QtGui.QColor(255, 255, 255))
            y = area_rect.top()
            # Ù‚Ø³Ù‘Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¥Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ†: 42% Ù„Ù„Ù‚ÙŠÙ…Ø©ØŒ 58% Ù„Ù„ÙˆØµÙ
            mid_x = area_rect.left() + area_rect.width() * 0.42
            # Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„Ø®Ø· ÙˆØ®ÙŠØ§Ø± Ø§Ù„Ø¹Ø±ÙŠØ¶
            try:
                base_pt = int(getattr(self, 'sp_props_font_pt', None).value()) if hasattr(self, 'sp_props_font_pt') else 8
                bold_vals = bool(getattr(self, 'chk_props_bold_values', None).isChecked()) if hasattr(self, 'chk_props_bold_values') else True
            except Exception:
                base_pt, bold_vals = 8, True
            for val, label in values:
                rr = QtCore.QRectF(area_rect.left(), y, area_rect.width(), row_h)
                painter.drawRect(rr)
                # Ø®Ø· ÙØ§ØµÙ„ Ø¹Ù…ÙˆØ¯ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© ÙˆØ§Ù„ÙˆØµÙ
                painter.drawLine(QtCore.QPointF(mid_x, rr.top()), QtCore.QPointF(mid_x, rr.bottom()))
                # Ø§Ù„Ù‚ÙŠÙ…Ø©: Ø¨Ø®Ø· Ø£Ø«Ù‚Ù„ Ù‚Ù„ÙŠÙ„Ù‹Ø§ ÙˆÙ…Ø­Ø§Ø°Ø§Ø© ÙŠØ³Ø§Ø±
                f_val = QtGui.QFont(font_family, max(7, int(base_pt)))
                f_val.setBold(bool(bold_vals))
                painter.setFont(f_val)
                left = QtCore.QRectF(rr.left() + 6, rr.top(), mid_x - rr.left() - 12, rr.height())
                painter.drawText(left, QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter, f"{float(val or 0):,.2f}")
                # Ø§Ù„ÙˆØµÙ: Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ† Ù…Ø¹ Ù…Ø³Ø§Ø­Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆÙ…Ù†Ø¹ Ø£ÙƒÙ„ Ø§Ù„Ø­Ø±ÙˆÙ ÙŠÙ…ÙŠÙ†Ù‹Ø§
                f_lbl = QtGui.QFont(font_family, max(7, int(base_pt)))
                f_lbl.setBold(False)
                painter.setFont(f_lbl)
                pad_l, pad_r = 6.0, 8.0
                right = QtCore.QRectF(mid_x + pad_l, rr.top(), rr.right() - (mid_x + pad_l + pad_r), rr.height())
                # Ù‚Øµ Ø¢Ù…Ù† Ù„Ù„Ù†Øµ Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨ RTL: Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø± ÙŠÙ…ÙŠÙ†Ù‹Ø§
                fm = painter.fontMetrics()
                elided = fm.elidedText(str(label), QtCore.Qt.ElideLeft, int(max(0, right.width() - 2)))
                painter.drawText(right, QtCore.Qt.AlignVCenter | QtCore.Qt.AlignHCenter | QtCore.Qt.TextSingleLine, elided)
                y += row_h
            painter.restore()
        except Exception:
            pass

    def _save_pdf(self):
        self._save_settings()
        path, _ = QtWidgets.QFileDialog.getSaveFileName(self, "Ø­ÙØ¸ PDF", "report.pdf", "PDF (*.pdf)")
        if not path:
            return
        printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
        printer.setOutputFormat(QtPrintSupport.QPrinter.PdfFormat)
        printer.setOutputFileName(path)
        self._apply_printer_settings(printer)
        self._render(printer)


def preview(self):
    dlg = PrintPreviewDialog(self)
    dlg.exec_()


class _EmbeddedSplash(QtWidgets.QWidget):
    """Overlay covers the whole MainWindow (including toolbar) and shows centered logo for N ms."""

    def __init__(self, parent: QtWidgets.QMainWindow, logo_path: str, duration_ms: int = 5000):
        super().__init__(parent)
        self.setObjectName("EmbeddedSplash")
        # Stay above other children
        self.setWindowFlags(QtCore.Qt.FramelessWindowHint | QtCore.Qt.SubWindow)
        self.setAttribute(QtCore.Qt.WA_StyledBackground, True)
        self.setStyleSheet("#EmbeddedSplash { background: #000; }")
        self._pm = QtGui.QPixmap(logo_path) if logo_path else QtGui.QPixmap()
        self._duration = int(duration_ms)
        # Centered label for logo or text
        self._label = QtWidgets.QLabel(self)
        self._label.setAlignment(QtCore.Qt.AlignCenter)
        self._label.setStyleSheet("QLabel { color:#eee; font-size:14px; }")
        self._label.raise_()
        QtCore.QTimer.singleShot(self._duration, self._finish)

    def _layout_logo(self):
        self._label.setGeometry(self.rect())
        if not self._pm.isNull():
            target_h = max(100, int(min(self.width(), self.height()) * 0.40))
            pm2 = self._pm.scaledToHeight(target_h, QtCore.Qt.SmoothTransformation)
            self._label.setPixmap(pm2)
            self._label.setText("")
        else:
            self._label.setPixmap(QtGui.QPixmap())
            self._label.setText("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦")

    def showEvent(self, e):
        super().showEvent(e)
        self._sync_geometry()
        self._layout_logo()

    def resizeEvent(self, e):
        super().resizeEvent(e)
        self._sync_geometry()
        self._layout_logo()

    def _sync_geometry(self):
        # Cover the entire main window client area including toolbars/statusbar
        if self.parent():
            self.setGeometry(self.parent().rect())

    def _finish(self):
        self.hide()
        self.deleteLater()


QtCore.QCoreApplication.setOrganizationName("GuaranteesApp")
QtCore.QCoreApplication.setApplicationName("Main")


# ======== Ø¬Ø¯ÙˆÙ„: Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ (Ø§Ø³Ù… + ÙÙ‡Ø±Ø³) Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡ ========
def _ensure_geom_timer(self):
    try:
        if getattr(self, "_geom_save_timer", None) is None:
            self._geom_save_timer = QtCore.QTimer(self)
            self._geom_save_timer.setSingleShot(True)
            self._geom_save_timer.timeout.connect(lambda: _do_auto_save_geometry(self))
    except Exception:
        pass


def _do_auto_save_geometry(self):
    try:
        self._geom_save_timer.stop()
    except Exception:
        pass
    try:
        save_table_geometry(self)
        # Ø¥Ø´Ø¹Ø§Ø± Ø®ÙÙŠÙ Ø¨Ø¯ÙˆÙ† Ø¥Ø²Ø¹Ø§Ø¬
        try:
            _status(self, "ØªÙ… Ø­ÙØ¸ ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.", 2000)
        except Exception:
            pass
    except Exception:
        pass


def _schedule_geom_save(self):
    try:
        _ensure_geom_timer(self)
        self._geom_save_timer.start(400)
    except Exception:
        pass

def _status(self, msg: str, ms: int = 2000):
    try:
        if hasattr(self, "statusBar") and callable(self.statusBar) and self.statusBar():
            self.statusBar().showMessage(str(msg), int(ms))
    except Exception:
        pass


def save_table_geometry(self):
    """Save widths (by normalized name + by index) and row heights as JSON in QSettings."""
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        by_name = {}
        by_index = []
        try:
            for i in range(self.table.columnCount()):
                it = self.table.horizontalHeaderItem(i)
                nm = _norm_col_name(it.text() if it else str(i))
                w = int(self.table.columnWidth(i))
                by_name[nm] = w
                by_index.append(w)
        except Exception:
            pass
        import json as _json
        s.setValue("columns/json_widths_by_name", _json.dumps(by_name, ensure_ascii=False))
        s.setValue("columns/json_widths_by_index", _json.dumps(by_index))
        try:
            heights = [int(self.table.rowHeight(r)) for r in range(self.table.rowCount())]
        except Exception:
            heights = []
        s.setValue("rows/json_heights", _json.dumps(heights))
    except Exception:
        pass


def load_table_geometry(self):
    """Return (by_name:dict, by_index:list, heights:list) from JSON in QSettings."""
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        import json as _json
        by_name_raw = s.value("columns/json_widths_by_name", "")
        by_index_raw = s.value("columns/json_widths_by_index", "")
        heights_raw = s.value("rows/json_heights", "")
        by_name = {}
        by_index = []
        heights = []
        try:
            if by_name_raw:
                tmp = _json.loads(str(by_name_raw))
                if isinstance(tmp, dict):
                    by_name = {_norm_col_name(k): int(v) for k, v in tmp.items()}
        except Exception:
            by_name = {}
        try:
            if by_index_raw:
                tmp = _json.loads(str(by_index_raw))
                if isinstance(tmp, list):
                    by_index = [int(v) for v in tmp]
        except Exception:
            by_index = []
        try:
            if heights_raw:
                tmp = _json.loads(str(heights_raw))
                if isinstance(tmp, list):
                    heights = [int(v) for v in tmp]
        except Exception:
            heights = []
        return by_name, by_index, heights
    except Exception:
        return {}, [], []


def apply_table_geometry(self, widths_by_name=None, widths_by_index=None, row_heights=None):
    """Apply stored geometry:
         prefer name; fallback to index."""
    try:
        if widths_by_name or widths_by_index:
            for i in range(self.table.columnCount()):
                try:
                    it = self.table.horizontalHeaderItem(i)
                    nm = _norm_col_name(it.text() if it else str(i))
                    w = None
                    if widths_by_name and nm in widths_by_name:
                        w = int(widths_by_name[nm])
                    elif widths_by_index and i < len(widths_by_index):
                        w = int(widths_by_index[i])
                    if w and w > 0:
                        self.table.setColumnWidth(i, w)
                except Exception:
                    pass
    except Exception:
        pass
    try:
        if row_heights and self.table.rowCount() > 0:
            m = min(self.table.rowCount(), len(row_heights))
            for r in range(m):
                try:
                    h = int(row_heights[r])
                    if h > 0:
                        self.table.setRowHeight(r, h)
                except Exception:
                    pass
    except Exception:
        pass


# Ù…Ø­Ø°ÙˆÙ: Ù…Ø¹Ø§Ù„Ø¬Ø§Øª ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ (Ù†ÙØ³Ø® Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø©)


QtCore.QCoreApplication.setOrganizationName('GuaranteesApp')
QtCore.QCoreApplication.setApplicationName('Main')


# ===== Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø£Ø¹Ù…Ø¯Ø©/ØµÙÙˆÙ) â€” Ø¯Ø§Ø¦Ù… Ø¹Ø¨Ø± QSettings =====
def save_table_geometry(self):
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        by_name, by_index = {}, []
        try:
            for i in range(self.table.columnCount()):
                it = self.table.horizontalHeaderItem(i)
                nm = _norm_col_name(it.text() if it else str(i))
                w = int(self.table.columnWidth(i))
                by_name[nm] = w
                by_index.append(w)
        except Exception:
            pass
        s.setValue("columns/widths_by_name", by_name)
        s.setValue("columns/widths_by_index", by_index)
        try:
            heights = [int(self.table.rowHeight(r)) for r in range(self.table.rowCount())]
        except Exception:
            heights = []
        s.setValue("rows/heights", heights)
    except Exception:
        pass


def load_table_geometry(self):
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        by_name = s.value("columns/widths_by_name", type=dict) or {}
        if not isinstance(by_name, dict): by_name = {}
        by_name = {_norm_col_name(k): int(v) for k, v in by_name.items() if str(v).strip() != ""}
        by_index = s.value("columns/widths_by_index", type=list) or []
        if not isinstance(by_index, list): by_index = []
        by_index = [int(v) for v in by_index if str(v).strip() != ""]
        heights = s.value("rows/heights", type=list) or []
        if not isinstance(heights, list): heights = []
        heights = [int(h) for h in heights if str(h).strip() != ""]
        return by_name, by_index, heights
    except Exception:
        return {}, [], []


def apply_table_geometry(self, widths_by_name=None, widths_by_index=None, row_heights=None):
    # Ø£Ø¹Ù…Ø¯Ø©
    try:
        if widths_by_name or widths_by_index:
            for i in range(self.table.columnCount()):
                try:
                    it = self.table.horizontalHeaderItem(i)
                    nm = _norm_col_name(it.text() if it else str(i))
                    w = None
                    if widths_by_name and nm in widths_by_name:
                        w = int(widths_by_name[nm])
                    elif widths_by_index and i < len(widths_by_index):
                        w = int(widths_by_index[i])
                    if w and w > 0:
                        self.table.setColumnWidth(i, w)
                except Exception:
                    pass
    except Exception:
        pass
    # ØµÙÙˆÙ
    try:
        if row_heights and self.table.rowCount() > 0:
            m = min(self.table.rowCount(), len(row_heights))
            for r in range(m):
                try:
                    h = int(row_heights[r])
                    if h > 0:
                        self.table.setRowHeight(r, h)
                except Exception:
                    pass
    except Exception:
        pass


class MarqueeLabel(QtWidgets.QLabel):
    def __init__(self, text="", parent=None):
        super().__init__(text, parent)
        self._timer = QtCore.QTimer(self)
        self._timer.timeout.connect(self._tick)
        self._step = 1
        self._offset = 0
        self._gap = 40
        self._direction = 1
        try:
            self.setTextFormat(QtCore.Qt.RichText)
        except Exception:
            pass
    def start(self, interval=40, step=1, gap=40, direction=1):
        try:
            self._step = max(1, int(step or 1))
            self._gap = max(10, int(gap or 40))
            self._direction = 1 if int(direction or 1) >= 0 else -1
            self._timer.setInterval(max(10, int(interval or 40)))
            self._timer.start()
        except Exception:
            pass
    def stop(self):
        try:
            self._timer.stop()
        except Exception:
            pass
    def _tick(self):
        try:
            self._offset += self._step * self._direction
            self.update()
        except Exception:
            pass
    def paintEvent(self, ev):
        try:
            painter = QtGui.QPainter(self)
            painter.setRenderHint(QtGui.QPainter.Antialiasing, True)
            # Prepare rich text document for HTML content
            doc = QtGui.QTextDocument()
            doc.setDefaultFont(self.font())
            doc.setHtml(self.text())
            tw = int(doc.idealWidth())
            h = int(doc.size().height())
            if tw <= 0:
                tw = max(1, self.fontMetrics().horizontalAdvance(self.text()))
                h = self.fontMetrics().height()
            y = (self.height() - h) // 2
            L = tw + self._gap
            if L <= 0:
                L = 1
            while self._offset >= L:
                self._offset -= L
            while self._offset < 0:
                self._offset += L
            x = -self._offset
            # draw repeated copies to fill width
            while x < self.width():
                painter.save()
                painter.translate(x, y)
                doc.drawContents(painter)
                painter.restore()
                x += tw + self._gap
        except Exception:
            # fallback to default QLabel paint
            super().paintEvent(ev)

class StatisticsDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Dashboard)")
        self.resize(1000, 700)
        self.setLayoutDirection(QtCore.Qt.RightToLeft)
        self.setup_ui()
        self.load_data()

    def setup_ui(self):
        layout = QtWidgets.QVBoxLayout(self)
        
        # Header / Title
        title = QtWidgets.QLabel("Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª")
        title.setStyleSheet("font-size: 24px; font-weight: bold; color: #1565C0; margin-bottom: 10px;")
        title.setAlignment(QtCore.Qt.AlignCenter)
        layout.addWidget(title)

        # 1. Summary Cards Area (HBox)
        cards_layout = QtWidgets.QHBoxLayout()
        self.card_total_count = self._create_card("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª", "0", "#E3F2FD", "#1565C0")
        self.card_total_amount = self._create_card("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº", "0.00", "#E8F5E9", "#2E7D32")
        self.card_active = self._create_card("Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø±ÙŠØ©", "0", "#FFF3E0", "#EF6C00")
        
        cards_layout.addWidget(self.card_total_count)
        cards_layout.addWidget(self.card_total_amount)
        cards_layout.addWidget(self.card_active)
        layout.addLayout(cards_layout)
        
        # Scroll Area for Charts
        self.scroll = QtWidgets.QScrollArea()
        self.scroll.setWidgetResizable(True)
        content_widget = QtWidgets.QWidget()
        self.content_layout = QtWidgets.QVBoxLayout(content_widget)
        
        # 2. Charts Section
        # Row 1: Banks (Left) & Status (Right)
        row1 = QtWidgets.QHBoxLayout()
        
        # Bank Chart Container
        self.bank_group = QtWidgets.QGroupBox("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ (Ø£Ø¹Ù„Ù‰ 5)")
        self.bank_layout = QtWidgets.QVBoxLayout(self.bank_group)
        row1.addWidget(self.bank_group, 2) # weight 2
        
        # Status Chart Container
        self.status_group = QtWidgets.QGroupBox("Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª")
        self.status_layout = QtWidgets.QVBoxLayout(self.status_group)
        row1.addWidget(self.status_group, 1) # weight 1
        
        self.content_layout.addLayout(row1)
        
        # Row 2: Departments
        self.dept_group = QtWidgets.QGroupBox("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…")
        self.dept_layout = QtWidgets.QVBoxLayout(self.dept_group)
        self.content_layout.addWidget(self.dept_group)

        self.scroll.setWidget(content_widget)
        layout.addWidget(self.scroll)
        
        # Buttons Layout
        btn_layout = QtWidgets.QHBoxLayout()
        
        # Refresh Button
        btn_refresh = QtWidgets.QPushButton("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
        btn_refresh.setStyleSheet("background-color: #2196F3; color: white; padding: 8px; font-weight: bold;")
        btn_refresh.clicked.connect(self.load_data)
        btn_layout.addWidget(btn_refresh)
        
        # Print Button
        btn_print = QtWidgets.QPushButton("Ø·Ø¨Ø§Ø¹Ø© ğŸ–¨ï¸")
        btn_print.setStyleSheet("background-color: #607D8B; color: white; padding: 8px; font-weight: bold;")
        btn_print.clicked.connect(self.print_dashboard)
        btn_layout.addWidget(btn_print)
        
        # Download All Departments Button
        btn_download_all = QtWidgets.QPushButton("ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Word)")
        btn_download_all.setStyleSheet("background-color: #009688; color: white; padding: 8px; font-weight: bold;")
        btn_download_all.clicked.connect(self.generate_all_dept_letters)
        btn_layout.addWidget(btn_download_all)
        
        layout.addLayout(btn_layout)

    def _create_card(self, title, value, bg_color, text_color):
        card = QtWidgets.QFrame()
        card.setStyleSheet(f"background-color: {bg_color}; border-radius: 10px; border: 1px solid {text_color};")
        l = QtWidgets.QVBoxLayout(card)
        lbl_title = QtWidgets.QLabel(title)
        lbl_title.setStyleSheet(f"color: {text_color}; font-size: 14px;")
        lbl_title.setAlignment(QtCore.Qt.AlignCenter)
        
        lbl_value = QtWidgets.QLabel(value)
        lbl_value.setStyleSheet(f"color: {text_color}; font-size: 20px; font-weight: bold;")
        lbl_value.setAlignment(QtCore.Qt.AlignCenter)
        lbl_value.setObjectName("value_label") # for easy finding later
        
        l.addWidget(lbl_title)
        l.addWidget(lbl_value)
        return card

    def load_data(self):
        try:
            conn = connect_db()
            c = conn.cursor()
            today = date.today()
            today_str = today.strftime('%Y-%m-%d')
            
            # Fetch ALL data to process in Python for consistency
            # Columns: department, bank, amount, end_date, user_status, cash_flag
            c.execute("SELECT department, bank, amount, end_date, user_status, cash_flag FROM guarantees")
            rows = c.fetchall()
            conn.close()
            
            # --- Aggregation Variables ---
            # global_count: Total Guarantees in DB (History + Current)
            global_count = len(rows)
            
            # active_count: "Current Exposure" count (Active + Near Expiry + Expired Pending)
            # i.e. Everything NOT Final/Closed
            active_count = 0
            
            # global_amount: Sum of amounts for "Current Exposure" (Not Final AND Not Cash)
            global_amount = 0.0
            
            bank_stats = {} # bank -> amount
            status_counts = {"Ø³Ø§Ø±ÙŠ": 0, "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": 0, "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯": 0, "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ": 0}
            dept_stats = {} # dept -> {'count': 0, 'amount': 0.0}

            # Keywords indicating the guarantee is effectively closed/final
            final_keywords = ["Ø§ÙØ±Ø§Ø¬", "Ø¥ÙØ±Ø§Ø¬", "Ù…Ø±Ø¯ÙˆØ¯", "Ù…Ù„ØºÙ‰", "Ù…Ù„ØºÙŠ", "Ø¥Ù„ØºØ§Ø¡", "Ø§Ù„ØºØ§Ø¡", "Ù…ØµØ§Ø¯Ø±", "Ù…ØµØ§Ø¯Ø±Ø©", "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØºØ±Ø¶", "Ù…Ù†ØªÙ‡ÙŠ"]

            def _norm(t):
                if not t: return ""
                return t.replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§").replace("Ø©", "Ù‡").replace("Ù‰", "ÙŠ")

            for (dept, bank, amount, end_date_str, u_status, cash_flag) in rows:
                amount = amount or 0.0
                
                # 1. Check if Final/Closed
                is_final = False
                u_norm = ""
                if u_status:
                    u_norm = _norm(str(u_status))
                    for k in final_keywords:
                        if _norm(k) in u_norm:
                            is_final = True
                            break
                
                if is_final:
                    continue # Skip Final from Active Stats (Amounts, Active Count, Charts)
                
                # If we are here, it's a "Non-Final" guarantee (Active, Near Expiry, Expired Pending, or Unregistered)
                # User wants ALL of these treated as "Active" for totals/stats
                active_count += 1
                
                # 2. Status Calculation (for Chart)
                st = ""
                # Explicit check for "Unregistered" if user manually marked it
                if "ØºÙŠØ± Ù…Ø³Ø¬Ù„" in u_norm:
                    st = "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"
                else:
                    st = auto_status_for_row(end_date_str, "", today)
                
                status_counts[st] = status_counts.get(st, 0) + 1
                
                # 3. Amount Logic (Exclude Cash)
                # Cash flag: 1 means cash
                is_cash = False
                try:
                    if cash_flag and int(cash_flag) == 1:
                        is_cash = True
                except:
                    pass
                
                # Amount contribution (for Global, Bank, Dept)
                # Include amount if NOT Cash (regardless of expiry date, as long as NOT Final)
                if not is_cash:
                    global_amount += amount
                    
                    # Bank Stats
                    b_key = bank if bank else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
                    bank_stats[b_key] = bank_stats.get(b_key, 0.0) + amount
                    
                    # Dept Stats (Amount part)
                    d_key = dept if dept else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
                    if d_key not in dept_stats: dept_stats[d_key] = {'count': 0, 'amount': 0.0}
                    dept_stats[d_key]['amount'] += amount
                
                # Dept Stats (Count part - All Non-Final)
                d_key = dept if dept else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
                if d_key not in dept_stats: dept_stats[d_key] = {'count': 0, 'amount': 0.0}
                dept_stats[d_key]['count'] += 1

            # --- Update UI ---
            
            # 1. Cards
            self.card_total_count.findChild(QtWidgets.QLabel, "value_label").setText(f"{global_count:,}")
            self.card_total_amount.findChild(QtWidgets.QLabel, "value_label").setText(f"{global_amount:,.2f}")
            self.card_active.findChild(QtWidgets.QLabel, "value_label").setText(f"{active_count:,}")
            
            # 2. Banks (Top 5 by Amount)
            bank_data = [(k, v) for k, v in bank_stats.items()]
            bank_data.sort(key=lambda x: x[1], reverse=True)
            self._update_chart(self.bank_layout, bank_data[:5], global_amount, is_currency=True)
            
            # 3. Status
            status_data = [(k, v) for k, v in status_counts.items() if v > 0]
            status_data.sort(key=lambda x: x[1], reverse=True)
            # Use active_count as base for status percentages (distribution of current portfolio)
            self._update_chart(self.status_layout, status_data, active_count, is_currency=False, color_map={
                "Ø³Ø§Ø±ÙŠ": "#4CAF50", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": "#FFC107", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯": "#F44336",
                "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„": "#2196F3"
            })
            
            # 4. Departments
            # Convert dict to list of tuples: (Name, Count, Amount)
            dept_data = []
            for d_name, d_val in dept_stats.items():
                dept_data.append((d_name, d_val['count'], d_val['amount']))
            
            # Sort by Count DESC
            dept_data.sort(key=lambda x: x[1], reverse=True)
            
            # Use active_count as base for dept percentages
            self._update_chart(self.dept_layout, dept_data, active_count, is_currency=False, action_callback=self.generate_dept_letter)

        except Exception as e:
            # print(f"Error loading stats: {e}")
            pass

    def _update_chart(self, layout, data, total_base, is_currency=False, color_map=None, action_callback=None):
        # Clear existing
        while layout.count():
            item = layout.takeAt(0)
            if item.widget(): item.widget().deleteLater()
            
        if not data:
            layout.addWidget(QtWidgets.QLabel("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"))
            return

        # Calculate max value for progress bar
        # data item can be (label, value) or (label, value, secondary)
        max_val = max((item[1] or 0) for item in data) if data else 1
        
        for item in data:
            label = item[0]
            value = item[1] or 0
            secondary = item[2] if len(item) > 2 else None
            
            if not label: label = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
            percentage = (value / total_base * 100) if total_base > 0 else 0
            relative_percent = (value / max_val * 100) if max_val > 0 else 0
            
            container = QtWidgets.QWidget()
            l_h = QtWidgets.QVBoxLayout(container)
            l_h.setContentsMargins(0, 5, 0, 5)
            
            # Label Row
            row_lbl = QtWidgets.QHBoxLayout()
            
            # Action Button (e.g. Word Report)
            if action_callback:
                btn_act = QtWidgets.QPushButton("ğŸ“„")
                btn_act.setCursor(QtCore.Qt.PointingHandCursor)
                btn_act.setToolTip("Ø¥ØµØ¯Ø§Ø± Ø®Ø·Ø§Ø¨ (Word)")
                btn_act.setFixedSize(30, 25)
                btn_act.setStyleSheet("background-color: #E0E0E0; border: none; border-radius: 3px;")
                btn_act.clicked.connect(lambda checked, l=label: action_callback(l))
                row_lbl.addWidget(btn_act)

            lbl_name = QtWidgets.QLabel(label)
            
            val_str = f"{value:,.2f}" if is_currency else f"{value:,}"
            text = f"{val_str} ({percentage:.1f}%)"
            if secondary is not None:
                text += f"   |   {secondary:,.2f}"
            
            lbl_val = QtWidgets.QLabel(text)
            row_lbl.addWidget(lbl_name)
            row_lbl.addStretch()
            row_lbl.addWidget(lbl_val)
            l_h.addLayout(row_lbl)
            
            # Bar
            pbar = QtWidgets.QProgressBar()
            pbar.setRange(0, 100)
            pbar.setValue(int(relative_percent))
            pbar.setTextVisible(False)
            pbar.setFixedHeight(10)
            
            color = "#1976D2"
            if color_map and label in color_map:
                color = color_map[label]
            
            pbar.setStyleSheet(f"""
                QProgressBar {{
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    background-color: #f0f0f0;
                }}
                QProgressBar::chunk {{
                    background-color: {color};
                    border-radius: 5px;
                }}
            """)
            l_h.addWidget(pbar)
            
            layout.addWidget(container)
        layout.addStretch()

    def print_dashboard(self):
        try:
            printer = QtPrintSupport.QPrinter(QtPrintSupport.QPrinter.HighResolution)
            
            # Apply Duplex Settings
            try:
                s = QtCore.QSettings("GuaranteesApp", "Main")
                d_idx = s.value("print/duplex", 0, type=int)
                if d_idx == 1:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexLongSide)
                elif d_idx == 2:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexShortSide)
                else:
                    printer.setDuplex(QtPrintSupport.QPrinter.DuplexNone)
            except Exception:
                pass
                
            dialog = QtPrintSupport.QPrintDialog(printer, self)
            if dialog.exec_() == QtPrintSupport.QPrintDialog.Accepted:
                painter = QtGui.QPainter(printer)
                widget = self.scroll.widget()
                pixmap = widget.grab()
                rect = printer.pageRect()
                scaled_pixmap = pixmap.scaledToWidth(rect.width(), QtCore.Qt.SmoothTransformation)
                painter.drawPixmap(0, 0, scaled_pixmap)
                painter.end()
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {e}")

    def _generate_word_for_dept(self, dept_name, save_path):
        """Deprecated: Use ReportsHandler.generate_word_for_dept instead."""
        return ReportsHandler.generate_word_for_dept(dept_name, save_path)

    def generate_dept_letter(self, dept_name):
        ReportsHandler.generate_dept_letter_ui(self, dept_name)

    def generate_all_dept_letters(self):
        ReportsHandler.generate_all_dept_letters_ui(self)


class AuditLogDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Ø³Ø¬Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Audit Log)")
        self.resize(900, 600)
        self.setLayoutDirection(QtCore.Qt.RightToLeft)
        self.setup_ui()
        self.load_data()

    def setup_ui(self):
        layout = QtWidgets.QVBoxLayout(self)
        
        # Filter Layout
        filter_layout = QtWidgets.QHBoxLayout()
        self.ed_search = QtWidgets.QLineEdit()
        self.ed_search.setPlaceholderText("Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ Ø§Ù„ØªÙØ§ØµÙŠÙ„)...")
        self.ed_search.textChanged.connect(self.load_data)
        filter_layout.addWidget(self.ed_search)
        
        self.btn_refresh = QtWidgets.QPushButton("ØªØ­Ø¯ÙŠØ«")
        self.btn_refresh.clicked.connect(self.load_data)
        filter_layout.addWidget(self.btn_refresh)
        
        layout.addLayout(filter_layout)
        
        # Table
        self.table = QtWidgets.QTableWidget()
        self.table.setColumnCount(5)
        self.table.setHorizontalHeaderLabels(["ID", "Ø§Ù„ÙˆÙ‚Øª", "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "Ø§Ù„ØªÙØ§ØµÙŠÙ„"])
        self.table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.ResizeToContents)
        self.table.horizontalHeader().setSectionResizeMode(4, QtWidgets.QHeaderView.Stretch)
        self.table.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
        self.table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        layout.addWidget(self.table)

    def load_data(self):
        try:
            conn = connect_db()
            c = conn.cursor()
            
            search_text = self.ed_search.text().strip()
            query = "SELECT id, timestamp, user, action, target || ' - ' || details FROM audit_log"
            params = []
            
            if search_text:
                query += " WHERE user LIKE ? OR action LIKE ? OR target LIKE ? OR details LIKE ?"
                p = f"%{search_text}%"
                params = [p, p, p, p]
                
            query += " ORDER BY id DESC LIMIT 500"
            
            c.execute(query, params)
            rows = c.fetchall()
            
            self.table.setRowCount(0)
            for row in rows:
                r_idx = self.table.rowCount()
                self.table.insertRow(r_idx)
                for c_idx, val in enumerate(row):
                    it = QtWidgets.QTableWidgetItem(str(val))
                    it.setTextAlignment(QtCore.Qt.AlignCenter)
                    self.table.setItem(r_idx, c_idx, it)
            
            conn.close()
        except Exception as e:
            pass

class BackupManagerDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ")
        self.resize(800, 500)
        self.setLayoutDirection(QtCore.Qt.RightToLeft)
        self.setup_ui()
        self.load_backups()

    def setup_ui(self):
        layout = QtWidgets.QVBoxLayout(self)
        
        # Toolbar
        toolbar = QtWidgets.QHBoxLayout()
        
        self.btn_create = QtWidgets.QPushButton("Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©")
        self.btn_create.setStyleSheet("font-weight: bold; color: #2e7d32;")
        self.btn_create.clicked.connect(self.create_backup_action)
        toolbar.addWidget(self.btn_create)
        
        self.btn_restore = QtWidgets.QPushButton("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
        self.btn_restore.setStyleSheet("font-weight: bold; color: #1565c0;")
        self.btn_restore.clicked.connect(self.restore_backup_action)
        toolbar.addWidget(self.btn_restore)
        
        self.btn_delete = QtWidgets.QPushButton("Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
        self.btn_delete.setStyleSheet("font-weight: bold; color: #c62828;")
        self.btn_delete.clicked.connect(self.delete_backup_action)
        toolbar.addWidget(self.btn_delete)
        
        toolbar.addStretch()
        layout.addLayout(toolbar)
        
        # Table
        self.table = QtWidgets.QTableWidget()
        self.table.setColumnCount(3)
        self.table.setHorizontalHeaderLabels(["Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø®Ø©", "Ø§Ù„Ø­Ø¬Ù…"])
        self.table.horizontalHeader().setSectionResizeMode(0, QtWidgets.QHeaderView.Stretch)
        self.table.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
        self.table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        self.table.setSelectionMode(QtWidgets.QAbstractItemView.SingleSelection)
        layout.addWidget(self.table)

    def load_backups(self):
        try:
            from pathlib import Path
            from datetime import datetime
            data_dir = _get_data_dir()
            backup_dir = data_dir / "backup"
            if not backup_dir.exists():
                backup_dir.mkdir(parents=True, exist_ok=True)
            
            backups = sorted(backup_dir.glob("backup_*.zip"), key=lambda p: p.stat().st_mtime, reverse=True)
            
            self.table.setRowCount(0)
            for bk in backups:
                r = self.table.rowCount()
                self.table.insertRow(r)
                
                # Name
                it_name = QtWidgets.QTableWidgetItem(bk.name)
                it_name.setTextAlignment(QtCore.Qt.AlignCenter)
                self.table.setItem(r, 0, it_name)
                self.table.item(r, 0).setData(QtCore.Qt.UserRole, str(bk))
                
                # Date
                dt = datetime.fromtimestamp(bk.stat().st_mtime)
                it_date = QtWidgets.QTableWidgetItem(dt.strftime("%Y-%m-%d %H:%M:%S"))
                it_date.setTextAlignment(QtCore.Qt.AlignCenter)
                self.table.setItem(r, 1, it_date)
                
                # Size
                size_mb = bk.stat().st_size / (1024 * 1024)
                it_size = QtWidgets.QTableWidgetItem(f"{size_mb:.2f} MB")
                it_size.setTextAlignment(QtCore.Qt.AlignCenter)
                self.table.setItem(r, 2, it_size)
        except Exception:
            pass

    def create_backup_action(self):
        try:
            # Show progress dialog or wait cursor
            QtWidgets.QApplication.setOverrideCursor(QtCore.Qt.WaitCursor)
            path = create_backup()
            QtWidgets.QApplication.restoreOverrideCursor()
            
            if path:
                QtWidgets.QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.")
                self.load_backups()
                # Log audit
                try:
                    log_audit("Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "Ø§Ù„Ù†Ø¸Ø§Ù…", "Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©")
                except:
                    pass
            else:
                QtWidgets.QMessageBox.warning(self, "ÙØ´Ù„", "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.")
        except Exception as e:
            QtWidgets.QApplication.restoreOverrideCursor()
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")

    def restore_backup_action(self):
        row = self.table.currentRow()
        if row < 0:
            QtWidgets.QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†Ø³Ø®Ø© Ù„Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§.")
            return
            
        path = self.table.item(row, 0).data(QtCore.Qt.UserRole)
        
        reply = QtWidgets.QMessageBox.question(
            self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©",
            "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©ØŸ\nØ³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹).",
            QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
        )
        
        if reply == QtWidgets.QMessageBox.Yes:
            from pathlib import Path
            QtWidgets.QApplication.setOverrideCursor(QtCore.Qt.WaitCursor)
            success = restore_backup(path)
            QtWidgets.QApplication.restoreOverrideCursor()
            
            if success:
                QtWidgets.QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙØ¶Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.")
                # Log audit
                try:
                    log_audit("Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "Ø§Ù„Ù†Ø¸Ø§Ù…", f"Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {Path(path).name}")
                except:
                    pass
                self.accept() # Close dialog as state changed significantly
            else:
                QtWidgets.QMessageBox.warning(self, "ÙØ´Ù„", "ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.")

    def delete_backup_action(self):
        try:
            import os
            from pathlib import Path
            row = self.table.currentRow()
            if row < 0:
                QtWidgets.QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†Ø³Ø®Ø© Ù„Ø­Ø°ÙÙ‡Ø§.")
                return
                
            path = self.table.item(row, 0).data(QtCore.Qt.UserRole)
            
            reply = QtWidgets.QMessageBox.question(
                self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
                "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )
            
            if reply == QtWidgets.QMessageBox.Yes:
                try:
                    os.remove(path)
                    self.load_backups()
                    # Log audit
                    try:
                        log_audit("Ø­Ø°Ù Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", "Ø§Ù„Ù†Ø¸Ø§Ù…", f"Ø­Ø°Ù: {Path(path).name}")
                    except:
                        pass
                except Exception as e:
                    QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù: {e}")
        except Exception:
            pass


class DuplicatesDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©")
        self.resize(1100, 600)
        self.setLayoutDirection(QtCore.Qt.RightToLeft)
        
        # Layout
        layout = QtWidgets.QVBoxLayout(self)
        
        # Header / Info
        lbl_info = QtWidgets.QLabel("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØªØ¹Ø±Ø¶ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ´ØªØ±Ùƒ ÙÙŠ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„ØªÙƒØ±Ø§Ø±.")
        lbl_info.setStyleSheet("color: #eaeaea; font-weight: bold; margin-bottom: 10px; font-size: 14px;")
        lbl_info.setWordWrap(True)
        layout.addWidget(lbl_info)
        
        # Tree Widget
        self.tree = QtWidgets.QTreeWidget()
        self.tree.setHeaderLabels(["Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø§Ù„Ù…Ø³ØªÙÙŠØ¯", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"])
        self.tree.header().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        self.tree.header().setSectionResizeMode(6, QtWidgets.QHeaderView.ResizeToContents) # Actions column
        self.tree.setLayoutDirection(QtCore.Qt.RightToLeft)
        layout.addWidget(self.tree)
        
        # Buttons
        btn_box = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Close)
        btn_box.rejected.connect(self.accept)
        layout.addWidget(btn_box)
        
        self.load_duplicates()

    def load_duplicates(self):
        self.tree.clear()
        try:
            from db_adapter import connect_db
            conn = connect_db()
            c = conn.cursor()
            
            # Fetch all g_nos and cash_flags to perform normalized duplicate detection in Python
            all_rows = c.execute("SELECT id, department, bank, g_no, beneficiary, amount, user_status, cash_flag FROM guarantees").fetchall()
            conn.close()

            from collections import defaultdict
            grouped = defaultdict(list)
            
            # Group by normalized g_no
            for r in all_rows:
                g_no_raw = r[3]
                try:
                    norm = normalize_gno(str(g_no_raw or ""))
                except Exception:
                    norm = ""
                if norm:
                    grouped[norm].append(r)
            
            # Filter for duplicates (count > 1)
            duplicates = {k: v for k, v in grouped.items() if len(v) > 1}
            
            if not duplicates:
                item = QtWidgets.QTreeWidgetItem(["Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶Ù…Ø§Ù†Ø§Øª Ù…ÙƒØ±Ø±Ø©", "", "", "", "", "", ""])
                self.tree.addTopLevelItem(item)
                return

            # Sort by the g_no of the first item in each group
            sorted_keys = sorted(duplicates.keys(), key=lambda k: duplicates[k][0][3] or "")
            
            for key in sorted_keys:
                items = duplicates[key]
                display_gno = items[0][3] or key
                
                # Create Parent Item
                parent = QtWidgets.QTreeWidgetItem([f"Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†: {display_gno} ({len(items)})"])
                parent.setExpanded(True)
                parent.setBackground(0, QtGui.QBrush(QtGui.QColor("#424242")))
                parent.setForeground(0, QtGui.QBrush(QtGui.QColor("#ffff00")))
                parent.setFont(0, QtGui.QFont("Arial", 10, QtGui.QFont.Bold))
                self.tree.addTopLevelItem(parent)
                
                # Create Child Items
                for r in items:
                    rid, dept, bank, gno, ben, amt, status, cash_flag = r
                    
                    is_cash = int(cash_flag or 0) == 1
                    # Show "Ù†Ù‚Ø¯ÙŠ" instead of Bank Name for Cash Guarantees, or append it
                    type_display = "Ù†Ù‚Ø¯ÙŠ" if is_cash else (bank or "")
                    
                    child = QtWidgets.QTreeWidgetItem([
                        dept or "", type_display, gno or "", ben or "", f"{amt:,.2f}" if amt else "0.00", status or "", ""
                    ])
                    
                    # Highlight Cash Guarantees in Blue
                    if is_cash:
                        for col in range(7):
                            child.setForeground(col, QtGui.QBrush(QtGui.QColor("#42a5f5"))) # Light Blue
                    
                    child.setData(0, QtCore.Qt.UserRole, rid)
                    parent.addChild(child)
                    
                    # Action Buttons Widget
                    widget = QtWidgets.QWidget()
                    h_lay = QtWidgets.QHBoxLayout(widget)
                    h_lay.setContentsMargins(2, 2, 2, 2)
                    
                    btn_edit = QtWidgets.QPushButton("ØªØ¹Ø¯ÙŠÙ„")
                    btn_edit.setCursor(QtCore.Qt.PointingHandCursor)
                    btn_edit.setStyleSheet("background-color: #1976d2; color: white; border-radius: 3px; padding: 2px 8px;")
                    btn_edit.clicked.connect(lambda _, x=rid: self.edit_guarantee(x))
                    
                    btn_del = QtWidgets.QPushButton("Ø­Ø°Ù")
                    btn_del.setCursor(QtCore.Qt.PointingHandCursor)
                    btn_del.setStyleSheet("background-color: #c62828; color: white; border-radius: 3px; padding: 2px 8px;")
                    btn_del.clicked.connect(lambda _, x=rid: self.delete_guarantee(x))
                    
                    h_lay.addWidget(btn_edit)
                    h_lay.addWidget(btn_del)
                    self.tree.setItemWidget(child, 6, widget)
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª: {e}")

    def edit_guarantee(self, rid):
        if self.parent():
            try:
                if hasattr(self.parent(), 'edit_guarantee_by_id'):
                    self.parent().edit_guarantee_by_id(rid)
                    self.load_duplicates() # Reload after edit
                    # Refresh parent logic is handled by parent if needed, or we can trigger it
                    if hasattr(self.parent(), 'refresh'):
                        self.parent().refresh()
            except Exception as e:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: {e}")

    def delete_guarantee(self, rid):
        reply = QtWidgets.QMessageBox.question(self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¶Ù…Ø§Ù†ØŸ", 
                                             QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No)
        if reply == QtWidgets.QMessageBox.Yes:
            try:
                from db_adapter import connect_db
                conn = connect_db()
                c = conn.cursor()
                # Check existence
                if not c.execute("SELECT 1 FROM guarantees WHERE id=?", (rid,)).fetchone():
                    conn.close()
                    QtWidgets.QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø±Ø¨Ù…Ø§ ØªÙ… Ø­Ø°ÙÙ‡ Ø¨Ø§Ù„ÙØ¹Ù„.")
                    self.load_duplicates()
                    return

                c.execute("DELETE FROM guarantees WHERE id=?", (rid,))
                conn.commit()
                conn.close()
                
                QtWidgets.QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­.")
                
                self.load_duplicates()
                # Notify parent to refresh
                if self.parent() and hasattr(self.parent(), 'refresh'):
                    self.parent().refresh()
            except Exception as e:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù: {e}")


class MainWindow(QtWidgets.QMainWindow):
    def _setup_auto_refresh(self):
        try:
            self._auto_refresh_timer = QtCore.QTimer(self)
            self._auto_refresh_timer.setSingleShot(True)
            self._auto_refresh_timer.timeout.connect(self._refresh_all_tabs)
        except Exception:
            pass
        try:
            self.table.itemChanged.connect(lambda *_: self._schedule_auto_refresh())
        except Exception:
            pass
        try:
            if getattr(self, 'table_cash', None):
                self.table_cash.itemChanged.connect(lambda *_: self._schedule_auto_refresh())
        except Exception:
            pass

    def do_cloud_sync(self):
        """Execute cloud synchronization"""
        try:
            # Check if requests is available
            if 'requests' not in sys.modules:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "Ù…ÙƒØªØ¨Ø© requests ØºÙŠØ± Ù…Ø«Ø¨ØªØ©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.")
                return

            # Import cloud_sync module dynamically to avoid circular imports or early errors
            try:
                import cloud_sync
                import importlib
                importlib.reload(cloud_sync)
            except ImportError:
                # If file not in path, try adding current dir
                sys.path.append(os.path.dirname(os.path.abspath(__file__)))
                try:
                    import cloud_sync
                except ImportError as e:
                    QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: {e}")
                    return

            # Create progress dialog
            progress = QtWidgets.QProgressDialog("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...", "Ø¥Ù„ØºØ§Ø¡", 0, 0, self)
            progress.setWindowModality(QtCore.Qt.WindowModal)
            progress.setMinimumDuration(0)
            progress.setValue(0)
            progress.show()
            
            # Define callback for progress updates
            def update_progress(msg):
                progress.setLabelText(msg)
                QtWidgets.QApplication.processEvents()

            # Run sync
            success, msg = cloud_sync.sync_to_cloud(progress_callback=update_progress)
            
            progress.close()
            
            if success:
                self.show_toast(msg, 3000)
                QtWidgets.QMessageBox.information(self, "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­", msg)
            else:
                QtWidgets.QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", f"ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:\n{msg}")
                
        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {str(e)}")

    def _schedule_auto_refresh(self):
        try:
            if getattr(self, '_loading_rows', False):
                return
            t = getattr(self, '_auto_refresh_timer', None)
            if t and not t.isActive():
                t.start(250)
        except Exception:
            pass

    def _refresh_all_tabs(self):
        for name in (
            '_populate_bank_detailed_tab',
            '_populate_dept_report_tab',
            '_populate_dept_matrix_tab',
            '_populate_kpis_tab',
        ):
            try:
                fn = getattr(self, name, None)
                if callable(fn):
                    fn()
            except Exception:
                pass
    def _ensure_daily_active_excel_export(self):
        try:
            from datetime import datetime, timedelta
            s = QtCore.QSettings("GuaranteesApp", "Main")
            last_date = str(s.value("daily_export/last_date", type=str) or "")
            today = datetime.now().strftime("%Y-%m-%d")
            if last_date != today:
                try:
                    self._do_daily_active_excel_export()
                    s.setValue("daily_export/last_date", today)
                    s.sync()
                except Exception:
                    pass
            # Schedule next run (~02:00 next day)
            try:
                now = datetime.now()
                nxt = (now + timedelta(days=1)).replace(hour=2, minute=0, second=0, microsecond=0)
                ms = max(60_000, int((nxt - now).total_seconds() * 1000))
            except Exception:
                ms = 6 * 60 * 60 * 1000
            try:
                if getattr(self, "_daily_export_timer", None) is None:
                    self._daily_export_timer = QtCore.QTimer(self)
                    self._daily_export_timer.setSingleShot(False)
                    self._daily_export_timer.timeout.connect(self._do_daily_active_excel_export)
                self._daily_export_timer.start(ms)
            except Exception:
                pass
        except Exception:
            pass
    def _resize_row_for_item(self, item):
        """Resize the changed row to fit its wrapped content."""
        try:
            if item is None:
                return
            r = item.row()
            if r is not None and int(r) >= 0:
                self.table.resizeRowToContents(int(r))
        except Exception:
            pass

    def _on_edit_commit(self, editor):
        """Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø³Ø·Ø± Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ±.

        ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ guarantees:
        - 7: beneficiary
        - 8: requester
        - 9: project_name
        - 17: delivery_status
        - 18: recipient_name
        - 19: notes
        - 20: entry_number
        """
        try:
            idx = self.table.currentIndex()
            if not idx or not idx.isValid():
                return
            row = idx.row(); col = idx.column()
            # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ù…Ø­Ø±Ø± Ø£Ùˆ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠ
            try:
                text = editor.toPlainText() if hasattr(editor, 'toPlainText') else str(self.table.item(row, col).text())
            except Exception:
                it = self.table.item(row, col)
                text = it.text() if it else ""

            # Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø¬Ù„: Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
            g_item = self.table.item(row, 2)
            g_no = normalize_gno(g_item.text().strip() if g_item else "")
            if not g_no:
                return

            mapping = {
                7:  "beneficiary",
                8:  "requester",
                9:  "project_name",
                17: "delivery_status",
                18: "recipient_name",
                19: "notes",
                20: "entry_number",
            }
            if col not in mapping:
                return

            # Ù†ÙÙ‘Ø° ØªØ­Ø¯ÙŠØ«Ù‹Ø§ Ù…Ø¨Ø§Ø´Ø±Ù‹Ø§ Ù„Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            try:
                conn = connect_db(); c = conn.cursor()
                c.execute(f"UPDATE guarantees SET {mapping[col]}=? WHERE g_no=?", (text, g_no))
                conn.commit(); conn.close()
            except Exception:
                try:
                    conn.close()
                except Exception:
                    pass
                return

            # Ø£Ø¹ÙØ¯ Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø«Ù… Ø§Ø­ÙØ¸ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            try:
                self.table.resizeRowToContents(row)
            except Exception:
                pass
            try:
                self.save_table_geometry()
            except Exception:
                pass
        except Exception:
            pass

    def _persist_cell_change(self, item):
        try:
            if item is None:
                return
            if getattr(self, "_loading_rows", False):
                return
            row = item.row(); col = item.column()
            mapping = {
                7:  "beneficiary",
                8:  "requester",
                9:  "project_name",
                17: "delivery_status",
                18: "recipient_name",
                19: "notes",
                20: "entry_number",
            }
            if col not in mapping:
                return
            g_item = self.table.item(row, 2)
            g_no = normalize_gno(g_item.text().strip() if g_item else "")
            if not g_no:
                return
            text = item.text() if hasattr(item, "text") else ""
            try:
                conn = connect_db(); c = conn.cursor()
                c.execute(f"UPDATE guarantees SET {mapping[col]}=? WHERE g_no=?", (text, g_no))
                conn.commit(); conn.close()
            except Exception:
                try:
                    conn.close()
                except Exception:
                    pass
        except Exception:
            pass

    def show_toast(self, message: str, timeout: int = 2000):
        """Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ø¶Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© (Ù…ÙØªÙ…Ø±ÙƒØ²) ÙŠØ¸Ù‡Ø± Ù„Ø«ÙˆØ§Ù†Ù Ù‚Ù„ÙŠÙ„Ø©."""
        try:
            if not hasattr(self, "_toast_label") or self._toast_label is None:
                self._toast_label = QtWidgets.QLabel(self)
                self._toast_label.setAttribute(QtCore.Qt.WA_TransparentForMouseEvents)
                self._toast_label.setAttribute(QtCore.Qt.WA_TranslucentBackground)
                # Ù…Ø¸Ù‡Ø± ÙˆØ§Ø¶Ø­ Ø¨Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© ÙˆÙ†Øµ ØºØ§Ù…Ù‚ ÙˆØ­Ø¯ Ø£Ø®Ø¶Ø±
                self._toast_label.setStyleSheet(
                    """
                    QLabel {
                        background: rgba(255,255,255, 240);
                        color: #111;
                        border: 2px solid #2E7D32;
                        border-radius: 10px;
                        padding: 10px 16px;
                        font-size: 14px;
                        font-weight: 600;
                    }
                    """
                )
                self._toast_label.setWindowFlags(QtCore.Qt.SubWindow)
                # Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                try:
                    eff = QtWidgets.QGraphicsDropShadowEffect(self._toast_label)
                    eff.setBlurRadius(18)
                    eff.setOffset(0, 3)
                    eff.setColor(QtGui.QColor(0, 0, 0, 160))
                    self._toast_label.setGraphicsEffect(eff)
                except Exception:
                    pass
            # Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© ØªØ­Ù‚Ù‚ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ¶ÙˆØ­
            txt = str(message or "")
            if "âœ“" not in txt:
                txt = "âœ“ " + txt
            self._toast_label.setText(txt)
            self._toast_label.adjustSize()
            # ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ù…Ù†ØªØµÙ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            geo = self.rect()
            x = (geo.width() - self._toast_label.width()) // 2
            y = (geo.height() - self._toast_label.height()) // 2
            self._toast_label.move(max(8, x), max(8, y))
            self._toast_label.show(); self._toast_label.raise_()
            try:
                if hasattr(self, "_toast_timer") and self._toast_timer:
                    self._toast_timer.stop()
            except Exception:
                pass
            self._toast_timer = QtCore.QTimer(self)
            self._toast_timer.setSingleShot(True)
            self._toast_timer.timeout.connect(lambda: self._toast_label.hide())
            self._toast_timer.start(int(timeout if timeout else 3000))
        except Exception:
            # Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ù†Ø¹ÙˆØ¯ Ù„Ø±Ø³Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
            try:
                if hasattr(self, "statusBar") and self.statusBar():
                    self.statusBar().showMessage(str(message), 3000)
            except Exception:
                pass

    def _attach_search_suggestions(self):
        comp = QtWidgets.QCompleter(self)
        comp.setCaseSensitivity(QtCore.Qt.CaseInsensitive)
        try:
            comp.setFilterMode(QtCore.Qt.MatchContains)
        except Exception:
            pass
        comp.setMaxVisibleItems(3)
        try:
            comp.popup().setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarAlwaysOff)
        except Exception:
            pass
        mdl = QtCore.QStringListModel([], comp)
        comp.setModel(mdl)
        self.ed_search.setCompleter(comp)
        def _q(sql, p):
            try:
                conn = connect_db(); c = conn.cursor()
                rows = c.execute(sql, ("%" + p + "%",)).fetchall()
                conn.close()
                return [str(r[0]) for r in rows if (r and r[0] is not None)]
            except Exception:
                return []
        def _fetch_all(t):
            t = str(t or "").strip()
            if not t:
                return []
            out = []
            for sql in (
                "SELECT DISTINCT g_no FROM guarantees WHERE TRIM(COALESCE(g_no,''))<>'' AND g_no LIKE ? ORDER BY g_no LIMIT 5",
                "SELECT DISTINCT beneficiary FROM guarantees WHERE TRIM(COALESCE(beneficiary,''))<>'' AND beneficiary LIKE ? ORDER BY beneficiary LIMIT 5",
                "SELECT DISTINCT requester FROM guarantees WHERE TRIM(COALESCE(requester,''))<>'' AND requester LIKE ? ORDER BY requester LIMIT 5",
                "SELECT DISTINCT project_name FROM guarantees WHERE TRIM(COALESCE(project_name,''))<>'' AND project_name LIKE ? ORDER BY project_name LIMIT 5",
                "SELECT DISTINCT entry_number FROM guarantees WHERE TRIM(COALESCE(entry_number,''))<>'' AND entry_number LIKE ? ORDER BY entry_number LIMIT 5",
                "SELECT DISTINCT notes FROM guarantees WHERE TRIM(COALESCE(notes,''))<>'' AND notes LIKE ? ORDER BY notes LIMIT 5",
            ):
                if len(out) >= 3:
                    break
                for v in _q(sql, t):
                    if v not in out:
                        out.append(v)
                    if len(out) >= 3:
                        break
            return out[:3]
        def _on(txt):
            items = _fetch_all(txt)
            mdl.setStringList(items)
            if items:
                comp.complete()
        try:
            self.ed_search.textEdited.connect(_on)
        except Exception:
            pass

    def show_import_excel(self):
            path, _ = QtWidgets.QFileDialog.getOpenFileName(self, "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„", "", "Excel (*.xlsx)")
            if not path:
                return
            try:
                import_xlsx_to_db(path, parent=self)
                if hasattr(self, "refresh"):
                    self.refresh()
            except Exception as e:
                try:
                    QtWidgets.QMessageBox.critical(self, "Ø§Ø³ØªÙŠØ±Ø§Ø¯", f"ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: {e}")
                except Exception:
                    pass

    # ==============================
    # ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„ (Ø¬Ø¯ÙŠØ¯)
    # ==============================
    def _build_bank_detailed_tab(self):
        w = QtWidgets.QWidget(self)
        v = QtWidgets.QVBoxLayout(w)

        # ØµÙ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ù†Ùƒ
        filter_row = QtWidgets.QHBoxLayout()
        filter_row.addWidget(QtWidgets.QLabel("Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ:"))
        self.bank_detailed_filter = QtWidgets.QComboBox(w)
        try:
            self.bank_detailed_filter.setEditable(False)
        except Exception:
            pass
        # Ø§Ù…Ù„Ø£ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        try:
            self.bank_detailed_filter.clear()
            self.bank_detailed_filter.addItem("Ø§Ù„ÙƒÙ„")
            try:
                self.bank_detailed_filter.setCurrentIndex(0)
            except Exception:
                pass
        except Exception:
            pass
        filter_row.addWidget(self.bank_detailed_filter)
        try:
            self.bank_detailed_dept_only_chk = QtWidgets.QCheckBox("Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙ‚Ø·")
        except Exception:
            self.bank_detailed_dept_only_chk = QtWidgets.QCheckBox()
            self.bank_detailed_dept_only_chk.setText("Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙ‚Ø·")
        filter_row.addWidget(self.bank_detailed_dept_only_chk)
        try:
            self.bank_detailed_cash_chk = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©")
            try:
                self.bank_detailed_cash_chk.setChecked(True)
            except Exception:
                pass
            self.bank_detailed_cash_chk.toggled.connect(self._on_bank_detailed_cash_toggled)
            filter_row.addWidget(self.bank_detailed_cash_chk)
        except Exception:
            pass
        filter_row.addStretch(1)
        v.addLayout(filter_row)

        # Ø¬Ø¯ÙˆÙ„ Ø£Ø¹Ù„Ù‰: Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ù†Ùƒ (ØºÙŠØ± Ù†Ù‚Ø¯ÙŠØ© ÙˆØ­Ø§Ù„Ø§Øª ÙØ¹Ø§Ù„Ø©)
        grp_top = QtWidgets.QGroupBox("Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ù†Ùƒ")
        self.bank_detailed_grp_top = grp_top
        top_v = QtWidgets.QVBoxLayout(grp_top)
        self.bank_detailed_active_table = QtWidgets.QTableWidget(grp_top)
        # Ø§Ø¬Ø¹Ù„ Ø£Ø¹Ù…Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ØªØ·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        try:
            _main = getattr(self, 'table', None)
            if _main is not None:
                self.bank_detailed_active_table.setColumnCount(_main.columnCount())
                _hdrs = [
                    _main.horizontalHeaderItem(i).text()
                    for i in range(_main.columnCount())
                ]
                self.bank_detailed_active_table.setHorizontalHeaderLabels(_hdrs)
                try:
                    for i in range(self.bank_detailed_active_table.columnCount()):
                        it = self.bank_detailed_active_table.horizontalHeaderItem(i)
                        if it and it.text().strip() == "ID":
                            self.bank_detailed_active_table.setColumnHidden(i, True)
                            break
                except Exception:
                    pass
        except Exception:
            # ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„ØŒ Ø§Ø­ØªÙŠØ§Ø· Ø¨ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            self.bank_detailed_active_table.setColumnCount(8)
            self.bank_detailed_active_table.setHorizontalHeaderLabels([
                "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø§Ù„Ù†ÙˆØ¹", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¬Ù‡Ø©", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù„Ø­Ø§Ù„Ø©",
            ])
        try:
            self.bank_detailed_active_table.setAlternatingRowColors(True)
        except Exception:
            pass
        try:
            self.bank_detailed_active_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Interactive)
        except Exception:
            try:
                self.bank_detailed_active_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
            except Exception:
                pass
        top_v.addWidget(self.bank_detailed_active_table)
        v.addWidget(grp_top)

        # Ø¬Ø¯ÙˆÙ„ Ø£Ø³ÙÙ„: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ
        grp_bottom = QtWidgets.QGroupBox("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ")
        self.bank_detailed_grp_bottom = grp_bottom
        bot_v = QtWidgets.QVBoxLayout(grp_bottom)
        self.bank_detailed_dept_table = QtWidgets.QTableWidget(grp_bottom)
        self.bank_detailed_dept_table.setColumnCount(6)
        self.bank_detailed_dept_table.setHorizontalHeaderLabels([
            "Ø§Ù„Ù‚Ø³Ù…",
            "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
            "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠ",
            "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
            "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ",
            "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©",
        ])
        try:
            self.bank_detailed_dept_table.setAlternatingRowColors(True)
        except Exception:
            pass
        self.bank_detailed_dept_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        bot_v.addWidget(self.bank_detailed_dept_table)
        v.addWidget(grp_bottom)

        try:
            self.bank_detailed_filter.currentIndexChanged.connect(self._on_bank_detailed_filter_changed)
        except Exception:
            try:
                self.bank_detailed_filter.currentIndexChanged.connect(lambda _=None: self._populate_bank_detailed_tab())
            except Exception:
                pass
        try:
            self.bank_detailed_dept_only_chk.toggled.connect(lambda checked: self._on_bank_detailed_dept_only_toggled(checked))
        except Exception:
            pass

        # Ø£ÙˆÙ„ ØªØ¹Ø¨Ø¦Ø©
        try:
            self._populate_bank_detailed_tab()
        except Exception:
            pass
        return w

    def _on_bank_detailed_dept_only_toggled(self, checked):
        try:
            if getattr(self, 'bank_detailed_grp_top', None):
                self.bank_detailed_grp_top.setVisible(not bool(checked))
        except Exception:
            pass
        try:
            self._populate_bank_detailed_tab()
        except Exception:
            pass

    def _on_bank_detailed_cash_toggled(self, checked):
        try:
            # Ø§Ù„Ø¹Ù…ÙˆØ¯ 5 Ù‡Ùˆ "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©"
            if getattr(self, 'bank_detailed_dept_table', None):
                self.bank_detailed_dept_table.setColumnHidden(5, not checked)
        except Exception:
            pass

    def _on_bank_detailed_filter_changed(self, *_):
        try:
            self._populate_bank_detailed_tab()
        except Exception as e:
            try:
                _log(f"bank_detailed: populate failed on filter change: {e}")
            except Exception:
                pass
            try:
                _status(self, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ÙØµÙ„", 3000)
            except Exception:
                pass

    def _build_bank_limits_tab(self):
        """Ø¨Ù†Ø§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ"""
        w = QtWidgets.QWidget(self)
        v = QtWidgets.QVBoxLayout(w)
        v.setContentsMargins(10, 10, 10, 10)
        v.setSpacing(10)

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        self.bank_limits_table = QtWidgets.QTableWidget(w)
        self.bank_limits_table.setColumnCount(7)
        self.bank_limits_table.setHorizontalHeaderLabels([
            "Ø§Ù„Ø¨Ù†Ùƒ",
            "Ø§Ù„Ø­Ø¯",
            "Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©",
            "Ø¶Ù…Ø§Ù†Ø§Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©",
            "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª",
            "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ",
            "Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…"
        ])
        
        try:
            self.bank_limits_table.setAlternatingRowColors(True)
        except Exception:
            pass
        try:
            self.bank_limits_table.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
            self.bank_limits_table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        except Exception:
            pass
        try:
            self.bank_limits_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        except Exception:
            pass
        try:
            self.bank_limits_table.verticalHeader().setVisible(False)
        except Exception:
            pass

        # Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¯ÙˆØ¯
        btn_layout = QtWidgets.QHBoxLayout()
        
        btn_layout.addStretch(1)
        btn_update_limits = QtWidgets.QPushButton("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¯ÙˆØ¯")
        btn_update_limits.setToolTip("ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ")
        try:
            btn_update_limits.clicked.connect(self._show_update_limits_dialog)
        except Exception:
            pass
        btn_layout.addWidget(btn_update_limits)
        v.addLayout(btn_layout)
        v.addWidget(self.bank_limits_table)

        # Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        try:
            self._populate_bank_limits_tab()
        except Exception:
            pass

        return w

    def _build_dept_report_tab(self):
        w = QtWidgets.QWidget(self)
        v = QtWidgets.QVBoxLayout(w)
        fl = QtWidgets.QHBoxLayout()
        lbl_b = QtWidgets.QLabel("Ø§Ù„Ø¨Ù†Ùƒ:")
        self.dept_report_bank_filter = QtWidgets.QComboBox()
        try:
            self.dept_report_bank_filter.clear()
        except Exception:
            pass
        self.dept_report_bank_filter.addItem("Ø§Ù„ÙƒÙ„")
        lbl_d = QtWidgets.QLabel("Ø§Ù„Ù‚Ø³Ù…:")
        self.dept_report_dept_filter = QtWidgets.QComboBox()
        try:
            self.dept_report_dept_filter.clear()
        except Exception:
            pass
        self.dept_report_dept_filter.addItem("Ø§Ù„ÙƒÙ„")
        fl.addWidget(lbl_b)
        fl.addWidget(self.dept_report_bank_filter)
        fl.addWidget(lbl_d)
        fl.addWidget(self.dept_report_dept_filter)
        self.dept_report_pivot_chk = QtWidgets.QCheckBox("Ø¹Ø±Ø¶ ÙƒÙ…ØµÙÙˆÙØ© Ù…Ø­ÙˆØ±ÙŠØ©")
        fl.addWidget(self.dept_report_pivot_chk)
        self.dept_report_totals_only_chk = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙ‚Ø·")
        fl.addWidget(self.dept_report_totals_only_chk)
        btn_export_dept_excel = QtWidgets.QPushButton("ØªØµØ¯ÙŠØ± Excelâ€¦")
        try:
            btn_export_dept_excel.clicked.connect(lambda _=None: export_table_to_excel(self, self.dept_report_table))
        except Exception:
            pass
        fl.addWidget(btn_export_dept_excel)
        fl.addStretch(1)
        v.addLayout(fl)
        self.dept_report_table = QtWidgets.QTableWidget(w)
        self.dept_report_table.setColumnCount(7)
        self.dept_report_table.setHorizontalHeaderLabels(["Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦ÙŠ", "Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", "Ù†Ù‚Ø¯ÙŠ"])
        try:
            self.dept_report_table.setAlternatingRowColors(True)
        except Exception:
            pass
        self.dept_report_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        v.addWidget(self.dept_report_table)
        try:
            # Ù…Ù†Ø¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ _populate_dept_report_tab Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
            self._updating_filters = False
            self.dept_report_bank_filter.currentIndexChanged.connect(lambda _=None: self._on_dept_filter_changed())
            self.dept_report_dept_filter.currentIndexChanged.connect(lambda _=None: self._on_dept_filter_changed())
            self.dept_report_pivot_chk.toggled.connect(lambda _=None: self._on_dept_filter_changed())
            self.dept_report_totals_only_chk.toggled.connect(lambda _=None: self._on_dept_filter_changed())
        except Exception:
            pass
        try:
            self._populate_dept_report_tab()
        except Exception:
            pass
        return w

    def _on_dept_filter_changed(self):
        """Ù…Ø¹Ø§Ù„Ø¬ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ ØªØ¨ÙˆÙŠØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"""
        try:
            if not getattr(self, '_updating_filters', False):
                self._populate_dept_report_tab()
        except Exception:
            pass

    def _populate_dept_report_tab(self):
        try:
            rows = self._iter_all_rows()
        except Exception:
            rows = []
        banks_set = set()
        depts_set = set()
        for r in rows:
            try:
                depts_set.add(str(r[0] or ""))
                banks_set.add(normalize_bank(r[1] or "", str(r[2] or "")))
            except Exception:
                pass
        # Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¨Ù†Ùƒ
        try:
            current_bank = self.dept_report_bank_filter.currentText()
        except Exception:
            current_bank = "Ø§Ù„ÙƒÙ„"
        # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ
        try:
            self._updating_filters = True
            self.dept_report_bank_filter.blockSignals(True)
            self.dept_report_bank_filter.clear()
            self.dept_report_bank_filter.addItem("Ø§Ù„ÙƒÙ„")
            for b in sorted(banks_set):
                if b:
                    self.dept_report_bank_filter.addItem(b)
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            index = self.dept_report_bank_filter.findText(current_bank)
            if index >= 0:
                self.dept_report_bank_filter.setCurrentIndex(index)
            else:
                self.dept_report_bank_filter.setCurrentIndex(0)
            self.dept_report_bank_filter.blockSignals(False)
        except Exception:
            try:
                self.dept_report_bank_filter.blockSignals(False)
            except Exception:
                pass
        # Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù‚Ø³Ù…
        try:
            current_dept = self.dept_report_dept_filter.currentText()
        except Exception:
            current_dept = "Ø§Ù„ÙƒÙ„"
        # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        try:
            self.dept_report_dept_filter.blockSignals(True)
            self.dept_report_dept_filter.clear()
            self.dept_report_dept_filter.addItem("Ø§Ù„ÙƒÙ„")
            for d in sorted(depts_set):
                if d:
                    self.dept_report_dept_filter.addItem(d)
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            index = self.dept_report_dept_filter.findText(current_dept)
            if index >= 0:
                self.dept_report_dept_filter.setCurrentIndex(index)
            else:
                self.dept_report_dept_filter.setCurrentIndex(0)
            self.dept_report_dept_filter.blockSignals(False)
            self._updating_filters = False
        except Exception:
            try:
                self.dept_report_dept_filter.blockSignals(False)
                self._updating_filters = False
            except Exception:
                pass
        try:
            sel_bank = self.dept_report_bank_filter.currentText()
        except Exception:
            sel_bank = "Ø§Ù„ÙƒÙ„"
        try:
            sel_dept = self.dept_report_dept_filter.currentText()
        except Exception:
            sel_dept = "Ø§Ù„ÙƒÙ„"
        pivot = False
        try:
            pivot = bool(self.dept_report_pivot_chk.isChecked())
        except Exception:
            pivot = False
        totals_only = False
        try:
            totals_only = bool(self.dept_report_totals_only_chk.isChecked())
        except Exception:
            totals_only = False
        from datetime import date as _date
        today = _date.today()
        allowed_statuses = ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„")
        data = {}
        for r in rows:
            try:
                department, bank_raw, g_no, g_type, amount = r[0], r[1], r[2], r[3], r[4]
            except Exception:
                department, bank_raw, g_no, g_type, amount = None, None, None, None, 0.0
            bname = normalize_bank(bank_raw or "", str(g_no or ""))
            dname = str(department or "")
            if sel_bank and sel_bank != "Ø§Ù„ÙƒÙ„" and bname != sel_bank:
                continue
            if sel_dept and sel_dept != "Ø§Ù„ÙƒÙ„" and dname != sel_dept:
                continue
            # ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
            try:
                end_date = r[11]
                user_status = r[12]
            except Exception:
                end_date = None; user_status = None
            a_status = auto_status_for_row(end_date, bname, today)
            _us = (user_status or "").strip()
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us:
                a_status = _us
            try:
                amt = float(amount or 0.0)
            except Exception:
                amt = 0.0
            gt = (g_type or "").strip()
            gt = gt.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
            key = (dname, bname)
            if key not in data:
                data[key] = {"initial": 0.0, "final": 0.0, "financial": 0.0, "cash": 0.0}
            try:
                is_cash = bool(int((r[13] if len(r) > 13 else 0) or 0))
            except Exception:
                is_cash = False
            if is_cash:
                # Ù„Ø§ ØªÙØ­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¶Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
                data[key]["cash"] += amt
                continue
            if not (a_status in allowed_statuses):
                # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ ÙˆØºÙŠØ±Ù‡
                continue
            if ("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" in gt) or ("Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰" in gt) or ("Ù…Ø¨Ø¯Ø¦ÙŠ" in gt) or ("Ù…Ø¨Ø¯Ø¦Ù‰" in gt):
                data[key]["initial"] += amt
            elif ("Ù†Ù‡Ø§Ø¦ÙŠ" in gt) or ("Ù†Ù‡Ø§Ø¦Ù‰" in gt):
                data[key]["final"] += amt
            elif ("Ù…Ø§Ù„ÙŠ" in gt) or ("Ø§Ù„Ù…Ø§Ù„ÙŠØ©" in gt) or ("Ù…Ø§Ù„Ù‰" in gt):
                data[key]["financial"] += amt
        def fmt_money(x):
            try:
                return f"{float(x):,.2f}"
            except Exception:
                try:
                    return f"{float(str(x).replace(',', '')):,.2f}"
                except Exception:
                    return str(x)
        t = self.dept_report_table
        if pivot:
            banks_list = sorted(banks_set) if sel_bank == "Ø§Ù„ÙƒÙ„" else [sel_bank]
            if totals_only:
                headers = ["Ø§Ù„Ù‚Ø³Ù…"] + [f"{b} - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" for b in banks_list] + ["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ù…"]
                cols_cnt = 1 + len(banks_list) * 1 + 1
            else:
                headers = ["Ø§Ù„Ù‚Ø³Ù…"]
                for b in banks_list:
                    headers.extend([f"{b} - Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", f"{b} - Ù†Ù‡Ø§Ø¦ÙŠ", f"{b} - Ù…Ø§Ù„ÙŠ", f"{b} - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", f"{b} - Ù†Ù‚Ø¯ÙŠ"]) 
                headers.extend(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ù…", "Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù‚Ø³Ù…"])
                cols_cnt = 1 + len(banks_list) * 5 + 2
            t.setColumnCount(cols_cnt)
            t.setHorizontalHeaderLabels(headers)
            depts_list = sorted(depts_set) if sel_dept == "Ø§Ù„ÙƒÙ„" else [sel_dept]
            t.setRowCount(len(depts_list))
            for r_idx, d in enumerate(depts_list):
                itd = QtWidgets.QTableWidgetItem(str(d))
                itd.setFlags(itd.flags() ^ QtCore.Qt.ItemIsEditable)
                itd.setTextAlignment(getattr(self, "_align", QtCore.Qt.AlignCenter) | QtCore.Qt.AlignVCenter)
                t.setItem(r_idx, 0, itd)
                cpos = 1
                row_total = 0.0
                row_cash_total = 0.0
                for b in banks_list:
                    sums = data.get((d, b), {"initial": 0.0, "final": 0.0, "financial": 0.0, "cash": 0.0})
                    iv = float(sums.get("initial", 0.0))
                    fv = float(sums.get("final", 0.0))
                    mv = float(sums.get("financial", 0.0))
                    cv = float(sums.get("cash", 0.0))
                    tv = iv + fv + mv
                    if totals_only:
                        val = tv
                        it = QtWidgets.QTableWidgetItem(fmt_money(val))
                        it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                        it.setTextAlignment(QtCore.Qt.AlignCenter)
                        t.setItem(r_idx, cpos, it)
                        cpos += 1
                    else:
                        for val in [iv, fv, mv, tv, cv]:
                            it = QtWidgets.QTableWidgetItem(fmt_money(val))
                            it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                            it.setTextAlignment(QtCore.Qt.AlignCenter)
                            t.setItem(r_idx, cpos, it)
                            cpos += 1
                    row_total += tv
                    row_cash_total += cv
                it_tot = QtWidgets.QTableWidgetItem(fmt_money(row_total))
                it_tot.setFlags(it_tot.flags() ^ QtCore.Qt.ItemIsEditable)
                it_tot.setTextAlignment(QtCore.Qt.AlignCenter)
                t.setItem(r_idx, cols_cnt - 1, it_tot)
                if not totals_only:
                    it_cash_tot = QtWidgets.QTableWidgetItem(fmt_money(row_cash_total))
                    it_cash_tot.setFlags(it_cash_tot.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_cash_tot.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(r_idx, cols_cnt - 1, it_cash_tot)
        else:
            rows_out = []
            for (d, b), sums in sorted(data.items(), key=lambda kv: (kv[0][0], kv[0][1])):
                init_v = float(sums.get("initial", 0.0))
                final_v = float(sums.get("final", 0.0))
                fin_v = float(sums.get("financial", 0.0))
                cash_v = float(sums.get("cash", 0.0))
                total_v = init_v + final_v + fin_v
                rows_out.append((d, b, init_v, final_v, fin_v, total_v, cash_v))
            if totals_only:
                t.setColumnCount(3)
                t.setHorizontalHeaderLabels(["Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"])
            else:
                t.setColumnCount(7)
                t.setHorizontalHeaderLabels(["Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦ÙŠ", "Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", "Ù†Ù‚Ø¯ÙŠ"])
            t.setRowCount(len(rows_out) + (1 if rows_out else 0))
            tot_init = 0.0
            tot_final = 0.0
            tot_fin = 0.0
            tot_all = 0.0
            tot_cash = 0.0
            for r_idx, (d, b, iv, fv, mv, tv, cv) in enumerate(rows_out):
                if totals_only:
                    items = [
                        QtWidgets.QTableWidgetItem(str(d)),
                        QtWidgets.QTableWidgetItem(str(b)),
                        QtWidgets.QTableWidgetItem(fmt_money(tv)),
                    ]
                else:
                    items = [
                        QtWidgets.QTableWidgetItem(str(d)),
                        QtWidgets.QTableWidgetItem(str(b)),
                        QtWidgets.QTableWidgetItem(fmt_money(iv)),
                        QtWidgets.QTableWidgetItem(fmt_money(fv)),
                        QtWidgets.QTableWidgetItem(fmt_money(mv)),
                        QtWidgets.QTableWidgetItem(fmt_money(tv)),
                        QtWidgets.QTableWidgetItem(fmt_money(cv)),
                    ]
                for i, it in enumerate(items):
                    it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                    it.setTextAlignment(QtCore.Qt.AlignCenter if (not totals_only and i >= 2) or (totals_only and i == 2) else (getattr(self, "_align", QtCore.Qt.AlignCenter) | QtCore.Qt.AlignVCenter))
                    t.setItem(r_idx, i, it)
                tot_init += iv
                tot_final += fv
                tot_fin += mv
                tot_all += tv
                tot_cash += cv
            if rows_out:
                rpos = len(rows_out)
                it_d = QtWidgets.QTableWidgetItem("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ")
                it_d.setFlags(it_d.flags() ^ QtCore.Qt.ItemIsEditable)
                it_d.setTextAlignment(QtCore.Qt.AlignCenter)
                t.setItem(rpos, 0, it_d)
                if totals_only:
                    it_b = QtWidgets.QTableWidgetItem("")
                    it_b.setFlags(it_b.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_b.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 1, it_b)
                    it_t = QtWidgets.QTableWidgetItem(fmt_money(tot_all))
                    it_t.setFlags(it_t.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_t.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 2, it_t)
                else:
                    it_b = QtWidgets.QTableWidgetItem("")
                    it_b.setFlags(it_b.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_b.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 1, it_b)
                    it_i = QtWidgets.QTableWidgetItem(fmt_money(tot_init))
                    it_i.setFlags(it_i.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_i.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 2, it_i)
                    it_f = QtWidgets.QTableWidgetItem(fmt_money(tot_final))
                    it_f.setFlags(it_f.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_f.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 3, it_f)
                    it_m = QtWidgets.QTableWidgetItem(fmt_money(tot_fin))
                    it_m.setFlags(it_m.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_m.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 4, it_m)
                    it_t = QtWidgets.QTableWidgetItem(fmt_money(tot_all))
                    it_t.setFlags(it_t.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_t.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 5, it_t)
                    it_c = QtWidgets.QTableWidgetItem(fmt_money(tot_cash))
                    it_c.setFlags(it_c.flags() ^ QtCore.Qt.ItemIsEditable)
                    it_c.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(rpos, 6, it_c)

    def _populate_bank_detailed_tab(self):
        # Ø§Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø«Ù… ØµÙÙ‘ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
        try:
            rows = self._iter_all_rows()
        except Exception:
            rows = []
        from datetime import date as _date
        today = _date.today()

        try:
            selected_bank_txt = (self.bank_detailed_filter.currentText() or "").strip()
        except Exception:
            selected_bank_txt = ""
        if selected_bank_txt in ("", "Ø§Ù„ÙƒÙ„", "Ø§Ù„ÙƒÙ„ÙŠ", "Ø§Ù„ÙƒÙ„Ù‘ÙŠ"):
            selected_bank = "Ø§Ù„ÙƒÙ„"
        else:
            selected_bank = selected_bank_txt

        # Ø­Ø¯Ù‘Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        try:
            current_bank = (self.bank_detailed_filter.currentText() or "").strip() or "Ø§Ù„ÙƒÙ„"
            banks_set = set()
            for r in rows:
                try:
                    bank_raw = r[1]; gno = r[2]
                except Exception as e:
                    try:
                        _log(f"bank_detailed: parse row for banks failed: {e}")
                    except Exception:
                        pass
                    bank_raw, gno = None, None
                banks_set.add(normalize_bank(bank_raw or "", str(gno or "")))
            self.bank_detailed_filter.blockSignals(True)
            self.bank_detailed_filter.clear()
            self.bank_detailed_filter.addItem("Ø§Ù„ÙƒÙ„")
            for b in sorted(banks_set):
                if b:
                    self.bank_detailed_filter.addItem(b)
            idx = self.bank_detailed_filter.findText(current_bank)
            if idx >= 0:
                self.bank_detailed_filter.setCurrentIndex(idx)
            else:
                self.bank_detailed_filter.setCurrentIndex(0)
            self.bank_detailed_filter.blockSignals(False)
            selected_bank_txt = (self.bank_detailed_filter.currentText() or "").strip()
            selected_bank = "Ø§Ù„ÙƒÙ„" if selected_bank_txt in ("", "Ø§Ù„ÙƒÙ„", "Ø§Ù„ÙƒÙ„ÙŠ", "Ø§Ù„ÙƒÙ„Ù‘ÙŠ") else selected_bank_txt
        except Exception as e:
            try:
                _log(f"bank_detailed: update filter failed: {e}")
                _status(self, "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ", 2000)
            except Exception:
                pass
            try:
                self.bank_detailed_filter.blockSignals(False)
            except Exception:
                pass

        allowed_statuses = ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„")

        # ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ (ØºÙŠØ± Ù†Ù‚Ø¯ÙŠ ÙˆØ­Ø§Ù„Ø§Øª ÙØ¹Ø§Ù„Ø©)
        active_rows = []
        for r in rows:
            try:
                department, bank_raw, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment = r[:15]
            except Exception:
                department, bank_raw, g_no, g_type, amount, beneficiary, issue_date, end_date, user_status, cash_flag = None, None, None, None, 0.0, None, None, None, None, 0
            bname = normalize_bank(bank_raw or "", str(g_no or ""))
            if (selected_bank != "Ø§Ù„ÙƒÙ„") and (bname != selected_bank):
                continue
            _us = (user_status or "").strip()
            a_status = auto_status_for_row(end_date, bname, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                a_status = "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"
            elif _us:
                a_status = _us
            is_cash = False
            try:
                is_cash = bool(int(cash_flag or 0))
            except Exception:
                is_cash = False
            if is_cash:
                continue
            if a_status in allowed_statuses:
                try:
                    amt = float(amount or 0.0)
                except Exception:
                    amt = 0.0
                active_rows.append((str(g_no or ""), str(g_type or ""), amt, str(department or ""), str(beneficiary or ""), str(issue_date or ""), str(end_date or ""), a_status))

        # Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ù‚ÙŠÙ… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ØªØ±ØªÙŠØ¨ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        t_top = self.bank_detailed_active_table
        t_top.setRowCount(0)
        for r_idx, (department, bank_raw, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment, delivery_status, recipient_name, notes, entry_number, _rowid) in enumerate(rows):
            bname = normalize_bank(bank_raw or "", str(g_no or ""))
            if (selected_bank != "Ø§Ù„ÙƒÙ„") and (bname != selected_bank):
                continue
            _us = (user_status or "").strip()
            a_status = auto_status_for_row(end_date, bname, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                a_status = "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"
            elif _us:
                a_status = _us
            try:
                is_cash = bool(int(cash_flag or 0))
            except Exception:
                is_cash = False
            if is_cash:
                continue
            if a_status not in allowed_statuses:
                continue

            rpos = t_top.rowCount(); t_top.insertRow(rpos)
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙ„ÙˆÙŠÙ†
            attachment_count = 0
            try:
                conn = connect_db(); c = conn.cursor()
                attachment_count = c.execute("SELECT COUNT(*) FROM attachments WHERE g_no=?", (str(g_no or ""),)).fetchone()[0]
                conn.close()
            except Exception as e:
                try:
                    _log(f"bank_detailed_active: attachments count failed for {g_no}: {e}")
                    _status(self, "ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª", 2000)
                except Exception:
                    pass
            
            vals = [
                str(department or ""),
                bname,
                str(g_no or ""),
                str(g_type or ""),
                f"{float(amount or 0):,.2f}",
                f"{float(insurance_amount or 0):,.2f}",
                f"{float(percent or 0):.0f}%",
                str(beneficiary or ""),
                str(requester or ""),
                str(project_name or ""),
                format_date_for_view(issue_date),
                format_date_for_view(end_date),
                format_date_for_view((parse_date(end_date) + timedelta(days=bank_grace_days(bname))) if parse_date(end_date) else None),
                a_status,
                "Ù„Ø§",
                "",
                "",
                str(delivery_status or ""),
                str(recipient_name or ""),
                str(notes or ""),
                str(entry_number or ""),
            ]
            for c_idx, val in enumerate(vals):
                if c_idx >= t_top.columnCount():
                    try:
                        _log(f"bank_detailed_active: skip col {c_idx} > columns {t_top.columnCount()}")
                    except Exception:
                        pass
                    continue
                it = QtWidgets.QTableWidgetItem(str(val))
                it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                if c_idx in (4, 5, 6):
                    it.setTextAlignment(QtCore.Qt.AlignCenter)
                else:
                    it.setTextAlignment(self._align | QtCore.Qt.AlignVCenter)
                if c_idx == 2:
                    try:
                        if attachment_count == 0:
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#c62828")))
                        elif (user_status or "").strip() == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#6a1b9a")))
                    except Exception as e:
                        try:
                            _log(f"bank_detailed_active: color set failed for g_no {g_no}: {e}")
                        except Exception:
                            pass
                if c_idx == 13:
                    try:
                        if a_status == "Ø³Ø§Ø±ÙŠ":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#2e7d32")))
                        elif a_status == "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#f9a825")))
                        elif a_status == "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#c62828")))
                        elif a_status == "Ù…Ù†ØªÙ‡ÙŠ":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#9e9e9e")))
                    except Exception as e:
                        try:
                            _log(f"bank_detailed_active: status color failed {e}")
                        except Exception:
                            pass
                t_top.setItem(rpos, c_idx, it)
            try:
                if 16 < t_top.columnCount():
                    t_top.setItem(rpos, 16, QtWidgets.QTableWidgetItem(str(attachment_count)))
            except Exception as e:
                try:
                    _log(f"bank_detailed_active: set attachment_count col failed: {e}")
                except Exception:
                    pass

        try:
            self._sync_bank_detailed_active_columns_to_main()
        except Exception:
            pass

        dept_totals_final = {}
        dept_totals_financial = {}
        dept_totals_initial = {}
        dept_totals_cash = {}
        all_matching_depts = set()
        
        for r in rows:
            try:
                department, bank_raw, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, _attachment = r[:15]
            except Exception:
                department, bank_raw, g_no, g_type, amount, end_date, user_status, cash_flag = None, None, None, None, 0.0, None, None, 0
            bname = normalize_bank(bank_raw or "", str(g_no or ""))
            if (selected_bank != "Ø§Ù„ÙƒÙ„") and (bname != selected_bank):
                continue
            _us = (user_status or "").strip()
            a_status = auto_status_for_row(end_date, bname, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us:
                a_status = _us
            try:
                amt = float(amount or 0.0)
            except Exception:
                amt = 0.0
            is_cash = False
            try:
                is_cash = bool(int(cash_flag or 0))
            except Exception:
                is_cash = False

            if is_cash:
                if a_status in allowed_statuses:
                    key = str(department or "")
                    all_matching_depts.add(key)
                    dept_totals_cash[key] = dept_totals_cash.get(key, 0.0) + amt
                continue

            if (a_status in allowed_statuses) or (a_status == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"):
                key = str(department or "")
                all_matching_depts.add(key)
                gt = (g_type or "").strip()
                gt_norm = gt.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
                if ("Ù†Ù‡Ø§Ø¦ÙŠ" in gt_norm) or ("Ù†Ù‡Ø§Ø¦Ù‰" in gt_norm) or ("Ø­Ø³Ù† ØªÙ†ÙÙŠØ°" in gt_norm) or ("Ø­Ø³Ù† Ø§Ù„ØªÙ†ÙÙŠØ°" in gt_norm):
                    dept_totals_final[key] = dept_totals_final.get(key, 0.0) + amt
                elif ("Ù…Ø§Ù„ÙŠ" in gt_norm) or ("Ø§Ù„Ù…Ø§Ù„ÙŠØ©" in gt_norm) or ("Ù…Ø§Ù„Ù‰" in gt_norm):
                    dept_totals_financial[key] = dept_totals_financial.get(key, 0.0) + amt
                elif ("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" in gt_norm) or ("Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰" in gt_norm) or ("Ù…Ø¨Ø¯Ø¦ÙŠ" in gt_norm) or ("Ù…Ø¨Ø¯Ø¦Ù‰" in gt_norm):
                    dept_totals_initial[key] = dept_totals_initial.get(key, 0.0) + amt

        all_depts = all_matching_depts
        rows_out = []
        for d in sorted(all_depts):
            fsum_final = float(dept_totals_final.get(d, 0.0))
            fsum_financial = float(dept_totals_financial.get(d, 0.0))
            isum_initial = float(dept_totals_initial.get(d, 0.0))
            tsum = fsum_final + fsum_financial + isum_initial
            csum = float(dept_totals_cash.get(d, 0.0))
            rows_out.append((d, fsum_final, fsum_financial, isum_initial, tsum, csum))

        t_bot = self.bank_detailed_dept_table
        t_bot.setRowCount(len(rows_out))
        for r_idx, (d, fsum_final, fsum_financial, isum_initial, tsum, csum) in enumerate(rows_out):
            vals = [d, f"{fsum_final:,.2f}", f"{fsum_financial:,.2f}", f"{isum_initial:,.2f}", f"{tsum:,.2f}", f"{csum:,.2f}"]
            for c_idx, val in enumerate(vals):
                it = QtWidgets.QTableWidgetItem(str(val))
                it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                it.setTextAlignment(QtCore.Qt.AlignCenter)
                t_bot.setItem(r_idx, c_idx, it)

        if rows_out:
            grand_final = sum(v for v in dept_totals_final.values())
            grand_financial = sum(v for v in dept_totals_financial.values())
            grand_initial = sum(v for v in dept_totals_initial.values())
            grand_cash = sum(v for v in dept_totals_cash.values())
            grand_total = grand_final + grand_financial + grand_initial

            rpos = t_bot.rowCount()
            t_bot.insertRow(rpos)
            it_name = QtWidgets.QTableWidgetItem("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ")
            it_name.setFlags(it_name.flags() ^ QtCore.Qt.ItemIsEditable)
            it_name.setTextAlignment(QtCore.Qt.AlignCenter)
            try:
                fnt = it_name.font(); fnt.setBold(True); it_name.setFont(fnt)
            except Exception:
                pass
            t_bot.setItem(rpos, 0, it_name)

            totals_vals = [f"{grand_final:,.2f}", f"{grand_financial:,.2f}", f"{grand_initial:,.2f}", f"{grand_total:,.2f}", f"{grand_cash:,.2f}"]
            for ofs, val in enumerate(totals_vals, start=1):
                it = QtWidgets.QTableWidgetItem(str(val))
                it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                it.setTextAlignment(QtCore.Qt.AlignCenter)
                try:
                    fnt = it.font(); fnt.setBold(True); it.setFont(fnt)
                except Exception:
                    pass
                t_bot.setItem(rpos, ofs, it)

    def _show_update_limits_dialog(self):
        """ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø­ÙˆØ§Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ"""
        try:
            dlg = BankLimitsDialog(self)
            dlg.exec_()
        except Exception as e:
            try:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: {str(e)}")
            except Exception:
                pass

    def _populate_bank_limits_tab(self):
        """Ù…Ù„Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            rows = self._iter_all_rows()
        except Exception:
            rows = []
        
        from datetime import date as _date
        today = _date.today()
        
        # Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ
        bank_data = {}
        allowed_statuses = ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„")
        
        for r in rows:
            try:
                _department, bank_raw, g_no, _g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, _attachment = r[:15]
            except Exception:
                _department, bank_raw, g_no, _g_type, amount, end_date, user_status, cash_flag = None, None, None, None, 0.0, None, None, 0
            
            bname = normalize_bank(bank_raw or "", str(g_no or ""))
            if not bname:
                continue
            
            if bname not in bank_data:
                bank_data[bname] = {
                    "existing": 0.0,
                    "unregistered": 0.0
                }
            
            try:
                amt = float(amount or 0.0)
            except Exception:
                amt = 0.0
            
            _us = (user_status or "").strip()
            a_status = auto_status_for_row(end_date, bname, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                a_status = "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"
            elif _us:
                a_status = _us
            
            try:
                is_cash = bool(int(cash_flag or 0))
            except Exception:
                is_cash = False
            
            if is_cash:
                continue # Ignore cash guarantees in limits tab

            if a_status in allowed_statuses:
                if _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                    bank_data[bname]["unregistered"] += amt
                else:
                    bank_data[bname]["existing"] += amt
        
        # Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        try:
            conn = connect_db()
            c = conn.cursor()
            limits_data = {}
            for row in c.execute("SELECT bank_name, limit_amount FROM bank_limits").fetchall():
                limits_data[row[0]] = float(row[1] or 0.0)
            conn.close()
        except Exception:
            limits_data = {}
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶
        table_data = []
        for bank_name in sorted(bank_data.keys()):
            data = bank_data[bank_name]
            limit = limits_data.get(bank_name, 0.0)
            existing = data["existing"]
            unregistered = data["unregistered"]
            total = existing + unregistered
            remaining = max(0.0, limit - total)
            usage_pct = (total / limit * 100.0) if limit > 0 else 0.0
            
            table_data.append({
                "bank": bank_name,
                "limit": limit,
                "existing": existing,
                "unregistered": unregistered,
                "total": total,
                "remaining": remaining,
                "usage_pct": usage_pct
            })
        
        # Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        t = self.bank_limits_table
        t.setRowCount(len(table_data))
        
        def fmt_money(x):
            try:
                return f"{float(x):,.2f}"
            except Exception:
                return "0.00"
        
        def fmt_pct(x):
            try:
                return f"{float(x):,.1f}%"
            except Exception:
                return "0.0%"
        
        for r_idx, data in enumerate(table_data):
            # Ø§Ù„Ø¨Ù†Ùƒ
            it_bank = QtWidgets.QTableWidgetItem(str(data["bank"]))
            it_bank.setFlags(it_bank.flags() ^ QtCore.Qt.ItemIsEditable)
            it_bank.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 0, it_bank)
            
            # Ø§Ù„Ø­Ø¯
            it_limit = QtWidgets.QTableWidgetItem(fmt_money(data["limit"]))
            it_limit.setFlags(it_limit.flags() ^ QtCore.Qt.ItemIsEditable)
            it_limit.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 1, it_limit)
            
            # Ø¶Ù…Ø§Ù†Ø§Øª Ù‚Ø§Ø¦Ù…Ø©
            it_existing = QtWidgets.QTableWidgetItem(fmt_money(data["existing"]))
            it_existing.setFlags(it_existing.flags() ^ QtCore.Qt.ItemIsEditable)
            it_existing.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 2, it_existing)
            
            # Ø¶Ù…Ø§Ù†Ø§Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©
            it_unreg = QtWidgets.QTableWidgetItem(fmt_money(data["unregistered"]))
            it_unreg.setFlags(it_unreg.flags() ^ QtCore.Qt.ItemIsEditable)
            it_unreg.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 3, it_unreg)
            
            # Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª
            it_total = QtWidgets.QTableWidgetItem(fmt_money(data["total"]))
            it_total.setFlags(it_total.flags() ^ QtCore.Qt.ItemIsEditable)
            it_total.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 4, it_total)
            
            # Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            it_remaining = QtWidgets.QTableWidgetItem(fmt_money(data["remaining"]))
            it_remaining.setFlags(it_remaining.flags() ^ QtCore.Qt.ItemIsEditable)
            it_remaining.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 5, it_remaining)
            
            # Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            it_usage = QtWidgets.QTableWidgetItem(fmt_pct(data["usage_pct"]))
            it_usage.setFlags(it_usage.flags() ^ QtCore.Qt.ItemIsEditable)
            it_usage.setTextAlignment(QtCore.Qt.AlignCenter | QtCore.Qt.AlignVCenter)
            t.setItem(r_idx, 6, it_usage)
            
            # ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            usage = data["usage_pct"]
            try:
                if usage >= 90.0:
                    # Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù„ÙŠ (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©)
                    bg_color = QtGui.QColor("#8B0000")  # Dark red
                    fg_color = QtGui.QColor("#FFFFFF")  # White text
                elif usage >= 75.0:
                    # Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·-Ø§Ù„Ø¹Ø§Ù„ÙŠ (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©)
                    bg_color = QtGui.QColor("#FF8C00")  # Dark orange
                    fg_color = QtGui.QColor("#FFFFFF")  # White text
                else:
                    # Ø£Ø®Ø¶Ø± Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†Ø®ÙØ¶ (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©)
                    bg_color = QtGui.QColor("#2E7D32")  # Green
                    fg_color = QtGui.QColor("#FFFFFF")  # White text
                
                for col in range(7):
                    item = t.item(r_idx, col)
                    if item:
                        item.setBackground(QtGui.QBrush(bg_color))
                        item.setForeground(QtGui.QBrush(fg_color))
            except Exception:
                pass

    def _build_dept_matrix_tab(self):
        w = QtWidgets.QWidget(self)
        v = QtWidgets.QVBoxLayout(w)
        # Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ ÙˆØ²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        fl = QtWidgets.QHBoxLayout()
        lbl_b = QtWidgets.QLabel("Ø§Ù„Ø¨Ù†Ùƒ:")
        self.dept_matrix_bank_filter = QtWidgets.QComboBox()
        try:
            self.dept_matrix_bank_filter.clear()
        except Exception:
            pass
        self.dept_matrix_bank_filter.addItem("Ø§Ù„ÙƒÙ„")
        fl.addWidget(lbl_b)
        fl.addWidget(self.dept_matrix_bank_filter)
        self.dept_matrix_totals_only_chk = QtWidgets.QCheckBox("Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙ‚Ø·")
        fl.addWidget(self.dept_matrix_totals_only_chk)
        fl.addStretch(1)
        # Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        btn_print = QtWidgets.QPushButton("Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©â€¦")
        btn_print.setToolTip("Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
        try:
            btn_print.clicked.connect(self.preview)
        except Exception:
            pass
        fl.addWidget(btn_print)
        v.addLayout(fl)
        self.dept_matrix_table = QtWidgets.QTableWidget(w)
        try:
            self.dept_matrix_table.setAlternatingRowColors(True)
            self.dept_matrix_table.verticalHeader().setVisible(True)
            self.dept_matrix_table.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
            self.dept_matrix_table.setSelectionMode(QtWidgets.QAbstractItemView.NoSelection)
            # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
            try:
                self.dept_matrix_table.setWordWrap(False)
            except Exception:
                pass
            try:
                self.dept_matrix_table.setTextElideMode(QtCore.Qt.ElideNone)
            except Exception:
                pass
            # Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ
            try:
                self.dept_matrix_table.setHorizontalScrollBarPolicy(QtCore.Qt.ScrollBarAsNeeded)
                self.dept_matrix_table.setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarAsNeeded)
            except Exception:
                pass
        except Exception:
            pass
        v.addWidget(self.dept_matrix_table)
        try:
            # Ø±Ø¨Ø· ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            self.dept_matrix_bank_filter.currentIndexChanged.connect(lambda _=None: self._populate_dept_matrix_tab())
            self.dept_matrix_totals_only_chk.toggled.connect(lambda _=None: self._populate_dept_matrix_tab())
        except Exception:
            pass
        try:
            self._populate_dept_matrix_tab()
        except Exception:
            pass
        return w

    def _populate_dept_matrix_tab(self):
        try:
            rows = self._iter_all_rows()
        except Exception:
            rows = []
        depts_set = set(); banks_set = set()
        for r in rows:
            try:
                depts_set.add(str(r[0] or ""))
                banks_set.add(normalize_bank(r[1] or "", str(r[2] or "")))
            except Exception:
                pass
        # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙÙŠ Ø§Ù„ÙÙ„ØªØ±
        try:
            current_bank = self.dept_matrix_bank_filter.currentText()
        except Exception:
            current_bank = "Ø§Ù„ÙƒÙ„"
        try:
            self.dept_matrix_bank_filter.blockSignals(True)
            self.dept_matrix_bank_filter.clear()
            self.dept_matrix_bank_filter.addItem("Ø§Ù„ÙƒÙ„")
            for b in sorted(banks_set):
                if b:
                    self.dept_matrix_bank_filter.addItem(b)
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            index = self.dept_matrix_bank_filter.findText(current_bank)
            if index >= 0:
                self.dept_matrix_bank_filter.setCurrentIndex(index)
            else:
                self.dept_matrix_bank_filter.setCurrentIndex(0)
            self.dept_matrix_bank_filter.blockSignals(False)
        except Exception:
            try:
                self.dept_matrix_bank_filter.blockSignals(False)
            except Exception:
                pass
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
        try:
            sel_bank = self.dept_matrix_bank_filter.currentText()
        except Exception:
            sel_bank = "Ø§Ù„ÙƒÙ„"
        depts = sorted([d for d in depts_set if d])
        # ØªØµÙÙŠØ© Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        if sel_bank and sel_bank != "Ø§Ù„ÙƒÙ„":
            banks = [sel_bank] if sel_bank in banks_set else []
        else:
            banks = sorted([b for b in banks_set if b])
        t = self.dept_matrix_table
        # Ø®Ø²Ù‘Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù…ØµÙÙˆÙØ©) ÙƒÙŠ Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±
        try:
            self._dept_matrix_visible_banks = []
            self._dept_matrix_bank_spans = []
            self._dept_matrix_cols_per_bank = 0
            self._dept_matrix_total_col_index = None
        except Exception:
            pass
        # Ø§Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ ÙˆØ¯Ù…Ø¬ Ø®Ù„Ø§ÙŠØ§ Ø³Ø§Ø¨Ù‚ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¨Ù‚Ø§Ø¡ Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†ÙˆÙƒ Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±
        try:
            t.clearContents()
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„ØªÙØ±ÙŠØº Ø£ÙŠ span Ø³Ø§Ø¨Ù‚
            t.setRowCount(0)
            t.setColumnCount(0)
        except Exception:
            pass
        single_bank = (len(banks) == 1)
        try:
            totals_only = bool(self.dept_matrix_totals_only_chk.isChecked())
        except Exception:
            totals_only = False
        cols_per_bank = 1 if totals_only else (3 if single_bank else 4)
        headers_cnt = 1 + len(banks) * cols_per_bank + 1
        t.setColumnCount(headers_cnt)
        try:
            self._dept_matrix_visible_banks = list(banks)
            self._dept_matrix_cols_per_bank = cols_per_bank
            spans = []
            cpos = 1
            for b in banks:
                span_end = cpos + cols_per_bank - 1
                spans.append((b, cpos, span_end))
                cpos = span_end + 1
            self._dept_matrix_bank_spans = spans
            self._dept_matrix_total_col_index = headers_cnt - 1
        except Exception:
            pass
        # Ù†Ø¬Ø¹Ù„ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙØ§Ø±ØºØ© Ù„Ø£Ù†Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¶Ù…Ø§Ù† ÙƒØµÙ Ø«Ø§Ù†Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        bank_cols_header = [""] * (len(banks) * cols_per_bank)
        headers = ["Ø§Ù„Ù‚Ø³Ù…"] + bank_cols_header + ["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] 
        t.setHorizontalHeaderLabels(headers)
        # Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙ…Ø¯Ø¯ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø¹Ø±Ø¶
        try:
            # Ø§Ø³ØªØ®Ø¯Ù… ResizeToContents Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø­ØªÙ‰ ÙŠØ£Ø®Ø° ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªÙŠ ÙŠØ­ØªØ§Ø¬Ù‡Ø§
            t.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.ResizeToContents)
            # Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Interactive Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹
            # t.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Interactive)
        except Exception:
            pass
        # +2 ØµÙÙˆÙ: Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø«Ù… Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª ØªØ­ØªÙ‡Ø§
        has_banks = bool(banks)
        t.setRowCount((2 if has_banks else 0) + len(depts) + (1 if depts else 0))
        from datetime import date as _date
        today = _date.today()
        allowed_statuses = ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„")
        data = {}
        for r in rows:
            try:
                d, bank_raw, g_no, g_type, amount = r[0], r[1], r[2], r[3], r[4]
            except Exception:
                d, bank_raw, g_no, g_type, amount = None, None, None, None, 0.0
            dname = str(d or ""); bname = normalize_bank(bank_raw or "", str(g_no or ""))
            # ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ
            if sel_bank and sel_bank != "Ø§Ù„ÙƒÙ„" and bname != sel_bank:
                continue
            # ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
            try:
                end_date = r[11]
                user_status = r[12]
                cash_flag = r[13]
            except Exception:
                end_date = None; user_status = None; cash_flag = 0
            a_status = auto_status_for_row(end_date, bname, today)
            _us = (user_status or "").strip()
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us:
                a_status = _us
            try:
                is_cash = bool(int(cash_flag or 0))
            except Exception:
                is_cash = False
            if is_cash or not (a_status in allowed_statuses):
                continue
            try:
                amt = float(amount or 0.0)
            except Exception:
                try:
                    amt = float(str(amount).replace(',', ''))
                except Exception:
                    amt = 0.0
            gt = (g_type or "").strip()
            gt = gt.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
            key = (dname, bname)
            if key not in data:
                data[key] = {"initial": 0.0, "final": 0.0, "financial": 0.0}
            if ("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" in gt) or ("Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰" in gt) or ("Ù…Ø¨Ø¯Ø¦ÙŠ" in gt) or ("Ù…Ø¨Ø¯Ø¦Ù‰" in gt):
                data[key]["initial"] += amt
            elif ("Ù†Ù‡Ø§Ø¦ÙŠ" in gt) or ("Ù†Ù‡Ø§Ø¦Ù‰" in gt):
                data[key]["final"] += amt
            elif ("Ù…Ø§Ù„ÙŠ" in gt) or ("Ø§Ù„Ù…Ø§Ù„ÙŠØ©" in gt) or ("Ù…Ø§Ù„Ù‰" in gt):
                data[key]["financial"] += amt
        def fmt_money(x):
            try:
                return f"{float(x):,.2f}"
            except Exception:
                try:
                    return f"{float(str(x).replace(',', '')):,.2f}"
                except Exception:
                    return str(x)
        # Ø§ÙƒØªØ¨ ØµÙ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙÙŠ Ø§Ù„ØµÙ 0 Ù…Ø¹ Ø¯Ù…Ø¬ ÙƒÙ„ Ø£Ø±Ø¨Ø¹Ø© Ø£Ø¹Ù…Ø¯Ø© ØªØ­Øª ÙƒÙ„ Ø¨Ù†Ùƒ
        if has_banks:
            # Ø®Ù„ÙŠØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙØ§Ø±ØºØ©
            it_blank = QtWidgets.QTableWidgetItem("")
            it_blank.setFlags(it_blank.flags() ^ QtCore.Qt.ItemIsEditable)
            it_blank.setTextAlignment(QtCore.Qt.AlignCenter)
            t.setItem(0, 0, it_blank)
            cpos = 1
            for b in banks:
                itb = QtWidgets.QTableWidgetItem(str(b))
                itb.setFlags(itb.flags() ^ QtCore.Qt.ItemIsEditable)
                itb.setTextAlignment(QtCore.Qt.AlignCenter)
                t.setItem(0, cpos, itb)
                try:
                    t.setSpan(0, cpos, 1, cols_per_bank)
                except Exception:
                    pass
                cpos += cols_per_bank
            # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± Ø¹Ù†ÙˆØ§Ù†Ù‡ ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©ØŒ Ù†ØªØ±Ùƒ Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù‡
            # Ø§Ù„ØµÙ 1: Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª ØªØ­Øª ÙƒÙ„ Ø¨Ù†Ùƒ
            it_blank2 = QtWidgets.QTableWidgetItem("")
            it_blank2.setFlags(it_blank2.flags() ^ QtCore.Qt.ItemIsEditable)
            it_blank2.setTextAlignment(QtCore.Qt.AlignCenter)
            t.setItem(1, 0, it_blank2)
            cpos = 1
            for _b in banks:
                subs = ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ",) if totals_only else (("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦ÙŠ", "Ù…Ø§Ù„ÙŠ") if single_bank else ("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦ÙŠ", "Ù…Ø§Ù„ÙŠ", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ"))
                for sub in subs:
                    its = QtWidgets.QTableWidgetItem(sub)
                    its.setFlags(its.flags() ^ QtCore.Qt.ItemIsEditable)
                    its.setTextAlignment(QtCore.Qt.AlignCenter)
                    t.setItem(1, cpos, its)
                    cpos += 1
            # Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£Ø¶Ù Ø¹Ù†ÙˆØ§Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            it_tot_lbl = QtWidgets.QTableWidgetItem("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ")
            it_tot_lbl.setFlags(it_tot_lbl.flags() ^ QtCore.Qt.ItemIsEditable)
            it_tot_lbl.setTextAlignment(QtCore.Qt.AlignCenter)
            t.setItem(1, headers_cnt - 1, it_tot_lbl)
        totals_by_bank = {b: {"initial": 0.0, "final": 0.0, "financial": 0.0, "total": 0.0} for b in banks}
        grand_total = 0.0
        for r_idx, d in enumerate(depts):
            itd = QtWidgets.QTableWidgetItem(str(d))
            itd.setFlags(itd.flags() ^ QtCore.Qt.ItemIsEditable)
            itd.setTextAlignment(getattr(self, "_align", QtCore.Qt.AlignCenter) | QtCore.Qt.AlignVCenter)
            t.setItem(2 + r_idx, 0, itd)
            cpos = 1
            row_total = 0.0
            for b in banks:
                sums = data.get((d, b), {"initial": 0.0, "final": 0.0, "financial": 0.0})
                iv = float(sums.get("initial", 0.0))
                fv = float(sums.get("final", 0.0))
                mv = float(sums.get("financial", 0.0))
                tv = iv + fv + mv
                totals_by_bank[b]["initial"] += iv
                totals_by_bank[b]["final"] += fv
                totals_by_bank[b]["financial"] += mv
                totals_by_bank[b]["total"] += tv
                row_total += tv
                vals_to_add = (tv,) if totals_only else ((iv, fv, mv) if single_bank else (iv, fv, mv, tv))
                for val in vals_to_add:
                    it = QtWidgets.QTableWidgetItem(fmt_money(val))
                    it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                    it.setTextAlignment(QtCore.Qt.AlignCenter)
                    try:
                        if _num_font is not None:
                            it.setFont(_num_font)
                    except Exception:
                        pass
                    t.setItem(2 + r_idx, cpos, it)
                    cpos += 1
            # Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£Ø¶Ù Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… Ù„ÙƒÙ„ ØµÙ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            it_row_tot = QtWidgets.QTableWidgetItem(fmt_money(row_total))
            it_row_tot.setFlags(it_row_tot.flags() ^ QtCore.Qt.ItemIsEditable)
            it_row_tot.setTextAlignment(QtCore.Qt.AlignCenter)
            try:
                if _num_font is not None:
                    it_row_tot.setFont(_num_font)
            except Exception:
                pass
            t.setItem(2 + r_idx, headers_cnt - 1, it_row_tot)
            grand_total += row_total
        if depts:
            rpos = 2 + len(depts)
            itlbl = QtWidgets.QTableWidgetItem("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ")
            itlbl.setFlags(itlbl.flags() ^ QtCore.Qt.ItemIsEditable)
            itlbl.setTextAlignment(QtCore.Qt.AlignCenter)
            t.setItem(rpos, 0, itlbl)
            cpos = 1
            for b in banks:
                vals = totals_by_bank[b]
                keys_to_add = ("total",) if totals_only else (("initial", "final", "financial") if single_bank else ("initial", "final", "financial", "total"))
                for key in keys_to_add:
                    it = QtWidgets.QTableWidgetItem(fmt_money(vals[key]))
                    it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                    it.setTextAlignment(QtCore.Qt.AlignCenter)
                    try:
                        if _num_font is not None:
                            it.setFont(_num_font)
                    except Exception:
                        pass
                    t.setItem(rpos, cpos, it)
                    cpos += 1
            # Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£Ø¶Ù Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ ÙÙŠ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            itg = QtWidgets.QTableWidgetItem(fmt_money(grand_total))
            itg.setFlags(itg.flags() ^ QtCore.Qt.ItemIsEditable)
            itg.setTextAlignment(QtCore.Qt.AlignCenter)
            try:
                _num_font = QtGui.QFont()
                _num_font.setFamily("Consolas")
                _num_font.setPointSize(9)
                if _num_font is not None:
                    itg.setFont(_num_font)
            except Exception:
                pass
            t.setItem(rpos, headers_cnt - 1, itg)
        # ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ù…Ø¬ Ø®Ù„Ø§ÙŠØ§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±Ø£Ø³ Ù…Ø®ØµÙ‘Øµ
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
        try:
            # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
            t.setWordWrap(False)
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
            t.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.ResizeToContents)
            # Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            for col in range(t.columnCount()):
                t.horizontalHeader().setMinimumSectionSize(60)
            # Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø­ØªÙ‰ Ù„Ùˆ ØªØ¬Ø§ÙˆØ² Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
            t.setSizeAdjustPolicy(QtWidgets.QAbstractScrollArea.AdjustToContents)
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ delegate ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙØ§Ù
            if hasattr(t, 'itemDelegate'):
                delegate = t.itemDelegate()
                if delegate and isinstance(delegate, (WrapTextDelegate, MultiLineEditDelegate)):
                    # Ø¥Ø²Ø§Ù„Ø© delegate Ø§Ù„ØªÙØ§Ù Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    t.setItemDelegate(None)
        except Exception:
            pass

    def _normalize_header_name(self, s):
        try:
            s = str(s or "").strip()
            # Ø·Ø¨Ù‘Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            s = s.replace("Ù‰", "ÙŠ").replace("Ø£", "Ø§").replace("Ø¥", "Ø§").replace("Ø¢", "Ø§")
            return s
        except Exception:
            return str(s)

    def _sync_bank_detailed_active_columns_to_main(self):
        # Ù…Ø²Ø§Ù…Ù†Ø© ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ "Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ù†Ùƒ" Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        tbl_main = getattr(self, 'table', None)
        tbl_bank = getattr(self, 'bank_detailed_active_table', None)
        if tbl_main is None or tbl_bank is None:
            return
        try:
            # Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ
            main_names = [self._normalize_header_name(tbl_main.horizontalHeaderItem(i).text()) for i in range(tbl_main.columnCount())]
            # Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¹Ù…Ø¯Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†Ùƒ
            bank_names = [self._normalize_header_name(tbl_bank.horizontalHeaderItem(i).text()) for i in range(tbl_bank.columnCount())]
            bank_map = {nm: idx for idx, nm in enumerate(bank_names)}

            # Ø±ØªÙ‘Ø¨ Ø£Ø¹Ù…Ø¯Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù„Ù„Ø§Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ÙÙ‚Ø·)
            order_indices = [bank_map[nm] for nm in main_names if nm in bank_map]
            hdr = tbl_bank.horizontalHeader()
            try:
                hdr.setSectionsMovable(True)
            except Exception:
                pass
            for new_pos, logical_idx in enumerate(order_indices):
                try:
                    cur_vis = hdr.visualIndex(logical_idx)
                    if cur_vis != new_pos:
                        hdr.moveSection(cur_vis, new_pos)
                except Exception:
                    pass

            # Ø£Ø®ÙÙ/Ø£Ø¸Ù‡Ø± Ø£Ø¹Ù…Ø¯Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            for nm, b_idx in bank_map.items():
                try:
                    if nm in main_names:
                        m_idx = main_names.index(nm)
                        tbl_bank.setColumnHidden(b_idx, tbl_main.isColumnHidden(m_idx))
                    else:
                        # ÙÙŠ Ø­Ø§Ù„ Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ù†Ùƒ ÙˆÙ„ÙŠØ³ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŒ Ø§Ø¬Ø¹Ù„Ù‡ Ù…Ø®ÙÙŠÙ‹Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
                        tbl_bank.setColumnHidden(b_idx, True)
                except Exception:
                    pass

            try:
                if "ID" in bank_map:
                    tbl_bank.setColumnHidden(bank_map["ID"], True)
            except Exception:
                pass
        except Exception:
            pass

    # ==============================
    # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (KPIs)
    # ==============================
    def _build_kpis_tab(self):
        w = QtWidgets.QWidget(self)
        v = QtWidgets.QVBoxLayout(w)

        # --- ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ---
        filter_row = QtWidgets.QHBoxLayout()
        try:
            lbl = QtWidgets.QLabel("ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ù†Ùƒ:")
            self.kpi_bank_filter = QtWidgets.QComboBox()
            try:
                self.kpi_bank_filter.setEditable(False)
            except Exception:
                pass
            # Ø§Ø¨Ø¯Ø£ Ø¨Ù€ "Ø§Ù„ÙƒÙ„"ØŒ Ø«Ù… ØªÙØ­Ø¯Ù‘ÙØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            try:
                self.kpi_bank_filter.clear(); self.kpi_bank_filter.addItem("Ø§Ù„ÙƒÙ„")
            except Exception:
                pass
            filter_row.addWidget(lbl)
            filter_row.addWidget(self.kpi_bank_filter)
            filter_row.addStretch(1)
            v.addLayout(filter_row)
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±
            try:
                self.kpi_bank_filter.currentIndexChanged.connect(lambda _=None: self._populate_kpis_tab())
            except Exception:
                pass
        except Exception:
            # ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ±ØŒ Ù†Ø³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø©
            self.kpi_bank_filter = None

        # --- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ ---
        bank_group = QtWidgets.QGroupBox("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ")
        # Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        try:
            self.kpi_bank_group = bank_group
        except Exception:
            pass
        bank_v = QtWidgets.QVBoxLayout(bank_group)
        self.kpi_bank_table = QtWidgets.QTableWidget(bank_group)
        self.kpi_bank_table.setColumnCount(3)
        self.kpi_bank_table.setHorizontalHeaderLabels(["Ø§Ù„Ø¨Ù†Ùƒ", "Ø¹Ø¯Ø¯", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©"])
        try:
            self.kpi_bank_table.setAlternatingRowColors(True)
        except Exception:
            pass
        self.kpi_bank_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        bank_v.addWidget(self.kpi_bank_table)
        # ÙØªØ­ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ Ø¨Ù†Ùƒ
        try:
            self.kpi_bank_table.cellDoubleClicked.connect(self._drilldown_bank_clicked)
        except Exception:
            pass
        v.addWidget(bank_group)

        # --- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ---
        dept_group = QtWidgets.QGroupBox("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
        # Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        try:
            self.kpi_dept_group = dept_group
        except Exception:
            pass
        dept_v = QtWidgets.QVBoxLayout(dept_group)
        self.kpi_dept_table = QtWidgets.QTableWidget(dept_group)
        self.kpi_dept_table.setColumnCount(3)
        self.kpi_dept_table.setHorizontalHeaderLabels(["Ø§Ù„Ù‚Ø³Ù…", "Ø¹Ø¯Ø¯", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©"])
        try:
            self.kpi_dept_table.setAlternatingRowColors(True)
        except Exception:
            pass
        self.kpi_dept_table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        dept_v.addWidget(self.kpi_dept_table)
        # ÙØªØ­ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ Ù‚Ø³Ù…
        try:
            self.kpi_dept_table.cellDoubleClicked.connect(self._drilldown_dept_clicked)
        except Exception:
            pass
        v.addWidget(dept_group)

        # Ù€ ØªÙ… Ø­Ø°Ù Ù‚Ø³Ù… "ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¨Ù†Ùƒ" Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù€

        btn_row = QtWidgets.QHBoxLayout()
        btn_export = QtWidgets.QPushButton("ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„")
        btn_preview = QtWidgets.QPushButton("Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©â€¦")
        btn_row.addStretch(1)
        btn_row.addWidget(btn_export)
        btn_row.addWidget(btn_preview)
        v.addLayout(btn_row)
        btn_export.clicked.connect(lambda: self._export_kpi_summary_to_excel())
        btn_preview.clicked.connect(lambda: self.preview())

        try:
            self._populate_kpis_tab()
        except Exception:
            pass
        return w

    def _drilldown_bank_clicked(self, row: int, col: int):
        try:
            name_item = self.kpi_bank_table.item(row, 0)
            bank_name = name_item.text().strip() if name_item else ""
            if bank_name:
                self._open_drilldown_report(kind="bank", name=bank_name)
        except Exception:
            pass

    def _drilldown_dept_clicked(self, row: int, col: int):
        try:
            name_item = self.kpi_dept_table.item(row, 0)
            dept_name = name_item.text().strip() if name_item else ""
            if dept_name:
                self._open_drilldown_report(kind="dept", name=dept_name)
        except Exception:
            pass

    def _open_drilldown_report(self, kind: str, name: str):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù…Ø¤Ù‚Øª Ø¨ÙƒÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¨Ù†Ùƒ/Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆÙØªØ­ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©."""
        # Ø¬Ù‡Ù‘Ø² Ø¬Ø¯ÙˆÙ„Ù‹Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¨Ù†ÙØ³ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        try:
            cols = self.table.columnCount()
        except Exception:
            cols = 21
        tbl = QtWidgets.QTableWidget()
        tbl.setColumnCount(cols)
        # Ø§Ù†Ø³Ø® Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ù† ØªÙˆÙÙ‘Ø±Øª
        headers = []
        try:
            headers = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
        except Exception:
            headers = ["Ø§Ù„Ù‚Ø³Ù…","Ø§Ù„Ø¨Ù†Ùƒ","Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†","Ø§Ù„Ù†ÙˆØ¹","Ø§Ù„Ù‚ÙŠÙ…Ø©","Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†","%","Ø§Ù„Ø¬Ù‡Ø©","Ø§Ù„Ø·Ø§Ù„Ø¨Ø©","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡","Ø§Ù†ØªÙ‡Ø§Ø¡ + Ù…Ù‡Ù„Ø©","Ø§Ù„Ø­Ø§Ù„Ø©","Ù†Ù‚Ø¯ÙŠ","","","Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…","Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯"]
            headers = headers[:cols]
        try:
            tbl.setHorizontalHeaderLabels(headers)
        except Exception:
            pass
        try:
            tbl.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        except Exception:
            pass

        # Ø§Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        try:
            rows = self._iter_all_rows()
        except Exception:
            rows = []
        from datetime import date, timedelta
        today = date.today()

        def _row_matches(row):
            try:
                department, bank, g_no = row[0], row[1], row[2]
            except Exception:
                department, bank, g_no = "", "", ""
            # ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆÙØ¬Ø¯)
            try:
                selected_bank = (self.kpi_bank_filter.currentText().strip() if self.kpi_bank_filter is not None else "Ø§Ù„ÙƒÙ„")
            except Exception:
                selected_bank = "Ø§Ù„ÙƒÙ„"
            if kind == "bank":
                return normalize_bank(bank or "", str(g_no or "")) == name
            else:
                matches_dept = (department or "").strip() == name
                if selected_bank == "Ø§Ù„ÙƒÙ„":
                    return matches_dept
                return matches_dept and normalize_bank(bank or "", str(g_no or "")) == selected_bank

        for r in rows:
            if not _row_matches(r):
                continue
            try:
                department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, _attachment, delivery_status, recipient_name, notes, entry_number = (
                    r[0], r[1], r[2], r[3], r[4], r[5], r[6], r[7], r[8], r[9], r[10], r[11], r[12], r[13], r[14], r[15], r[16], r[17], r[18]
                )
            except Exception:
                department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, delivery_status, recipient_name, notes, entry_number = ("","","","",0.0,0.0,0.0,"","","",None,None,"",0,"","","","")
            bname = normalize_bank(bank or "", str(g_no or ""))
            _us = (user_status or "").strip()
            _auto = auto_status_for_row(end_date, bname, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                a_status = _auto
            else:
                a_status = _us or _auto
            vals = [
                department, bname, str(g_no), g_type,
                f"{(amount or 0):,.2f}", f"{(insurance_amount or 0):,.2f}", f"{float(percent or 0):.0f}%",
                beneficiary, requester, project_name,
                format_date_for_view(issue_date), format_date_for_view(end_date), format_date_for_view(
                    (parse_date(end_date) + timedelta(days=bank_grace_days(bname))) if parse_date(end_date) else None
                ),
                a_status, "Ù†Ø¹Ù…" if cash_flag else "Ù„Ø§", "", "",
                delivery_status, recipient_name, notes, entry_number
            ]
            rr = tbl.rowCount(); tbl.insertRow(rr)
            for c, v in enumerate(vals[:cols]):
                it = QtWidgets.QTableWidgetItem(str(v) if v is not None else "")
                it.setTextAlignment(QtCore.Qt.AlignCenter)
                if c == 2:
                    try:
                        if int(cash_flag or 0):
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#1565c0")))
                        elif (user_status or "").strip() == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#6a1b9a")))
                    except Exception:
                        pass
                if c == 13:
                    if a_status == "Ø³Ø§Ø±ÙŠ":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#2e7d32")))
                    elif a_status == "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#f9a825")))
                    elif a_status == "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#c62828")))
                    elif a_status == "Ù…Ù†ØªÙ‡ÙŠ":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#9e9e9e")))
                tbl.setItem(rr, c, it)

        try:
            tbl.resizeRowsToContents()
            tbl.resizeColumnsToContents()
            # ÙØ±Ø¶ Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØ¬Ù†Ù‘Ø¨ Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø´Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¶ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            for i in range(tbl.columnCount()):
                w = max(100, int(tbl.columnWidth(i)))
                tbl.setColumnWidth(i, w)
        except Exception:
            pass

        # Ø§ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª
        try:
            # Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­ ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±
            try:
                selected_bank = (self.kpi_bank_filter.currentText().strip() if self.kpi_bank_filter is not None else "Ø§Ù„ÙƒÙ„")
            except Exception:
                selected_bank = "Ø§Ù„ÙƒÙ„"
            dlg = PrintPreviewDialog(self, table_override=tbl)
            if kind == "bank":
                dlg.setWindowTitle(f"Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ø¨Ù†Ùƒ: {name}")
            else:
                if selected_bank != "Ø§Ù„ÙƒÙ„":
                    dlg.setWindowTitle(f"Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ù‚Ø³Ù…: {name} - Ø§Ù„Ø¨Ù†Ùƒ: {selected_bank}")
                else:
                    dlg.setWindowTitle(f"Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - Ø§Ù„Ù‚Ø³Ù…: {name}")
            dlg.exec_()
        except Exception:
            # ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø­ÙˆØ§Ø± Ø¨Ø³ÙŠØ·
            try:
                fallback = QtWidgets.QDialog(self)
                fallback.setWindowTitle(f"ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - {('Ø§Ù„Ø¨Ù†Ùƒ: ' + name) if kind=='bank' else ('Ø§Ù„Ù‚Ø³Ù…: ' + name)}")
                v = QtWidgets.QVBoxLayout(fallback); v.addWidget(tbl)
                btn_close = QtWidgets.QPushButton("Ø¥ØºÙ„Ø§Ù‚")
                btn_close.clicked.connect(fallback.accept)
                h = QtWidgets.QHBoxLayout(); h.addStretch(1); h.addWidget(btn_close); v.addLayout(h)
                fallback.resize(1000, 700); fallback.exec_()
            except Exception:
                pass

    def _populate_kpis_tab(self):
        try:
            rows = self._iter_all_rows()
        except Exception:
            rows = []
        from datetime import date as _date
        today = _date.today()

        total_count = 0
        total_value = 0.0

        by_bank = {}
        by_dept = {}
        by_type_bank = {}

        # Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¨Ù†Ùƒ (Ø¥Ù† ÙˆÙØ¬Ø¯)
        try:
            selected_bank = (self.kpi_bank_filter.currentText().strip() if self.kpi_bank_filter is not None else "Ø§Ù„ÙƒÙ„")
        except Exception:
            selected_bank = "Ø§Ù„ÙƒÙ„"

        for r in rows:
            try:
                department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment, delivery_status, recipient_name, notes, entry_number = r
            except Exception:
                # fallback unpack
                bank = ""; g_type = ""; amount = 0.0; end_date = None; user_status = ""; g_no = ""

            amt = 0.0
            try:
                amt = float(amount or 0)
            except Exception:
                pass

            total_count += 1
            total_value += amt

            bname = normalize_bank(bank or "", str(g_no or ""))
            tname = (g_type or "").strip() or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
            dname = (department or "").strip()
            _us = (user_status or "").strip()
            _auto = auto_status_for_row(end_date, bname, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                a_status = _auto
            else:
                a_status = _us or _auto

            # Ù†Ø¯Ø±Ø¬ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø· Ø§Ù„Ø­Ø§Ù„Ø§Øª: Ø³Ø§Ø±ÙŠØŒ Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ ÙˆØ§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
            include_in_reports = a_status in ("Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯")
            if include_in_reports:
                by_bank.setdefault(bname, [0, 0.0])
                by_bank[bname][0] += 1
                by_bank[bname][1] += amt

                # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ÙŠÙ‚ÙŠÙ‘ÙØ¯ Ø¨Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¥Ù† ÙƒØ§Ù† Ø§Ù„ÙÙ„ØªØ± ÙØ¹Ø§Ù„Ù‹Ø§
                if dname and (selected_bank == "Ø§Ù„ÙƒÙ„" or bname == selected_bank):
                    by_dept.setdefault(dname, [0, 0.0])
                    by_dept[dname][0] += 1
                    by_dept[dname][1] += amt

                by_type_bank.setdefault((bname, tname), [0, 0.0])
                by_type_bank[(bname, tname)][0] += 1
                by_type_bank[(bname, tname)][1] += amt

            # Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­ØªØ³Ø¨ Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©Ø› Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙ‚Ø·

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª
        def fmt_money(x):
            try:
                return f"{float(x):,.2f}"
            except Exception:
                try:
                    return f"{float(str(x).replace(',', '')):,.2f}"
                except Exception:
                    return str(x)

        # Ø£Ø²Ù„Ù†Ø§ ØªØ­Ø¯ÙŠØ« Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©

        # Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ
        def _fill_table(tbl, rows_data):
            tbl.setRowCount(len(rows_data))
            for r, (name, cnt, val) in enumerate(rows_data):
                items = [
                    QtWidgets.QTableWidgetItem(str(name)),
                    QtWidgets.QTableWidgetItem(str(cnt)),
                    QtWidgets.QTableWidgetItem(fmt_money(val)),
                ]
                for i, it in enumerate(items):
                    it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                    it.setTextAlignment(QtCore.Qt.AlignCenter)
                    tbl.setItem(r, i, it)

        # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ: Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙ„ØªØ± Ø¨Ù†ÙƒØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·Ø› ÙˆØ¥Ù„Ø§ Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
        bank_rows_all = sorted(((k, v[0], v[1]) for k, v in by_bank.items()), key=lambda x: x[2], reverse=True)
        if selected_bank != "Ø§Ù„ÙƒÙ„":
            if selected_bank in by_bank:
                bank_rows = [(selected_bank, by_bank[selected_bank][0], by_bank[selected_bank][1])]
            else:
                bank_rows = []
        else:
            bank_rows = bank_rows_all
        _fill_table(self.kpi_bank_table, bank_rows)

        # Ø­Ø¯Ù‘Ø« Ù‚Ø§Ø¦Ù…Ø© ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù† Ø£Ù…ÙƒÙ†
        try:
            if self.kpi_bank_filter is not None:
                prev = self.kpi_bank_filter.currentText().strip() if self.kpi_bank_filter.count() > 0 else "Ø§Ù„ÙƒÙ„"
                banks_list = ["Ø§Ù„ÙƒÙ„"] + [b for b, _, _ in bank_rows]
                # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨
                seen = set(); unique_banks = []
                for b in banks_list:
                    if b not in seen:
                        seen.add(b); unique_banks.append(b)
                # Ø¥Ù† ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŒ Ø£Ø¹Ø¯ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                try:
                    curr_items = [self.kpi_bank_filter.itemText(i) for i in range(self.kpi_bank_filter.count())]
                except Exception:
                    curr_items = []
                if curr_items != unique_banks:
                    self.kpi_bank_filter.blockSignals(True)
                    self.kpi_bank_filter.clear()
                    for b in unique_banks:
                        self.kpi_bank_filter.addItem(b)
                    # Ø§Ø³ØªØ¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø®ØªØ± "Ø§Ù„ÙƒÙ„"
                    try:
                        idx = unique_banks.index(prev) if prev in unique_banks else 0
                    except Exception:
                        idx = 0
                    self.kpi_bank_filter.setCurrentIndex(idx)
                    self.kpi_bank_filter.blockSignals(False)
        except Exception:
            pass

        # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…ØŒ Ù…Ø±ØªØ¨Ø© ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø©
        dept_rows = sorted(((k, v[0], v[1]) for k, v in by_dept.items()), key=lambda x: x[2], reverse=True)
        # Ø§Ù…Ù„Ø£ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        self.kpi_dept_table.setRowCount(len(dept_rows))
        for r, (name, cnt, val) in enumerate(dept_rows):
            items = [
                QtWidgets.QTableWidgetItem(str(name)),
                QtWidgets.QTableWidgetItem(str(cnt)),
                QtWidgets.QTableWidgetItem(fmt_money(val)),
            ]
            for i, it in enumerate(items):
                it.setFlags(it.flags() ^ QtCore.Qt.ItemIsEditable)
                it.setTextAlignment(QtCore.Qt.AlignCenter)
                self.kpi_dept_table.setItem(r, i, it)

        # Ø­Ø¯Ù‘Ø« Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù…Ø§ ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
        try:
            if hasattr(self, 'kpi_bank_group'):
                if selected_bank != "Ø§Ù„ÙƒÙ„":
                    self.kpi_bank_group.setTitle(f"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†Ùƒ: {selected_bank}")
                else:
                    self.kpi_bank_group.setTitle("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ")
            if hasattr(self, 'kpi_dept_group'):
                if selected_bank != "Ø§Ù„ÙƒÙ„":
                    self.kpi_dept_group.setTitle(f"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ø¨Ù†Ùƒ: {selected_bank}")
                else:
                    self.kpi_dept_group.setTitle("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
        except Exception:
            pass

        # Ù€ ØªÙ… Ø­Ø°Ù ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¨Ù†Ùƒ Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù€

    def _export_kpi_summary_to_excel(self):
        try:
            from openpyxl import Workbook  # type: ignore
        except Exception:
            try:
                QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ÙŠØ¬Ø§Ø¯ openpyxl Ù„Ù„ØªØµØ¯ÙŠØ±.")
            except Exception:
                pass
            return
        wb = Workbook()
        ws_kpi = wb.active
        ws_kpi.title = "ØªÙ‚Ø§Ø±ÙŠØ±"
        # ws_kpi.print_area = 'A:R'

        # ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù…Ù† Ø§Ù„ØµÙØ­Ø©Ø› Ù„Ø§ Ù†Ø¶ÙŠÙÙ‡Ø§ Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„

        # ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ
        ws_bank = wb.create_sheet("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ")
        # ws_bank.print_area = 'A:R'

        ws_bank.append(["Ø§Ù„Ø¨Ù†Ùƒ", "Ø¹Ø¯Ø¯", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©"])
        for r in range(self.kpi_bank_table.rowCount()):
            ws_bank.append([
                self.kpi_bank_table.item(r, 0).text() if self.kpi_bank_table.item(r, 0) else "",
                self.kpi_bank_table.item(r, 1).text() if self.kpi_bank_table.item(r, 1) else "",
                self.kpi_bank_table.item(r, 2).text() if self.kpi_bank_table.item(r, 2) else "",
            ])
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙÙˆÙ - Ø§Ø³ØªØ®Ø¯Ø§Ù… ws.max_row Ù„Ù„ØªØ²Ø§Ù…Ù†
            _current_row = ws_bank.max_row

        # ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        ws_dept = wb.create_sheet("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
        # ws_dept.print_area = 'A:R'

        ws_dept.append(["Ø§Ù„Ù‚Ø³Ù…", "Ø¹Ø¯Ø¯", "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©"])
        for r in range(self.kpi_dept_table.rowCount()):
            ws_dept.append([
                self.kpi_dept_table.item(r, 0).text() if self.kpi_dept_table.item(r, 0) else "",
                self.kpi_dept_table.item(r, 1).text() if self.kpi_dept_table.item(r, 1) else "",
                self.kpi_dept_table.item(r, 2).text() if self.kpi_dept_table.item(r, 2) else "",
            ])
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙÙˆÙ - Ø§Ø³ØªØ®Ø¯Ø§Ù… ws.max_row Ù„Ù„ØªØ²Ø§Ù…Ù†
            _current_row = ws_dept.max_row

        # Ù€ ØªÙ… Ø­Ø°Ù ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ¹ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¨Ù†Ùƒ Ù€

        # Ø­ÙØ¸
        try:
            default_name = _default_excel_name(self, fallback="kpi-summary")
        except Exception:
            default_name = "kpi-summary.xlsx"
        path, _ = QtWidgets.QFileDialog.getSaveFileName(self, "Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø®Øµ", default_name, "Excel (*.xlsx)")
        if not path:
            return
        if ws_bank.max_row > 0:
            ws_bank.print_area = f'A1:R{ws_bank.max_row}'
        if ws_dept.max_row > 0:
            ws_dept.print_area = f'A1:R{ws_dept.max_row}'

        try:
            wb.save(path)
            try:
                QtWidgets.QMessageBox.information(self, "ØªÙ…", "ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„.")
            except Exception:
                pass
        except Exception as e:
            try:
                QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸: {e}")
            except Exception:
                pass

    def export_excel(self, *args, **kwargs):
        try:
            return export_excel(self, *args, **kwargs)
        except Exception:
            pass

    def _fix_known_data_issues(self):
        """Fix known data inconsistencies in the database."""
        try:
            conn = connect_db()
            c = conn.cursor()
            # Fix B299015 bank assignment
            c.execute("UPDATE guarantees SET bank = ? WHERE g_no LIKE '%B299015%' AND bank != ?", ("Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"))
            if c.rowcount > 0:
                conn.commit()
                try:
                    _log(f"Fixed {c.rowcount} rows for B299015 bank assignment")
                except Exception:
                    pass
            conn.close()
        except Exception:
            pass

    def __init__(self):
        # Ø¥Ø²Ø§Ù„Ø© Ø²Ø± "ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„" Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)
        try:
            if hasattr(self, "act_export") and isinstance(self.act_export, QtWidgets.QAction):
                try:
                    for tb in self.findChildren(QtWidgets.QToolBar):
                        try:
                            tb.removeAction(self.act_export)
                        except Exception:
                            pass
                except Exception:
                    pass
                try:
                    self.act_export.triggered.disconnect()
                except Exception:
                    pass
                try:
                    self.act_export.setVisible(False)
                    self.act_export.setEnabled(False)
                except Exception:
                    pass
        except Exception:
            pass
        super().__init__()
        self.setWindowTitle("Abu Sarhad - Guarantees Management")
        self.setLayoutDirection(QtCore.Qt.RightToLeft)
        self._splash_shown_once = False
        self.resize(1250, 760)

        # Fix known data issues
        try:
            self._fix_known_data_issues()
        except Exception:
            pass

        self.table = QtWidgets.QTableWidget(0, 21)
        headers = ["Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†", "Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†", "Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†", "Ø§Ù„Ù†Ø³Ø¨Ø© %",
                   "Ø§Ù„Ù…Ø³ØªÙÙŠØ¯", "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "ÙØªØ±Ø© Ø§Ù„Ø³Ù…Ø§Ø­",
                   "Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ)", "Ù†Ù‚Ø¯ÙŠØŸ", "", "Ù…Ø±ÙÙ‚", "Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯"]
        self.table.setHorizontalHeaderLabels(headers)
        # ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ù…Ø­Ø±Ø± Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±
        try:
            self.table.setWordWrap(True)
            if hasattr(self.table, 'setTextElideMode'):
                self.table.setTextElideMode(QtCore.Qt.ElideNone)
            self._ml_delegate = MultiLineEditDelegate(self.table)
            self.table.setItemDelegate(self._ml_delegate)
        except Exception:
            pass
        try:
            self.table.setAlternatingRowColors(True)
        except Exception:
            pass
        # ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        try:
            _wn, _wi, _h = load_table_geometry(self)
            apply_table_geometry(self, _wn, _wi, None)
        except Exception:
            pass
        # ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸
        try:
            _wn, _wi, _h = self.load_table_geometry()
            self.apply_table_geometry(_wn, _wi, None)
        except Exception:
            pass
        # ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø±)
        try:
            order, hidden = self.load_column_settings()
            self.apply_column_settings(order, hidden)
        except Exception:
            pass
        self.table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Interactive)
        self.table.verticalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Interactive)
        # Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ
        try:
            hh = self.table.horizontalHeader()
            vh = self.table.verticalHeader()
            hh.setSectionsMovable(True)
            hh.sectionResized.connect(self._on_col_resized)
            hh.sectionMoved.connect(self._on_col_moved)
            vh.sectionResized.connect(self._on_row_resized)
        except Exception:
            pass
        # ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø¹Ù…ÙˆØ¯ ID Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        # Ø§Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ø§Ø¡ Ù…Ø­Ø±Ø± Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± Ù…Ø¹ Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ§Ø¶Ø­Ø© ÙƒÙŠ Ù†Ø±Ø¨Ø· Ø§Ù„Ø­ÙØ¸ Ø¹Ù†Ø¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ­Ø±ÙŠØ±
        self._dl_project = MultiLineEditDelegate(self.table)
        self._dl_requester = MultiLineEditDelegate(self.table)
        self._dl_beneficiary = MultiLineEditDelegate(self.table)
        self.table.setItemDelegateForColumn(9, self._dl_project)    # project
        self.table.setItemDelegateForColumn(8, self._dl_requester)  # requester
        self.table.setItemDelegateForColumn(7, self._dl_beneficiary)  # beneficiary

        # Ø±Ø¨Ø· Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠØ± (commitData)
        try:
            self._ml_delegate.commitData.connect(self._on_edit_commit)
        except Exception:
            pass
        try:
            self._dl_project.commitData.connect(self._on_edit_commit)
            self._dl_requester.commitData.connect(self._on_edit_commit)
            self._dl_beneficiary.commitData.connect(self._on_edit_commit)
        except Exception:
            pass
        self.table.setColumnHidden(16, True)

        # Ø£Ø¹ÙØ¯ Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ø®Ù„ÙŠØ©
        try:
            self.table.itemChanged.connect(self._resize_row_for_item)
        except Exception:
            pass
        try:
            self.table.itemChanged.connect(self._persist_cell_change)
        except Exception:
            pass

        # Header context menus for alignment (Excel-like)
        try:
            hh = self.table.horizontalHeader()
            self._uniform_col_from_header = False
            self._uniform_row_from_header = False
            hh.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
            hh.customContextMenuRequested.connect(self.show_header_menu)
            hh.sectionDoubleClicked.connect(self._cycle_alignment)
            hh.sectionResized.connect(self._uniform_col_width)
            hh.installEventFilter(self)
            vh = self.table.verticalHeader()
            vh.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
            vh.customContextMenuRequested.connect(self.show_row_header_menu)
            vh.sectionDoubleClicked.connect(self._cycle_alignment)
            vh.sectionResized.connect(self._uniform_row_height)
            vh.installEventFilter(self)

            # Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ø§Ø®ØªØµØ§Ø± Ctrl+U
            self.act_unmark_done = QtWidgets.QAction("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", self)
            self.act_unmark_done.setShortcut(QtGui.QKeySequence("Ctrl+U"))
            self.act_unmark_done.setToolTip("Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© \"Ù…Ù†ØªÙ‡ÙŠ\" Ø¹Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
            self.act_unmark_done.triggered.connect(self._confirm_unmark_selected_done)
            # Ø¹Ù†ØµØ± Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            self.act_delete = QtWidgets.QAction("Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§", self)
            self.act_delete.setToolTip("Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†/Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª")
            try:
                self.act_delete.triggered.disconnect()
            except Exception:
                pass
            # Ø§Ø±Ø¨Ø· Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ø¹Ø¨Ø± Lambda Ù„ØªØ¬Ù†Ø¨ ÙØ´Ù„ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ù
            self.act_delete.triggered.connect(self._confirm_delete_selected)
            # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø±Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ† Ø³ÙŠØªÙ… Ø£ÙŠØ¶Ù‹Ø§ Ø®Ø§Ø±Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„ÙˆÙƒ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø´ÙŠØ¡ Ø£Ø¹Ù„Ø§Ù‡
            self.table.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
            self.table.customContextMenuRequested.connect(self._show_table_menu)
            # ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ Action Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„ÙŠØ³ØªØ¬ÙŠØ¨ Ø§Ù„Ø§Ø®ØªØµØ§Ø±
            self.addAction(self.act_unmark_done)
            self.addAction(self.act_delete)
        except Exception:
            pass

        # Ø±Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„Ù‡Ø§ Ø­ØªÙ‰ Ù„Ùˆ Ø­Ø¯Ø« Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¨Ù„ÙˆÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚
        try:
            if not hasattr(self, 'act_unmark_done'):
                self.act_unmark_done = QtWidgets.QAction("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", self)
                self.act_unmark_done.setShortcut(QtGui.QKeySequence("Ctrl+U"))
                self.act_unmark_done.setToolTip("Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© \"Ù…Ù†ØªÙ‡ÙŠ\" Ø¹Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
                self.act_unmark_done.triggered.connect(self._confirm_unmark_selected_done)
                self.addAction(self.act_unmark_done)
        except Exception:
            pass
        try:
            if not hasattr(self, 'act_delete'):
                self.act_delete = QtWidgets.QAction("Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§", self)
                self.act_delete.setToolTip("Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†/Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª")
                # Ø§Ø±Ø¨Ø· Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ø¹Ø¨Ø± Lambda Ù„ØªØ¬Ù†Ø¨ ÙØ´Ù„ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ù
                self.act_delete.triggered.connect(self._confirm_delete_selected)
                self.addAction(self.act_delete)
        except Exception:
            pass
        try:
            self.table.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
            # Ù„ØªÙØ§Ø¯ÙŠ Ø±Ø¨Ø· Ù…ÙƒØ±Ø± ÙŠØ³Ø¨Ø¨ Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø› Ø­Ø§ÙˆÙ„ ÙØµÙ„ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø·
            try:
                self.table.customContextMenuRequested.disconnect()
            except Exception:
                pass
            self.table.customContextMenuRequested.connect(self._show_table_menu)
        except Exception:
            pass

        self.cmb_dept = QtWidgets.QComboBox();
        self.cmb_dept.addItem("Ø§Ù„ÙƒÙ„")
        self.cmb_bank = QtWidgets.QComboBox();
        # Ø£Ø²Ù„Ù†Ø§ Ø®ÙŠØ§Ø± "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        self.cmb_bank.addItems(["Ø§Ù„ÙƒÙ„", "Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³Ø§Ø¨", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ", "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"])
        # ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ù†Ùƒ Ù„ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
        try:
            self.cmb_bank.currentIndexChanged.connect(self.refresh)
        except Exception:
            pass
        self.cmb_gtype = QtWidgets.QComboBox();
        self.cmb_gtype.addItem("Ø§Ù„ÙƒÙ„")
        self.cmb_cash = QtWidgets.QComboBox();
        self.cmb_cash.addItems(["Ø§Ù„ÙƒÙ„", "Ù†Ù‚Ø¯ÙŠ", "ØªØ³Ù‡ÙŠÙ„Ø§Øª"])
        self.ed_search = QtWidgets.QLineEdit();
        self.ed_search.setPlaceholderText("Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† / Ø§Ù„Ù…Ø¨Ù„Øº / Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©â€¦");
        self.ed_search.setMaximumWidth(360)
        self.btn_apply = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚")
        self.btn_apply.setDefault(False)
        self.btn_apply.setAutoDefault(False)
        self.btn_clear = QtWidgets.QPushButton("Ù…Ø³Ø­")
        self.btn_clear.setDefault(False)
        self.btn_clear.setAutoDefault(False)
        self.btn_import = QtWidgets.QPushButton("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„")
        self.btn_preview = QtWidgets.QPushButton("Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©â€¦")

        self.btn_done = QtWidgets.QPushButton("ğŸ”´ Ù…Ù†ØªÙ‡ÙŠ")
        try:
            self.btn_done.clicked.disconnect()
        except Exception:
            pass
        try:
            self.btn_done.clicked.connect(self._confirm_mark_selected_done)
        except Exception:
            try:
                self.btn_done.clicked.connect(self._confirm_mark_selected_done)
            except Exception:
                pass
        self.btn_undone = QtWidgets.QPushButton("ğŸŸ¢ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡")
        # Ø²Ø± ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        self.btn_auto = QtWidgets.QPushButton("ğŸ”µ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ")
        # Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†
        self.btn_delete = QtWidgets.QPushButton("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†")
        # Ø´Ø±ÙŠØ· Ø£Ø²Ø±Ø§Ø± (ÙŠÙ…ÙŠÙ†) Ø¨Ù…Ø³Ø§ÙØ© 8px Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±ÙŠÙ†
        self._btn_bar = QtWidgets.QWidget()
        _hb = QtWidgets.QHBoxLayout(self._btn_bar)
        _hb.setContentsMargins(0, 0, 0, 0)
        _hb.setSpacing(8)
        _hb.addStretch(1)
        try:
            _hb.addWidget(self.btn_done)
        except Exception:
            pass
        _hb.addWidget(self.btn_undone)
        _hb.addWidget(self.btn_auto)
        _hb.addWidget(self.btn_delete)
        # Ø²Ø± Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª
        # Ø²Ø± Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª Ø³ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‡Ù†Ø§

        self.btn_undone.setDefault(False)
        self.btn_undone.setAutoDefault(False)
        self.btn_undone.setToolTip("Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© \"Ù…Ù†ØªÙ‡ÙŠ\" Ù„Ù„ØµÙ/Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
        self.btn_undone.clicked.connect(self._confirm_unmark_selected_done)

        self.btn_auto.setDefault(False)
        self.btn_auto.setAutoDefault(False)
        self.btn_auto.setToolTip("ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø³Ø­ user_status)")
        self.btn_auto.clicked.connect(self._confirm_set_selected_auto_status)

        self.btn_delete.setDefault(False)
        self.btn_delete.setAutoDefault(False)
        self.btn_delete.setToolTip("Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†/Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª")
        try:
            self.btn_delete.clicked.disconnect()
        except Exception:
            pass
        # Ø§Ø±Ø¨Ø· Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ø¹Ø¨Ø± Lambda Ù„ØªØ¬Ù†Ø¨ ÙØ´Ù„ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ù
        self.btn_delete.clicked.connect(self._confirm_delete_selected)
        # ÙØªØ­ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª
        # Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ø³Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ

        self.cmb_status = QtWidgets.QComboBox();
        self.cmb_status.addItems(["Ø§Ù„ÙƒÙ„", "Ø³Ø§Ø±ÙŠ", "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯", "Ù…Ù†ØªÙ‡ÙŠ", "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„"])

        self.btn_apply.clicked.connect(self.refresh)
        self.btn_clear.clicked.connect(self.clear_filters)
        self.btn_import.clicked.connect(self.do_import)
        self.btn_preview.clicked.connect(self.preview)
        self.ed_search.returnPressed.connect(self.refresh)
        # Ø§Ø®ØªØµØ§Ø± ENTER/RETURN Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙˆØ±Ù‹Ø§
        QtWidgets.QShortcut(QtGui.QKeySequence(QtCore.Qt.Key_Return), self, activated=self.refresh)
        QtWidgets.QShortcut(QtGui.QKeySequence(QtCore.Qt.Key_Enter), self, activated=self.refresh)
        try:
            self._attach_search_suggestions()
        except Exception:
            pass
        # Debounce Ù„Ù„Ø¨Ø­Ø« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (250ms)
        self._search_timer = QtCore.QTimer(self)
        self._search_timer.setInterval(250)
        self._search_timer.setSingleShot(True)
        self._search_timer.timeout.connect(self.refresh)
        try:
            self.ed_search.textChanged.connect(lambda _=None: self._search_timer.start())
        except Exception:
            pass
        # Ø§Ø®ØªØµØ§Ø±Ø§Øª: ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¨Ø­Ø« (Ctrl+F) ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ctrl+R)
        try:
            QtWidgets.QShortcut(QtGui.QKeySequence("Ctrl+F"), self, activated=lambda: self.ed_search.setFocus())
            QtWidgets.QShortcut(QtGui.QKeySequence("Ctrl+R"), self, activated=self.refresh)
        except Exception:
            pass

        top = QtWidgets.QGridLayout()

        # === Ø´Ø¨ÙƒØ© Ø§Ù„ÙÙ„Ø§ØªØ±: ØµÙÙ‘Ø§Ù† Ø¨Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ===
        # Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ù‚Ø³Ù… | Ø§Ù„Ø¨Ù†Ùƒ | Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª | Ø§Ù„Ø¨Ø­Ø« (ÙŠÙ…ØªØ¯ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨ØµØ±ÙŠÙ‹Ø§)
        top.addWidget(QtWidgets.QLabel("Ø§Ù„Ù‚Ø³Ù…:"), 0, 0);
        top.addWidget(self.cmb_dept, 0, 1)
        top.addWidget(QtWidgets.QLabel("Ø§Ù„Ø¨Ù†Ùƒ:"), 0, 2);
        top.addWidget(self.cmb_bank, 0, 3)
        top.addWidget(QtWidgets.QLabel("Ù†Ù‚Ø¯ÙŠ/ØªØ³Ù‡ÙŠÙ„Ø§Øª:"), 0, 4);
        top.addWidget(self.cmb_cash, 0, 5)
        top.addWidget(QtWidgets.QLabel("Ø¨Ø­Ø«:"), 0, 6);
        top.addWidget(self.ed_search, 0, 7)
        top.setColumnStretch(7, 1)

        # Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø­Ø§Ù„Ø© | Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù† | [Ù…Ù†ØªÙ‡ÙŠ/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡] ØªØ­Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠ | (ÙØ§ØµÙ„ 36px) | ØªØ·Ø¨ÙŠÙ‚/Ù…Ø³Ø­ ØªØ­Øª Ø§Ù„Ø¨Ø­Ø«
        top.addWidget(QtWidgets.QLabel("Ø§Ù„Ø­Ø§Ù„Ø©:"), 1, 0);
        top.addWidget(self.cmb_status, 1, 1)
        top.addWidget(QtWidgets.QLabel("Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†:"), 1, 2);
        top.addWidget(self.cmb_gtype, 1, 3)
        top.addWidget(self._btn_bar, 1, 4, 1, 2)
        # ÙØ§ØµÙ„ Ø«Ø§Ø¨Øª Ø¨Ø¯Ù„ Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·)
        top.addItem(QtWidgets.QSpacerItem(36, 1, QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Minimum), 1, 6)
        top.addWidget(self.btn_apply, 1, 7);
        top.addWidget(self.btn_clear, 1, 8)

        top_box = QtWidgets.QGroupBox("Ø§Ù„ÙÙ„Ø§ØªØ±");
        top_box.setLayout(top)
        # --- Wrap in tabs & add Bank Limits tab (added) ---
        central_home = QtWidgets.QWidget();
        lay = QtWidgets.QVBoxLayout(central_home)
        lay.addWidget(top_box);
        grp_fac = QtWidgets.QGroupBox("Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„ØªØ³Ù‡ÙŠÙ„Ø§Øª")
        vfac = QtWidgets.QVBoxLayout(grp_fac)
        vfac.setContentsMargins(4, 4, 4, 4)
        vfac.addWidget(self.table)
        grp_cash = QtWidgets.QGroupBox("Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©")
        vcash = QtWidgets.QVBoxLayout(grp_cash)
        vcash.setContentsMargins(4, 4, 4, 4)
        try:
            cols = self.table.columnCount()
        except Exception:
            cols = 21
        self.table_cash = QtWidgets.QTableWidget(0, cols)
        try:
            headers = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
            self.table_cash.setHorizontalHeaderLabels(headers)
        except Exception:
            pass
        try:
            self.table_cash.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
            self.table_cash.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectItems)
            self.table_cash.setAlternatingRowColors(True)
            self.table_cash.verticalHeader().setVisible(True)
            ch = self.table_cash.horizontalHeader()
            ch.setSectionResizeMode(QtWidgets.QHeaderView.Interactive)
            try:
                ch.setSectionsMovable(True)
            except Exception:
                pass
        except Exception:
            pass
        vcash.addWidget(self.table_cash)
        try:
            order, hidden = self.load_column_settings()
            self.apply_column_settings(order, hidden)
        except Exception:
            pass
        try:
            self._sync_cash_columns()
        except Exception:
            pass
        splitter = QtWidgets.QSplitter(QtCore.Qt.Vertical)
        splitter.addWidget(grp_fac)
        splitter.addWidget(grp_cash)
        try:
            splitter.setStretchFactor(0, 3)
            splitter.setStretchFactor(1, 1)
        except Exception:
            pass
        lay.addWidget(splitter)
        try:
            # Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØ§Ù„Ø³ÙÙ„ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§
            hh = self.table.horizontalHeader()
            hh.sectionResized.connect(self._sync_cash_columns)
            try:
                hh.sectionMoved.connect(self._sync_cash_columns)
            except Exception:
                pass
            if getattr(self, 'list_cols', None):
                self.list_cols.itemChanged.connect(self._sync_cash_columns)
        except Exception:
            pass
        self.tabs = QtWidgets.QTabWidget(self)
        self.tabs.addTab(central_home, "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
        # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„ (Ø¬Ø¯ÙŠØ¯)
        try:
            self._bank_detailed_tab_widget = self._build_bank_detailed_tab()
            self.tabs.addTab(self._bank_detailed_tab_widget, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„")
        except Exception:
            # ÙÙŠ Ø­Ø§Ù„ Ø£ÙŠ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ØŒ Ù„Ø§ Ù†Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
            pass
        try:
            self._dept_matrix_tab_widget = self._build_dept_matrix_tab()
            self.tabs.addTab(self._dept_matrix_tab_widget, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
        except Exception:
            pass
        # ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        try:
            self._bank_limits_tab_widget = self._build_bank_limits_tab()
            self.tabs.addTab(self._bank_limits_tab_widget, "Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ")
        except Exception:
            pass
        # Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…ÙØµÙ„"
        try:
            def _on_tab_changed(_idx):
                try:
                    if self.tabs.currentWidget() is getattr(self, '_bank_detailed_tab_widget', None):
                        self._sync_bank_detailed_active_columns_to_main()
                except Exception:
                    pass
            self.tabs.currentChanged.connect(_on_tab_changed)
        except Exception:
            pass
        # ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        self.setCentralWidget(self.tabs)
# Ø§Ø®ØªØµØ§Ø± Ø¹Ø§Ù… Ù„Ø­ÙØ¸ Ø§Ù„Ø®Ø·ÙˆØ§Øª (Ctrl+S)
        try:
            sc = QtWidgets.QShortcut(QtGui.QKeySequence('Ctrl+S'), self)
            sc.activated.connect(lambda: getattr(self, 'save_all_settings', lambda: None)())
        except Exception:
            pass
        # Watermark overlay
        try:
            self._wm_overlay = WatermarkOverlay(self.table.viewport())
            self._wm_overlay.setGeometry(self.table.viewport().rect())
            self.table.viewport().installEventFilter(self)
        except Exception:
            self._wm_overlay = None
        try:
            self.ensure_brand_defaults_enabled()
        except Exception:
            pass
        self.apply_brand_settings()
        self.table.itemDoubleClicked.connect(self.on_cell_double)
        try:
            if getattr(self, 'table_cash', None):
                self.table_cash.itemDoubleClicked.connect(self.on_cell_double)
        except Exception:
            pass
        try:
            self._setup_auto_refresh()
        except Exception:
            pass
        # ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        try:
            cfg = self.load_font_settings();
            self.apply_font_settings(cfg)
        except Exception:
            pass

            # Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø£Ø¹ÙŠØ¯ ØªØµÙ…ÙŠÙ…Ù‡Ø§)
        toolbar = QtWidgets.QToolBar("Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª");
        toolbar.setMovable(False)
        self.addToolBar(QtCore.Qt.TopToolBarArea, toolbar)
        
        apply_toolbar_visibility(self)
# Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© + Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øªâ€¦
        # Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© ØªØ±Ø³
        self.btn_settings = QtWidgets.QToolButton()
        self.btn_settings.setText("âš™")  # Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ±Ø³
        self.btn_settings.setToolTip("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
        self.btn_settings.setStyleSheet("""
            QToolButton {
                font-size: 18px;
                background-color: transparent;
                border: none;
                padding: 4px;
                min-width: 28px;
                min-height: 28px;
            }
            QToolButton:hover {
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }
        """)
        self.btn_settings.clicked.connect(self.show_settings_dialog)
        toolbar.addWidget(self.btn_settings)
        
        # Ø²Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø¬Ø¯ÙŠØ¯)
        if StatisticsDialog:
            self.btn_stats = QtWidgets.QToolButton()
            self.btn_stats.setText("ğŸ“ˆ")
            self.btn_stats.setToolTip("Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")
            self.btn_stats.setStyleSheet(self.btn_settings.styleSheet())
            self.btn_stats.clicked.connect(lambda: StatisticsDialog(self).exec_())
            toolbar.addWidget(self.btn_stats)
        # Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)

        # Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
        # Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ØªÙ… Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)

        toolbar.addSeparator()
        # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„ (Ctrl+I)
        try:
            self.act_import = QtWidgets.QAction("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„â€¦", self)
            self.act_import.setToolTip("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Excel")
            try:
                self.act_import.setShortcut(QtGui.QKeySequence("Ctrl+I"))
            except Exception:
                pass
            self.act_import.triggered.connect(self.do_import)
            # Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠØŒ Ù„ÙƒÙ† Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØµØ§Ø±
            try:
                self.addAction(self.act_import)
            except Exception:
                pass
        except Exception:
            pass
        # Ø²Ø± ØªØµØ¯ÙŠØ± Excel ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø©
        try:
            self.btn_export_excel = QtWidgets.QToolButton()
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Excel (emoji)
            self.btn_export_excel.setText("ğŸ“Š")
            self.btn_export_excel.setToolTip("ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel (Ctrl+E)")
            self.btn_export_excel.setStyleSheet("""
                QToolButton {
                    font-size: 18px;
                    background-color: transparent;
                    border: none;
                    padding: 4px;
                    min-width: 28px;
                    min-height: 28px;
                }
                QToolButton:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    border-radius: 3px;
                }
            """)
            try:
                self.btn_export_excel.setShortcut(QtGui.QKeySequence("Ctrl+E"))
            except Exception:
                pass
            self.btn_export_excel.clicked.connect(lambda: export_table_to_excel(self))
            toolbar.addWidget(self.btn_export_excel)
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø®ØªØµØ§Ø± ÙƒÙ€ QAction Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            try:
                self.act_export_excel = QtWidgets.QAction(self)
                self.act_export_excel.setShortcut(QtGui.QKeySequence("Ctrl+E"))
                self.act_export_excel.triggered.connect(lambda: export_table_to_excel(self))
                self.addAction(self.act_export_excel)
            except Exception:
                pass
        except Exception:
            pass
        try:
            self.btn_print_top = QtWidgets.QToolButton()
            self.btn_print_top.setText("ğŸ–¨")
            self.btn_print_top.setToolTip("Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø© (Ctrl+P)")
            self.btn_print_top.setStyleSheet(
                """
                QToolButton {
                    font-size: 18px;
                    background-color: transparent;
                    border: none;
                    padding: 4px;
                    min-width: 28px;
                    min-height: 28px;
                }
                QToolButton:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    border-radius: 3px;
                }
                """
            )
            self.btn_print_top.clicked.connect(self.preview)
            toolbar.addWidget(self.btn_print_top)
        except Exception:
            pass

        try:
            self.btn_export_pdf = QtWidgets.QToolButton()
            self.btn_export_pdf.setText("ğŸ“„")
            self.btn_export_pdf.setToolTip("ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF")
            self.btn_export_pdf.setStyleSheet(
                """
                QToolButton {
                    font-size: 18px;
                    background-color: transparent;
                    border: none;
                    padding: 4px;
                    min-width: 28px;
                    min-height: 28px;
                }
                QToolButton:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    border-radius: 3px;
                }
                """
            )
            try:
                self.btn_export_pdf.clicked.connect(self.export_pdf)
            except Exception:
                self.btn_export_pdf.clicked.connect(lambda: None)
            toolbar.addWidget(self.btn_export_pdf)
        except Exception:
            pass
        # Ø£Ù…Ø± Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ù… Ø§Ø­ØªØ±Ø§ÙÙŠ
        self.act_print = QtWidgets.QAction("Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©â€¦", self)
        try:
            self.act_print.setShortcut(QtGui.QKeySequence("Ctrl+P"))
        except Exception:
            pass
        self.act_print.setToolTip("ÙØªØ­ Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©")
        self.act_print.triggered.connect(self.preview)
        # Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠØŒ Ù„ÙƒÙ† Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØµØ§Ø±
        try:
            self.addAction(self.act_print)
        except Exception:
            pass
        # Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª (Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†) Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        # Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© remove_duplicates_by_gno Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ø£Ù…Ø§ÙƒÙ† Ø£Ø®Ø±Ù‰ Ø¥Ù† Ù„Ø²Ù…
        # Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¶Ù…Ø§Ù†
        self.btn_add = QtWidgets.QToolButton();
        # Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø£ÙŠÙ‚ÙˆÙ†Ø© + Ø®Ø¶Ø±Ø§Ø¡
        self.btn_add.setText("+")
        self.btn_add.setToolTip("Ø¥Ø¶Ø§ÙØ© Ø¶Ù…Ø§Ù†")
        self.btn_add.setStyleSheet("""
            QToolButton {
                font-size: 16px;
                font-weight: bold;
                color: #2e7d32;
                background-color: transparent;
                border: 1px solid #2e7d32;
                border-radius: 3px;
                padding: 2px 6px;
                min-width: 24px;
                min-height: 24px;
            }
            QToolButton:hover {
                background-color: #2e7d32;
                color: white;
            }
        """)
        self.btn_edit = QtWidgets.QToolButton();
        # Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù‚Ù„Ù… Ø¹Ù…ÙˆØ¯ÙŠ
        self.btn_edit.setText("âœ")
        self.btn_edit.setToolTip("ØªØ¹Ø¯ÙŠÙ„ Ø¶Ù…Ø§Ù†")
        self.btn_edit.setStyleSheet("""
            QToolButton {
                font-size: 18px;
                background-color: transparent;
                border: none;
                padding: 2px 4px;
                min-width: 24px;
                min-height: 24px;
                line-height: 1.2;
            }
            QToolButton:hover {
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }
        """)
        self.btn_print_all_depts = QtWidgets.QToolButton();
        self.btn_print_all_depts.setText("Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
        self.btn_export_all_depts_excel = QtWidgets.QToolButton();
        self.btn_export_all_depts_excel.setText("ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Excel")
        self.btn_add.clicked.connect(self.add_guarantee)
        self.btn_edit.clicked.connect(self.edit_selected_guarantee)
        self.btn_print_all_depts.clicked.connect(self.print_all_depts)
        self.btn_export_all_depts_excel.clicked.connect(self._export_all_sections_excel)
        toolbar.addWidget(self.btn_add);
        toolbar.addWidget(self.btn_edit)
        # Ø¶Ø¹ Ø²Ø± Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª Ø¨ÙŠÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        try:
            self.btn_trash_top = QtWidgets.QToolButton()
            self.btn_trash_top.setText("ğŸ—‘")
            self.btn_trash_top.setToolTip("Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª (Ø§Ø³ØªØ±Ø¬Ø§Ø¹/Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ)")
            self.btn_trash_top.setStyleSheet("""
                QToolButton {
                    font-size: 18px;
                    background-color: transparent;
                    border: none;
                    padding: 4px;
                    min-width: 28px;
                    min-height: 28px;
                }
                QToolButton:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    border-radius: 3px;
                }
            """)
            self.btn_trash_top.clicked.connect(lambda: open_trash_dialog(self))
            toolbar.addWidget(self.btn_trash_top)
        except Exception:
            pass
        toolbar.addWidget(self.btn_print_all_depts)
        toolbar.addWidget(self.btn_export_all_depts_excel)
        # --- Center Title on Top Toolbar ---
        try:
            left_spacer = QtWidgets.QWidget();
            left_spacer.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Preferred)
            right_spacer = QtWidgets.QWidget();
            right_spacer.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Preferred)
            self.title_center = QtWidgets.QLabel("Ø£Ø¨Ùˆ Ø³Ø±Ù‡Ø¯ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª")
            self.title_center.setAlignment(QtCore.Qt.AlignCenter)
            self.title_center.setStyleSheet(
                "QLabel { font-size:16px; font-weight:700; color:#eaeaea; letter-spacing:0.5px; }")
            self.title_center.setMinimumWidth(320)
            toolbar.addWidget(left_spacer)
            toolbar.addWidget(self.title_center)
            toolbar.addWidget(right_spacer)
        except Exception:
            pass

        # App top banner logo (RTL aware)
        try:
            self._logo_banner = QtWidgets.QLabel()
            self._logo_banner.setObjectName("AppLogoBanner")
            self._logo_banner.setContentsMargins(6, 0, 6, 0)
            self._logo_banner.setAlignment(QtCore.Qt.AlignVCenter)
            toolbar.addSeparator();
            toolbar.addWidget(self._logo_banner)
        except Exception:
            self._logo_banner = None
        # Ø²Ø± Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø¨Ø¬ÙˆØ§Ø± Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø±)
        self.btn_duplicates = QtWidgets.QToolButton()
        self.btn_duplicates.setText("âš ï¸")
        self.btn_duplicates.setToolTip("ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ Ø¶Ù…Ø§Ù†Ø§Øª Ù…ÙƒØ±Ø±Ø©")
        self.btn_duplicates.setStyleSheet("background-color: transparent; border: none; font-size: 18px; color: #9e9e9e;")
        self.btn_duplicates.setCursor(QtCore.Qt.PointingHandCursor)
        self.btn_duplicates.clicked.connect(self.show_duplicates_dialog)
        toolbar.addWidget(self.btn_duplicates)

        self.module_switch = QtWidgets.QComboBox()
        self.module_switch.addItems(["Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶"])
        try:
            self.module_switch.setCurrentIndex(0)
        except Exception:
            pass
        try:
            self.module_switch.currentIndexChanged.connect(lambda idx: self._switch_module("loans") if int(idx) == 1 else None)
        except Exception:
            pass
        toolbar.addSeparator()
        toolbar.addWidget(self.module_switch)

        # ØªÙ… Ø­Ø°Ù Ø²Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§
        self.status = self.statusBar()
        # --- Show current DB path in the status bar (5s) ---
        try:
            self.status.showMessage(f"Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {db_path()}", 5000)
        except Exception:
            pass

        # --- First-run: if database is empty, prompt the user to import once ---
        try:
            conn = connect_db();
            c = conn.cursor()
            cnt = c.execute("SELECT COUNT(*) FROM guarantees").fetchone()[0]
            conn.close()
        except Exception:
            cnt = 0
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            already = int(s.value("import/done", 0) or 0)
        except Exception:
            already = 0
        if (cnt == 0) and (already == 0):
            try:
                QtWidgets.QMessageBox.information(self, "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø©",
                                                  "Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©. Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§.")
            except Exception:
                pass
            try:
                self.do_import()
                s = QtCore.QSettings("GuaranteesApp", "Main");
                s.setValue("import/done", 1)
            except Exception:
                pass

        self.lbl_bank_totals = MarqueeLabel("Ø§Ù„Ø¨Ù†ÙˆÙƒ: â€”")
        self.status.addPermanentWidget(self.lbl_bank_totals)
        self.lbl_cash_total = QtWidgets.QLabel("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©: <span style='color:#1565c0'>0.00</span>")
        self.status.addPermanentWidget(self.lbl_cash_total)
        self.lbl_unreg_total = QtWidgets.QLabel("ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„: <span style='color:#6a1b9a'>0 | 0.00</span>")
        self.status.addPermanentWidget(self.lbl_unreg_total)
        # Alert badges
        self.badge_near = QtWidgets.QPushButton("")
        self.badge_near.setCursor(QtCore.Qt.PointingHandCursor)
        self.badge_near.setFlat(True)
        self.badge_near.setStyleSheet(
            "QPushButton { background:#f9a825; color:#111; border-radius:10px; padding:4px 8px; }")
        self.badge_near.hide()
        self.badge_exp = QtWidgets.QPushButton("")
        self.badge_exp.setCursor(QtCore.Qt.PointingHandCursor)
        self.badge_exp.setFlat(True)
        self.badge_exp.setStyleSheet(
            "QPushButton { background:#c62828; color:#fff; border-radius:10px; padding:4px 8px; }")
        self.badge_exp.hide()
        self.status.addWidget(self.badge_near)
        self.status.addWidget(self.badge_exp)
        # Click => filter by status
        self.badge_near.clicked.connect(self._filter_near)
        self.badge_exp.clicked.connect(self._filter_exp)

        # Ø§Ø¬Ø¹Ù„ Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ³Ø§Ø±->ÙŠÙ…ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¯Ø§Ø¦Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†ØŒ Ø«Ù… Ø§Ø¬Ø¹Ù„ Ù†Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠÙ…ÙŠÙ†Ø§Ù‹
        try:
            self.status.setLayoutDirection(QtCore.Qt.LeftToRight)
        except Exception:
            pass
        try:
            self.lbl_bank_totals.setMinimumWidth(320)
            self.lbl_bank_totals.setAlignment(QtCore.Qt.AlignLeft | QtCore.Qt.AlignVCenter)
            self.lbl_bank_totals.start(40, 1, 60, direction=-1)
            self.lbl_cash_total.setAlignment(QtCore.Qt.AlignLeft | QtCore.Qt.AlignVCenter)
            self.lbl_unreg_total.setAlignment(QtCore.Qt.AlignLeft | QtCore.Qt.AlignVCenter)
        except Exception:
            pass
        self._reload_departments_from_db()
        self._reload_types_from_db()
        self.refresh()
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True
        try:
            _PATCH_after_main_reload_departments(self)
        except Exception:
            pass
        # Ensure bank filter combo includes default banks (incl. Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶)
        try:
            _PATCH_after_main_reload_banks(self)
        except Exception:
            pass


    def _reload_departments_from_db(self):
        conn = connect_db();
        c = conn.cursor()
        depts = [r[0] for r in c.execute(
            "SELECT DISTINCT department FROM guarantees WHERE department IS NOT NULL AND TRIM(department)<>'' ORDER BY department").fetchall()]
        conn.close()
        for d in depts:
            if self.cmb_dept.findText(d) < 0:
                self.cmb_dept.addItem(d)
        try:
            _PATCH_after_main_reload_departments(self)
        except Exception:
            pass


    def _reload_types_from_db(self):
        conn = connect_db();
        c = conn.cursor()
        types = [r[0] for r in c.execute(
            "SELECT DISTINCT g_type FROM guarantees WHERE g_type IS NOT NULL AND TRIM(g_type)<>'' ORDER BY g_type").fetchall()]
        conn.close()
        existing = set(self.cmb_gtype.itemText(i) for i in range(self.cmb_gtype.count()))
        for t in types:
            if t not in existing:
                self.cmb_gtype.addItem(t)

    def _switch_user(self):
        self._login_as(None)

    def _populate_user_menu(self):
        try:
            m = getattr(self, "_user_menu", None)
            if m is None:
                return
            m.clear()
            act_switch = QtWidgets.QAction("ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨", self)
            act_switch.triggered.connect(self._switch_user)
            m.addAction(act_switch)
            m.addSeparator()
            try:
                _cur = (getattr(self, 'current_user', '') or '').strip().upper()
                if _cur == 'MELADL':
                    a_manage = QtWidgets.QAction("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†â€¦", self)
                    a_manage.triggered.connect(self.show_settings_dialog)
                    m.addAction(a_manage)
            except Exception:
                pass
        except Exception:
            pass

    def _login_as(self, username: str):
        try:
            QtWidgets.QApplication.instance().setQuitOnLastWindowClosed(False)
        except Exception:
            pass
        try:
            self.hide()
        except Exception:
            pass
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            s.setValue("user/current", "")
        except Exception:
            pass
        w = MainWindow()
        try:
            w.current_user = ""
        except Exception:
            pass
        w.show()
        try:
            self.close()
        except Exception:
            pass
    def _switch_module(self, target):
        try:
            cur_user = getattr(self, "current_user", "")
        except Exception:
            cur_user = ""
        try:
            w = LoansWindow() if str(target) == "loans" else MainWindow()
        except Exception:
            w = LoansWindow()
        try:
            w.current_user = cur_user
        except Exception:
            pass
        try:
            w.show()
        except Exception:
            pass
        try:
            self.close()
        except Exception:
            pass

    def _iter_filtered_rows(self):
        dep = self.cmb_dept.currentText()
        bank = self.cmb_bank.currentText()
        search = self.ed_search.text().strip()
        where = [];
        args = []
        if dep and dep != "Ø§Ù„ÙƒÙ„":
            where.append("department=?");
            args.append(dep)
        if bank and bank != "Ø§Ù„ÙƒÙ„":
            # ØªØ­Ø³ÙŠÙ† ÙÙ„ØªØ± Ø§Ù„Ø¨Ù†Ùƒ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ø§Ù„Ù‡Ù…Ø²Ø§Øª)
            if bank == "Ø§Ù„Ø£Ù‡Ù„ÙŠ":
                 where.append("((bank LIKE ? OR bank LIKE ?) AND bank NOT LIKE ?)")
                 args.extend(['%Ø§Ù„Ø£Ù‡Ù„ÙŠ%', '%Ø§Ù„Ø§Ù‡Ù„ÙŠ%', '%Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶%'])
            elif bank == "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶":
                 where.append("(bank LIKE ? OR g_no LIKE ?)")
                 args.extend(['%Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶%', '%B299015%'])
            elif bank == "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡":
                 where.append("(bank LIKE ? OR bank LIKE ?)")
                 args.extend(['%Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡%', '%Ø§Ù„Ø§Ù†Ù…Ø§Ø¡%'])
            elif bank == "Ø§Ù„Ø±ÙŠØ§Ø¶":
                 where.append("(bank LIKE ? AND g_no NOT LIKE ?)")
                 args.extend(['%Ø§Ù„Ø±ÙŠØ§Ø¶%', '%B299015%'])
            else:
                 # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ù„Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠØ¹
                 where.append("bank LIKE ?")
                 args.append(f"%{bank}%")
        gtype = getattr(self, "cmb_gtype", None)
        gt = gtype.currentText() if gtype else "Ø§Ù„ÙƒÙ„"
        if gt and gt != "Ø§Ù„ÙƒÙ„":
            where.append("g_type=?");
            args.append(gt)
        # cash/credit filter
        cash_sel = getattr(self, "cmb_cash", None)
        cf = cash_sel.currentText() if cash_sel else "Ø§Ù„ÙƒÙ„"
        if cf == "Ù†Ù‚Ø¯ÙŠ":
            where.append("cash_flag=1")
        elif cf == "ØªØ³Ù‡ÙŠÙ„Ø§Øª":
            where.append("cash_flag=0")
        is_numeric_search = False
        search_digits_only = ""
        if search:
            # Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ØµØ·Ù„Ø­Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù…ÙØµÙˆÙ„Ø© Ø¨Ù€ *
            if '*' in search:
                terms = [t.strip() for t in search.split('*') if t.strip()]
            else:
                terms = [search]

            if terms:
                or_clauses = []
                for term in terms:
                    s_num = term.translate(ARABIC_DIGITS).replace(",", "").strip()
                    like = f"%{term}%"
                    try:
                        amt = float(s_num)
                        clause = "(g_no LIKE ? OR beneficiary LIKE ? OR requester LIKE ? OR project_name LIKE ? OR notes LIKE ? OR entry_number LIKE ? OR amount = ? OR insurance_amount = ?)"
                        or_clauses.append(clause)
                        args.extend([like, like, like, like, like, like, amt, amt])
                    except Exception:
                        clause = "(g_no LIKE ? OR beneficiary LIKE ? OR requester LIKE ? OR project_name LIKE ? OR notes LIKE ? OR entry_number LIKE ?)"
                        or_clauses.append(clause)
                        args.extend([like, like, like, like, like, like])
                
                if or_clauses:
                    where.append(f"({' OR '.join(or_clauses)})")

                # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (post-processing)
                if len(terms) == 1:
                    # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ÙØ±Ø¯ØŒ Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                    search_single = terms[0]
                    s_num = search_single.translate(ARABIC_DIGITS).replace(",", "").strip()
                    search_digits_only = extract_digits_only(search_single)
                    try:
                        float(s_num)
                        is_numeric_search = True
                    except:
                        is_numeric_search = False
                else:
                    # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ØŒ Ù†Ø¹Ø·Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù„Ø§Ø­Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø­Ø°Ù Ù†ØªØ§Ø¦Ø¬ ØµØ­ÙŠØ­Ø©
                    is_numeric_search = True
                    search_digits_only = ""
        sql = "SELECT department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment, delivery_status, recipient_name, notes, entry_number, rowid FROM guarantees"
        if where:
            sql += " WHERE " + " AND ".join(where)
        
        # ØªØ®ØµÙŠØµ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø§Ù„Ø¨Ù†Ùƒ Ø«Ù… Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ (ØªØ±ØªÙŠØ¨ Ø·Ø¨ÙŠØ¹ÙŠ)
        status_filter = self.cmb_status.currentText() if hasattr(self, "cmb_status") else "Ø§Ù„ÙƒÙ„"
        if status_filter == "Ù…Ù†ØªÙ‡ÙŠ":
            # Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø¨Ù†Ùƒ (Ø£Ø¨Ø¬Ø¯ÙŠ) -> Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ (Ø±Ù‚Ù…ÙŠ Ø¨Ø¹Ø¯ Ø­Ø°Ù EN-)
            sql += " ORDER BY bank ASC, CAST(REPLACE(UPPER(IFNULL(entry_number, '')), 'EN-', '') AS INTEGER) ASC, entry_number ASC"
        else:
            sql += get_sort_sql_clause()
            
        conn = connect_db();
        c = conn.cursor()
        rows = c.execute(sql, args).fetchall()
        conn.close()
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
        try:
            rows = _dedup_rows_by_gno(rows, 2)
        except Exception:
            pass
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø­Ø±ÙˆÙ)ØŒ ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
        # Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø¨Ø¯ÙˆÙ† Ø­Ø±ÙˆÙ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)
        # Ù„ÙƒÙ† Ù„Ø§ Ù†Ø·Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ø±Ù‚Ù…ÙŠ (Ù…Ø¨Ù„Øº) Ù„Ø£Ù† SQL Ø³ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº
        if search and not is_numeric_search and search_digits_only and len(search_digits_only) > 0:
            # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙˆÙ (ØºÙŠØ± Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)
            search_normalized = search.translate(ARABIC_DIGITS)
            search_has_letters = any(c.isalpha() for c in search_normalized)
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø­Ø±ÙˆÙ)ØŒ Ø£Ø¶Ù ÙÙ„ØªØ±Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
            if not search_has_letters:
                filtered_rows = []
                for row in rows:
                    g_no = str(row[2] or "")  # Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
                    g_no_digits = extract_digits_only(g_no)
                    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
                    if search_digits_only in g_no_digits:
                        filtered_rows.append(row)
                    # Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø£ÙŠ Ø­Ù‚Ù„ Ø¢Ø®Ø± (Ù…Ù† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
                    elif any(search.lower() in str(val or "").lower() for val in [row[7], row[8], row[9], row[17], row[18]]):
                        filtered_rows.append(row)
                rows = filtered_rows
        return rows

    def _iter_all_rows(self):
        """Return ALL rows from guarantees table, ignoring UI filters entirely."""
        sql = (
            "SELECT department, bank, g_no, g_type, amount, insurance_amount, percent, "
            "beneficiary, requester, project_name, issue_date, end_date, user_status, "
            "cash_flag, attachment, delivery_status, recipient_name, notes, entry_number, rowid "
            "FROM guarantees" + get_sort_sql_clause()
        )
        conn = connect_db();
        c = conn.cursor()
        rows = c.execute(sql).fetchall()
        conn.close()
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†
        try:
            rows = _dedup_rows_by_gno(rows, 2)
        except Exception:
            pass
        return rows

    def load_sort_settings(self):
        """Load sorting settings from QSettings."""
        return load_sort_settings()

    def save_sort_settings(self, sort_by, sort_by2, sort_order):
        """Save sorting settings to QSettings."""
        save_sort_settings(sort_by, sort_by2, sort_order)

    def apply_sort_settings(self, sort_by, sort_by2, sort_order):
        """Apply sorting settings and refresh the table."""
        apply_sort_settings(sort_by, sort_by2, sort_order)

    def refresh(self):
        # ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§
        # try:
        #     if hasattr(self, '_auto_remove_duplicates_by_gno'):
        #         self._auto_remove_duplicates_by_gno()
        # except Exception:
        #     pass
        rows = self._iter_filtered_rows()
        try:
            _set_if_has(self, "_loading_rows", True)
        except Exception:
            pass
        # Ù‚Ù„Ù‘Ù„ Ø§Ù„ÙˆÙ…ÙŠØ¶ ÙˆØªØ¬Ù†Ù‘Ø¨ Ø­Ù„Ù‚Ø§Øª refresh Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
        try:
            self.table.blockSignals(True)
        except Exception:
            pass
        try:
            self.table.setUpdatesEnabled(False)
        except Exception:
            pass
        self.table.setRowCount(0)
        try:
            if getattr(self, 'table_cash', None):
                try:
                    self.table_cash.blockSignals(True)
                except Exception:
                    pass
                try:
                    self.table_cash.setUpdatesEnabled(False)
                except Exception:
                    pass
                self.table_cash.setRowCount(0)
        except Exception:
            pass
        total_amount = 0.0
        cash_total = 0.0
        unreg_count = 0
        unreg_amount = 0.0
        bank_totals = {}
        today = date.today()
        near_cnt = 0
        exp_cnt = 0
        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„ÙƒÙ„ Ø±Ù‚Ù… Ø¶Ù…Ø§Ù† Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        attachment_counts = {}
        try:
            conn = connect_db(); c = conn.cursor()
            rows_cnt = c.execute("SELECT g_no, COUNT(*) FROM attachments GROUP BY g_no").fetchall()
            attachment_counts = {normalize_gno(str(g or '')): int(cnt or 0) for (g, cnt) in rows_cnt}
            conn.close()
        except Exception:
            attachment_counts = {}
        # Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…ÙƒØ±Ø±Ø© (Ù„ØªÙ…ÙŠÙŠØ²Ù‡Ø§ Ø¨ØµØ±ÙŠÙ‹Ø§)
        dup_gnos = set()
        try:
            conn = connect_db(); c = conn.cursor()
            # Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ù„ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ø¯ (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)
            all_gnos = c.execute("SELECT g_no FROM guarantees").fetchall()
            conn.close()
            
            from collections import defaultdict
            g_counts = defaultdict(int)
            for (g,) in all_gnos:
                try:
                    norm = normalize_gno(str(g or ''))
                except Exception:
                    norm = ""
                if norm:
                    g_counts[norm] += 1
            
            # Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            dup_gnos = {k for k, v in g_counts.items() if v > 1}

            # Update duplicates notification icon
            try:
                if hasattr(self, 'btn_duplicates'):
                    if dup_gnos:
                        self.btn_duplicates.setToolTip(f"ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ {len(dup_gnos)} Ø£Ø±Ù‚Ø§Ù… Ø¶Ù…Ø§Ù† Ù…ÙƒØ±Ø±Ø©")
                        self.btn_duplicates.setStyleSheet("background-color: transparent; border: none; font-size: 18px; color: #fbc02d;")
                    else:
                        self.btn_duplicates.setToolTip("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶Ù…Ø§Ù†Ø§Øª Ù…ÙƒØ±Ø±Ø©")
                        self.btn_duplicates.setStyleSheet("background-color: transparent; border: none; font-size: 18px; color: #9e9e9e;")
                    self.btn_duplicates.show()
            except Exception:
                pass
        except Exception:
            dup_gnos = set()
        for r_idx, (department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment, delivery_status, recipient_name, notes, entry_number, _rowid) in enumerate(rows):
            g_no = str(g_no or '')
            bank = normalize_bank(bank, g_no)
            _us = (user_status or "").strip()
            _auto = auto_status_for_row(end_date, bank, today)
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                a_status = _auto
            else:
                a_status = _us or _auto
            # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ØŒ Ù„ÙƒÙ† Ø£Ø¸Ù‡Ø±Ù‡ Ø¹Ù†Ø¯ ÙÙ„ØªØ±Ø© 'Ù…Ù†ØªÙ‡ÙŠ' Ø£Ùˆ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù†Øµ Ø¨Ø­Ø«
            try:
                _want_finished = (hasattr(self, 'cmb_status') and self.cmb_status.currentText().strip() == 'Ù…Ù†ØªÙ‡ÙŠ')
            except Exception:
                _want_finished = False
            try:
                _has_search = bool(self.ed_search.text().strip())
            except Exception:
                _has_search = False
            if (user_status or '').strip() == 'Ù…Ù†ØªÙ‡ÙŠ' and not (_want_finished or _has_search):
                continue
            # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ØŒ Ù„ÙƒÙ† Ø£Ø¸Ù‡Ø±Ù‡ Ø¹Ù†Ø¯ ÙÙ„ØªØ±Ø© 'Ù…Ù†ØªÙ‡ÙŠ' Ø£Ùˆ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ù†Øµ Ø¨Ø­Ø«
            try:
                _want_finished = (hasattr(self, 'cmb_status') and self.cmb_status.currentText().strip() == 'Ù…Ù†ØªÙ‡ÙŠ')
            except Exception:
                _want_finished = False
            try:
                _has_search = bool(self.ed_search.text().strip())
            except Exception:
                _has_search = False
            if (user_status or '').strip() == 'Ù…Ù†ØªÙ‡ÙŠ' and not (_want_finished or _has_search):
                continue
            if a_status == "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡":
                near_cnt += 1
            elif a_status == "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":
                exp_cnt += 1
            status_filter = self.cmb_status.currentText() if hasattr(self, "cmb_status") else "Ø§Ù„ÙƒÙ„"
            # Ø¯Ø¹Ù… ÙÙ„ØªØ± "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„" ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ø­Ø³Ø¨ user_status
            if status_filter == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                if (user_status or '').strip() != 'Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„':
                    continue
            elif status_filter and status_filter != "Ø§Ù„ÙƒÙ„" and a_status != status_filter:
                continue
            # Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©)
            if (user_status or '').strip() == 'Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„':
                unreg_count += 1
                try:
                    unreg_amount += float(amount or 0)
                except Exception:
                    pass

            if int(cash_flag or 0):
                cash_total += float(amount or 0)
            elif a_status != "Ù…Ù†ØªÙ‡ÙŠ":
                total_amount += float(amount or 0)
                # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Â«Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„Â» Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
                if (user_status or '').strip() != 'Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„':
                    try:
                        _amt = float(amount or 0)
                        bank_totals[bank] = bank_totals.get(bank, 0.0) + _amt
                    except Exception:
                        pass
            target_tbl = self.table_cash if int(cash_flag or 0) else self.table
            r = target_tbl.rowCount();
            target_tbl.insertRow(r)
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙ„ÙˆÙŠÙ† (Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§)
            try:
                attachment_count = attachment_counts.get(g_no, 0)
            except Exception:
                attachment_count = 0
            
            vals = [department, bank, g_no, g_type,
                    f"{(amount or 0):,.2f}", f"{(insurance_amount or 0):,.2f}", f"{float(percent or 0):.0f}%",
                    beneficiary, requester, project_name,
                    format_date_for_view(issue_date), format_date_for_view(end_date), format_date_for_view(
                    (parse_date(end_date) + timedelta(days=bank_grace_days(bank))) if parse_date(end_date) else None),
                    a_status, "Ù†Ø¹Ù…" if cash_flag else "Ù„Ø§", "", "", delivery_status, recipient_name, notes, entry_number]
            for c, v in enumerate(vals):
                it = QtWidgets.QTableWidgetItem(str(v) if v is not None else "")
                it.setTextAlignment(QtCore.Qt.AlignCenter)
                # ØªÙ„ÙˆÙŠÙ† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†:
                # - Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙÙ‚: Ù„ÙˆÙ† Ø£Ø­Ù…Ø± (Ø£ÙˆÙ„ÙˆÙŠØ©)
                # - Ù†Ù‚Ø¯ÙŠ: Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ù…Ù…ÙŠØ²
                # - Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„: Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ Ù…Ù…ÙŠØ²
                if c == 2:
                    try:
                        it.setData(QtCore.Qt.UserRole, int(_rowid))
                    except Exception:
                        pass
                    try:
                        if attachment_count == 0:
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#c62828")))  # Ø£Ø­Ù…Ø±
                        elif int(cash_flag or 0):
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#1565c0")))  # Ø£Ø²Ø±Ù‚
                        elif (user_status or "").strip() == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                            it.setForeground(QtGui.QBrush(QtGui.QColor("#6a1b9a")))  # Ø¨Ù†ÙØ³Ø¬ÙŠ
                        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø¶Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§ØªØŒ Ù„ÙˆÙ‘Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± Ø§Ù„ÙØ§Ù‚Ø¹
                        try:
                            if normalize_gno(g_no) in dup_gnos:
                                it.setBackground(QtGui.QBrush(QtGui.QColor("#ffff00")))
                        except Exception:
                            pass
                    except Exception:
                        pass
                if c == 13:
                    if a_status == "Ø³Ø§Ø±ÙŠ":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#2e7d32")))
                    elif a_status == "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#f9a825")))
                    elif a_status == "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#c62828")))
                    elif a_status == "Ù…Ù†ØªÙ‡ÙŠ":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#9e9e9e")))
                if c == 3:
                    if a_status == "Ø³Ø§Ø±ÙŠ":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#2e7d32")))
                    elif a_status == "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#f9a825")))
                    elif a_status == "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#c62828")))
                    elif a_status == "Ù…Ù†ØªÙ‡ÙŠ":
                        it.setForeground(QtGui.QBrush(QtGui.QColor("#9e9e9e")))
                target_tbl.setItem(r, c, it)
            # store number of attachments in hidden col 16
            try:
                target_tbl.setItem(r, 16, QtWidgets.QTableWidgetItem(str(attachment_count)))
            except Exception:
                pass
            try:
                it_id = QtWidgets.QTableWidgetItem(str(r + 1))
                it_id.setTextAlignment(QtCore.Qt.AlignCenter)
                pal = target_tbl.palette()
                use_alt = bool(target_tbl.alternatingRowColors()) and (r % 2 == 1)
                bg = pal.color(QtGui.QPalette.AlternateBase if use_alt else QtGui.QPalette.Base)
                lum = 0.299 * bg.red() + 0.587 * bg.green() + 0.114 * bg.blue()
                it_id.setForeground(QtGui.QBrush(QtCore.Qt.white if lum < 128 else QtCore.Qt.black))
                target_tbl.setItem(r, 21, it_id)
            except Exception:
                pass
        self.table.resizeRowsToContents()
        try:
            if getattr(self, 'table_cash', None):
                self.table_cash.resizeRowsToContents()
        except Exception:
            pass
        try:
            self._sync_cash_columns()
        except Exception:
            pass
        # wrap recalculation for multi-line text: ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙƒØ±Ø± Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©
        # ØªØ·Ø¨ÙŠÙ‚ Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
        try:
            _wn, _wi, _h = load_table_geometry(self)
            apply_table_geometry(self, None, None, _h)
        except Exception:
            pass
        # ØªØ·Ø¨ÙŠÙ‚ Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        try:
            _wn, _wi, _h = self.load_table_geometry()
            self.apply_table_geometry(None, None, _h)
        except Exception:
            pass
        try:
            # ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
            _sorted = sorted(bank_totals.items(), key=lambda kv: kv[1], reverse=True)
            # ØªÙ„ÙˆÙŠÙ† Ø®ÙÙŠÙ: Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ ÙˆØ§Ù„Ù‚ÙŠÙ… ÙƒÙ‡Ø±Ù…Ø§Ù†ÙŠ ÙØ§ØªØ­
            def _entry_html(b, amt):
                return f"<span style='color:#b0bec5'>{b}</span>: <span style='color:#ffe082'>{amt:,.2f}</span>"
            banks_html = " â€¢ ".join([_entry_html(b, amt) for b, amt in _sorted]) if _sorted else "â€”"
            self.lbl_bank_totals.setText(f"Ø§Ù„Ø¨Ù†ÙˆÙƒ: {banks_html}")
            # ØªÙ„Ù…ÙŠØ­ Ù…ÙØµÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± (Ø¨Ø¯ÙˆÙ† Ø¹Ø¯Ø¯)
            tooltip_lines = ["ØªÙØµÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆÙƒ:"] + [f"- {b}: {amt:,.2f}" for b, amt in _sorted]
            self.lbl_bank_totals.setToolTip("\n".join(tooltip_lines))
            self.lbl_cash_total.setText(f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©: <span style='color:#1565c0'>{cash_total:,.2f}</span>")
            self.lbl_unreg_total.setText(f"ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„: <span style='color:#6a1b9a'>{unreg_count} | {unreg_amount:,.2f}</span>")
            try:
                _near_global = 0; _exp_global = 0
                _rows_all = list(self._iter_all_rows())
                _today = date.today()
                for _r in _rows_all:
                    bank_raw = _r[1]; g_no_all = _r[2]; end_date_all = _r[11]; user_status_all = (_r[12] or '').strip()
                    bank_all = normalize_bank(bank_raw, g_no_all)
                    _auto_all = auto_status_for_row(end_date_all, bank_all, _today)
                    if user_status_all == 'Ù…Ù†ØªÙ‡ÙŠ':
                        a_status_all = 'Ù…Ù†ØªÙ‡ÙŠ'
                    elif user_status_all == 'Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„':
                        a_status_all = _auto_all
                    else:
                        a_status_all = user_status_all or _auto_all
                    if a_status_all == 'Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡':
                        _near_global += 1
                    elif a_status_all == 'Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯':
                        _exp_global += 1
                self._update_alerts(_near_global, _exp_global)
            except Exception:
                self._update_alerts(near_cnt, exp_cnt)
        except Exception:
            pass
        try:
            _set_if_has(self, "_loading_rows", False)
        except Exception:
            pass
        # Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        try:
            self.table.blockSignals(False)
        except Exception:
            pass
        try:
            self.table.setUpdatesEnabled(True)
        except Exception:
            pass
        try:
            if getattr(self, 'table_cash', None):
                self.table_cash.blockSignals(False)
                self.table_cash.setUpdatesEnabled(True)
        except Exception:
            pass
        # ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±Ø› Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ«Ù‡
        # ØªØ­Ø¯ÙŠØ« ØªØ¨ÙˆÙŠØ¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ
        try:
            if hasattr(self, '_bank_limits_tab_widget') and hasattr(self, '_populate_bank_limits_tab'):
                self._populate_bank_limits_tab()
        except Exception:
            pass


    def _update_alerts(self, near_cnt: int, exp_cnt: int):
        """Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØºØ¶Ù‘ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„ÙÙ„Ø§ØªØ±."""
        try:
            if near_cnt > 0:
                self.badge_near.setText(f"Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: {near_cnt}")
                self.badge_near.show()
            else:
                self.badge_near.hide()
        except Exception:
            pass
        try:
            if exp_cnt > 0:
                self.badge_exp.setText(f"Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ù†Ùƒ: {exp_cnt}")
                self.badge_exp.show()
            else:
                self.badge_exp.hide()
        except Exception:
            pass


    def clear_filters(self):
        self.cmb_dept.setCurrentIndex(0)
        self.cmb_bank.setCurrentIndex(0)
        try:
            self.cmb_status.setCurrentIndex(0)
        except Exception:
            pass
        try:
            self.cmb_gtype.setCurrentIndex(0)
        except Exception:
            pass
        try:
            self.cmb_cash.setCurrentIndex(0)
        except Exception:
            pass
        self.ed_search.clear()
        self.refresh()
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True


    def do_import(self):
        """Import Excel DATA into SQLite (data-only): we DO NOT store or remember the Excel file path."""
        path, _ = QtWidgets.QFileDialog.getOpenFileName(self, "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„", "", "Excel (*.xlsx)")
        if not path:
            return
        # Import rows into DB only (no file path is persisted)
        import_xlsx_to_db(path, self)
        # Proactively forget any previous 'last import path' settings if they ever existed
        try:
            s = QtCore.QSettings("GuaranteesApp", "Main")
            s.remove("import/last_path");
            s.remove("import/dir");
            s.remove("import/last")
        except Exception:
            pass
        # Reload caches/UI from DB
        self._reload_departments_from_db()
        self._reload_types_from_db()
        self.refresh()
        try:
            QtWidgets.QMessageBox.information(self, "ØªÙ…",
                                              "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„Ù† ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
        except Exception:
            pass
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True


    def preview(self):
        # Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØªØµØ¯ÙŠØ± PDF
        dlg = PrintPreviewDialog(self)
        dlg.exec_()


    def export_pdf(self):
        """ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ PDF Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©."""
        try:
            dlg = PrintPreviewDialog(self)
        except Exception:
            dlg = None
        if dlg is None:
            try:
                QtWidgets.QMessageBox.warning(self, "PDF", "ØªØ¹Ø°Ø± ÙØªØ­ Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ØªØµØ¯ÙŠØ±.")
            except Exception:
                pass
            return
        try:
            try:
                dlg._load_settings()
            except Exception:
                pass
            dlg._save_pdf_from_preview()
        except Exception:
            pass
        finally:
            try:
                dlg.close()
            except Exception:
                pass


    def _do_daily_active_excel_export(self):
        """ÙŠÙÙ†Ø´Ø¦ Ù…Ù„Ù Ø¥ÙƒØ³Ù„ ÙŠÙˆÙ…ÙŠ Ø¨ÙƒÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ backup."""
        try:
            from openpyxl import Workbook  # type: ignore
            from openpyxl.utils import get_column_letter  # type: ignore
            from openpyxl.styles import Font, Alignment, Border, Side  # type: ignore
            from datetime import datetime, date as _date
        except Exception:
            return
        try:
            # Prepare output path under data/backup
            data_dir = _get_data_dir()
            backup_dir = data_dir / "backup"
            backup_dir.mkdir(parents=True, exist_ok=True)
            fname = f"guarantees_active_{datetime.now().strftime('%Y%m%d')}.xlsx"
            out_path = backup_dir / fname
        except Exception:
            return

        # Fetch all rows from DB
        try:
            conn = connect_db(); c = conn.cursor()
            rows = c.execute(
                "SELECT department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment, delivery_status, recipient_name, notes, entry_number FROM guarantees ORDER BY bank ASC"
            ).fetchall()
            conn.close()
        except Exception:
            rows = []

        wb = Workbook(); ws = wb.active; ws.title = "ØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©"
        try:
            ws.sheet_view.rightToLeft = True
            # ws.print_area = 'A:R'
        except Exception:
            pass

        thin = Side(border_style="thin", color="999999"); border = Border(top=thin, bottom=thin, left=thin, right=thin)
        hdrs = [
            "Ø§Ù„Ù‚Ø³Ù…","Ø§Ù„Ø¨Ù†Ùƒ","Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†","Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†","Ø§Ù„Ù…Ø¨Ù„Øº","Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†","Ø§Ù„Ù†Ø³Ø¨Ø© %","Ø§Ù„Ù…Ø³ØªÙÙŠØ¯","Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¶Ù…Ø§Ù†","Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡","Ø­Ø§Ù„Ø© (Ù…Ø¯Ø®Ù„Ø©)","Ù†Ù‚Ø¯ÙŠ","Ù…Ø±ÙÙ‚","Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙ„Ù…","Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯","Ø§Ù„Ø­Ø§Ù„Ø©"
        ]
        # Ù‚Øµ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØªÙˆÙ‚Ù Ø¹Ù†Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        try:
            end_date_idx = hdrs.index("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡")
            hdrs = hdrs[:end_date_idx+1]
        except ValueError:
            pass

        ws.append(hdrs)
        for j in range(1, len(hdrs)+1):
            cell = ws.cell(row=1, column=j); cell.font = Font(bold=True)
            cell.alignment = Alignment(horizontal='center', vertical='center'); cell.border = border

        today = _date.today()
        r_out = 2
        for r in rows:
            try:
                department, bank, g_no, g_type, amount, insurance_amount, percent, beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment, delivery_status, recipient_name, notes, entry_number = r
            except Exception:
                continue
            try:
                a_status = auto_status_for_row(end_date, bank, today)
            except Exception:
                a_status = ""
            _us = str(user_status or "").strip()
            if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                a_status = "Ù…Ù†ØªÙ‡ÙŠ"
            # Exclude finished
            if a_status == "Ù…Ù†ØªÙ‡ÙŠ":
                continue
            # Row values
            vals = [
                department, bank, g_no, g_type, float(amount or 0.0), float(insurance_amount or 0.0), float(percent or 0.0), beneficiary, requester, project_name,
                issue_date, end_date, _us, ("Ù†Ø¹Ù…" if int(cash_flag or 0) else "Ù„Ø§"), attachment, delivery_status, recipient_name, notes, entry_number, a_status
            ]
            vals = vals[:len(hdrs)]
            ws.append(vals)
            # Format numeric columns
            for col_idx in (5,6):
                try:
                    cell = ws.cell(row=r_out, column=col_idx)
                    cell.number_format = '#,##0.00'
                except Exception:
                    pass
            # Format Percentage
            try:
                cell = ws.cell(row=r_out, column=7)
                cell.number_format = '0"%"'
            except:
                pass
            for j in range(1, len(hdrs)+1):
                cell = ws.cell(row=r_out, column=j)
                cell.border = border; cell.alignment = Alignment(horizontal='center', vertical='center')
            r_out += 1

        try:
            if ws.max_row > 0:
                last_col_letter = get_column_letter(ws.max_column)
                ws.print_area = f'A1:{last_col_letter}{ws.max_row}'
            wb.save(str(out_path))
        except Exception:

            pass


    def print_all_depts(self):
        """Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…ØŒ ÙƒÙ„ Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ø­Ø¯Ø©."""
        # Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        original_dept = ""
        try:
            if hasattr(self, 'cmb_dept'):
                original_dept = self.cmb_dept.currentText()
        except Exception:
            pass
    
        try:
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            from guarantees import connect_db
            conn = connect_db()
            c = conn.cursor()
            depts = [r[0] for r in c.execute(
                "SELECT DISTINCT department FROM guarantees WHERE department IS NOT NULL AND TRIM(department)<>'' ORDER BY department").fetchall()]
            conn.close()
        
            if not depts:
                QtWidgets.QMessageBox.information(self, "Ø·Ø¨Ø§Ø¹Ø©", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.")
                return
        
            # ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            reply = QtWidgets.QMessageBox.question(
                self, "Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…",
                f"Ø³ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© {len(depts)} Ù‚Ø³Ù…ØŒ ÙƒÙ„ Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ø­Ø¯Ø©.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )
            if reply != QtWidgets.QMessageBox.Yes:
                return
        
            # Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ù‚Ø³Ù…
            for idx, dept in enumerate(depts):
                # ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                try:
                    if hasattr(self, 'cmb_dept'):
                        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        dept_idx = self.cmb_dept.findText(dept)
                        if dept_idx >= 0:
                            self.cmb_dept.setCurrentIndex(dept_idx)
                        else:
                            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø£Ø¶ÙÙ‡ Ù…Ø¤Ù‚ØªØ§Ù‹
                            self.cmb_dept.addItem(dept)
                            self.cmb_dept.setCurrentText(dept)
                except Exception:
                    pass
            
                # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ÙŠØ¹ÙƒØ³ ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù…
                try:
                    if hasattr(self, 'refresh'):
                        self.refresh()
                except Exception:
                    pass
            
                # ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                try:
                    dlg = PrintPreviewDialog(self)
                    dlg.setWindowTitle(f"Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - Ø§Ù„Ù‚Ø³Ù…: {dept}")
                    dlg.exec_()
                except Exception as e:
                    QtWidgets.QMessageBox.warning(
                        self, "ØªØ­Ø°ÙŠØ±",
                        f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø³Ù… '{dept}': {e}\nØ³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ."
                    )
                    continue
        
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
            try:
                if hasattr(self, 'cmb_dept') and original_dept:
                    dept_idx = self.cmb_dept.findText(original_dept)
                    if dept_idx >= 0:
                        self.cmb_dept.setCurrentIndex(dept_idx)
                    else:
                        self.cmb_dept.setCurrentText(original_dept)
                    if hasattr(self, 'refresh'):
                        self.refresh()
            except Exception:
                pass
        
            QtWidgets.QMessageBox.information(
                self, "Ø·Ø¨Ø§Ø¹Ø©",
                f"ØªÙ… ÙØªØ­ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù€ {len(depts)} Ù‚Ø³Ù…."
            )
        except Exception as e:
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            try:
                if hasattr(self, 'cmb_dept') and original_dept:
                    dept_idx = self.cmb_dept.findText(original_dept)
                    if dept_idx >= 0:
                        self.cmb_dept.setCurrentIndex(dept_idx)
                    else:
                        self.cmb_dept.setCurrentText(original_dept)
                    if hasattr(self, 'refresh'):
                        self.refresh()
            except Exception:
                pass
            QtWidgets.QMessageBox.critical(
                self, "Ø®Ø·Ø£",
                f"ØªØ¹Ø°Ø± Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: {e}"
            )


    def _export_all_sections_excel(self):
        """ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª Excel Ù…Ù†ÙØµÙ„Ø© (ÙƒÙ„ Ù‚Ø³Ù… ÙÙŠ Ù…Ù„Ù)."""
        try:
            # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù„Ø¯
            dir_path = QtWidgets.QFileDialog.getExistingDirectory(
                self,
                "Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯ Ù„ØªØµØ¯ÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¥Ù„ÙŠÙ‡"
            )
            if not dir_path:
                return
        
            # Ø®ÙŠØ§Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
            include_cash = True
            reply_cash = QtWidgets.QMessageBox.question(
                self, "Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±",
                "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±ØŸ\n\nYes: ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ (Ø´Ø§Ù…Ù„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ)\nNo: Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )
            if reply_cash == QtWidgets.QMessageBox.No:
                include_cash = False
        
            try:
                from openpyxl import Workbook  # type: ignore
                from openpyxl.styles import Font, PatternFill, Alignment, Border, Side  # type: ignore
            except ImportError:
                QtWidgets.QMessageBox.critical(self, "Ø®Ø·Ø£", "Ù…ÙƒØªØ¨Ø© openpyxl ØºÙŠØ± Ù…Ø«Ø¨ØªØ©.\nÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: pip install openpyxl")
                return

            # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            try:
                import db_adapter
                conn = sqlite3.connect(db_adapter.db_path())
            except ImportError:
                # Fallback if db_adapter not found
                conn = sqlite3.connect("guarantees.db")
            
            c = conn.cursor()
        
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            depts = [r[0] for r in c.execute(
                "SELECT DISTINCT department FROM guarantees WHERE department IS NOT NULL AND TRIM(department)<>'' ORDER BY department").fetchall()]
        
            if not depts:
                QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù„Ù„ØªØµØ¯ÙŠØ±.")
                conn.close()
                return
        
            # ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            reply = QtWidgets.QMessageBox.question(
                self, "ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…",
                f"Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ {len(depts)} Ù…Ù„Ù Excel ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )
            if reply != QtWidgets.QMessageBox.Yes:
                conn.close()
                return

            import os
            from datetime import date
            from openpyxl.utils import get_column_letter  # type: ignore
            today = date.today()
        
            # Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            headers = [
                "Ø§Ù„Ù‚Ø³Ù…", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ù†ÙˆØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†", "Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù†", 
                "Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†", "Ø§Ù„Ù†Ø³Ø¨Ø© %", "Ø§Ù„Ù…Ø³ØªÙÙŠØ¯", "Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
                "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ù‡ÙŠÙ„",
                "Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯"
            ]

            # Ù‚Øµ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØªÙˆÙ‚Ù Ø¹Ù†Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            try:
                end_date_idx = headers.index("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡")
                headers = headers[:end_date_idx+1]
            except ValueError:
                pass

        
            # Ø§Ù„Ø£Ù†Ù…Ø§Ø· (Styles)
            header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid") # Blue
            header_font = Font(bold=True, color="FFFFFF", size=11, name="Tahoma")
            border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
        
            success_count = 0
            errors = []

            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„ÙƒÙ„ Ù‚Ø³Ù…
            for dept in depts:
                try:
                    wb = Workbook()
                    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù†Ø´Ø·Ø©
                    ws = wb.active
                
                    # ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙƒØ§Ø³Ù… ÙˆØ±Ù‚Ø© ÙˆÙƒØ§Ø³Ù… Ù…Ù„Ù
                    safe_name = "".join(c for c in dept if c not in "[]:*?/\\|<>\"")
                    ws.title = safe_name[:30] # Ø­Ø¯ Ø£Ù‚ØµÙ‰ 30 Ø­Ø±Ù Ù„Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø©
                
                    # Ø¶Ø¨Ø· Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ±Ù‚Ø© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
                    ws.sheet_view.rightToLeft = True
                
                    # ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ù† A Ø¥Ù„Ù‰ R ÙÙ‚Ø· (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
                    # ws.print_area = 'A:R' - ØªÙ… Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø£Ø³ÙÙ„ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ openpyxl

                
                    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¤ÙˆØ³
                    ws.append(headers)
                
                    # ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø±Ø¤ÙˆØ³
                    for col_idx, header in enumerate(headers, 1):
                        cell = ws.cell(row=1, column=col_idx)
                        cell.fill = header_fill
                        cell.font = header_font
                        cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
                        cell.border = border
                
                    # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø³Ù…
                    query = """
                        SELECT department, bank, g_no, g_type, amount, insurance_amount, 
                               percent, beneficiary, requester, project_name,
                               issue_date, end_date, user_status, cash_flag,
                               delivery_status, recipient_name, notes, entry_number
                        FROM guarantees
                        WHERE department = ?
                    """
                    params = [dept]
                
                    if not include_cash:
                        query += " AND (cash_flag IS NULL OR cash_flag != 1)"
                
                    query += " ORDER BY bank ASC, issue_date DESC, g_no ASC"
                
                    rows = c.execute(query, params).fetchall()
                
                    # Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ
                    summary_data = {}  # {bank: {'initial': 0.0, 'final': 0.0, 'financial': 0.0, 'cash': 0.0}}
                
                    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    for row_idx, row in enumerate(rows, 2):
                        # ØªÙÙƒÙŠÙƒ Ø§Ù„ØµÙ
                        (r_dept, r_bank, r_gno, r_gtype, r_amount, r_ins_amount, 
                         r_percent, r_beneficiary, r_requester, r_project,
                         r_issue, r_end, r_user_status, r_cash_flag,
                         r_delivery, r_recipient, r_notes, r_entry) = row
                     
                        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                        _us = (r_user_status or "").strip()
                        _auto = auto_status_for_row(r_end, r_bank, today)
                        if _us == "Ù…Ù†ØªÙ‡ÙŠ":
                            status = "Ù…Ù†ØªÙ‡ÙŠ"
                        elif _us == "Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„":
                            status = _auto
                        else:
                            status = _us or _auto
                    
                        # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹
                        if status == "Ù…Ù†ØªÙ‡ÙŠ":
                            continue
                    
                        # ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ
                        r_bank_norm = (r_bank or "").strip()
                        if r_bank_norm not in summary_data:
                            summary_data[r_bank_norm] = {'initial': 0.0, 'final': 0.0, 'financial': 0.0, 'cash': 0.0}
                    
                        gt_norm = (r_gtype or "").strip()
                        amt = float(r_amount or 0.0)
                    
                        # Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ù…Ù†ÙØµÙ„Ø©
                        if r_cash_flag == 1:
                            summary_data[r_bank_norm]['cash'] += amt
                        else:
                            if any(x in gt_norm for x in ["Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ø¨ØªØ¯Ø§Ø¦Ù‰", "Ù…Ø¨Ø¯Ø¦ÙŠ", "Ù…Ø¨Ø¯Ø¦Ù‰"]):
                                summary_data[r_bank_norm]['initial'] += amt
                            elif any(x in gt_norm for x in ["Ù†Ù‡Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦Ù‰"]):
                                summary_data[r_bank_norm]['final'] += amt
                            elif any(x in gt_norm for x in ["Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ù…Ø§Ù„ÙŠØ©", "Ù…Ø§Ù„Ù‰"]):
                                summary_data[r_bank_norm]['financial'] += amt
                        
                        # Ø­Ø³Ø§Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ù‡ÙŠÙ„
                        cash_str = "Ù†Ù‚Ø¯ÙŠ" if r_cash_flag == 1 else "ØªØ³Ù‡ÙŠÙ„Ø§Øª"
                    
                        # ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙ Ù„Ù„ÙƒØªØ§Ø¨Ø©
                        out_row = [
                            r_dept, r_bank, r_gno, r_gtype, r_amount, r_ins_amount,
                            r_percent, r_beneficiary, r_requester, r_project,
                            r_issue, r_end, status, cash_str,
                            r_delivery, r_recipient, r_notes, r_entry
                        ]
                        # Ù‚Øµ Ø§Ù„ØµÙ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø±Ø¤ÙˆØ³
                        out_row = out_row[:len(headers)]
                    
                        ws.append(out_row)
                    
                        # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
                        for col_idx in range(1, len(headers) + 1):
                            cell = ws.cell(row=ws.max_row, column=col_idx)
                            cell.border = border
                            cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=False)
                        
                            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø§Ù„Ø¹Ù…ÙˆØ¯ 5 Ùˆ 6: Ø§Ù„Ù…Ø¨Ù„Øº ÙˆÙ…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†)
                            if col_idx in (5, 6):
                                cell.number_format = '#,##0.00'
                            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (Ø§Ù„Ø¹Ù…ÙˆØ¯ 7)
                            elif col_idx == 7:
                                cell.number_format = '0"%"'
                            
                    # Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
                    column_widths = [15, 20, 15, 12, 15, 15, 8, 20, 20, 25, 12, 12, 15, 10, 15, 15, 25, 12]
                    for i, width in enumerate(column_widths, 1):
                        col_letter = chr(64 + i) if i <= 26 else chr(64 + (i-1)//26) + chr(65 + (i-1)%26)
                        ws.column_dimensions[col_letter].width = width
                
                    # --- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ (Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ) ---
                    if summary_data:
                        # ØªØ±Ùƒ 4 ØµÙÙˆÙ ÙØ§Ø±ØºØ©
                        start_summary_row = ws.max_row + 5
                    
                        # Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ
                        summary_headers = ["Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ù†Ù‡Ø§Ø¦ÙŠ", "Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"]
                        if include_cash:
                            summary_headers.append("Ù†Ù‚Ø¯ÙŠ")
                    
                        # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                        for col_idx, header in enumerate(summary_headers, 1):
                            cell = ws.cell(row=start_summary_row, column=col_idx)
                            cell.value = header
                            cell.fill = header_fill
                            cell.font = header_font
                            cell.alignment = Alignment(horizontal='center', vertical='center')
                            cell.border = border
                    
                        # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        current_row = start_summary_row + 1
                        grand_totals = {'initial': 0.0, 'final': 0.0, 'financial': 0.0, 'total': 0.0, 'cash': 0.0}
                    
                        for bank in sorted(summary_data.keys()):
                            vals = summary_data[bank]
                            init_v = vals['initial']
                            final_v = vals['final']
                            fin_v = vals['financial']
                            cash_v = vals['cash']
                            total_v = init_v + final_v + fin_v # Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø§ ÙŠØ´Ù…Ù„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                        
                            grand_totals['initial'] += init_v
                            grand_totals['final'] += final_v
                            grand_totals['financial'] += fin_v
                            grand_totals['total'] += total_v
                            grand_totals['cash'] += cash_v
                        
                            row_vals = [bank, init_v, final_v, fin_v, total_v]
                            if include_cash:
                                row_vals.append(cash_v)
                        
                            for col_idx, val in enumerate(row_vals, 1):
                                cell = ws.cell(row=current_row, column=col_idx)
                                cell.value = val
                                cell.border = border
                                cell.alignment = Alignment(horizontal='center', vertical='center')
                                if col_idx > 1: # Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                                    cell.number_format = '#,##0.00'
                            current_row += 1
                        
                        # ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
                        total_row_vals = ["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", grand_totals['initial'], grand_totals['final'], grand_totals['financial'], grand_totals['total']]
                        if include_cash:
                            total_row_vals.append(grand_totals['cash'])
                        for col_idx, val in enumerate(total_row_vals, 1):
                            cell = ws.cell(row=current_row, column=col_idx)
                            cell.value = val
                            cell.border = border
                            cell.alignment = Alignment(horizontal='center', vertical='center')
                            cell.font = Font(bold=True) # Ø®Ø· Ø¹Ø±ÙŠØ¶ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                            # Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© Ø®ÙÙŠÙØ© Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                            cell.fill = PatternFill(start_color="E0E0E0", end_color="E0E0E0", fill_type="solid")
                            if col_idx > 1:
                                cell.number_format = '#,##0.00'
                
                    # ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ
                    if ws.max_row > 0:
                        last_col_letter = get_column_letter(ws.max_column)
                        ws.print_area = f'A1:{last_col_letter}{ws.max_row}'

                    # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                    file_name = f"{safe_name}.xlsx"
                    save_path = os.path.join(dir_path, file_name)
                    wb.save(save_path)
                    success_count += 1
                
                except Exception as e:
                    errors.append(f"{dept}: {e}")
        
            conn.close()
        
            msg = f"ØªÙ… ØªØµØ¯ÙŠØ± {success_count} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ:\n{dir_path}"
            if errors:
                msg += "\n\nØ­Ø¯Ø«Øª Ø£Ø®Ø·Ø§Ø¡ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:\n" + "\n".join(errors[:5])
                if len(errors) > 5:
                    msg += "\n..."
                
            QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±", msg)
    
        except Exception as e:
            QtWidgets.QMessageBox.critical(
                self, "Ø®Ø·Ø£",
                f"ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: {e}"
            )


    def load_font_settings(self):
        s = QtCore.QSettings("GuaranteesApp", "Main")
        return {
            "appFamily": s.value("fonts/appFamily", type=str) or "Tahoma",
            "appSize": s.value("fonts/appSize", type=int) or 11,
            "headerFamily": s.value("fonts/headerFamily", type=str) or "Tahoma",
            "headerSize": s.value("fonts/headerSize", type=int) or 11,
            "headerBold": bool(int(s.value("fonts/headerBold", 0) or 0)),
            "bodyFamily": s.value("fonts/bodyFamily", type=str) or "Tahoma",
            "bodySize": s.value("fonts/bodySize", type=int) or 11,
            "align": s.value("fonts/align", type=str) or "right",
        }


    def save_font_settings(self, cfg):
        s = QtCore.QSettings("GuaranteesApp", "Main")
        s.setValue("fonts/appFamily", cfg.get("appFamily"))
        s.setValue("fonts/appSize", int(cfg.get("appSize", 11)))
        s.setValue("fonts/headerFamily", cfg.get("headerFamily"))
        s.setValue("fonts/headerSize", int(cfg.get("headerSize", 11)))
        s.setValue("fonts/headerBold", 1 if cfg.get("headerBold") else 0)
        s.setValue("fonts/bodyFamily", cfg.get("bodyFamily"))
        s.setValue("fonts/bodySize", int(cfg.get("bodySize", 11)))
        s.setValue("fonts/align", cfg.get("align", "right"))


    def apply_font_settings(self, cfg, total_amount=None):
        # App font
        app = QtWidgets.QApplication.instance()
        if app:
            app.setFont(QtGui.QFont(cfg["appFamily"], int(cfg["appSize"])))
        # Table header/font
        header_font = QtGui.QFont(cfg["headerFamily"], int(cfg["headerSize"]))
        header_font.setBold(bool(cfg["headerBold"]))
        try:
            self.table.horizontalHeader().setFont(header_font)
            self.table.verticalHeader().setFont(header_font)
        except Exception:
            pass
        # Body font
        body_font = QtGui.QFont(cfg["bodyFamily"], int(cfg["bodySize"]))
        try:
            self.table.setFont(body_font)
        except Exception:
            pass
        try:
            if getattr(self, 'table_cash', None):
                self.table_cash.horizontalHeader().setFont(header_font)
                self.table_cash.verticalHeader().setFont(header_font)
                self.table_cash.setFont(body_font)
        except Exception:
            pass
        try:
            for t in self.findChildren(QtWidgets.QTableWidget):
                if t is self.table or t is getattr(self, 'table_cash', None):
                    continue
                try:
                    t.horizontalHeader().setFont(header_font)
                except Exception:
                    pass
                try:
                    t.verticalHeader().setFont(header_font)
                except Exception:
                    pass
                try:
                    t.setFont(body_font)
                except Exception:
                    pass
        except Exception:
            pass
        # Alignment
        al = (cfg.get("align") or "right")
        if al == "left":
            self._align = QtCore.Qt.AlignLeft
        elif al == "center":
            self._align = QtCore.Qt.AlignHCenter
        else:
            self._align = QtCore.Qt.AlignRight
        # Apply to existing cells
        rows = self.table.rowCount();
        cols = self.table.columnCount()
        for r in range(rows):
            for c in range(cols):
                if c in (4, 5, 6):
                    continue
                it = self.table.item(r, c)
                if it is not None:
                    it.setTextAlignment(self._align | QtCore.Qt.AlignVCenter)
        try:
            self.table.resizeRowsToContents()
            # wrap recalculation for multi-line text
            self.table.resizeRowsToContents()
        except Exception:
            pass
        try:
            if getattr(self, 'table_cash', None):
                self.table_cash.resizeRowsToContents()
        except Exception:
            pass
            # ØªØ·Ø¨ÙŠÙ‚ Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
            _wn, _wi, _h = load_table_geometry(self)
            apply_table_geometry(self, None, None, _h)
        except Exception:
            pass
        except Exception:
            pass
        try:
            # Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø§Ù…Ø› Ù†ÙØ¨Ù‚ÙŠ Ù†Øµ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ù†ÙˆÙƒ ÙƒÙ…Ø§ Ù‡Ùˆ Ù‡Ù†Ø§
            self.lbl_bank_totals.setText(self.lbl_bank_totals.text())

        except Exception:
            pass


    def show_font_settings(self):
        current = self.load_font_settings()
        dlg = FontSettingsDialog(self, initial=current)
        if dlg.exec_() == QtWidgets.QDialog.Accepted:
            cfg = dlg.get_values()
            self.save_font_settings(cfg)
            self.apply_font_settings(cfg)
            try:
                QtWidgets.QMessageBox.information(self, "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·", "ØªÙ… Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.")
            except Exception:
                pass


    def on_align_change(self, align):
        """Apply horizontal alignment to all non-numeric columns (leave 4,5,6 centered)."""
        try:
            self._align = align
        except Exception:
            self._align = QtCore.Qt.AlignRight
        # Apply to existing cells
        rows = self.table.rowCount();
        cols = self.table.columnCount()
        for r in range(rows):
            for c in range(cols):
                if c in (4, 5, 6):
                    continue
                it = self.table.item(r, c)
                if it is not None:
                    it.setTextAlignment(self._align | QtCore.Qt.AlignVCenter)



    def _confirm_mark_selected_done(self):
            # ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ° (ÙŠØ¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
            rows = _selected_rows_or_current(self)
            gnos = _selected_gnos(self)
            if not rows or not gnos:
                try:
                    QtWidgets.QMessageBox.information(self, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯", "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
                except Exception:
                    pass
                return
            n = len(gnos)
            g_list = "ØŒ ".join(gnos)
            text = "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙˆØ³Ù… Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ÙƒÙ€ 'Ù…Ù†ØªÙ‡ÙŠ'ØŸ\n" + str(n) + " Ø¹Ù†ØµØ±/Ø¹Ù†Ø§ØµØ±:\n" + g_list
            try:
                ret = QtWidgets.QMessageBox.question(
                    self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", text,
                    QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No, QtWidgets.QMessageBox.No
                )
            except Exception:
                ret = QtWidgets.QMessageBox.Yes
            if ret != QtWidgets.QMessageBox.Yes:
                return
            self.mark_selected_as_done()

    def mark_selected_as_done(self):
        """Mark selected guarantees as 'Ù…Ù†ØªÙ‡ÙŠ' and refresh; do not sum them in totals."""
        rows = set(idx.row() for idx in self.table.selectedIndexes())
        if not rows:
            try:
                QtWidgets.QMessageBox.information(self, "Ù…Ù†ØªÙ‡ÙŠ", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            except Exception:
                pass
            return
        conn = connect_db();
        c = conn.cursor()
        updated = 0
        try:
            for r in rows:
                it = self.table.item(r, 2)  # g_no column
                g_no = it.text().strip() if it else ""
                if not g_no:
                    continue
                try:
                    c.execute("UPDATE guarantees SET user_status=? WHERE g_no=?", ("Ù…Ù†ØªÙ‡ÙŠ", g_no))
                    updated += c.rowcount if hasattr(c, "rowcount") else 1
                except Exception:
                    pass
            conn.commit()
        finally:
            conn.close()
        self.refresh()
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True

        try:
            QtWidgets.QMessageBox.information(self, "Ù…Ù†ØªÙ‡ÙŠ", f"ØªÙ… ØªØ­Ø¯ÙŠØ« {updated} Ø³Ø¬Ù„(Ø§Øª) Ø¥Ù„Ù‰ 'Ù…Ù†ØªÙ‡ÙŠ'.")
        except Exception:
            pass


    def _show_table_menu(self, pos):
        menu = QtWidgets.QMenu(self)

        has_sel = False

        try:

            has_sel = bool(self.table.selectionModel().selectedRows())

        except Exception:

            has_sel = False

        self.act_unmark_done.setEnabled(
            bool(self.table.selectionModel().selectedRows()) if hasattr(self.table, 'selectionModel') else False)

        menu.addAction(self.act_unmark_done)

        # ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø­Ø°Ù Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙ Ù…Ø­Ø¯Ø¯ Ø£Ùˆ ØµÙ Ø­Ø§Ù„ÙŠ
        try:
            has_current = self.table.currentRow() >= 0
        except Exception:
            has_current = False
        try:
            self.act_delete.setEnabled(has_sel or has_current)
        except Exception:
            pass
        try:
            menu.addAction(self.act_delete)
        except Exception:
            pass

        try:

            menu.setDefaultAction(self.act_unmark_done)

        except Exception:

            pass

        menu.exec_(self.table.viewport().mapToGlobal(pos))



    def _confirm_unmark_selected_done(self):
            # ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ° (ÙŠØ¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
            rows = _selected_rows_or_current(self)
            gnos = _selected_gnos(self)
            if not rows or not gnos:
                try:
                    QtWidgets.QMessageBox.information(self, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯", "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
                except Exception:
                    pass
                return
            n = len(gnos)
            g_list = "ØŒ ".join(gnos)
            text = "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¹Ù† Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ\n" + str(n) + " Ø¹Ù†ØµØ±/Ø¹Ù†Ø§ØµØ±:\n" + g_list
            try:
                ret = QtWidgets.QMessageBox.question(
                    self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", text,
                    QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No, QtWidgets.QMessageBox.No
                )
            except Exception:
                ret = QtWidgets.QMessageBox.Yes
            if ret != QtWidgets.QMessageBox.Yes:
                return
            self.unmark_selected_done()

    def _confirm_delete_selected(self):
            # ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù (ÙŠØ¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
            rows = _selected_rows_or_current(self)
            gnos = _selected_gnos(self)
            if not rows or not gnos:
                try:
                    QtWidgets.QMessageBox.information(self, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯", "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
                except Exception:
                    pass
                return
            n = len(gnos)
            g_list = "ØŒ ".join(gnos)
            text = "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª:\n" + str(n) + " Ø¹Ù†ØµØ±/Ø¹Ù†Ø§ØµØ±:\n" + g_list
            try:
                ret = QtWidgets.QMessageBox.question(
                    self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", text,
                    QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No, QtWidgets.QMessageBox.No
                )
            except Exception:
                ret = QtWidgets.QMessageBox.Yes
            if ret != QtWidgets.QMessageBox.Yes:
                return
            # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ù…Ø¹ ØªÙ…Ø±ÙŠØ± self
            self.delete_selected_guarantees()

    def delete_selected_guarantees(self):
        """ÙŠØ­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù†/Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† (g_no)ØŒ
        ÙˆÙŠÙ†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù„Ø§Ø­Ù‚Ù‹Ø§.
        """
        rows = _selected_rows_or_current(self)
        if not rows:
            try:
                QtWidgets.QMessageBox.information(self, "Ø­Ø°Ù", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            except Exception:
                pass
            return
        gnos = _selected_gnos(self)
        rowids = _selected_rowids(self)
        if not gnos:
            try:
                QtWidgets.QMessageBox.information(self, "Ø­Ø°Ù", "ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.")
            except Exception:
                pass
            return
        deleted = 0
        try:
            conn = connect_db(); c = conn.cursor()
            # Ø§Ù†Ù‚Ù„ Ø£ÙˆÙ„Ù‹Ø§ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª (Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª + Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª)
            try:
                from datetime import datetime
                now = datetime.now().isoformat(timespec="seconds")
                targets = []
                if rowids:
                    for rid in rowids:
                        try:
                            row = c.execute("""SELECT department, bank, g_no, g_type, amount, insurance_amount, percent,
                                                      beneficiary, requester, project_name, issue_date, end_date, user_status,
                                                      cash_flag, attachment, delivery_status, recipient_name, notes, entry_number
                                               FROM guarantees WHERE rowid=?""", (int(rid),)).fetchone()
                            if row:
                                targets.append(("rowid", int(rid), row))
                        except Exception:
                            pass
                else:
                    for g in gnos:
                        gkey = normalize_gno(str(g or ""))
                        if not gkey:
                            continue
                        try:
                            row = c.execute("""SELECT department, bank, g_no, g_type, amount, insurance_amount, percent,
                                                      beneficiary, requester, project_name, issue_date, end_date, user_status,
                                                      cash_flag, attachment, delivery_status, recipient_name, notes, entry_number
                                               FROM guarantees WHERE g_no=?""", (gkey,)).fetchone()
                            if row:
                                targets.append(("gno", gkey, row))
                        except Exception:
                            pass
                for typ, key, row in targets:
                    try:
                        c.execute("""INSERT INTO trash_guarantees (
                                        original_rowid, department, bank, g_no, g_type, amount, insurance_amount, percent,
                                        beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag,
                                        attachment, delivery_status, recipient_name, notes, entry_number, deleted_at
                                     ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)""",
                                  (key if typ == "rowid" else None,
                                   row[0], row[1], row[2], row[3], row[4], row[5], row[6],
                                   row[7], row[8], row[9], row[10], row[11], row[12], row[13],
                                   row[14], row[15], row[16], row[17], row[18], now))
                    except Exception:
                        pass
                    # Ø§Ù†Ø³Ø® Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª (Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù‡Ù†Ø§)
                    try:
                        gkey = normalize_gno(str(row[2] or ""))
                        arows = c.execute("SELECT g_no, path, notes FROM attachments WHERE g_no=?", (gkey,)).fetchall()
                        for (ag, apath, anotes) in arows:
                            try:
                                c.execute("""INSERT INTO trash_attachments (g_no, path, notes, deleted_at) VALUES (?,?,?,?)""",
                                          (ag, apath, anotes, now))
                            except Exception:
                                pass
                    except Exception:
                        pass
                conn.commit()
            except Exception:
                pass
            # Ø«Ù… Ø§Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·Ø© (Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª + Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª) Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©
            try:
                if rowids:
                    for rid in rowids:
                        try:
                            # Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø£ÙˆÙ„Ù‹Ø§
                            try:
                                r = c.execute("SELECT g_no FROM guarantees WHERE rowid=?", (int(rid),)).fetchone()
                                if r and r[0]:
                                    c.execute("DELETE FROM attachments WHERE g_no=?", (normalize_gno(str(r[0])),))
                            except Exception:
                                pass
                            c.execute("DELETE FROM guarantees WHERE rowid=?", (int(rid),))
                            deleted += int(c.rowcount or 0)
                            if c.rowcount > 0:
                                try:
                                    log_audit("Ø­Ø°Ù", normalize_gno(str(r[0])) if r and r[0] else "", "Ù†Ù‚Ù„ Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª")
                                except Exception:
                                    pass
                        except Exception:
                            pass
                else:
                    for g in gnos:
                        gkey = normalize_gno(str(g or ""))
                        if not gkey:
                            continue
                        try:
                            c.execute("DELETE FROM attachments WHERE g_no=?", (gkey,))
                        except Exception:
                            pass
                        c.execute("DELETE FROM guarantees WHERE g_no=?", (gkey,))
                        try:
                            deleted += int(c.rowcount or 0)
                            if c.rowcount > 0:
                                log_audit("Ø­Ø°Ù", gkey, "Ù†Ù‚Ù„ Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª")
                        except Exception:
                            pass
            except Exception:
                pass
            try:
                conn.commit(); conn.close()
            except Exception:
                pass
        except Exception as e:
            try:
                QtWidgets.QMessageBox.critical(self, "Ø­Ø°Ù", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: {e}")
            except Exception:
                pass
            return
        # Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„
        self.refresh()
        try:
            QtWidgets.QMessageBox.information(self, "ØªÙ…", f"ØªÙ… Ø­Ø°Ù {deleted} Ø³Ø¬Ù„(Ø§Øª).")
        except Exception:
            pass

    def unmark_selected_done(self):
        """Revert selected guarantees from 'Ù…Ù†ØªÙ‡ÙŠ' to automatic status by clearing user_status."""
        rows = set(idx.row() for idx in self.table.selectedIndexes())
        if not rows:
            try:
                QtWidgets.QMessageBox.information(self, "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            except Exception:
                pass
            return
        conn = connect_db();
        c = conn.cursor()
        updated = 0
        try:
            for r in rows:
                it = self.table.item(r, 2)  # g_no column
                g_no = it.text().strip() if it else ""
                if not g_no:
                    continue
                try:
                    c.execute("UPDATE guarantees SET user_status=? WHERE g_no=?", ("", g_no))
                    updated += c.rowcount if hasattr(c, "rowcount") else 1
                except Exception:
                    pass
            conn.commit()
        finally:
            conn.close()
        self.refresh()
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True

        try:
            QtWidgets.QMessageBox.information(self, "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", f"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù„Ù€ {updated} Ø³Ø¬Ù„(Ø§Øª).")
        except Exception:
            pass


    def _confirm_set_selected_auto_status(self):
        # ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ° (ÙŠØ¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
        rows = _selected_rows_or_current(self)
        gnos = _selected_gnos(self)
        if not rows or not gnos:
            try:
                QtWidgets.QMessageBox.information(self, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯", "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            except Exception:
                pass
            return
        n = len(gnos)
        g_list = "ØŒ ".join(gnos)
        text = "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©) Ù„Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ\n" + str(n) + " Ø¹Ù†ØµØ±/Ø¹Ù†Ø§ØµØ±:\n" + g_list
        try:
            ret = QtWidgets.QMessageBox.question(
                self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", text,
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No, QtWidgets.QMessageBox.No
            )
        except Exception:
            ret = QtWidgets.QMessageBox.Yes
        if ret != QtWidgets.QMessageBox.Yes:
            return
        self.set_selected_auto_status()


    def set_selected_auto_status(self):
        """Clear user_status for selected guarantees (set to automatic)."""
        rows = set(idx.row() for idx in self.table.selectedIndexes())
        if not rows:
            try:
                QtWidgets.QMessageBox.information(self, "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            except Exception:
                pass
            return
        conn = connect_db();
        c = conn.cursor()
        updated = 0
        try:
            for r in rows:
                it = self.table.item(r, 2)  # g_no column
                g_no = it.text().strip() if it else ""
                if not g_no:
                    continue
                try:
                    c.execute("UPDATE guarantees SET user_status=? WHERE g_no=?", ("", g_no))
                    updated += c.rowcount if hasattr(c, "rowcount") else 1
                except Exception:
                    pass
            conn.commit()
        finally:
            conn.close()
        self.refresh()
        try:
            QtWidgets.QMessageBox.information(self, "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ", f"ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù€ {updated} Ø³Ø¬Ù„(Ø§Øª).")
        except Exception:
            pass


    def add_guarantee(self):
        dlg = GuaranteeDialog(self)
        if dlg.exec_() == QtWidgets.QDialog.Accepted:
            v = dlg.values()
            if not v["g_no"]:
                try:
                    QtWidgets.QMessageBox.warning(self, "Ø¥Ø¶Ø§ÙØ©", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ù…Ø·Ù„ÙˆØ¨.")
                except Exception:
                    pass
                return
            # ØªØ­Ù‚Ù‚ Ù…Ø¨ÙƒØ±: Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… ØºÙŠØ± ÙƒØ§Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¬Ø±Ø¯ Ø¨Ø§Ø¯Ø¦Ø© Ø¨Ù†Ùƒ
            try:
                _gno_clean = normalize_gno(v["g_no"]) 
                if _gno_clean in SAB_MARKERS:
                    try:
                        QtWidgets.QMessageBox.warning(self, "Ø¥Ø¶Ø§ÙØ©", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ ÙŠØ¨Ø¯Ùˆ ÙƒØ¨Ø§Ø¯Ø¦Ø© Ø¨Ù†Ùƒ ÙÙ‚Ø· (Ù…Ø«Ù„ ATNHTS). ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙƒØ§Ù…Ù„Ø§Ù‹.")
                    except Exception:
                        pass
                    return
            except Exception:
                pass
            conn = connect_db();
            c = conn.cursor()
            # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ø¹ ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø§Ø³Ù…ØŒ Ø£Ùˆ Ø§ÙƒØªØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§
            bank = normalize_bank(v.get("bank", ""), v["g_no"]) 
            cash = v.get("cash_flag", 0)
            try:
                _existing = None
                try:
                    _existing = c.execute("SELECT id FROM guarantees WHERE g_no=?", (normalize_gno(v["g_no"]),)).fetchone()
                except Exception:
                    _existing = None
                if _existing:
                    # Ask for confirmation before updating
                    try:
                        reply = QtWidgets.QMessageBox.question(
                            self, "ØªÙ†Ø¨ÙŠÙ‡ ØªÙƒØ±Ø§Ø±",
                            f"Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† {v['g_no']} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ",
                            QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
                            QtWidgets.QMessageBox.No
                        )
                    except Exception:
                        reply = QtWidgets.QMessageBox.No
                
                    if reply != QtWidgets.QMessageBox.Yes:
                        conn.close()
                        return

                    c.execute(
                        """UPDATE guarantees SET department=?, bank=?, g_type=?, amount=?, percent=?, beneficiary=?, requester=?, project_name=?, issue_date=?, end_date=?, user_status=?, cash_flag=?, entry_number=? WHERE g_no=?""",
                        (v["department"], bank, v["g_type"], v["amount"], v.get("percent", 0.0), v["beneficiary"], v["requester"], v["project_name"], v["issue_date"], v["end_date"], v.get("user_status", ""), cash, v["entry_number"], normalize_gno(v["g_no"]))
                    )
                else:
                    c.execute("""INSERT INTO guarantees (department, bank, g_no, g_type, amount, insurance_amount, percent,
                                 beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, entry_number)
                                 VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)""",
                          (v["department"], bank, normalize_gno(v["g_no"]), v["g_type"], v["amount"], 0.0, float(v.get("percent", 0.0)),
                           v["beneficiary"], v["requester"], v["project_name"], v["issue_date"], v["end_date"], v.get("user_status", ""), cash, v["entry_number"]))
                conn.commit()
                try:
                    log_audit("Ø¥Ø¶Ø§ÙØ©", normalize_gno(v["g_no"]), f"Ù‚Ø³Ù…: {v['department']} | Ø¨Ù†Ùƒ: {bank} | Ù…Ø¨Ù„Øº: {v['amount']}")
                except Exception:
                    pass
            except Exception as e:
                try:
                    QtWidgets.QMessageBox.warning(self, "Ø¥Ø¶Ø§ÙØ©", f"ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©: {e}")
                except Exception:
                    pass
            finally:
                conn.close()
            # Save attachments (if any) â†’ copy to portable folder and store relative paths
            try:
                atts = v.get("attachments", [])
                if atts:
                    gno = normalize_gno(v.get("g_no", ""))
                    rels = copy_attachments_for_gno(gno, atts)
                    conn = connect_db();
                    c = conn.cursor()
                    for rel in rels:
                        try:
                            c.execute("INSERT INTO attachments (g_no, path) VALUES (?,?)", (gno, rel))
                        except Exception:
                            pass
                    conn.commit();
                    conn.close()
            except Exception:
                pass
            self._reload_departments_from_db();
            self._reload_types_from_db();
        self.refresh()
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True


    def on_cell_double(self, item):
        self.edit_selected_guarantee()


    def edit_selected_guarantee(self):
        target_table = self.table
        rows = set(idx.row() for idx in self.table.selectedIndexes())
        
        # Check if cash table is selected
        if getattr(self, 'table_cash', None):
            cash_rows = set(idx.row() for idx in self.table_cash.selectedIndexes())
            if cash_rows:
                # Prioritize cash table if it has focus or main table has no selection
                if self.table_cash.hasFocus() or (not rows):
                    target_table = self.table_cash
                    rows = cash_rows

        if not rows:
            try:
                QtWidgets.QMessageBox.information(self, "ØªØ¹Ø¯ÙŠÙ„", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.")
            except Exception:
                pass
            return
        r = sorted(rows)[0]
        rid = None
        try:
            rid = int(target_table.item(r, 2).data(QtCore.Qt.UserRole))
        except Exception:
            pass

        data = {
            "department": target_table.item(r, 0).text() if target_table.item(r, 0) else "",
            "bank": target_table.item(r, 1).text() if target_table.item(r, 1) else "",
            "g_no": target_table.item(r, 2).text() if target_table.item(r, 2) else "",
            "g_type": target_table.item(r, 3).text() if target_table.item(r, 3) else "",
            "amount": target_table.item(r, 4).text().replace(',', '') if target_table.item(r, 4) else "0",
            "beneficiary": target_table.item(r, 7).text() if target_table.item(r, 7) else "",
            "requester": target_table.item(r, 8).text() if target_table.item(r, 8) else "",
            "project_name": target_table.item(r, 9).text() if target_table.item(r, 9) else "",
            "issue_date": target_table.item(r, 10).text() if target_table.item(r, 10) else "",
            "end_date": target_table.item(r, 11).text() if target_table.item(r, 11) else "",
            "cash_flag": 1 if (target_table.item(r, 14) and target_table.item(r, 14).text() == "Ù†Ø¹Ù…") else 0,
            "entry_number": target_table.item(r, 20).text() if target_table.item(r, 20) else "",
        }
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
        try:
            conn = connect_db();
            c = conn.cursor()
            row = c.execute("SELECT user_status, percent FROM guarantees WHERE g_no=?", (normalize_gno(data.get("g_no", "")),)).fetchone()
            conn.close()
            if row:
                data["user_status"] = row[0] or ""
                try:
                    data["percent"] = str(row[1] if row[1] is not None else 0)
                except Exception:
                    pass
        except Exception:
            pass
        dlg = GuaranteeDialog(self, data=data)
        if dlg.exec_() == QtWidgets.QDialog.Accepted:
            v = dlg.values()
            conn = connect_db()
            c = conn.cursor()
            
            # Recalculate bank based on g_no logic
            bank = normalize_bank(v.get("bank", ""), v["g_no"]) 
            cash = v.get("cash_flag", 0)
            
            # 1. Ensure we have a valid RID to update
            if not rid:
                try:
                    # Fallback: try to find ID by original g_no
                    orig_gno = normalize_gno(data.get("g_no", ""))
                    if orig_gno:
                        found = c.execute("SELECT id FROM guarantees WHERE g_no=?", (orig_gno,)).fetchone()
                        if found:
                            rid = found[0]
                except Exception:
                    pass

            try:
                if rid:
                     # Update by ID (Safest)
                     try:
                         log_info(f"Updating existing guarantee by ID: {rid}")
                     except: pass
                     c.execute(
                        """UPDATE guarantees SET 
                            department=?, bank=?, g_type=?, amount=?, beneficiary=?, requester=?, project_name=?, 
                            issue_date=?, end_date=?, cash_flag=?, entry_number=?, user_status=?, g_no=?, percent=? 
                            WHERE id=?""",
                        (v["department"], bank, v["g_type"], v["amount"], v["beneficiary"], v["requester"], v["project_name"],
                         v["issue_date"], v["end_date"], cash, v["entry_number"], v.get("user_status", ""), 
                         normalize_gno(v["g_no"]), float(v.get("percent", 0.0)), rid))
                else:
                    # Update by g_no (Last resort, if user didn't change g_no)
                    target_gno = normalize_gno(v["g_no"])
                    try:
                        log_info(f"Updating guarantee by G_NO: {target_gno} (RID not found)")
                    except: pass
                    # Check if we are updating an existing one or if we lost context
                    c.execute(
                        """UPDATE guarantees SET 
                            department=?, bank=?, g_type=?, amount=?, beneficiary=?, requester=?, project_name=?, 
                            issue_date=?, end_date=?, cash_flag=?, entry_number=?, user_status=?, percent=? 
                            WHERE g_no=?""",
                        (v["department"], bank, v["g_type"], v["amount"], v["beneficiary"], v["requester"], v["project_name"],
                         v["issue_date"], v["end_date"], cash, v["entry_number"], v.get("user_status", ""), 
                         float(v.get("percent", 0.0)), target_gno))
                
                if c.rowcount == 0:
                    try:
                        log_error(f"Save failed: No rows updated. RID={rid}, GNO={v['g_no']}")
                        QtWidgets.QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø³Ø¬Ù„. Ø±Ø¨Ù…Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¶Ù…Ø§Ù† Ø£Ùˆ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.")
                    except: pass
                conn.commit()
                try:
                    log_info(f"Save successful. Rows updated: {c.rowcount}")
                except: pass
                
                try:
                    log_audit("ØªØ¹Ø¯ÙŠÙ„", normalize_gno(v["g_no"]), f"ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ù…Ø§Ù†. Ù‚Ø³Ù…: {v['department']} | Ø¨Ù†Ùƒ: {bank}")
                except Exception:
                    pass

            except sqlite3.IntegrityError:
                try:
                    QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø±Ù‡!")
                except:
                    pass
            except Exception as e:
                try:
                    log_error(f"Error saving guarantee: {e}")
                except: pass
                try:
                    QtWidgets.QMessageBox.warning(self, "ØªØ¹Ø¯ÙŠÙ„", f"ØªØ¹Ø°Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: {e}")
                except Exception:
                    pass
            finally:
                conn.close()
            self._reload_departments_from_db();
            self._reload_types_from_db();
        self.refresh()
        # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
        if not getattr(self, "_splash_shown_once", False):
            try:
                _logo = _read_brand_logo_path()
            except Exception:
                _logo = ""
            try:
                self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
                self._embedded_splash.show()
                self._embedded_splash.raise_()
            except Exception:
                self._embedded_splash = None
            self._splash_shown_once = True


    def remove_duplicates_by_gno(self):
        """Delete duplicate rows from DB by normalized guarantee number, keeping the latest (highest id)."""
        try:
            conn = connect_db();
            c = conn.cursor()
            # Ø§Ø­ØµØ§Ø¡ Ø³Ø±ÙŠØ¹ Ù„Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
            rows = c.execute("SELECT id, g_no FROM guarantees ORDER BY id DESC").fetchall()
            keep_ids = set()
            delete_ids = []
            seen = set()
            for rid, g in rows:
                key = normalize_gno(str(g or ""))
                if not key:
                    # Ø¥Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙØ§Ø±ØºØŒ Ù„Ø§ Ù†Ø¹ØªØ¨Ø±Ù‡ ØªÙƒØ±Ø§Ø±Ù‹Ø§ Ù‡Ù†Ø§
                    continue
                if key in seen:
                    delete_ids.append(rid)
                else:
                    seen.add(key)
                    keep_ids.add(rid)
            if not delete_ids:
                try:
                    QtWidgets.QMessageBox.information(self, "Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†.")
                except Exception:
                    pass
                conn.close();
                return
            # Ø¹Ø±Ø¶ ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ù„Ø®Øµ Ù…Ø®ØªØµØ±
            try:
                sample = []
                # Ø£Ù†Ø´Ø¦ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ø¹Ø±Ø¶
                dups_map = {}
                for rid, g in rows:
                    key = normalize_gno(str(g or ""))
                    if not key:
                        continue
                    dups_map.setdefault(key, 0)
                    dups_map[key] += 1
                for k, cnt in list(dups_map.items())[:20]:
                    if cnt > 1:
                        sample.append(f"- {k}: {cnt}")
                msg = "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆÙŠÙØ¨Ù‚ÙŠ Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„ Ù„ÙƒÙ„ Ø±Ù‚Ù… Ø¶Ù…Ø§Ù†.\n\n" + ("\n".join(sample) if sample else "")
                ret = QtWidgets.QMessageBox.question(
                    self, "ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", msg,
                    QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No, QtWidgets.QMessageBox.No
                )
                if ret != QtWidgets.QMessageBox.Yes:
                    conn.close();
                    return
            except Exception:
                # ÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø°Ø± Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©ØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
                pass
            # ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù
            try:
                c.executemany("DELETE FROM guarantees WHERE id=?", [(i,) for i in delete_ids])
                conn.commit()
                deleted = len(delete_ids)
            except Exception as e:
                try:
                    QtWidgets.QMessageBox.warning(self, "Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù: {e}")
                except Exception:
                    pass
                deleted = 0
            finally:
                conn.close()
            self.refresh()
            try:
                QtWidgets.QMessageBox.information(self, "Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", f"ØªÙ… Ø­Ø°Ù {deleted} Ø³Ø¬Ù„(Ø§Øª) Ù…ÙƒØ±Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.")
            except Exception:
                pass
        except Exception as e:
            # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¥Ù† ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ù‹Ø§ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ¯ÙŠØ©
            try:
                if 'conn' in locals():
                    try:
                        conn.close()
                    except Exception:
                        pass
            except Exception:
                pass
            try:
                QtWidgets.QMessageBox.warning(self, "Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {e}")
            except Exception:
                pass


    def edit_guarantee_by_id(self, rid):
        """Edit a guarantee by its database ID."""
        try:
            conn = connect_db()
            c = conn.cursor()
            # Retrieve current data
            row = c.execute("SELECT * FROM guarantees WHERE id=?", (rid,)).fetchone()
            conn.close()
            if not row:
                QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¶Ù…Ø§Ù†.")
                return

            data = {
                "department": row[1] or "",
                "bank": row[2] or "",
                "g_no": row[3] or "",
                "g_type": row[4] or "",
                "amount": str(row[5] or 0),
                "insurance_amount": str(row[6] or 0),
                "percent": str(row[7] or 0),
                "beneficiary": row[8] or "",
                "requester": row[9] or "",
                "project_name": row[10] or "",
                "issue_date": row[11] or "",
                "end_date": row[12] or "",
                "notes": row[13] or "",
                "user_status": row[13] or "",
                "cash_flag": int(row[14] or 0),
                "entry_number": row[31] or "",
            }
            
            dlg = GuaranteeDialog(self, data=data)
            if dlg.exec_() == QtWidgets.QDialog.Accepted:
                v = dlg.values()
                conn = connect_db()
                c = conn.cursor()
                bank = normalize_bank(v.get("bank", ""), v["g_no"])
                
                c.execute("""UPDATE guarantees SET 
                            department=?, bank=?, g_no=?, g_type=?, amount=?, insurance_amount=?, percent=?, 
                            beneficiary=?, requester=?, project_name=?, issue_date=?, end_date=?, 
                            user_status=?, cash_flag=?, entry_number=?
                            WHERE id=?""",
                          (v["department"], bank, v["g_no"], v["g_type"], v["amount"], v["insurance_amount"], v["percent"],
                           v["beneficiary"], v["requester"], v["project_name"], v["issue_date"], v["end_date"],
                           v["user_status"], v["cash_flag"], v["entry_number"], rid))
                conn.commit()
                conn.close()
                self.refresh()
                # Update status bar or log
                try:
                    self.status.showMessage("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­", 3000)
                except Exception:
                    pass
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: {e}")

    def show_duplicates_dialog(self):
        try:
            dlg = DuplicatesDialog(self)
            dlg.exec_()
            self.refresh()
        except Exception as e:
            QtWidgets.QMessageBox.warning(self, "Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")

    def _auto_remove_duplicates_by_gno(self):
        """Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ù†ÙˆØ§ÙØ°.
        ÙŠØ¨Ù‚ÙŠ Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„ (Ø£Ø¹Ù„Ù‰ id) Ù„ÙƒÙ„ Ø±Ù‚Ù… Ø¶Ù…Ø§Ù† Ù…ÙØ·ÙØ¨ÙÙ‘Ø¹.
        """
        try:
            conn = connect_db();
            c = conn.cursor()
            rows = c.execute("SELECT id, g_no FROM guarantees ORDER BY id DESC").fetchall()
            seen = set()
            delete_ids = []
            for rid, g in rows:
                key = normalize_gno(str(g or ""))
                if not key:
                    continue
                if key in seen:
                    delete_ids.append(rid)
                else:
                    seen.add(key)
            if delete_ids:
                try:
                    c.executemany("DELETE FROM guarantees WHERE id=?", [(i,) for i in delete_ids])
                    conn.commit()
                except Exception:
                    pass
            try:
                conn.close()
            except Exception:
                pass
        except Exception:
            pass

    def on_cell_double(self, it):
        try:
            row = it.row()
            col = it.column()
            tbl = getattr(it, 'tableWidget', lambda: None)() or self.table
            if col == 0:
                data = {
                    "department": tbl.item(row, 0).text() if tbl.item(row, 0) else "",
                    "bank": tbl.item(row, 1).text() if tbl.item(row, 1) else "",
                    "g_no": tbl.item(row, 2).text() if tbl.item(row, 2) else "",
                    "g_type": tbl.item(row, 3).text() if tbl.item(row, 3) else "",
                    "amount": tbl.item(row, 4).text() if tbl.item(row, 4) else "0",
                    "insurance_amount": tbl.item(row, 5).text() if tbl.item(row, 5) else "0",
                    "percent": tbl.item(row, 6).text() if tbl.item(row, 6) else "0%",
                    "beneficiary": tbl.item(row, 7).text() if tbl.item(row, 7) else "",
                    "requester": tbl.item(row, 8).text() if tbl.item(row, 8) else "",
                    "project_name": tbl.item(row, 9).text() if tbl.item(row, 9) else "",
                    "issue_date": tbl.item(row, 10).text() if tbl.item(row, 10) else "",
                    "end_date": tbl.item(row, 11).text() if tbl.item(row, 11) else "",
                    "grace_period": tbl.item(row, 12).text() if tbl.item(row, 12) else "",
                    "user_status": tbl.item(row, 13).text() if tbl.item(row, 13) else "ØªÙ„Ù‚Ø§Ø¦ÙŠ",
                    "cash_flag": tbl.item(row, 14).text() if tbl.item(row, 14) else "Ù„Ø§",
                    "delivery_status": tbl.item(row, 17).text() if tbl.item(row, 17) else "",
                    "recipient_name": tbl.item(row, 18).text() if tbl.item(row, 18) else "",
                    "notes": tbl.item(row, 19).text() if tbl.item(row, 19) else "",
                    "entry_number": tbl.item(row, 20).text() if tbl.item(row, 20) else "",
                }
                dlg = GuaranteeViewDialog(self, row_data=data, g_no=data.get("g_no"))
                dlg.exec_()
            elif col == 2:
                cell = tbl.item(row, 2)
                gno = cell.text().strip() if cell else ""
                if not gno:
                    return
                dlg = AttachmentManagerDialog(self, gno)
                dlg.exec_()
        except Exception:
            pass


def set_dark_theme(app):
    app.setStyle("Fusion")
    dark = QtGui.QPalette()
    dark.setColor(QtGui.QPalette.Window, QtGui.QColor(45, 45, 48))
    dark.setColor(QtGui.QPalette.WindowText, QtCore.Qt.white)
    dark.setColor(QtGui.QPalette.Base, QtGui.QColor(30, 30, 30))
    dark.setColor(QtGui.QPalette.AlternateBase, QtGui.QColor(45, 45, 48))
    dark.setColor(QtGui.QPalette.ToolTipBase, QtCore.Qt.white)
    dark.setColor(QtGui.QPalette.ToolTipText, QtCore.Qt.white)
    dark.setColor(QtGui.QPalette.Text, QtCore.Qt.white)
    dark.setColor(QtGui.QPalette.Button, QtGui.QColor(45, 45, 48))
    dark.setColor(QtGui.QPalette.ButtonText, QtCore.Qt.white)
    dark.setColor(QtGui.QPalette.BrightText, QtCore.Qt.red)
    dark.setColor(QtGui.QPalette.Link, QtGui.QColor(42, 130, 218))
    dark.setColor(QtGui.QPalette.Highlight, QtGui.QColor(42, 130, 218))
    dark.setColor(QtGui.QPalette.HighlightedText, QtCore.Qt.black)
    dark.setColor(QtGui.QPalette.PlaceholderText, QtGui.QColor(160, 160, 160))
    app.setPalette(dark)


def set_royal_theme(app):
    """Ø«ÙŠÙ… Ù…Ù„ÙƒÙŠ: ÙƒØ­Ù„ÙŠ Ø¹Ù…ÙŠÙ‚ ÙˆØ°Ù‡Ø¨ÙŠ."""
    app.setStyle("Fusion")
    pal = QtGui.QPalette()
    
    # Ø®Ù„ÙÙŠØ© ÙƒØ­Ù„ÙŠ Ø¹Ù…ÙŠÙ‚
    bg_color = QtGui.QColor(10, 25, 47)
    text_color = QtGui.QColor(230, 241, 255)
    gold_color = QtGui.QColor(255, 215, 0)
    
    pal.setColor(QtGui.QPalette.Window, bg_color)
    pal.setColor(QtGui.QPalette.WindowText, text_color)
    pal.setColor(QtGui.QPalette.Base, QtGui.QColor(17, 34, 64))
    pal.setColor(QtGui.QPalette.AlternateBase, QtGui.QColor(23, 42, 69))
    pal.setColor(QtGui.QPalette.ToolTipBase, text_color)
    pal.setColor(QtGui.QPalette.ToolTipText, bg_color)
    pal.setColor(QtGui.QPalette.Text, text_color)
    pal.setColor(QtGui.QPalette.Button, QtGui.QColor(23, 42, 69))
    pal.setColor(QtGui.QPalette.ButtonText, text_color)
    pal.setColor(QtGui.QPalette.BrightText, gold_color)
    
    pal.setColor(QtGui.QPalette.Link, gold_color)
    pal.setColor(QtGui.QPalette.Highlight, QtGui.QColor(100, 255, 218)) # Teal accent
    pal.setColor(QtGui.QPalette.HighlightedText, bg_color)
    pal.setColor(QtGui.QPalette.PlaceholderText, QtGui.QColor(136, 146, 176))
    
    app.setPalette(pal)



def set_cyberpunk_theme(app):
    """Ø«ÙŠÙ… Ø³Ø§ÙŠØ¨Ø±Ø¨Ø§Ù†Ùƒ: Ù†ÙŠÙˆÙ† Ù…ØªÙˆÙ‡Ø¬ØŒ ØªØ¯Ø±Ø¬Ø§Øª Ø¯Ø§ÙƒÙ†Ø©ØŒ ØªØ£Ø«ÙŠØ±Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©."""
    app.setStyle("Fusion")
    pal = QtGui.QPalette()
    
    # Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†ÙŠÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    neon_cyan = "#00f3ff"
    neon_pink = "#ff00ff"
    dark_bg = "#0b0d17"
    dark_panel = "#15192b"
    
    # Palette setup
    pal.setColor(QtGui.QPalette.Window, QtGui.QColor(11, 13, 23))
    pal.setColor(QtGui.QPalette.WindowText, QtGui.QColor(0, 243, 255))
    pal.setColor(QtGui.QPalette.Base, QtGui.QColor(21, 25, 43))
    pal.setColor(QtGui.QPalette.AlternateBase, QtGui.QColor(30, 35, 60))
    pal.setColor(QtGui.QPalette.ToolTipBase, QtGui.QColor(0, 243, 255))
    pal.setColor(QtGui.QPalette.ToolTipText, QtGui.QColor(11, 13, 23))
    pal.setColor(QtGui.QPalette.Text, QtGui.QColor(220, 220, 255))
    pal.setColor(QtGui.QPalette.Button, QtGui.QColor(21, 25, 43))
    pal.setColor(QtGui.QPalette.ButtonText, QtGui.QColor(0, 243, 255))
    pal.setColor(QtGui.QPalette.BrightText, QtGui.QColor(255, 0, 255))
    pal.setColor(QtGui.QPalette.Link, QtGui.QColor(255, 0, 255))
    pal.setColor(QtGui.QPalette.Highlight, QtGui.QColor(0, 243, 255))
    pal.setColor(QtGui.QPalette.HighlightedText, QtGui.QColor(11, 13, 23))
    pal.setColor(QtGui.QPalette.PlaceholderText, QtGui.QColor(100, 110, 130))
    
    app.setPalette(pal)
    
    # CSS Ù…ØªÙ‚Ø¯Ù… (Gradients, Glows, Borders)
    app.setStyleSheet(f"""
        QMainWindow, QDialog {{
            background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 {dark_bg}, stop:1 #1a1c29);
        }}
        QGroupBox {{
            border: 1px solid {neon_cyan};
            border-radius: 8px;
            margin-top: 10px;
            background-color: rgba(21, 25, 43, 0.7);
        }}
        QGroupBox::title {{
            subcontrol-origin: margin;
            left: 10px;
            padding: 0 5px;
            color: {neon_cyan};
            background-color: {dark_bg};
            border: 1px solid {neon_cyan};
            border-radius: 4px;
        }}
        QLineEdit, QComboBox, QDateEdit, QSpinBox {{
            background-color: rgba(21, 25, 43, 0.8);
            border: 1px solid #333;
            border-bottom: 2px solid {neon_cyan};
            border-radius: 4px;
            padding: 4px;
            color: white;
            selection-background-color: {neon_pink};
            selection-color: white;
        }}
        QLineEdit:focus, QComboBox:focus {{
            border-bottom: 2px solid {neon_pink};
            background-color: rgba(30, 35, 60, 0.9);
        }}
        QPushButton {{
            background-color: rgba(0, 243, 255, 0.1);
            border: 1px solid {neon_cyan};
            border-radius: 6px;
            color: {neon_cyan};
            padding: 6px 15px;
            font-weight: bold;
        }}
        QPushButton:hover {{
            background-color: {neon_cyan};
            color: {dark_bg};
            box-shadow: 0 0 10px {neon_cyan};
        }}
        QPushButton:pressed {{
            background-color: {neon_pink};
            border-color: {neon_pink};
            color: white;
        }}
        QHeaderView::section {{
            background-color: {dark_panel};
            color: {neon_cyan};
            border: 1px solid #333;
            padding: 5px;
        }}
        QTableWidget {{
            gridline-color: #333;
            background-color: rgba(21, 25, 43, 0.5);
            alternate-background-color: rgba(30, 35, 60, 0.5);
        }}
        QTableWidget::item:selected {{
            background-color: rgba(0, 243, 255, 0.2);
            border: 1px solid {neon_cyan};
            color: white;
        }}
        QScrollBar:vertical {{
            background: {dark_bg};
            width: 10px;
        }}
        QScrollBar::handle:vertical {{
            background: {neon_cyan};
            border-radius: 5px;
        }}
    """)



def set_desert_sunset_theme(app):
    """Ø«ÙŠÙ… ØºØ±ÙˆØ¨ Ø§Ù„ØµØ­Ø±Ø§Ø¡: Ù†Ø³Ø®Ø© Ù…Ø¹Ø¯Ù„Ø© (Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© + Ø®Ø· Ø¯Ø§ÙƒÙ†) Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."""
    app.setStyle("Fusion")
    pal = QtGui.QPalette()
    
    # Ø£Ù„ÙˆØ§Ù† Ø¯Ø§ÙØ¦Ø© ÙØ§ØªØ­Ø© Ù„Ù„Ø®Ù„ÙÙŠØ©ØŒ ÙˆØ¯Ø§ÙƒÙ†Ø© Ù„Ù„Ù†ØµÙˆØµ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„ØªØ§Ù…
    dark_purple = QtGui.QColor(53, 3, 79)
    warm_white = QtGui.QColor(255, 250, 245)
    
    pal.setColor(QtGui.QPalette.Window, warm_white)
    pal.setColor(QtGui.QPalette.WindowText, dark_purple)
    pal.setColor(QtGui.QPalette.Base, QtGui.QColor(255, 255, 255))
    pal.setColor(QtGui.QPalette.AlternateBase, QtGui.QColor(255, 243, 224))
    pal.setColor(QtGui.QPalette.Text, dark_purple)
    pal.setColor(QtGui.QPalette.Button, QtGui.QColor(255, 224, 178))
    pal.setColor(QtGui.QPalette.ButtonText, dark_purple)
    pal.setColor(QtGui.QPalette.Highlight, QtGui.QColor(199, 62, 29))
    pal.setColor(QtGui.QPalette.HighlightedText, QtGui.QColor(255, 255, 255))
    pal.setColor(QtGui.QPalette.PlaceholderText, QtGui.QColor(128, 128, 128))
    
    app.setPalette(pal)
    
    app.setStyleSheet("""
        QMainWindow, QDialog {
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #FFE0B2, stop:1 #FFF8F0);
        }
        QWidget {
            color: #35034F;
        }
        QLabel, QCheckBox, QRadioButton, QGroupBox {
            color: #35034F;
        }
        QGroupBox {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid #C73E1D;
            border-radius: 8px;
            margin-top: 10px;
        }
        QGroupBox::title {
            background-color: #C73E1D;
            color: white;
            border-radius: 4px;
            padding: 2px 8px;
            subcontrol-origin: margin;
            left: 10px;
        }
        QLineEdit, QComboBox, QDateEdit, QSpinBox {
            border: 2px solid #F18F01;
            border-radius: 5px;
            padding: 4px;
            background-color: white;
            color: #35034F;
        }
        QLineEdit:focus, QComboBox:focus, QDateEdit:focus, QSpinBox:focus {
            border-color: #35034F;
        }
        QPushButton {
            background-color: #F18F01;
            color: #35034F;
            border: none;
            border-radius: 4px;
            padding: 6px 15px;
            font-weight: bold;
        }
        QPushButton:hover {
            background-color: #FFB347;
            color: #35034F;
        }
        QPushButton:pressed {
            background-color: #C73E1D;
            color: white;
        }
        QTableWidget {
            background-color: white;
            alternate-background-color: #FFF3E0;
            color: #35034F;
        }
        QHeaderView::section {
            background-color: #35034F;
            color: #F18F01;
            padding: 5px;
        }
        QTabWidget::pane {
            border: 1px solid #C73E1D;
            background: white;
        }
        QTabBar::tab {
            background: #FFE0B2;
            color: #35034F;
            padding: 8px 12px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            margin-right: 2px;
        }
        QTabBar::tab:selected {
            background: #C73E1D;
            color: white;
        }
    """)


def set_light_theme(app):
    app.setStyle("Fusion")
    pal = QtGui.QPalette()
    pal.setColor(QtGui.QPalette.Window, QtGui.QColor(245, 245, 245))
    pal.setColor(QtGui.QPalette.WindowText, QtCore.Qt.black)
    pal.setColor(QtGui.QPalette.Base, QtGui.QColor(255, 255, 255))
    pal.setColor(QtGui.QPalette.AlternateBase, QtGui.QColor(245, 245, 245))
    pal.setColor(QtGui.QPalette.ToolTipBase, QtCore.Qt.black)
    pal.setColor(QtGui.QPalette.ToolTipText, QtCore.Qt.black)
    pal.setColor(QtGui.QPalette.Text, QtCore.Qt.black)
    pal.setColor(QtGui.QPalette.Button, QtGui.QColor(240, 240, 240))
    pal.setColor(QtGui.QPalette.ButtonText, QtCore.Qt.black)
    pal.setColor(QtGui.QPalette.BrightText, QtCore.Qt.red)
    pal.setColor(QtGui.QPalette.Link, QtGui.QColor(0, 120, 215))
    pal.setColor(QtGui.QPalette.Highlight, QtGui.QColor(0, 120, 215))
    pal.setColor(QtGui.QPalette.HighlightedText, QtCore.Qt.white)
    pal.setColor(QtGui.QPalette.PlaceholderText, QtGui.QColor(128, 128, 128))
    app.setPalette(pal)


def set_colorful_theme(app):
    app.setStyle("Fusion")
    pal = QtGui.QPalette()
    # Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ù…ØªÙ†Ø§ØºÙ…Ø©: Ø¯Ø±Ø¬Ø§Øª ÙƒØ­Ù„ÙŠ Ù…Ø¹ Ù„Ù…Ø³Ø© ØªØ±ÙƒÙˆØ§Ø²
    pal.setColor(QtGui.QPalette.Window, QtGui.QColor(31, 36, 48))            # Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†ÙˆØ§ÙØ°
    pal.setColor(QtGui.QPalette.WindowText, QtCore.Qt.white)
    pal.setColor(QtGui.QPalette.Base, QtGui.QColor(32, 37, 51))              # ØµÙÙˆÙ Ø£Ø³Ø§Ø³
    pal.setColor(QtGui.QPalette.AlternateBase, QtGui.QColor(37, 43, 60))     # ØµÙÙˆÙ Ù…ØªÙ†Ø§ÙˆØ¨Ø©
    pal.setColor(QtGui.QPalette.ToolTipBase, QtCore.Qt.white)
    pal.setColor(QtGui.QPalette.ToolTipText, QtCore.Qt.black)
    pal.setColor(QtGui.QPalette.Text, QtCore.Qt.white)
    pal.setColor(QtGui.QPalette.Button, QtGui.QColor(43, 49, 69))
    pal.setColor(QtGui.QPalette.ButtonText, QtCore.Qt.white)
    pal.setColor(QtGui.QPalette.BrightText, QtCore.Qt.red)
    # Ù„ÙˆÙ† Ø§Ù„ØªÙ…ÙŠÙŠØ² ÙˆØ±ÙˆØ§Ø¨Ø· Ø¨Ù„ÙˆÙ† ØªØ±ÙƒÙˆØ§Ø² Ù…ØªÙ†Ø§ØºÙ…
    pal.setColor(QtGui.QPalette.Link, QtGui.QColor(0, 178, 169))
    pal.setColor(QtGui.QPalette.Highlight, QtGui.QColor(0, 178, 169))
    pal.setColor(QtGui.QPalette.HighlightedText, QtCore.Qt.white)
    pal.setColor(QtGui.QPalette.PlaceholderText, QtGui.QColor(170, 175, 185))
    app.setPalette(pal)



def apply_theme(app, name):
    name = (name or "colorful").lower()
    
    # 1. Reset global stylesheet
    app.setStyleSheet("")
    
    # 2. Apply theme (Palette + Style)
    if name in ("dark", "Ø¯Ø§ÙƒÙ†"):
        set_dark_theme(app)
    elif name in ("light", "ÙØ§ØªØ­"):
        set_light_theme(app)
    elif name in ("colorful", "Ù…Ù„ÙˆÙ†"):
        set_colorful_theme(app)
    elif name in ("royal", "Ù…Ù„ÙƒÙŠ"):
        set_royal_theme(app)
    elif name in ("cyberpunk", "Ø³Ø§ÙŠØ¨Ø±Ø¨Ø§Ù†Ùƒ"):
        set_cyberpunk_theme(app)
    elif name in ("desert_sunset", "ØºØ±ÙˆØ¨ Ø§Ù„ØµØ­Ø±Ø§Ø¡"):
        set_desert_sunset_theme(app)
    else:
        set_colorful_theme(app)
    
    # 3. Force refresh of all widgets to prevent artifacts
    # This ensures the new palette/style is applied everywhere immediately
    style = app.style()
    for widget in QtWidgets.QApplication.topLevelWidgets():
        style.unpolish(widget)
        style.polish(widget)
        widget.update()



def _filter_near(self):
    """Badge click: filter status to 'Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' (toggle)."""
    try:
        if self.cmb_status.currentText() == "Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡":
            self.cmb_status.setCurrentIndex(0)  # Ø§Ù„ÙƒÙ„
        else:
            idx = self.cmb_status.findText("Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡")
            if idx >= 0:
                self.cmb_status.setCurrentIndex(idx)
    except Exception:
        pass
    self.refresh()
    # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
    if not getattr(self, "_splash_shown_once", False):
        try:
            _logo = _read_brand_logo_path()
        except Exception:
            _logo = ""
        try:
            self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
            self._embedded_splash.show()
            self._embedded_splash.raise_()
        except Exception:
            self._embedded_splash = None
        self._splash_shown_once = True


def _filter_exp(self):
    """Badge click: filter status to 'Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯' (toggle)."""
    try:
        target = "Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯"
        if self.cmb_status.currentText() == target:
            self.cmb_status.setCurrentIndex(0)  # Ø§Ù„ÙƒÙ„
        else:
            idx = self.cmb_status.findText(target)
            if idx >= 0:
                self.cmb_status.setCurrentIndex(idx)
    except Exception:
        pass
    self.refresh()
    # --- Embedded Splash once at startup (covers entire window) for 5 seconds ---
    if not getattr(self, "_splash_shown_once", False):
        try:
            _logo = _read_brand_logo_path()
        except Exception:
            _logo = ""
        try:
            self._embedded_splash = _EmbeddedSplash(self, _logo, 5000)
            self._embedded_splash.show()
            self._embedded_splash.raise_()
        except Exception:
            self._embedded_splash = None
        self._splash_shown_once = True


def load_column_settings(self):
    s = QtCore.QSettings("GuaranteesApp", "Main")
    order = s.value("columns/order", type=list)
    hidden_by_name = s.value("columns/hidden_by_name", type=dict)
    if order is None:
        order = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
    if not isinstance(hidden_by_name, dict):
        hidden_by_name = {}
    # Ensure keys are strings
    hidden_by_name = {str(k): bool(int(v)) if isinstance(v, (str, int)) else bool(v) for k, v in hidden_by_name.items()}
    return order, hidden_by_name


def save_column_settings(self, order, hidden_by_name):
    s = QtCore.QSettings("GuaranteesApp", "Main")
    s.setValue("columns/order", order)
    hidden_str = {str(k): int(bool(v)) for k, v in hidden_by_name.items()}
    s.setValue("columns/hidden_by_name", hidden_str)


def apply_column_settings(self, order, hidden_by_name):
    header = self.table.horizontalHeader()
    try:
        header.setSectionsMovable(True)
    except Exception:
        pass
    # Helper: rebuild name -> logical index map each iteration
    def _build_map():
        m = {}
        for i in range(self.table.columnCount()):
            it = self.table.horizontalHeaderItem(i)
            nm = (it.text().strip() if it else f"col_{i}")
            m[nm] = i
        return m
    # Robust reordering
    try:
        self.table.setUpdatesEnabled(False)
        header.blockSignals(True)
        for desired_visual, name in enumerate(order):
            name_to_logical = _build_map()
            if name not in name_to_logical:
                continue
            logical = name_to_logical[name]
            current_visual = header.visualIndex(logical)
            if current_visual != desired_visual and current_visual != -1:
                header.moveSection(current_visual, desired_visual)
    finally:
        try:
            header.blockSignals(False)
            self.table.setUpdatesEnabled(True)
        except Exception:
            pass
    # Show/hide by NAME
    for i in range(self.table.columnCount()):
        try:
            name = (self.table.horizontalHeaderItem(i).text() or "").strip()
            self.table.setColumnHidden(i, bool(hidden_by_name.get(name, False)))
        except Exception:
            pass
    # keep the always-hidden internal column 16 hidden
    try:
        self.table.setColumnHidden(16, True)
    except Exception:
        pass
    # Ø·Ø¨Ù‘Ù‚ Ù†ÙØ³ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ£Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯
    try:
        if getattr(self, 'table_cash', None):
            ch = self.table_cash.horizontalHeader()
            ch.setSectionResizeMode(QtWidgets.QHeaderView.Interactive)
            # Ø®Ø±ÙŠØ·Ø© Ø§Ø³Ù… -> Ø¹Ø±Ø¶ ÙˆØ§Ø³Ù… -> Ø¥Ø®ÙØ§Ø¡
            name_to_width = {}
            for i in range(self.table.columnCount()):
                it = self.table.horizontalHeaderItem(i)
                nm = (it.text().strip() if it else f"col_{i}")
                name_to_width[nm] = int(self.table.columnWidth(i))
            for i in range(self.table_cash.columnCount()):
                it = self.table_cash.horizontalHeaderItem(i)
                nm = (it.text().strip() if it else f"col_{i}")
                try:
                    self.table_cash.setColumnHidden(i, bool(hidden_by_name.get(nm, False)))
                except Exception:
                    pass
                if nm in name_to_width:
                    try:
                        self.table_cash.setColumnWidth(i, int(name_to_width[nm]))
                    except Exception:
                        pass
            try:
                self.table_cash.setColumnHidden(16, True)
            except Exception:
                pass
    except Exception:
        pass
    # Header context menus for alignment (Excel-like)
    try:
        hh = self.table.horizontalHeader()
        self._uniform_col_from_header = False
        self._uniform_row_from_header = False
        hh.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
        hh.customContextMenuRequested.connect(self.show_header_menu)
        hh.sectionDoubleClicked.connect(self._cycle_alignment)
        hh.sectionResized.connect(self._uniform_col_width)
        hh.installEventFilter(self)
        vh = self.table.verticalHeader()
        vh.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
        vh.customContextMenuRequested.connect(self.show_row_header_menu)
        vh.sectionDoubleClicked.connect(self._cycle_alignment)
        vh.sectionResized.connect(self._uniform_row_height)
        vh.installEventFilter(self)
        try:
            self._sync_cash_columns()
        except Exception:
            pass

    except Exception:
        pass


def show_column_settings(self):
    headers = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
    _, hidden_by_name = self.load_column_settings()
    dlg = ColumnSettingsDialog(self, headers, hidden_by_name)
    if dlg.exec_() == QtWidgets.QDialog.Accepted:
        order, hidden_new = dlg.result_config()
        self.save_column_settings(order, hidden_new)
        self.apply_column_settings(order, hidden_new)


def apply_alignment(self, where: str):
    # where in {"right","center","left"}; save to settings and apply to ALL cells (like Excel)
    cfg = self.load_font_settings()
    cfg["align"] = "right" if where == "right" else ("center" if where == "center" else "left")
    self.save_font_settings(cfg)
    self.apply_font_settings(cfg)


def _alignment_menu(self, global_pos):
    m = QtWidgets.QMenu(self)
    a_r = m.addAction("Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†")
    a_c = m.addAction("Ù…Ø­Ø§Ø°Ø§Ø© ÙˆØ³Ø·")
    a_l = m.addAction("Ù…Ø­Ø§Ø°Ø§Ø© ÙŠØ³Ø§Ø±")
    act = m.exec_(global_pos)
    if act == a_r:
        self.apply_alignment("right")
    elif act == a_c:
        self.apply_alignment("center")
    elif act == a_l:
        self.apply_alignment("left")


def show_header_menu(self, pos):
    # Horizontal header menu (align whole table)
    header = self.table.horizontalHeader()
    self._alignment_menu(header.mapToGlobal(pos))


def show_row_header_menu(self, pos):
    # Vertical header menu (align whole table as well)
    vheader = self.table.verticalHeader()
    self._alignment_menu(vheader.mapToGlobal(pos))


def _cycle_alignment(self, *_):
    # Determine current, then cycle Right -> Center -> Left -> Right
    try:
        cfg = self.load_font_settings()
    except Exception:
        cfg = {"align": "right"}
    cur = (cfg.get("align") or "right").lower()
    nxt = "center" if cur == "right" else ("left" if cur == "center" else "right")
    cfg["align"] = nxt
    self.save_font_settings(cfg)
    self.apply_font_settings(cfg)
    # Optional toast
    try:
        QtWidgets.QToolTip.showText(QtGui.QCursor.pos(),
                                    f"ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©: { {'right': 'ÙŠÙ…ÙŠÙ†', 'center': 'ÙˆØ³Ø·', 'left': 'ÙŠØ³Ø§Ø±'}[nxt]}")
    except Exception:
        pass


def _uniform_col_width(self, logical, old, new):
    """Apply to ALL columns only if resize started from header; otherwise leave default (affects one column).
    Guard against spurious tiny resizes during setup.
    """
    try:
        if new is None or int(new) < 40 or abs(int(new) - int(old or 0)) < 2:
            return
        if not getattr(self, '_uniform_col_from_header', False):
            return  # user resized elsewhere â†’ do not propagate
        cols = self.table.columnCount()
        for c in range(cols):
            if self.table.isColumnHidden(c):
                continue
            self.table.setColumnWidth(c, int(new))
    except Exception:
        pass


def _uniform_row_height(self, logical, old, new):
    """Apply to ALL rows only if resize started from header; otherwise affect the single row.
    Guard against spurious tiny resizes during setup.
    """
    try:
        if new is None or int(new) < 20 or abs(int(new) - int(old or 0)) < 2:
            return
        if not getattr(self, '_uniform_row_from_header', False):
            return
        rows = self.table.rowCount()
        for r in range(rows):
            self.table.setRowHeight(r, int(new))
    except Exception:
        pass


def eventFilter(self, obj, event):
    # Detect mouse press/release on table headers to enable uniform resize propagation (Excel-like)
    try:
        et = event.type()
        hh = self.table.horizontalHeader()
        vh = self.table.verticalHeader()
        if obj is hh or obj is vh:
            if et == QtCore.QEvent.MouseButtonPress:
                if obj is hh:
                    self._uniform_col_from_header = True
                else:
                    self._uniform_row_from_header = True
            elif et == QtCore.QEvent.MouseButtonRelease:
                if obj is hh:
                    self._uniform_col_from_header = False
                else:
                    self._uniform_row_from_header = False
    except Exception:
        pass
    return QtWidgets.QMainWindow.eventFilter(self, obj, event)


def export_excel(self):
    """
    ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:
    - Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    - Ø¯Ø¹Ù… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
    - Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØ¹Ù„Ø©
    - ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©ØŒ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙÙˆÙØŒ ÙˆØªØ¬Ù…ÙŠØ¯ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
    """
    try:
        dlg = PrintPreviewDialog(self)
        dlg._export_excel_from_preview()
    except Exception:
        try:
            QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", "ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° ØªØµØ¯ÙŠØ± Excel Ø¹Ø¨Ø± Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.")
        except Exception:
            pass
        return


# ---- Bind free functions as class methods (to ensure signals can find them) ----
# MainWindow.clear_filters = clear_filters
# MainWindow.do_import = do_import
# MainWindow.load_font_settings = load_font_settings
# MainWindow.save_font_settings = save_font_settings
# MainWindow.apply_font_settings = apply_font_settings
# MainWindow.show_font_settings = show_font_settings
# MainWindow.on_align_change = on_align_change
# MainWindow.mark_selected_as_done = mark_selected_as_done
# MainWindow.unmark_selected_done = unmark_selected_done
# MainWindow.add_guarantee = add_guarantee
# MainWindow.edit_selected_guarantee = edit_selected_guarantee
# Methods now part of MainWindow class structure
# MainWindow._filter_near = _filter_near
# MainWindow._filter_exp = _filter_exp
# MainWindow.load_column_settings = load_column_settings
# MainWindow.save_column_settings = save_column_settings
# MainWindow.apply_column_settings = apply_column_settings
# MainWindow.show_column_settings = show_column_settings
# MainWindow.show_date_settings = show_date_settings
# MainWindow.apply_alignment = apply_alignment
# MainWindow._alignment_menu = _alignment_menu
# MainWindow.show_header_menu = show_header_menu
# MainWindow.show_row_header_menu = show_row_header_menu
# MainWindow._cycle_alignment = _cycle_alignment
# MainWindow._uniform_col_width = _uniform_col_width
# MainWindow._uniform_row_height = _uniform_row_height
# MainWindow.eventFilter = eventFilter


def load_brand_settings(self):
    s = QtCore.QSettings("GuaranteesApp", "Main")
    return {"wm_enabled": bool(int(s.value("watermark/enabled", 0) or 0)),
            "wm_path": s.value("watermark/path", type=str) or "",
            "wm_opacity": float(s.value("watermark/opacity", 0.08) or 0.08),
            "wm_scale": float(s.value("watermark/scale", 0.40) or 0.40),
            "logo_enabled": bool(int(s.value("logo/enabled", 1) or 1)),
            "logo_path": s.value("logo/path", type=str) or (s.value("watermark/path", type=str) or ""),
            "logo_height": int(s.value("logo/height", 48) or 48),
            "app_icon_enabled": bool(int(s.value("logo/appIconEnabled", 1) or 1)),
            "app_banner_enabled": bool(int(s.value("logo/appBannerEnabled", 1) or 1)),
            "app_banner_height": int(s.value("logo/appBannerHeight", 28) or 28)}


def apply_brand_settings(self):
    cfg = load_brand_settings(self)
    try:
        if getattr(self, "_wm_overlay", None):
            self._wm_overlay.set_config(path=cfg["wm_path"], enabled=cfg["wm_enabled"],
                                        opacity=cfg["wm_opacity"], scale=cfg["wm_scale"])
    except Exception:
        pass


def ensure_brand_defaults_enabled(self):
    s = QtCore.QSettings("GuaranteesApp", "Main")
    try:
        # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        s.setValue("watermark/enabled", 1)
        s.setValue("watermark/path", ":/assets/watermark.png")
        s.setValue("watermark/opacity", 0.10)
        s.setValue("watermark/scale", 0.40)

        # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        s.setValue("logo/enabled", 1)
        s.setValue("logo/path", ":/assets/logo.png")
        s.setValue("logo/height", 48)
        s.setValue("logo/appIconEnabled", 1)
        s.setValue("logo/appBannerEnabled", 1)
        s.setValue("logo/appBannerHeight", 22)
    except Exception:
        pass
    


def _print_with_branding(self, printer):
    # Ù†Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    doc = QtGui.QTextDocument()
    row_cnt = self.table.rowCount()
    html = "<h3>ØªÙ‚Ø±ÙŠØ± Ø¨Ø³ÙŠØ·</h3><table border='1' width='100%'><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>"
    for r in range(row_cnt):
        try:
            gno = self.table.item(r, 2).text()
            st = self.table.item(r, 13).text()
        except Exception:
            gno, st = "", ""
        html += f"<tr><td>{gno}</td><td>{st}</td></tr>"
    if row_cnt == 0:
        html += "<tr><td colspan='2' style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>"
    html += "</table>"
    doc.setHtml(html)

    cfg = load_brand_settings(self)
    painter = QtGui.QPainter(printer)

    # Ø³ÙŠØªÙ… Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§.

    # Ø´Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    y_offset = 0
    if cfg.get("logo_enabled") and cfg.get("logo_path"):
        lp = QtGui.QPixmap(cfg["logo_path"])
        if not lp.isNull():
            h = max(16, int(cfg.get("logo_height", 48)))
            lp2 = lp.scaledToHeight(h, QtCore.Qt.SmoothTransformation)
            painter.drawPixmap(30, 30, lp2)
            y_offset = 30 + lp2.height() + 10

    # Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙˆØ­Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (Points) Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³
    rect_pt = printer.pageRect(QtPrintSupport.QPrinter.Point)
    doc.setPageSize(QtCore.QSizeF(rect_pt.size()))

    # Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø®Ù„ Ù‡ÙˆØ§Ù…Ø´ Ø¨Ø³ÙŠØ·Ø©ØŒ Ø¯ÙˆÙ† Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ø¥Ø²Ø§Ø­Ø©
    content = QtCore.QRectF(rect_pt)
    content.adjust(30, y_offset + 10, -30, -30)
    painter.save()
    doc.drawContents(painter, content)
    painter.restore()

    # Watermark (ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰)
    if cfg.get("wm_enabled") and cfg.get("wm_path"):
        pm = QtGui.QPixmap(cfg["wm_path"])
        if not pm.isNull():
            vp = painter.viewport()
            size = int(min(vp.width(), vp.height()) * float(cfg.get("wm_scale", 0.40)))
            pm2 = pm.scaled(size, size, QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation)
            painter.save()
            painter.setOpacity(float(cfg.get("wm_opacity", 0.08)))
            # Ø§Ù„Ø±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¶Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø­ØªÙ‰ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
            painter.drawPixmap(vp.x() + (vp.width() - pm2.width()) // 2,
                               vp.y() + (vp.height() - pm2.height()) // 2, pm2)
            painter.restore()
    painter.end()


def eventFilter(self, obj, event):
    try:
        if (obj is self.table.viewport()) and getattr(self, "_wm_overlay", None):
            if event.type() in (QtCore.QEvent.Resize, QtCore.QEvent.Show):
                self._wm_overlay.setGeometry(obj.rect())
    except Exception:
        pass
    return QtWidgets.QMainWindow.eventFilter(self, obj, event)


# =======================
# Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙˆØ­Ù‘Ø¯Ø©
# =======================


def save_all_settings(self):
    """Ø­ÙØ¸ ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ± ØºÙŠØ± Ù…Ø²Ø¹Ø¬."""
    try:
        # Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
        try:
            save_table_geometry(self)
        except Exception:
            pass
        # Ø­ÙØ¸ ØªØ±ØªÙŠØ¨/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        try:
            order = [self.table.horizontalHeaderItem(i).text() for i in range(self.table.columnCount())]
            hidden_by_name = {}
            for i in range(self.table.columnCount()):
                nm = self.table.horizontalHeaderItem(i).text()
                hidden_by_name[nm] = bool(self.table.isColumnHidden(i))
            if hasattr(self, "save_column_settings"):
                self.save_column_settings(order, hidden_by_name)
        except Exception:
            pass
        # Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ± + Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
        try:
            if hasattr(self, "statusBar") and self.statusBar():
                self.statusBar().showMessage("ØªÙ… Ø§Ù„Ø­ÙØ¸", 2000)
            if hasattr(self, "show_toast"):
                self.show_toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
        except Exception:
            pass
    except Exception as e:
        try:
            QtWidgets.QMessageBox.critical(self, "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸: {e}")
        except Exception:
            pass



# --- Patch: Bind standalone functions to MainWindow ---
# MainWindow._export_all_sections_excel = _export_all_sections_excel
# MainWindow.load_font_settings = load_font_settings
# MainWindow.save_font_settings = save_font_settings
# MainWindow.apply_font_settings = apply_font_settings
# MainWindow.show_font_settings = show_font_settings
# MainWindow.on_align_change = on_align_change
# MainWindow._confirm_mark_selected_done = _confirm_mark_selected_done
# MainWindow.mark_selected_as_done = mark_selected_as_done
# MainWindow._show_table_menu = _show_table_menu
# MainWindow._confirm_unmark_selected_done = _confirm_unmark_selected_done
# MainWindow._confirm_delete_selected = _confirm_delete_selected
# MainWindow.delete_selected_guarantees = delete_selected_guarantees
# MainWindow.unmark_selected_done = unmark_selected_done
# MainWindow._confirm_set_selected_auto_status = _confirm_set_selected_auto_status
# MainWindow.set_selected_auto_status = set_selected_auto_status
# MainWindow.add_guarantee = add_guarantee
# MainWindow.edit_selected_guarantee = edit_selected_guarantee
# Methods now part of MainWindow class structure
MainWindow._filter_near = _filter_near
MainWindow._filter_exp = _filter_exp
MainWindow.load_column_settings = load_column_settings
MainWindow.save_column_settings = save_column_settings
MainWindow.apply_column_settings = apply_column_settings
MainWindow.show_column_settings = show_column_settings
MainWindow.apply_alignment = apply_alignment
MainWindow._alignment_menu = _alignment_menu
MainWindow.show_header_menu = show_header_menu
MainWindow.show_row_header_menu = show_row_header_menu
MainWindow._cycle_alignment = _cycle_alignment
MainWindow._uniform_col_width = _uniform_col_width
MainWindow._uniform_row_height = _uniform_row_height
MainWindow.eventFilter = eventFilter
MainWindow.export_excel = export_excel
MainWindow.load_brand_settings = load_brand_settings
MainWindow.apply_brand_settings = apply_brand_settings
MainWindow.ensure_brand_defaults_enabled = ensure_brand_defaults_enabled
MainWindow._print_with_branding = _print_with_branding
MainWindow.save_all_settings = save_all_settings

class SettingsDialog(QtWidgets.QDialog):
    def __init__(self, parent):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬")
        self.resize(720, 500)

        tabs = QtWidgets.QTabWidget(self)
        tabs.setTabPosition(QtWidgets.QTabWidget.North)

        # --- Ø¹Ø§Ù… (Ù…Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ù…Ø¸Ù‡Ø±) ---
        pg_general = QtWidgets.QWidget();
        v_general = QtWidgets.QVBoxLayout(pg_general)
        
        # Date settings section
        try:
            grp_date = QtWidgets.QGroupBox("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®")
            date_layout = QtWidgets.QFormLayout(grp_date)
            btn_date = QtWidgets.QPushButton("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®â€¦")
            btn_date.clicked.connect(parent.show_date_settings)
            date_layout.addRow(btn_date)
            v_general.addWidget(grp_date)
        except Exception:
            pass
        
        # Appearance settings section (merged from pg_view)
        try:
            grp_theme = QtWidgets.QGroupBox("Ø³Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚")
            ft = QtWidgets.QFormLayout(grp_theme)
            self._cmb_theme = QtWidgets.QComboBox(); self._cmb_theme.addItems(["Ø¯Ø§ÙƒÙ†", "ÙØ§ØªØ­", "Ù…Ù„ÙˆÙ†", "Ù…Ù„ÙƒÙŠ", "Ø³Ø§ÙŠØ¨Ø±Ø¨Ø§Ù†Ùƒ", "ØºØ±ÙˆØ¨ Ø§Ù„ØµØ­Ø±Ø§Ø¡"])
            s = QtCore.QSettings("GuaranteesApp", "Main")
            _cur = (s.value("theme/name", "dark") or "dark").lower()
            if _cur in ("dark", "Ø¯Ø§ÙƒÙ†"):
                self._cmb_theme.setCurrentIndex(0)
            elif _cur in ("light", "ÙØ§ØªØ­"):
                self._cmb_theme.setCurrentIndex(1)
            elif _cur in ("colorful", "Ù…Ù„ÙˆÙ†"):
                self._cmb_theme.setCurrentIndex(2)
            elif _cur in ("royal", "Ù…Ù„ÙƒÙŠ"):
                self._cmb_theme.setCurrentIndex(3)
            elif _cur in ("cyberpunk", "Ø³Ø§ÙŠØ¨Ø±Ø¨Ø§Ù†Ùƒ"):
                self._cmb_theme.setCurrentIndex(4)
            elif _cur in ("desert_sunset", "ØºØ±ÙˆØ¨ Ø§Ù„ØµØ­Ø±Ø§Ø¡"):
                self._cmb_theme.setCurrentIndex(5)
            else:
                self._cmb_theme.setCurrentIndex(0)
            
            ft.addRow("Ø§Ù„Ø«ÙŠÙ…:", self._cmb_theme)
            btns_theme = QtWidgets.QHBoxLayout()
            _btn_apply_theme = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…")
            _btn_save_theme = QtWidgets.QPushButton("Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…")
            def _read_theme_name():
                idx = self._cmb_theme.currentIndex()
                if idx == 0: return "dark"
                if idx == 1: return "light"
                if idx == 2: return "colorful"
                if idx == 3: return "royal"
                if idx == 4: return "cyberpunk"
                if idx == 5: return "desert_sunset"
                return "dark"
            _btn_apply_theme.clicked.connect(lambda: apply_theme(QtWidgets.QApplication.instance(), _read_theme_name()))
            def _save_and_apply():
                name = _read_theme_name()
                s = QtCore.QSettings("GuaranteesApp", "Main")
                s.setValue("theme/name", name)
                apply_theme(QtWidgets.QApplication.instance(), name)
            _btn_save_theme.clicked.connect(_save_and_apply)
            btns_theme.addWidget(_btn_apply_theme); btns_theme.addWidget(_btn_save_theme); btns_theme.addStretch(1)
            v_general.addWidget(grp_theme)
            v_general.addLayout(btns_theme)
        except Exception:
            pass
        # Font settings section
        try:
            cfg = parent.load_font_settings()
            form = QtWidgets.QFormLayout()
            # App font
            self._fc_app = QtWidgets.QFontComboBox();
            try:
                self._fc_app.setCurrentFont(QtGui.QFont(cfg["appFamily"]))
            except Exception:
                pass
            self._sp_app = QtWidgets.QSpinBox(); self._sp_app.setRange(6, 48); self._sp_app.setValue(int(cfg["appSize"]))
            form.addRow("Ø®Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", self._fc_app)
            form.addRow("Ø­Ø¬Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", self._sp_app)
            # Header font
            self._fc_head = QtWidgets.QFontComboBox();
            try:
                self._fc_head.setCurrentFont(QtGui.QFont(cfg["headerFamily"]))
            except Exception:
                pass
            self._sp_head = QtWidgets.QSpinBox(); self._sp_head.setRange(6, 48); self._sp_head.setValue(int(cfg["headerSize"]))
            self._chk_head_bold = QtWidgets.QCheckBox("Ø¹Ø±ÙŠØ¶")
            self._chk_head_bold.setChecked(bool(cfg.get("headerBold")))
            form.addRow("Ø®Ø· Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:", self._fc_head)
            form.addRow("Ø­Ø¬Ù… Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:", self._sp_head)
            form.addRow("Ø³ÙÙ…Ùƒ Ø§Ù„Ø±Ø£Ø³:", self._chk_head_bold)
            # Body font
            self._fc_body = QtWidgets.QFontComboBox();
            try:
                self._fc_body.setCurrentFont(QtGui.QFont(cfg["bodyFamily"]))
            except Exception:
                pass
            self._sp_body = QtWidgets.QSpinBox(); self._sp_body.setRange(6, 48); self._sp_body.setValue(int(cfg["bodySize"]))
            form.addRow("Ø®Ø· Ø§Ù„Ø¬Ø³Ù… (Ø§Ù„Ø®Ù„Ø§ÙŠØ§):", self._fc_body)
            form.addRow("Ø­Ø¬Ù… Ø§Ù„Ø¬Ø³Ù…:", self._sp_body)
            # Alignment
            self._cmb_align = QtWidgets.QComboBox(); self._cmb_align.addItems(["ÙŠÙ…ÙŠÙ†","ÙˆØ³Ø·","ÙŠØ³Ø§Ø±"])
            _al = (cfg.get("align") or "right")
            self._cmb_align.setCurrentIndex(0 if _al=="right" else (1 if _al=="center" else 2))
            form.addRow("Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ:", self._cmb_align)
            # Apply/Save
            btns_font = QtWidgets.QHBoxLayout()
            _btn_apply_font = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚")
            _btn_save_font = QtWidgets.QPushButton("Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚")
            def _read_font_cfg():
                return {
                    "appFamily": self._fc_app.currentFont().family(),
                    "appSize": int(self._sp_app.value()),
                    "headerFamily": self._fc_head.currentFont().family(),
                    "headerSize": int(self._sp_head.value()),
                    "headerBold": bool(self._chk_head_bold.isChecked()),
                    "bodyFamily": self._fc_body.currentFont().family(),
                    "bodySize": int(self._sp_body.value()),
                    "align": ("right" if self._cmb_align.currentIndex()==0 else ("center" if self._cmb_align.currentIndex()==1 else "left")),
                }
            _btn_apply_font.clicked.connect(lambda: parent.apply_font_settings(_read_font_cfg()))
            _btn_save_font.clicked.connect(lambda: (parent.save_font_settings(_read_font_cfg()), parent.apply_font_settings(_read_font_cfg())))
            btns_font.addWidget(_btn_apply_font); btns_font.addWidget(_btn_save_font); btns_font.addStretch(1)
            
            grp_font = QtWidgets.QGroupBox("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·")
            grp_font.setLayout(form)
            v_general.addWidget(grp_font)
            v_general.addLayout(btns_font)
        except Exception:
            pass
        
        # Toolbar settings section
        try:
            btn_align_menu = QtWidgets.QPushButton("Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ø§Ø°Ø§Ø© Ø³Ø±ÙŠØ¹Ø©â€¦")
            btn_align_menu.clicked.connect(lambda: parent._alignment_menu(QtGui.QCursor.pos()))
            v_general.addWidget(btn_align_menu)
        except Exception:
            pass
        try:
            btn_toolbar = QtWidgets.QPushButton("Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠâ€¦")
            btn_toolbar.clicked.connect(lambda: show_toolbar_buttons_settings(parent))
            v_general.addWidget(btn_toolbar)
        except Exception:
            pass

        # Print settings section
        try:
            grp_print = QtWidgets.QGroupBox("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
            print_layout = QtWidgets.QFormLayout(grp_print)
            
            # --- Printer Selection ---
            self._cmb_printer = QtWidgets.QComboBox()
            # Add "System Default" option first
            self._cmb_printer.addItem("Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…", "")
            
            # List all available printers
            available_printers = QtPrintSupport.QPrinterInfo.availablePrinterNames()
            for p_name in available_printers:
                self._cmb_printer.addItem(p_name, p_name)
                
            self._cmb_printer.setToolTip("Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬")
            
            # --- Duplex Selection ---
            self._cmb_duplex = QtWidgets.QComboBox()
            self._cmb_duplex.addItems(["Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ (Simplex)", "Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ÙŠÙ† - Ù‚Ù„Ø¨ Ø·ÙˆÙŠÙ„ (Long Side)", "Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ÙŠÙ† - Ù‚Ù„Ø¨ Ù‚ØµÙŠØ± (Short Side)"])
            self._cmb_duplex.setToolTip("Ø§Ø®ØªØ± Ù†Ù…Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© ØªØ¯Ø¹Ù… Ø°Ù„Ùƒ")
            
            # Load current settings
            s_print = QtCore.QSettings("GuaranteesApp", "Main")
            
            # Load Printer
            current_printer = s_print.value("print/printer_name", "")
            idx_printer = self._cmb_printer.findData(current_printer)
            if idx_printer >= 0:
                self._cmb_printer.setCurrentIndex(idx_printer)
            else:
                self._cmb_printer.setCurrentIndex(0)
                
            # Load Duplex
            current_duplex = s_print.value("print/duplex", 0, type=int)
            if 0 <= current_duplex < 3:
                self._cmb_duplex.setCurrentIndex(current_duplex)
            else:
                self._cmb_duplex.setCurrentIndex(0)
            
            print_layout.addRow("Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:", self._cmb_printer)
            print_layout.addRow("Ù†Ù…Ø· Ø§Ù„ÙˆØ¬Ù‡ÙŠÙ†:", self._cmb_duplex)
            
            btns_print = QtWidgets.QHBoxLayout()
            _btn_save_print = QtWidgets.QPushButton("Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
            
            def _save_print_settings():
                s = QtCore.QSettings("GuaranteesApp", "Main")
                s.setValue("print/duplex", self._cmb_duplex.currentIndex())
                s.setValue("print/printer_name", self._cmb_printer.currentData())
                QtWidgets.QMessageBox.information(self, "ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­.\nØ³ØªØ·Ø¨Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.")
                
            _btn_save_print.clicked.connect(_save_print_settings)
            btns_print.addWidget(_btn_save_print)
            btns_print.addStretch(1)
            
            v_general.addWidget(grp_print)
            v_general.addLayout(btns_print)
        except Exception:
            pass
        
        v_general.addStretch(1)

        # --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ø¯Ù…Ø¬) ---
        pg_table = QtWidgets.QWidget();
        t = QtWidgets.QVBoxLayout(pg_table)
        # Ø¬Ø²Ø¡ ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        try:
            grp_cols = QtWidgets.QGroupBox("ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©")
            gl = QtWidgets.QVBoxLayout(grp_cols)
            try:
                _lbl_note = QtWidgets.QLabel("Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© âœ“ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù…ÙˆØ¯ØŒ Ø£Ø²Ù„Ù‡Ø§ Ù„Ø¥Ø®ÙØ§Ø¦Ù‡")
                _lbl_note.setWordWrap(True)
                gl.addWidget(_lbl_note)
            except Exception:
                pass
            self._lst_cols = QtWidgets.QListWidget()
            self._lst_cols.setDragDropMode(QtWidgets.QAbstractItemView.InternalMove)
            self._lst_cols.setDefaultDropAction(QtCore.Qt.MoveAction)
            headers = [parent.table.horizontalHeaderItem(i).text() for i in range(parent.table.columnCount())]
            order, hidden_by_name = parent.load_column_settings()
            if order and len(order)==len(headers):
                names = order
            else:
                names = headers
            for nm in names:
                it = QtWidgets.QListWidgetItem(nm)
                it.setFlags(it.flags() | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsSelectable)
                # Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙŠØ¹Ù†ÙŠ "Ø¥Ø¸Ù‡Ø§Ø±"ØŒ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù‡ÙŠ "Ù…Ø®ÙÙŠ"
                it.setCheckState(QtCore.Qt.Checked if not hidden_by_name.get(nm, False) else QtCore.Qt.Unchecked)
                self._lst_cols.addItem(it)
            gl.addWidget(self._lst_cols)
            btns_cols = QtWidgets.QHBoxLayout()
            _btn_apply_cols = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚")
            _btn_save_cols = QtWidgets.QPushButton("Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚")
            def _read_cols_cfg():
                new_order = [self._lst_cols.item(i).text() for i in range(self._lst_cols.count())]
                # Ù†Ø­ÙˆÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ø¥Ø¸Ù‡Ø§Ø±) Ø¥Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø®Ø²Ù†Ø©
                new_hidden = {self._lst_cols.item(i).text(): (self._lst_cols.item(i).checkState()!=QtCore.Qt.Checked) for i in range(self._lst_cols.count())}
                return new_order, new_hidden
            _btn_apply_cols.clicked.connect(lambda: parent.apply_column_settings(*_read_cols_cfg()))
            _btn_save_cols.clicked.connect(lambda: (lambda x: (parent.save_column_settings(*x), parent.apply_column_settings(*x)))(_read_cols_cfg()))
            btns_cols.addWidget(_btn_apply_cols); btns_cols.addWidget(_btn_save_cols); btns_cols.addStretch(1)
            gl.addLayout(btns_cols)
            t.addWidget(grp_cols)
        except Exception:
            pass
        # Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø£Ø¹Ù…Ø¯Ø©/ØµÙÙˆÙ)
        try:
            grp_sizes = QtWidgets.QGroupBox("Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ")
            sl = QtWidgets.QFormLayout(grp_sizes)
            self._sp_uni_col = QtWidgets.QSpinBox(); self._sp_uni_col.setRange(20, 800); self._sp_uni_col.setValue(120)
            self._sp_uni_row = QtWidgets.QSpinBox(); self._sp_uni_row.setRange(12, 200); self._sp_uni_row.setValue(28)
            sl.addRow("Ø¹Ø±Ø¶ Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:", self._sp_uni_col)
            sl.addRow("Ø§Ø±ØªÙØ§Ø¹ Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ:", self._sp_uni_row)
            btns_sz = QtWidgets.QHBoxLayout()
            _btn_apply_w = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶")
            _btn_apply_h = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹")
            _btn_save_geom = QtWidgets.QPushButton("Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
            _btn_restore_geom = QtWidgets.QPushButton("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©")
            _btn_apply_w.clicked.connect(lambda: [parent.table.setColumnWidth(i, int(self._sp_uni_col.value())) for i in range(parent.table.columnCount())])
            _btn_apply_h.clicked.connect(lambda: [parent.table.setRowHeight(r, int(self._sp_uni_row.value())) for r in range(parent.table.rowCount())])
            _btn_save_geom.clicked.connect(lambda: parent.save_table_geometry())
            def _restore():
                by_name, by_index, heights = parent.load_table_geometry()
                parent.apply_table_geometry(by_name, by_index, heights)
            _btn_restore_geom.clicked.connect(_restore)
            for _b in (_btn_apply_w, _btn_apply_h, _btn_save_geom, _btn_restore_geom):
                btns_sz.addWidget(_b)
            btns_sz.addStretch(1)
            t.addWidget(grp_sizes)
            t.addLayout(btns_sz)
        except Exception:
            pass
        t.addStretch(1)

        # --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±ØªÙŠØ¨ ---
        pg_sort = QtWidgets.QWidget()
        s = QtWidgets.QVBoxLayout(pg_sort)
        try:
            grp_sort = QtWidgets.QGroupBox("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª")
            sort_layout = QtWidgets.QFormLayout(grp_sort)
            
            # Sort by options
            self._cmb_sort_by = QtWidgets.QComboBox()
            self._cmb_sort_by.addItems(["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ù„Ø¬Ù‡Ø©", "Ø¨Ù†Ùƒ Ø«Ù… ØªØ§Ø±ÙŠØ®", "Ø¨Ù†Ùƒ Ø«Ù… Ù…Ø¨Ù„Øº", "Ø¨Ù†Ùƒ Ø«Ù… Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯"])
            self._cmb_sort_by.setToolTip("Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„")
            sort_layout.addRow("ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:", self._cmb_sort_by)
            
            # Bank grouping info label
            try:
                lbl_bank_info = QtWidgets.QLabel("ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø§Ø®ØªØ± 'Ø¨Ù†Ùƒ Ø«Ù… ØªØ§Ø±ÙŠØ®' Ø£Ùˆ 'Ø¨Ù†Ùƒ Ø«Ù… Ù…Ø¨Ù„Øº' Ø£Ùˆ 'Ø¨Ù†Ùƒ Ø«Ù… Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯' Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹")
                lbl_bank_info.setWordWrap(True)
                lbl_bank_info.setStyleSheet("color: #666; font-size: 11px; padding: 5px;")
                sort_layout.addRow(lbl_bank_info)
            except Exception:
                pass
            
            # Secondary sort by (for better bank organization)
            self._cmb_sort_by2 = QtWidgets.QComboBox()
            self._cmb_sort_by2.addItems(["Ø¨Ø¯ÙˆÙ†", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ù„Ø¬Ù‡Ø©"])
            self._cmb_sort_by2.setToolTip("Ø§Ø®ØªØ± Ø­Ù‚Ù„ Ø«Ø§Ù†ÙˆÙŠ Ù„Ù„ØªØ±ØªÙŠØ¨ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©")
            sort_layout.addRow("Ø«Ù… Ø­Ø³Ø¨:", self._cmb_sort_by2)
            
            # Sort order
            self._cmb_sort_order = QtWidgets.QComboBox()
            self._cmb_sort_order.addItems(["ØªØµØ§Ø¹Ø¯ÙŠ", "ØªÙ†Ø§Ø²Ù„ÙŠ"])
            sort_layout.addRow("ØªØ±ØªÙŠØ¨:", self._cmb_sort_order)
            
            # Load current settings
            s_main = QtCore.QSettings("GuaranteesApp", "Main")
            current_sort_by = s_main.value("sort/by", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±")
            current_sort_by2 = s_main.value("sort/by2", "Ø¨Ø¯ÙˆÙ†")
            current_sort_order = s_main.value("sort/order", "ØªØµØ§Ø¹Ø¯ÙŠ")
            
            # Set current values
            idx_sort = self._cmb_sort_by.findText(current_sort_by)
            if idx_sort >= 0:
                self._cmb_sort_by.setCurrentIndex(idx_sort)
            
            idx_sort2 = self._cmb_sort_by2.findText(current_sort_by2)
            if idx_sort2 >= 0:
                self._cmb_sort_by2.setCurrentIndex(idx_sort2)
            
            idx_order = self._cmb_sort_order.findText(current_sort_order)
            if idx_order >= 0:
                self._cmb_sort_order.setCurrentIndex(idx_order)
            
            # Apply/Save buttons
            btns_sort = QtWidgets.QHBoxLayout()
            _btn_apply_sort = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚")
            _btn_save_sort = QtWidgets.QPushButton("Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚")
            
            def _apply_sort_settings():
                sort_by = self._cmb_sort_by.currentText()
                sort_by2 = self._cmb_sort_by2.currentText()
                sort_order = self._cmb_sort_order.currentText()
                parent.apply_sort_settings(sort_by, sort_by2, sort_order)
            
            def _save_and_apply_sort_settings():
                sort_by = self._cmb_sort_by.currentText()
                sort_by2 = self._cmb_sort_by2.currentText()
                sort_order = self._cmb_sort_order.currentText()
                parent.save_sort_settings(sort_by, sort_by2, sort_order)
                parent.apply_sort_settings(sort_by, sort_by2, sort_order)
            
            _btn_apply_sort.clicked.connect(_apply_sort_settings)
            _btn_save_sort.clicked.connect(_save_and_apply_sort_settings)
            
            btns_sort.addWidget(_btn_apply_sort)
            btns_sort.addWidget(_btn_save_sort)
            btns_sort.addStretch(1)
            
            s.addWidget(grp_sort)
            s.addLayout(btns_sort)
        except Exception:
            pass
        s.addStretch(1)

        # --- Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
        pg_brand = QtWidgets.QWidget();
        b = QtWidgets.QVBoxLayout(pg_brand)
        try:
            btn_brand = QtWidgets.QPushButton("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø±/Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©â€¦")
            btn_brand.clicked.connect(parent.show_brand_settings)
            b.addWidget(btn_brand)
        except Exception:
            pass
        try:
            btn_print = QtWidgets.QPushButton("Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø©â€¦")
            btn_print.setToolTip("ÙØªØ­ Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¶Ø¨Ø· Ø§Ù„ØµÙØ­Ø©")
            btn_print.clicked.connect(getattr(parent, "preview", lambda: None))
            b.addWidget(btn_print)
        except Exception:
            pass
        b.addStretch(1)

        # --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        pg_data = QtWidgets.QWidget();
        d = QtWidgets.QVBoxLayout(pg_data)
        
        # Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Audit Log) - Ù…Ù†Ù‚ÙˆÙ„ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
        try:
            btn_audit = QtWidgets.QPushButton("Ø³Ø¬Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Audit Log)")
            btn_audit.setToolTip("Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…")
            if 'AuditLogDialog' in globals():
                btn_audit.clicked.connect(lambda: AuditLogDialog(parent).exec_())
                d.addWidget(btn_audit)
                d.addWidget(QtWidgets.QLabel("")) # ÙØ§ØµÙ„
        except Exception:
            pass

        try:
            btn_import = QtWidgets.QPushButton("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„â€¦")
            if hasattr(parent, "show_import_excel"):
                btn_import.clicked.connect(parent.show_import_excel)
            else:
                btn_import.clicked.connect(getattr(parent, "do_import", lambda: None))
            d.addWidget(btn_import)
        except Exception:
            pass

        # --- Cloud Sync Button ---
        try:
            btn_sync = QtWidgets.QPushButton("ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©")
            btn_sync.setToolTip("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©")
            btn_sync.setStyleSheet("QPushButton { padding: 8px; background-color: #0288D1; color: white; font-weight: bold; }")
            btn_sync.clicked.connect(parent.do_cloud_sync)
            d.addWidget(btn_sync)
        except Exception:
            pass
        # -------------------------

        try:
            btn_export = QtWidgets.QPushButton("ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„â€¦")
            if hasattr(parent, "export_excel"):
                btn_export.clicked.connect(parent.export_excel)
            else:
                btn_export.clicked.connect(lambda: export_table_to_excel(parent))
            d.addWidget(btn_export)
        except Exception:
            pass
        try:
            btn_undone = QtWidgets.QPushButton("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯)")
            btn_undone.clicked.connect(parent._confirm_unmark_selected_done)
            d.addWidget(btn_undone)
        except Exception:
            pass
        
        # Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
        try:
            d.addWidget(QtWidgets.QLabel("")) # ÙØ§ØµÙ„
            grp_backup = QtWidgets.QGroupBox("Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ")
            backup_layout = QtWidgets.QVBoxLayout(grp_backup)
            
            # Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            btn_backup = QtWidgets.QPushButton("Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†")
            btn_backup.setToolTip("Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
            btn_backup.setStyleSheet("QPushButton { padding: 8px; background-color: #2E7D32; color: white; font-weight: bold; }")
            
            def _create_backup():
                try:
                    backup_path = create_backup()
                    if backup_path:
                        QtWidgets.QMessageBox.information(parent, "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", 
                            f"âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ù…Ø³Ø§Ø±:\n{backup_path}\n\nØªÙ… ØªØ¶Ù…ÙŠÙ† Ù†Ø³Ø®Ø© Excel (Guarantees_Data.xlsx) ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.\n\nÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.")
                    else:
                        QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "âš  ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.")
                except Exception as e:
                    QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", f"âš  Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
            
            btn_backup.clicked.connect(_create_backup)
            backup_layout.addWidget(btn_backup)
            
            # Ø²Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
            btn_restore = QtWidgets.QPushButton("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...")
            btn_restore.setToolTip("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©")
            btn_restore.setStyleSheet("QPushButton { padding: 8px; background-color: #1976D2; color: white; }")
            
            def _restore_backup():
                try:
                    reply = QtWidgets.QMessageBox.question(parent, "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", 
                        "âš  ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ\n\n"
                        "â€¢ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\n"
                        "â€¢ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©\n"
                        "â€¢ ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©",
                        QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No)
                    
                    if reply == QtWidgets.QMessageBox.Yes:
                        # Create backup of current data first
                        current_backup = create_backup()
                        if current_backup:
                            if restore_backup():
                                QtWidgets.QMessageBox.information(parent, "Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", 
                                    "âœ“ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                                    f"ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ:\n{current_backup}\n\n"
                                    "ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¢Ù† Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.")
                            else:
                                QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "âš  ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.")
                        else:
                            QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "âš  ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.")
                except Exception as e:
                    QtWidgets.QMessageBox.warning(parent, "Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", f"âš  Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
            
            btn_restore.clicked.connect(_restore_backup)
            backup_layout.addWidget(btn_restore)
            
            # Ø²Ø± ÙØªØ­ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            btn_open_backup_folder = QtWidgets.QPushButton("ÙØªØ­ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©")
            btn_open_backup_folder.setToolTip("ÙØªØ­ Ù…Ø¬Ù„Ø¯ data/backup/ Ø­ÙŠØ« ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©")
            
            def _open_backup_folder():
                try:
                    backup_dir = _get_data_dir() / "backup"
                    backup_dir.mkdir(parents=True, exist_ok=True)
                    QtGui.QDesktopServices.openUrl(QtCore.QUrl.fromLocalFile(str(backup_dir)))
                except Exception as e:
                    try:
                        _status(self, "âš  ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…Ø¬Ù„Ø¯", 2500)
                    except Exception:
                        try:
                            QtWidgets.QMessageBox.warning(parent, "ÙØªØ­ Ø§Ù„Ù…Ø¬Ù„Ø¯", f"âš  ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…Ø¬Ù„Ø¯: {str(e)}")
                        except Exception:
                            pass
            
            btn_open_backup_folder.clicked.connect(_open_backup_folder)
            backup_layout.addWidget(btn_open_backup_folder)
            
            # Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©
            info_label = QtWidgets.QLabel(
                "ğŸ’¡ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.\n"
                "ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙ‚Ø·."
            )
            info_label.setWordWrap(True)
            info_label.setStyleSheet("color: #666; font-size: 11px; padding: 5px; background-color: #f5f5f5; border-radius: 3px;")
            backup_layout.addWidget(info_label)
            
            d.addWidget(grp_backup)
        except Exception:
            pass
        
        d.addStretch(1)

        # --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¨Ù†ÙˆÙƒ) ---
        pg_lists = QtWidgets.QWidget();
        lz = QtWidgets.QVBoxLayout(pg_lists)
        try:
            grp_depts = QtWidgets.QGroupBox("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")
            fd = QtWidgets.QFormLayout(grp_depts)
            self._lst_depts = QtWidgets.QListWidget()
            self._lst_depts.addItems(_read_custom_departments() + ["Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"])  # Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            self._lst_depts.setMinimumHeight(120)
            fd.addRow("Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:", self._lst_depts)
            h1 = QtWidgets.QHBoxLayout()
            self._ed_new_dept = QtWidgets.QLineEdit(); self._ed_new_dept.setPlaceholderText("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯â€¦")
            _btn_add_dept = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…")
            def _add_dept():
                name = (self._ed_new_dept.text() or "").strip()
                if not name:
                    return
                cur = _read_custom_departments()
                if name not in cur and name not in ("Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶",):
                    cur.append(name)
                    _save_custom_departments(cur)
                # Ø­Ø¯Ø« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                try:
                    combo = getattr(parent, "cmb_dept", None)
                    if combo is not None and combo.findText(name) < 0:
                        combo.addItem(name)
                except Exception:
                    pass
                # Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¶
                self._lst_depts.clear(); self._lst_depts.addItems(_read_custom_departments() + ["Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶"]) 
                self._ed_new_dept.clear()
            _btn_add_dept.clicked.connect(_add_dept)
            h1.addWidget(self._ed_new_dept); h1.addWidget(_btn_add_dept)
            fd.addRow(h1)
            lz.addWidget(grp_depts)
        except Exception:
            pass
        try:
            grp_banks = QtWidgets.QGroupBox("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆÙƒ")
            fb = QtWidgets.QFormLayout(grp_banks)
            self._lst_banks = QtWidgets.QListWidget()
            self._lst_banks.addItems(_read_custom_banks() + ["Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³Ø§Ø¨", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ", "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]) 
            self._lst_banks.setMinimumHeight(120)
            fb.addRow("Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:", self._lst_banks)
            h2 = QtWidgets.QHBoxLayout()
            self._ed_new_bank = QtWidgets.QLineEdit(); self._ed_new_bank.setPlaceholderText("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¨Ù†Ùƒ Ø¬Ø¯ÙŠØ¯â€¦")
            _btn_add_bank = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ùƒ")
            def _add_bank():
                name = (self._ed_new_bank.text() or "").strip()
                if not name:
                    return
                cur = _read_custom_banks()
                defaults = ["Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ù…Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø³Ø§Ø¨", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ", "Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡"]
                if name not in cur and name not in defaults:
                    cur.append(name)
                    _save_custom_banks(cur)
                # Ø­Ø¯Ø« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                try:
                    combo = getattr(parent, "cmb_bank", None)
                    if combo is not None and combo.findText(name) < 0:
                        combo.addItem(name)
                except Exception:
                    pass
                # Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¶
                self._lst_banks.clear(); self._lst_banks.addItems(_read_custom_banks() + defaults)
                self._ed_new_bank.clear()
            _btn_add_bank.clicked.connect(_add_bank)
            h2.addWidget(self._ed_new_bank); h2.addWidget(_btn_add_bank)
            fb.addRow(h2)
            lz.addWidget(grp_banks)
        except Exception:
            pass
        # Ø¥ÙŠØ¶Ø§Ø­ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
        try:
            _info = QtWidgets.QLabel("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± â€˜Ø¶Ù…Ø§Ù† ØºÙŠØ± Ù…Ø³Ø¬Ù„â€™ Ø¥Ù„Ù‰ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©. Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ø³ÙŠÙØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.")
            _info.setWordWrap(True)
            lz.addWidget(_info)
        except Exception:
            pass
        lz.addStretch(1)

        # Database tab removed completely

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙØ­Ø§Øª
        tabs.addTab(pg_general, "Ø¹Ø§Ù…")
        tabs.addTab(pg_table, "Ø§Ù„Ø¬Ø¯ÙˆÙ„")
        tabs.addTab(pg_sort, "Ø§Ù„ØªØ±ØªÙŠØ¨")
        tabs.addTab(pg_brand, "Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©")
        tabs.addTab(pg_data, "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
        tabs.addTab(pg_lists, "Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…")

        try:
            _cur = (getattr(parent, 'current_user', '') or '').strip().upper()
            if _cur == 'MELADL':
                pg_users = QtWidgets.QWidget();
                u = QtWidgets.QVBoxLayout(pg_users)
                tbl = QtWidgets.QTableWidget(pg_users)
                tbl.setColumnCount(3)
                tbl.setHorizontalHeaderLabels(["Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "Ø§Ù„Ø¯ÙˆØ±", "Ù†Ø´Ø·"])
                try:
                    tbl.setEditTriggers(QtWidgets.QAbstractItemView.NoEditTriggers)
                except Exception:
                    pass
                try:
                    tbl.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
                    tbl.setSelectionMode(QtWidgets.QAbstractItemView.SingleSelection)
                except Exception:
                    pass
                tbl.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
                def _reload_users():
                    try:
                        ensure_db()
                        conn = connect_db(); c = conn.cursor()
                        rows = c.execute("SELECT username, role, active FROM users ORDER BY id ASC").fetchall()
                        conn.close()
                    except Exception:
                        rows = []
                    # Ø§Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    try:
                        sel_row = tbl.currentRow()
                        sel_user = tbl.item(sel_row, 0).text() if (sel_row >= 0 and tbl.item(sel_row,0)) else ""
                    except Exception:
                        sel_user = ""
                    tbl.setRowCount(0)
                    for i, (un, role, act) in enumerate(rows):
                        tbl.insertRow(i)
                        tbl.setItem(i, 0, QtWidgets.QTableWidgetItem(str(un)))
                        tbl.setItem(i, 1, QtWidgets.QTableWidgetItem(str(role or "user")))
                        tbl.setItem(i, 2, QtWidgets.QTableWidgetItem("âœ“" if int(act or 0)==1 else "âœ—"))
                    try:
                        if not rows:
                            tbl.setRowCount(1)
                            it = QtWidgets.QTableWidgetItem("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")
                            it.setFlags(it.flags() & ~QtCore.Qt.ItemIsEditable)
                            tbl.setItem(0, 0, it)
                            tbl.setItem(0, 1, QtWidgets.QTableWidgetItem(""))
                            tbl.setItem(0, 2, QtWidgets.QTableWidgetItem(""))
                            try:
                                self._ed_user.clear(); self._ed_pass.clear()
                                self._cmb_role.setCurrentText("user"); self._chk_active.setChecked(False)
                            except Exception:
                                pass
                        else:
                            # Ø£Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø£Ùˆ Ø£ÙˆÙ„ ØµÙ
                            try:
                                target_index = 0
                                if sel_user:
                                    for i, (un, _role, _act) in enumerate(rows):
                                        if str(un) == sel_user:
                                            target_index = i; break
                                tbl.selectRow(target_index)
                                # Ø­Ø¯Ø« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙˆØ±Ù‹Ø§
                                try:
                                    r = target_index
                                    self._ed_user.setText(tbl.item(r,0).text())
                                    self._cmb_role.setCurrentText(tbl.item(r,1).text())
                                    act_txt = tbl.item(r,2).text() if tbl.item(r,2) else ''
                                    self._chk_active.setChecked(True if act_txt.strip()=="âœ“" else False)
                                except Exception:
                                    pass
                            except Exception:
                                pass
                    except Exception:
                        pass
                    try:
                        QtWidgets.QApplication.processEvents()
                    except Exception:
                        pass
                _reload_users()
                split = QtWidgets.QSplitter(QtCore.Qt.Vertical, pg_users)
                try:
                    split.setChildrenCollapsible(False)
                    split.setHandleWidth(6)
                except Exception:
                    pass
                split.addWidget(tbl)
                panel = QtWidgets.QWidget(); pl = QtWidgets.QGridLayout(panel)
                gb = QtWidgets.QGroupBox("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
                form = QtWidgets.QFormLayout(gb)
                self._ed_user = QtWidgets.QLineEdit(); self._ed_user.setPlaceholderText("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
                self._ed_pass = QtWidgets.QLineEdit(); self._ed_pass.setPlaceholderText("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); self._ed_pass.setEchoMode(QtWidgets.QLineEdit.Password)
                eye = QtWidgets.QToolButton(); eye.setText("ğŸ‘"); eye.setCheckable(True)
                try:
                    eye.setFixedWidth(28)
                    eye.setSizePolicy(QtWidgets.QSizePolicy.Fixed, QtWidgets.QSizePolicy.Fixed)
                except Exception:
                    pass
                eye.clicked.connect(lambda checked=False: self._ed_pass.setEchoMode(QtWidgets.QLineEdit.Normal if eye.isChecked() else QtWidgets.QLineEdit.Password))
                row_pw = QtWidgets.QHBoxLayout(); row_pw.setContentsMargins(0,0,0,0); row_pw.setSpacing(6)
                try:
                    self._ed_pass.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Fixed)
                except Exception:
                    pass
                row_pw.addWidget(self._ed_pass, 1); row_pw.addWidget(eye)
                wrap_pw = QtWidgets.QWidget(); wrap_pw.setLayout(row_pw)
                self._cmb_role = QtWidgets.QComboBox(); self._cmb_role.addItems(["user","admin"]) 
                self._chk_active = QtWidgets.QCheckBox("Ù†Ø´Ø·")
                self._chk_active.setChecked(True)
                form.addRow("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", self._ed_user)
                form.addRow("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:", wrap_pw)
                form.addRow("Ø§Ù„Ø¯ÙˆØ±:", self._cmb_role)
                form.addRow(self._chk_active)
                pl.addWidget(gb, 0, 0, 1, 2)
                _btn_add_user = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù…")
                _btn_del_user = QtWidgets.QPushButton("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯")
                btns_user = QtWidgets.QHBoxLayout(); btns_user.addWidget(_btn_add_user); btns_user.addStretch(1); btns_user.addWidget(_btn_del_user)
                pl.addLayout(btns_user, 1, 0, 1, 2)
                split.addWidget(panel)
                try:
                    split.setSizes([int(self.height()*0.55 or 240), int(self.height()*0.45 or 180)])
                except Exception:
                    pass
                u.addWidget(split)
                # ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
                try:
                    def _on_row_select():
                        r = tbl.currentRow()
                        if r >= 0:
                            try:
                                self._ed_user.setText(tbl.item(r,0).text())
                            except Exception:
                                pass
                            try:
                                self._cmb_role.setCurrentText(tbl.item(r,1).text())
                            except Exception:
                                pass
                            try:
                                act_txt = tbl.item(r,2).text() if tbl.item(r,2) else ''
                                self._chk_active.setChecked(True if act_txt.strip()=="âœ“" else False)
                            except Exception:
                                pass
                    tbl.itemSelectionChanged.connect(_on_row_select)
                except Exception:
                    pass
                def _save_user():
                    un = (self._ed_user.text() or "").strip().upper()
                    pw = (self._ed_pass.text() or "")
                    try:
                        pw = pw.translate(ARABIC_DIGITS).strip()
                    except Exception:
                        pw = pw.strip()
                    role = self._cmb_role.currentText()
                    active = 1 if self._chk_active.isChecked() else 0
                    if not un:
                        return
                    try:
                        ensure_db()
                        conn = connect_db(); c = conn.cursor()
                        row = c.execute("SELECT id FROM users WHERE username=?", (un,)).fetchone()
                        ph = _hash_password(pw)
                        if row:
                            try:
                                c.execute("UPDATE users SET pass_hash=?, password_hash=?, role=?, active=? WHERE username=?",
                                          (ph, ph, role, active, un))
                            except Exception:
                                try:
                                    c.execute("UPDATE users SET pass_hash=?, role=?, active=? WHERE username=?",
                                              (ph, role, active, un))
                                except Exception:
                                    c.execute("UPDATE users SET password_hash=?, role=?, active=? WHERE username=?",
                                              (ph, role, active, un))
                        else:
                            try:
                                c.execute("INSERT INTO users (username, pass_hash, password_hash, role, active) VALUES (?,?,?,?,?)",
                                          (un, ph, ph, role, active))
                            except Exception:
                                try:
                                    c.execute("INSERT INTO users (username, pass_hash, role, active) VALUES (?,?,?,?)",
                                              (un, ph, role, active))
                                except Exception:
                                    c.execute("INSERT INTO users (username, password_hash, role, active) VALUES (?,?,?,?)",
                                              (un, ph, role, active))
                        conn.commit(); conn.close()
                    except Exception as e:
                        try:
                            QtWidgets.QMessageBox.critical(self, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†", f"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: {e}")
                        except Exception:
                            pass
                    self._ed_pass.clear();
                    _reload_users()
                    try:
                        tbl.viewport().update(); tbl.repaint(); QtWidgets.QApplication.processEvents()
                    except Exception:
                        pass
                    try:
                        QtCore.QTimer.singleShot(0, _reload_users)
                    except Exception:
                        pass
                    try:
                        QtWidgets.QMessageBox.information(self, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/ØªØ­Ø¯ÙŠØ«Ù‡")
                    except Exception:
                        pass
                _btn_add_user.clicked.connect(_save_user)
                def _delete_selected():
                    try:
                        ensure_db()
                        un = ""
                        try:
                            r = tbl.currentRow()
                            if r >= 0 and tbl.item(r,0):
                                un = (tbl.item(r,0).text() or "").strip().upper()
                        except Exception:
                            un = ""
                        if not un:
                            try:
                                un = (self._ed_user.text() or "").strip().upper()
                            except Exception:
                                un = ""
                        if not un or un == "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª" or un == "LA TWJAD BYNAT":
                            return
                        if un == "MELADL":
                            QtWidgets.QMessageBox.warning(self, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ MELADL")
                            return
                        conn = connect_db(); c = conn.cursor()
                        c.execute("DELETE FROM users WHERE username=?", (un,))
                        conn.commit(); conn.close()
                        try:
                            QtWidgets.QMessageBox.information(self, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†", f"ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {un}")
                        except Exception:
                            pass
                    except Exception as e:
                        try:
                            QtWidgets.QMessageBox.critical(self, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†", f"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù: {e}")
                        except Exception:
                            pass
                    _reload_users()
                    try:
                        tbl.viewport().update(); tbl.repaint(); QtWidgets.QApplication.processEvents()
                    except Exception:
                        pass
                    try:
                        QtCore.QTimer.singleShot(0, _reload_users)
                    except Exception:
                        pass
                _btn_del_user.clicked.connect(_delete_selected)
                btns_user.addWidget(_btn_add_user); btns_user.addWidget(_btn_del_user); btns_user.addStretch(1)
                tabs.addTab(pg_users, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†")
        except Exception:
            pass

        # --- Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª ---
        try:
            pg_shortcuts = QtWidgets.QWidget();
            ls = QtWidgets.QVBoxLayout(pg_shortcuts)
            lbl_info = QtWidgets.QLabel("Ù‡Ø°Ù‡ Ù‚Ø§Ø¦Ù…Ø© Ø³Ø±ÙŠØ¹Ø© Ø¨ÙƒÙ„ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.")
            lbl_info.setWordWrap(True)
            ls.addWidget(lbl_info)
            tbl = QtWidgets.QTableWidget(pg_shortcuts)
            tbl.setColumnCount(2)
            tbl.setHorizontalHeaderLabels(["Ø§Ù„Ø§Ø®ØªØµØ§Ø±", "Ø§Ù„ÙˆØ¸ÙŠÙØ©"])
            tbl.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
            shortcuts = [
                ("Ctrl+F", "Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«"),
                ("Ctrl+R", "ØªØ­Ø¯ÙŠØ«/ØªØµÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„"),
                ("Ctrl+I", "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø¥ÙƒØ³Ù„"),
                ("Ctrl+E", "ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„"),
                ("Ctrl+P", "Ø·Ø¨Ø§Ø¹Ø© / Ù…Ø¹Ø§ÙŠÙ†Ø©"),
                ("Ctrl+S", "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ®Ø·ÙŠØ·"),
                ("Ctrl+Z", "ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªØ®Ø·ÙŠØ·"),
                ("Ctrl+Y", "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹"),
                ("Ctrl+L", "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©"),
                ("Enter / Return", "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±/ØªØ­Ø¯ÙŠØ«"),
                ("Ctrl+Enter / Shift+Enter", "Ø¥Ù†Ù‡Ø§Ø¡ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø®Ù„ÙŠØ©"),
                ("Ctrl+U", "Ø¥Ù„ØºØ§Ø¡ ÙˆØ³Ù… ÙƒÙ…ÙƒØªÙ…Ù„"),
                ("Esc (ÙƒØ§ØªØ¨ Ø§Ù„Ø¥ÙƒØ³Ù„)", "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©")
            ]
            tbl.setRowCount(len(shortcuts))
            for i, (key, desc) in enumerate(shortcuts):
                it_key = QtWidgets.QTableWidgetItem(key); it_key.setFlags(it_key.flags() & ~QtCore.Qt.ItemIsEditable)
                it_desc = QtWidgets.QTableWidgetItem(desc); it_desc.setFlags(it_desc.flags() & ~QtCore.Qt.ItemIsEditable)
                tbl.setItem(i, 0, it_key)
                tbl.setItem(i, 1, it_desc)
            ls.addWidget(tbl)
            tabs.addTab(pg_shortcuts, "Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª")
        except Exception:
            pass

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Close)
        btns.rejected.connect(self.reject)
        btns.button(QtWidgets.QDialogButtonBox.Close).clicked.connect(self.close)

        root = QtWidgets.QVBoxLayout(self)
        root.addWidget(tabs)
        root.addWidget(btns)

        # Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        try:
            _sc_save = QtWidgets.QShortcut(QtGui.QKeySequence('Ctrl+S'), self)
            _sc_save.activated.connect(lambda: (getattr(parent, 'save_all_settings', lambda: None)(), getattr(parent, 'show_toast', lambda *a, **k: None)("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")))
        except Exception:
            pass
        
        
class LoansSettingsDialog(QtWidgets.QDialog):
    def __init__(self, parent):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø±ÙˆØ¶")
        self.resize(700, 480)
        tabs = QtWidgets.QTabWidget(self)
        tabs.setTabPosition(QtWidgets.QTabWidget.North)

        pg_general = QtWidgets.QWidget(); v_general = QtWidgets.QVBoxLayout(pg_general)
        try:
            grp_date = QtWidgets.QGroupBox("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®")
            date_layout = QtWidgets.QFormLayout(grp_date)
            btn_date = QtWidgets.QPushButton("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®â€¦")
            btn_date.clicked.connect(lambda: show_date_settings(parent))
            date_layout.addRow(btn_date)
            v_general.addWidget(grp_date)
        except Exception:
            pass
        v_general.addStretch(1)

        pg_table = QtWidgets.QWidget(); t = QtWidgets.QVBoxLayout(pg_table)
        try:
            grp_cols = QtWidgets.QGroupBox("ØªØ±ØªÙŠØ¨/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©")
            gl = QtWidgets.QVBoxLayout(grp_cols)
            lst = QtWidgets.QListWidget()
            lst.setDragDropMode(QtWidgets.QAbstractItemView.InternalMove)
            lst.setDefaultDropAction(QtCore.Qt.MoveAction)
            headers = [parent.table.horizontalHeaderItem(i).text() for i in range(parent.table.columnCount())]
            order, hidden_by_name = parent.load_loans_column_settings()
            names = order if (order and len(order) == len(headers)) else headers
            for nm in names:
                it = QtWidgets.QListWidgetItem(nm)
                it.setFlags(it.flags() | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsSelectable)
                it.setCheckState(QtCore.Qt.Checked if not hidden_by_name.get(nm, False) else QtCore.Qt.Unchecked)
                lst.addItem(it)
            gl.addWidget(lst)
            btns_cols = QtWidgets.QHBoxLayout()
            _btn_apply_cols = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚")
            _btn_save_cols = QtWidgets.QPushButton("Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚")
            def _read_cols_cfg():
                new_order = [lst.item(i).text() for i in range(lst.count())]
                new_hidden = {lst.item(i).text(): (lst.item(i).checkState()!=QtCore.Qt.Checked) for i in range(lst.count())}
                return new_order, new_hidden
            _btn_apply_cols.clicked.connect(lambda: parent.apply_loans_column_settings(*_read_cols_cfg()))
            _btn_save_cols.clicked.connect(lambda: (lambda x: (parent.save_loans_column_settings(*x), parent.apply_loans_column_settings(*x)))(_read_cols_cfg()))
            btns_cols.addWidget(_btn_apply_cols); btns_cols.addWidget(_btn_save_cols); btns_cols.addStretch(1)
            gl.addLayout(btns_cols)
            t.addWidget(grp_cols)
        except Exception:
            pass
        try:
            grp_sizes = QtWidgets.QGroupBox("Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ")
            sl = QtWidgets.QFormLayout(grp_sizes)
            _sp_uni_col = QtWidgets.QSpinBox(); _sp_uni_col.setRange(20, 800); _sp_uni_col.setValue(120)
            _sp_uni_row = QtWidgets.QSpinBox(); _sp_uni_row.setRange(12, 200); _sp_uni_row.setValue(28)
            sl.addRow("Ø¹Ø±Ø¶ Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:", _sp_uni_col)
            sl.addRow("Ø§Ø±ØªÙØ§Ø¹ Ù…ÙˆØ­Ù‘Ø¯ Ù„ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ:", _sp_uni_row)
            btns_sz = QtWidgets.QHBoxLayout()
            _btn_apply_w = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶")
            _btn_apply_h = QtWidgets.QPushButton("ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹")
            _btn_save_geom = QtWidgets.QPushButton("Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
            _btn_restore_geom = QtWidgets.QPushButton("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©")
            _btn_apply_w.clicked.connect(lambda: [parent.table.setColumnWidth(i, int(_sp_uni_col.value())) for i in range(parent.table.columnCount())])
            _btn_apply_h.clicked.connect(lambda: [parent.table.setRowHeight(r, int(_sp_uni_row.value())) for r in range(parent.table.rowCount())])
            _btn_save_geom.clicked.connect(parent.save_loans_table_geometry)
            def _restore():
                by_name, by_index, heights = parent.load_loans_table_geometry()
                parent.apply_loans_table_geometry(by_name, by_index, heights)
            _btn_restore_geom.clicked.connect(_restore)
            for _b in (_btn_apply_w, _btn_apply_h, _btn_save_geom, _btn_restore_geom):
                btns_sz.addWidget(_b)
            btns_sz.addStretch(1)
            t.addWidget(grp_sizes)
            t.addLayout(btns_sz)
        except Exception:
            pass
        t.addStretch(1)

        # Banks tab
        pg_banks = QtWidgets.QWidget(); b = QtWidgets.QVBoxLayout(pg_banks)
        try:
            lst_banks = QtWidgets.QListWidget()
            lst_banks.addItems(parent._load_loans_banks())
            b.addWidget(lst_banks)
            h = QtWidgets.QHBoxLayout()
            btn_add = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ùƒ")
            btn_del = QtWidgets.QPushButton("Ø­Ø°Ù Ø¨Ù†Ùƒ")
            btn_save = QtWidgets.QPushButton("Ø­ÙØ¸")
            def _add():
                text, ok = QtWidgets.QInputDialog.getText(self, "Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ùƒ", "Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ:")
                if ok and str(text).strip():
                    lst_banks.addItem(str(text).strip())
            def _del():
                it = lst_banks.currentItem()
                if it:
                    lst_banks.takeItem(lst_banks.row(it))
            def _save():
                names = [lst_banks.item(i).text().strip() for i in range(lst_banks.count()) if lst_banks.item(i).text().strip()]
                parent._save_loans_banks(names)
                try:
                    parent._rebuild_bank_tabs()
                except Exception:
                    pass
            btn_add.clicked.connect(_add); btn_del.clicked.connect(_del); btn_save.clicked.connect(_save)
            for _b in (btn_add, btn_del, btn_save): h.addWidget(_b)
            h.addStretch(1); b.addLayout(h)
        except Exception:
            pass

        tabs.addTab(pg_general, "Ø¹Ø§Ù…")
        tabs.addTab(pg_table, "Ø§Ù„Ø¬Ø¯ÙˆÙ„")
        tabs.addTab(pg_banks, "Ø§Ù„Ø¨Ù†ÙˆÙƒ")

        v = QtWidgets.QVBoxLayout(self)
        v.addWidget(tabs)
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Close)
        v.addWidget(btns)
        btns.rejected.connect(self.reject)


class LoanFormDialog(QtWidgets.QDialog):
    def __init__(self, parent, default_cybor=0.0, banks=None, current_bank="", initial=None):
        super().__init__(parent)
        self.setWindowTitle("Ø¥Ø¶Ø§ÙØ© ØªÙ…ÙˆÙŠÙ„")
        self.resize(520, 420)
        f = QtWidgets.QFormLayout(self)
        self.cmb_bank = QtWidgets.QComboBox(self)
        for b in (banks or parent._load_loans_banks()):
            self.cmb_bank.addItem(b)
        if current_bank:
            idx = self.cmb_bank.findText(current_bank)
            if idx >= 0:
                self.cmb_bank.setCurrentIndex(idx)
        self.cmb_type = QtWidgets.QComboBox(self); self.cmb_type.addItems(["Ù‚ØµÙŠØ± Ø§Ù„Ø§Ø¬Ù„","Ø·ÙˆÙŠÙ„ Ø§Ù„Ø§Ø¬Ù„"])
        self.sp_principal = QtWidgets.QDoubleSpinBox(self); self.sp_principal.setRange(0, 1_000_000_000); self.sp_principal.setDecimals(2)
        self.sp_outstanding = QtWidgets.QDoubleSpinBox(self); self.sp_outstanding.setRange(0, 1_000_000_000); self.sp_outstanding.setDecimals(2)
        self.de_start = QtWidgets.QDateEdit(self); self.de_start.setCalendarPopup(True); self.de_start.setDate(QtCore.QDate.currentDate())
        self.de_end = QtWidgets.QDateEdit(self); self.de_end.setCalendarPopup(True); self.de_end.setDate(QtCore.QDate.currentDate())
        self.sp_rate = QtWidgets.QDoubleSpinBox(self); self.sp_rate.setRange(0.0, 100.0); self.sp_rate.setDecimals(4); self.sp_rate.setSuffix("%")
        self.sp_cybor = QtWidgets.QDoubleSpinBox(self); self.sp_cybor.setRange(-100.0, 100.0); self.sp_cybor.setDecimals(4); self.sp_cybor.setSuffix("%"); self.sp_cybor.setValue(float(default_cybor))
        self.ed_sector = QtWidgets.QLineEdit(self)
        f.addRow("Ø§Ù„Ø¨Ù†Ùƒ:", self.cmb_bank)
        f.addRow("Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø¶:", self.cmb_type)
        f.addRow("Ø£ØµÙ„ Ø§Ù„Ù‚Ø±Ø¶:", self.sp_principal)
        f.addRow("Ø§Ù„Ù‚Ø§Ø¦Ù… Ù…Ù† Ø§Ù„Ù‚Ø±Ø¶:", self.sp_outstanding)
        f.addRow("Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø±Ø¶:", self.de_start)
        f.addRow("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø±Ø¶:", self.de_end)
        f.addRow("Ø³Ø¹Ø± Ø§Ù„ÙØ§Ø¦Ø¯Ø©:", self.sp_rate)
        f.addRow("Ø³Ø§ÙŠØ¨Ø±:", self.sp_cybor)
        f.addRow("Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯:", self.ed_sector)
        btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel, self)
        f.addRow(btns)
        btns.accepted.connect(self.accept); btns.rejected.connect(self.reject)
        if initial:
            try:
                i_bank = initial.get("bank")
                if i_bank:
                    j = self.cmb_bank.findText(i_bank)
                    if j >= 0: self.cmb_bank.setCurrentIndex(j)
                i_type = initial.get("loan_type")
                if i_type:
                    j = self.cmb_type.findText(i_type)
                    if j >= 0: self.cmb_type.setCurrentIndex(j)
                self.sp_principal.setValue(float(initial.get("principal", 0.0) or 0.0))
                self.sp_outstanding.setValue(float(initial.get("outstanding", 0.0) or 0.0))
                d1 = parse_date(initial.get("start_date") or "")
                d2 = parse_date(initial.get("end_date") or "")
                if d1:
                    self.de_start.setDate(QtCore.QDate(d1.year, d1.month, d1.day))
                if d2:
                    self.de_end.setDate(QtCore.QDate(d2.year, d2.month, d2.day))
                self.sp_rate.setValue(float(initial.get("rate_percent", 0.0) or 0.0))
                self.sp_cybor.setValue(float(initial.get("cybor_percent", 0.0) or 0.0))
                self.ed_sector.setText(str(initial.get("sector", "") or ""))
            except Exception:
                pass

    def result_values(self):
        def _fmt_date(qd):
            return format_date_for_view(qd.toPyDate())
        return {
            "bank": self.cmb_bank.currentText(),
            "loan_type": self.cmb_type.currentText(),
            "principal": float(self.sp_principal.value()),
            "outstanding": float(self.sp_outstanding.value()),
            "start_date": _fmt_date(self.de_start.date()),
            "end_date": _fmt_date(self.de_end.date()),
            "rate_percent": float(self.sp_rate.value()),
            "cybor_percent": float(self.sp_cybor.value()),
            "sector": self.ed_sector.text().strip(),
        }


class InstallmentsDialog(QtWidgets.QDialog):
    def __init__(self, parent, loan_id):
        super().__init__(parent)
        self.parent = parent
        self.loan_id = int(loan_id)
        self._loading = False
        self.setWindowTitle("Ø§Ù„Ø£Ù‚Ø³Ø§Ø·")
        self.resize(720, 480)
        v = QtWidgets.QVBoxLayout(self)
        self.table = QtWidgets.QTableWidget(self)
        self.table.setColumnCount(7)
        self.table.setHorizontalHeaderLabels([
            "Ø±Ù‚Ù… Ø§Ù„Ù‚Ø³Ø·","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚","Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·","Ø£ØµÙ„ Ø§Ù„Ù‚Ø³Ø·","ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù‚Ø³Ø·","Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø³Ø·","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ"
        ])
        try:
            self.table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        except Exception:
            pass
        class StatusDelegate(QtWidgets.QStyledItemDelegate):
            def __init__(self, parent=None):
                super().__init__(parent)
                self._opts = ["Ù…Ø¯ÙÙˆØ¹","Ù…ØªØ£Ø®Ø±","Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„"]
            def createEditor(self, parent, _option, _index):
                w = QtWidgets.QComboBox(parent)
                w.addItems(self._opts)
                return w
            def setEditorData(self, editor, index):
                val = str(index.data() or "")
                i = editor.findText(val)
                editor.setCurrentIndex(0 if i < 0 else i)
            def setModelData(self, editor, model, index):
                model.setData(index, editor.currentText())
                txt = editor.currentText()
                from PyQt5 import QtGui, QtCore  # type: ignore
                def _bg(v):
                    if v == "Ù…Ø¯ÙÙˆØ¹":
                        return QtGui.QBrush(QtGui.QColor("#c8e6c9"))
                    if v == "Ù…ØªØ£Ø®Ø±":
                        return QtGui.QBrush(QtGui.QColor("#ffcdd2"))
                    return QtGui.QBrush(QtGui.QColor("#ffe0b2"))
                model.setData(index, _bg(txt), QtCore.Qt.BackgroundRole)
        class DateDelegate(QtWidgets.QStyledItemDelegate):
            def __init__(self, parent=None):
                super().__init__(parent)
                self._key = load_date_format_key()
            def createEditor(self, parent, _option, _index):
                from PyQt5 import QtWidgets  # type: ignore
                w = QtWidgets.QDateEdit(parent)
                w.setCalendarPopup(True)
                key = load_date_format_key()
                if key == "D-MMM-YYYY":
                    w.setDisplayFormat("d-MMM-yyyy")
                elif key == "DD/MM/YYYY":
                    w.setDisplayFormat("dd/MM/yyyy")
                elif key == "MM/DD/YYYY":
                    w.setDisplayFormat("MM/dd/yyyy")
                else:
                    w.setDisplayFormat("yyyy-MM-dd")
                return w
            def setEditorData(self, editor, index):
                s = str(index.data() or "")
                d = parse_date(s)
                from PyQt5 import QtCore  # type: ignore
                if d:
                    editor.setDate(QtCore.QDate(d.year, d.month, d.day))
            def setModelData(self, editor, model, index):
                qd = editor.date().toPyDate()
                model.setData(index, format_date_for_view(qd))
        try:
            self.table.setItemDelegateForColumn(5, StatusDelegate(self))
            self.table.setItemDelegateForColumn(1, DateDelegate(self))
            self.table.setItemDelegateForColumn(6, DateDelegate(self))
        except Exception:
            pass
        v.addWidget(self.table)
        h = QtWidgets.QHBoxLayout()
        btn_add = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø·")
        btn_del = QtWidgets.QPushButton("Ø­Ø°Ù Ù‚Ø³Ø·")
        btn_close = QtWidgets.QPushButton("Ø¥ØºÙ„Ø§Ù‚")
        h.addWidget(btn_add); h.addWidget(btn_del); h.addStretch(1); h.addWidget(btn_close)
        v.addLayout(h)
        btn_add.clicked.connect(self._add_row)
        btn_del.clicked.connect(self._del_row)
        btn_close.clicked.connect(self.accept)
        self.table.itemChanged.connect(self._on_item_changed)
        self._load_from_db()

    def _fmt_amt(self, v):
        return self.parent._format_amount(v)
    def _parse_amt(self, s):
        return self.parent._parse_amount(s)
    def _fmt_pct(self, v):
        return self.parent._format_percent(v)
    def _parse_pct(self, s):
        return self.parent._parse_percent(s)
    def _fmt_date(self, d):
        return format_date_for_view(d)
    def _parse_date(self, s):
        return parse_date(s)

    def _get_text(self, r, c):
        it = self.table.item(r, c)
        return "" if it is None else it.text()
    def _set_text(self, r, c, txt):
        it = self.table.item(r, c)
        if it is None:
            it = QtWidgets.QTableWidgetItem()
            self.table.setItem(r, c, it)
        it.setText(str(txt))
        try:
            it.setTextAlignment(QtCore.Qt.AlignCenter)
        except Exception:
            pass

    def _add_row(self):
        r = self.table.rowCount()
        self.table.insertRow(r)

    def _del_row(self):
        r = self.table.currentRow()
        if r < 0:
            return
        try:
            rid = self.table.item(r, 0).data(QtCore.Qt.UserRole)
        except Exception:
            rid = None
        if rid:
            try:
                conn = connect_db(); c = conn.cursor()
                c.execute("DELETE FROM installments WHERE id=?", (int(rid),))
                conn.commit(); conn.close()
            except Exception:
                pass
        self.table.removeRow(r)

    def _on_item_changed(self, item):
        if item is None or self._loading:
            return
        r = item.row()
        due_date = self._get_text(r, 1) or None
        amount = self._parse_amt(self._get_text(r, 2)) or 0.0
        principal_part = self._parse_amt(self._get_text(r, 3)) or 0.0
        interest_part = self._parse_amt(self._get_text(r, 4)) or 0.0
        status = self._get_text(r, 5) or None
        paid_date = self._get_text(r, 6) or None
        inst_no = None
        try:
            inst_no = int(float(self._get_text(r, 0) or 0))
        except Exception:
            inst_no = None
        try:
            it = self.table.item(r, 5)
            from PyQt5 import QtGui  # type: ignore
            def _bg(v):
                if v == "Ù…Ø¯ÙÙˆØ¹":
                    return QtGui.QBrush(QtGui.QColor("#c8e6c9"))
                if v == "Ù…ØªØ£Ø®Ø±":
                    return QtGui.QBrush(QtGui.QColor("#ffcdd2"))
                return QtGui.QBrush(QtGui.QColor("#ffe0b2"))
            if it:
                it.setBackground(_bg(status or ""))
        except Exception:
            pass
        try:
            conn = connect_db(); c = conn.cursor()
            rid = self.table.item(r, 0).data(QtCore.Qt.UserRole) if self.table.item(r, 0) else None
            if not rid:
                c.execute(
                    "INSERT INTO installments (loan_id, installment_no, due_date, amount, principal_part, interest_part, status, paid_date) VALUES (?,?,?,?,?,?,?,?)",
                    (self.loan_id, inst_no, due_date, amount, principal_part, interest_part, status, paid_date)
                )
                conn.commit()
                new_id = c.lastrowid
                it = self.table.item(r, 0)
                if it is None:
                    it = QtWidgets.QTableWidgetItem()
                    self.table.setItem(r, 0, it)
                it.setData(QtCore.Qt.UserRole, int(new_id))
            else:
                c.execute(
                    "UPDATE installments SET installment_no=?, due_date=?, amount=?, principal_part=?, interest_part=?, status=?, paid_date=? WHERE id=?",
                    (inst_no, due_date, amount, principal_part, interest_part, status, paid_date, int(rid))
                )
                conn.commit()
            conn.close()
        except Exception:
            try:
                conn.close()
            except Exception:
                pass

    def _load_from_db(self):
        self._loading = True
        try:
            self.table.blockSignals(True)
            try:
                conn = connect_db(); c = conn.cursor()
                rows = c.execute("SELECT id, installment_no, due_date, amount, principal_part, interest_part, status, paid_date FROM installments WHERE loan_id=? ORDER BY installment_no ASC, id ASC", (self.loan_id,)).fetchall()
                conn.close()
            except Exception:
                rows = []
            self.table.setRowCount(0)
            for rid, inst_no, due_date, amount, principal_part, interest_part, status, paid_date in rows:
                r = self.table.rowCount(); self.table.insertRow(r)
                self._set_text(r, 0, str(inst_no or ""))
                it0 = self.table.item(r, 0)
                if it0 is None:
                    it0 = QtWidgets.QTableWidgetItem(str(inst_no or ""))
                    self.table.setItem(r, 0, it0)
                it0.setData(QtCore.Qt.UserRole, int(rid))
                self._set_text(r, 1, format_date_for_view(due_date) if due_date else "")
                self._set_text(r, 2, self._fmt_amt(amount or 0.0))
                self._set_text(r, 3, self._fmt_amt(principal_part or 0.0))
                self._set_text(r, 4, self._fmt_amt(interest_part or 0.0))
                self._set_text(r, 5, status or "")
                self._set_text(r, 6, format_date_for_view(paid_date) if paid_date else "")
                try:
                    it = self.table.item(r, 5)
                    from PyQt5 import QtGui  # type: ignore
                    def _bg(v):
                        if v == "Ù…Ø¯ÙÙˆØ¹":
                            return QtGui.QBrush(QtGui.QColor("#c8e6c9"))
                        if v == "Ù…ØªØ£Ø®Ø±":
                            return QtGui.QBrush(QtGui.QColor("#ffcdd2"))
                        return QtGui.QBrush(QtGui.QColor("#ffe0b2"))
                    if it:
                        it.setBackground(_bg(status or ""))
                except Exception:
                    pass
        finally:
            try:
                self.table.blockSignals(False)
            except Exception:
                pass
            self._loading = False


class RepaymentsDialog(QtWidgets.QDialog):
    def __init__(self, parent, loan_id):
        super().__init__(parent)
        self.parent = parent
        self.loan_id = int(loan_id)
        self._loading = False
        self.setWindowTitle("Ø§Ù„Ø³Ø¯Ø§Ø¯")
        self.resize(760, 500)
        v = QtWidgets.QVBoxLayout(self)
        self.table = QtWidgets.QTableWidget(self)
        self.table.setColumnCount(7)
        self.table.setHorizontalHeaderLabels([
            "Ø±Ù‚Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯","Ø§Ù„Ù‚Ø±Ø¶","Ø§Ù„Ù‚Ø³Ø·","Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹","Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹","ØªØ¯ÙˆÙŠØ±"
        ])
        try:
            self.table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        except Exception:
            pass
        # Delegates
        class PayDateDelegate(QtWidgets.QStyledItemDelegate):
            def createEditor(self, parent, _option, _index):
                w = QtWidgets.QDateEdit(parent)
                w.setCalendarPopup(True)
                key = load_date_format_key()
                if key == "D-MMM-YYYY":
                    w.setDisplayFormat("d-MMM-yyyy")
                elif key == "DD/MM/YYYY":
                    w.setDisplayFormat("dd/MM/yyyy")
                elif key == "MM/DD/YYYY":
                    w.setDisplayFormat("MM/dd/yyyy")
                else:
                    w.setDisplayFormat("yyyy-MM-dd")
                return w
            def setEditorData(self, editor, index):
                s = str(index.data() or "")
                d = parse_date(s)
                if d:
                    editor.setDate(QtCore.QDate(d.year, d.month, d.day))
            def setModelData(self, editor, model, index):
                model.setData(index, format_date_for_view(editor.date().toPyDate()))
        class MethodDelegate(QtWidgets.QStyledItemDelegate):
            def createEditor(self, parent, _option, _index):
                w = QtWidgets.QComboBox(parent)
                w.addItems(["Ù†Ù‚Ø¯ÙŠ","ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ","Ø´ÙŠÙƒ","ØªØ¯ÙˆÙŠØ±"])
                return w
            def setEditorData(self, editor, index):
                val = str(index.data() or "")
                i = editor.findText(val)
                editor.setCurrentIndex(0 if i < 0 else i)
            def setModelData(self, editor, model, index):
                model.setData(index, editor.currentText())
        try:
            self.table.setItemDelegateForColumn(4, PayDateDelegate(self))
            self.table.setItemDelegateForColumn(5, MethodDelegate(self))
        except Exception:
            pass
        v.addWidget(self.table)
        h = QtWidgets.QHBoxLayout()
        btn_add = QtWidgets.QPushButton("Ø¥Ø¶Ø§ÙØ© Ø³Ø¯Ø§Ø¯")
        btn_del = QtWidgets.QPushButton("Ø­Ø°Ù Ø³Ø¯Ø§Ø¯")
        btn_roll = QtWidgets.QPushButton("ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù‚Ø±Ø¶")
        btn_close = QtWidgets.QPushButton("Ø¥ØºÙ„Ø§Ù‚")
        h.addWidget(btn_add); h.addWidget(btn_del); h.addWidget(btn_roll); h.addStretch(1); h.addWidget(btn_close)
        v.addLayout(h)
        btn_add.clicked.connect(self._add_row)
        btn_del.clicked.connect(self._del_row)
        btn_roll.clicked.connect(self._rollover)
        btn_close.clicked.connect(self.accept)
        self.table.itemChanged.connect(self._on_item_changed)
        self._load_from_db()

    def _fmt_amt(self, v): return self.parent._format_amount(v)
    def _parse_amt(self, s): return self.parent._parse_amount(s)
    def _fmt_date(self, d): return format_date_for_view(d)
    def _parse_date(self, s): return parse_date(s)
    def _set_text(self, r, c, txt):
        it = self.table.item(r, c)
        if it is None:
            it = QtWidgets.QTableWidgetItem()
            self.table.setItem(r, c, it)
        it.setText(str(txt))
        try: it.setTextAlignment(QtCore.Qt.AlignCenter)
        except Exception: pass
    def _get_text(self, r, c):
        it = self.table.item(r, c)
        return "" if it is None else it.text()

    def _add_row(self):
        r = self.table.rowCount(); self.table.insertRow(r)
        try:
            it = QtWidgets.QTableWidgetItem("")
            it.setFlags(QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsEnabled)
            self.table.setItem(r, 1, it)
        except Exception:
            pass

    def _del_row(self):
        r = self.table.currentRow()
        if r < 0: return
        try:
            rid = self.table.item(r, 0).data(QtCore.Qt.UserRole)
        except Exception:
            rid = None
        if rid:
            try:
                conn = connect_db(); c = conn.cursor()
                c.execute("DELETE FROM repayments WHERE id=?", (int(rid),))
                conn.commit(); conn.close()
            except Exception:
                pass
        self.table.removeRow(r)
        try:
            self.parent._refresh_loan_totals(self.loan_id)
        except Exception:
            pass

    def _rollover(self):
        try:
            conn = connect_db(); c = conn.cursor()
            prev = c.execute(
                "SELECT id, payment_no, installment_no, amount, pay_date FROM repayments WHERE loan_id=? AND COALESCE(roll_over,0)=0 ORDER BY id DESC LIMIT 1",
                (self.loan_id,)
            ).fetchone()
            if not prev:
                conn.close()
                return
            prev_id, pay_no, inst_no, amount, pay_date = prev
            c.execute("UPDATE repayments SET roll_over=1 WHERE id=?", (int(prev_id),))
            next_no_row = c.execute("SELECT COALESCE(MAX(payment_no),0)+1 FROM repayments WHERE loan_id=?", (self.loan_id,)).fetchone()
            next_no = int(next_no_row[0] or 1)
            c.execute(
                "INSERT INTO repayments (loan_id, payment_no, installment_no, amount, pay_date, method, roll_over) VALUES (?,?,?,?,?,?,?)",
                (self.loan_id, next_no, inst_no, amount, pay_date, "ØªØ¯ÙˆÙŠØ±", 1)
            )
            conn.commit(); conn.close()
        except Exception:
            try: conn.close()
            except Exception: pass
        try:
            self._load_from_db()
        except Exception:
            pass
        try:
            self.parent._refresh_loan_totals(self.loan_id)
        except Exception:
            pass
        try:
            self.parent._refresh_loan_totals(self.loan_id)
        except Exception:
            pass

    def _on_item_changed(self, item):
        if item is None or self._loading: return
        r = item.row()
        payment_no = None
        try:
            payment_no = int(float(self._get_text(r, 0) or 0))
        except Exception:
            payment_no = None
        _loan_display = self._get_text(r, 1)
        inst_no = None
        try:
            inst_no = int(float(self._get_text(r, 2) or 0))
        except Exception:
            inst_no = None
        amount = self._parse_amt(self._get_text(r, 3)) or 0.0
        pay_date = self._get_text(r, 4) or None
        method = self._get_text(r, 5) or None
        roll_over = 1 if (self._get_text(r, 6) or "").strip() in ("1","Ù†Ø¹Ù…","true","True") or method=="ØªØ¯ÙˆÙŠØ±" else 0
        try:
            conn = connect_db(); c = conn.cursor()
            rid = self.table.item(r, 0).data(QtCore.Qt.UserRole) if self.table.item(r, 0) else None
            if not rid:
                c.execute(
                    "INSERT INTO repayments (loan_id, payment_no, installment_no, amount, pay_date, method, roll_over) VALUES (?,?,?,?,?,?,?)",
                    (self.loan_id, payment_no, inst_no, amount, pay_date, method, roll_over)
                )
                conn.commit()
                new_id = c.lastrowid
                it = self.table.item(r, 0)
                if it is None:
                    it = QtWidgets.QTableWidgetItem()
                    self.table.setItem(r, 0, it)
                it.setData(QtCore.Qt.UserRole, int(new_id))
            else:
                c.execute(
                    "UPDATE repayments SET payment_no=?, installment_no=?, amount=?, pay_date=?, method=?, roll_over=? WHERE id=?",
                    (payment_no, inst_no, amount, pay_date, method, roll_over, int(rid))
                )
                conn.commit()
            conn.close()
        except Exception:
            try: conn.close()
            except Exception: pass
        try:
            self.parent._refresh_loan_totals(self.loan_id)
        except Exception:
            pass

    def _load_from_db(self):
        self._loading = True
        try:
            self.table.blockSignals(True)
            try:
                conn = connect_db(); c = conn.cursor()
                rows = c.execute("SELECT id, payment_no, installment_no, amount, pay_date, method, roll_over FROM repayments WHERE loan_id=? ORDER BY payment_no ASC, id ASC", (self.loan_id,)).fetchall()
                conn.close()
            except Exception:
                rows = []
            self.table.setRowCount(0)
            for rid, pay_no, inst_no, amount, pay_date, method, roll_over in rows:
                r = self.table.rowCount(); self.table.insertRow(r)
                self._set_text(r, 0, str(pay_no or ""))
                it0 = self.table.item(r, 0)
                if it0 is None:
                    it0 = QtWidgets.QTableWidgetItem(str(pay_no or ""))
                    self.table.setItem(r, 0, it0)
                it0.setData(QtCore.Qt.UserRole, int(rid))
                try:
                    it1 = QtWidgets.QTableWidgetItem("")
                    it1.setFlags(QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsEnabled)
                    self.table.setItem(r, 1, it1)
                except Exception:
                    self._set_text(r, 1, "")
                self._set_text(r, 2, str(inst_no or ""))
                self._set_text(r, 3, self._fmt_amt(amount or 0.0))
                self._set_text(r, 4, format_date_for_view(pay_date) if pay_date else "")
                self._set_text(r, 5, method or "")
                self._set_text(r, 6, "1" if int(roll_over or 0) else "0")
        finally:
            try: self.table.blockSignals(False)
            except Exception: pass
            self._loading = False
def load_sort_settings():
    """Load sorting settings from QSettings."""
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        sort_by = s.value("sort/by", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±")
        sort_by2 = s.value("sort/by2", "Ø¨Ø¯ÙˆÙ†")
        sort_order = s.value("sort/order", "ØªØµØ§Ø¹Ø¯ÙŠ")
        return sort_by, sort_by2, sort_order
    except Exception:
        return "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", "Ø¨Ø¯ÙˆÙ†", "ØªØµØ§Ø¹Ø¯ÙŠ"


def save_sort_settings(sort_by, sort_by2, sort_order):
    """Save sorting settings to QSettings."""
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        s.setValue("sort/by", sort_by)
        s.setValue("sort/by2", sort_by2)
        s.setValue("sort/order", sort_order)
    except Exception:
        pass


def apply_sort_settings(sort_by, sort_by2, sort_order):
    """Apply sorting settings to the main window and refresh the table."""
    try:
        # Save settings
        save_sort_settings(sort_by, sort_by2, sort_order)
        
        # Refresh the table if main window exists
        main_win = None
        for widget in QtWidgets.QApplication.topLevelWidgets():
            if isinstance(widget, MainWindow):
                main_win = widget
                break
        
        if main_win:
            main_win.refresh()
            
    except Exception:
        pass


def get_sort_sql_clause():
    """Get SQL ORDER BY clause based on current sorting settings."""
    try:
        sort_by, sort_by2, sort_order = load_sort_settings()
        
        # Map Arabic field names to database column names
        field_mapping = {
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±": "issue_date",
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡": "end_date", 
            "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†": "g_no",
            "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯": "entry_number",
            "Ø§Ù„Ù…Ø¨Ù„Øº": "amount",
            "Ø§Ù„Ø¨Ù†Ùƒ": "bank",
            "Ø§Ù„Ø¬Ù‡Ø©": "department"
        }
        
        # Determine sort direction
        is_desc = (sort_order == "ØªÙ†Ø§Ø²Ù„ÙŠ")
        
        # Handle special bank sorting options
        if sort_by == "Ø¨Ù†Ùƒ Ø«Ù… ØªØ§Ø±ÙŠØ®":
            order_clause = f" ORDER BY bank {'DESC' if is_desc else 'ASC'}, issue_date {'DESC' if is_desc else 'ASC'}"
        elif sort_by == "Ø¨Ù†Ùƒ Ø«Ù… Ù…Ø¨Ù„Øº":
            order_clause = f" ORDER BY bank {'DESC' if is_desc else 'ASC'}, amount {'DESC' if is_desc else 'ASC'}"
        elif sort_by == "Ø¨Ù†Ùƒ Ø«Ù… Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯":
            order_clause = f" ORDER BY bank {'DESC' if is_desc else 'ASC'}, CAST(entry_number AS INTEGER) {'DESC' if is_desc else 'ASC'}, entry_number {'DESC' if is_desc else 'ASC'}"
        else:
            # Get primary database field name
            db_field = field_mapping.get(sort_by, "issue_date")
            
            # Build ORDER BY clause
            if db_field == "entry_number":
                order_clause = f" ORDER BY CAST(entry_number AS INTEGER) {'DESC' if is_desc else 'ASC'}, entry_number {'DESC' if is_desc else 'ASC'}"
            else:
                order_clause = f" ORDER BY {db_field} {'DESC' if is_desc else 'ASC'}"
            
            # Add secondary sort if specified
            if sort_by2 and sort_by2 != "Ø¨Ø¯ÙˆÙ†":
                db_field2 = field_mapping.get(sort_by2, "issue_date")
                order_clause += f", {db_field2} {'DESC' if is_desc else 'ASC'}"
        
        return order_clause
        
    except Exception:
        return " ORDER BY issue_date ASC"


def show_settings_dialog(self):
    dlg = SettingsDialog(self)
    dlg.exec_()


MainWindow.show_settings_dialog = show_settings_dialog



def safe_show_settings_dialog(self):
    """Open Settings dialog safely. If anything goes wrong, show a minimal fallback dialog."""
    try:
        dlg = SettingsDialog(self)
        dlg.exec_()
    except Exception as e:
        try:
            fb = QtWidgets.QDialog(self)
            fb.setWindowTitle("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙˆØ¶Ø¹ Ø¢Ù…Ù†)")
            lay = QtWidgets.QVBoxLayout(fb)
            lab = QtWidgets.QLabel("ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.\n\n" + str(e));
            lab.setWordWrap(True)
            lay.addWidget(lab)
            btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Close, fb)
            btns.rejected.connect(fb.reject)
            btns.button(QtWidgets.QDialogButtonBox.Close).clicked.connect(fb.close)
            lay.addWidget(btns)
            fb.exec_()
        except Exception:
            pass


# Bind methods to MainWindow
# MainWindow.preview = preview
# MainWindow.print_all_depts = print_all_depts
# MainWindow.load_brand_settings = load_brand_settings
# MainWindow.apply_brand_settings = apply_brand_settings
# MainWindow.ensure_brand_defaults_enabled = ensure_brand_defaults_enabled
# MainWindow._print_with_branding = _print_with_branding
# MainWindow.eventFilter = eventFilter
# MainWindow.export_pdf = export_pdf
# try:
#     MainWindow.save_table_geometry = save_table_geometry
#     MainWindow.load_table_geometry = load_table_geometry
#     MainWindow.apply_table_geometry = apply_table_geometry
# except Exception:
#     pass

class RecycleBinDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª")
        self.resize(900, 600)
        lay = QtWidgets.QVBoxLayout(self)
        self.table = QtWidgets.QTableWidget(self)
        self.table.setColumnCount(6)
        self.table.setHorizontalHeaderLabels(["Ø§Ù„Ø¨Ù†Ùƒ", "Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†", "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯", "Ø§Ù„Ù‚Ø³Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù", ""])
        self.table.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.Stretch)
        lay.addWidget(self.table)
        btns = QtWidgets.QHBoxLayout()
        self.btn_restore = QtWidgets.QPushButton("Ø§Ø³ØªØ±Ø¬Ø§Ø¹")
        self.btn_purge = QtWidgets.QPushButton("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ")
        self.btn_close = QtWidgets.QPushButton("Ø¥ØºÙ„Ø§Ù‚")
        btns.addStretch(1)
        btns.addWidget(self.btn_restore)
        btns.addWidget(self.btn_purge)
        btns.addWidget(self.btn_close)
        lay.addLayout(btns)
        self.btn_close.clicked.connect(self.close)
        self.btn_restore.clicked.connect(self.restore_selected)
        self.btn_purge.clicked.connect(self.purge_selected)
        self.reload()

    def reload(self):
        self.table.setRowCount(0)
        try:
            conn = connect_db(); c = conn.cursor()
            rows = c.execute("""SELECT rowid, bank, g_no, entry_number, department, deleted_at
                                FROM trash_guarantees ORDER BY deleted_at DESC""").fetchall()
            conn.close()
        except Exception:
            rows = []
        for (rid, bank, gno, en, dept, d_at) in rows:
            r = self.table.rowCount()
            self.table.insertRow(r)
            items = [bank or "", gno or "", en or "", dept or "", d_at or ""]
            for i, val in enumerate(items):
                it = QtWidgets.QTableWidgetItem(str(val))
                it.setData(QtCore.Qt.UserRole, int(rid) if i == 1 else None)
                self.table.setItem(r, i, it)
            self.table.setItem(r, 5, QtWidgets.QTableWidgetItem(""))

    def _selected_rids(self):
        rows = set(i.row() for i in self.table.selectedIndexes())
        if not rows and self.table.currentRow() >= 0:
            rows = {self.table.currentRow()}
        rids = []
        for r in sorted(rows):
            it = self.table.item(r, 1)
            rid = it.data(QtCore.Qt.UserRole) if it else None
            if rid is not None:
                rids.append(int(rid))
        return rids

    def restore_selected(self):
        rids = self._selected_rids()
        if not rids:
            QtWidgets.QMessageBox.information(self, "Ø§Ø³ØªØ±Ø¬Ø§Ø¹", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            return
        restored = 0
        try:
            conn = connect_db(); c = conn.cursor()
            for rid in rids:
                row = c.execute("""SELECT department, bank, g_no, g_type, amount, insurance_amount, percent,
                                          beneficiary, requester, project_name, issue_date, end_date, user_status,
                                          cash_flag, attachment, delivery_status, recipient_name, notes, entry_number
                                   FROM trash_guarantees WHERE rowid=?""", (rid,)).fetchone()
                if not row:
                    continue
                # Ø£Ø¹Ø¯ Ø¥Ø¯Ø±Ø§Ø¬/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¶Ù…Ø§Ù†
                gno = normalize_gno(str(row[2] or ""))
                existing = c.execute("SELECT rowid FROM guarantees WHERE g_no=?", (gno,)).fetchone()
                if existing:
                    c.execute("""UPDATE guarantees SET department=?, bank=?, g_type=?, amount=?, insurance_amount=?, percent=?,
                                 beneficiary=?, requester=?, project_name=?, issue_date=?, end_date=?, user_status=?, cash_flag=?,
                                 attachment=?, delivery_status=?, recipient_name=?, notes=?, entry_number=? WHERE g_no=?""",
                              (row[0], row[1], row[3], row[4], row[5], row[6],
                               row[7], row[8], row[9], row[10], row[11], row[12], row[13],
                               row[14], row[15], row[16], row[17], row[18], gno))
                else:
                    c.execute("""INSERT INTO guarantees (department, bank, g_no, g_type, amount, insurance_amount, percent,
                                 beneficiary, requester, project_name, issue_date, end_date, user_status, cash_flag, attachment,
                                 delivery_status, recipient_name, notes, entry_number)
                                 VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)""",
                              (row[0], row[1], gno, row[3], row[4], row[5], row[6],
                               row[7], row[8], row[9], row[10], row[11], row[12], row[13], row[14],
                               row[15], row[16], row[17], row[18]))
                # Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                atts = c.execute("SELECT g_no, path, notes FROM trash_attachments WHERE g_no=?", (gno,)).fetchall()
                for (ag, ap, an) in atts:
                    try:
                        c.execute("INSERT INTO attachments (g_no, path, notes) VALUES (?,?,?)", (ag, ap, an))
                    except Exception:
                        pass
                # Ø§Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ù„Ø©
                c.execute("DELETE FROM trash_attachments WHERE g_no=?", (gno,))
                c.execute("DELETE FROM trash_guarantees WHERE rowid=?", (rid,))
                restored += 1
            conn.commit(); conn.close()
        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "Ø§Ø³ØªØ±Ø¬Ø§Ø¹", f"ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹: {e}")
            return
        QtWidgets.QMessageBox.information(self, "ØªÙ…", f"ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ {restored} Ø³Ø¬Ù„(Ø§Øª).")
        self.reload()

    def purge_selected(self):
        rids = self._selected_rids()
        if not rids:
            QtWidgets.QMessageBox.information(self, "Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ", "Ø§Ø®ØªØ± ØµÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            return
        ret = QtWidgets.QMessageBox.question(self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
                                             "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§ØªØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                                             QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
                                             QtWidgets.QMessageBox.No)
        if ret != QtWidgets.QMessageBox.Yes:
            return
        purged = 0
        try:
            conn = connect_db(); c = conn.cursor()
            for rid in rids:
                row = c.execute("SELECT g_no FROM trash_guarantees WHERE rowid=?", (rid,)).fetchone()
                gno = normalize_gno(str(row[0] or "")) if row else ""
                # Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø© ÙˆÙ…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª ÙØ¹Ù„ÙŠÙ‹Ø§
                try:
                    arows = c.execute("SELECT path FROM trash_attachments WHERE g_no=?", (gno,)).fetchall()
                    for (p,) in arows:
                        try:
                            ap = resolve_attachment_path(p)
                            from pathlib import Path as _P
                            _P(ap).unlink(missing_ok=True)
                        except Exception:
                            pass
                    c.execute("DELETE FROM trash_attachments WHERE g_no=?", (gno,))
                except Exception:
                    pass
                c.execute("DELETE FROM trash_guarantees WHERE rowid=?", (rid,))
                purged += 1
            conn.commit(); conn.close()
        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ", f"ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: {e}")
            return
        QtWidgets.QMessageBox.information(self, "ØªÙ…", f"ØªÙ… Ø­Ø°Ù {purged} Ø³Ø¬Ù„(Ø§Øª) Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.")
        self.reload()


def open_trash_dialog(self):
    dlg = RecycleBinDialog(self)
    dlg.exec_()


def closeEvent(self, e):
    try:
        save_table_geometry(self)
    except Exception:
        pass
    try:
        save_table_geometry(self)
    except Exception:
        pass
    try:
        super(MainWindow, self).closeEvent(e)
    except Exception:
        try:
            e.accept()
        except Exception:
            pass


# Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø¨Ù€Ù€ MainWindow
# MainWindow.show_size_settings = show_size_settings


# ============================================================================
# Excel Typist - Ø£Ø¯Ø§Ø© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Excel ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
# ============================================================================
class TypistWindow(QtWidgets.QWidget):
    """Ù†Ø§ÙØ°Ø© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Excel ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"""
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Excel Typist â€” Simple")
        self.setLayout(QtWidgets.QVBoxLayout())

        info = QtWidgets.QLabel(
            "Paste lines below. Click Start, then click a cell in Excel.\n"
            "Typing runs line-by-line into rows. Press ESC to stop.")
        info.setWordWrap(True)
        self.layout().addWidget(info)

        self.text = QtWidgets.QPlainTextEdit()
        self.text.setPlaceholderText("One item per lineâ€¦")
        self.layout().addWidget(self.text)

        opts = QtWidgets.QHBoxLayout()
        self.delay = QtWidgets.QDoubleSpinBox()
        self.delay.setRange(0.01, 2.0)
        self.delay.setSingleStep(0.05)
        self.delay.setValue(0.10)
        self.delay.setSuffix(" s/keystroke")
        opts.addWidget(QtWidgets.QLabel("Delay:"))
        opts.addWidget(self.delay)

        self.countdown = QtWidgets.QSpinBox()
        self.countdown.setRange(0, 10)
        self.countdown.setValue(3)
        self.countdown.setSuffix(" s start")
        opts.addWidget(QtWidgets.QLabel("Countdown:"))
        opts.addWidget(self.countdown)

        self.direction = QtWidgets.QComboBox()
        self.direction.addItems(["Down (rows)", "Right (columns)"])
        opts.addWidget(self.direction)
        opts.addStretch(1)
        self.layout().addLayout(opts)

        btns = QtWidgets.QHBoxLayout()
        self.btn_start = QtWidgets.QPushButton("Start Typing")
        self.btn_stop = QtWidgets.QPushButton("Stop")
        self.btn_stop.setEnabled(False)
        btns.addWidget(self.btn_start)
        btns.addWidget(self.btn_stop)
        self.layout().addLayout(btns)

        self.btn_start.clicked.connect(self.start_typing)
        self.btn_stop.clicked.connect(self.stop_typing)

        # ESC hotkey
        QtWidgets.QShortcut(QtGui.QKeySequence("Esc"), self, activated=self.stop_typing)

        self._running = False

    def _lines(self):
        return [ln for ln in self.text.toPlainText().splitlines() if ln.strip()]

    def start_typing(self):
        try:
            import pyautogui  # type: ignore
        except Exception:
            QtWidgets.QMessageBox.critical(self, "Missing dependency",
                                           "pyautogui is not installed. Please run: pip install pyautogui")
            return
        items = self._lines()
        if not items:
            QtWidgets.QMessageBox.information(self, "No data", "Please paste some lines to type.")
            return

        self._running = True
        self.btn_start.setEnabled(False)
        self.btn_stop.setEnabled(True)

        # Countdown so the user can focus Excel and select the starting cell
        import time
        cd = self.countdown.value()
        for i in range(cd, 0, -1):
            self.btn_start.setText(f"Starting in {i}â€¦")
            QtWidgets.QApplication.processEvents()
            time.sleep(1)
        self.btn_start.setText("Typingâ€¦")

        # Typing loop
        step_delay = self.delay.value()
        move_key = 'down' if self.direction.currentIndex() == 0 else 'right'
        try:
            import pyautogui  # type: ignore
            for i, text in enumerate(items, 1):
                if not self._running:
                    break
                pyautogui.typewrite(text, interval=step_delay)
                pyautogui.press('enter')  # commit the cell
                pyautogui.press(move_key)  # move to next cell
        finally:
            self.btn_start.setText("Start Typing")
            self.btn_start.setEnabled(True)
            self.btn_stop.setEnabled(False)
            self._running = False

    def stop_typing(self):
        self._running = False


# ============================================================================
# Export Database to CSV - ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª CSV
# ============================================================================
def export_database_to_csv(sqlite_path=None, output_dir=None):
    """ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª CSV
    
    Args:
        sqlite_path: Ù…Ø³Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠØ³ØªØ®Ø¯Ù… db_path() Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ­Ø¯Ø¯)
        output_dir: Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠØ³ØªØ®Ø¯Ù… Desktop/Guarantees_Export Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ­Ø¯Ø¯)
    """
    import csv
    import os
    from pathlib import Path
    
    if sqlite_path is None:
        sqlite_path = db_path()
    
    if output_dir is None:
        output_dir = str(Path.home() / "Desktop" / "Guarantees_Export")
    
    os.makedirs(output_dir, exist_ok=True)
    
    try:
        conn = sqlite3.connect(sqlite_path)
        cur = conn.cursor()
        tables = [r[0] for r in cur.execute("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'")]
        print("Tables:", tables)
        
        for t in tables:
            rows = cur.execute(f"SELECT * FROM {t}")
            cols = [d[0] for d in rows.description]
            out_csv = os.path.join(output_dir, f"{t}.csv")
            with open(out_csv, "w", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                w.writerow(cols)
                w.writerows(rows)
            print("Exported:", out_csv)
        
        conn.close()
        print("Done.")
        return True
    except Exception as e:
        print(f"Error exporting database: {e}")
        return False


if __name__ == "__main__":
    def _hash_password(p: str) -> str:
        try:
            import hashlib
            try:
                p = (p or "").translate(ARABIC_DIGITS).strip()
            except Exception:
                p = (p or "").strip()
            return hashlib.sha256(p.encode("utf-8")).hexdigest()
        except Exception:
            return ""
    def ensure_default_user():
        try:
            conn = connect_db(); c = conn.cursor()
            row = c.execute("SELECT id FROM users WHERE username=?", ("MELADL",)).fetchone()
            if not row:
                c.execute("INSERT INTO users (username, pass_hash, role, active) VALUES (?,?,?,?)",
                          ("MELADL", _hash_password("7799"), "admin", 1))
                conn.commit()
            conn.close()
        except Exception:
            pass
    def verify_user(username: str, password: str) -> bool:
        return True
    ensure_db()
    app = QtWidgets.QApplication(sys.argv)
    app.setLayoutDirection(QtCore.Qt.RightToLeft)
    try:
        _s = QtCore.QSettings("GuaranteesApp", "Main")
        _theme_name = _s.value("theme/name", "dark")
        apply_theme(app, _theme_name)
    except Exception:
        set_dark_theme(app)
    class LoginDialog(QtWidgets.QDialog):
        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
            self.resize(420, 300)
            v = QtWidgets.QVBoxLayout(self)
            try:
                logo = _read_brand_logo_path()
            except Exception:
                logo = ""
            lbl_logo = QtWidgets.QLabel(); lbl_logo.setAlignment(QtCore.Qt.AlignCenter)
            if logo:
                pm = QtGui.QPixmap(logo)
                if not pm.isNull():
                    lbl_logo.setPixmap(pm.scaledToHeight(80, QtCore.Qt.SmoothTransformation))
            v.addWidget(lbl_logo)
            form = QtWidgets.QFormLayout()
            self.ed_user = QtWidgets.QLineEdit(); self.ed_user.setPlaceholderText("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            self.ed_pass = QtWidgets.QLineEdit(); self.ed_pass.setPlaceholderText("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); self.ed_pass.setEchoMode(QtWidgets.QLineEdit.Password)
            btn_eye = QtWidgets.QToolButton(); btn_eye.setText("ğŸ‘")
            try:
                btn_eye.setCheckable(True)
                btn_eye.setToolTip("Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
                btn_eye.clicked.connect(lambda checked=False: self.ed_pass.setEchoMode(QtWidgets.QLineEdit.Normal if btn_eye.isChecked() else QtWidgets.QLineEdit.Password))
            except Exception:
                pass
            row_pw = QtWidgets.QHBoxLayout(); row_pw.addWidget(self.ed_pass); row_pw.addWidget(btn_eye)
            wrap_pw = QtWidgets.QWidget(); wrap_pw.setLayout(row_pw)
            form.addRow("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", self.ed_user)
            form.addRow("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:", wrap_pw)
            v.addLayout(form)
            btns = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel)
            v.addWidget(btns)
            def _accept():
                u = (self.ed_user.text() or "").strip().upper();
                p = (self.ed_pass.text() or "").translate(ARABIC_DIGITS).strip()
                if verify_user(u, p) or (u == "MELADL" and p == "7799"):
                    s = QtCore.QSettings("GuaranteesApp", "Main"); s.setValue("user/current", u)
                    self.accept()
                else:
                    QtWidgets.QMessageBox.warning(self, "Ø§Ù„Ø¯Ø®ÙˆÙ„", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
            btns.accepted.connect(_accept); btns.rejected.connect(self.reject)
        def result_user(self):
            return self.ed_user.text().strip()

    class ModuleChooserDialog(QtWidgets.QDialog):
        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle("Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")
            self.resize(420, 260)
            v = QtWidgets.QVBoxLayout(self)
            v.setSpacing(16)
            v.setContentsMargins(18, 18, 18, 18)
            btn_g = QtWidgets.QPushButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª")
            btn_l = QtWidgets.QPushButton("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶")
            for b in (btn_g, btn_l):
                try:
                    b.setMinimumHeight(64)
                    f = b.font(); f.setPointSize(f.pointSize() + 3); b.setFont(f)
                except Exception:
                    pass
                v.addWidget(b)
            v.addStretch(1)
            self._choice = "guarantees"
            btn_g.clicked.connect(lambda: self._set_choice_and_accept("guarantees"))
            btn_l.clicked.connect(lambda: self._set_choice_and_accept("loans"))
        def _set_choice_and_accept(self, c):
            self._choice = c
            self.accept()
        def result_choice(self):
            return self._choice

    s = QtCore.QSettings("GuaranteesApp", "Main")
    try:
        s.setValue("user/current", "")
    except Exception:
        pass
    chooser = ModuleChooserDialog()
    _res = chooser.exec_()
    if _res != QtWidgets.QDialog.Accepted:
        sys.exit(0)
    ch = chooser.result_choice()
    w = LoansWindow() if ch == "loans" else MainWindow()
    try:
        w.current_user = ""
    except Exception:
        w.current_user = ""
    w.show()
    try:
        if hasattr(w, 'user_btn'):
            w.user_btn.hide()
    except Exception:
        pass
    if isinstance(w, MainWindow):
        try:
            w.table.setWordWrap(True)
            if hasattr(w.table, 'setTextElideMode'):
                w.table.setTextElideMode(QtCore.Qt.ElideNone)
            w._wrap_delegate = WrapTextDelegate(w.table)
            w.table.setItemDelegate(w._wrap_delegate)
            if hasattr(w.table, 'setAlternatingRowColors'):
                w.table.setAlternatingRowColors(True)
            w.table.resizeRowsToContents()
        except Exception:
            pass
    if isinstance(w, MainWindow):
        try:
            _wn, _wi, _h = load_table_geometry(w)
            apply_table_geometry(w, _wn, _wi, None)
        except Exception:
            pass
    # ØªÙØ¹ÙŠÙ„ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„ØµÙÙˆÙ + ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    if isinstance(w, MainWindow):
        try:
            hh = w.table.horizontalHeader()
            vh = w.table.verticalHeader()
            hh.setSectionsMovable(True)
            hh.sectionResized.connect(w._on_col_resized)
            hh.sectionMoved.connect(w._on_col_moved)
            vh.sectionResized.connect(w._on_row_resized)
        except Exception:
            pass
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©
    if isinstance(w, MainWindow):
        try:
            _w, _h = w.load_table_geometry()
            w.apply_table_geometry(_w, None)
        except Exception:
            pass
    # Ø§Ø®ØªØµØ§Ø± Ø­ÙØ¸ Ø§Ù„Ø®Ø·ÙˆØ§Øª
    try:
        _sc_save = QtWidgets.QShortcut(QtGui.QKeySequence("Ctrl+S"), w)
        _sc_save.activated.connect(w.save_all_settings)
    except Exception:
        pass
    
    # Start the application event loop
    sys.exit(app.exec_())


def load_brand_settings(self):
    s = QtCore.QSettings("GuaranteesApp", "Main")
    return {"wm_enabled": bool(int(s.value("watermark/enabled", 0) or 0)),
            "wm_path": s.value("watermark/path", type=str) or "",
            "wm_opacity": float(s.value("watermark/opacity", 0.08) or 0.08),
            "wm_scale": float(s.value("watermark/scale", 0.40) or 0.40),
            "logo_enabled": bool(int(s.value("logo/enabled", 1) or 1)),
            "logo_path": s.value("logo/path", type=str) or (s.value("watermark/path", type=str) or ""),
            "logo_height": int(s.value("logo/height", 48) or 48),
            "app_icon_enabled": bool(int(s.value("logo/appIconEnabled", 1) or 1)),
            "app_banner_enabled": bool(int(s.value("logo/appBannerEnabled", 1) or 1)),
            "app_banner_height": int(s.value("logo/appBannerHeight", 28) or 28)}


def apply_brand_settings(self):
    cfg = load_brand_settings(self)
    try:
        if getattr(self, "_wm_overlay", None):
            self._wm_overlay.set_config(path=cfg["wm_path"], enabled=cfg["wm_enabled"],
                                        opacity=cfg["wm_opacity"], scale=cfg["wm_scale"])
    except Exception:
        pass


def show_brand_settings(self):
    dlg = WatermarkSettingsDialog(self)
    if dlg.exec_() == QtWidgets.QDialog.Accepted:
        vals = dlg.result_values()
        s = QtCore.QSettings("GuaranteesApp", "Main")
        for k, v in vals.items(): s.setValue(k, v)
        self.apply_brand_settings()
        try:
            QtWidgets.QMessageBox.information(self, "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "ØªÙ… Ø­ÙØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©.")
        except Exception:
            pass


def _print_with_branding(self, printer):
    cfg = load_brand_settings(self)
    painter = QtGui.QPainter(printer)

    # Watermark (Ø®Ù„Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰)
    if cfg.get("wm_enabled") and cfg.get("wm_path"):
        pm = QtGui.QPixmap(cfg["wm_path"])
        if not pm.isNull():
            vp = painter.viewport()
            size = int(min(vp.width(), vp.height()) * float(cfg.get("wm_scale", 0.40)))
            pm2 = pm.scaled(size, size, QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation)
            painter.save()
            painter.setOpacity(float(cfg.get("wm_opacity", 0.08)))
            painter.drawPixmap(vp.x() + (vp.width() - pm2.width()) // 2,
                               vp.y() + (vp.height() - pm2.height()) // 2, pm2)
            painter.restore()

    # Ø´Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    y_offset = 0
    if cfg.get("logo_enabled") and cfg.get("logo_path"):
        lp = QtGui.QPixmap(cfg["logo_path"])
        if not lp.isNull():
            h = max(16, int(cfg.get("logo_height", 48)))
            lp2 = lp.scaledToHeight(h, QtCore.Qt.SmoothTransformation)
            painter.drawPixmap(30, 30, lp2)
            y_offset = 30 + lp2.height() + 10

    # Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙˆØ­Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (Points) Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³
    rect_pt = printer.pageRect(QtPrintSupport.QPrinter.Point)
    content = QtCore.QRectF(rect_pt)
    content.adjust(30, y_offset + 10, -30, -30)

    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§ØªØŒ Ø§Ø·Ø¨Ø¹ Ù„Ù‚Ø·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    try:
        current = self.tabs.currentWidget() if hasattr(self, "tabs") else None
        if current is not None and current is getattr(self, "_kpis_tab_widget", None):
            widget = current
            size = widget.size()
            if size.width() <= 0 or size.height() <= 0:
                size = widget.sizeHint()
            total_w = max(1, int(size.width()))
            total_h = max(1, int(size.height()))
            kx = float(content.width()) / float(total_w)
            ky = float(content.height()) / float(total_h)
            k = min(kx, ky)
            painter.save()
            painter.translate(content.left(), content.top())
            painter.scale(k, k)
            widget.render(painter, QtCore.QPoint(), QtGui.QRegion(widget.rect()))
            painter.restore()
            painter.end()
            return
    except Exception:
        pass

    # Ø®Ù„Ø§Ù Ø°Ù„Ùƒ: Ø§Ø·Ø¨Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª ÙƒÙ€ HTML Ø¨Ø³ÙŠØ·
    doc = QtGui.QTextDocument()
    row_cnt = self.table.rowCount() if hasattr(self, "table") else 0
    html = "<h3>ØªÙ‚Ø±ÙŠØ± Ø¨Ø³ÙŠØ·</h3><table border='1' width='100%'><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¶Ù…Ø§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>"
    for r in range(row_cnt):
        try:
            gno = self.table.item(r, 2).text()
            st = self.table.item(r, 13).text()
        except Exception:
            gno, st = "", ""
        html += f"<tr><td>{gno}</td><td>{st}</td></tr>"
    if row_cnt == 0:
        html += "<tr><td colspan='2' style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>"
    html += "</table>"
    doc.setHtml(html)
    doc.setPageSize(QtCore.QSizeF(rect_pt.size()))

    painter.save()
    doc.drawContents(painter, content)
    painter.restore()
    painter.end()


def eventFilter(self, obj, event):
    try:
        if (obj is self.table.viewport()) and getattr(self, "_wm_overlay", None):
            if event.type() in (QtCore.QEvent.Resize, QtCore.QEvent.Show):
                self._wm_overlay.setGeometry(obj.rect())
    except Exception:
        pass
    return QtWidgets.QMainWindow.eventFilter(self, obj, event)


# Bind methods to MainWindow
# MainWindow.load_brand_settings = load_brand_settings
# MainWindow.apply_brand_settings = apply_brand_settings
# MainWindow.show_brand_settings = show_brand_settings
# MainWindow.ensure_brand_defaults_enabled = ensure_brand_defaults_enabled
# MainWindow._print_with_branding = _print_with_branding
# MainWindow.eventFilter = eventFilter

# Bind brand methods to LoansWindow as well
try:
    LoansWindow.apply_brand_settings = apply_brand_settings
    LoansWindow.show_brand_settings = show_brand_settings
except Exception:
    pass

# Bind top-level closeEvent to MainWindow
# try:
#     MainWindow.closeEvent = closeEvent
# except Exception:
#     pass

# -- Bind confirmation helpers as MainWindow methods (so .clicked.connect(self._confirm_...) works) --
# try:
#     MainWindow._confirm_unmark_selected_done = _confirm_unmark_selected_done
#     MainWindow._confirm_mark_selected_done = _confirm_mark_selected_done
# except Exception:
#     pass
# MainWindow.save_all_settings = save_all_settings
# --- Initialize portable settings and migrate data at startup ---
try:
    _patch_qsettings()  # Patch QSettings to use portable INI format
except Exception:
    pass

# --- Ensure DB schema & migrate legacy location at import time ---
try:
    migrate_old_db_if_any()  # Migrate old data to portable location
except Exception:
    pass
try:
    ensure_db()
except Exception:
    pass


# ===== Geometry persistence (columns widths & row heights) =====


def _norm_col_name(txt):
    try:
        import re as _re
        if txt is None:
            return ""
        s = str(txt)
        s = s.replace("\u200f", "").replace("\u200e", "")
        s = _re.sub(r"\s+", " ", s).strip()
        return s
    except Exception:
        return str(txt or "")


def save_table_geometry(self):
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        by_name = {};
        by_index = []
        try:
            for i in range(self.table.columnCount()):
                it = self.table.horizontalHeaderItem(i)
                nm = _norm_col_name(it.text() if it else str(i))
                w = int(self.table.columnWidth(i));
                by_name[nm] = w;
                by_index.append(w)
        except Exception:
            pass
        s.setValue("columns/widths_by_name", by_name)
        s.setValue("columns/widths_by_index", by_index)
        try:
            heights = [int(self.table.rowHeight(r)) for r in range(self.table.rowCount())]
        except Exception:
            heights = []
        s.setValue("rows/heights", heights)
    except Exception:
        pass


def load_table_geometry(self):
    try:
        s = QtCore.QSettings("GuaranteesApp", "Main")
        by_name = s.value("columns/widths_by_name", type=dict) or {}
        if not isinstance(by_name, dict): by_name = {}
        by_name = {_norm_col_name(k): int(v) for k, v in by_name.items() if str(v).strip() != ""}
        by_index = s.value("columns/widths_by_index", type=list) or []
        if not isinstance(by_index, list): by_index = []
        by_index = [int(v) for v in by_index if str(v).strip() != ""]
        heights = s.value("rows/heights", type=list) or []
        if not isinstance(heights, list): heights = []
        heights = [int(h) for h in heights if str(h).strip() != ""]
        return by_name, by_index, heights
    except Exception:
        return {}, [], []


def apply_table_geometry(self, widths_by_name=None, widths_by_index=None, row_heights=None):
    # columns
    try:
        if widths_by_name or widths_by_index:
            for i in range(self.table.columnCount()):
                try:
                    it = self.table.horizontalHeaderItem(i)
                    nm = _norm_col_name(it.text() if it else str(i))
                    w = None
                    if widths_by_name and nm in widths_by_name:
                        w = int(widths_by_name[nm])
                    elif widths_by_index and i < len(widths_by_index):
                        w = int(widths_by_index[i])
                    if w and w > 0:
                        self.table.setColumnWidth(i, w)
                except Exception:
                    pass
    except Exception:
        pass
    # rows
    try:
        if row_heights and self.table.rowCount() > 0:
            m = min(self.table.rowCount(), len(row_heights))
            for r in range(m):
                try:
                    h = int(row_heights[r])
                    if h > 0:
                        self.table.setRowHeight(r, h)
                except Exception:
                    pass
    except Exception:
        pass


 # Ù…Ø­Ø°ÙˆÙ: Ù…Ø¹Ø§Ù„Ø¬Ø§Øª ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·Ø© Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©/Ø§Ù„ØµÙÙˆÙ (Ù†ÙØ³Ø® Ø­Ø¯ÙŠØ«Ø© ÙˆÙ„ÙƒÙ† ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø©)


# ØºÙ„Ø§Ù ÙŠÙÙˆÙÙ‘Ø± show_import_excel Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…Ø¹Ø±ÙÙ‹Ø§ØŒ ÙˆÙŠØ³ØªØ¯Ø¹ÙŠ do_import
try:
    if not hasattr(MainWindow, "show_import_excel"):
        def _mw_show_import_excel(self):
            try:
                return self.do_import()
            except Exception:
                pass
        MainWindow.show_import_excel = _mw_show_import_excel
except Exception:
    pass


# =========================
# Toolbar Excel Export (safe patch)
# =========================

# Provide export_excel if it's missing on MainWindow
def _fallback_export_excel(self):
    """Export current visible table to XLSX or CSV (fallback to CSV)."""
    try:
        path, chosen = QtWidgets.QFileDialog.getSaveFileName(
            self, "ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„", "guarantees.xlsx", "Excel (*.xlsx);;CSV (*.csv)"
        )
        if not path:
            return

        # Collect visible headers/columns
        headers, vis_cols = [], []
        bank_col_idx = -1
        for i in range(self.table.columnCount()):
            if not self.table.isColumnHidden(i):
                it = self.table.horizontalHeaderItem(i)
                nm = it.text() if it else f"Ø¹Ù…ÙˆØ¯ {i + 1}"
                headers.append(nm)
                if "Ø§Ù„Ø¨Ù†Ùƒ" in nm:
                    bank_col_idx = len(headers) - 1
                vis_cols.append(i)
                if "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" in nm:
                    break

        rows = []
        for r in range(self.table.rowCount()):
            vals = []
            for ci in vis_cols:
                it = self.table.item(r, ci)
                vals.append("" if it is None else it.text())
            rows.append(vals)
            
        # Sort by Bank if present
        if bank_col_idx != -1:
            try:
                rows.sort(key=lambda x: x[bank_col_idx])
            except:
                pass

        # CSV?
        need_csv = (path.lower().endswith(".csv") or (chosen and "CSV" in chosen))
        if need_csv:
            import csv, os
            if not path.lower().endswith(".csv"):
                base, _ = os.path.splitext(path);
                path = base + ".csv"
            with open(path, "w", newline="", encoding="utf-8-sig") as f:
                w = csv.writer(f);
                w.writerow(headers);
                w.writerows(rows)
            try:
                QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±", "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV Ø¨Ù†Ø¬Ø§Ø­.")
            except Exception:
                pass
            return

        # XLSX try
        try:
            from openpyxl import Workbook  # type: ignore
            from openpyxl.utils import get_column_letter  # type: ignore
            wb = Workbook();
            ws = wb.active;
            ws.title = "Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª"
            # ws.print_area = 'A:R'

            ws.append(headers)
            for row in rows:
                ws.append(row)
                # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙÙˆÙ - Ø§Ø³ØªØ®Ø¯Ø§Ù… ws.max_row Ù„Ù„ØªØ²Ø§Ù…Ù†
                _current_row = ws.max_row
            for col in ws.columns:
                max_len = 0
                first = next(iter(col))
                letter = first.column_letter
                is_pct = "Ø§Ù„Ù†Ø³Ø¨Ø©" in str(first.value or "")
                for cell in col:
                    try:
                        max_len = max(max_len, len(str(cell.value or "")))
                    except Exception:
                        pass
                    if is_pct and cell.row > 1:
                        cell.number_format = '0"%"'
            
                ws.column_dimensions[letter].width = min(max(12, max_len + 2), 80)
            
            if ws.max_row > 0:
                last_col_letter = get_column_letter(ws.max_column)
                ws.print_area = f'A1:{last_col_letter}{ws.max_row}'

            wb.save(path)

            try:
                QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±", "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­.")
            except Exception:
                pass
        except Exception:
            # fallback to CSV
            import csv, os
            base, _ = os.path.splitext(path);
            csv_path = base + ".csv"
            with open(csv_path, "w", newline="", encoding="utf-8-sig") as f:
                w = csv.writer(f);
                w.writerow(headers);
                w.writerows(rows)
            try:
                QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±",
                                                  "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ XLSX (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªØ«Ø¨ÙŠØª openpyxl). ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ CSV Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.")
            except Exception:
                pass
    except Exception as e:
        try:
            QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", f"ØªØ¹Ø°Ø± Ø§Ù„ØªØµØ¯ÙŠØ±: {e}")
        except Exception:
            pass
# Ensure export_excel exists on MainWindow; if not, attach fallback
try:
    if not hasattr(MainWindow, "export_excel"):
        MainWindow.export_excel = _fallback_export_excel
except Exception:
    pass

# Export all data (DB + attachments) to a single Zip file
import zipfile as _zipfile
from pathlib import Path as _Path
import datetime as _dt

def _export_all_to_zip(self):
    try:
        base_dir = _Path(db_path()).parent
        db_file = base_dir / "guarantees.db"
        atts_dir = base_dir / "attachments"

        ts = _dt.datetime.now().strftime("%Y%m%d_%H%M")
        default_name = f"GuaranteesBackup_{ts}.zip"
        default_path = str(base_dir / default_name)

        path, _ = QtWidgets.QFileDialog.getSaveFileName(
            self,
            "ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ Zip",
            default_path,
            "Zip Files (*.zip)"
        )
        if not path:
            return

        with _zipfile.ZipFile(path, "w", compression=_zipfile.ZIP_DEFLATED) as zf:
            # Add DB
            if db_file.exists():
                zf.write(str(db_file), arcname="guarantees.db")
            # Add attachments recursively
            if atts_dir.exists():
                for p in atts_dir.rglob('*'):
                    if p.is_file():
                        arc = str(p.relative_to(base_dir))
                        zf.write(str(p), arcname=arc)

        try:
            QtWidgets.QMessageBox.information(self, "ØªØµØ¯ÙŠØ±", f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø²Ù…Ø©: {path}")
        except Exception:
            pass
        # Optionally open the containing folder
        try:
            folder = str(_Path(path).parent)
            QtGui.QDesktopServices.openUrl(QtCore.QUrl.fromLocalFile(folder))
        except Exception:
            pass
    except Exception as e:
        try:
            QtWidgets.QMessageBox.critical(self, "ØªØµØ¯ÙŠØ±", f"ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Zip: {e}")
        except Exception:
            pass

# Attach as method if missing
try:
    if not hasattr(MainWindow, "export_all_to_zip"):
        MainWindow.export_all_to_zip = _export_all_to_zip
except Exception:
    pass

# Monkey-patch MainWindow.__init__ to ensure toolbar export action
try:
    _MW_init_orig = MainWindow.__init__

    def _MW_init_patched(self, *a, **kw):
        _MW_init_orig(self, *a, **kw)
        try:
            # Find or create a top toolbar
            toolbar = None
            try:
                tbs = self.findChildren(QtWidgets.QToolBar)
                if tbs:
                    toolbar = tbs[0]
            except Exception:
                toolbar = None
            if toolbar is None:
                toolbar = QtWidgets.QToolBar("Ø§Ù„Ø£ÙˆØ§Ù…Ø±", self)
                self.addToolBar(QtCore.Qt.TopToolBarArea, toolbar)

            # Apply saved toolbar visibility
            try:
                apply_toolbar_visibility(self)
            except Exception:
                pass

            # Export action removed as per user request
            # if not hasattr(self, "act_export") or self.act_export is None:
            #     self.act_export = QtWidgets.QAction("ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„", self)
            #     try:
            #         self.act_export.setShortcut(QtGui.QKeySequence("Ctrl+E"))
            #     except Exception:
            #         pass
            #     self.act_export.setToolTip("ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¸Ø§Ù‡Ø± Ø¥Ù„Ù‰ Ù…Ù„Ù Excel")
            #     self.act_export.triggered.connect(lambda: export_table_to_excel(self))
            #     try:
            #         toolbar.addAction(self.act_export)
            #     except Exception:
            #         pass

            # Ensure an import action exists and is connected (Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ)
            if not hasattr(self, "act_import") or self.act_import is None:
                try:
                    self.act_import = QtWidgets.QAction("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„â€¦", self)
                    self.act_import.setToolTip("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Excel")
                    try:
                        self.act_import.setShortcut(QtGui.QKeySequence("Ctrl+I"))
                    except Exception:
                        pass
                    self.act_import.triggered.connect(self.do_import)
                    try:
                        self.addAction(self.act_import)
                    except Exception:
                        pass
                except Exception:
                    pass

            # Ensure a unified print/preview action exists (Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ)
            if not hasattr(self, "act_print") or self.act_print is None:
                self.act_print = QtWidgets.QAction("Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©â€¦", self)
                try:
                    self.act_print.setShortcut(QtGui.QKeySequence("Ctrl+P"))
                except Exception:
                    pass
                self.act_print.setToolTip("ÙØªØ­ Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©")
                try:
                    self.act_print.triggered.connect(self.preview)
                except Exception:
                    pass
                try:
                    self.addAction(self.act_print)
                except Exception:
                    pass

            # Add Export-All-to-Zip action
            if not hasattr(self, "act_export_zip") or self.act_export_zip is None:
                try:
                    self.act_export_zip = QtWidgets.QAction("ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ Zip", self)
                    try:
                        self.act_export_zip.setShortcut(QtGui.QKeySequence("Ctrl+Shift+E"))
                    except Exception:
                        pass
                    self.act_export_zip.setToolTip("Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Zip ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª")
                    try:
                        self.act_export_zip.triggered.connect(self.export_all_to_zip)
                    except Exception:
                        pass
                    try:
                        toolbar.addAction(self.act_export_zip)
                    except Exception:
                        pass
                except Exception:
                    pass

            # Reconnect to method if present
            try:
                self.act_export.triggered.disconnect()
            except Exception:
                pass
            try:
                self.act_export.triggered.connect(self.export_excel)
            except Exception:
                # fallback to direct function
                try:
                    self.act_export.triggered.connect(lambda: export_table_to_excel(self))
                except Exception:
                    pass

            try:
                self.act_export.setEnabled(True)
            except Exception:
                pass

            # Ensure daily export is scheduled and run if needed
            try:
                self._ensure_daily_active_excel_export()
            except Exception:
                pass

        except Exception:
            pass

    MainWindow.__init__ = _MW_init_patched
except Exception:
    pass

# --- Bind toolbar helpers to MainWindow for compatibility ---
# try:
#     MainWindow.show_toolbar_buttons_settings = show_toolbar_buttons_settings
#     MainWindow.apply_toolbar_visibility = apply_toolbar_visibility
# except Exception:
#     pass

# ===================== AUTO-SAVE PATCH (added) =====================
# This patch makes the app persist *every* UI step automatically:
# - Column widths/order, row heights (existing) + auto-saved on resize/move
# - Filters (department/bank/type/cash/status/search text)
# - Active tab index, window geometry/state, and common splitters
# - Saved on every change (debounced) and at closeEvent
#
# Safe to import; it only augments MainWindow methods.

try:
    from PyQt5 import QtCore, QtWidgets  # type: ignore
except Exception:
    pass

def _qsettings():
    try:
        return QtCore.QSettings("GuaranteesApp", "Main")
    except Exception:
        class _Dummy:
            def setValue(self, *a, **k): pass
            def value(self, *a, **k): return None
            def sync(self): pass
        return _Dummy()

def _set_if_has(obj, name, val):
    try:
        if obj and hasattr(obj, name):
            setattr(obj, name, val)
    except Exception:
        pass

def _get_text_safe(w):
    try:
        if hasattr(w, "currentText"):
            return str(w.currentText() or "")
        if hasattr(w, "text"):
            return str(w.text() or "")
    except Exception:
        pass
    return ""

def _set_combo_by_text(cmb, text):
    try:
        if not cmb: return
        i = cmb.findText(text)
        if i >= 0:
            cmb.setCurrentIndex(i)
    except Exception:
        pass

def _save_ui_state(self):
    try:
        s = _qsettings()
        # ---- filters
        filters = {}
        for key, wname in [
            ("dept", "cmb_dept"),
            ("bank", "cmb_bank"),
            ("gtype", "cmb_gtype"),
            ("cash", "cmb_cash"),
            ("status", "cmb_status"),
        ]:
            try:
                w = getattr(self, wname, None)
                filters[key] = _get_text_safe(w)
            except Exception:
                filters[key] = ""
        try:
            ed = getattr(self, "ed_search", None)
            filters["search"] = _get_text_safe(ed)
        except Exception:
            filters["search"] = ""
        s.setValue("filters/state", filters)

        # ---- active tab
        try:
            tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
            if tabs:
                s.setValue("ui/active_tab", int(tabs.currentIndex()))
        except Exception:
            pass

        # ---- window geometry/state
        try:
            s.setValue("ui/main_geometry", self.saveGeometry())
            s.setValue("ui/main_state", self.saveState())
        except Exception:
            pass

        # ---- splitters common names
        try:
            for sp_name in ("splitter", "splitter_main", "splitterLeft", "splitterRight"):
                sp = getattr(self, sp_name, None)
                if sp and hasattr(sp, "saveState"):
                    s.setValue(f"ui/{sp_name}_state", sp.saveState())
        except Exception:
            pass

        # ---- table geometry (reuse existing helper if present)
        try:
            if hasattr(self, "save_table_geometry"):
                self.save_table_geometry()
        except Exception:
            pass

        try:
            s.sync()
        except Exception:
            pass
    except Exception:
        pass

def _load_ui_state(self):
    try:
        s = _qsettings()

        # ---- filters
        try:
            filters = s.value("filters/state")
            if isinstance(filters, dict):
                _set_combo_by_text(getattr(self, "cmb_dept", None), filters.get("dept", ""))
                _set_combo_by_text(getattr(self, "cmb_bank", None), filters.get("bank", ""))
                _set_combo_by_text(getattr(self, "cmb_gtype", None), filters.get("gtype", ""))
                _set_combo_by_text(getattr(self, "cmb_cash", None), filters.get("cash", ""))
                _set_combo_by_text(getattr(self, "cmb_status", None), filters.get("status", ""))
                try:
                    ed = getattr(self, "ed_search", None)
                    if ed and hasattr(ed, "setText"):
                        ed.setText(filters.get("search", ""))
                except Exception:
                    pass
        except Exception:
            pass

        # ---- active tab
        try:
            tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
            idx = s.value("ui/active_tab", type=int)
            if tabs is not None and isinstance(idx, int) and idx >= 0 and idx < tabs.count():
                tabs.setCurrentIndex(idx)
        except Exception:
            pass

        # ---- window geometry/state
        try:
            geo = s.value("ui/main_geometry", type=QtCore.QByteArray)
            if geo:
                self.restoreGeometry(geo)
            st = s.value("ui/main_state", type=QtCore.QByteArray)
            if st:
                self.restoreState(st)
        except Exception:
            pass

        # ---- splitters
        try:
            for sp_name in ("splitter", "splitter_main", "splitterLeft", "splitterRight"):
                sp = getattr(self, sp_name, None)
                if sp and hasattr(sp, "restoreState"):
                    data = s.value(f"ui/{sp_name}_state", type=QtCore.QByteArray)
                    if data:
                        sp.restoreState(data)
        except Exception:
            pass

        # ---- table geometry
        try:
            if hasattr(self, "load_table_geometry") and hasattr(self, "apply_table_geometry"):
                by_name, by_index, heights = self.load_table_geometry()
                self.apply_table_geometry(by_name, by_index, heights)
        except Exception:
            pass

    except Exception:
        pass

def _schedule_auto_save(self, delay_ms=800):
    try:
        # Debounced autosave timer
        t = getattr(self, "_autosave_timer", None)
        if not t:
            t = QtCore.QTimer(self); t.setSingleShot(True)
            _set_if_has(self, "_autosave_timer", t)
            t.timeout.connect(lambda: _save_ui_state(self))
        t.stop()
        t.start(int(delay_ms))
    except Exception:
        # fallback: save immediately
        try: _save_ui_state(self)
        except Exception: pass

def _connect_filter_autosave(self):
    try:
        for wname, sig in [
            ("cmb_dept", "currentIndexChanged"),
            ("cmb_bank", "currentIndexChanged"),
            ("cmb_gtype", "currentIndexChanged"),
            ("cmb_cash", "currentIndexChanged"),
            ("cmb_status", "currentIndexChanged"),
        ]:
            w = getattr(self, wname, None)
            if w and hasattr(w, sig):
                getattr(w, sig).connect(lambda *_: _schedule_auto_save(self))
        ed = getattr(self, "ed_search", None)
        if ed and hasattr(ed, "textChanged"):
            ed.textChanged.connect(lambda *_: _schedule_auto_save(self))
    except Exception:
        pass

def _connect_table_autosave(self):
    try:
        if not hasattr(self, "table"):
            return
        hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
        vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
        if hh:
            try:
                hh.sectionResized.connect(lambda *a: _schedule_geom_save(self))
            except Exception:
                pass
            try:
                hh.sectionMoved.connect(lambda *a: _schedule_geom_save(self))
            except Exception:
                pass
        if vh:
            try:
                vh.sectionResized.connect(lambda *a: _schedule_geom_save(self))
            except Exception:
                pass
    except Exception:
        pass

def enable_autosave(self):
    """Call once after UI is built."""
    try:
        if getattr(self, "_autosave_inited", False):
            return
        _set_if_has(self, "_autosave_inited", True)
        _connect_filter_autosave(self)
        _connect_table_autosave(self)
        # initial load once
        _load_ui_state(self)
        # queue a second load after widgets finish populating
        try:
            QtCore.QTimer.singleShot(0, lambda: _load_ui_state(self))
        except Exception:
            pass
        # save immediately so state is consistent
        _schedule_auto_save(self, delay_ms=50)
    except Exception:
        pass

def closeEvent(self, event):
    # Save EVERYTHING on close
    try:
        _save_ui_state(self)
    except Exception:
        pass
    try:
        # If original closeEvent existed, call it safely (it might be rebound elsewhere)
        super_closer = getattr(QtWidgets.QMainWindow, "closeEvent", None)
        if callable(super_closer):
            super_closer(self, event)
        else:
            event.accept()
    except Exception:
        try:
            event.accept()
        except Exception:
            pass

def showEvent(self, event):
    # One-time hook to initialize autosave right after the window becomes visible
    try:
        super_shower = getattr(QtWidgets.QMainWindow, "showEvent", None)
        if callable(super_shower):
            super_shower(self, event)
    except Exception:
        pass
    try:
        enable_autosave(self)
    except Exception:
        pass

# Bind into MainWindow if present (safe try/except for import-time)

#     MainWindow.enable_autosave = enable_autosave
#     MainWindow._save_ui_state = _save_ui_state
#     MainWindow._load_ui_state = _load_ui_state
#     MainWindow._schedule_auto_save = _schedule_auto_save
#     MainWindow.showEvent = showEvent
#     MainWindow.closeEvent = closeEvent
# =================== END AUTO-SAVE PATCH (added) ===================



# ===================== JSON STATE PERSISTENCE (ADDED) =====================
# Portable autosave to a JSON file next to the app, so settings survive even Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù€Registry.
import json, os
from pathlib import Path

def _state_file_path():
    try:
        # Put next to the executable/py file
        base = Path(getattr(sys, "_MEIPASS", Path(__file__).resolve().parent))
    except Exception:
        base = Path(".")
    return base / "guarantees_state.json"

def _json_read():
    try:
        p = _state_file_path()
        if p.exists():
            with open(p, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception:
        pass
    return {}

def _json_write(data: dict):
    try:
        p = _state_file_path()
        with open(p, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception:
        pass

def json_save_ui_state(self):
    try:
        data = _json_read()

        # ---- filters
        filters = {}
        for key, wname in [
            ("dept", "cmb_dept"),
            ("bank", "cmb_bank"),
            ("gtype", "cmb_gtype"),
            ("cash", "cmb_cash"),
            ("status", "cmb_status"),
        ]:
            try:
                w = getattr(self, wname, None)
                if w and hasattr(w, "currentText"):
                    filters[key] = str(w.currentText() or "")
                else:
                    filters[key] = ""
            except Exception:
                filters[key] = ""
        try:
            ed = getattr(self, "ed_search", None)
            if ed and hasattr(ed, "text"):
                filters["search"] = str(ed.text() or "")
        except Exception:
            filters["search"] = ""

        data["filters"] = filters

        # ---- active tab
        try:
            tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
            if tabs and hasattr(tabs, "currentIndex"):
                data["active_tab"] = int(tabs.currentIndex())
        except Exception:
            pass

        # ---- geometry
        try:
            data["main_geometry"] = bytes(self.saveGeometry().data()).hex()
            data["main_state"] = bytes(self.saveState().data()).hex()
        except Exception:
            pass

        # ---- splitters
        try:
            data["splitters"] = {}
            for sp_name in ("splitter", "splitter_main", "splitterLeft", "splitterRight"):
                sp = getattr(self, sp_name, None)
                if sp and hasattr(sp, "saveState"):
                    data["splitters"][sp_name] = bytes(sp.saveState().data()).hex()
        except Exception:
            pass

        # ---- table header geometry
        try:
            if hasattr(self, "table"):
                hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
                vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
                if hh:
                    data["table_hh"] = {
                        "count": hh.count(),
                        "visual_indices": [hh.visualIndex(i) for i in range(hh.count())],
                        "sizes": [hh.sectionSize(i) for i in range(hh.count())],
                    }
                if vh:
                    # store first N visible row heights (limited to 200 rows to cap file size)
                    rows = min(getattr(self.table, "rowCount", lambda:0)(), 200)
                    data["table_vh"] = {
                        "rows": rows,
                        "sizes": [vh.sectionSize(i) for i in range(rows)],
                    }
        except Exception:
            pass

        _json_write(data)
    except Exception:
        pass

def json_load_ui_state(self):
    try:
        data = _json_read()

        # ---- filters
        try:
            filters = data.get("filters", {})
            def _set_combo_by_text(c, text):
                try:
                    if c is None: return
                    i = c.findText(text)
                    if i >= 0:
                        c.setCurrentIndex(i)
                except Exception:
                    pass
            _set_combo_by_text(getattr(self, "cmb_dept", None), filters.get("dept", ""))
            _set_combo_by_text(getattr(self, "cmb_bank", None), filters.get("bank", ""))
            _set_combo_by_text(getattr(self, "cmb_gtype", None), filters.get("gtype", ""))
            _set_combo_by_text(getattr(self, "cmb_cash", None), filters.get("cash", ""))
            _set_combo_by_text(getattr(self, "cmb_status", None), filters.get("status", ""))
            try:
                ed = getattr(self, "ed_search", None)
                if ed and hasattr(ed, "setText"):
                    ed.setText(filters.get("search", ""))
            except Exception:
                pass
        except Exception:
            pass

        # ---- active tab
        try:
            tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
            idx = int(data.get("active_tab", -1))
            if tabs and 0 <= idx < tabs.count():
                tabs.setCurrentIndex(idx)
        except Exception:
            pass

        # ---- geometry
        try:
            g = data.get("main_geometry")
            st = data.get("main_state")
            if g:
                ba = QtCore.QByteArray.fromHex(g.encode())
                self.restoreGeometry(ba)
            if st:
                ba = QtCore.QByteArray.fromHex(st.encode())
                self.restoreState(ba)
        except Exception:
            pass

        # ---- splitters
        try:
            spd = data.get("splitters", {})
            for sp_name, hx in spd.items():
                sp = getattr(self, sp_name, None)
                if sp and hx:
                    ba = QtCore.QByteArray.fromHex(hx.encode())
                    sp.restoreState(ba)
        except Exception:
            pass

        # ---- table header geometry
        try:
            if hasattr(self, "table"):
                hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
                vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
                info = data.get("table_hh", {})
                if hh and info:
                    vis = info.get("visual_indices", [])
                    sizes = info.get("sizes", [])
                    for i, v in enumerate(vis):
                        try:
                            hh.moveSection(hh.visualIndex(i), v)
                        except Exception:
                            pass
                    for i, w in enumerate(sizes):
                        try:
                            hh.resizeSection(i, int(w))
                        except Exception:
                            pass
                info_v = data.get("table_vh", {})
                if vh and info_v:
                    sizes = info_v.get("sizes", [])
                    for i, h in enumerate(sizes):
                        try:
                            vh.resizeSection(i, int(h))
                        except Exception:
                            pass
        except Exception:
            pass
    except Exception:
        pass

# Hook JSON save/load into existing flow:
_old_enable_autosave = globals().get("enable_autosave")
def enable_autosave(self):
    # Call original enable_autosave if it exists
    try:
        if callable(_old_enable_autosave):
            _old_enable_autosave(self)
    except Exception:
        pass
    # Then also load JSON state (twice: now and after event loop turns)
    try:
        json_load_ui_state(self)
    except Exception:
        pass
    try:
        QtCore.QTimer.singleShot(0, lambda: json_load_ui_state(self))
    except Exception:
        pass
    # Ensure frequent saving to JSON alongside QSettings
    try:
        if hasattr(self, "_autosave_timer"):
            self._autosave_timer.timeout.connect(lambda: json_save_ui_state(self))
        else:
            # fallback: periodic timer
            t = QtCore.QTimer(self); t.setInterval(1500); t.timeout.connect(lambda: json_save_ui_state(self)); t.start()
            setattr(self, "_json_autosave_fallback", t)
    except Exception:
        pass

# Also ensure closeEvent persists JSON
_old_closeEvent = globals().get("closeEvent")
def closeEvent(self, event):
    try:
        json_save_ui_state(self)
    except Exception:
        pass
    try:
        if callable(_old_closeEvent):
            _old_closeEvent(self, event); return
    except Exception:
        pass
    try:
        super(QtWidgets.QMainWindow, self).closeEvent(event)
    except Exception:
        try:
            event.accept()
        except Exception:
            pass
# Rebind
# try:
#     MainWindow.enable_autosave = enable_autosave
#     MainWindow.closeEvent = closeEvent
# except Exception:
#     pass
# =================== END JSON STATE PERSISTENCE ===================



# ===================== EASY TRIPLE PERSISTENCE (INI + JSON + SHORTCUTS) =====================
# This section adds:
#   (1) INI (QSettings in INIFormat) session save/load to app.ini next to the script
#   (2) JSON session save/load to session.json next to the script
#   (3) Simple shortcuts: Ctrl+S (save), Ctrl+L (load)
from PyQt5 import QtCore, QtWidgets  # type: ignore
import os, json

# ---------------- INI helpers ----------------
def _ini_path():
    try:
        base = os.path.dirname(__file__)
    except Exception:
        base = "."
    return os.path.join(base, "app.ini")

def _ini_settings():
    return QtCore.QSettings(_ini_path(), QtCore.QSettings.IniFormat)

def save_session_ini(self):
    s = _ini_settings()
    # Filters
    def get_combo(name):
        w = getattr(self, name, None)
        return w.currentText() if (w and hasattr(w, "currentText")) else ""
    s.setValue("filters/dept",   get_combo("cmb_dept"))
    s.setValue("filters/bank",   get_combo("cmb_bank"))
    s.setValue("filters/gtype",  get_combo("cmb_gtype"))
    s.setValue("filters/cash",   get_combo("cmb_cash"))
    s.setValue("filters/status", get_combo("cmb_status"))
    ed = getattr(self, "ed_search", None)
    s.setValue("filters/search", ed.text() if (ed and hasattr(ed, "text")) else "")

    # Tab
    tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
    if tabs:
        s.setValue("ui/active_tab", int(tabs.currentIndex()))

    # Window geometry/state
    s.setValue("ui/geometry", self.saveGeometry())
    s.setValue("ui/state",    self.saveState())
    s.sync()

    # Table geometry
    try:
        if hasattr(self, "table"):
            hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
            vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
            if hh:
                visual = [hh.visualIndex(i) for i in range(hh.count())]
                sizes  = [hh.sectionSize(i) for i in range(hh.count())]
                s.setValue("table/hh_visual", visual)
                s.setValue("table/hh_sizes", sizes)
            if vh:
                rows = min(getattr(self.table, "rowCount", lambda:0)(), 200)
                sizes = [vh.sectionSize(i) for i in range(rows)]
                s.setValue("table/vh_rows", rows)
                s.setValue("table/vh_sizes", sizes)
    except Exception:
        pass

def load_session_ini(self):
    s = _ini_settings()
    # Filters
    def set_combo(name, key):
        try:
            w = getattr(self, name, None)
            if w and hasattr(w, "findText"):
                txt = s.value(f"filters/{key}", "", type=str)
                i = w.findText(txt)
                if i >= 0:
                    w.setCurrentIndex(i)
        except Exception:
            pass
    set_combo("cmb_dept",   "dept")
    set_combo("cmb_bank",   "bank")
    set_combo("cmb_gtype",  "gtype")
    set_combo("cmb_cash",   "cash")
    set_combo("cmb_status", "status")
    try:
        ed = getattr(self, "ed_search", None)
        if ed and hasattr(ed, "setText"):
            ed.setText(s.value("filters/search", "", type=str))
    except Exception:
        pass

    # Tab
    try:
        tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
        if tabs:
            idx = s.value("ui/active_tab", -1, type=int)
            if isinstance(idx, int) and 0 <= idx < tabs.count():
                tabs.setCurrentIndex(idx)
    except Exception:
        pass

    # Window geometry/state
    try:
        geo = s.value("ui/geometry", None)
        if geo:
            self.restoreGeometry(geo)
        st = s.value("ui/state", None)
        if st:
            self.restoreState(st)
    except Exception:
        pass

    # Table geometry
    try:
        if hasattr(self, "table"):
            hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
            vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
            if hh:
                visual = s.value("table/hh_visual", [], type=list)
                sizes  = s.value("table/hh_sizes",  [], type=list)
                # move sections
                for i, v in enumerate(visual):
                    try:
                        hh.moveSection(hh.visualIndex(i), int(v))
                    except Exception:
                        pass
                for i, w in enumerate(sizes):
                    try:
                        hh.resizeSection(i, int(w))
                    except Exception:
                        pass
            if vh:
                rows  = s.value("table/vh_rows", 0, type=int)
                sizes = s.value("table/vh_sizes", [], type=list)
                for i, h in enumerate(sizes[:rows] if rows else sizes):
                    try:
                        vh.resizeSection(i, int(h))
                    except Exception:
                        pass
    except Exception:
        pass

# ---------------- JSON helpers ----------------
def save_session_json(self):
    data = {"filters": {}}
    def get_combo(name):
        w = getattr(self, name, None)
        return w.currentText() if (w and hasattr(w, "currentText")) else ""
    for k in ["dept","bank","gtype","cash","status"]:
        data["filters"][k] = get_combo(f"cmb_{k}")
    ed = getattr(self, "ed_search", None)
    data["filters"]["search"] = ed.text() if (ed and hasattr(ed, "text")) else ""
    tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
    if tabs:
        data["active_tab"] = int(tabs.currentIndex())
    try:
        data["geo"]   = bytes(self.saveGeometry().data()).hex()
        data["state"] = bytes(self.saveState().data()).hex()
    except Exception:
        pass
    # Table geometry
    try:
        if hasattr(self, "table"):
            hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
            vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
            if hh:
                data["table_hh"] = {
                    "visual": [hh.visualIndex(i) for i in range(hh.count())],
                    "sizes":  [hh.sectionSize(i) for i in range(hh.count())],
                }
            if vh:
                rows = min(getattr(self.table, "rowCount", lambda:0)(), 200)
                data["table_vh"] = {
                    "rows": rows,
                    "sizes": [vh.sectionSize(i) for i in range(rows)],
                }
    except Exception:
        pass
    try:
        with open(_session_json_path(), "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception:
        pass

def load_session_json(self):
    try:
        with open(_session_json_path(), "r", encoding="utf-8") as f:
            d = json.load(f)
    except Exception:
        d = {}
    # Filters
    def set_combo(name, key):
        try:
            w = getattr(self, name, None)
            if w and hasattr(w, "findText"):
                txt = d.get("filters", {}).get(key, "")
                i = w.findText(txt)
                if i >= 0:
                    w.setCurrentIndex(i)
        except Exception:
            pass
    for k in ["dept","bank","gtype","cash","status"]:
        set_combo(f"cmb_{k}", k)
    try:
        ed = getattr(self, "ed_search", None)
        if ed and hasattr(ed, "setText"):
            ed.setText(d.get("filters", {}).get("search",""))
    except Exception:
        pass

    # Tab
    try:
        tabs = getattr(self, "tabs", None) or getattr(self, "tabWidget", None)
        idx = int(d.get("active_tab", -1)) if "active_tab" in d else -1
        if tabs and 0 <= idx < tabs.count():
            tabs.setCurrentIndex(idx)
    except Exception:
        pass

    # Window geometry/state
    try:
        if "geo" in d:
            self.restoreGeometry(QtCore.QByteArray.fromHex(d["geo"].encode()))
        if "state" in d:
            self.restoreState(QtCore.QByteArray.fromHex(d["state"].encode()))
    except Exception:
        pass

    # Table geometry
    try:
        if hasattr(self, "table"):
            hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
            vh = self.table.verticalHeader() if hasattr(self, "verticalHeader") else None
            info = d.get("table_hh", {})
            if hh and info:
                vis = info.get("visual", [])
                sizes = info.get("sizes",  [])
                for i, v in enumerate(vis):
                    try:
                        hh.moveSection(hh.visualIndex(i), int(v))
                    except Exception:
                        pass
                for i, w in enumerate(sizes):
                    try:
                        hh.resizeSection(i, int(w))
                    except Exception:
                        pass
            info_v = d.get("table_vh", {})
            if vh and info_v:
                rows  = int(info_v.get("rows", 0) or 0)
                sizes = info_v.get("sizes", [])
                for i, h in enumerate(sizes[:rows] if rows else sizes):
                    try:
                        vh.resizeSection(i, int(h))
                    except Exception:
                        pass
    except Exception:
        pass

# ---------------- Unified wrappers + shortcuts ----------------
def save_session(self):
    # Save to both INI and JSON for robustness
    try: save_session_ini(self)
    except Exception: pass
    try: save_session_json(self)
    except Exception: pass

def load_session(self):
    # Prefer INI if exists; otherwise JSON; then fallback to existing loaders, if any
    used = False
    try:
        if os.path.exists(_ini_path()):
            load_session_ini(self); used = True
    except Exception:
        pass
    if not used:
        try:
            if os.path.exists(_session_json_path()):
                load_session_json(self); used = True
        except Exception:
            pass
    # Also call the existing loaders (from JSON/QSettings patches) for completeness
    try: _load_ui_state(self)  # from earlier patch
    except Exception: pass
    try: json_load_ui_state(self)  # from earlier JSON patch
    except Exception: pass

def _attach_simple_shortcuts(self):
    try:
        sc_save = QtWidgets.QShortcut(QtCore.QKeySequence("Ctrl+S"), self)
        sc_save.activated.connect(lambda: save_session(self))
        sc_load = QtWidgets.QShortcut(QtCore.QKeySequence("Ctrl+L"), self)
        sc_load.activated.connect(lambda: load_session(self))
        self._simple_shortcuts = (sc_save, sc_load)
    except Exception:
        pass

# Hook: enable both at startup and ensure save on close
_old_enable_autosave_triple = globals().get("enable_autosave")
def enable_autosave(self):
    try:
        if callable(_old_enable_autosave_triple):
            _old_enable_autosave_triple(self)
    except Exception:
        pass
    try:
        load_session(self)
        QtCore.QTimer.singleShot(0, lambda: load_session(self))
    except Exception:
        pass
    try:
        _attach_simple_shortcuts(self)
    except Exception:
        pass

_old_closeEvent_triple = globals().get("closeEvent")
def closeEvent(self, event):
    try:
        save_session(self)
    except Exception:
        pass
    try:
        if callable(_old_closeEvent_triple):
            _old_closeEvent_triple(self, event); return
    except Exception:
        pass
    try:
        super(QtWidgets.QMainWindow, self).closeEvent(event)
    except Exception:
        try: event.accept()
        except Exception: pass

# MainWindow.enable_autosave = enable_autosave
# MainWindow.closeEvent = closeEvent
# =================== END EASY TRIPLE PERSISTENCE ===================



# ===================== PERSISTENCE HARDENING & DEBUG =====================
import os, time

def _data_dir():
    # Use %APPDATA%\GuaranteesApp on Windows; else alongside the script
    try:
        if os.name == "nt":
            base = os.environ.get("APPDATA") or os.path.expanduser("~")
            d = os.path.join(base, "GuaranteesApp")
        else:
            d = os.path.join(os.path.dirname(__file__), "GuaranteesApp")
        os.makedirs(d, exist_ok=True)
        return d
    except Exception:
        return os.path.dirname(__file__)

def _debug_log_path():
    return os.path.join(_data_dir(), "persist_debug.log")

def _log(msg):
    try:
        with open(_debug_log_path(), "a", encoding="utf-8") as f:
            f.write(time.strftime("[%Y-%m-%d %H:%M:%S] ") + str(msg) + "\n")
    except Exception:
        pass

# Override INI/JSON paths to live under data dir
def _ini_path():
    return os.path.join(_data_dir(), "app.ini")

def _session_json_path():
    return os.path.join(_data_dir(), "session.json")

# Tie saves to changes with a small debounce timer
def _ensure_autosave_timer(self):
    try:
        if getattr(self, "_persist_timer", None) is None:
            t = QtCore.QTimer(self); t.setSingleShot(True); t.setInterval(600)
            t.timeout.connect(lambda: (save_session(self), _log("autosave: timer fired")))
            self._persist_timer = t
        return self._persist_timer
    except Exception:
        return None

def _schedule_save(self):
    t = _ensure_autosave_timer(self)
    try:
        if t: t.start()
    except Exception:
        pass

def _connect_autosave_signals(self):
    # Combos
    for name in ("cmb_dept","cmb_bank","cmb_gtype","cmb_cash","cmb_status"):
        try:
            w = getattr(self, name, None)
            if w and hasattr(w, "currentIndexChanged"):
                w.currentIndexChanged.connect(lambda *_: _schedule_save(self))
        except Exception:
            pass
    # Search text
    try:
        ed = getattr(self, "ed_search", None)
        if ed and hasattr(ed, "textChanged"):
            ed.textChanged.connect(lambda *_: _schedule_save(self))
    except Exception:
        pass
    # Table headers - DISABLED to avoid redundancy with _connect_table_autosave and heavy JSON dumps on resize
    # try:
    #     if hasattr(self, "table"):
    #         hh = self.table.horizontalHeader() if hasattr(self.table, "horizontalHeader") else None
    #         vh = self.table.verticalHeader() if hasattr(self.table, "verticalHeader") else None
    #         if hh:
    #             try: hh.sectionResized.connect(lambda *a: _schedule_save(self))
    #             except Exception: pass
    #             try: hh.sectionMoved.connect(lambda *a: _schedule_save(self))
    #             except Exception: pass
    #         if vh:
    #             try: vh.sectionResized.connect(lambda *a: _schedule_save(self))
    #             except Exception: pass
    # except Exception:
    #     pass

# Periodic autosave safety net (every 2s)
def _start_periodic_autosave(self):
    try:
        if getattr(self, "_persist_periodic", None) is None:
            t = QtCore.QTimer(self); t.setInterval(2000)
            t.timeout.connect(lambda: (save_session(self), _log("autosave: periodic")))
            t.start()
            self._persist_periodic = t
    except Exception:
        pass

# Wrap existing enable_autosave to attach signals and start periodic timer
_old_enable_autosave_dbg = globals().get("enable_autosave")
def enable_autosave(self):
    try:
        if callable(_old_enable_autosave_dbg):
            _old_enable_autosave_dbg(self)
    except Exception:
        pass
    try:
        _connect_autosave_signals(self)
        _start_periodic_autosave(self)
        _log("enable_autosave: connected signals + periodic timer")
    except Exception:
        pass

# MainWindow.enable_autosave = enable_autosave

# Log on load/save for visibility
_old_load_session = globals().get("load_session")
def load_session(self):
    _log("load_session: begin")
    try:
        if callable(_old_load_session):
            _old_load_session(self)
    except Exception as e:
        _log(f"load_session: underlying loader error: {e}")
    _log("load_session: end")

_old_save_session = globals().get("save_session")
def save_session(self):
    _log("save_session: begin")
    try:
        if callable(_old_save_session):
            _old_save_session(self)
    except Exception as e:
        _log(f"save_session: underlying saver error: {e}")
    _log("save_session: end")

# MainWindow.load_session = load_session
# MainWindow.save_session = save_session
# =================== END HARDENING & DEBUG ===================



# ===================== UNIVERSAL PERSISTENCE LAYER =====================
# fallback import for PyQt5
try:
    from PyQt5 import QtCore, QtGui, QtWidgets  # type: ignore
except ImportError:
    # if PyQt5 is not available, try PyQt6 as a fallback
    try:
        from PyQt6 import QtCore, QtGui, QtWidgets  # type: ignore
    except ImportError:
        # if neither PyQt5 nor PyQt6 is available, raise an informative error
        raise ImportError(
            "PyQt5 (or PyQt6) is required but not installed. "
            "Please install it with: pip install PyQt5"
        )
import os, json, time

# ---------- Storage paths (APPDATA on Windows) ----------
def _data_dir():
    try:
        if os.name == "nt":
            base = os.environ.get("APPDATA") or os.path.expanduser("~")
            d = os.path.join(base, "GuaranteesApp")
        else:
            d = os.path.join(os.path.dirname(__file__), "GuaranteesApp")
        os.makedirs(d, exist_ok=True)
        return d
    except Exception:
        return os.path.dirname(__file__)

def _store_path():
    return os.path.join(_data_dir(), "universal_state.json")

def _log_path():
    return os.path.join(_data_dir(), "universal_persist.log")

def ulog(msg):
    try:
        with open(_log_path(), "a", encoding="utf-8") as f:
            f.write(time.strftime("[%Y-%m-%d %H:%M:%S] ") + str(msg) + "\n")
    except Exception:
        pass

# ---------- Helpers to ensure stable object names ----------
def _ensure_name(w, prefix):
    try:
        name = w.objectName() or ""
        if not name or name.startswith("qt_"):
            name = f"{prefix}_{id(w)}"
            w.setObjectName(name)
        return name
    except Exception:
        return f"{prefix}_anon"

# ---------- Take a full snapshot ----------
def snapshot_ui(self):
    data = {"combos": {}, "edits": {}, "tabs": {}, "geometry": {}, "splitters": {}, "tables": {}}
    try:
        # combos
        for cmb in self.findChildren(QtWidgets.QComboBox):
            name = _ensure_name(cmb, "combo")
            try:
                data["combos"][name] = cmb.currentText() or ""
            except Exception:
                pass
        # line edits
        for ed in self.findChildren(QtWidgets.QLineEdit):
            name = _ensure_name(ed, "edit")
            try:
                data["edits"][name] = ed.text() or ""
            except Exception:
                pass
        # tabs
        for tb in self.findChildren(QtWidgets.QTabWidget):
            name = _ensure_name(tb, "tabs")
            try:
                data["tabs"][name] = int(tb.currentIndex())
            except Exception:
                pass
        # window
        try:
            data["geometry"]["geo"]   = bytes(self.saveGeometry().data()).hex()
            data["geometry"]["state"] = bytes(self.saveState().data()).hex()
        except Exception:
            pass
        # splitters
        for sp in self.findChildren(QtWidgets.QSplitter):
            name = _ensure_name(sp, "splitter")
            try:
                data["splitters"][name] = bytes(sp.saveState().data()).hex()
            except Exception:
                pass
        # tables / headers
        for tbl in self.findChildren((QtWidgets.QTableWidget, QtWidgets.QTableView)):
            try:
                name = _ensure_name(tbl, "table")
                hh = tbl.horizontalHeader() if hasattr(tbl, "horizontalHeader") else None
                vh = tbl.verticalHeader() if hasattr(tbl, "verticalHeader") else None
                tinfo = {}
                if hh:
                    try:
                        count = hh.count()
                        tinfo["hh_visual"] = [hh.visualIndex(i) for i in range(count)]
                        tinfo["hh_sizes"]  = [hh.sectionSize(i) for i in range(count)]
                    except Exception: pass
                if vh:
                    try:
                        rows = getattr(tbl, "rowCount", lambda:0)()
                        rows = rows if isinstance(rows, int) else 0
                        rows = min(rows, 200)
                        tinfo["vh_rows"]  = rows
                        tinfo["vh_sizes"] = [vh.sectionSize(i) for i in range(rows)]
                    except Exception: pass
                if tinfo:
                    data["tables"][name] = tinfo
            except Exception:
                pass
    except Exception as e:
        ulog(f"snapshot error: {e}")
    return data

def save_universal_state(self):
    try:
        data = snapshot_ui(self)
        with open(_store_path(), "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        ulog("save_universal_state: saved")
    except Exception as e:
        ulog(f"save error: {e}")

# ---------- Apply snapshot with retries ----------
def _apply_snapshot_now(self, data):
    try:
        # combos
        for cmb in self.findChildren(QtWidgets.QComboBox):
            try:
                name = cmb.objectName()
                val = data.get("combos", {}).get(name, None)
                if val is not None:
                    i = cmb.findText(val)
                    if i >= 0:
                        cmb.setCurrentIndex(i)
            except Exception:
                pass
        # line edits
        for ed in self.findChildren(QtWidgets.QLineEdit):
            try:
                name = ed.objectName()
                val = data.get("edits", {}).get(name, None)
                if val is not None:
                    ed.setText(val)
            except Exception:
                pass
        # tabs
        for tb in self.findChildren(QtWidgets.QTabWidget):
            try:
                name = tb.objectName()
                idx = data.get("tabs", {}).get(name, None)
                if isinstance(idx, int) and 0 <= idx < tb.count():
                    tb.setCurrentIndex(idx)
            except Exception:
                pass
        # window
        try:
            geo = data.get("geometry", {}).get("geo", None)
            st  = data.get("geometry", {}).get("state", None)
            if geo:
                self.restoreGeometry(QtCore.QByteArray.fromHex(geo.encode()))
            if st:
                self.restoreState(QtCore.QByteArray.fromHex(st.encode()))
        except Exception:
            pass
        # splitters
        for sp in self.findChildren(QtWidgets.QSplitter):
            try:
                name = sp.objectName()
                hx = data.get("splitters", {}).get(name, None)
                if hx:
                    sp.restoreState(QtCore.QByteArray.fromHex(hx.encode()))
            except Exception:
                pass
        # tables / headers
        for tbl in self.findChildren((QtWidgets.QTableWidget, QtWidgets.QTableView)):
            try:
                name = tbl.objectName()
                info = data.get("tables", {}).get(name, None)
                if not info: continue
                hh = tbl.horizontalHeader() if hasattr(tbl, "horizontalHeader") else None
                vh = tbl.verticalHeader() if hasattr(tbl, "verticalHeader") else None
                if hh:
                    vis = info.get("hh_visual", [])
                    sizes = info.get("hh_sizes", [])
                    for i, v in enumerate(vis):
                        try: hh.moveSection(hh.visualIndex(i), int(v))
                        except Exception: pass
                    for i, w in enumerate(sizes):
                        try: hh.resizeSection(i, int(w))
                        except Exception: pass
                if vh:
                    rows  = int(info.get("vh_rows", 0) or 0)
                    sizes = info.get("vh_sizes", [])
                    for i, h in enumerate(sizes[:rows] if rows else sizes):
                        try: vh.resizeSection(i, int(h))
                        except Exception: pass
            except Exception:
                pass
    except Exception as e:
        ulog(f"apply_now error: {e}")

def load_universal_state(self):
    try:
        with open(_store_path(), "r", encoding="utf-8") as f:
            data = json.load(f)
    except Exception:
        data = {}
    _apply_snapshot_now(self, data)
    ulog("load_universal_state: applied once")

    # Retry for a few seconds to cover late-populating widgets (e.g., async fills)
    tries = {"left": 20}  # 20 * 200ms = 4s
    def retry_apply():
        try:
            if tries["left"] <= 0:
                return
            _apply_snapshot_now(self, data)
            tries["left"] -= 1
            if tries["left"] > 0:
                QtCore.QTimer.singleShot(200, retry_apply)
            else:
                ulog("load_universal_state: retries done")
        except Exception as e:
            ulog(f"retry_apply error: {e}")
    try:
        QtCore.QTimer.singleShot(0, retry_apply)
    except Exception:
        pass

# ---------- Wire in: always save + periodic + on change, and load with retries ----------
def _attach_universal_autosave(self):
    try:
        # Debounced timer
        if getattr(self, "_univ_timer", None) is None:
            t = QtCore.QTimer(self); t.setSingleShot(True); t.setInterval(700)
            t.timeout.connect(lambda: save_universal_state(self))
            self._univ_timer = t

        def _kick(): 
            try:
                self._univ_timer.start()
            except Exception:
                pass

        # Connect combos and edits
        for cmb in self.findChildren(QtWidgets.QComboBox):
            try: cmb.currentIndexChanged.connect(_kick)
            except Exception: pass
        for ed in self.findChildren(QtWidgets.QLineEdit):
            try: ed.textChanged.connect(_kick)
            except Exception: pass

        # Table headers
        for tbl in self.findChildren((QtWidgets.QTableWidget, QtWidgets.QTableView)):
            try:
                hh = tbl.horizontalHeader() if hasattr(tbl,"horizontalHeader") else None
                vh = tbl.verticalHeader() if hasattr(tbl,"verticalHeader") else None
                if hh:
                    try: hh.sectionResized.connect(_kick)
                    except Exception: pass
                    try: hh.sectionMoved.connect(_kick)
                    except Exception: pass
                if vh:
                    try: vh.sectionResized.connect(_kick)
                    except Exception: pass
            except Exception: pass

        # Periodic safety net
        if getattr(self, "_univ_periodic", None) is None:
            p = QtCore.QTimer(self); p.setInterval(2500)
            p.timeout.connect(lambda: save_universal_state(self))
            p.start()
            self._univ_periodic = p
    except Exception as e:
        ulog(f"_attach_universal_autosave error: {e}")

# Hook into enable_autosave + closeEvent
_prev_enable_autosave_univ = globals().get("enable_autosave")
def enable_autosave(self):
    try:
        if callable(_prev_enable_autosave_univ):
            _prev_enable_autosave_univ(self)
    except Exception:
        pass
    try:
        load_universal_state(self)
    except Exception as e:
        ulog(f"enable_autosave load error: {e}")
    try:
        _attach_universal_autosave(self)
    except Exception as e:
        ulog(f"enable_autosave attach error: {e}")

_prev_close_univ = globals().get("closeEvent")
def closeEvent(self, event):
    try:
        save_universal_state(self)
    except Exception as e:
        ulog(f"close save error: {e}")
    
    # Auto Backup on Close
    try:
        import db_adapter
        # Perform backup in a way that doesn't block too long, but closeEvent is blocking anyway.
        # It's fast enough for small DBs.
        db_adapter.backup_db(keep_last=10)
    except Exception as e:
        ulog(f"backup error: {e}")

    try:
        if callable(_prev_close_univ):
            _prev_close_univ(self, event); return
    except Exception:
        pass
    try:
        super(QtWidgets.QMainWindow, self).closeEvent(event)
    except Exception:
        try: event.accept()
        except Exception: pass

# MainWindow.enable_autosave = enable_autosave
# MainWindow.closeEvent = closeEvent
# =================== END UNIVERSAL PERSISTENCE LAYER ===================

# ===================== SNAPSHOT-BASED UNDO/REDO (Ctrl+Z / Ctrl+Y) =====================
def _ensure_undo_stacks(self):
    try:
        if getattr(self, "_undo_stack", None) is None:
            self._undo_stack = []
        if getattr(self, "_redo_stack", None) is None:
            self._redo_stack = []
        if getattr(self, "_current_snapshot", None) is None:
            # Ù„Ù‚Ø·Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            self._current_snapshot = snapshot_ui(self)
    except Exception:
        pass

def _push_snapshot_if_changed(self):
    try:
        _ensure_undo_stacks(self)
        new_snap = snapshot_ui(self)
        # Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø± Ø´ÙŠØ¡ØŒ Ø§Ø¯ÙØ¹ Ø§Ù„Ù„Ù‚Ø·Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù€Undo ÙˆØ¨Ø¯Ù‘Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if json.dumps(new_snap, ensure_ascii=False, sort_keys=True) != json.dumps(getattr(self, "_current_snapshot", {}), ensure_ascii=False, sort_keys=True):
            self._undo_stack.append(self._current_snapshot)
            # Ø­Ø¯Ø¯ Ø­Ø¯Ù‹Ø§ Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø°Ø§ÙƒØ±Ø© (20 Ø®Ø·ÙˆØ©)
            if len(self._undo_stack) > 20:
                self._undo_stack = self._undo_stack[-20:]
            self._current_snapshot = new_snap
            # Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¬Ø¯ÙŠØ¯ ÙŠÙØ³Ù‚Ø· Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
            self._redo_stack.clear()
    except Exception:
        pass

def undo(self):
    try:
        _ensure_undo_stacks(self)
        if not self._undo_stack:
            return
        prev = self._undo_stack.pop()
        # Ø§Ø¯ÙØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Redo Ø«Ù… Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        self._redo_stack.append(self._current_snapshot)
        _apply_snapshot_now(self, prev)
        self._current_snapshot = prev
        # Ø§Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ø§Ø¬Ø¹
        try: save_universal_state(self)
        except Exception: pass
    except Exception:
        pass

def redo(self):
    try:
        _ensure_undo_stacks(self)
        if not self._redo_stack:
            return
        nxt = self._redo_stack.pop()
        # Ø§Ø¯ÙØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Undo Ø«Ù… Ø·Ø¨Ù‘Ù‚ Ø§Ù„ØªØ§Ù„ÙŠØ©
        self._undo_stack.append(self._current_snapshot)
        _apply_snapshot_now(self, nxt)
        self._current_snapshot = nxt
        try: save_universal_state(self)
        except Exception: pass
    except Exception:
        pass

def _attach_undo_shortcuts(self):
    try:
        _ensure_undo_stacks(self)
        sc_undo = QtWidgets.QShortcut(QtCore.QKeySequence("Ctrl+Z"), self)
        sc_undo.activated.connect(lambda: undo(self))
        sc_redo = QtWidgets.QShortcut(QtCore.QKeySequence("Ctrl+Y"), self)
        sc_redo.activated.connect(lambda: redo(self))
        self._undo_shortcuts = (sc_undo, sc_redo)
    except Exception:
        pass

# Ø§Ø±Ø¨Ø· Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø¨ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø±ØªÙƒØ§Ø² ÙÙŠ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©)
_prev_enable_autosave_undo = globals().get("enable_autosave")
def enable_autosave(self):
    try:
        if callable(_prev_enable_autosave_undo):
            _prev_enable_autosave_undo(self)
    except Exception:
        pass
    try:
        _attach_undo_shortcuts(self)
    except Exception:
        pass
    try:
        # Ø§Ø´ØªØ±Ùƒ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªÙØ­ÙÙ‘Ø² Ø§Ù„Ø­ÙØ¸ Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù‚Ø·Ø© Ø§Ù„Ù€Undo
        def _kick_undo():
            try:
                _push_snapshot_if_changed(self)
            except Exception:
                pass
        # ÙƒÙˆÙ…Ø¨ÙˆØ¨ÙˆÙƒØ³ ÙˆÙ„ÙŠÙ† Ø¥ÙŠØ¯Øª
        for cmb in self.findChildren(QtWidgets.QComboBox):
            try: cmb.currentIndexChanged.connect(_kick_undo)
            except Exception: pass
        for ed in self.findChildren(QtWidgets.QLineEdit):
            try: ed.textChanged.connect(_kick_undo)
            except Exception: pass
        # Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        for tbl in self.findChildren((QtWidgets.QTableWidget, QtWidgets.QTableView)):
            try:
                hh = tbl.horizontalHeader() if hasattr(tbl, "horizontalHeader") else None
                vh = tbl.verticalHeader() if hasattr(tbl, "verticalHeader") else None
                if hh:
                    try: hh.sectionResized.connect(_kick_undo)
                    except Exception: pass
                    try: hh.sectionMoved.connect(_kick_undo)
                    except Exception: pass
                if vh:
                    try: vh.sectionResized.connect(_kick_undo)
                    except Exception: pass
            except Exception: pass
    except Exception:
        pass

# try:
#     MainWindow.enable_autosave = enable_autosave
#     MainWindow.undo = undo
#     MainWindow.redo = redo
# except Exception:
#     pass
# =================== END SNAPSHOT-BASED UNDO/REDO =====================

# Provide export_excel if it's missing on MainWindow
try:
    if not hasattr(MainWindow, "export_excel"):
        def export_excel(self):
            try:
                export_table_to_excel(self)
            except Exception:
                pass
#         MainWindow.export_excel = export_excel
except Exception:
    pass
def _hash_password(p: str) -> str:
    try:
        import hashlib
        return hashlib.sha256((p or "").encode("utf-8")).hexdigest()
    except Exception:
        return ""

def _sync_cash_columns(self):
    try:
        if not getattr(self, 'table_cash', None):
            return
        # Ø§Ø¹ØªÙ…Ø¯ Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        name_to_width = {}
        name_to_hidden = {}
        header_main = self.table.horizontalHeader()
        # Ø§Ø¬Ù…Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨ØªØ±ØªÙŠØ¨Ù‡Ø§ Ø§Ù„Ù…Ø±Ø¦ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
        pairs = []
        for logical in range(self.table.columnCount()):
            it = self.table.horizontalHeaderItem(logical)
            nm = (it.text().strip() if it else f"col_{logical}")
            try:
                vis = header_main.visualIndex(logical)
            except Exception:
                vis = logical
            pairs.append((vis, nm, logical))
            name_to_width[nm] = int(self.table.columnWidth(logical))
            name_to_hidden[nm] = bool(self.table.isColumnHidden(logical))
        pairs = [p for p in pairs if p[0] != -1]
        pairs.sort(key=lambda x: x[0])
        order_names = [nm for _, nm, _ in pairs]
        # Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ
        for i in range(self.table_cash.columnCount()):
            it = self.table_cash.horizontalHeaderItem(i)
            nm = (it.text().strip() if it else f"col_{i}")
            if nm in name_to_width:
                try:
                    self.table_cash.setColumnWidth(i, int(name_to_width[nm]))
                except Exception:
                    pass
            try:
                self.table_cash.setColumnHidden(i, bool(name_to_hidden.get(nm, False)))
            except Exception:
                pass
        # Ø£Ø¹Ø¯ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        header_cash = self.table_cash.horizontalHeader()
        try:
            header_cash.setSectionsMovable(True)
        except Exception:
            pass
        # Ø¨Ù†Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø³Ù… -> Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ
        def _map_cash():
            m = {}
            for j in range(self.table_cash.columnCount()):
                it2 = self.table_cash.horizontalHeaderItem(j)
                nm2 = (it2.text().strip() if it2 else f"col_{j}")
                m[nm2] = j
            return m
        try:
            self.table_cash.setUpdatesEnabled(False)
            header_cash.blockSignals(True)
            for desired_visual, nm in enumerate(order_names):
                m = _map_cash()
                if nm not in m:
                    continue
                logical = m[nm]
                cur_vis = header_cash.visualIndex(logical)
                if cur_vis != desired_visual and cur_vis != -1:
                    try:
                        header_cash.moveSection(cur_vis, desired_visual)
                    except Exception:
                        pass
        finally:
            try:
                header_cash.blockSignals(False)
                self.table_cash.setUpdatesEnabled(True)
            except Exception:
                pass
        try:
            self.table_cash.setColumnHidden(16, True)
        except Exception:
            pass
    except Exception:
        pass

# MainWindow._sync_cash_columns = _sync_cash_columns
